<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>likeqy.com</title>
  <subtitle>ä¸€ä¸ªä¸“æ³¨å‘å¸ƒæœ‰å…³Kotlinã€Androidç›¸å…³èµ„æºä¸ä¼˜ç§€æ–‡ç« çš„æŠ€æœ¯ç½‘ç«™</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://likeqy.com/"/>
  <updated>2017-09-03T02:05:29.622Z</updated>
  <id>https://likeqy.com/</id>
  
  <author>
    <name>sunshuntao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Text3æ€ä¹ˆä¿®æ”¹ä¾§è¾¹æ çš„é¢œè‰²å’Œå†…å®¹ä¸€è‡´</title>
    <link href="https://likeqy.com/2017/09/03/Text3%E6%80%8E%E4%B9%88%E4%BF%AE%E6%94%B9%E4%BE%A7%E8%BE%B9%E6%A0%8F%E7%9A%84%E9%A2%9C%E8%89%B2%E5%92%8C%E5%86%85%E5%AE%B9%E4%B8%80%E8%87%B4/"/>
    <id>https://likeqy.com/2017/09/03/Text3æ€ä¹ˆä¿®æ”¹ä¾§è¾¹æ çš„é¢œè‰²å’Œå†…å®¹ä¸€è‡´/</id>
    <published>2017-09-03T02:04:58.000Z</published>
    <updated>2017-09-03T02:05:29.622Z</updated>
    
    <content type="html"><![CDATA[<p>sublime text3åˆšå®‰è£…å®Œæˆä¹‹åæ‰“å¼€æ–‡ä»¶å¤¹æ˜¾ç¤ºçš„æ ·å¼å¦‚ä¸‹</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/38900987.jpg" alt=""></p>
<p>è¿™æ ·å­çœ‹èµ·æ¥çœ¼ç›ä¼šå¾ˆéš¾å—,é‚£ä¹ˆæˆ‘ä»¬æ€æ ·æ‰èƒ½ä½¿å¾—å¼•å¯¼èœå•çš„é¢œè‰²å’Œç¼–è¾‘å™¨åº•è‰²ä¸€æ ·å‘¢?</p>
<p>è§£å†³æ–¹æ³•å¦‚ä¸‹:</p>
<p>Ctrl+Shift+P -&gt; install -&gt; æœç´¢å®‰è£…åŒ…SyncedSidebarBgï¼Œè‡ªåŠ¨åŒæ­¥ä¾§è¾¹æ åº•è‰²ä¸ºç¼–è¾‘çª—å£åº•è‰²ã€‚<br>PSï¼šæœ‰æ—¶æ”¹å®Œåä¾§è¾¹æ é¢œè‰²æ²¡å˜åŒ–ï¼Œä¸çŸ¥ä»€ä¹ˆåŸå› ï¼Œæ‰“å¼€åŒ…æ§åˆ¶ï¼Œç„¶ååˆ—ä¸€ä¸‹å·²å®‰è£…åŒ…å°±åˆ·æ–°äº†ã€‚</p>
<p>å®‰è£…å®Œæˆä¹‹å,æ•ˆæœæ˜¯è¿™æ ·å­çš„:</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/5379561.jpg" alt=""></p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;sublime text3åˆšå®‰è£…å®Œæˆä¹‹åæ‰“å¼€æ–‡ä»¶å¤¹æ˜¾ç¤ºçš„æ ·å¼å¦‚ä¸‹&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://omvbl46i3.bkt.clouddn.com/17-9-3/38900987.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·å­çœ‹èµ·æ¥çœ¼ç›ä¼šå¾ˆéš¾å—,é‚£ä¹ˆæˆ‘ä»¬æ€
    
    </summary>
    
      <category term="ç¼–ç¨‹ç›¸å…³" scheme="https://likeqy.com/categories/%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/"/>
    
    
      <category term="Program" scheme="https://likeqy.com/tags/Program/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntuæ‰å¹³åŒ–ä¸»é¢˜Flatabulouså®‰è£…æ•™ç¨‹</title>
    <link href="https://likeqy.com/2017/09/03/Ubuntu%E6%89%81%E5%B9%B3%E5%8C%96%E4%B8%BB%E9%A2%98Flatabulous%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/"/>
    <id>https://likeqy.com/2017/09/03/Ubuntuæ‰å¹³åŒ–ä¸»é¢˜Flatabulouså®‰è£…æ•™ç¨‹/</id>
    <published>2017-09-03T01:25:48.000Z</published>
    <updated>2017-09-03T01:46:01.454Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“å¤§å®¶å¯¹Ubuntuè‡ªå¸¦çš„ä¸»é¢˜æ•ˆæœæ€ä¹ˆçœ‹ï¼Œåæ­£æˆ‘è‡ªå·±è§‰å¾—è‡ªå¸¦çš„ä¸»é¢˜çœ‹èµ·æ¥æŒºéš¾å—çš„ï¼Œæ‰€ä»¥ç½‘ä¸Šæ‰¾äº†è®¸å¤šæ³•å­ï¼Œç»ˆäºæŠŠä¸»é¢˜ç¾åŒ–æˆè‡ªå·±å–œæ¬¢çš„æ ·å­ã€‚</p>
<p>Flatabulous: ä¸€ä¸ªè¶…å¥½çœ‹çš„æ‰å¹³åŒ– Ubuntu æ¡Œé¢ä¸»é¢˜</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/16411938.jpg" alt=""></p>
<p>å®‰è£…æ­¤ä¸»é¢˜æ­¥éª¤ï¼š</p>
<h4 id="ä¸€ã€TweeakTool"><a href="#ä¸€ã€TweeakTool" class="headerlink" title="ä¸€ã€TweeakTool"></a>ä¸€ã€TweeakTool</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:tualatrix/ppa  </div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install ubuntu-tweak</div></pre></td></tr></table></figure>
<p>è¯¥å·¥å…·æ˜¯ç”¨æ¥è®¾ç½®å„ç§Ubuntuåå¥½ä½¿ç”¨çš„</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/47946394.jpg" alt=""></p>
<h4 id="äºŒã€å®‰è£…Flatabulous"><a href="#äºŒã€å®‰è£…Flatabulous" class="headerlink" title="äºŒã€å®‰è£…Flatabulous"></a>äºŒã€å®‰è£…Flatabulous</h4><p><a href="https://github.com/anmoljagetia/Flatabulous/archive/master.zip" target="_blank" rel="external">ä¸‹è½½åœ°å€</a><br>æˆ–è€…ç›´æ¥åœ¨Githubä¸Š Cloneä¸‹æ¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/anmoljagetia/Flatabulous</div></pre></td></tr></table></figure></p>
<p>æŠŠä¸‹è½½ä¸‹æ¥çš„zipåŒ…è§£å‹ï¼Œç§»åŠ¨åˆ°/usr/share/themes/ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo mv Flatabulous-master /usr/share/themes/</div></pre></td></tr></table></figure>
<h4 id="ä¸‰ã€å®‰è£…æ‰å¹³åŒ–å›¾æ ‡ultra-flat-icons"><a href="#ä¸‰ã€å®‰è£…æ‰å¹³åŒ–å›¾æ ‡ultra-flat-icons" class="headerlink" title="ä¸‰ã€å®‰è£…æ‰å¹³åŒ–å›¾æ ‡ultra-flat-icons"></a>ä¸‰ã€å®‰è£…æ‰å¹³åŒ–å›¾æ ‡ultra-flat-icons</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:noobslab/icons</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install ultra-flat-icons</div></pre></td></tr></table></figure>
<p>æˆ–è€…åˆ°<a href="http://ppa.launchpad.net/noobslab/icons/ubuntu/pool/main/u/ultra-flat-icons/" target="_blank" rel="external">http://ppa.launchpad.net/noobslab/icons/ubuntu/pool/main/u/ultra-flat-icons/</a>è‡ªå·±ä¸‹è½½å®‰è£…</p>
<h4 id="æ³¨æ„ï¼Œåœ¨Ubuntu15-04ä¼šæç¤ºæ‰¾ä¸åˆ°ultra-flat-iconsè¿™ä¸ªåŒ…"><a href="#æ³¨æ„ï¼Œåœ¨Ubuntu15-04ä¼šæç¤ºæ‰¾ä¸åˆ°ultra-flat-iconsè¿™ä¸ªåŒ…" class="headerlink" title="æ³¨æ„ï¼Œåœ¨Ubuntu15.04ä¼šæç¤ºæ‰¾ä¸åˆ°ultra-flat-iconsè¿™ä¸ªåŒ…"></a>æ³¨æ„ï¼Œåœ¨Ubuntu15.04ä¼šæç¤ºæ‰¾ä¸åˆ°ultra-flat-iconsè¿™ä¸ªåŒ…</h4><p>è§£å†³æ–¹æ³•ï¼šåœ¨è½¯ä»¶å’Œæ›´æ–°ä¸­æŠŠultra-flat-iconsæºä¸­çš„vividæ”¹æˆtrustyï¼Œå³å¯å®‰è£…æˆåŠŸï¼Œæœ€åè®°å¾—æ”¹å›æ¥è¿‡</p>
<p>æˆ–è€…ä½ ä¹Ÿå¯ä»¥è¿è¡Œsudo apt-get install ultra-flat-icons-orangeæˆ–è€… sudo apt-get install ultra-flat-icons-green</p>
<p>æ ¹æ®ä½ è‡ªå·±å–œæ¬¢çš„é¢œè‰²é€‰æ‹©ã€‚</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/90967736.jpg" alt=""></p>
<p>æœ€åå®Œæˆä»¥ä¸Šè®¾ç½®çš„æ•ˆæœå›¾</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-3/47946394.jpg" alt=""></p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸çŸ¥é“å¤§å®¶å¯¹Ubuntuè‡ªå¸¦çš„ä¸»é¢˜æ•ˆæœæ€ä¹ˆçœ‹ï¼Œåæ­£æˆ‘è‡ªå·±è§‰å¾—è‡ªå¸¦çš„ä¸»é¢˜çœ‹èµ·æ¥æŒºéš¾å—çš„ï¼Œæ‰€ä»¥ç½‘ä¸Šæ‰¾äº†è®¸å¤šæ³•å­ï¼Œç»ˆäºæŠŠä¸»é¢˜ç¾åŒ–æˆè‡ªå·±å–œæ¬¢çš„æ ·å­ã€‚&lt;/p&gt;
&lt;p&gt;Flatabulous: ä¸€ä¸ªè¶…å¥½çœ‹çš„æ‰å¹³åŒ– Ubuntu æ¡Œé¢ä¸»é¢˜&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://
    
    </summary>
    
      <category term="Linux" scheme="https://likeqy.com/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://likeqy.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>å†³ç­–</title>
    <link href="https://likeqy.com/2017/09/02/%E5%86%B3%E7%AD%96/"/>
    <id>https://likeqy.com/2017/09/02/å†³ç­–/</id>
    <published>2017-09-02T12:16:15.000Z</published>
    <updated>2017-09-02T13:09:57.524Z</updated>
    
    <content type="html"><![CDATA[<p>ä»€ä¹ˆæ˜¯æˆ‘ä»¬ä¸€ç”Ÿä¸­è€—æ—¶æœ€å¤šã€æœ€è®©äººçº ç»“çš„äº‹?æ˜¯åšå‡ºå¤§å¤§å°å°çš„å†³ç­–ã€‚</p>
<p>æˆ‘ä»¬çš„ç”Ÿæ´»æ— æ—¶æ— åˆ»çš„éƒ½å……æ»¡äº†å„ç§å†³ç­–ï¼Œæ¯”å¦‚åˆé¤æˆ‘è¦åƒä»€ä¹ˆï¼Œåˆ°äº†å•†åœºæˆ‘è¦ä¹°ä»€ä¹ˆï¼Œä»Šå¤©è¡£æœç©¿ä»€ä¹ˆç­‰ç­‰ã€‚</p>
<p>æˆ‘ä»¬æ—¶å¸¸é™·å…¥ä¸ªäººä¸»è§‚æ„Ÿæƒ…æˆ–è€…æ˜¯éç†æ€§æ„Ÿæƒ…ä¸­åšå‡ºé”™è¯¯çš„å†³å®šï¼Œä»¥è‡´äºåšå‡ºè®©æˆ‘ä»¬åæ‚”ç»ˆç”Ÿçš„åˆ¤æ–­ã€‚</p>
<p>æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜â€œ<strong>æ‰å…‹ä¼¯æ ¼ä¸ºä»€ä¹ˆæ€»æ˜¯ç©¿åŒä¸€ä»¶è¡£æœï¼Ÿ</strong>â€</p>
<p>å…¶å®æ‰å…‹ä¼¯æ ¼çš„è¡£æŸœé‡Œçš„è¡£æœæ˜¯è¿™æ ·å­çš„</p>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-9-2/51906861.jpg" alt=""></p>
<p> è€Œæ‰å…‹ä¼¯æ ¼è‡ªå·±çš„å›ç­”åˆ™æ˜¯</p>
<p> â€œ<strong>æˆ‘æƒ³é€šè¿‡æ¸…ç©ºæˆ‘çš„ç”Ÿæ´»æ¥è®©æˆ‘åœ¨é™¤äº†å¦‚ä½•æ›´å¥½æœåŠ¡ç¤¾ä¼šè¿™ä»¶äº‹æƒ…ä»¥å¤–çš„ä»»ä½•äº‹æƒ…ä¸Šéƒ½åšå°½å¯èƒ½å°‘çš„å†³ç­–ã€‚</strong>â€</p>
<p> ä½œä¸ºä¸€ä¸ªå¯Œè±ªï¼Œæ‰å…‹ä¼¯æ ¼ä¸æ˜¯ä¸ºäº†æœ‰è¶£æ‰æ¯å¤©ç©¿åŒä¸€æ¬¾å¼çš„è¡£æœï¼Œä»–è¿™æ ·åšç¡®å®æ˜¯è¡Œä¹‹æœ‰æ•ˆ,æ¯ä¸€ä¸ªå†³å®šéƒ½ä¼šå‡å°‘æˆ‘ä»¬çš„æ„å¿—åŠ›â€œè¡€æ§½â€ã€‚<strong>æ¯ä¸€ä¸ªå†³å®šéƒ½ä¼šè®©æˆ‘ä»¬å°‘ä¸€ä¸åˆ›é€ åŠ›ã€æ§åˆ¶åŠ›å’Œä¸“æ³¨åŠ›</strong>ã€‚</p>
<p> å¼•ç”¨ä¸€ä½åäººçš„è¯</p>
<blockquote>
<p>â€œæˆ‘ä»¬å¿…é¡»å°½æ—©å°†å°½å¯èƒ½å¤šä¸”æœ‰ç”¨çš„è¡ŒåŠ¨å˜æˆæˆ‘ä»¬è‡ªå‘çš„å’Œä¹ ä»¥ä¸ºå¸¸çš„å†³ç­–â€¦â€¦æˆ‘ä»¬é€šè¿‡æ¯«ä¸è´¹åŠ›çš„ä¸‹æ„è¯†è¡Œä¸ºè§£å†³çš„æ—¥å¸¸ç»†èŠ‚è¶Šå¤šï¼Œæˆ‘ä»¬å°±èƒ½è§£æ”¾è¶Šå¤šåº”è¯¥ç”¨æ¥å¤„ç†é«˜çº§äº‹åŠ¡çš„ç²¾ç¥æ„å¿—åŠ›ã€‚â€â€”â€”å¨å»‰Â·è©¹å§†æ–¯</p>
</blockquote>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»€ä¹ˆæ˜¯æˆ‘ä»¬ä¸€ç”Ÿä¸­è€—æ—¶æœ€å¤šã€æœ€è®©äººçº ç»“çš„äº‹?æ˜¯åšå‡ºå¤§å¤§å°å°çš„å†³ç­–ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çš„ç”Ÿæ´»æ— æ—¶æ— åˆ»çš„éƒ½å……æ»¡äº†å„ç§å†³ç­–ï¼Œæ¯”å¦‚åˆé¤æˆ‘è¦åƒä»€ä¹ˆï¼Œåˆ°äº†å•†åœºæˆ‘è¦ä¹°ä»€ä¹ˆï¼Œä»Šå¤©è¡£æœç©¿ä»€ä¹ˆç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ—¶å¸¸é™·å…¥ä¸ªäººä¸»è§‚æ„Ÿæƒ…æˆ–è€…æ˜¯éç†æ€§æ„Ÿæƒ…ä¸­åšå‡ºé”™è¯¯çš„å†³å®šï¼Œä»¥è‡´äºåšå‡ºè®©æˆ‘ä»¬åæ‚”ç»ˆ
    
    </summary>
    
      <category term="ç”Ÿæ´»éšç¬”" scheme="https://likeqy.com/categories/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="ç”Ÿæ´»éšç¬”" scheme="https://likeqy.com/tags/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>Androidå¼€å‘å·¥å…·å¤§å…¨</title>
    <link href="https://likeqy.com/2017/07/29/Android%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%85%A8/"/>
    <id>https://likeqy.com/2017/07/29/Androidå¼€å‘å·¥å…·å¤§å…¨/</id>
    <published>2017-07-29T06:35:32.000Z</published>
    <updated>2017-07-29T06:44:15.999Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AndroidDevTools"><a href="#AndroidDevTools" class="headerlink" title="AndroidDevTools"></a>AndroidDevTools</h1><p><img src="https://badges.gitter.im/Join%20Chat.svg" alt=""></p>
<p><strong>Android Dev Toolså®˜ç½‘åœ°å€ï¼š<a href="http://www.androiddevtools.cn" target="_blank" rel="external">www.androiddevtools.cn</a></strong></p>
<p>æ”¶é›†æ•´ç†Androidå¼€å‘æ‰€éœ€çš„Android SDKã€å¼€å‘ä¸­ç”¨åˆ°çš„å·¥å…·ã€Androidå¼€å‘æ•™ç¨‹ã€Androidè®¾è®¡è§„èŒƒï¼Œå…è´¹çš„è®¾è®¡ç´ æç­‰ã€‚</p>
<p>æ¬¢è¿å¤§å®¶æ¨èè‡ªå·±åœ¨Androidå¼€å‘è¿‡ç¨‹ä¸­ç”¨çš„å¥½ç”¨çš„å·¥å…·ã€å­¦ä¹ å¼€å‘æ•™ç¨‹ã€ç”¨åˆ°è®¾è®¡ç´ æï¼Œæ¬¢è¿Starã€Fork ğŸ˜„ã€‚</p>
<h1 id="Android-Tools"><a href="#Android-Tools" class="headerlink" title="Android Tools"></a>Android Tools</h1><hr>
<h4 id="Android-SDKåœ¨çº¿æ›´æ–°é•œåƒæœåŠ¡å™¨"><a href="#Android-SDKåœ¨çº¿æ›´æ–°é•œåƒæœåŠ¡å™¨" class="headerlink" title="Android SDKåœ¨çº¿æ›´æ–°é•œåƒæœåŠ¡å™¨"></a>Android SDKåœ¨çº¿æ›´æ–°é•œåƒæœåŠ¡å™¨</h4><ol>
<li><p>ä¸­å›½ç§‘å­¦é™¢å¼€æºåä¼šé•œåƒç«™åœ°å€:</p>
<ul>
<li><p>IPV4/IPV6: <code>mirrors.opencas.cn</code> ç«¯å£ï¼š80</p>
</li>
<li><p>IPV4/IPV6: <code>mirrors.opencas.org</code> ç«¯å£ï¼š80</p>
</li>
<li><p>IPV4/IPV6: <code>mirrors.opencas.ac.cn</code> ç«¯å£ï¼š80</p>
</li>
</ul>
</li>
</ol>
<ol>
<li><p>ä¸Šæµ·GDGé•œåƒæœåŠ¡å™¨åœ°å€:</p>
<ul>
<li><code>sdk.gdgshanghai.com</code>  ç«¯å£ï¼š8000</li>
</ul>
</li>
<li><p>åŒ—äº¬åŒ–å·¥å¤§å­¦é•œåƒæœåŠ¡å™¨åœ°å€:</p>
<ul>
<li><p>IPv4: <code>ubuntu.buct.edu.cn/</code> ç«¯å£ï¼š80</p>
</li>
<li><p>IPv4: <code>ubuntu.buct.cn/</code>   ç«¯å£ï¼š80</p>
</li>
<li><p>IPv6: <code>ubuntu.buct6.edu.cn/</code>  ç«¯å£ï¼š80</p>
</li>
</ul>
</li>
<li><p>å¤§è¿ä¸œè½¯ä¿¡æ¯å­¦é™¢é•œåƒæœåŠ¡å™¨åœ°å€:</p>
<ul>
<li><code>mirrors.neusoft.edu.cn</code> ç«¯å£ï¼š80</li>
</ul>
</li>
<li><p>è…¾è®¯Bugly é•œåƒ:</p>
<ul>
<li><p><code>android-mirror.bugly.qq.com</code> ç«¯å£ï¼š8080</p>
<p>è…¾è®¯é•œåƒä½¿ç”¨æ–¹æ³•: <a href="http://android-mirror.bugly.qq.com:8080/include/usage.html" target="_blank" rel="external">http://android-mirror.bugly.qq.com:8080/include/usage.html</a></p>
</li>
</ul>
</li>
</ol>
<p><strong>ä½¿ç”¨æ–¹æ³•</strong>ï¼š</p>
<ol>
<li><p>å¯åŠ¨ Android SDK Manager ï¼Œæ‰“å¼€ä¸»ç•Œé¢ï¼Œä¾æ¬¡é€‰æ‹©ã€<strong>Tools</strong>ã€ã€ã€<strong>Optionsâ€¦</strong>ã€ï¼Œå¼¹å‡ºã€<strong>Android SDK Manager - Settings</strong>ã€çª—å£ï¼›</p>
</li>
<li><p>åœ¨ã€<strong>Android SDK Manager - Settings</strong>ã€çª—å£ä¸­ï¼Œåœ¨ã€<strong>HTTP Proxy Serverã€å’Œã€ŒHTTP Proxy Port</strong>ã€è¾“å…¥æ¡†å†…å¡«å…¥ä¸Šé¢é•œåƒæœåŠ¡å™¨åœ°å€(<strong>ä¸åŒ…å«http://</strong>ï¼Œå¦‚ä¸‹å›¾)å’Œç«¯å£ï¼Œå¹¶ä¸”é€‰ä¸­ã€<strong>Force https://â€¦ sources to be fetched using http://â€¦</strong>ã€å¤é€‰æ¡†ã€‚è®¾ç½®å®Œæˆåå•å‡»ã€<strong>Close</strong>ã€æŒ‰é’®å…³é—­ã€<strong>Android SDK Manager - Settings</strong>ã€çª—å£è¿”å›åˆ°ä¸»ç•Œé¢ï¼›</p>
</li>
<li><p>ä¾æ¬¡é€‰æ‹©ã€<strong>Packages</strong>ã€ã€ã€<strong>Reload</strong>ã€ã€‚</p>
</li>
</ol>
<p><img src="http://omvbl46i3.bkt.clouddn.com/17-7-29/26741829.jpg" alt=""></p>
<h4 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h4><blockquote style="color: gray"><br>                        <strong style="color: red">æ³¨æ„:</strong>ä»¥ä¸‹ Android Studio ä¸‹è½½é“¾æ¥å…¨æ˜¯ <code>dl.google.com</code> å¼€å¤´çš„å®˜æ–¹ä¸‹è½½ï¼Œæ— éœ€tiziï¼Œ<strong style="color: red">å»ºè®®ç”¨æµè§ˆå™¨ç›´æ¥ä»å®˜æ–¹åŸå§‹é“¾æ¥ä¸‹è½½ï¼Œä¸è¦ç”¨è¿…é›·ä¸‹è½½ã€ä¸è¦ç”¨è¿…é›·ä¸‹è½½ã€ä¸è¦ç”¨è¿…é›·ä¸‹è½½</strong>ï¼Œé‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œé¿å…ç±»ä¼¼<a href="https://www.zhihu.com/question/35721299" target="_blank" rel="external">XCodeGhost</a>çš„äº‹ä»¶ï¼ï¼ï¼<br>                    </blockquote>

<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
<th style="text-align:left">SHA-1æ ¡éªŒç </th>
<th style="text-align:center">å®˜æ–¹SHA-1æ ¡éªŒç æˆªå›¾</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2.1.3 æ­£å¼ç‰ˆ</td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/install/2.1.3.0/android-studio-bundle-143.3101438-windows.exe" target="_blank" rel="external">ä¸‹è½½ (æ¨è)</a> <br> <a href="https://dl.google.com/dl/android/studio/ide-zips/2.1.3.0/android-studio-ide-143.3101438-windows.zip" target="_blank" rel="external">ä¸‹è½½ (ä¸å«SDK Tools)</a> <br> <a href="https://dl.google.com/dl/android/studio/install/2.1.3.0/android-studio-ide-143.3101438-windows.exe" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/install/2.1.3.0/android-studio-ide-143.3101438-mac.dmg" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.1.3.0/android-studio-ide-143.3101438-linux.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:left">Win: 10d319c772b80f3cb0cde952451af8429ea1b68b <br> 43f84de7e61f37880a126c3d567b7fa6cb90c90e <br> 8ad212c55c7f4dc7ab490e4b7e77ec48001ae224 <br> Mac: 06166759b0e1e1ee91a147dcf5227d897a184277 <br> Linux: 8729e6f2f1fa58f04df9f8d1caac2f5be9dfc549</td>
<td style="text-align:center"><a href="http://ww2.sinaimg.cn/large/8a41f469gw1f6ve98yjtxj21kw16baos.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
<tr>
<td style="text-align:center">2.2 Beta</td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.7/android-studio-ide-145.3128856-windows.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.7/android-studio-ide-145.3128856-mac.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.7/android-studio-ide-145.3128856-linux.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:left">Win: 7d2c9861e90dc985b1e6ba78ebd8497b610a8620 <br> Mac:050a443ffee51922eabddbcd260c845a8e06e4a9 <br> Linux: bafb5d7029d2678e8274e24da1c7ce0a00f3a644</td>
<td style="text-align:center"><a href="http://ww1.sinaimg.cn/large/8a41f469gw1f6ve698vw9j21ih1304jw.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
<tr>
<td style="text-align:center">2.2 Preview7</td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.6/android-studio-ide-145.3111935-windows.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.6/android-studio-ide-145.3111935-mac.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.6/android-studio-ide-145.3111935-linux.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:left">Win: e6ea4c9d9bf4ae46dbea82e3cc5638fd93194c33 <br> Mac: 56327a0f97d999a6b7a15f3e9e513aa42881c989 <br> Linux: b85c4e27401f7f18af19e39e453cca8575041dbb</td>
<td style="text-align:center"><a href="http://ww2.sinaimg.cn/large/8a41f469gw1f6ve98yjtxj21kw16baos.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
<tr>
<td style="text-align:center">2.1.2 æ­£å¼ç‰ˆ</td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/install/2.1.2.0/android-studio-bundle-143.2915827-windows.exe" target="_blank" rel="external">ä¸‹è½½(æ¨è)</a> <br> <a href="https://dl.google.com/dl/android/studio/ide-zips/2.1.2.0/android-studio-ide-143.2915827-windows.zip" target="_blank" rel="external">ä¸‹è½½(ä¸å«SDK Tools)</a> <br> <a href="https://dl.google.com/dl/android/studio/install/2.1.2.0/android-studio-ide-143.2915827-windows.exe" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/install/2.1.2.0/android-studio-ide-143.2915827-mac.dmg" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://dl.google.com/dl/android/studio/ide-zips/2.1.2.0/android-studio-ide-143.2915827-linux.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:left">Win: 10d319c772b80f3cb0cde952451af8429ea1b68b <br> 43f84de7e61f37880a126c3d567b7fa6cb90c90e <br> 8ad212c55c7f4dc7ab490e4b7e77ec48001ae224 <br> Mac: <br> Linux:</td>
<td style="text-align:center"><a href="http://ww4.sinaimg.cn/large/8a41f469gw1f6ve8k9nkij21kw15316t.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
</tbody>
</table>
<h4 id="SDK-Tools"><a href="#SDK-Tools" class="headerlink" title="SDK Tools"></a>SDK Tools</h4><table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:left">Mac OSX</th>
<th style="text-align:center">Linux</th>
<th style="text-align:left">SHA-1æ ¡éªŒç </th>
<th style="text-align:center">å®˜æ–¹SHA-1æ ¡éªŒç æˆªå›¾</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">24.4.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i5xug3j" target="_blank" rel="external">installer_r24.4.1-windows.exe</a> <a href="http://pan.baidu.com/s/1kVjIPCV" target="_blank" rel="external">android-sdk_r24.4.1-windows.zip</a></td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1nuWN7V7" target="_blank" rel="external">android-sdk_r24.4.1-macosx.zip</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o8iqMQQ" target="_blank" rel="external">android-sdk_r24.4.1-linux.tgz</a></td>
<td style="text-align:left">Win:f9b59d72413649d31e633207e31f456443e7ea0b <br>66b6a6433053c152b22bf8cab19c0f3fef4eba49 <br> Mac: 85a9cccb0b1f9e6f1f616335c5f07107553840cd<br> Linux: 725bb360f0f7d04eaccff5a2d57abdd49061326d</td>
<td style="text-align:center"><a href="http://ww2.sinaimg.cn/large/8a41f469jw1f2ng43mgnhj21kw0fmwhi.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
<tr>
<td style="text-align:left">24.3.4</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQppdPC" target="_blank" rel="external">installer_r24.3.4-windows.exe</a> <a href="http://pan.baidu.com/s/1mg08f2K" target="_blank" rel="external">android-sdk_r24.3.4-windows.zip</a></td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDlTqBB" target="_blank" rel="external">android-sdk_r24.3.4-macosx.zip</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdsALt5" target="_blank" rel="external">android-sdk_r24.3.4-linux.tgz</a></td>
<td style="text-align:left">Win: 094dd45f98a31f839feae898b48f23704f2878dd <br> 4a8718fb4a2bf2128d34b92f23ddd79fc65839e7 <br> Mac: 128f10fba668ea490cc94a08e505a48a608879b9 <br> Linux: fb293d7bca42e05580be56b1adc22055d46603dd</td>
<td style="text-align:center"><a href="http://ww1.sinaimg.cn/large/8a41f469gw1ewbnhql68uj21k20jkjw4.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
</tbody>
</table>
<h4 id="SDK-Platform-Tools"><a href="#SDK-Platform-Tools" class="headerlink" title="SDK Platform-Tools"></a>SDK Platform-Tools</h4><p>è¿™æ˜¯ adb, fastboot ç­‰å·¥å…·åŒ…ã€‚æŠŠè§£å‹å‡ºæ¥çš„ <code>platform-tools</code> æ–‡ä»¶å¤¹æ”¾åœ¨ android sdk æ ¹ç›®å½•ä¸‹ï¼Œå¹¶æŠŠ <code>adb</code>æ‰€åœ¨çš„ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ <code>PATH</code> è·¯å¾„é‡Œï¼Œå³å¯åœ¨å‘½ä»¤è¡Œé‡Œç›´æ¥è®¿é—®äº† adb, fastboot ç­‰å·¥å…·ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:left">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">platform-tools-r22</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1sj4ZfTb" target="_blank" rel="external">platform-tools_r22-windows.zip</a></td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1jG3l6Ea" target="_blank" rel="external">platform-tools_r22-mac.zip</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0GUTxA" target="_blank" rel="external">platform-tools_r22-linux.zip</a></td>
</tr>
<tr>
<td style="text-align:left">platform-tools-r21</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdF1fkZ" target="_blank" rel="external">platform-tools_r21-windows.zip</a></td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDu6xC9" target="_blank" rel="external">platform-tools_r21-mac.zip</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDAL25j" target="_blank" rel="external">platform-tools_r21-linux.zip</a></td>
</tr>
<tr>
<td style="text-align:left">platform-tools-r20</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntHqLZj" target="_blank" rel="external">platform-tools_r20-windows.zip</a></td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1gdy6fzP" target="_blank" rel="external">platform-tools_r20-mac.zip</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/173KQi" target="_blank" rel="external">platform-tools_r20-linux.zip</a></td>
</tr>
</tbody>
</table>
<h3 id="Build-Tools"><a href="#Build-Tools" class="headerlink" title="Build-Tools"></a>Build-Tools</h3><p>è¿™æ˜¯Androidå¼€å‘æ‰€éœ€çš„Build-Toolsï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ° <code>your sdk è·¯å¾„/build-tools</code> æ–‡ä»¶å¤¹å³å¯ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">22.0.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3kqFHV" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGquuqU" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDdDne5" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:center">21.1.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqH1pZY" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hq1mml2" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">21.1.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgzFXW0" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i367FTz" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">21.1.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJ3DCGN" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqIfeCW" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">21.0.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTDpnt9" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDCf9TZ" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">21.0.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQreI6A" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQCd5YE" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">21.0.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3y0mKd" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3oWM01" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">20.0.0</td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0AfIOK" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">19.1.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nttAyhV" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nt2vM21" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">19.0.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qWCzdwC" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hq7VIgG" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">19.0.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntl0Qnf" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1xY7PO" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">19.0.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJ1BJrt" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o65bAwa" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">19.0.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6I8NBs" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0dBDvE" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h4><p>è¿™æ˜¯Androidå¼€å‘æ‰€éœ€çš„sdkï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/platforms</code>æ–‡ä»¶å¤¹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">android 5.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i33Puo1" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6v7E2I" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6v7E2I" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android L Rev3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1u8dhc" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jG1duN8" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jG1duN8" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android L</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3tDDvZ" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntHmhYx" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntHmhYx" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.4W</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eYPGE" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nt5GKWh" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nt5GKWh" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.4.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQf8ZgI" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c03XoL6" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c03XoL6" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o65bfV8" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bn1tNm3" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bn1tNm3" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.2.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgICw9E" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJJSlfl" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJJSlfl" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.1.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nt3bpI5" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTA6V8z" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTA6V8z" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJoegpd" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGzdDxc" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGzdDxc" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0H6Ld2" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqwzPTa" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqwzPTa" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGLvX6A" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qWqH9Q8" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qWqH9Q8" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJ0naTP" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jG62PSy" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jG62PSy" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0hi7Ck" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bn2Duub" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bn2Duub" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 2.3.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ngubc" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGge2bk" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGge2bk" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 2.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qW8YzY8" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntmJVmD" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntmJVmD" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="SDK-System-images"><a href="#SDK-System-images" class="headerlink" title="SDK System images"></a>SDK System images</h4><p>è¿™æ˜¯åœ¨åˆ›å»ºæ¨¡æ‹Ÿå™¨æ—¶éœ€è¦çš„system imageï¼Œä¹Ÿå°±æ˜¯åœ¨åˆ›å»ºæ¨¡æ‹Ÿå™¨æ—¶<code>CPU/ABI</code>é¡¹éœ€è¦é€‰æ‹©çš„ï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/system-images</code>æ–‡ä»¶å¤¹ä¸‹å³å¯ï¼Œ å¦‚æœæ²¡æœ‰<code>system-images</code>ç›®å½•å°±å…ˆåˆ›å»ºæ­¤æ–‡ä»¶å¤¹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">android 5.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntwpDQL" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1D7glC" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1D7glC" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android L</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqIcqhA" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntFQlRV" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntFQlRV" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.4W</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgJVZfE" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1GmAE6" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1GmAE6" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.4.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3Jwhed" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qW0QWdm" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qW0QWdm" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1guLaQ" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJPp6dX" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJPp6dX" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.2.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJO99hD" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTyZo27" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTyZo27" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.1.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1nMr4E" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kT2xdxd" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kT2xdxd" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i3Fsx6H" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdnCh2b" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdnCh2b" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJzIXZl" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqoWcNM" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqoWcNM" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="GoogleMap-APIs-SDK"><a href="#GoogleMap-APIs-SDK" class="headerlink" title="GoogleMap APIs SDK"></a>GoogleMap APIs SDK</h4><p>è¿™æ˜¯GoogleMap APIs SDKï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/add-ons</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">android 4.4.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bno0mFt" target="_blank" rel="external">ä¸‹è½½ARMç‰ˆ</a> <a href="http://pan.baidu.com/s/1jGgKyZc" target="_blank" rel="external">ä¸‹è½½x86ç‰ˆ</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bngsIkB" target="_blank" rel="external">ä¸‹è½½ARMç‰ˆ</a> <a href="http://pan.baidu.com/s/1eQDwCpG" target="_blank" rel="external">ä¸‹è½½x86ç‰ˆ</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bngsIkB" target="_blank" rel="external">ä¸‹è½½ARMç‰ˆ</a> <a href="http://pan.baidu.com/s/1eQDwCpG" target="_blank" rel="external">ä¸‹è½½x86ç‰ˆ</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bnb9at5" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdJ0mqR" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdJ0mqR" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.2.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGl4hZw" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDmurr7" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDmurr7" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.1.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntK9Urf" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgIAcpa" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgIAcpa" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bnEiHiB" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqBWAIo" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqBWAIo" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gd68WtP" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqBWAIo" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqBWAIo" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6Dgtse" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdf49Jt" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gdf49Jt" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.1</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6Dgtse" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGBS4rO" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGBS4rO" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 3.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0CKIFA" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0iY68w" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0iY68w" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 2.3.3</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqHwsHA" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDvhHOt" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDvhHOt" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 2.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qWJNPyk" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQEc8SU" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQEc8SU" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Google-Glass-SDK"><a href="#Google-Glass-SDK" class="headerlink" title="Google Glass SDK"></a>Google Glass SDK</h4><p>è¿™æ˜¯GDKï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/add-ons</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">android 4.4.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1fENeu" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQpGaA2" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQpGaA2" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">android 4.0.3</td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqikzUs" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Google-TV-Addon"><a href="#Google-TV-Addon" class="headerlink" title="Google TV Addon"></a>Google TV Addon</h4><p>è¿™æ˜¯Google TV Addonï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/add-ons</code>æ–‡ä»¶å¤¹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">android 3.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1qWLPFfm" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQFy1KA" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQFy1KA" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<p>####Android Framework Source Code<br>è¿™æ˜¯Android Framework Source Codeï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/sources</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)ï¼Œè¿™æ ·å½“ä½ åœ¨Eclipseé‡Œé¢æŒ‰ä½<code>Ctrl</code>é”®ç‚¹å‡»æŸä¸ªç³»ç»Ÿç±»æ—¶å°±å¯ä»¥æ‰“å¼€è¯¥ç±»çš„æºç æ–‡ä»¶æŸ¥çœ‹æºç äº†ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dD5Z1Hf" target="_blank" rel="external">android 5.0</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eQf6F0Q" target="_blank" rel="external">android 4.4W</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1hqGGrVA" target="_blank" rel="external">android 4.4.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1pJI3YrD" target="_blank" rel="external">android 4.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1qWlXS9u" target="_blank" rel="external">android 4.2.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1qWv1spm" target="_blank" rel="external">android 4.1.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1jGGCpuu" target="_blank" rel="external">android 4.0.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1o61AZwQ" target="_blank" rel="external">android 4.0</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1pJt14En" target="_blank" rel="external">android 3.0</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eQekIPW" target="_blank" rel="external">android 2.3.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1bny9E2b" target="_blank" rel="external">android 2.2</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-SDK-Extras"><a href="#Android-SDK-Extras" class="headerlink" title="Android SDK Extras"></a>Android SDK Extras</h4><p>åŒ…å« <code>Android Support Library</code> ã€ <code>Google Cloud Messaging for Android Library</code> ã€<code>Google Play services</code> ã€ <code>Google Play services for fit preview</code> ã€<code>Google Play services for Froyo</code> ã€<code>Google Play APK Expansion Library</code>ã€<code>Google Play Billing Library</code> ã€<code>Google Play Licensing Library</code> ç­‰ï¼Œä¸‹è½½è§£å‹åå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk</code>æ ¹ç›®å½•ä¸‹ä¸‹ï¼Œå¦‚æœå·²ç»å­˜åœ¨<code>extras</code>æ–‡ä»¶å¤¹å°±æ›¿æ¢æ‰ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTmlB9d" target="_blank" rel="external">21.0.3</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgso8Y0" target="_blank" rel="external">21.0.2</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6v78Lk" target="_blank" rel="external">21</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1eQIMXMy" target="_blank" rel="external">20</a></td>
</tr>
</tbody>
</table>
<h4 id="Support-Library"><a href="#Support-Library" class="headerlink" title="Support Library"></a>Support Library</h4><p>åŒ…å«support <code>v4</code>ã€<code>v7</code>ã€<code>v13</code>ã€<code>v17</code>ã€<code>multidex</code>å’Œ<code>m2repository</code>ï¼Œä¸‹è½½è§£å‹åå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/extras</code>ä¸‹ï¼Œç„¶åæ‰“å¼€SDK Managerï¼Œæ‰“å¼€<code>Tools(å·¥å…·)</code>èœå•é€‰æ‹©<code>Options(é€‰é¡¹)</code>èœå•é¡¹æ‰“å¼€Android SDK Manager Settingå¯¹è¯æ¡†ï¼Œç‚¹å‡»<code>Clear Cache(æ¸…é™¤ç¼“å­˜)</code>æŒ‰é’®ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)å’ŒSDK Managerã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntsoeE1" target="_blank" rel="external">21.0.3</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTzIkYV" target="_blank" rel="external">21.0.2</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6MBWIu" target="_blank" rel="external">21</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6OBlR8" target="_blank" rel="external">20</a></td>
</tr>
</tbody>
</table>
<h4 id="SDK-Samples"><a href="#SDK-Samples" class="headerlink" title="SDK Samples"></a>SDK Samples</h4><p>è¿™æ˜¯Android SDKè‡ªå¸¦çš„ç¤ºä¾‹ä»£ç ï¼Œä¸‹è½½å¹¶è§£å‹åï¼Œå°†è§£å‹å‡ºçš„æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°<code>your sdk è·¯å¾„/samples</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åé‡å¯Eclipse(æˆ–Android Studio)ã€‚<br>ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç³»ç»Ÿç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDD19XB" target="_blank" rel="external">android 21</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1gdpEan5" target="_blank" rel="external">android L</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1ntLVN9B" target="_blank" rel="external">android 4.4W</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDeSKt7" target="_blank" rel="external">android 4.4.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1pJHicjx" target="_blank" rel="external">android 4.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1hqGavMc" target="_blank" rel="external">android 4.2.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eYPL8" target="_blank" rel="external">android 4.1.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1i3mScXv" target="_blank" rel="external">android 4.0.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1kTiKqZP" target="_blank" rel="external">android 4.0</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eQpafgI" target="_blank" rel="external">android 3.2</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1haIPw" target="_blank" rel="external">android 3.1</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1ntx9qFR" target="_blank" rel="external">android 3.0</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1hqiQw1Q" target="_blank" rel="external">android 2.3.3</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1ntv7wut" target="_blank" rel="external">android 2.2</a></td>
</tr>
</tbody>
</table>
<h4 id="NDK"><a href="#NDK" class="headerlink" title="NDK"></a>NDK</h4><p>C/C++å¼€å‘Androidåº”ç”¨å·¥å…·åŒ…,<code>Linux/Mac OS X ä¸‹NDK r10c</code>çš„å®‰è£…æ–¹æ³•è¯·æˆ³ <a href="install-method-url">è¿™é‡Œ</a></p>
<table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
<th style="text-align:left">MD5/SHA-1æ ¡éªŒç </th>
<th style="text-align:center">å®˜æ–¹SHA-1æ ¡éªŒç æˆªå›¾</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ndk-r11b</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1JWvUI" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1pKlqcZL" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pKi8yJT" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0YLv00" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:left">Win:b42da395440cc1c5dc4eeeb383679331addeb3ea <br> 480eca1b29cfe73a5b35374730e6a82ca65c2aa6 <br> Mac: c64fb355fec4da57d329ab45bf0aa29a1aec58dc <br> Linux: cf0658956945c81d3d3fad5f9a24fa062d4c9d41</td>
<td style="text-align:center"><a href="http://ww2.sinaimg.cn/large/8a41f469gw1f25wwym8t6j21kw0rxwja.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
<tr>
<td style="text-align:left">ndk-r10e</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jG7Yacm" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1jG5WjL8" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1DKkfc" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1sjoneRr" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1dDAqnK1" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:left">Win: 1a82445baaf62aec3a46386ab1e5772c <br>  8412bb4991a95e08fda50b5a44d95df7 <br> Mac: 2cb8893a5701603519d38a7e04c50e81 <br> Linux: c3edd3273029da1cbd2f62c48249e978 <br> 19af543b068bdb7f27787c2bc69aba7f</td>
<td style="text-align:center"><a href="http://ww1.sinaimg.cn/large/8a41f469gw1ewboorr3czj21kk0vgdmn.jpg" target="_blank" rel="external">æŸ¥çœ‹</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">Additional Download (32-, 64-bit)</th>
<th style="text-align:left">Package</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">r10 STL debug info</td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1xWgUE" target="_blank" rel="external">android-ndk-r10-cxx-stl-libs-with-debug-info.zip</a></td>
</tr>
<tr>
<td style="text-align:left">r9 STL debug info</td>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1c0EMn8O" target="_blank" rel="external">android-ndk-r9-cxx-stl-libs-with-debug-info.zip</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-L-Preview-System-Image"><a href="#Android-L-Preview-System-Image" class="headerlink" title="Android L Preview System Image"></a>Android L Preview System Image</h4><p>è¿™ä¸ªæ˜¯Android L Previewç³»ç»Ÿçš„åˆ·æœºé•œåƒã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">è®¾å¤‡</th>
<th style="text-align:center">ä¸‹è½½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Nexus 5 (GSM/LTE) â€œhammerheadâ€</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1kTsnxsF" target="_blank" rel="external">hammerhead-lpv79-preview-ac1d8a8e.tgz</a></td>
</tr>
<tr>
<td style="text-align:center">Nexus 7 (Wifi) â€œrazorâ€</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgn1CyG" target="_blank" rel="external">razor-lpv79-preview-d0ddf8ce.tgz</a></td>
</tr>
</tbody>
</table>
<h4 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h4><table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1.8 u77</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hsFDbBu" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1kUJuzH1" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bRetFw" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i4YX7VZ" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1slBWTIH" target="_blank" rel="external">64ä½</a></td>
</tr>
<tr>
<td style="text-align:center">1.8 u74</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c1w1TCk" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1nu3BdVj" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c0Tv5Pe" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1gecIYxP" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1hrtBXkg" target="_blank" rel="external">64ä½</a></td>
</tr>
<tr>
<td style="text-align:center">1.7 u80</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bfAT58" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1gewvEAR" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hrl4x3u" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1c1pG2Fu" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1hrecZ9U" target="_blank" rel="external">64ä½</a></td>
</tr>
<tr>
<td style="text-align:center">1.6 u45</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o67aooM" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1dDmtSZJ" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqpB7Nm" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJJj5Ib" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1dDck3O9" target="_blank" rel="external">64ä½</a></td>
</tr>
</tbody>
</table>
<h4 id="ADT-Bundle"><a href="#ADT-Bundle" class="headerlink" title="ADT Bundle"></a>ADT Bundle</h4><p>ADT BundleåŒ…å«äº†Eclipseã€ADTæ’ä»¶å’ŒSDK Toolsï¼Œæ˜¯å·²ç»é›†æˆå¥½çš„IDEï¼Œåªéœ€å®‰è£…å¥½Jdkå³å¯å¼€å§‹å¼€å‘ï¼Œæ¨èåˆå­¦è€…ä¸‹è½½ADT Bundleï¼Œä¸ç”¨å†æŠ˜è…¾å¼€å‘ç¯å¢ƒã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">23.0.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dDGM8oD" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1mgn2dOs" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o6OBIHG" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1GmIsQ" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1EQMT4" target="_blank" rel="external">64ä½</a></td>
</tr>
<tr>
<td style="text-align:center">23.0.0</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i39mvY1" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1o65ExPS" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqvHkry" target="_blank" rel="external">64ä½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgoh41q" target="_blank" rel="external">32ä½</a> <a href="http://pan.baidu.com/s/1qWJh4wk" target="_blank" rel="external">64ä½</a></td>
</tr>
</tbody>
</table>
<h4 id="ADT-Plugin"><a href="#ADT-Plugin" class="headerlink" title="ADT Plugin"></a>ADT Plugin</h4><p>ç¦»çº¿å®‰è£…ADTæ’ä»¶è¯·æˆ³<a href="https://github.com/inferjay/AndroidDevTools/wiki/é¦–é¡µ" target="_blank" rel="external"><strong>é¡¹ç›®wiki</strong></a></p>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰ˆæœ¬å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bngDm6V" target="_blank" rel="external">ADT-23.0.7</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGraNEQ" target="_blank" rel="external">ADT-23.0.6</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1i39UM7j" target="_blank" rel="external">ADT-23.0.4</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1hqJyLTi" target="_blank" rel="external">ADT-23.0.3</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bnGkEvX" target="_blank" rel="external">ADT-23.0.2</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1sjArX7J" target="_blank" rel="external">ADT-23.0.0</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jGMb5yQ" target="_blank" rel="external">ADT-22.6.3</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1pJ185Rl" target="_blank" rel="external">AdT-22.6.1</a></td>
</tr>
</tbody>
</table>
<h4 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h4><table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1gdLhXa7" target="_blank" rel="external">gradle-2.12-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1gewXkzx" target="_blank" rel="external">gradle-2.11-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1mhrKIF2" target="_blank" rel="external">gradle-2.10-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eRll1Ns" target="_blank" rel="external">gradle-2.9-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1qW25Ndy" target="_blank" rel="external">gradle-2.8-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1c0g9D5m" target="_blank" rel="external">gradle-2.7-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1mg8JAbA" target="_blank" rel="external">gradle-2.6-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1jGrmKx4" target="_blank" rel="external">gradle-2.5-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1c0dcgfe" target="_blank" rel="external">gradle-2.4-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDEnQr3" target="_blank" rel="external">gradle-2.3-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1eQH39AE" target="_blank" rel="external">gradle-2.2.1-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1i3BXKYp" target="_blank" rel="external">gradle-2.2-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1bnF6jV5" target="_blank" rel="external">gradle-2.1-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1mgFTN7a" target="_blank" rel="external">gradle-2.0-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1Gmlx8" target="_blank" rel="external">gradle-1.12-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1c0hCmdE" target="_blank" rel="external">gradle-1.11-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1qWtzaGW" target="_blank" rel="external">gradle-1.10-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1dDeSuXV" target="_blank" rel="external">gradle-1.9-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1o6Npqqe" target="_blank" rel="external">gradle-1.8-all.zip</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1pJnvyWz" target="_blank" rel="external">gradle-1.7-all.zip</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Gradle-Plugin-DSL-åœ¨çº¿æ–‡æ¡£"><a href="#Android-Gradle-Plugin-DSL-åœ¨çº¿æ–‡æ¡£" class="headerlink" title="Android Gradle Plugin DSL åœ¨çº¿æ–‡æ¡£"></a>Android Gradle Plugin DSL åœ¨çº¿æ–‡æ¡£</h4><p><a href="http://google.github.io/android-gradle-dsl/" target="_blank" rel="external">http://google.github.io/android-gradle-dsl/</a></p>
<h4 id="Gradle-Dependencies-Configuration-Generatorï¼ˆéœ€è¦æ¢¯å­ï¼‰"><a href="#Gradle-Dependencies-Configuration-Generatorï¼ˆéœ€è¦æ¢¯å­ï¼‰" class="headerlink" title="Gradle Dependencies Configuration Generatorï¼ˆéœ€è¦æ¢¯å­ï¼‰"></a>Gradle Dependencies Configuration Generatorï¼ˆéœ€è¦æ¢¯å­ï¼‰</h4><p><a href="http://gradleplease.appspot.com" target="_blank" rel="external">http://gradleplease.appspot.com</a></p>
<h4 id="ç‰ˆæœ¬æ§åˆ¶å·¥å…·"><a href="#ç‰ˆæœ¬æ§åˆ¶å·¥å…·" class="headerlink" title="ç‰ˆæœ¬æ§åˆ¶å·¥å…·"></a>ç‰ˆæœ¬æ§åˆ¶å·¥å…·</h4><h5 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h5><table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
<th style="text-align:center">Windows</th>
<th style="text-align:center">Mac OSX</th>
<th style="text-align:center">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Git-2.0.1</td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mgkM9BE" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://github.com/inferjay/AndroidDevTools/wiki/Download-for-Linux-and-Unix" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">Git-1.9.4</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntjy9N7" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://github.com/inferjay/AndroidDevTools/wiki/Download-for-Linux-and-Unix" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">Git-1.8.5.2</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1ntJWxeD" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bncr1pX" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://github.com/inferjay/AndroidDevTools/wiki/Download-for-Linux-and-Unix" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h5 id="SVN-Plugin-For-Eclipse"><a href="#SVN-Plugin-For-Eclipse" class="headerlink" title="SVN Plugin For Eclipse"></a>SVN Plugin For Eclipse</h5><table>
<thead>
<tr>
<th style="text-align:left">ç‰ˆæœ¬å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1mg2x4Xq" target="_blank" rel="external">1.10.5</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1hqswoGs" target="_blank" rel="external">1.8.22</a></td>
</tr>
<tr>
<td style="text-align:left"><a href="http://pan.baidu.com/s/1o60r6UA" target="_blank" rel="external">1.6.18</a></td>
</tr>
</tbody>
</table>
<h4 id="åç¼–è¯‘å·¥å…·"><a href="#åç¼–è¯‘å·¥å…·" class="headerlink" title="åç¼–è¯‘å·¥å…·"></a>åç¼–è¯‘å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Enjarify</td>
<td style="text-align:left">Enjarify æ˜¯ä¸€ä¸ªç”¨ Python å†™çš„ï¼Œ Google å®˜æ–¹å¼€æºçš„å¯ä»¥å°† Dalvik å­—èŠ‚ç è½¬æ¢ä¸º Java å­—èŠ‚ç çš„å·¥å…·ã€‚</td>
<td style="text-align:center"><a href="https://github.com/google/enjarify" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
<tr>
<td style="text-align:left">JEB Android Decompiler</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://www.android-decompiler.com/index.php" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Virtuous Ten Studio</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://virtuous-ten-studio.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Apkæ–‡ä»¶ä¿®æ”¹å·¥å…·Root Tools</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/Stericson/RootTools" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Dexæ–‡ä»¶åç¼–è¯‘å·¥å…·Dedexer</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://dedexer.sourceforge.net" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">APK+Dexæ–‡ä»¶åç¼–è¯‘åŠå›ç¼–è¯‘å·¥å…·</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://idoog.me" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">android-apktool</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://ibotpeaches.github.io/Apktool/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Onekey Decompile Apk]</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://code.google.com/p/onekey-decompile-apk/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Baksmali</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://code.google.com/p/smali/downloads/detail?name=baksmali" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Smali</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://code.google.com/p/smali/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">AXMLPrinter2</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://android4me.googlecode.com/files/AXMLPrinter2.jar" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JAD Java Decompiler</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://varaneckas.com/jad/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JD-GUI Decompiler</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/java-decompiler/jd-gui/releases/tag/v1.4.0" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">XJad V2.2</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://files.cnblogs.com/arix04/XJad_V2.2.rar" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android APK Decompiler</td>
<td style="text-align:left">åœ¨çº¿åç¼–è¯‘å·¥å…·</td>
<td style="text-align:center"><a href="http://www.decompileandroid.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JADX - Dex to Java decompiler</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/skylot/jadx" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">dex2jar</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://code.google.com/p/dex2jar/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">SmaliViewer</td>
<td style="text-align:left">æ˜¯ä¸€æ¬¾å…è´¹çš„APKåˆ†æè½¯ä»¶ï¼Œæ— è®ºä»åˆ†æçš„æ·±åº¦<br>è¿˜æ˜¯å¹¿åº¦æ¥çœ‹ï¼Œéƒ½æ˜¯ä¸€æ¬¾èƒ½å¤Ÿæ»¡è¶³ç”¨æˆ·éœ€æ±‚çš„äº§å“ï¼Œ<br>ä½¿æ‚¨åœ¨APKåˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚</td>
<td style="text-align:center"><a href="http://blog.avlyun.com/wp-content/uploads/2014/04/SmaliViewer.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://blog.avlyun.com/show/ã€Šsvç”¨æˆ·æŒ‡å—ã€‹/" target="_blank" rel="external">ä½¿ç”¨æŒ‡å—</a></td>
</tr>
<tr>
<td style="text-align:left">Androidé€†å‘åŠ©æ‰‹</td>
<td style="text-align:left">Androidé€†å‘åŠ©æ‰‹æ˜¯ä¸€åŠŸèƒ½å¼ºå¤§çš„é€†å‘è¾…åŠ©è½¯ä»¶ã€‚<br>è¯¥è½¯ä»¶å¯ä»¥å¸®åŠ©ç”¨æˆ·æ¥è¿›è¡Œapkåç¼–è¯‘æ‰“åŒ…ç­¾åï¼›<br>dex/jaräº’è½¬æ›¿æ¢æå–ä¿®å¤ï¼›soåç¼–è¯‘ï¼›<br>xmlã€txtåŠ å¯†ï¼›å­—ç¬¦ä¸²ç¼–ç ç­‰ç­‰ï¼Œæ“ä½œç®€å•<br>ï¼Œåªéœ€è¦ç›´æ¥å°†æ–‡ä»¶æ‹–æ”¾åˆ°æºå’Œç›®æ ‡æ–‡ä»¶ã€‚</td>
<td style="text-align:center"><a href="http://enjoycode.info/uploads/Androidnxzs.zip" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://www.sanwho.com/620.html" target="_blank" rel="external">ä½¿ç”¨æŒ‡å—</a></td>
</tr>
<tr>
<td style="text-align:left">Android Killer</td>
<td style="text-align:left">Android Killer æ˜¯ä¸€æ¬¾å¯è§†åŒ–çš„å®‰å“åº”ç”¨é€†å‘å·¥å…·ï¼Œ<br>é›†Apkåç¼–è¯‘ã€Apkæ‰“åŒ…ã€Apkç­¾åï¼Œç¼–ç äº’è½¬ï¼Œ<br>ADBé€šä¿¡ï¼ˆåº”ç”¨å®‰è£…-å¸è½½-è¿è¡Œ-è®¾å¤‡æ–‡ä»¶ç®¡ç†ï¼‰<br>ç­‰ç‰¹è‰²åŠŸèƒ½äºä¸€ èº«ï¼Œæ”¯æŒlogcatæ—¥å¿—è¾“å‡ºï¼Œ<br>è¯­æ³•é«˜äº®ï¼ŒåŸºäºå…³é”®å­—ï¼ˆæ”¯æŒå•è¡Œä»£ç æˆ–å¤šè¡Œä»£ç æ®µï¼‰<br>é¡¹ç›®å†…æœç´¢ï¼Œå¯è‡ªå®šä¹‰å¤–éƒ¨å·¥å…·ï¼›å¸æ”¶èæ±‡å¤šç§å·¥å…·åŠŸèƒ½ä¸ç‰¹ç‚¹ï¼Œ<br>æ‰“é€ ä¸€ç«™ å¼é€†å‘å·¥å…·æ“ä½œä½“éªŒï¼Œå¤§å¤§ç®€åŒ–äº†ç”¨æˆ·åœ¨<br>å®‰å“åº”ç”¨/æ¸¸æˆä¿®æ”¹è¿‡ç¨‹ä¸­çš„å„ç±»ç¹çå·¥ä½œã€‚</td>
<td style="text-align:center"><a href="http://www.pd521.com/thread-136-1-1.html" target="_blank" rel="external">ä¸‹è½½1</a><br><a href="http://pan.baidu.com/share/home?uk=4099707276#category/type=6" target="_blank" rel="external">ä¸‹è½½2</a></td>
<td style="text-align:center"><a href="http://www.pd521.com/thread-509-1-1.html" target="_blank" rel="external">ä½¿ç”¨æŒ‡å—</a></td>
</tr>
<tr>
<td style="text-align:left">DexExtractor</td>
<td style="text-align:left">android dex extractor ï¼Œanti-shellï¼Œandroid è„±å£³ã€‚</td>
<td style="text-align:center"><a href="https://github.com/bunnyblue/DexExtractor" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">jadx</td>
<td style="text-align:left">Dex to Java decompiler</td>
<td style="text-align:center"><a href="https://github.com/skylot/jadx" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">android-classyshark</td>
<td style="text-align:left">a handy Android and Java executables viewer</td>
<td style="text-align:center"><a href="https://github.com/google/android-classyshark" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ShakaApktool</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/rover12421/ShakaApktool" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å®‰å…¨å·¥å…·"><a href="#å®‰å…¨å·¥å…·" class="headerlink" title="å®‰å…¨å·¥å…·"></a>å®‰å…¨å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">APKfuscator</td>
<td style="text-align:center"><a href="https://github.com/strazzere/APKfuscator" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ApkAnalyser</td>
<td style="text-align:center"><a href="https://github.com/sonyxperiadev/ApkAnalyser/downloads" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">AppXplore</td>
<td style="text-align:center"><a href="https://play.google.com/store/apps/details?id=com.sonyericsson.androidapp.AppExplore&amp;feature=search_result#?t=W251bGwsMSwxLDEsImNvbS5zb255ZXJpY3Nzb24uYW5kcm9pZGFwcC5BcHBFeHBsb3JlIl0." target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android analysis framework</td>
<td style="text-align:center"><a href="http://www.dexlabs.org" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Androguard</td>
<td style="text-align:center"><a href="https://code.google.com/p/androguard/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Droidbox</td>
<td style="text-align:center"><a href="https://code.google.com/p/droidbox/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">dsploit</td>
<td style="text-align:center"><a href="https://github.com/evilsocket/dsploit" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Androwarn</td>
<td style="text-align:center"><a href="https://github.com/maaaaz/androwarn" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Anubis</td>
<td style="text-align:center"><a href="http://anubis.iseclab.org" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Drozer</td>
<td style="text-align:center"><a href="https://www.mwrinfosecurity.com/products/drozer/community-edition/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">VirusTotal</td>
<td style="text-align:center"><a href="https://www.virustotal.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">GDB for Android</td>
<td style="text-align:center"><a href="http://gnutoolchains.com/android/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">VisualGDB</td>
<td style="text-align:center"><a href="http://visualgdb.com/?features=android" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="é™æ€ä»£ç åˆ†æå·¥å…·"><a href="#é™æ€ä»£ç åˆ†æå·¥å…·" class="headerlink" title="é™æ€ä»£ç åˆ†æå·¥å…·"></a>é™æ€ä»£ç åˆ†æå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">infer</td>
<td style="text-align:left">Facebook å¼€æºçš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œç”¨äºåœ¨å‘å¸ƒç§»åŠ¨åº”ç”¨ä¹‹å‰å¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œæ‰¾å‡ºæ½œåœ¨çš„é—®é¢˜ã€‚</td>
<td style="text-align:center"><a href="https://github.com/facebook/infer" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="æœç´¢å·¥å…·"><a href="#æœç´¢å·¥å…·" class="headerlink" title="æœç´¢å·¥å…·"></a>æœç´¢å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Structural Java Exception Search</td>
<td style="text-align:left">Javaå¼‚å¸¸æœç´¢å·¥å…·</td>
<td style="text-align:center"><a href="http://www.brainleg.com/search" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Library Finder</td>
<td style="text-align:left">æœ€å¿«çš„æ–¹å¼è·å–ä¾èµ–åº“</td>
<td style="text-align:center"><a href="https://github.com/cesarferreira/alfi" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Codota</td>
<td style="text-align:left">ç¤ºä¾‹ä»£ç æœç´¢ç½‘ç«™</td>
<td style="text-align:center"><a href="http://www.codota.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Debugè°ƒè¯•å·¥å…·"><a href="#Debugè°ƒè¯•å·¥å…·" class="headerlink" title="Debugè°ƒè¯•å·¥å…·"></a>Debugè°ƒè¯•å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Stetho</td>
<td style="text-align:left">Stetho æ˜¯Facebookæ¨å‡ºçš„Android è°ƒè¯•å¹³å°ï¼ŒåŸºäº Chrome Developer Tools ï¼Œè°ƒè¯•ç½‘ç»œè¯·æ±‚æ–¹é¢ç‰¹åˆ«æ–¹ä¾¿ã€‚</td>
<td style="text-align:center"><a href="https://github.com/facebook/stetho" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://facebook.github.io/stetho/" target="_blank" rel="external">æ•™ç¨‹</a></td>
</tr>
<tr>
<td style="text-align:left">Augmented Traffic Control</td>
<td style="text-align:left">Facebookå®£å¸ƒå¼€æºç§»åŠ¨ç½‘ç»œæµ‹è¯•å·¥å…·ATCï¼Œè¯¥å·¥å…·æ”¯æŒåˆ©ç”¨Wi-Fiç½‘ç»œæ¨¡æ‹Ÿ2Gã€2.5Gã€3Gä»¥åŠLTE 4Gç§»åŠ¨ç½‘ç»œç¯å¢ƒï¼Œè®©æµ‹è¯•å·¥ç¨‹å¸ˆä»¬èƒ½å¤Ÿå¿«é€Ÿå¯¹æ™ºèƒ½æ‰‹æœºå’ŒAppåœ¨ä¸åŒå›½å®¶åœ°åŒºå’Œåº”ç”¨ç¯å¢ƒä¸‹çš„æ€§èƒ½è¡¨ç°è¿›è¡Œæµ‹è¯•ã€‚</td>
<td style="text-align:center"><a href="https://github.com/facebook/augmented-traffic-control" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h3 id="Apiæµ‹è¯•å·¥å…·"><a href="#Apiæµ‹è¯•å·¥å…·" class="headerlink" title="Apiæµ‹è¯•å·¥å…·"></a>Apiæµ‹è¯•å·¥å…·</h3><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bat</td>
<td style="text-align:left">ä¸€ä¸ªç”¨Goå†™çš„å‘½ä»¤è¡ŒAPIæµ‹è¯•åˆ©å™¨ï¼Œæ”¯æŒæ–‡ä»¶ä¸‹è½½ï¼Œ<br>æ–‡ä»¶ä¸Šä¼ ï¼Œæ”¯æŒLinuxçš„pipeæ–¹å¼ï¼Œæ€»ä¹‹å°±æ˜¯ç‚«é…·ã€‚</td>
<td style="text-align:center"><a href="http://www.brainleg.com/search" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="https://github.com/astaxie/bat#installation" target="_blank" rel="external">ä½¿ç”¨æŒ‡å—</a></td>
</tr>
</tbody>
</table>
<h4 id="Eclipse-Android-Studio-IDEAæ’ä»¶"><a href="#Eclipse-Android-Studio-IDEAæ’ä»¶" class="headerlink" title="Eclipse/Android Studio/IDEAæ’ä»¶"></a>Eclipse/Android Studio/IDEAæ’ä»¶</h4><h5 id="Eclipse"><a href="#Eclipse" class="headerlink" title="Eclipse"></a>Eclipse</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SVN</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1sjqamOP" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Genymobileæ¨¡æ‹Ÿå™¨</td>
<td style="text-align:center"><a href="http://genymotion.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Memory-Analyzer-Tools</td>
<td style="text-align:center"><a href="http://download.eclipse.org/mat/1.4/update-site/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Droidinspector</td>
<td style="text-align:center"><a href="http://www.sriramramani.com/droidinspector/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">SQLiteManager</td>
<td style="text-align:center"><a href="https://dl.dropboxusercontent.com/u/91846918/sqlite%20manager/com.questoid.sqlitemanager_1.0.0.jar" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Color Theme</td>
<td style="text-align:center"><a href="http://eclipsecolorthemes.org/?view=plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">RoboVM</td>
<td style="text-align:center"><a href="http://www.robovm.org" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Newrelic</td>
<td style="text-align:center"><a href="https://download.newrelic.com/android_agent/eclipse" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h5 id="Android-Studio-IDEA"><a href="#Android-Studio-IDEA" class="headerlink" title="Android Studio/IDEA"></a>Android Studio/IDEA</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Resource Resizer Plugin</td>
<td style="text-align:center"><a href="https://github.com/walmyrcarvalho/android-resource-resizer" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Gradle Dependencies Helper Plugin</td>
<td style="text-align:center"><a href="https://github.com/ligi/GradleDependenciesHelperPlugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Parcelable code generation Plugin</td>
<td style="text-align:center"><a href="https://github.com/mcharmas/android-parcelable-intellij-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Holo Colors IDEA Plugin</td>
<td style="text-align:center"><a href="https://github.com/jeromevdl/android-holo-colors-idea-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Toolbox Plugin</td>
<td style="text-align:center"><a href="https://github.com/idamobile/android-toolbox-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Gradle Sign Plugin</td>
<td style="text-align:center"><a href="https://github.com/alexvasilkov/AndroidGradleSignPlugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Permissions Usage Plugin</td>
<td style="text-align:center"><a href="https://github.com/RomainPiel/AndroidPermissionsUsage" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Helper Plugin</td>
<td style="text-align:center"><a href="https://github.com/eunjae-lee/AndroidHelper" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Studio Prettify Plugin</td>
<td style="text-align:center"><a href="https://github.com/Haehnchen/idea-android-studio-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">IDEA ADB Plugin</td>
<td style="text-align:center"><a href="https://github.com/pbreault/adb-idea" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Otto Intellij Plugin</td>
<td style="text-align:center"><a href="https://github.com/square/otto-intellij-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Dagger intellij Plugin</td>
<td style="text-align:center"><a href="https://github.com/square/dagger-intellij-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Gradle Gui Plugin</td>
<td style="text-align:center"><a href="https://github.com/gradle-archive/gradle-intellij-gui" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Studio Unit Test Plugin</td>
<td style="text-align:center"><a href="https://github.com/evant/android-studio-unit-test-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Layout ID Converter Plugin</td>
<td style="text-align:center"><a href="https://github.com/funnything/OffingHarbor" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">IDEA protobuf Plugin</td>
<td style="text-align:center"><a href="https://github.com/nnmatveev/idea-plugin-protobuf" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Simple Team Code Reviewer Plugin</td>
<td style="text-align:center"><a href="https://github.com/syllant/idea-plugin-revu" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android XML Plugin</td>
<td style="text-align:center"><a href="https://github.com/mironov-nsk/AndroidXML" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ADF Plugin</td>
<td style="text-align:center"><a href="https://github.com/tizionario/adf-intellijPlugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Java2smali Plugin</td>
<td style="text-align:center"><a href="https://github.com/ollide/intellij-java2smali" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">IDEA gitignore Plugin</td>
<td style="text-align:center"><a href="https://github.com/hsz/idea-gitignore" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">IDEA Background Image Plugin</td>
<td style="text-align:center"><a href="https://github.com/kimptoc/Intellij-IDEA-Plugin-Background-Image" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">IDEA Maven Plugin</td>
<td style="text-align:center"><a href="https://github.com/born2snipe/idea-plugin-maven-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Gradle GooglePlay Publisher Plugin</td>
<td style="text-align:center"><a href="https://github.com/Triple-T/gradle-play-publisher" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Drawable Selectors Generates Plugin</td>
<td style="text-align:center"><a href="https://github.com/inmite/android-selector-chapek" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Drawable Importer</td>
<td style="text-align:center"><a href="https://github.com/winterDroid/android-drawable-importer-intellij-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Color themes for IntelliJ IDEA</td>
<td style="text-align:center"><a href="https://github.com/winterDroid/android-drawable-importer-intellij-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">GsonFormat</td>
<td style="text-align:center"><a href="https://github.com/zzz40500/GsonFormat" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ormlite-android-gradle-plugin</td>
<td style="text-align:center"><a href="https://github.com/stephanenicolas/ormlite-android-gradle-plugin" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Androidèµ„æº-Themes-Styleç”Ÿæˆå·¥å…·"><a href="#Androidèµ„æº-Themes-Styleç”Ÿæˆå·¥å…·" class="headerlink" title="Androidèµ„æº/Themes/Styleç”Ÿæˆå·¥å…·"></a>Androidèµ„æº/Themes/Styleç”Ÿæˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Asset Studio</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://romannurik.github.io/AndroidAssetStudio/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Drawable Factory</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/tizionario/AndroidDrawableFactory" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Action Bar Style Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://jgilfelt.github.io/android-actionbarstylegenerator" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Holo Colors Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://android-holo-colors.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Simple Nine-patch Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://romannurik.github.io/AndroidAssetStudio/nine-patches.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Device Frame Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://f2prateek.com/android-device-frame-generator/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android 9-patch shadow generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://inloop.github.io/shadow4android/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Androidèµ„æºåˆ†æå·¥å…·"><a href="#Androidèµ„æºåˆ†æå·¥å…·" class="headerlink" title="Androidèµ„æºåˆ†æå·¥å…·"></a>Androidèµ„æºåˆ†æå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Assets Viewer</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://www.cellebellum.net/AndroidAssetsViewer/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Layout-Parserå·¥å…·"><a href="#Android-Layout-Parserå·¥å…·" class="headerlink" title="Android Layout Parserå·¥å…·"></a>Android Layout Parserå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Layout Binder</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://android.lineten.net/layout.php" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Content-Providerä»£ç ç”Ÿæˆå·¥å…·"><a href="#Android-Content-Providerä»£ç ç”Ÿæˆå·¥å…·" class="headerlink" title="Android Content Providerä»£ç ç”Ÿæˆå·¥å…·"></a>Android Content Providerä»£ç ç”Ÿæˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Content Provider Code Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://github.com/BoD/android-contentprovider-generator" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Fragment-Code-Generatorä»£ç ç”Ÿæˆå·¥å…·"><a href="#Android-Fragment-Code-Generatorä»£ç ç”Ÿæˆå·¥å…·" class="headerlink" title="Android Fragment Code Generatorä»£ç ç”Ÿæˆå·¥å…·"></a>Android Fragment Code Generatorä»£ç ç”Ÿæˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Fragment Code Generator</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="http://techisfun.github.io/pages/android-fragment-generator/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="ä»£ç ç”Ÿæˆå·¥å…·"><a href="#ä»£ç ç”Ÿæˆå·¥å…·" class="headerlink" title="ä»£ç ç”Ÿæˆå·¥å…·"></a>ä»£ç ç”Ÿæˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android KickstartR</td>
<td style="text-align:left">AndroidKickstartRå¸®åŠ©æ‚¨å¿«é€Ÿåˆ›å»º<br>Androidåº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨æœ€æµè¡Œçš„åº“è¿›è¡Œé…ç½®ã€‚<br>å®ƒåˆ›å»ºå’Œé…ç½®ä½ çš„é¡¹ç›®ç»™ä½ ã€‚åªä¸“æ³¨äºä»£ç !</td>
<td style="text-align:center"><a href="http://androidkickstartr.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Button Maker</td>
<td style="text-align:left">Android Button Makeræ˜¯ä¸€ä¸ªåœ¨çº¿ç”ŸæˆAndroidåº”ç”¨æŒ‰é’®ä»£ç çš„å·¥å…·ã€‚<br>Androidçš„APIæä¾›å¯ç»˜åˆ¶èµ„æºï¼Œå…¶ä¸­çš„XMLæ–‡ä»¶å®šä¹‰çš„å‡ ä½•å½¢çŠ¶ï¼ŒåŒ…æ‹¬é¢œè‰²ï¼Œè¾¹æ¡†å’Œæ¢¯åº¦ã€‚<br>è¿™äº›æŒ‰é’®æ˜¯åœ¨shape drawable XMLä»£ç åŸºç¡€ä¸Šäº§ç”Ÿçš„ç›¸æ¯”é€šå¸¸çš„PNGæŒ‰é’®åŠ è½½é€Ÿåº¦æ›´å¿«ã€‚<br>æ‚¨å¯ä»¥åœ¨è®¾ç½®é¢æ¿ä¸­è‡ªå®šä¹‰æŒ‰é’®çš„å±æ€§å’Œè·å¾—æºä»£ç ã€‚</td>
<td style="text-align:center"><a href="http://angrytools.com/android/button/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">DroidDraw</td>
<td style="text-align:left"></td>
<td style="text-align:center"><a href="https://code.google.com/p/droiddraw/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android SVG to VectorDrawable</td>
<td style="text-align:left">ä¸€ä¸ªå¯ä»¥å°†SVGå›¾ç‰‡è½¬æ¢ä¸ºVector Drawable xmlæ–‡ä»¶çš„åœ¨çº¿å·¥å…·ã€‚</td>
<td style="text-align:center"><a href="http://inloop.github.io/svg2android/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Nativeå¼€å‘å·¥å…·"><a href="#Android-Nativeå¼€å‘å·¥å…·" class="headerlink" title="Android Nativeå¼€å‘å·¥å…·"></a>Android Nativeå¼€å‘å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android++</td>
<td></td>
<td style="text-align:center"><a href="http://android-plus-plus.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Androidæµ‹è¯•å·¥å…·"><a href="#Androidæµ‹è¯•å·¥å…·" class="headerlink" title="Androidæµ‹è¯•å·¥å…·"></a>Androidæµ‹è¯•å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Appurify</td>
<td></td>
<td style="text-align:center"><a href="http://appurify.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Monkey</td>
<td></td>
<td style="text-align:center"><a href="http://developer.android.com/intl/zh-cn/tools/help/monkey.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Testin</td>
<td></td>
<td style="text-align:center"><a href="http://testin.cn" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Spoon</td>
<td></td>
<td style="text-align:center"><a href="http://square.github.io/spoon/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Little Eye</td>
<td></td>
<td style="text-align:center"><a href="http://www.littleeye.co" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">æ˜“æµ‹äº‘</td>
<td></td>
<td style="text-align:center"><a href="http://www.yiceyun.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Emmagee</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/emmagee/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Apk View Tracer</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/apk-view-tracer/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">APT</td>
<td>APTæ˜¯ä¸€ä¸ªAndroidå¹³å°é«˜æ•ˆæ€§èƒ½æµ‹è¯•ç»„ä»¶ï¼Œ<br>æä¾›ä¸°å¯Œå®ç”¨çš„åŠŸèƒ½ï¼Œé€‚ç”¨äºå¼€å‘è‡ªæµ‹ã€<br>å®šä½æ€§èƒ½ç“¶é¢ˆï¼›<br>æµ‹è¯•äººå‘˜å®Œæˆæ€§èƒ½åŸºå‡†æµ‹è¯•ã€ç«å“å¯¹æ¯”æµ‹è¯•ã€‚</td>
<td style="text-align:center"><a href="https://code.csdn.net/Tencent/apt" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://www.eoeandroid.com/thread-497380-1-1.html" target="_blank" rel="external">æ•™ç¨‹</a></td>
</tr>
<tr>
<td style="text-align:left">GT</td>
<td>GTï¼ˆéšèº«è°ƒï¼‰æ˜¯APPçš„éšèº«è°ƒæµ‹å¹³å°ï¼Œå®ƒæ˜¯ç›´æ¥è¿è¡Œåœ¨æ‰‹æœºä¸Šçš„â€œé›†æˆè°ƒæµ‹ç¯å¢ƒâ€(IDTE, Integrated Debug&amp;Test Environment)ã€‚</td>
<td style="text-align:center"><a href="http://gt.tencent.com/index.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://gt.tencent.com/docs.html" target="_blank" rel="external">æ•™ç¨‹</a></td>
</tr>
<tr>
<td style="text-align:left">Mobile-Checker</td>
<td>ç§»åŠ¨ç«¯é¡µé¢æ£€æŸ¥å·¥å…·,å¯ä»¥é€‰æ‹©ä¸‰ç§å±å¹•è§„æ ¼ï¼Œé€šè¿‡å·¥å…·å‘ç°ç½‘ç«™åœ¨ç§»åŠ¨ç«¯å­˜åœ¨çš„é—®é¢˜ã€‚</td>
<td style="text-align:center"><a href="https://github.com/w3c/Mobile-Checker" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Androidå¤šæ¸ é“æ‰“åŒ…å·¥å…·"><a href="#Androidå¤šæ¸ é“æ‰“åŒ…å·¥å…·" class="headerlink" title="Androidå¤šæ¸ é“æ‰“åŒ…å·¥å…·"></a>Androidå¤šæ¸ é“æ‰“åŒ…å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Umengå¤šæ¸ é“æ‰“åŒ…å·¥å…·</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/umeng/umeng-muti-channel-build-tool" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">AppToolså…·</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/wubo/apptools" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">package_tool</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/ahui2823/package_tool" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">RyApkTool</td>
<td></td>
<td style="text-align:center"><a href="http://blog.csdn.net/rydiy/article/details/7901564" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">å…°è´å£³å„¿</td>
<td></td>
<td style="text-align:center"><a href="http://www.orchidshell.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://www.orchidshell.com/Instructions/OchidShellInstructions.htm" target="_blank" rel="external">æ•™ç¨‹</a></td>
</tr>
</tbody>
</table>
<h4 id="Android-Bugæ—¥å¿—æ”¶é›†å·¥å…·"><a href="#Android-Bugæ—¥å¿—æ”¶é›†å·¥å…·" class="headerlink" title="Android Bugæ—¥å¿—æ”¶é›†å·¥å…·"></a>Android Bugæ—¥å¿—æ”¶é›†å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Crashlytics</td>
<td></td>
<td style="text-align:center"><a href="http://try.crashlytics.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ACRA</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/ACRA/acra" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ChkBugReport</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/sonyxperiadev/ChkBugReport" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Log Collector</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/android-log-collector/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Crash Catcher</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/netcook/crash-catcher" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å…¶ä»–è¯­è¨€å¼€å‘Androidåº”ç”¨å·¥å…·"><a href="#å…¶ä»–è¯­è¨€å¼€å‘Androidåº”ç”¨å·¥å…·" class="headerlink" title="å…¶ä»–è¯­è¨€å¼€å‘Androidåº”ç”¨å·¥å…·"></a>å…¶ä»–è¯­è¨€å¼€å‘Androidåº”ç”¨å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Xamarin</td>
<td></td>
<td style="text-align:center"><a href="http://xamarin.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Basic4android</td>
<td></td>
<td style="text-align:center"><a href="http://www.basic4ppc.com/index.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Scripting Layer</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/android-scripting/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Ruby Rhodes</td>
<td>ç§»åŠ¨è®¾å¤‡ä¸Šçš„Ruby</td>
<td style="text-align:center"><a href="http://rhomobile.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">PHP for Android</td>
<td></td>
<td style="text-align:center"><a href="http://www.phpforandroid.net/doku.php" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Codename One</td>
<td></td>
<td style="text-align:center"><a href="http://www.codenameone.com/index.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Touchqode</td>
<td></td>
<td style="text-align:center"><a href="http://www.codenameone.com/index.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">App Inventor</td>
<td></td>
<td style="text-align:center"><a href="http://www.codenameone.com/index.html" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿå·¥å…·"><a href="#ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿå·¥å…·" class="headerlink" title="ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿå·¥å…·"></a>ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Sensor Simulator</td>
<td>ç‹¬ç«‹çš„Javaåº”ç”¨ç¨‹åºï¼Œå®ƒæ¨¡æ‹Ÿä¼ æ„Ÿå™¨<br>çš„æ•°æ®å¹¶å°†å®ƒä»¬ä¼ é€åˆ°Androidæ¨¡æ‹Ÿå™¨ã€‚</td>
<td style="text-align:center"><a href="http://www.openintents.org/en/node/23)" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Androidä¸²å£å¼€å‘å·¥å…·"><a href="#Androidä¸²å£å¼€å‘å·¥å…·" class="headerlink" title="Androidä¸²å£å¼€å‘å·¥å…·"></a>Androidä¸²å£å¼€å‘å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Serialport Api</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/android-serialport-api/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å›¾ç‰‡å°ºå¯¸å¤„ç†å·¥å…·"><a href="#å›¾ç‰‡å°ºå¯¸å¤„ç†å·¥å…·" class="headerlink" title="å›¾ç‰‡å°ºå¯¸å¤„ç†å·¥å…·"></a>å›¾ç‰‡å°ºå¯¸å¤„ç†å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">9-Patch Resizer</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/redwarp/9-Patch-Resizer" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å›¾ç‰‡å‹ç¼©å·¥å…·"><a href="#å›¾ç‰‡å‹ç¼©å·¥å…·" class="headerlink" title="å›¾ç‰‡å‹ç¼©å·¥å…·"></a>å›¾ç‰‡å‹ç¼©å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">OptiPNG</td>
<td></td>
<td style="text-align:center"><a href="http://optipng.sourceforge.net/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Pngcrush</td>
<td></td>
<td style="text-align:center"><a href="http://pmt.sourceforge.net/pngcrush/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ImageOptim</td>
<td></td>
<td style="text-align:center"><a href="https://imageoptim.com)" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Tinypng</td>
<td></td>
<td style="text-align:center"><a href="https://tinypng.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="èµ„æºæ¸…ç†å·¥å…·"><a href="#èµ„æºæ¸…ç†å·¥å…·" class="headerlink" title="èµ„æºæ¸…ç†å·¥å…·"></a>èµ„æºæ¸…ç†å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Lint</td>
<td></td>
<td style="text-align:center"><a href="http://tools.android.com/tips/lint" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Resource Cleaner</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/android-resource-cleaner/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Unused Resources</td>
<td></td>
<td style="text-align:center"><a href="https://code.google.com/p/android-unused-resources/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Resource Remover</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/KeepSafe/android-resource-remover" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="pxå’Œdpè½¬æ¢-è®¡ç®—å·¥å…·"><a href="#pxå’Œdpè½¬æ¢-è®¡ç®—å·¥å…·" class="headerlink" title="pxå’Œdpè½¬æ¢/è®¡ç®—å·¥å…·"></a>pxå’Œdpè½¬æ¢/è®¡ç®—å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android dp px Calculator</td>
<td></td>
<td style="text-align:center"><a href="http://labs.rampinteractive.co.uk/android_dp_px_calculator/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">dp px converter</td>
<td></td>
<td style="text-align:center"><a href="http://pixplicity.com/dp-px-converter/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">pixelcalc</td>
<td></td>
<td style="text-align:center"><a href="http://angrytools.com/android/pixelcalc/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">androidpixels</td>
<td></td>
<td style="text-align:center"><a href="http://androidpixels.net" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">android dpi calculator</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/JerzyPuchalski/Android-DPI-Calculator" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">DPI Calculator</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/dpi-calculator/dldofgjemhkpilajnlenfijjpkabilcg?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android DPI Calculatoræ’ä»¶</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/JerzyPuchalski/Android-DPI-Calculator" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Java-To-iOS"><a href="#Java-To-iOS" class="headerlink" title="Java To iOS"></a>Java To iOS</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">j2Objc</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/google/j2objc" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">RoboVM</td>
<td></td>
<td style="text-align:center"><a href="http://www.robovm.org" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="JSON-XMLè½¬æ¢ä¸ºPOJO-Classå·¥å…·"><a href="#JSON-XMLè½¬æ¢ä¸ºPOJO-Classå·¥å…·" class="headerlink" title="JSON/XMLè½¬æ¢ä¸ºPOJO Classå·¥å…·"></a>JSON/XMLè½¬æ¢ä¸ºPOJO Classå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">jsonschema2pojo</td>
<td></td>
<td style="text-align:center"><a href="http://www.jsonschema2pojo.org" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Convert XML or JSON to Java Pojo</td>
<td></td>
<td style="text-align:center"><a href="http://pojo.sodhanalibrary.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Java-DAO-Generateå·¥å…·"><a href="#Java-DAO-Generateå·¥å…·" class="headerlink" title="Java DAO Generateå·¥å…·"></a>Java DAO Generateå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Generate Java DAO for relational data table</td>
<td></td>
<td style="text-align:center"><a href="http://pojo.sodhanalibrary.com/GenerateDAO.html" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Chromeæ’ä»¶"><a href="#Chromeæ’ä»¶" class="headerlink" title="Chromeæ’ä»¶"></a>Chromeæ’ä»¶</h4><h5 id="Androidæ’ä»¶"><a href="#Androidæ’ä»¶" class="headerlink" title="Androidæ’ä»¶"></a>Androidæ’ä»¶</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android SDK Search</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/android-sdk-search/hgcbffeicehlpmgmnhnkjbjoldkfhoin" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Resource Navigator</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/android-resource-navigato/agoomkionjjbejegcejiefodgbckeebo?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ADB Plugin for remote <br>debugging Chrome on Android</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/adb/dpngiggdglpdnjdoaefidgiigpemgage?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Mobile/RWD Tester</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/mobilerwd-tester/elmekokodcohlommfikpmojheggnbelo?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ExtensionAndroid SDK Samples Search</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/android-sdk-samples-searc/mbiobcenjhldinmnbpjihaemkfofnmgf?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Developer Improvements</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/android-developer-improve/omakkdelnjjgfmohpfkejgfcckpkbhbj?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android downloader</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/android-downloader/pkffcfhlacdchhpahlgcajjiiljobbbb?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h5 id="JSON-XMLæ ¼å¼åŒ–æ’ä»¶"><a href="#JSON-XMLæ ¼å¼åŒ–æ’ä»¶" class="headerlink" title="JSON/XMLæ ¼å¼åŒ–æ’ä»¶"></a>JSON/XMLæ ¼å¼åŒ–æ’ä»¶</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JSONView</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JSON Formatter</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/json-formatter/bcjindcccaagfpapjjmafapmmgkkhgoa?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JSON Viewer</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/json-viewer/gbmdgpbipfallnflgajpaliibnhdgobh?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">JSON Finder</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/json-finder/flhdcaebggmmpnnaljiajhihdfconkbj?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h5 id="Encode-Decodeæ’ä»¶"><a href="#Encode-Decodeæ’ä»¶" class="headerlink" title="Encode/Decodeæ’ä»¶"></a>Encode/Decodeæ’ä»¶</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Base64 Encode and Decode</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/base64-encode-and-decode/kcafoaahiffdjffagoegkdiabclnkbha?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h5 id="Git-1"><a href="#Git-1" class="headerlink" title="Git"></a>Git</h5><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Git Cheat Sheet</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/git-cheat-sheet/mjdmgoiobnbkfcfjcceaodlcodhpokgn?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h2 id="Guides"><a href="#Guides" class="headerlink" title="Guides"></a>Guides</h2><h4 id="Google-Javaç¼–ç¨‹é£æ ¼æŒ‡å—ä¸­æ–‡ç‰ˆ"><a href="#Google-Javaç¼–ç¨‹é£æ ¼æŒ‡å—ä¸­æ–‡ç‰ˆ" class="headerlink" title="Google Javaç¼–ç¨‹é£æ ¼æŒ‡å—ä¸­æ–‡ç‰ˆ"></a>Google Javaç¼–ç¨‹é£æ ¼æŒ‡å—ä¸­æ–‡ç‰ˆ</h4><p>è‹±æ–‡åœ°å€ï¼š<a href="http://google-styleguide.googlecode.com/svn/trunk/javaguide.html" target="_blank" rel="external">http://google-styleguide.googlecode.com/svn/trunk/javaguide.html</a></p>
<p>åœ°å€0ï¼š<a href="http://hawstein.com/posts/google-java-style.html" target="_blank" rel="external">http://hawstein.com/posts/google-java-style.html</a></p>
<p>åœ°å€1ï¼š<a href="https://github.com/codeset/google-java-styleguide" target="_blank" rel="external">https://github.com/codeset/google-java-styleguide</a></p>
<h4 id="Android-Developers-å›½å†…é•œåƒç«™"><a href="#Android-Developers-å›½å†…é•œåƒç«™" class="headerlink" title="Android Developers å›½å†…é•œåƒç«™"></a>Android Developers å›½å†…é•œåƒç«™</h4><p>åœ°å€: <a href="http://androiddoc.qiniudn.com/" target="_blank" rel="external">Android Developers å›½å†…é•œåƒç«™</a></p>
<h4 id="Android-Apiä¸­æ–‡ç‰ˆ"><a href="#Android-Apiä¸­æ–‡ç‰ˆ" class="headerlink" title="Android Apiä¸­æ–‡ç‰ˆ"></a>Android Apiä¸­æ–‡ç‰ˆ</h4><p>åœ°å€ï¼š<a href="http://www.embeddedlinux.org.cn/androidapi/" target="_blank" rel="external">http://www.embeddedlinux.org.cn/androidapi/</a></p>
<p>####Android APIæŒ‡å—ä¸­æ–‡ç‰ˆ</p>
<p>åœ°å€ï¼š<a href="http://api.apkbus.com/guide" target="_blank" rel="external">http://api.apkbus.com/guide</a></p>
<h4 id="Android-Proguardæ··æ·†é…ç½®æŒ‡å—"><a href="#Android-Proguardæ··æ·†é…ç½®æŒ‡å—" class="headerlink" title="Android Proguardæ··æ·†é…ç½®æŒ‡å—"></a>Android Proguardæ··æ·†é…ç½®æŒ‡å—</h4><p>åœ°å€ï¼š<a href="https://github.com/inferjay/AndroidProguardGuide/" target="_blank" rel="external">https://github.com/inferjay/AndroidProguardGuide/</a></p>
<h4 id="Gradleæ’ä»¶ä½¿ç”¨æŒ‡å—ä¸­æ–‡ç‰ˆ"><a href="#Gradleæ’ä»¶ä½¿ç”¨æŒ‡å—ä¸­æ–‡ç‰ˆ" class="headerlink" title="Gradleæ’ä»¶ä½¿ç”¨æŒ‡å—ä¸­æ–‡ç‰ˆ"></a>Gradleæ’ä»¶ä½¿ç”¨æŒ‡å—ä¸­æ–‡ç‰ˆ</h4><p>åœ°å€ï¼š<a href="http://avatarqing.github.io/Gradle-Plugin-User-Guide-Chinese-Verision" target="_blank" rel="external">http://avatarqing.github.io/Gradle-Plugin-User-Guide-Chinese-Verision</a></p>
<h4 id="Gradle-User-Guide"><a href="#Gradle-User-Guide" class="headerlink" title="Gradle User Guide"></a>Gradle User Guide</h4><p>Gradle 1.12ç”¨æˆ·æŒ‡å—ï¼š<a href="http://pan.baidu.com/s/1dD7sC2d" target="_blank" rel="external">http://pan.baidu.com/s/1dD7sC2d</a></p>
<h2 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h2><h4 id="Androidå­¦ä¹ ä¹‹è·¯"><a href="#Androidå­¦ä¹ ä¹‹è·¯" class="headerlink" title="Androidå­¦ä¹ ä¹‹è·¯"></a>Androidå­¦ä¹ ä¹‹è·¯</h4><p>åœ°å€ï¼š<a href="http://stormzhang.github.io/android/2014/07/07/learn-android-from-rookie/" target="_blank" rel="external">http://stormzhang.github.io/android/2014/07/07/learn-android-from-rookie/</a></p>
<h4 id="Google-Androidå®˜æ–¹åŸ¹è®­è¯¾ç¨‹ä¸­æ–‡ç‰ˆ"><a href="#Google-Androidå®˜æ–¹åŸ¹è®­è¯¾ç¨‹ä¸­æ–‡ç‰ˆ" class="headerlink" title="Google Androidå®˜æ–¹åŸ¹è®­è¯¾ç¨‹ä¸­æ–‡ç‰ˆ"></a>Google Androidå®˜æ–¹åŸ¹è®­è¯¾ç¨‹ä¸­æ–‡ç‰ˆ</h4><p>åœ°å€ï¼š<a href="http://hukai.me/android-training-course-in-chinese/index.html" target="_blank" rel="external">http://hukai.me/android-training-course-in-chinese/index.html</a></p>
<h4 id="Developing-Android-Apps"><a href="#Developing-Android-Apps" class="headerlink" title="Developing Android Apps"></a>Developing Android Apps</h4><p>åœ°å€ï¼š<a href="https://www.udacity.com/course/ud853" target="_blank" rel="external">https://www.udacity.com/course/ud853</a></p>
<h4 id="Java-Design-Patterns-Samples-in-Java"><a href="#Java-Design-Patterns-Samples-in-Java" class="headerlink" title="Java Design Patterns Samples in Java."></a>Java Design Patterns Samples in Java.</h4><p><a href="https://github.com/iluwatar/java-design-patterns" target="_blank" rel="external">Java Design Patterns</a></p>
<h1 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h1><hr>
<h2 id="Design-Tools"><a href="#Design-Tools" class="headerlink" title="Design Tools"></a>Design Tools</h2><h4 id="Photoshopæ’ä»¶"><a href="#Photoshopæ’ä»¶" class="headerlink" title="Photoshopæ’ä»¶"></a>Photoshopæ’ä»¶</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cut&amp;Slice</td>
<td>åˆ‡å›¾ç¥å™¨</td>
<td style="text-align:center"><a href="http://www.cutandslice.me" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">DevRocket</td>
<td>åˆ‡å›¾ç¥å™¨</td>
<td style="text-align:center"><a href="http://www.robovm.org" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Cutterman</td>
<td>æœ€å¥½ç”¨çš„åˆ‡å›¾å·¥å…·</td>
<td style="text-align:center"><a href="http://www.cutterman.cn" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Ink</td>
<td></td>
<td style="text-align:center"><a href="http://ink.chrometaphore.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Corner Editor</td>
<td>è·¯å¾„åœ†è§’ç¼–è¾‘å·¥å…·</td>
<td style="text-align:center"><a href="http://photoshopscripts.wordpress.com" target="_blank" rel="external">ä¸‹è½½1</a> <br><a href="http://sourceforge.net/projects/cornereditor/" target="_blank" rel="external">ä¸‹è½½1</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">GuideGuide</td>
<td>è¾…åŠ©çº¿å·¥å…·</td>
<td style="text-align:center"><a href="http://guideguide.me" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Assistor PS</td>
<td></td>
<td style="text-align:center"><a href="http://assistor.net/en/assistor" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Skeuomorphism.it</td>
<td></td>
<td style="text-align:center"><a href="http://skeuomorphism.it" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">QuickGuide</td>
<td></td>
<td style="text-align:center"><a href="http://guchitaka.com/project-view/quickguidepro/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Long Shadow Generator</td>
<td>é•¿æŠ•å½±æ•ˆæœç”Ÿæˆæ’ä»¶</td>
<td style="text-align:center"><a href="http://lab.rayps.com/lsg2/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">android_resizer_toolkit</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/marcosecchi/android_resizer_toolkit" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">android-ps-tools</td>
<td>ä¸€äº›æ–¹ä¾¿Android UIè®¾è®¡çš„PhototShopæ’ä»¶ã€‚</td>
<td style="text-align:center"><a href="https://github.com/timroes/android-ps-tools" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">LayerCraft</td>
<td>A Photoshop plugin to export UI assets from layers</td>
<td style="text-align:center"><a href="http://lab.rayps.com/lc/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="çŸ¢é‡å›¾è®¾è®¡å·¥å…·"><a href="#çŸ¢é‡å›¾è®¾è®¡å·¥å…·" class="headerlink" title="çŸ¢é‡å›¾è®¾è®¡å·¥å…·"></a>çŸ¢é‡å›¾è®¾è®¡å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Sketch 3</td>
<td></td>
<td style="text-align:center"><a href="http://bohemiancoding.com/sketch/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Affinity Designer</td>
<td></td>
<td style="text-align:center"><a href="https://affinity.serif.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Gravit</td>
<td></td>
<td style="text-align:center"><a href="http://gravit.io" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Adobe Illustrator</td>
<td></td>
<td style="text-align:center"><a href="https://www.adobe.com/cn/products/illustrator.html" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="åˆ‡å›¾å·¥å…·"><a href="#åˆ‡å›¾å·¥å…·" class="headerlink" title="åˆ‡å›¾å·¥å…·"></a>åˆ‡å›¾å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Slicy</td>
<td></td>
<td style="text-align:center"><a href="http://macrabbit.com/slicy/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="è®¾è®¡ç¨¿å°ºå¯¸æ ‡æ³¨å·¥å…·"><a href="#è®¾è®¡ç¨¿å°ºå¯¸æ ‡æ³¨å·¥å…·" class="headerlink" title="è®¾è®¡ç¨¿å°ºå¯¸æ ‡æ³¨å·¥å…·"></a>è®¾è®¡ç¨¿å°ºå¯¸æ ‡æ³¨å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">é©¬å…‹é³—</td>
<td></td>
<td style="text-align:center"><a href="http://www.getmarkman.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">PxCookåƒç´ å¤§å¨</td>
<td>UIè®¾è®¡å¸ˆæ•ˆç‡æå‡åˆ©å™¨ï¼Œè®©ä½ ä¸“æ³¨äºè®¾è®¡æœ¬è´¨ï¼Œ<br>ä¸å†ä¸ºæ ‡æ³¨åˆ‡å›¾è€Œçƒ¦æ¼ï¼Œä»è®¾è®¡åˆ°å®ç°ä¸€æ°”å‘µæˆ</td>
<td style="text-align:center"><a href="http://www.fancynode.com.cn" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"><a href="http://www.fancynode.com.cn/tutorial" target="_blank" rel="external">ä½¿ç”¨æ•™ç¨‹</a></td>
</tr>
</tbody>
</table>
<h4 id="åŸå‹è®¾è®¡å·¥å…·"><a href="#åŸå‹è®¾è®¡å·¥å…·" class="headerlink" title="åŸå‹è®¾è®¡å·¥å…·"></a>åŸå‹è®¾è®¡å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Axure</td>
<td></td>
<td style="text-align:center"><a href="http://www.axure.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Fluid UI</td>
<td></td>
<td style="text-align:center"><a href="https://chrome.google.com/webstore/detail/fluid-ui/obgmmkbgpilmggfkhganmcmpemnhimgg?hl=en" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Briefs</td>
<td></td>
<td style="text-align:center"><a href="http://giveabrief.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Flinto</td>
<td></td>
<td style="text-align:center"><a href="https://www.flinto.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Balsamiq Mockups</td>
<td></td>
<td style="text-align:center"><a href="http://balsamiq.com/products/mockups/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">AppCooker</td>
<td></td>
<td style="text-align:center"><a href="http://www.appcooker.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Proto.io</td>
<td></td>
<td style="text-align:center"><a href="https://proto.io/en/signup/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">UXPin</td>
<td></td>
<td style="text-align:center"><a href="http://uxpin.com/#" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">InVision</td>
<td></td>
<td style="text-align:center"><a href="http://www.invisionapp.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">POP</td>
<td></td>
<td style="text-align:center"><a href="https://popapp.in" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">å¿«ç°</td>
<td></td>
<td style="text-align:center"><a href="http://www.ikuaixian.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Composite</td>
<td></td>
<td style="text-align:center"><a href="http://www.getcomposite.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">OmniGraffle</td>
<td></td>
<td style="text-align:center"><a href="https://www.omnigroup.com/omnigraffle" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Marvelapp</td>
<td></td>
<td style="text-align:center"><a href="https://marvelapp.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Justinmind</td>
<td></td>
<td style="text-align:center"><a href="http://www.justinmind.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Form</td>
<td></td>
<td style="text-align:center"><a href="http://www.relativewave.com/form.html" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Prott</td>
<td></td>
<td style="text-align:center"><a href="https://prottapp.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Composite</td>
<td></td>
<td style="text-align:center"><a href="http://www.getcomposite.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Avocado</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/ideo/avocado" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Pixate</td>
<td></td>
<td style="text-align:center"><a href="http://www.pixate.com/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="äº¤äº’è®¾è®¡å·¥å…·"><a href="#äº¤äº’è®¾è®¡å·¥å…·" class="headerlink" title="äº¤äº’è®¾è®¡å·¥å…·"></a>äº¤äº’è®¾è®¡å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Framer Studio</td>
<td></td>
<td style="text-align:center"><a href="http://framerjs.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Quartz Composer</td>
<td></td>
<td style="text-align:center"><a href="http://adcdownload.apple.com/Developer_Tools/graphics_tools_for_xcode__march_2014/graphics_tools_for_xcode_5.1__march_2014.dmg" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Origami</td>
<td></td>
<td style="text-align:center"><a href="http://facebook.github.io/origami/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">jQC</td>
<td></td>
<td style="text-align:center"><a href="http://qcdesigners.com/index.php/forums" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="UIæ•ˆæœé¢„è§ˆå·¥å…·"><a href="#UIæ•ˆæœé¢„è§ˆå·¥å…·" class="headerlink" title="UIæ•ˆæœé¢„è§ˆå·¥å…·"></a>UIæ•ˆæœé¢„è§ˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Design Preview</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/romannurik/AndroidDesignPreview/releases" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">PS Play</td>
<td></td>
<td style="text-align:center"><a href="http://isux.tencent.com/app/psplay" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Pixl Preview</td>
<td></td>
<td style="text-align:center"><a href="https://play.google.com/store/apps/details?id=at.markushi.pixl" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Skala Preview</td>
<td></td>
<td style="text-align:center"><a href="http://bjango.com/mac/skalapreview/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">LiveView</td>
<td></td>
<td style="text-align:center"><a href="http://www.zambetti.com/projects/liveview/" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="é…è‰²å·¥å…·"><a href="#é…è‰²å·¥å…·" class="headerlink" title="é…è‰²å·¥å…·"></a>é…è‰²å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Android Material Designå¯è§†åŒ–è°ƒè‰²æ¿</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/HozakaN/MaterialDesignColorPalette" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Material Design Colours.xml</td>
<td></td>
<td style="text-align:center"><a href="https://gist.github.com/daniellevass/b0b8cfa773488e138037" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Colorubeé…è‰²ç¥å™¨</td>
<td></td>
<td style="text-align:center"><a href="http://www.fancynode.com/colorcube/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Adobe Kuler</td>
<td></td>
<td style="text-align:center"><a href="https://kuler.adobe.com/zh/create/color-wheel/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">ColorSchemer Studio</td>
<td></td>
<td style="text-align:center"><a href="http://www.colorschemer.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Piknik</td>
<td></td>
<td style="text-align:center"><a href="https://gist.github.com/daniellevass/b0b8cfa773488e138037" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="è®¾è®¡ç¨¿ç‰ˆæœ¬æ§åˆ¶å·¥å…·"><a href="#è®¾è®¡ç¨¿ç‰ˆæœ¬æ§åˆ¶å·¥å…·" class="headerlink" title="è®¾è®¡ç¨¿ç‰ˆæœ¬æ§åˆ¶å·¥å…·"></a>è®¾è®¡ç¨¿ç‰ˆæœ¬æ§åˆ¶å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">LayerVault</td>
<td></td>
<td style="text-align:center"><a href="https://layervault.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å›¾æ ‡å¤„ç†å·¥å…·"><a href="#å›¾æ ‡å¤„ç†å·¥å…·" class="headerlink" title="å›¾æ ‡å¤„ç†å·¥å…·"></a>å›¾æ ‡å¤„ç†å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Icon Slate</td>
<td></td>
<td style="text-align:center"><a href="http://www.kodlian.com/apps" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="åœ¨çº¿Iconåº“"><a href="#åœ¨çº¿Iconåº“" class="headerlink" title="åœ¨çº¿Iconåº“"></a>åœ¨çº¿Iconåº“</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">IconFont</td>
<td></td>
<td style="text-align:center"><a href="http://iconfont.cn" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">NounProject</td>
<td></td>
<td style="text-align:center"><a href="http://thenounproject.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="å–è‰²å·¥å…·"><a href="#å–è‰²å·¥å…·" class="headerlink" title="å–è‰²å·¥å…·"></a>å–è‰²å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ColorSnapper</td>
<td></td>
<td style="text-align:center"><a href="http://colorsnapper.com" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="ä¸é€æ˜åº¦16è¿›åˆ¶å€¼"><a href="#ä¸é€æ˜åº¦16è¿›åˆ¶å€¼" class="headerlink" title="ä¸é€æ˜åº¦16è¿›åˆ¶å€¼"></a>ä¸é€æ˜åº¦16è¿›åˆ¶å€¼</h4><table>
<thead>
<tr>
<th style="text-align:center">ä¸é€æ˜åº¦</th>
<th style="text-align:center">16è¿›åˆ¶å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">100%</td>
<td style="text-align:center">FF</td>
</tr>
<tr>
<td style="text-align:center">95%</td>
<td style="text-align:center">F2</td>
</tr>
<tr>
<td style="text-align:center">90%</td>
<td style="text-align:center">E6</td>
</tr>
<tr>
<td style="text-align:center">85%</td>
<td style="text-align:center">D9</td>
</tr>
<tr>
<td style="text-align:center">80%</td>
<td style="text-align:center">CC</td>
</tr>
<tr>
<td style="text-align:center">75%</td>
<td style="text-align:center">BF</td>
</tr>
<tr>
<td style="text-align:center">70%</td>
<td style="text-align:center">B3</td>
</tr>
<tr>
<td style="text-align:center">65%</td>
<td style="text-align:center">A6</td>
</tr>
<tr>
<td style="text-align:center">60%</td>
<td style="text-align:center">99</td>
</tr>
<tr>
<td style="text-align:center">55%</td>
<td style="text-align:center">8C</td>
</tr>
<tr>
<td style="text-align:center">50%</td>
<td style="text-align:center">80</td>
</tr>
<tr>
<td style="text-align:center">45%</td>
<td style="text-align:center">73</td>
</tr>
<tr>
<td style="text-align:center">40%</td>
<td style="text-align:center">66</td>
</tr>
<tr>
<td style="text-align:center">35%</td>
<td style="text-align:center">59</td>
</tr>
<tr>
<td style="text-align:center">30%</td>
<td style="text-align:center">4D</td>
</tr>
<tr>
<td style="text-align:center">25%</td>
<td style="text-align:center">40</td>
</tr>
<tr>
<td style="text-align:center">20%</td>
<td style="text-align:center">33</td>
</tr>
<tr>
<td style="text-align:center">15%</td>
<td style="text-align:center">26</td>
</tr>
<tr>
<td style="text-align:center">10%</td>
<td style="text-align:center">1A</td>
</tr>
<tr>
<td style="text-align:center">5%</td>
<td style="text-align:center">0D</td>
</tr>
<tr>
<td style="text-align:center">0%</td>
<td style="text-align:center">00</td>
</tr>
</tbody>
</table>
<p>å‡ºè‡ªï¼š<a href="http://stackoverflow.com/questions/5445085/understanding-colors-in-android-6-chars" target="_blank" rel="external">http://stackoverflow.com/questions/5445085/understanding-colors-in-android-6-chars</a></p>
<h4 id="æ‰‹æœºToç”µè„‘åŒæ­¥é¢„è§ˆå·¥å…·"><a href="#æ‰‹æœºToç”µè„‘åŒæ­¥é¢„è§ˆå·¥å…·" class="headerlink" title="æ‰‹æœºToç”µè„‘åŒæ­¥é¢„è§ˆå·¥å…·"></a>æ‰‹æœºToç”µè„‘åŒæ­¥é¢„è§ˆå·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Reflector</td>
<td></td>
<td style="text-align:center"><a href="http://www.airsquirrels.com/reflector/download/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">x-Mirage</td>
<td></td>
<td style="text-align:center"><a href="http://x-mirage.com/x-mirage/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">AirServer</td>
<td></td>
<td style="text-align:center"><a href="http://www.airserver.com" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">BBQScreen</td>
<td></td>
<td style="text-align:center"><a href="http://screen.bbqdroid.org" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h4 id="Gifå›¾ç‰‡å½•åˆ¶å·¥å…·"><a href="#Gifå›¾ç‰‡å½•åˆ¶å·¥å…·" class="headerlink" title="Gifå›¾ç‰‡å½•åˆ¶å·¥å…·"></a>Gifå›¾ç‰‡å½•åˆ¶å·¥å…·</h4><table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th>ç®€ä»‹</th>
<th style="text-align:center">ä¸‹è½½åœ°å€</th>
<th style="text-align:center">ä½¿ç”¨æ•™ç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">LICEcap</td>
<td></td>
<td style="text-align:center"><a href="http://www.cockos.com/licecap/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">GifCam</td>
<td></td>
<td style="text-align:center"><a href="http://blog.bahraniapps.com/gifcam/" target="_blank" rel="external">ä¸‹è½½</a></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Android Tool</td>
<td></td>
<td style="text-align:center"><a href="https://github.com/mortenjust/androidtool-mac" target="_blank" rel="external">ä¸‹è½½</a></td>
</tr>
</tbody>
</table>
<h2 id="UI-Programming-Language"><a href="#UI-Programming-Language" class="headerlink" title="UI Programming Language"></a>UI Programming Language</h2><p><a href="http://uilang.com" target="_blank" rel="external">UILang</a></p>
<h2 id="Tutorials-1"><a href="#Tutorials-1" class="headerlink" title="Tutorials"></a>Tutorials</h2><p><a href="https://hackdesign.org/lessons" target="_blank" rel="external">HackDesign</a></p>
<h2 id="Games"><a href="#Games" class="headerlink" title="Games"></a>Games</h2><p><a href="http://bezier.method.ac" target="_blank" rel="external">The Bezier Game</a></p>
<p>ä¸€ä¸ªå¸®åŠ©ä½ ç»ƒä¹ PSé‡Œé’¢ç¬”å·¥å…·çš„å°æ¸¸æˆã€‚</p>
<h2 id="Guides-1"><a href="#Guides-1" class="headerlink" title="Guides"></a>Guides</h2><h4 id="Androidè®¾è®¡æŒ‡å—éå®˜æ–¹ç®€ä½“ä¸­æ–‡ç‰ˆ"><a href="#Androidè®¾è®¡æŒ‡å—éå®˜æ–¹ç®€ä½“ä¸­æ–‡ç‰ˆ" class="headerlink" title="Androidè®¾è®¡æŒ‡å—éå®˜æ–¹ç®€ä½“ä¸­æ–‡ç‰ˆ"></a>Androidè®¾è®¡æŒ‡å—éå®˜æ–¹ç®€ä½“ä¸­æ–‡ç‰ˆ</h4><p>Topfuné•œåƒåœ°å€ï¼š<a href="http://www.topfun.us/adchs/index.html" target="_blank" rel="external">http://www.topfun.us/adchs/index.html</a></p>
<p>Githubé•œåƒåœ°å€ï¼š<a href="http://adchs.github.io" target="_blank" rel="external">http://adchs.github.io</a></p>
<p>ApkBusé•œåƒåœ°å€ï¼š<a href="http://www.apkbus.com/design/" target="_blank" rel="external">http://www.apkbus.com/design/</a></p>
<p>Segmentfaulté•œåƒåœ°å€ï¼š<a href="http://mirrors.segmentfault.com/adchs/" target="_blank" rel="external">http://mirrors.segmentfault.com/adchs/</a></p>
<p>å¤šçœ‹é˜…è¯»é•œåƒåœ°å€ï¼š<a href="http://www.duokan.com/book/47790" target="_blank" rel="external">http://www.duokan.com/book/47790</a></p>
<h4 id="Android-Cheatsheet-for-Graphic-Designers"><a href="#Android-Cheatsheet-for-Graphic-Designers" class="headerlink" title="Android Cheatsheet for Graphic Designers"></a>Android Cheatsheet for Graphic Designers</h4><p>åœ°å€:<a href="http://petrnohejl.github.io/Android-Cheatsheet-For-Graphic-Designers/" target="_blank" rel="external">http://petrnohejl.github.io/Android-Cheatsheet-For-Graphic-Designers/</a></p>
<h4 id="Google-Material-Design-ä¸­æ–‡ç‰ˆ"><a href="#Google-Material-Design-ä¸­æ–‡ç‰ˆ" class="headerlink" title="Google Material Design ä¸­æ–‡ç‰ˆ"></a>Google Material Design ä¸­æ–‡ç‰ˆ</h4><p>åœ°å€ï¼š<a href="http://design.1sters.com" target="_blank" rel="external">http://design.1sters.com</a></p>
<p>åœ°å€ï¼š <a href="http://www.ui.cn/Material/" target="_blank" rel="external">http://www.ui.cn/Material/</a></p>
<h4 id="Designerâ€™s-Guide-To-dpi"><a href="#Designerâ€™s-Guide-To-dpi" class="headerlink" title="Designerâ€™s Guide To dpi"></a>Designerâ€™s Guide To dpi</h4><p>åœ°å€ï¼š<a href="http://sebastien-gabriel.com/designers-guide-to-dpi/home#" target="_blank" rel="external">http://sebastien-gabriel.com/designers-guide-to-dpi/home</a></p>
<h4 id="Email-Design-Guide"><a href="#Email-Design-Guide" class="headerlink" title="Email Design Guide"></a>Email Design Guide</h4><p>åœ°å€ï¼š<a href="http://mailchimp.com/resources/email-design-guide/" target="_blank" rel="external">http://mailchimp.com/resources/email-design-guide/</a></p>
<h2 id="Free-Design-Resources"><a href="#Free-Design-Resources" class="headerlink" title="Free Design Resources"></a>Free Design Resources</h2><p><a href="http://pan.baidu.com/s/1i35iBNv" target="_blank" rel="external">Google Material Design ç´ æ</a>(æ„Ÿè°¢ <a href="http://weibo.com/sanityd" target="_blank" rel="external">@SanityD</a>)</p>
<p><a href="https://dribbble.com/shots/1617724" target="_blank" rel="external">Material Design Icon Templates</a></p>
<p><a href="https://github.com/google/material-design-icons" target="_blank" rel="external">Material Designçš„å›¾æ ‡é›†</a></p>
<p><a href="https://www.behance.net/gallery/20514895/Material-Design-UI-Kit" target="_blank" rel="external">Material Design UI Kit for Sketch</a></p>
<p><a href="http://tristanremy.com/nexus-5/" target="_blank" rel="external">Nexus 5 template for Sketch</a></p>
<p><a href="http://androiduiux.com/free-design-resources/?blogsub=confirming#blog_subscription-2" target="_blank" rel="external">Free Design Resources</a></p>
<p><a href="https://dl.dropboxusercontent.com/u/8067075/System%20Icons.zip" target="_blank" rel="external">434 SVG icons</a></p>
<p><a href="http://ui-cloud.com" target="_blank" rel="external">UI Cloun</a></p>
<p><a href="http://github.com/nullice/NViconsLib_Silhouette" target="_blank" rel="external">161ä¸ªå›½å†…å¤–ç¤¾äº¤ç½‘ç«™çŸ¢é‡å›¾æ ‡</a></p>
<p><a href="http://www.androidicons.com" target="_blank" rel="external">250 free icons in 5 sizes and 14 colors</a></p>
<p><a href="http://matt-cooper.com/minimalistic-icons/" target="_blank" rel="external">MINIMALISTIC EVERYDAY ICONS</a></p>
<p><a href="http://www.icons4android.com" target="_blank" rel="external">Icons4Android</a></p>
<h1 id="Books"><a href="#Books" class="headerlink" title="Books"></a>Books</h1><hr>
<p><a href="https://github.com/vhf/free-programming-books/blob/master/free-programming-books.md#android" target="_blank" rel="external">Free Programming Books</a></p>
<p>ä¸€å †å…è´¹çš„Androidå¼€å‘ç›¸å…³çš„ç”µå­ä¹¦ã€‚</p>
<p><a href="http://www.it-ebooks.info/book/2445/" target="_blank" rel="external">50 Android Hacks</a></p>
<p>50 Android Hacksè¿™æœ¬ä¹¦åˆ†12ä¸ªéƒ¨åˆ†ä»‹ç»äº†50ä¸ªAndroidå¼€å‘çš„å°æŠ€å·§ã€‚</p>
<p><a href="http://siberiawolf.com/free_programming/index.html" target="_blank" rel="external">å…è´¹çš„ç¼–ç¨‹ä¸­æ–‡ä¹¦ç±ç´¢å¼•</a></p>
<h1 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer"></a>Disclaimer</h1><hr>
<pre><code>ç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ï¼Œè¿™é‡Œä»…åšæ”¶é›†æ•´ç†ï¼Œæ¬¢è¿è‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²åå’Œé“¾æ¥ã€‚
</code></pre><hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;AndroidDevTools&quot;&gt;&lt;a href=&quot;#AndroidDevTools&quot; class=&quot;headerlink&quot; title=&quot;AndroidDevTools&quot;&gt;&lt;/a&gt;AndroidDevTools&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://
    
    </summary>
    
      <category term="å¼€å‘å·¥å…·" scheme="https://likeqy.com/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ä½ çœŸçš„äº†è§£AsyncTaskå—</title>
    <link href="https://likeqy.com/2017/07/26/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3AsyncTask%E5%90%97/"/>
    <id>https://likeqy.com/2017/07/26/ä½ çœŸçš„äº†è§£AsyncTaskå—/</id>
    <published>2017-07-26T12:09:45.000Z</published>
    <updated>2017-07-26T14:05:15.410Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="ä½ çœŸçš„äº†è§£AsyncTask"><a href="#ä½ çœŸçš„äº†è§£AsyncTask" class="headerlink" title="ä½ çœŸçš„äº†è§£AsyncTask?"></a>ä½ çœŸçš„äº†è§£AsyncTask?</h2><p>è™½è¯´ç°åœ¨åšç½‘ç»œè¯·æ±‚æœ‰äº†Volleyå…¨å®¶æ¡¶å’ŒOkHttpè¿™æ ·å¥½ç”¨çš„åº“ï¼Œä½†æ˜¯åœ¨å¤„ç†å…¶ä»–åå°ä»»åŠ¡ä»¥åŠä¸UIäº¤äº’ä¸Šï¼Œè¿˜æ˜¯éœ€è¦ç”¨åˆ°AsyncTaskã€‚ä½†æ˜¯ä½ çœŸçš„äº†è§£AsyncTaskå—ï¼Ÿ</p>
<p>AsyncTaskçš„å®ç°å‡ ç»ä¿®æ”¹ï¼Œå› æ­¤åœ¨ä¸åŒç‰ˆæœ¬çš„Androidç³»ç»Ÿä¸Šè¡¨ç°å„å¼‚ï¼›æˆ‘ç›¸ä¿¡ï¼Œä»»ä½•ä¸€ä¸ªç”¨æˆ·é‡ä¸Šåƒä¸‡çš„äº§å“ç»å¯¹ä¸ä¼šåœ¨ä»£ç é‡Œé¢ä½¿ç”¨ç³»ç»ŸåŸç”Ÿçš„AsynTaskï¼Œå› ä¸ºå®ƒè›‹ç–¼çš„å…¼å®¹æ€§ä»¥åŠæé«˜çš„å´©æºƒç‡å®åœ¨è®©äººä¸æ•¢æ­ç»´ã€‚æœ¬æ–‡å°†å¸¦ä½ äº†è§£AsyncTaskèƒŒåçš„åŸç†ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªä¹…ç»è€ƒéªŒçš„AsyncTaskä¿®æ”¹ç‰ˆã€‚</p>
<h2 id="AsyncTaskæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#AsyncTaskæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="AsyncTaskæ˜¯ä»€ä¹ˆï¼Ÿ"></a>AsyncTaskæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>AsyncTaskåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¾ˆç®€å•ï¼Œ<strong>å®ƒä¸è¿‡æ˜¯å¯¹çº¿ç¨‹æ± å’ŒHandlerçš„å°è£…</strong>ï¼›ç”¨çº¿ç¨‹æ± æ¥å¤„ç†åå°ä»»åŠ¡ï¼Œç”¨Handleræ¥å¤„ç†ä¸UIçš„äº¤äº’ã€‚çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯<code>Executor</code>æ¥å£ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹çº¿ç¨‹æ± çš„ç‰¹æ€§ã€‚</p>
<h2 id="çº¿ç¨‹æ± ThreadPoolExecutor"><a href="#çº¿ç¨‹æ± ThreadPoolExecutor" class="headerlink" title="çº¿ç¨‹æ± ThreadPoolExecutor"></a>çº¿ç¨‹æ± ThreadPoolExecutor</h2><p>JDK5å¸¦æ¥çš„ä¸€å¤§æ”¹è¿›å°±æ˜¯Javaçš„å¹¶å‘èƒ½åŠ›ï¼Œå®ƒæä¾›äº†ä¸‰ç§å¹¶å‘æ­¦å™¨ï¼šå¹¶å‘æ¡†æ¶Executorï¼Œå¹¶å‘é›†åˆç±»å‹å¦‚ConcurrentHashMapï¼Œå¹¶å‘æ§åˆ¶ç±»å¦‚CountDownLatchç­‰ï¼›åœ£ç»ã€ŠEffective Javaã€‹ä¹Ÿè¯´ï¼Œå°½é‡ä½¿ç”¨Exectorè€Œä¸æ˜¯ç›´æ¥ç”¨Threadç±»è¿›è¡Œå¹¶å‘ç¼–ç¨‹ã€‚</p>
<p>AsyncTaskå†…éƒ¨ä¹Ÿä½¿ç”¨äº†çº¿ç¨‹æ± å¤„ç†å¹¶å‘ï¼›çº¿ç¨‹æ± é€šè¿‡<code>ThreadPoolExector</code>ç±»æ„é€ ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°å‚æ•°æ¯”è¾ƒå¤šï¼Œå®ƒå…è®¸å¼€å‘è€…å¯¹çº¿ç¨‹æ± è¿›è¡Œå®šåˆ¶ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™æ¯ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Œç„¶åçœ‹çœ‹Androidæ˜¯ä»¥ä½•ç§æ–¹å¼å®šåˆ¶çš„ã€‚</p>
<p>ThreadPoolExecutorçš„å…¶ä»–æ„é€ å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨å¦‚ä¸‹çš„æ„é€ å‡½æ•°å®Œæˆå¯¹è±¡åˆ›å»ºå·¥ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></div><div class="line">                          <span class="keyword">int</span> maximumPoolSize,</div><div class="line">                          <span class="keyword">long</span> keepAliveTime,</div><div class="line">                          TimeUnit unit,</div><div class="line">                          BlockingQueue&lt;Runnable&gt; workQueue,</div><div class="line">                          ThreadFactory threadFactory,</div><div class="line">                          RejectedExecutionHandler handler)</div></pre></td></tr></table></figure>
<ul>
<li>corePoolSize: æ ¸å¿ƒçº¿ç¨‹æ•°ç›®ï¼Œå³ä½¿çº¿ç¨‹æ± æ²¡æœ‰ä»»åŠ¡ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¹Ÿä¸ä¼šç»ˆæ­¢ï¼ˆé™¤éè®¾ç½®äº†allowCoreThreadTimeOutå‚æ•°ï¼‰å¯ä»¥ç†è§£ä¸ºâ€œå¸¸é©»çº¿ç¨‹â€</li>
<li>maximumPoolSize: çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ç›®ï¼›ä¸€èˆ¬æ¥è¯´ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œçº¿ç¨‹è°ƒåº¦å¼€é”€è¶Šå¤§ï¼›å› æ­¤ä¸€èˆ¬éƒ½æœ‰è¿™ä¸ªé™åˆ¶ã€‚</li>
<li>keepAliveTime: å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®æ¯”æ ¸å¿ƒçº¿ç¨‹å¤šçš„æ—¶å€™ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªkeepAliveTimeçš„æ—¶é—´ï¼Œå¤šä½™çš„çº¿ç¨‹ä¼šè¢«å›æ”¶ï¼›è¿™äº›ä¸æ ¸å¿ƒçº¿ç¨‹ç›¸å¯¹çš„çº¿ç¨‹é€šå¸¸è¢«ç§°ä¸ºç¼“å­˜çº¿ç¨‹</li>
<li>unit: keepAliveTimeçš„æ—¶é—´å•ä½</li>
<li>workQueue: ä»»åŠ¡æ‰§è¡Œå‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ï¼›è¿™ä¸ªé˜Ÿåˆ—ä»…ä¿å­˜ç”±executeæäº¤çš„Runnableä»»åŠ¡</li>
<li>threadFactory: ç”¨æ¥æ„é€ çº¿ç¨‹æ± çš„å·¥å‚ï¼›ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨é»˜è®¤çš„ï¼›</li>
<li>handler: å½“çº¿ç¨‹æ± ç”±äºçº¿ç¨‹æ•°ç›®å’Œé˜Ÿåˆ—é™åˆ¶è€Œå¯¼è‡´åç»­ä»»åŠ¡é˜»å¡çš„æ—¶å€™ï¼Œçº¿ç¨‹æ± çš„å¤„ç†æ–¹å¼ã€‚</li>
</ul>
<p>é‚£ä¹ˆï¼Œå½“ä¸€ä¸ªæ–°çš„ä»»åŠ¡åˆ°è¾¾çš„æ—¶å€™ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è°ƒåº¦çš„å‘¢ï¼Ÿï¼ˆåˆ«æ…Œï¼Œè®²è¿™ä¹ˆä¸€å¤§æ®µçº¿ç¨‹æ± çš„çŸ¥è¯†ï¼Œæ˜¯ä¸ºäº†ç†è§£AsyncTaskï¼›Be Patientï¼‰</p>
<ol>
<li>å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°ç›®å°‘äºcorePoolSizeï¼Œå°±ç®—çº¿ç¨‹æ± ä¸­æœ‰å…¶ä»–çš„æ²¡äº‹åšçš„æ ¸å¿ƒçº¿ç¨‹ï¼Œçº¿ç¨‹æ± è¿˜æ˜¯ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼›ç›´åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ç›®åˆ°è¾¾corePoolSizeï¼ˆå¸¸é©»çº¿ç¨‹å°±ä½ï¼‰</li>
<li>å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°ç›®å¤§äºæˆ–è€…ç­‰äºcorePoolSizeï¼Œä½†æ˜¯å·¥ä½œé˜Ÿåˆ—workQueueæ²¡æœ‰æ»¡ï¼Œé‚£ä¹ˆæ–°çš„ä»»åŠ¡ä¼šæ”¾åœ¨é˜Ÿåˆ—workQueueä¸­ï¼ŒæŒ‰ç…§FIFOçš„åŸåˆ™ä¾æ¬¡ç­‰å¾…æ‰§è¡Œï¼›ï¼ˆå½“æœ‰æ ¸å¿ƒçº¿ç¨‹å¤„ç†å®Œä»»åŠ¡ç©ºé—²å‡ºæ¥åï¼Œä¼šæ£€æŸ¥è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—ç„¶åå–å‡ºä»»åŠ¡é»˜é»˜æ‰§è¡Œå»ï¼‰</li>
<li>å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ç›®å¤§äºç­‰äºcorePoolSizeï¼Œå¹¶ä¸”å·¥ä½œé˜Ÿåˆ—workQueueæ»¡äº†ï¼Œä½†æ˜¯æ€»çº¿ç¨‹æ•°ç›®å°äºmaximumPoolSizeï¼Œé‚£ä¹ˆç›´æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¤„ç†è¢«æ·»åŠ çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœå·¥ä½œé˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°ç›®åˆ°è¾¾äº†æœ€å¤§æ•°ç›®maximumPoolSizeï¼Œé‚£ä¹ˆå°±ä¼šç”¨æœ€åä¸€ä¸ªæ„é€ å‚æ•°<code>handler</code>å¤„ç†ï¼›<strong>é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯ç›´æ¥ä¸¢æ‰ä»»åŠ¡ï¼Œç„¶åæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</strong></li>
</ol>
<p>æ€»ç»“èµ·æ¥ï¼Œä¹Ÿå³æ˜¯è¯´ï¼Œå½“æœ‰æ–°çš„ä»»åŠ¡è¦å¤„ç†æ—¶ï¼Œ<strong>å…ˆçœ‹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äº corePoolSizeï¼Œå†çœ‹ç¼“å†²é˜Ÿåˆ— workQueue æ˜¯å¦æ»¡ï¼Œæœ€åçœ‹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äº maximumPoolSize</strong>ã€‚å¦å¤–ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº corePoolSize æ—¶ï¼Œå¦‚æœé‡Œé¢æœ‰çº¿ç¨‹çš„ç©ºé—²æ—¶é—´è¶…è¿‡äº† keepAliveTimeï¼Œå°±å°†å…¶ç§»é™¤çº¿ç¨‹æ± ï¼Œè¿™æ ·ï¼Œå¯ä»¥åŠ¨æ€åœ°è°ƒæ•´çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡ã€‚</p>
<p>æˆ‘ä»¬ä»¥API 22ä¸ºä¾‹ï¼Œçœ‹ä¸€çœ‹AsyncTaské‡Œé¢çš„çº¿ç¨‹æ± æ˜¯ä»¥ä»€ä¹ˆå‚æ•°æ„é€ çš„ï¼›AsyncTaské‡Œé¢æœ‰â€œä¸¤ä¸ªâ€çº¿ç¨‹æ± ï¼›ä¸€ä¸ª<code>THREAD_POOL_EXECUTOR</code>ä¸€ä¸ª<code>SERIAL_EXECUTOR</code>ï¼›ä¹‹æ‰€ä»¥æ‰“å¼•å·ï¼Œæ˜¯å› ä¸ºå…¶å®<code>SERIAL_EXECUTOR</code>ä¹Ÿä½¿ç”¨<code>THREAD_POOL_EXECUTOR</code>å®ç°çš„ï¼Œåªä¸è¿‡åŠ äº†ä¸€ä¸ªé˜Ÿåˆ—å¼„æˆäº†ä¸²è¡Œè€Œå·²ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>THREAD_POOL_EXECUTOR</code>æ˜¯å¦‚ä½•æ„é€ çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = CPU_COUNT + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</div><div class="line">            = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">                    TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒAsyncTaské‡Œé¢çº¿ç¨‹æ± æ˜¯ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º<code>CPU + 1</code>ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º<code>CPU * 2 + 1</code>ï¼Œå·¥ä½œé˜Ÿåˆ—é•¿åº¦ä¸º<strong>128</strong>çš„çº¿ç¨‹æ± ï¼›å¹¶ä¸”æ²¡æœ‰ä¼ é€’<code>handler</code>å‚æ•°ï¼Œé‚£ä¹ˆä½¿ç”¨çš„å°±æ˜¯é»˜è®¤çš„Handlerï¼ˆæ‹’ç»æ‰§è¡Œ).</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š</p>
<ol>
<li>å¦‚æœä»»åŠ¡è¿‡å¤šï¼Œé‚£ä¹ˆè¶…è¿‡äº†å·¥ä½œé˜Ÿåˆ—ä»¥åŠçº¿ç¨‹æ•°ç›®çš„é™åˆ¶å¯¼è‡´è¿™ä¸ªçº¿ç¨‹æ± å‘ç”Ÿé˜»å¡ï¼Œé‚£ä¹ˆæ‚²å‰§å‘ç”Ÿï¼Œé»˜è®¤çš„å¤„ç†æ–¹å¼ä¼šç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸å¯¼è‡´è¿›ç¨‹æŒ‚æ‰ã€‚å‡è®¾ä½ è‡ªå·±å†™ä¸€ä¸ªå¼‚æ­¥å›¾ç‰‡åŠ è½½çš„æ¡†æ¶ï¼Œç„¶åç”¨AsyncTaskå®ç°çš„è¯ï¼Œå½“ä½ å¿«é€Ÿæ»‘åŠ¨ListViewçš„æ—¶å€™å¾ˆå®¹æ˜“å‘ç”Ÿè¿™ç§å¼‚å¸¸ï¼›è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå„å¤§ImageLoaderéƒ½æ˜¯è‡ªå·±å†™çº¿ç¨‹æ± å’ŒHandlderçš„åŸå› ã€‚</li>
<li>è¿™ä¸ªçº¿ç¨‹æ± æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼›é‚£ä¹ˆåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¹‹å†…ï¼Œæ‰€æœ‰åœ°æ–¹ä½¿ç”¨åˆ°çš„AsyncTaské»˜è®¤æ„é€ å‡½æ•°æ„é€ å‡ºæ¥çš„AsyncTaskéƒ½ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¦‚æœAppæ¨¡å—æ¯”è¾ƒå¤šå¹¶ä¸”ä¸åŠ æ§åˆ¶çš„è¯ï¼Œå¾ˆå®¹æ˜“æ»¡è¶³ç¬¬ä¸€æ¡çš„å´©æºƒæ¡ä»¶ï¼›å¦‚æœä½ ä¸å¹¸åœ¨ä¸åŒçš„AsyncTaskçš„doInBackgroudé‡Œé¢è®¿é—®äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿå„ç§å¹¶å‘ç¼–ç¨‹é—®é¢˜ã€‚</li>
<li>åœ¨AsyncTaskå…¨éƒ¨æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè¿›ç¨‹ä¸­è¿˜æ˜¯ä¼šå¸¸é©»corePoolSizeä¸ªçº¿ç¨‹ï¼›åœ¨Android 4.4 ï¼ˆAPI 19ï¼‰ä»¥ä¸‹ï¼Œè¿™ä¸ªcorePoolSizeæ˜¯hardcodeçš„ï¼Œæ•°å€¼æ˜¯5ï¼›API 19æ”¹æˆäº†<code>cpu + 1</code>ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨Android 4.4ä»¥å‰ï¼›å¦‚æœä½ æ‰§è¡Œäº†è¶…è¿‡äº”ä¸ªAsyncTaskï¼›ç„¶åå•¥ä¹Ÿä¸å¹²äº†ï¼Œè¿›ç¨‹ä¸­è¿˜æ˜¯ä¼šæœ‰5ä¸ªAsyncTaskçº¿ç¨‹ï¼›ä¸ä¿¡ï¼Œä½ çœ‹ï¼š</li>
</ol>
<p><img src="/images/asynctask.png" alt="img"></p>
<h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h3><p>AsyncTaské‡Œé¢çš„handlerå¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼ˆAPI 22ä»£ç ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternalHandler sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè¿™é‡Œç›´æ¥ç”¨çš„ä¸»çº¿ç¨‹çš„Looperï¼›å¦‚æœå»çœ‹API 22ä»¥ä¸‹çš„ä»£ç ï¼Œä¼šå‘ç°å®ƒæ²¡æœ‰è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨é»˜è®¤çš„ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼ŒHandlerä¼šä½¿ç”¨å½“å‰çº¿ç¨‹çš„Looperï¼Œå¦‚æœä½ çš„AsyncTaskæ˜¯åœ¨å­çº¿ç¨‹åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå¾ˆä¸å¹¸ï¼Œä½ çš„<code>onPreExecute</code>å’Œ<code>onPostExecute</code>å¹¶éåœ¨UIçº¿ç¨‹æ‰§è¡Œï¼Œè€Œæ˜¯è¢«Handler poståˆ°åˆ›å»ºå®ƒçš„é‚£ä¸ªçº¿ç¨‹æ‰§è¡Œï¼›å¦‚æœä½ åœ¨è¿™ä¸¤ä¸ªçº¿ç¨‹æ›´æ–°äº†UIï¼Œé‚£ä¹ˆç›´æ¥å¯¼è‡´å´©æºƒã€‚è¿™ä¹Ÿæ˜¯å¤§å®¶å£å£ç›¸ä¼ çš„<strong>AsyncTaskå¿…é¡»åœ¨ä¸»çº¿ç¨‹åˆ›å»º</strong>çš„åŸå› ã€‚</p>
<p>å¦å¤–ï¼ŒAsyncTaské‡Œé¢çš„è¿™ä¸ªHandleræ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯åœ¨ç±»åŠ è½½çš„æ—¶å€™åˆ›å»ºçš„ï¼›å¦‚æœåœ¨ä½ çš„APPè¿›ç¨‹é‡Œé¢ï¼Œä»¥å‰ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡AsyncTaskï¼Œç„¶ååœ¨å­çº¿ç¨‹ä½¿ç”¨AsyncTaskçš„ç›¸å…³å˜é‡ï¼Œé‚£ä¹ˆå¯¼è‡´é™æ€Handleråˆå§‹åŒ–ï¼Œå¦‚æœåœ¨API 16ä»¥ä¸‹ï¼Œé‚£ä¹ˆä¼šå‡ºç°ä¸Šé¢åŒæ ·çš„é—®é¢˜ï¼›è¿™å°±æ˜¯<strong>AsyncTaskå¿…é¡»åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–</strong> çš„åŸå› ã€‚</p>
<p>äº‹å®ä¸Šï¼Œåœ¨Android 4.1(API 16)ä»¥åï¼Œåœ¨APPä¸»çº¿ç¨‹ActivityThreadçš„mainå‡½æ•°é‡Œé¢ï¼Œç›´æ¥è°ƒç”¨äº†<code>AscynTask.init</code>å‡½æ•°ç¡®ä¿è¿™ä¸ªç±»æ˜¯åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–çš„ï¼›å¦å¤–ï¼Œinitè¿™ä¸ªå‡½æ•°é‡Œé¢è·å–äº†<code>InternalHandler</code>çš„Looperï¼Œç”±äºæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå› æ­¤ï¼ŒAsyncTaskçš„Handlerç”¨çš„ä¹Ÿæ˜¯ä¸»çº¿ç¨‹çš„Looperã€‚è¿™ä¸ªé—®é¢˜ä»è€Œå¾—åˆ°å½»åº•çš„è§£å†³ã€‚</p>
<h2 id="AsyncTaskæ˜¯å¹¶è¡Œæ‰§è¡Œçš„å—ï¼Ÿ"><a href="#AsyncTaskæ˜¯å¹¶è¡Œæ‰§è¡Œçš„å—ï¼Ÿ" class="headerlink" title="AsyncTaskæ˜¯å¹¶è¡Œæ‰§è¡Œçš„å—ï¼Ÿ"></a>AsyncTaskæ˜¯å¹¶è¡Œæ‰§è¡Œçš„å—ï¼Ÿ</h2><p>ç°åœ¨çŸ¥é“AsyncTaskå†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œé‚£ä¹ˆæ´¾å‘ç»™AsyncTaskçš„ä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¸ç¡®å®šã€‚åœ¨Android 1.5åˆšå¼•å…¥çš„æ—¶å€™ï¼ŒAsyncTaskçš„<code>execute</code>æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼›åˆ°äº†Android 1.6ç›´åˆ°Android 2.3.2ï¼Œåˆè¢«ä¿®æ”¹ä¸ºå¹¶è¡Œæ‰§è¡Œäº†ï¼Œè¿™ä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± å°±æ˜¯<code>THREAD_POOL_EXECUTOR</code>ï¼Œå› æ­¤åœ¨ä¸€ä¸ªè¿›ç¨‹å†…ï¼Œæ‰€æœ‰çš„AsyncTaskéƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼›ä½†æ˜¯åœ¨Android 3.0ä»¥åï¼Œå¦‚æœä½ ä½¿ç”¨<code>execute</code>å‡½æ•°ç›´æ¥æ‰§è¡ŒAsyncTaskï¼Œé‚£ä¹ˆ<strong>è¿™äº›ä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„</strong>ï¼›ï¼ˆä½ è¯´è›‹ç–¼ä¸ï¼‰æºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ª<code>sDefaultExecutor</code>å°±æ˜¯ç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆå®ƒçš„å€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç»§ç»­çœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div></pre></td></tr></table></figure>
<p>å› æ­¤ç»“è®ºå°±æ¥äº†ï¼š<strong>Android 3.0ä»¥ä¸Šï¼ŒAsyncTaské»˜è®¤å¹¶ä¸æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</strong>ï¼›</p>
<h3 id="ä¸ºä»€ä¹ˆé»˜è®¤ä¸å¹¶è¡Œæ‰§è¡Œï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé»˜è®¤ä¸å¹¶è¡Œæ‰§è¡Œï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé»˜è®¤ä¸å¹¶è¡Œæ‰§è¡Œï¼Ÿ"></a>ä¸ºä»€ä¹ˆé»˜è®¤ä¸å¹¶è¡Œæ‰§è¡Œï¼Ÿ</h3><p>ä¹Ÿè®¸ä½ ä¸ç†è§£ï¼Œä¸ºä»€ä¹ˆAsyncTaské»˜è®¤æŠŠå®ƒè®¾è®¡ä¸ºä¸²è¡Œæ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<p>ç”±äºä¸€ä¸ªè¿›ç¨‹å†…æ‰€æœ‰çš„AsyncTaskéƒ½æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼›å¦‚æœåŒæ—¶æœ‰å‡ ä¸ªAsyncTaskä¸€èµ·å¹¶è¡Œæ‰§è¡Œçš„è¯ï¼Œæ°å¥½AysncTaskçš„ä½¿ç”¨è€…åœ¨<code>doInbackgroud</code>é‡Œé¢è®¿é—®äº†ç›¸åŒçš„èµ„æºï¼Œä½†æ˜¯è‡ªå·±æ²¡æœ‰å¤„ç†åŒæ­¥é—®é¢˜ï¼›é‚£ä¹ˆå°±æœ‰å¯èƒ½å¯¼è‡´ç¾éš¾æ€§çš„åæœï¼</p>
<p>ç”±äºå¼€å‘è€…é€šå¸¸ä¸ä¼šæ„è¯†åˆ°éœ€è¦å¯¹ä»–ä»¬åˆ›å»ºçš„æ‰€æœ‰çš„AsyncTaskå¯¹è±¡é‡Œé¢çš„<code>doInbackgroud</code>åšåŒæ­¥å¤„ç†ï¼Œå› æ­¤ï¼ŒAPIçš„è®¾è®¡è€…ä¸ºäº†é¿å…è¿™ç§æ— æ„ä¸­è®¿é—®å¹¶å‘èµ„æºçš„é—®é¢˜ï¼Œå¹²è„†æŠŠè¿™ä¸ªAPIè®¾ç½®ä¸ºé»˜è®¤æ‰€æœ‰ä¸²è¡Œæ‰§è¡Œçš„äº†ã€‚å¦‚æœä½ æ˜ç¡®çŸ¥é“è‡ªå·±éœ€è¦å¹¶è¡Œå¤„ç†ä»»åŠ¡ï¼Œé‚£ä¹ˆä½ éœ€è¦ä½¿ç”¨<code>executeOnExecutor(Executor exec,Params... params)</code>è¿™ä¸ªå‡½æ•°æ¥æŒ‡å®šä½ ç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼ŒåŒæ—¶ä¸ºè‡ªå·±çš„è¡Œä¸ºè´Ÿè´£ã€‚ï¼ˆå¤„ç†åŒæ­¥é—®é¢˜ï¼‰</p>
<p>å®é™…ä¸Šã€ŠEffective Javaã€‹é‡Œé¢æœ‰ä¸€æ¡åŸåˆ™è¯´çš„å°±æ˜¯è¿™ç§æƒ…å†µï¼šä¸è¦åœ¨åŒæ­¥å—é‡Œé¢è°ƒç”¨ä¸å¯ä¿¡çš„å¤–æ¥å‡½æ•°ã€‚è¿™é‡Œæ˜æ˜¾è¿èƒŒäº†è¿™ä¸ªåŸåˆ™ï¼šAsyncTaskè¿™ä¸ªç±»å¹¶ä¸çŸ¥é“ä½¿ç”¨è€…ä¼šåœ¨<code>doInBackgroud</code>è¿™ä¸ªå‡½æ•°é‡Œé¢åšä»€ä¹ˆï¼Œä½†æ˜¯å¯¹å®ƒçš„è¡Œä¸ºåšäº†æŸç§å‡è®¾ã€‚</p>
<h3 id="å¦‚ä½•è®©AsyncTaskå¹¶è¡Œæ‰§è¡Œï¼Ÿ"><a href="#å¦‚ä½•è®©AsyncTaskå¹¶è¡Œæ‰§è¡Œï¼Ÿ" class="headerlink" title="å¦‚ä½•è®©AsyncTaskå¹¶è¡Œæ‰§è¡Œï¼Ÿ"></a>å¦‚ä½•è®©AsyncTaskå¹¶è¡Œæ‰§è¡Œï¼Ÿ</h3><p>æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œå¦‚æœä½ ç¡®å®šè‡ªå·±åšå¥½äº†åŒæ­¥å¤„ç†ï¼Œæˆ–è€…ä½ æ²¡æœ‰åœ¨ä¸åŒçš„AsyncTaské‡Œé¢è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦AsyncTaskèƒ½å¤Ÿå¹¶è¡Œå¤„ç†ä»»åŠ¡çš„è¯ï¼Œä½ å¯ä»¥ç”¨å¸¦æœ‰ä¸¤ä¸ªå‚æ•°çš„<code>executeOnExecutor</code>æ‰§è¡Œä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> AsyncTask&lt;Void, Void, Vo</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</div></pre></td></tr></table></figure>
<h2 id="æ›´å¥½çš„AsyncTask"><a href="#æ›´å¥½çš„AsyncTask" class="headerlink" title="æ›´å¥½çš„AsyncTask"></a>æ›´å¥½çš„AsyncTask</h2><p>ä»ä¸Šé¢çš„åˆ†æå¾—çŸ¥ï¼ŒAsyncTaskæœ‰å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>é»˜è®¤çš„AsyncTaskå¦‚æœå¤„ç†çš„ä»»åŠ¡è¿‡å¤šï¼Œä¼šå¯¼è‡´ç¨‹åºç›´æ¥å´©æºƒï¼›</li>
<li>AsyncTaskç±»å¿…é¡»åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–ï¼Œå¿…é¡»åœ¨ä¸»çº¿ç¨‹åˆ›å»ºï¼Œä¸ç„¶åœ¨API 16ä»¥ä¸‹å¾ˆå¤§æ¦‚ç‡å´©æºƒã€‚</li>
<li>å¦‚æœä½ æ›¾ç»ä½¿ç”¨è¿‡AsyncTaskï¼Œä»¥åä¸ç”¨äº†ï¼›åœ¨Android 4.4ä»¥ä¸‹ï¼Œè¿›ç¨‹å†…ä¹Ÿé»˜è®¤æœ‰5ä¸ªAsyncTaskçº¿ç¨‹ï¼›åœ¨Android 4.4ä»¥ä¸Šï¼Œé»˜è®¤æœ‰<code>CPU + 1</code>ä¸ªçº¿ç¨‹ã€‚</li>
<li>Android 3.0ä»¥ä¸Šçš„AsyncTaské»˜è®¤æ˜¯ä¸²è¡Œæ‰§è¡Œä»»åŠ¡çš„ï¼›å¦‚æœè¦å¹¶è¡Œæ‰§è¡Œéœ€è¦è°ƒç”¨ä½ç‰ˆæœ¬æ²¡æœ‰çš„APIï¼Œå¤„ç†éº»çƒ¦ã€‚</li>
</ol>
<p>å› æ­¤æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„AsyncTaskåšäº†ä¸€äº›ä¿®æ”¹ï¼Œåœ¨ä¸åŒAndroidç‰ˆæœ¬æä¾›ä¸€è‡´çš„è¡Œä¸ºï¼Œå¹¶ä¸”æé«˜äº†ä½¿ç”¨æ­¤ç±»çš„å®‰å…¨æ€§ï¼Œä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ·»åŠ å¯¹äºä»»åŠ¡è¿‡å¤šå¯¼è‡´å´©æºƒçš„å¼‚å¸¸ä¿æŠ¤ï¼›åœ¨è¿™é‡Œè¿›è¡Œå¿…è¦çš„æ•°æ®ç»Ÿè®¡ä¸ŠæŠ¥å·¥ä½œï¼›å¦‚æœå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œè¯´æ˜AsyncTaskä¸é€‚åˆè¿™ç§åœºæ™¯äº†ï¼Œéœ€è¦è€ƒè™‘é‡æ„ï¼›</li>
<li>ç§»æ¤API 22å¯¹äºHandlerçš„å¤„ç†ï¼›è¿™æ ·å°±ç®—åœ¨çº¿ç¨‹åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼›</li>
<li>æä¾›ä¸²è¡Œæ‰§è¡Œå’Œå¹¶è¡Œæ‰§è¡Œçš„<code>execute</code>æ–¹æ³•ï¼›é»˜è®¤ä¸²è¡Œæ‰§è¡Œï¼Œå¦‚æœæ˜ç¡®çŸ¥é“è‡ªå·±åœ¨å¹²ä»€ä¹ˆï¼Œå¯ä»¥ä½¿ç”¨<code>executeParallel</code>å¹¶è¡Œæ‰§è¡Œã€‚</li>
<li>åœ¨<code>doInbackgroud</code>é‡Œé¢é¢‘ç¹å´©æºƒçš„åœ°æ–¹åŠ ä¸Š<code>try..catch</code>ï¼›è‡ªå·±å¤„ç†æ•°æ®ä¸ŠæŠ¥å·¥ä½œã€‚</li>
</ol>
<p>å®Œæ•´ä»£ç è§gistï¼Œ<a href="https://gist.github.com/tiann/8860bcc514f067ab4291" target="_blank" rel="external">BetterAsyncTask</a></p>
<blockquote>
<p>åŸæ–‡åœ°å€ï¼š<a href="http://weishu.me/2016/01/18/dive-into-asynctask/" target="_blank" rel="external">http://weishu.me/2016/01/18/dive-into-asynctask/</a></p>
</blockquote>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ViewDragHelperæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/ViewDragHelper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/ViewDragHelperæºç è§£æ/</id>
    <published>2017-07-26T12:08:18.000Z</published>
    <updated>2017-07-26T12:08:39.221Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="ViewDragHelperæºç è§£æ"><a href="#ViewDragHelperæºç è§£æ" class="headerlink" title="ViewDragHelperæºç è§£æ"></a>ViewDragHelperæºç è§£æ</h2><h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><p>æˆ‘ä»¬äº†è§£äº†<code>ViewDragHelper</code>æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¤„ç†å„ç§æ‹–æ‹½äº‹ä»¶çš„ç±».ä½¿ç”¨å¥½<code>ViewDragHelper</code>èƒ½å¸®åŠ©æˆ‘ä»¬åšå‡ºå„ç§é…·ç‚«çš„äº¤äº’,ä»Šå¤©æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹<code>ViewDragHelper</code>çš„ä½¿ç”¨ä¸å®ç°</p>
<h3 id="2-ä½¿ç”¨æ–¹æ³•"><a href="#2-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="2. ä½¿ç”¨æ–¹æ³•"></a>2. ä½¿ç”¨æ–¹æ³•</h3><p>æˆ‘ä»¬è¿™é‡Œå°±ä»¥<a href="http://blog.csdn.net/lmj623565791/article/details/46858663" target="_blank" rel="external">ç¿”æ€»çš„è¿™ç¯‡æ–‡ç« </a>ä¸­çš„ä¾‹å­æ¥ä»‹ç»ä¸€ä¸‹<code>ViewDragHelper</code>çš„ä½¿ç”¨.å¦å¤–,æœ¬æ–‡ä¸­çš„demoå¯ä»¥åœ¨<a href="https://github.com/Skykai521/ViewDragHelperDemo" target="_blank" rel="external">è¿™é‡Œæ‰¾åˆ°</a></p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>DragLayout</code>ç±»å¹¶ç»§æ‰¿è‡ª<code>LinearLayout</code>,ç„¶åæˆ‘ä»¬å‡†å¤‡åœ¨<code>DragLayout</code>æ”¾ç½®ä¸‰ä¸ª<code>View</code>ç¬¬ä¸€ä¸ªç”¨æ¥è¢«æˆ‘ä»¬æ‹–åŠ¨ç„¶ååœæ­¢åœ¨æ¾æ‰‹çš„ä½ç½®,ç¬¬äºŒä¸ªå¯ä»¥è¢«æˆ‘ä»¬æ‹–åŠ¨,æ¾æ‰‹çš„æ—¶å€™æ»‘åŠ¨åˆ°æŒ‡å®šä½ç½®,ç¬¬ä¸‰ä¸ªåªå¯ä»¥é€šè¿‡è§¦æ‘¸è¾¹ç¼˜æ¥è¿›è¡Œæ‹–åŠ¨,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DragLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ViewDragHelper mDragger;</div><div class="line">    <span class="keyword">private</span> View mDragView;</div><div class="line">    <span class="keyword">private</span> View mAutoBackView;</div><div class="line">    <span class="keyword">private</span> View mEdgeTrackerView;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Point mAutoBackOriginPos = <span class="keyword">new</span> Point();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DragLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DragLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DragLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        initViewDragHelper();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initViewDragHelper</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDragger = ViewDragHelper.create(<span class="keyword">this</span>,myCallback);</div><div class="line">        mDragger.setEdgeTrackingEnabled(ViewDragHelper.EDGE_ALL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ViewDragHelper.Callback myCallback = <span class="keyword">new</span> ViewDragHelper.Callback() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="comment">//childä¸ºå½“å‰è§¦æ‘¸åŒºåŸŸä¸‹çš„View,å¦‚æœè¿”å›true,å°±å¯ä»¥æ‹–æ‹½.</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> child == mDragView || child == mAutoBackView;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//æ¾æ‰‹æ—¶çš„å›è°ƒ</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewReleased</span><span class="params">(View releasedChild, <span class="keyword">float</span> xvel, <span class="keyword">float</span> yvel)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (releasedChild == mAutoBackView) &#123;</div><div class="line">                mDragger.settleCapturedViewAt(mAutoBackOriginPos.x, mAutoBackOriginPos.y);</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//è¾¹ç¼˜è§¦æ‘¸å¼€å§‹æ—¶çš„å›è°ƒ</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeDragStarted</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">            mDragger.captureChildView(mEdgeTrackerView, pointerId);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//è·å–æ°´å¹³æ–¹å‘å…è®¸æ‹–æ‹½çš„åŒºåŸŸ,è¿™é‡Œæ˜¯çˆ¶å¸ƒå±€çš„å®½-å­æ§ä»¶çš„å®½</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewHorizontalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getMeasuredWidth() - child.getMeasuredWidth();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//è·å–å‚ç›´æ–¹å‘å…è®¸æ‹–æ‹½çš„èŒƒå›´</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewVerticalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getMeasuredHeight() - child.getMeasuredHeight();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//leftä¸ºchildå³å°†ç§»åŠ¨åˆ°çš„æ°´å¹³ä½ç½®çš„å€¼,ä½†æ˜¯è¿”å›å€¼ä¼šæœ€ç»ˆå†³å®šç§»åŠ¨åˆ°çš„å€¼</span></div><div class="line">        <span class="comment">//è¿™é‡Œç›´æ¥è¿”å›äº†left</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> left;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åŒä¸Šåªæ˜¯è¿™é‡Œæ˜¯å‚ç›´æ–¹å‘</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> top;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mDragger.continueSettling(<span class="keyword">true</span>)) &#123;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mDragger.shouldInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        mDragger.processTouchEvent(event);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onFinishInflate();</div><div class="line">        mDragView = getChildAt(<span class="number">0</span>);</div><div class="line">        mAutoBackView = getChildAt(<span class="number">1</span>);</div><div class="line">        mEdgeTrackerView = getChildAt(<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line">        mAutoBackOriginPos.x = mAutoBackView.getLeft();</div><div class="line">        mAutoBackOriginPos.y = mAutoBackView.getTop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬é¦–å…ˆåœ¨æ„é€ æ–¹æ³•é‡Œä¼ å…¥äº†å½“å‰ç±»çš„å¯¹è±¡å’Œæˆ‘ä»¬å®šä¹‰çš„<code>ViewDragHelper.Callback</code>å¯¹è±¡åˆå§‹åŒ–äº†æˆ‘ä»¬çš„<code>ViewDragHelper</code>,ç„¶åæˆ‘ä»¬å¸Œæœ›æ‰€æœ‰çš„è¾¹ç¼˜è§¦æ‘¸éƒ½èƒ½è§¦å‘<code>mEdgeTrackerView</code>çš„æ‹–åŠ¨,æ‰€ä»¥æˆ‘ä»¬ç´§æ¥ç€è°ƒç”¨äº†<code>mDragger.setEdgeTrackingEnabled(ViewDragHelper.EDGE_ALL);</code>æ–¹æ³•.</li>
<li>åœ¨æˆ‘ä»¬å®šä¹‰çš„<code>Callback</code>ä¸­,æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•,æ¯ä¸ªå›è°ƒæ–¹æ³•éƒ½æœ‰å®ƒçš„ä½œç”¨,åœ¨ä»£ç é‡Œæ³¨é‡Šæ¯”è¾ƒæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬ä¸‹é¢ä¹Ÿä¼šè§£ææ¯ä¸€ä¸ª<code>Callback</code>ä¸­å›è°ƒæ–¹æ³•çš„ä½œç”¨.</li>
<li>ç¬¬ä¸‰æ­¥æˆ‘ä»¬éœ€è¦åœ¨<code>onInterceptTouchEvent()</code>æ–¹æ³•å’Œ<code>onTouchEvent()</code>å°†äº‹ä»¶å§”æ‰˜ç»™<code>ViewDragHelper</code>å»å¤„ç†,è¿™æ ·<code>ViewDragHelper</code>æ‰èƒ½æ ¹æ®å“åº”çš„äº‹ä»¶å¹¶å›è°ƒæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„<code>Callback</code>æ¥å£æ¥è¿›è¡Œå“åº”çš„å¤„ç†,</li>
<li>ç”±äº<code>ViewDragHelper</code>ä¸­çš„æ»‘åŠ¨æ˜¯äº¤ç»™<code>Srcoller</code>ç±»æ¥å¤„ç†çš„æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦é‡å†™<code>computeScroll()</code>æ–¹æ³•,é…åˆ<code>Scroller</code>å®Œæˆæ»šåŠ¨åŠ¨ç”».</li>
<li>æœ€ååœ¨<code>onFinishInflate()</code>é‡Œè·å–åˆ°æˆ‘ä»¬çš„<code>View</code>å¯¹è±¡å³å¯.</li>
</ul>
<h3 id="3-ç±»å…³ç³»å›¾"><a href="#3-ç±»å…³ç³»å›¾" class="headerlink" title="3. ç±»å…³ç³»å›¾"></a>3. ç±»å…³ç³»å›¾</h3><p>ç”±äºå°±ä¸€ä¸ªç±»ç±»å›¾æˆ‘ä»¬å°±ä¸ç”»äº†,ä½†æ˜¯ä½œä¸ºä¸€ä¸ªå¼ºè¿«ç—‡æ‚£è€…,è¿™ä¸ªæ ‡é¢˜å¿…é¡»æœ‰â€¦</p>
<h3 id="4-æºç åˆ†æ"><a href="#4-æºç åˆ†æ" class="headerlink" title="4. æºç åˆ†æ"></a>4. æºç åˆ†æ</h3><h4 id="4-1-ViewDragHelper-Callbackçš„å®ç°"><a href="#4-1-ViewDragHelper-Callbackçš„å®ç°" class="headerlink" title="4.1 ViewDragHelper.Callbackçš„å®ç°"></a>4.1 ViewDragHelper.Callbackçš„å®ç°</h4><p>åœ¨åˆ†æ<code>ViewDragHelper</code>ä¹‹å‰,æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹<code>Callback</code>çš„å®šä¹‰,çœ‹çœ‹<code>Callback</code>éƒ½å®šä¹‰äº†å“ªäº›æ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//å½“Viewçš„æ‹–æ‹½çŠ¶æ€æ”¹å˜æ—¶å›è°ƒ,stateä¸ºSTATE_IDLE,STATE_DRAGGING,STATE_SETTLINGçš„ä¸€ç§</span></div><div class="line">    <span class="comment">//STATE_IDLE:ã€€å½“å‰æœªè¢«æ‹–æ‹½</span></div><div class="line">    <span class="comment">//STATE_DRAGGINGï¼šæ­£åœ¨è¢«æ‹–æ‹½</span></div><div class="line">    <span class="comment">//STATE_SETTLING:ã€€è¢«æ‹–æ‹½åéœ€è¦è¢«å®‰æ”¾åˆ°ä¸€ä¸ªä½ç½®ä¸­çš„çŠ¶æ€</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewDragStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//å½“Viewè¢«æ‹–æ‹½ä½ç½®å‘ç”Ÿæ”¹å˜æ—¶å›è°ƒ</span></div><div class="line">    <span class="comment">//changedView ï¼šè¢«æ‹–æ‹½çš„View</span></div><div class="line">    <span class="comment">//left : è¢«æ‹–æ‹½åViewçš„leftè¾¹ç¼˜åæ ‡</span></div><div class="line">    <span class="comment">//top : è¢«æ‹–æ‹½åViewçš„topè¾¹ç¼˜åæ ‡</span></div><div class="line">    <span class="comment">//dx : æ‹–åŠ¨çš„xåç§»é‡</span></div><div class="line">    <span class="comment">//dy : æ‹–åŠ¨çš„yåç§»é‡</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewPositionChanged</span><span class="params">(View changedView, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//å½“ä¸€ä¸ªViewè¢«æ•è·åˆ°å‡†å¤‡å¼€å§‹æ‹–åŠ¨æ—¶å›è°ƒ,</span></div><div class="line">    <span class="comment">//capturedChild : æ•è·çš„View</span></div><div class="line">    <span class="comment">//activePointerId : å¯¹åº”çš„PointerId</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCaptured</span><span class="params">(View capturedChild, <span class="keyword">int</span> activePointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//å½“è¢«æ•è·æ‹–æ‹½çš„Viewè¢«é‡Šæ”¾æ˜¯å›è°ƒ</span></div><div class="line">    <span class="comment">//releasedChild : è¢«é‡Šæ”¾çš„View</span></div><div class="line">    <span class="comment">//xvel : é‡Šæ”¾Viewçš„xæ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦</span></div><div class="line">    <span class="comment">//yvel : é‡Šæ”¾Viewçš„yæ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewReleased</span><span class="params">(View releasedChild, <span class="keyword">float</span> xvel, <span class="keyword">float</span> yvel)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//å¦‚æœparentViewè®¢é˜…äº†è¾¹ç¼˜è§¦æ‘¸,åˆ™å¦‚æœæœ‰è¾¹ç¼˜è§¦æ‘¸å°±å›è°ƒçš„æ¥å£</span></div><div class="line">    <span class="comment">//edgeFlags : å½“å‰è§¦æ‘¸çš„flag æœ‰: EDGE_LEFT,EDGE_TOP,EDGE_RIGHT,EDGE_BOTTOM</span></div><div class="line">    <span class="comment">//pointerId : ç”¨æ¥æè¿°è¾¹ç¼˜è§¦æ‘¸æ“ä½œçš„id</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeTouched</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//æ˜¯å¦é”å®šè¯¥è¾¹ç¼˜çš„è§¦æ‘¸,é»˜è®¤è¿”å›false,è¿”å›trueè¡¨ç¤ºé”å®š</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onEdgeLock</span><span class="params">(<span class="keyword">int</span> edgeFlags)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//è¾¹ç¼˜è§¦æ‘¸å¼€å§‹æ—¶å›è°ƒ</span></div><div class="line">    <span class="comment">//edgeFlags : å½“å‰è§¦æ‘¸çš„flag æœ‰: EDGE_LEFT,EDGE_TOP,EDGE_RIGHT,EDGE_BOTTOM</span></div><div class="line">    <span class="comment">//pointerId : ç”¨æ¥æè¿°è¾¹ç¼˜è§¦æ‘¸æ“ä½œçš„id</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeDragStarted</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">//åœ¨å¯»æ‰¾å½“å‰è§¦æ‘¸ç‚¹ä¸‹çš„å­Viewæ—¶ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¯»æ‰¾åˆ°çš„Viewä¼šæä¾›ç»™tryCaptureViewForDrag()æ¥å°è¯•æ•è·ã€‚</span></div><div class="line">    <span class="comment">//å¦‚æœéœ€è¦æ”¹å˜å­Viewçš„éå†æŸ¥è¯¢é¡ºåºå¯æ”¹å†™æ­¤æ–¹æ³•ï¼Œä¾‹å¦‚è®©ä¸‹å±‚çš„Viewä¼˜å…ˆäºä¸Šå±‚çš„Viewè¢«é€‰ä¸­ã€‚</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrderedChildIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//è·å–è¢«æ‹–æ‹½View child çš„æ°´å¹³æ‹–æ‹½èŒƒå›´,è¿”å›0è¡¨ç¤ºæ— æ³•è¢«æ°´å¹³æ‹–æ‹½</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewHorizontalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//è·å–è¢«æ‹–æ‹½View child çš„å‚ç›´æ‹–æ‹½èŒƒå›´,è¿”å›0è¡¨ç¤ºæ— æ³•è¢«æ°´å¹³æ‹–æ‹½</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewVerticalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å°è¯•æ•è·è¢«æ‹–æ‹½çš„View</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">//å†³å®šæ‹–æ‹½Viewåœ¨æ°´å¹³æ–¹å‘ä¸Šåº”è¯¥ç§»åŠ¨åˆ°çš„ä½ç½®</span></div><div class="line">    <span class="comment">//child : è¢«æ‹–æ‹½çš„View</span></div><div class="line">    <span class="comment">//left : æœŸæœ›ç§»åŠ¨åˆ°ä½ç½®çš„Viewçš„leftå€¼</span></div><div class="line">    <span class="comment">//dx : ç§»åŠ¨çš„æ°´å¹³è·ç¦»</span></div><div class="line">    <span class="comment">//è¿”å›å€¼ : ç›´æ¥å†³å®šViewåœ¨æ°´å¹³æ–¹å‘çš„ä½ç½®</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å†³å®šæ‹–æ‹½Viewåœ¨å‚ç›´æ–¹å‘ä¸Šåº”è¯¥ç§»åŠ¨åˆ°çš„ä½ç½®</span></div><div class="line">    <span class="comment">//child : è¢«æ‹–æ‹½çš„View</span></div><div class="line">    <span class="comment">//top : æœŸæœ›ç§»åŠ¨åˆ°ä½ç½®çš„Viewçš„topå€¼</span></div><div class="line">    <span class="comment">//dy : ç§»åŠ¨çš„å‚ç›´è·ç¦»</span></div><div class="line">    <span class="comment">//è¿”å›å€¼ : ç›´æ¥å†³å®šViewåœ¨å‚ç›´æ–¹å‘çš„ä½ç½®</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æƒ³å¿…æ³¨é‡Šå·²ç»å¾ˆæ¸…æ¥šäº†,æ­£æ˜¯è¿™äº›å›è°ƒæ–¹æ³•,å†ç»“åˆ<code>ViewDragHelper</code>ä¸­çš„å„ç§æ–¹æ³•,æ¥å¸®åŠ©æˆ‘ä»¬å®ç°å„ç§å„æ ·çš„æ‹–æ‹½çš„æ•ˆæœã€‚</p>
<h4 id="4-2-shouldInterceptTouchEvent-æ–¹æ³•çš„å®ç°"><a href="#4-2-shouldInterceptTouchEvent-æ–¹æ³•çš„å®ç°" class="headerlink" title="4.2 shouldInterceptTouchEvent()æ–¹æ³•çš„å®ç°"></a>4.2 shouldInterceptTouchEvent()æ–¹æ³•çš„å®ç°</h4><p>åœ¨è¿™é‡Œæˆ‘ä»¬å‡è®¾å¤§å®¶éƒ½æ¸…æ¥šäº†<code>Android</code>çš„äº‹ä»¶åˆ†å‘æœºåˆ¶,å¦‚æœä¸æ¸…æ¥šè¯·çœ‹<a href="http://blog.csdn.net/guolin_blog/article/details/9097463" target="_blank" rel="external">è¿™é‡Œ</a>,è¦æƒ³å¤„ç†è§¦æ‘¸äº‹ä»¶,æˆ‘ä»¬éœ€è¦åœ¨<code>onInterceptTouchEvent(MotionEvent ev)</code>æ–¹æ³•é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªè¿™æ¬¡è§¦æ‘¸äº‹ä»¶,å¦‚æœæ­¤æ–¹æ³•è¿”å›<code>true</code>åˆ™è§¦æ‘¸äº‹ä»¶å°†ä¼šäº¤ç»™<code>onTouchEvent(MotionEvent event)</code>å¤„ç†,è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤„ç†è§¦æ‘¸äº‹ä»¶äº†,æ‰€ä»¥æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä½¿ç”¨æ–¹æ³•é‡Œä¼šè¿™æ ·å†™:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mDragger.shouldInterceptTouchEvent(ev);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    mDragger.processTouchEvent(event);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å°†æ˜¯å¦æ‹¦æˆªè§¦æ‘¸äº‹ä»¶,ä»¥åŠå¤„ç†è§¦æ‘¸äº‹ä»¶å§”æ‰˜ç»™<code>ViewDragHelper</code>æ¥å¤„ç†äº†,æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>ViewDragHelper</code>ä¸­<code>shouldInterceptTouchEvent();</code>æ–¹æ³•çš„å®ç°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="comment">//è·å–action</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">    <span class="comment">//è·å–actionå¯¹åº”çš„index</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">    <span class="comment">//å¦‚æœæ˜¯æŒ‰ä¸‹çš„actionåˆ™é‡ç½®ä¸€äº›ä¿¡æ¯,åŒ…æ‹¬å„ç§äº‹ä»¶ç‚¹çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        <span class="comment">// Reset things for a new event stream, just in case we didn't get</span></div><div class="line">        <span class="comment">// the whole previous stream.</span></div><div class="line">        cancel();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//åˆå§‹åŒ–mVelocityTracker</span></div><div class="line">    <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</div><div class="line">        mVelocityTracker = VelocityTracker.obtain();</div><div class="line">    &#125;</div><div class="line">    mVelocityTracker.addMovement(ev);</div><div class="line"></div><div class="line">    <span class="comment">//æ ¹æ®actionæ¥åšç›¸åº”çš„å¤„ç†</span></div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY();</div><div class="line">            <span class="comment">//è·å–è¿™ä¸ªäº‹ä»¶å¯¹åº”çš„pointerId,ä¸€èˆ¬æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªæ‰‹æŒ‡è§¦æ‘¸æ—¶ä¸º0</span></div><div class="line">            <span class="comment">//ä¸¤ä¸ªæ‰‹æŒ‡è§¦æ‘¸æ—¶ç¬¬äºŒä¸ªæ‰‹æŒ‡è§¦æ‘¸è¿”å›çš„pointerIdä¸º1ï¼Œä»¥æ­¤ç±»æ¨</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</div><div class="line">            <span class="comment">//ä¿å­˜ç‚¹çš„æ•°æ®</span></div><div class="line">            <span class="comment">//TODO (1)</span></div><div class="line">            saveInitialMotion(x, y, pointerId);</div><div class="line">            <span class="comment">//è·å–å½“å‰è§¦æ‘¸ç‚¹ä¸‹æœ€é¡¶å±‚çš„å­View</span></div><div class="line">            <span class="comment">//TODO (2)</span></div><div class="line">            <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line"></div><div class="line">            <span class="comment">//å¦‚æœtoCaptureæ˜¯å·²ç»æ•è·çš„View,è€Œä¸”æ­£åœ¨å¤„äºè¢«é‡Šæ”¾çŠ¶æ€</span></div><div class="line">            <span class="comment">//é‚£ä¹ˆå°±é‡æ–°æ•è·</span></div><div class="line">            <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mDragState == STATE_SETTLING) &#123;</div><div class="line">                tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//å¦‚æœè§¦æ‘¸äº†è¾¹ç¼˜,å›è°ƒcallbackçš„onEdgeTouched()æ–¹æ³•</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">            <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å½“åˆæœ‰ä¸€ä¸ªæ‰‹æŒ‡è§¦æ‘¸æ—¶</span></div><div class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, actionIndex);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(ev, actionIndex);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, actionIndex);</div><div class="line"></div><div class="line">            <span class="comment">//ä¿å­˜è§¦æ‘¸ä¿¡æ¯</span></div><div class="line">            saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">            <span class="comment">//å› ä¸ºåŒä¸€æ—¶é—´ViewDragHelperåªèƒ½æ“æ§ä¸€ä¸ªView,æ‰€ä»¥å½“æœ‰æ–°çš„æ‰‹æŒ‡è§¦æ‘¸æ—¶</span></div><div class="line">            <span class="comment">//åªè®¨è®ºå½“æ— è§¦æ‘¸å‘ç”Ÿæ—¶,å›è°ƒè¾¹ç¼˜è§¦æ‘¸çš„callback</span></div><div class="line">            <span class="comment">//æˆ–è€…æ­£åœ¨å¤„äºé‡Šæ”¾çŠ¶æ€æ—¶é‡æ–°æ•è·View</span></div><div class="line">            <span class="keyword">if</span> (mDragState == STATE_IDLE) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">                <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                    mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mDragState == STATE_SETTLING) &#123;</div><div class="line">                <span class="comment">// Catch a settling view if possible.</span></div><div class="line">                <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                <span class="keyword">if</span> (toCapture == mCapturedView) &#123;</div><div class="line">                    tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å½“æ‰‹æŒ‡ç§»åŠ¨æ—¶</span></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">            <span class="keyword">if</span> (mInitialMotionX == <span class="keyword">null</span> || mInitialMotionY == <span class="keyword">null</span>) <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// First to cross a touch slop over a draggable view wins. Also report edge drags.</span></div><div class="line">            <span class="comment">//å¾—åˆ°è§¦æ‘¸ç‚¹çš„æ•°é‡,å¹¶å¾ªç¯å¤„ç†,åªå¤„ç†ç¬¬ä¸€ä¸ªå‘ç”Ÿäº†æ‹–æ‹½çš„äº‹ä»¶</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = MotionEventCompat.getPointerCount(ev);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, i);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(ev, i);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, i);</div><div class="line">                <span class="comment">//è·å¾—æ‹–æ‹½åç§»é‡</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line">                <span class="comment">//è·å–å½“å‰è§¦æ‘¸ç‚¹ä¸‹æœ€é¡¶å±‚çš„å­View</span></div><div class="line">                <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                <span class="comment">//å¦‚æœæ‰¾åˆ°äº†æœ€é¡¶å±‚View,å¹¶ä¸”äº§ç”Ÿäº†æ‹–åŠ¨(checkTouchSlop()è¿”å›true)</span></div><div class="line">                <span class="comment">//TODO (3)</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> pastSlop = toCapture != <span class="keyword">null</span> &amp;&amp; checkTouchSlop(toCapture, dx, dy);</div><div class="line">                <span class="keyword">if</span> (pastSlop) &#123;</div><div class="line">                    <span class="comment">//æ ¹æ®callbackçš„å››ä¸ªæ–¹æ³•getView[Horizontal|Vertical]DragRangeå’Œ</span></div><div class="line">                    <span class="comment">//clampViewPosition[Horizontal|Vertical]æ¥æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‹–åŠ¨</span></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = toCapture.getLeft();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> targetLeft = oldLeft + (<span class="keyword">int</span>) dx;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> newLeft = mCallback.clampViewPositionHorizontal(toCapture,</div><div class="line">                            targetLeft, (<span class="keyword">int</span>) dx);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> oldTop = toCapture.getTop();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> targetTop = oldTop + (<span class="keyword">int</span>) dy;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> newTop = mCallback.clampViewPositionVertical(toCapture, targetTop,</div><div class="line">                            (<span class="keyword">int</span>) dy);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> horizontalDragRange = mCallback.getViewHorizontalDragRange(</div><div class="line">                            toCapture);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> verticalDragRange = mCallback.getViewVerticalDragRange(toCapture);</div><div class="line">                    <span class="comment">//å¦‚æœéƒ½ä¸å…è®¸ç§»åŠ¨åˆ™è·³å‡ºå¾ªç¯</span></div><div class="line">                    <span class="keyword">if</span> ((horizontalDragRange == <span class="number">0</span> || horizontalDragRange &gt; <span class="number">0</span></div><div class="line">                            &amp;&amp; newLeft == oldLeft) &amp;&amp; (verticalDragRange == <span class="number">0</span></div><div class="line">                            || verticalDragRange &gt; <span class="number">0</span> &amp;&amp; newTop == oldTop)) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//è®°å½•å¹¶å›è°ƒæ˜¯å¦æœ‰è¾¹ç¼˜è§¦æ‘¸</span></div><div class="line">                reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                    <span class="comment">// Callback might have started an edge drag</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//å¦‚æœäº§ç”Ÿäº†æ‹–åŠ¨åˆ™è°ƒç”¨tryCaptureViewForDrag()</span></div><div class="line">                <span class="comment">//TODO (4)</span></div><div class="line">                <span class="keyword">if</span> (pastSlop &amp;&amp; tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ä¿å­˜è§¦æ‘¸ç‚¹çš„ä¿¡æ¯</span></div><div class="line">            saveLastMotion(ev);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å½“æœ‰ä¸€ä¸ªæ‰‹æŒ‡æŠ¬èµ·æ—¶,æ¸…é™¤è¿™ä¸ªæ‰‹æŒ‡çš„è§¦æ‘¸æ•°æ®</span></div><div class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, actionIndex);</div><div class="line">            clearMotionHistory(pointerId);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//æ¸…é™¤æ‰€æœ‰è§¦æ‘¸æ•°æ®</span></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">            cancel();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å¦‚æœmDragStateç­‰äºæ­£åœ¨æ‹–æ‹½åˆ™è¿”å›true</span></div><div class="line">    <span class="keyword">return</span> mDragState == STATE_DRAGGING;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢å°±æ˜¯æ•´ä¸ª<code>shouldInterceptTouchEvent()</code>çš„å®ç°,ä¸Šé¢çš„æ³¨é‡Šä¹Ÿè¶³å¤Ÿæ¸…æ¥šäº†,æˆ‘ä»¬è¿™é‡Œå°±å…ˆä¸åˆ†ææŸä¸€ç§è§¦æ‘¸äº‹ä»¶,å¤§å®¶å¯ä»¥çœ‹åˆ°æˆ‘ä¸Šé¢ç•™äº†å‡ ä¸ªTODO,ä¸‹æ–‡ä¼šä¸€èµ·åˆ†æ,è¿™é‡Œæˆ‘å‡è®¾å¤§å®¶éƒ½å·²ç»å¯¹è§¦æ‘¸äº‹ä»¶åˆ†å‘å¤„ç†éƒ½æœ‰å……åˆ†çš„ç†è§£äº†,æˆ‘ä»¬ä¸‹é¢å°±ç›´æ¥çœ‹<code>ViewDragHelper</code>é‡Œ<code>processTouchEvent()</code>æ–¹æ³•çš„å®ç°.</p>
<h4 id="4-3-processTouchEvent-æ–¹æ³•çš„å®ç°"><a href="#4-3-processTouchEvent-æ–¹æ³•çš„å®ç°" class="headerlink" title="4.3 processTouchEvent()æ–¹æ³•çš„å®ç°"></a>4.3 processTouchEvent()æ–¹æ³•çš„å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">    ...ï¼ˆçœå»éƒ¨åˆ†ä»£ç ï¼‰</div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">            ...ï¼ˆçœå»éƒ¨åˆ†ä»£ç ï¼‰</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">            ...ï¼ˆçœå»éƒ¨åˆ†ä»£ç ï¼‰</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">            <span class="comment">//å¦‚æœç°åœ¨å·²ç»æ˜¯æ‹–æ‹½çŠ¶æ€</span></div><div class="line">            <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = MotionEventCompat.findPointerIndex(ev, mActivePointerId);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(ev, index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> idx = (<span class="keyword">int</span>) (x - mLastMotionX[mActivePointerId]);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> idy = (<span class="keyword">int</span>) (y - mLastMotionY[mActivePointerId]);</div><div class="line"></div><div class="line">                <span class="comment">//æ‹–æ‹½è‡³æŒ‡å®šä½ç½®</span></div><div class="line">                <span class="comment">//TODO (5)</span></div><div class="line">                dragTo(mCapturedView.getLeft() + idx, mCapturedView.getTop() + idy, idx, idy);</div><div class="line"></div><div class="line">                saveLastMotion(ev);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Check to see if any pointer is now over a draggable view.</span></div><div class="line">                <span class="comment">//å¦‚æœè¿˜ä¸æ˜¯æ‹–æ‹½çŠ¶æ€,å°±æ£€æµ‹æ˜¯å¦ç»è¿‡äº†ä¸€ä¸ªView</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = MotionEventCompat.getPointerCount(ev);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, i);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(ev, i);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, i);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line"></div><div class="line">                    reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                    <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                        <span class="comment">// Callback might have started an edge drag.</span></div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                    <span class="keyword">if</span> (checkTouchSlop(toCapture, dx, dy) &amp;&amp;</div><div class="line">                            tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                saveLastMotion(ev);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å½“å¤šä¸ªæ‰‹æŒ‡ä¸­çš„ä¸€ä¸ªæ‰‹æœºæ¾å¼€æ—¶</span></div><div class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pointerId = MotionEventCompat.getPointerId(ev, actionIndex);</div><div class="line">            <span class="comment">//å¦‚æœå½“å‰ç‚¹æ­£åœ¨è¢«æ‹–æ‹½,åˆ™å†å‰©ä½™è¿˜åœ¨è§¦æ‘¸çš„ç‚¹é’Ÿå¯»æ‰¾æ˜¯å¦æ­£åœ¨Viewä¸Š</span></div><div class="line">            <span class="keyword">if</span> (mDragState == STATE_DRAGGING &amp;&amp; pointerId == mActivePointerId) &#123;</div><div class="line">                <span class="comment">// Try to find another pointer that's still holding on to the captured view.</span></div><div class="line">                <span class="keyword">int</span> newActivePointer = INVALID_POINTER;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = MotionEventCompat.getPointerCount(ev);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> id = MotionEventCompat.getPointerId(ev, i);</div><div class="line">                    <span class="keyword">if</span> (id == mActivePointerId) &#123;</div><div class="line">                        <span class="comment">// This one's going away, skip.</span></div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(ev, i);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, i);</div><div class="line">                    <span class="keyword">if</span> (findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y) == mCapturedView &amp;&amp;</div><div class="line">                            tryCaptureViewForDrag(mCapturedView, id)) &#123;</div><div class="line">                        newActivePointer = mActivePointerId;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (newActivePointer == INVALID_POINTER) &#123;</div><div class="line">                    <span class="comment">// We didn't find another pointer still touching the view, release it.</span></div><div class="line">                    <span class="comment">//å¦‚æœæ²¡æ‰¾åˆ°åˆ™é‡Šæ”¾View</span></div><div class="line">                    <span class="comment">//TODO (6)</span></div><div class="line">                    releaseViewForPointerUp();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            clearMotionHistory(pointerId);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">            <span class="comment">//å¦‚æœæ˜¯æ‹–æ‹½çŠ¶æ€çš„é‡Šæ”¾åˆ™è°ƒç”¨</span></div><div class="line">            <span class="comment">//releaseViewForPointerUp()</span></div><div class="line">            <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                releaseViewForPointerUp();</div><div class="line">            &#125;</div><div class="line">            cancel();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">            <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                dispatchViewReleased(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            cancel();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢å°±æ˜¯<code>processTouchEvent()</code>æ–¹æ³•çš„å®ç°,æˆ‘ä»¬çœå»äº†éƒ¨åˆ†å¤§è‡´ä¸<code>shouldInterceptTouchEvent()</code>ç›¸åŒçš„é€»è¾‘ä»£ç ,é€šè¿‡äº‹ä»¶ä¼ é€’æœºåˆ¶æˆ‘ä»¬çŸ¥é“,å¦‚æœç¨‹åºå·²ç»è¿›å…¥åˆ°<code>processTouchEvent()</code>ä¸­,ä¹Ÿå°±æ„å‘³ç€è§¦æ‘¸äº‹ä»¶å°±ä¸ä¼šå†å‘ä¸‹ä¼ é€’,éƒ½ä¼šäº¤ç»™æ­¤æ–¹æ³•å¤„ç†,æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦å¤„ç†æ‹–æ‹½äº‹ä»¶äº†,é€šè¿‡ä¸Šé¢çš„æ³¨é‡Š,æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†åœ¨<code>MotionEvent.ACTION_MOVE</code>,<code>MotionEventCompat.ACTION_POINTER_UP</code>,<code>MotionEvent.ACTION_UP</code>å’Œ<code>MotionEvent.ACTION_CANCEL</code>éƒ½åˆ†åˆ«è¿›è¡Œäº†å¤„ç†    ,æˆ‘ä»¬çŸ¥é“è§¦æ‘¸äº‹ä»¶å¤§è‡´çš„æµç¨‹æ˜¯:</p>
<pre><code>ACTION_DOWN -&gt; ACTION_MOVE -&gt; ... -&gt; ACTION_MOVE -&gt; ACTION_UP
</code></pre><p>å†é…åˆäº‹ä»¶çš„åˆ†å‘æœºåˆ¶,æˆ‘ä»¬å°±èƒ½å¾ˆæ¸…æ™°çš„åˆ†æå‡ºä¸€æ¬¡å®Œæ•´çš„äº‹ä»¶è°ƒç”¨è¿‡ç¨‹,æ‰€ä»¥æ•´ä¸ª<code>ViewDragHelper</code>çš„æ‹–æ‹½è¿‡ç¨‹ä¹Ÿèƒ½å¾ˆæ¸…æ™°çš„åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤:</p>
<pre><code>æ•è·æ‹–æ‹½ç›®æ ‡View -&gt; æ‹–æ‹½ç›®æ ‡View -&gt; å¤„ç†ç›®æ ‡Viewé‡Šæ”¾æ“ä½œ
</code></pre><p>æœ€åæˆ‘ä»¬å†åˆ†æä¸Šé¢ä¸¤æ®µä»£ç çš„6ä¸ªTODO:</p>
<h4 id="4-4-saveInitialMotion-æ–¹æ³•"><a href="#4-4-saveInitialMotion-æ–¹æ³•" class="headerlink" title="4.4 saveInitialMotion()æ–¹æ³•"></a>4.4 saveInitialMotion()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveInitialMotion</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">    <span class="comment">//ç¡®ä¿å„ä¸ªæ•°ç»„çš„å¤§å°è¶³å¤Ÿå­˜æ”¾æ•°æ®</span></div><div class="line">    ensureMotionHistorySizeForId(pointerId);</div><div class="line">    <span class="comment">//ä¿å­˜xåæ ‡</span></div><div class="line">    mInitialMotionX[pointerId] = mLastMotionX[pointerId] = x;</div><div class="line">    <span class="comment">//ä¿å­˜yåæ ‡</span></div><div class="line">    mInitialMotionY[pointerId] = mLastMotionY[pointerId] = y;</div><div class="line">    <span class="comment">//ä¿å­˜æ˜¯å¦è§¦æ‘¸åˆ°è¾¹ç¼˜</span></div><div class="line">    mInitialEdgesTouched[pointerId] = getEdgesTouched((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">    <span class="comment">//ä¿å­˜å½“å‰idæ˜¯å¦åœ¨è§¦æ‘¸,ç”¨äºåç»­éªŒè¯</span></div><div class="line">    mPointersDown |= <span class="number">1</span> &lt;&lt; pointerId;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-5-findTopChildUnder-æ–¹æ³•"><a href="#4-5-findTopChildUnder-æ–¹æ³•" class="headerlink" title="4.5 findTopChildUnder()æ–¹æ³•"></a>4.5 findTopChildUnder()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">findTopChildUnder</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = mParentView.getChildCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">final</span> View child = mParentView.getChildAt(mCallback.getOrderedChildIndex(i));</div><div class="line">        <span class="keyword">if</span> (x &gt;= child.getLeft() &amp;&amp; x &lt; child.getRight() &amp;&amp;</div><div class="line">                y &gt;= child.getTop() &amp;&amp; y &lt; child.getBottom()) &#123;</div><div class="line">            <span class="keyword">return</span> child;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆç®€å•å°±æ˜¯æ ¹æ®<code>x</code>å’Œ<code>y</code>åæ ‡å’Œæ¥æ‰¾åˆ°æŒ‡å®š<code>View</code>,æ³¨æ„è¿™é‡Œå›è°ƒäº†<code>callback</code>ä¸­çš„<code>getOrderedChildIndex()</code>æ–¹æ³•,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè¿”å›æŒ‡å®šçš„<code>View</code>çš„<code>index</code>.</p>
<h4 id="4-6-checkTouchSlop-æ–¹æ³•"><a href="#4-6-checkTouchSlop-æ–¹æ³•" class="headerlink" title="4.6 checkTouchSlop()æ–¹æ³•"></a>4.6 checkTouchSlop()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkTouchSlop</span><span class="params">(View child, <span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> checkHorizontal = mCallback.getViewHorizontalDragRange(child) &gt; <span class="number">0</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> checkVertical = mCallback.getViewVerticalDragRange(child) &gt; <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (checkHorizontal &amp;&amp; checkVertical) &#123;</div><div class="line">        <span class="keyword">return</span> dx * dx + dy * dy &gt; mTouchSlop * mTouchSlop;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (checkHorizontal) &#123;</div><div class="line">        <span class="keyword">return</span> Math.abs(dx) &gt; mTouchSlop;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (checkVertical) &#123;</div><div class="line">        <span class="keyword">return</span> Math.abs(dy) &gt; mTouchSlop;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”¨æ¥æ ¹æ®<code>mTouchSlop</code>æœ€å°æ‹–åŠ¨çš„è·ç¦»æ¥åˆ¤æ–­æ˜¯å¦å±äºæ‹–åŠ¨,<code>mTouchSlop</code>æ ¹æ®æˆ‘ä»¬è®¾å®šçš„çµæ•åº¦å†³å®š.</p>
<h4 id="4-7-tryCaptureViewForDrag-æ–¹æ³•"><a href="#4-7-tryCaptureViewForDrag-æ–¹æ³•" class="headerlink" title="4.7 tryCaptureViewForDrag()æ–¹æ³•"></a>4.7 tryCaptureViewForDrag()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryCaptureViewForDrag</span><span class="params">(View toCapture, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">    <span class="comment">//å¦‚æœå·²ç»æ•è·è¯¥View ç›´æ¥è¿”å›true</span></div><div class="line">    <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mActivePointerId == pointerId) &#123;</div><div class="line">        <span class="comment">// Already done!</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ ¹æ®mCallback.tryCaptureView()æ–¹æ³•æ¥æœ€ç»ˆå†³å®šæ˜¯å¦å¯ä»¥æ•è·View</span></div><div class="line">    <span class="keyword">if</span> (toCapture != <span class="keyword">null</span> &amp;&amp; mCallback.tryCaptureView(toCapture, pointerId)) &#123;</div><div class="line">        mActivePointerId = pointerId;</div><div class="line">        <span class="comment">//å¦‚æœå¯ä»¥åˆ™è°ƒç”¨captureChildView(),å¹¶è¿”å›true</span></div><div class="line">        captureChildView(toCapture, pointerId);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å¦‚æœå¯ä»¥æ•è·<code>View</code>åˆ™è°ƒç”¨äº†<code>captureChildView()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureChildView</span><span class="params">(View childView, <span class="keyword">int</span> activePointerId)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (childView.getParent() != mParentView) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"captureChildView: parameter must be a descendant "</span> +</div><div class="line">                <span class="string">"of the ViewDragHelper's tracked parent view ("</span> + mParentView + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//èµ‹å€¼mCapturedView</span></div><div class="line">    mCapturedView = childView;</div><div class="line">    mActivePointerId = activePointerId;</div><div class="line">    <span class="comment">//å›è°ƒcallback</span></div><div class="line">    mCallback.onViewCaptured(childView, activePointerId);</div><div class="line">    <span class="comment">//è®¾å®šmDragStateçš„çŠ¶æ€ä¸ºSTATE_DRAGGING</span></div><div class="line">    setDragState(STATE_DRAGGING);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œ,å°±è¯æ˜<code>View</code>å·²ç»å¤„äºæ‹–æ‹½çŠ¶æ€äº†,åç»­çš„è§¦æ‘¸æ“ä½œ,å°†ç›´æ¥æ ¹æ®<code>mDragState</code>ä¸º<code>STATE_DRAGGING</code>çš„çŠ¶æ€å¤„ç†.</p>
<h4 id="4-8-dragTo-æ–¹æ³•çš„å®ç°"><a href="#4-8-dragTo-æ–¹æ³•çš„å®ç°" class="headerlink" title="4.8 dragTo()æ–¹æ³•çš„å®ç°"></a>4.8 dragTo()æ–¹æ³•çš„å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dragTo</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> clampedX = left;</div><div class="line">    <span class="keyword">int</span> clampedY = top;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = mCapturedView.getLeft();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldTop = mCapturedView.getTop();</div><div class="line">    <span class="keyword">if</span> (dx != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//å›è°ƒcallbackæ¥å†³å®šViewæœ€ç»ˆè¢«æ‹–æ‹½çš„xæ–¹å‘ä¸Šçš„åç§»é‡</span></div><div class="line">        clampedX = mCallback.clampViewPositionHorizontal(mCapturedView, left, dx);</div><div class="line">        <span class="comment">//ç§»åŠ¨View</span></div><div class="line">        ViewCompat.offsetLeftAndRight(mCapturedView, clampedX - oldLeft);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (dy != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//å›è°ƒcallbackæ¥å†³å®šViewæœ€ç»ˆè¢«æ‹–æ‹½çš„yæ–¹å‘ä¸Šçš„åç§»é‡</span></div><div class="line">        clampedY = mCallback.clampViewPositionVertical(mCapturedView, top, dy);</div><div class="line">        <span class="comment">//ç§»åŠ¨View</span></div><div class="line">        ViewCompat.offsetTopAndBottom(mCapturedView, clampedY - oldTop);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (dx != <span class="number">0</span> || dy != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> clampedDx = clampedX - oldLeft;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> clampedDy = clampedY - oldTop;</div><div class="line">        <span class="comment">//å›è°ƒcallback</span></div><div class="line">        mCallback.onViewPositionChanged(mCapturedView, clampedX, clampedY,</div><div class="line">                clampedDx, clampedDy);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› ä¸º<code>dragTo()</code>æ–¹æ³•æ˜¯åœ¨<code>processTouchEvent()</code>ä¸­çš„<code>MotionEvent.ACTION_MOVE case</code>è¢«è°ƒç”¨æ‰€ä»¥å½“ç¨‹åºè¿è¡Œåˆ°è¿™é‡Œæ—¶<code>View</code>å°±ä¼šä¸æ–­çš„è¢«æ‹–åŠ¨äº†ã€‚å¦‚æœä¸€æ—¦æ‰‹æŒ‡é‡Šæ”¾åˆ™æœ€ç»ˆä¼šè°ƒç”¨<code>releaseViewForPointerUp()</code>æ–¹æ³•</p>
<h4 id="4-8-releaseViewForPointerUp-æ–¹æ³•çš„å®ç°"><a href="#4-8-releaseViewForPointerUp-æ–¹æ³•çš„å®ç°" class="headerlink" title="4.8 releaseViewForPointerUp()æ–¹æ³•çš„å®ç°"></a>4.8 releaseViewForPointerUp()æ–¹æ³•çš„å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseViewForPointerUp</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//è®¡ç®—å‡ºå½“å‰xå’Œyæ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦</span></div><div class="line">    mVelocityTracker.computeCurrentVelocity(<span class="number">1000</span>, mMaxVelocity);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> xvel = clampMag(</div><div class="line">            VelocityTrackerCompat.getXVelocity(mVelocityTracker, mActivePointerId),</div><div class="line">            mMinVelocity, mMaxVelocity);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> yvel = clampMag(</div><div class="line">            VelocityTrackerCompat.getYVelocity(mVelocityTracker, mActivePointerId),</div><div class="line">            mMinVelocity, mMaxVelocity);</div><div class="line">    dispatchViewReleased(xvel, yvel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¡ç®—å®ŒåŠ é€Ÿåº¦åå°±è°ƒç”¨äº†<code>dispatchViewReleased()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchViewReleased</span><span class="params">(<span class="keyword">float</span> xvel, <span class="keyword">float</span> yvel)</span> </span>&#123;</div><div class="line">    <span class="comment">//è®¾å®šå½“å‰æ­£å¤„äºé‡Šæ”¾é˜¶æ®µ</span></div><div class="line">    mReleaseInProgress = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">//å›è°ƒcallbackçš„onViewReleased()æ–¹æ³•</span></div><div class="line">    mCallback.onViewReleased(mCapturedView, xvel, yvel);</div><div class="line">    mReleaseInProgress = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//è®¾å®šçŠ¶æ€</span></div><div class="line">    <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">        <span class="comment">// onViewReleased didn't call a method that would have changed this. Go idle.</span></div><div class="line">        <span class="comment">//å¦‚æœonViewReleased()ä¸­æ²¡æœ‰è°ƒç”¨ä»»ä½•æ–¹æ³•,åˆ™çŠ¶æ€è®¾å®šä¸ºSTATE_IDLE</span></div><div class="line">        setDragState(STATE_IDLE);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥æœ€åé‡Šæ”¾åçš„å¤„ç†äº¤ç»™äº†<code>callback</code>ä¸­çš„<code>onViewReleased()</code>æ–¹æ³•,å¦‚æœæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åš,é‚£ä¹ˆè¿™ä¸ªè¢«æ‹–æ‹½çš„<code>View</code>å°±æ˜¯åœæ­¢åœ¨å½“å‰ä½ç½®,æˆ–è€…æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>ViewDragHelper</code>æä¾›ç»™æˆ‘ä»¬çš„è¿™å‡ ä¸ªæ–¹æ³•:</p>
<ul>
<li>settleCapturedViewAt(int finalLeft, int finalTop)<br>ä»¥æ¾æ‰‹å‰çš„æ»‘åŠ¨é€Ÿåº¦ä¸ºåˆé€ŸåŠ¨ï¼Œè®©æ•è·åˆ°çš„Viewè‡ªåŠ¨æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚åªèƒ½åœ¨Callbackçš„onViewReleased()ä¸­è°ƒç”¨ã€‚</li>
<li>flingCapturedView(int minLeft, int minTop, int maxLeft, int maxTop)<br>ä»¥æ¾æ‰‹å‰çš„æ»‘åŠ¨é€Ÿåº¦ä¸ºåˆé€ŸåŠ¨ï¼Œè®©æ•è·åˆ°çš„Viewåœ¨æŒ‡å®šèŒƒå›´å†…flingã€‚åªèƒ½åœ¨Callbackçš„onViewReleased()ä¸­è°ƒç”¨ã€‚</li>
<li>smoothSlideViewTo(View child, int finalLeft, int finalTop)<br>æŒ‡å®šæŸä¸ªViewè‡ªåŠ¨æ»šåŠ¨åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œåˆé€Ÿåº¦ä¸º0ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
</ul>
<p>å¼•ç”¨è‡ª<a href="http://www.cnphp6.com/archives/87727" target="_blank" rel="external">è¿™ç¯‡æ–‡ç« </a>,å…·ä½“é‡Šæ”¾åçš„åŸç†æˆ‘ä»¬å°±ä¸åˆ†æäº†,å…¶å®å°±æ˜¯é…åˆ<code>Scroller</code>è¿™ä¸ªç±»æ¥å®ç°,å…·ä½“ä¹Ÿå¯ä»¥å‚ç…§ä¸Šé¢è¿™ç¯‡æ–‡ç« ã€‚å¥½,æˆ‘ä»¬å…³äº<code>ViewDragHelper</code>çš„æºç åˆ†æå°±åˆ°è¿™é‡Œ.</p>
<h3 id="5-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"><a href="#5-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨" class="headerlink" title="5. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"></a>5. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨</h3><p><code>ViewDragHelper</code>åœ¨å„ç§å…³äºæ‹–æ‹½å’Œå„ç§æ‰‹åŠ¿åŠ¨ç”»çš„å¼€æºåº“ä¸­ä½¿ç”¨å¹¿æ³›,æˆ‘è¿™é‡Œå°±ç®€è¦åˆ—å‡ºä¸€äº›,å¤§å®¶å¯ä»¥å¤šå»çœ‹çœ‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>ViewDragHelper</code>çš„:</p>
<ul>
<li><a href="https://github.com/ikew0ng/SwipeBackLayout" target="_blank" rel="external">SwipeBackLayout</a></li>
<li><a href="https://github.com/xmuSistone/android-card-slide-panel" target="_blank" rel="external">android-card-slide-panel</a></li>
<li><a href="https://github.com/mxn21/FlowingDrawer" target="_blank" rel="external">FlowingDrawer</a></li>
</ul>
<h3 id="6-ä¸ªäººè¯„ä»·"><a href="#6-ä¸ªäººè¯„ä»·" class="headerlink" title="6. ä¸ªäººè¯„ä»·"></a>6. ä¸ªäººè¯„ä»·</h3><p><code>ViewDragHelper</code>çš„å‡ºç°,å¤§å¤§ç®€åŒ–äº†æˆ‘ä»¬å¼€å‘ç›¸å…³è§¦æ‘¸å’Œæ‹–æ‹½åŠŸèƒ½çš„å¤æ‚åº¦å’Œä»£ç é‡,å¸®åŠ©æˆ‘ä»¬æ¯”è¾ƒå®¹æ˜“çš„å®ç°å„ç§æ•ˆæœ,è®©æˆ‘ä»¬å¼€å‘é…·ç‚«çš„äº¤äº’æ›´åŠ å®¹æ˜“äº†ã€‚ä½†æ˜¯ä»ä¸€äº›å¼€æºé¡¹ç›®ä¸­å‘ç°,<code>ViewDragHelper</code>ä¸­è¿˜æ˜¯æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„,æ¯”å¦‚ç»™<code>Scroller</code>æä¾›äº†ä¸€ä¸ªå›ºå®šçš„<code>Interpolator</code>,å¯¼è‡´å¦‚æœæˆ‘ä»¬æƒ³å®ç°ä¾‹å¦‚åå¼¹æ•ˆæœçš„è¯,è¿˜è¦æŠŠ<code>ViewDragHelper</code>çš„ä»£ç æ‹·è´ä¸€ä»½å¹¶ä¿®æ”¹<code>Interpolator</code>,è¿™æ ·åšè‚¯å®šæ˜¯ä¸å¤ªå¥½çš„.å½“ç„¶å»ºè®®æˆ‘ä»¬è‡ªå·±ä¿®æ”¹ä¸€ä¸ª<code>ViewDragHelper</code>åå¦‚æœé¡¹ç›®é‡Œæœ‰å¤šå¤„ä½¿ç”¨,å¯ä»¥åŒ…è£…æˆä¸€ä¸ªæä¾›ç»™æˆ‘ä»¬è‡ªå·±é¡¹ç›®çš„æ¨¡å—ä½¿ç”¨,é˜²æ­¢å‡ºç°æ›´å¤šçš„å¤šä½™ä»£ç </p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>TextViewæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/TextView%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/TextViewæºç è§£æ/</id>
    <published>2017-07-26T12:07:19.000Z</published>
    <updated>2017-07-26T12:07:37.007Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h1 id="TextViewæºç è§£æ"><a href="#TextViewæºç è§£æ" class="headerlink" title="TextViewæºç è§£æ"></a>TextViewæºç è§£æ</h1><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h2><blockquote>
<p>TextViewä½œä¸ºAndroidç³»ç»Ÿä¸Šæ˜¾ç¤ºå’Œæ’ç‰ˆæ–‡å­—ä»¥åŠæä¾›å¯¹æ–‡å­—çš„å¢åˆ æ”¹æŸ¥ã€å›¾æ–‡æ··æ’ç­‰åŠŸèƒ½çš„æ§ä»¶ï¼Œå†…éƒ¨æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤æ‚çš„ã€‚è¿™ä¹ˆä¸€ä¸ªå¤æ‚çš„æ§ä»¶è‡ªç„¶éœ€è¦ä¾èµ–äºä¸€äº›å…¶ä»–çš„è¾…åŠ©ç±»ï¼Œä¾‹å¦‚ï¼šLayoutä»¥åŠLayoutçš„ç›¸å…³å­ç±»ã€Spanç›¸å…³çš„ç±»ã€MovementMethodæ¥å£ã€TransformationMethodæ¥å£ç­‰ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»TextViewçš„ç»“æ„å’Œå†…éƒ¨å¤„ç†æ–‡å­—çš„æµç¨‹ä»¥åŠTextViewç›¸å…³çš„è¾…åŠ©ç±»åœ¨TextViewå¤„ç†æ–‡å­—è¿‡ç¨‹ä¸­çš„ä½œç”¨ã€‚</p>
</blockquote>
<h2 id="2-TextViewçš„å†…éƒ¨ç»“æ„å’Œè¾…åŠ©ç±»"><a href="#2-TextViewçš„å†…éƒ¨ç»“æ„å’Œè¾…åŠ©ç±»" class="headerlink" title="2.TextViewçš„å†…éƒ¨ç»“æ„å’Œè¾…åŠ©ç±»"></a>2.TextViewçš„å†…éƒ¨ç»“æ„å’Œè¾…åŠ©ç±»</h2><p>TextViewå†…éƒ¨é™¤äº†ç»§æ‰¿è‡ªViewçš„ç›¸å…³å±æ€§å’Œmeasureã€layoutã€drawæ­¥éª¤ï¼Œè¿˜åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>Layout</strong>: TextViewçš„æ–‡å­—æ’ç‰ˆã€æŠ˜è¡Œç­–ç•¥ä»¥åŠæ–‡æœ¬ç»˜åˆ¶éƒ½æ˜¯åœ¨Layouté‡Œé¢å®Œæˆçš„ï¼ŒTextViewçš„è‡ªèº«æµ‹é‡ä¹Ÿå—Layoutçš„å½±å“ã€‚Layoutæ˜¯TextViewæ‰§è¡ŒsetTextæ–¹æ³•åï¼Œç”±TextViewå†…éƒ¨åˆ›å»ºçš„å®ä¾‹ï¼Œå¹¶ä¸èƒ½ç”±å¤–éƒ¨æä¾›ã€‚å¯ä»¥ç”¨getLayout()æ–¹æ³•è·å–ã€‚</li>
<li><strong>TransformationMethod</strong>: ç”¨æ¥å¤„ç†æœ€ç»ˆçš„æ˜¾ç¤ºç»“æœçš„ç±»ï¼Œä¾‹å¦‚æ˜¾ç¤ºå¯†ç çš„æ—¶å€™æŠŠå¯†ç è½¬æ¢æˆåœ†ç‚¹ã€‚è¿™ä¸ªç±»å¹¶ä¸ç›´æ¥å½±å“TextViewå†…éƒ¨å‚¨å­˜çš„Textï¼Œåªå½±å“æ˜¾ç¤ºçš„ç»“æœã€‚</li>
<li><strong>MovementMethod</strong>: ç”¨æ¥å¤„ç†TextViewå†…éƒ¨äº‹ä»¶å“åº”çš„ç±»ï¼Œå¯ä»¥é’ˆå¯¹TextViewå†…æ–‡æœ¬çš„æŸä¸€ä¸ªåŒºåŸŸåšè½¯é”®ç›˜è¾“å…¥æˆ–è€…è§¦æ‘¸äº‹ä»¶çš„å“åº”ã€‚</li>
<li><strong>Drawables</strong>: TextViewçš„é™æ€å†…éƒ¨ç±»ï¼Œç”¨æ¥å¤„ç†å’Œå‚¨å­˜TextViewçš„CompoundDrawables,åŒ…æ‹¬TextViewçš„ä¸Šä¸‹å·¦å³çš„Drawableä»¥åŠé”™è¯¯æç¤ºçš„Drawableã€‚</li>
<li><strong>Spans</strong>: Spanså¹¶ä¸æ˜¯ç‰¹å®šçš„æŸä¸€ä¸ªç±»æˆ–è€…å®ç°äº†æŸä¸€ä¸ªæ¥å£çš„ç±»ã€‚å®ƒå¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼ŒSpanså®é™…ä¸Šåšçš„äº‹æƒ…æ˜¯åœ¨TextViewçš„å†…éƒ¨çš„textçš„æŸä¸€ä¸ªåŒºåŸŸåšæ ‡è®°ã€‚å…¶ä¸­æœ‰éƒ¨åˆ†Spanså¯ä»¥å½±å“TextViewçš„ç»˜åˆ¶å’Œæµ‹é‡ï¼Œå¦‚ImageSpanã€BackgroundColorSpanã€AbsoluteSizeSpanã€‚è¿˜æœ‰å¯ä»¥å“åº”ç‚¹å‡»äº‹ä»¶çš„ClickableSpanã€‚</li>
<li><strong>Editor</strong>: TextViewä½œä¸ºå¯ç¼–è¾‘æ–‡æœ¬æ§ä»¶çš„æ—¶å€™(EditText)ï¼Œä½¿ç”¨Editoræ¥å¤„ç†æ–‡æœ¬çš„åŒºåŸŸé€‰æ‹©å¤„ç†å’Œåˆ¤æ–­ã€æ‹¼å†™æ£€æŸ¥ã€å¼¹å‡ºæ–‡æœ¬èœå•ç­‰ã€‚</li>
<li><strong>InputConnection</strong>: EditTextçš„æ–‡æœ¬è¾“å…¥éƒ¨åˆ†æ˜¯åœ¨TextViewä¸­å®Œæˆçš„ã€‚è€ŒInputConnectionæ˜¯è½¯é”®ç›˜å’ŒTextViewä¹‹é—´çš„æ¡¥æ¢ï¼Œæ‰€æœ‰çš„è½¯é”®ç›˜çš„è¾“å…¥æ–‡å­—ã€ä¿®æ”¹æ–‡å­—å’Œåˆ é™¤æ–‡å­—éƒ½æ˜¯é€šè¿‡InputConnectionä¼ é€’ç»™TextViewçš„ã€‚</li>
</ul>
<h2 id="3-TextViewçš„onTouchEventå¤„ç†"><a href="#3-TextViewçš„onTouchEventå¤„ç†" class="headerlink" title="3.TextViewçš„onTouchEventå¤„ç†"></a>3.TextViewçš„onTouchEventå¤„ç†</h2><p>TextViewå†…éƒ¨èƒ½å¤„ç†è§¦æ‘¸äº‹ä»¶çš„ï¼ŒåŒ…æ‹¬è‡ªèº«çš„è§¦æ‘¸å¤„ç†ã€Editorçš„onTouchEventã€MovementMethodçš„onTouchEventã€‚Editorçš„onTouchEventä¸»è¦å¤„ç†å‡ºäºç¼–è¾‘çŠ¶æ€ä¸‹çš„è§¦æ‘¸äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»é€‰ä¸­ã€é•¿æŒ‰ç­‰ã€‚MovementMethodåˆ™ä¸»è¦è´Ÿè´£æ–‡æœ¬å†…éƒ¨æœ‰Spançš„æ—¶å€™çš„ç›¸å…³å¤„ç†ï¼Œæ¯”è¾ƒå¸¸è§çš„å°±æ˜¯LinkMovementMethodå¤„ç†ClickableSpançš„ç‚¹å‡»äº‹ä»¶ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TextViewå†…éƒ¨å¯¹è¿™äº›è§¦æ‘¸äº‹ä»¶çš„å¤„ç†å’Œä¼˜å…ˆçº§çš„åˆ†é…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> action = event.getActionMasked();</div><div class="line"></div><div class="line">        <span class="comment">//å½“Editorä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œç»™Editorçš„åŒå‡»äº‹ä»¶é¢„è®¾å€¼</span></div><div class="line">        <span class="keyword">if</span> (mEditor != <span class="keyword">null</span> &amp;&amp; action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            <span class="keyword">if</span> (mFirstTouch &amp;&amp; (SystemClock.uptimeMillis() - mLastTouchUpTime) &lt;=</div><div class="line">                    ViewConfiguration.getDoubleTapTimeout()) &#123;</div><div class="line">                mEditor.mDoubleTap = <span class="keyword">true</span>;</div><div class="line">                mFirstTouch = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mEditor.mDoubleTap = <span class="keyword">false</span>;</div><div class="line">                mFirstTouch = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP) &#123;</div><div class="line">            mLastTouchUpTime = SystemClock.uptimeMillis();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å½“Editorä¸ä¸ºç©ºï¼Œä¼˜å…ˆå¤„ç†Editorçš„è§¦æ‘¸äº‹ä»¶</span></div><div class="line">        <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</div><div class="line">            mEditor.onTouchEvent(event);</div><div class="line"></div><div class="line">            <span class="comment">//ç”±äºEditorå†…éƒ¨onTouchEventå®é™…ä¸Šäº¤ç»™äº†mSelectionModifierCursorControllerå¤„ç†ï¼Œæ‰€ä»¥è¿™è¾¹åˆ¤æ–­mSelectionModifierCursorControlleræ˜¯å¦éœ€è¦å¤„ç†æ¥ä¸‹æ¥çš„ä¸€ç³»åˆ—äº‹ä»¶ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›è·³è¿‡ä¸‹é¢çš„æ­¥éª¤</span></div><div class="line">            <span class="keyword">if</span> (mEditor.mSelectionModifierCursorController != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                    mEditor.mSelectionModifierCursorController.isDragAcceleratorActive()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> superResult = <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line"></div><div class="line">        <span class="comment">//å¤„ç†API 23æ–°åŠ å…¥çš„InsertionActinoMode</span></div><div class="line">        <span class="keyword">if</span> (mEditor != <span class="keyword">null</span> &amp;&amp; mEditor.mDiscardNextActionUp &amp;&amp; action == MotionEvent.ACTION_UP) &#123;</div><div class="line">            mEditor.mDiscardNextActionUp = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mEditor.mIsInsertionActionModeStartPending) &#123;</div><div class="line">                mEditor.startInsertionActionMode();</div><div class="line">                mEditor.mIsInsertionActionModeStartPending = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> superResult;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> touchIsFinished = (action == MotionEvent.ACTION_UP) &amp;&amp;</div><div class="line">                (mEditor == <span class="keyword">null</span> || !mEditor.mIgnoreActionUpEvent) &amp;&amp; isFocused();</div><div class="line"></div><div class="line">         <span class="keyword">if</span> ((mMovement != <span class="keyword">null</span> || onCheckIsTextEditor()) &amp;&amp; isEnabled()</div><div class="line">                &amp;&amp; mText <span class="keyword">instanceof</span> Spannable &amp;&amp; mLayout != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="comment">//MovementMethodçš„è§¦æ‘¸æ—¶é—´å¤„ç†ï¼Œå¦‚æœMovementMethodç±»å‹æ˜¯LinkMovementMethodåˆ™ä¼šå¤„ç†æ–‡æœ¬å†…çš„æ‰€æœ‰ClickableSpançš„ç‚¹å‡»</span></div><div class="line">            <span class="keyword">if</span> (mMovement != <span class="keyword">null</span>) &#123;</div><div class="line">                handled |= mMovement.onTouchEvent(<span class="keyword">this</span>, (Spannable) mText, event);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> textIsSelectable = isTextSelectable();</div><div class="line">            <span class="keyword">if</span> (touchIsFinished &amp;&amp; mLinksClickable &amp;&amp; mAutoLinkMask != <span class="number">0</span> &amp;&amp; textIsSelectable) &#123;</div><div class="line"></div><div class="line">                <span class="comment">//åœ¨æ–‡æœ¬å¯é€‰æ‹©çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰LinkMovementMethodæ¥å¤„ç†ClickableSpanç›¸å…³çš„ç‚¹å‡»çš„ï¼Œæ‰€ä»¥åœ¨æ–‡æœ¬å¯é€‰æ‹©æƒ…å†µï¼ŒTextViewå¯¹æ‰€æœ‰çš„ClickableSpanè¿›è¡Œç»Ÿä¸€å¤„ç†</span></div><div class="line">                ClickableSpan[] links = ((Spannable) mText).getSpans(getSelectionStart(),</div><div class="line">                        getSelectionEnd(), ClickableSpan.class);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (links.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                    links[<span class="number">0</span>].onClick(<span class="keyword">this</span>);</div><div class="line">                    handled = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (touchIsFinished &amp;&amp; (isTextEditable() || textIsSelectable)) &#123;</div><div class="line">                <span class="keyword">final</span> InputMethodManager imm = InputMethodManager.peekInstance();</div><div class="line">                viewClicked(imm);</div><div class="line">                <span class="keyword">if</span> (!textIsSelectable &amp;&amp; mEditor.mShowSoftInputOnFocus) &#123;</div><div class="line">                    handled |= imm != <span class="keyword">null</span> &amp;&amp; imm.showSoftInput(<span class="keyword">this</span>, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                mEditor.onTouchUpEvent(event);</div><div class="line"></div><div class="line">                handled = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (handled) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> superResult;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="4-TextViewçš„åˆ›å»ºLayoutçš„è¿‡ç¨‹"><a href="#4-TextViewçš„åˆ›å»ºLayoutçš„è¿‡ç¨‹" class="headerlink" title="4.TextViewçš„åˆ›å»ºLayoutçš„è¿‡ç¨‹"></a>4.TextViewçš„åˆ›å»ºLayoutçš„è¿‡ç¨‹</h2><p>TextViewå†…éƒ¨å¹¶ä¸ä»…ä»…åªæœ‰ä¸€ä¸ªç”¨æ¥æ˜¾ç¤ºæ–‡æœ¬å†…å®¹çš„Layoutï¼Œåœ¨è®¾ç½®äº†hintçš„æ—¶å€™ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªmHintLayoutæ¥å¤„ç†hintçš„å†…å®¹ã€‚å¦‚æœè®¾ç½®äº†Ellipsizeç±»å‹ä¸ºMarqueeæ—¶ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªmSavedMarqueeModeLayoutä¸“é—¨ç”¨æ¥æ˜¾ç¤ºmarqueeæ•ˆæœã€‚è¿™äº›Layoutéƒ½æ˜¯é€šè¿‡å†…éƒ¨çš„makeNewLayoutæ–¹æ³•æ¥åˆ›å»ºçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">makeNewLayout</span><span class="params">(<span class="keyword">int</span> wantWidth, <span class="keyword">int</span> hintWidth</span></span></div><div class="line">                                 BoringLayout.Metrics boring,</div><div class="line">                                 BoringLayout.Metrics hintBoring,</div><div class="line">                                 <span class="keyword">int</span> ellipsisWidth, <span class="keyword">boolean</span> bringIntoView) &#123;</div><div class="line">        <span class="comment">//å¦‚æœå½“å‰æœ‰marqueeåŠ¨ç”»ï¼Œåˆ™å…ˆåœæ­¢åŠ¨ç”»</span></div><div class="line">        stopMarquee();</div><div class="line"></div><div class="line">        mOldMaximum = mMaximum;</div><div class="line">        mOldMaxMode = mMaxMode;</div><div class="line"></div><div class="line">        mHighlightPathBogus = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (wantWidth &lt; <span class="number">0</span>) &#123;</div><div class="line">            wantWidth = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hintWidth &lt; <span class="number">0</span>) &#123;</div><div class="line">            hintWidth = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//æ–‡æœ¬å¯¹é½æ–¹å¼</span></div><div class="line">        Layout.Alignment alignment = getLayoutAlignment();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> testDirChange = mSingleLine &amp;&amp; mLayout != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            (alignment == Layout.Alignment.ALIGN_NORMAL ||</div><div class="line">             alignment == Layout.Alignment.ALIGN_OPPOSITE);</div><div class="line">        <span class="keyword">int</span> oldDir = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (testDirChange) oldDir = mLayout.getParagraphDirection(<span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">//æ£€æµ‹æ˜¯å¦è®¾ç½®äº†ellipsize</span></div><div class="line">        <span class="keyword">boolean</span> shouldEllipsize = mEllipsize != <span class="keyword">null</span> &amp;&amp; getKeyListener() == <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> switchEllipsize = mEllipsize == TruncateAt.MARQUEE &amp;&amp;</div><div class="line">                mMarqueeFadeMode != MARQUEE_FADE_NORMAL;</div><div class="line">        TruncateAt effectiveEllipsize = mEllipsize;</div><div class="line">        <span class="keyword">if</span> (mEllipsize == TruncateAt.MARQUEE &amp;&amp;</div><div class="line">                mMarqueeFadeMode == MARQUEE_FADE_SWITCH_SHOW_ELLIPSIS) &#123;</div><div class="line">            effectiveEllipsize = TruncateAt.END_SMALL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//æ–‡æœ¬æ–¹å‘</span></div><div class="line">        <span class="keyword">if</span> (mTextDir == <span class="keyword">null</span>) &#123;</div><div class="line">            mTextDir = getTextDirectionHeuristic();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ›å»ºä¸»Layout</span></div><div class="line">        mLayout = makeSingleLayout(wantWidth, boring, ellipsisWidth, alignment, shouldEllipsize,</div><div class="line">                effectiveEllipsize, effectiveEllipsize == mEllipsize);</div><div class="line"></div><div class="line">        <span class="comment">//éå¸¸è§„çš„Marqueeæ¨¡å¼ä¸‹ï¼Œéœ€è¦åˆ›å»ºmSavedMarqueeModeLayoutæ¥ä¿å­˜marqueeåŠ¨ç”»æ—¶æ‰€ç”¨çš„Layoutï¼Œå¹¶ä¸”åœ¨åŠ¨ç”»æœŸé—´æŠŠå®ƒå’ŒTextViewçš„ä¸»Layoutå¯¹æ¢</span></div><div class="line">        <span class="keyword">if</span> (switchEllipsize) &#123;</div><div class="line">            TruncateAt oppositeEllipsize = effectiveEllipsize == TruncateAt.MARQUEE ?</div><div class="line">                    TruncateAt.END : TruncateAt.MARQUEE;</div><div class="line">            mSavedMarqueeModeLayout = makeSingleLayout(wantWidth, boring, ellipsisWidth, alignment,</div><div class="line">                    shouldEllipsize, oppositeEllipsize, effectiveEllipsize != mEllipsize);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        shouldEllipsize = mEllipsize != <span class="keyword">null</span>;</div><div class="line">        mHintLayout = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºhintLayout</span></div><div class="line">        <span class="keyword">if</span> (mHint != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (shouldEllipsize) hintWidth = wantWidth;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (hintBoring == UNKNOWN_BORING) &#123;</div><div class="line">                hintBoring = BoringLayout.isBoring(mHint, mTextPaint, mTextDir,</div><div class="line">                                                   mHintBoring);</div><div class="line">                <span class="keyword">if</span> (hintBoring != <span class="keyword">null</span>) &#123;</div><div class="line">                    mHintBoring = hintBoring;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºboringï¼Œå¦‚æœæ˜¯åˆ™åˆ›å»ºBoringLayout</span></div><div class="line">            <span class="keyword">if</span> (hintBoring != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (hintBoring.width &lt;= hintWidth &amp;&amp;</div><div class="line">                    (!shouldEllipsize || hintBoring.width &lt;= ellipsisWidth)) &#123;</div><div class="line">                    <span class="keyword">if</span> (mSavedHintLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                        mHintLayout = mSavedHintLayout.</div><div class="line">                                replaceOrMake(mHint, mTextPaint,</div><div class="line">                                hintWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                hintBoring, mIncludePad);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        mHintLayout = BoringLayout.make(mHint, mTextPaint,</div><div class="line">                                hintWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                hintBoring, mIncludePad);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    mSavedHintLayout = (BoringLayout) mHintLayout;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldEllipsize &amp;&amp; hintBoring.width &lt;= hintWidth) &#123;</div><div class="line">                    <span class="keyword">if</span> (mSavedHintLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                        mHintLayout = mSavedHintLayout.</div><div class="line">                                replaceOrMake(mHint, mTextPaint,</div><div class="line">                                hintWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                hintBoring, mIncludePad, mEllipsize,</div><div class="line">                                ellipsisWidth);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        mHintLayout = BoringLayout.make(mHint, mTextPaint,</div><div class="line">                                hintWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                hintBoring, mIncludePad, mEllipsize,</div><div class="line">                                ellipsisWidth);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//ä¸æ˜¯boringçš„çŠ¶æ€ä¸‹ï¼Œç”¨StaticLayoutæ¥åˆ›å»º</span></div><div class="line">            <span class="keyword">if</span> (mHintLayout == <span class="keyword">null</span>) &#123;</div><div class="line">                StaticLayout.Builder builder = StaticLayout.Builder.obtain(mHint, <span class="number">0</span>,</div><div class="line">                        mHint.length(), mTextPaint, hintWidth)</div><div class="line">                        .setAlignment(alignment)</div><div class="line">                        .setTextDirection(mTextDir)</div><div class="line">                        .setLineSpacing(mSpacingAdd, mSpacingMult)</div><div class="line">                        .setIncludePad(mIncludePad)</div><div class="line">                        .setBreakStrategy(mBreakStrategy)</div><div class="line">                        .setHyphenationFrequency(mHyphenationFrequency);</div><div class="line">                <span class="keyword">if</span> (shouldEllipsize) &#123;</div><div class="line">                    builder.setEllipsize(mEllipsize)</div><div class="line">                            .setEllipsizedWidth(ellipsisWidth)</div><div class="line">                            .setMaxLines(mMaxMode == LINES ? mMaximum : Integer.MAX_VALUE);</div><div class="line">                &#125;</div><div class="line">                mHintLayout = builder.build();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bringIntoView || (testDirChange &amp;&amp; oldDir != mLayout.getParagraphDirection(<span class="number">0</span>))) &#123;</div><div class="line">            registerForPreDraw();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦å¼€å§‹MarqueeåŠ¨ç”»</span></div><div class="line">        <span class="keyword">if</span> (mEllipsize == TextUtils.TruncateAt.MARQUEE) &#123;</div><div class="line">            <span class="keyword">if</span> (!compressText(ellipsisWidth)) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> height = mLayoutParams.height;</div><div class="line">                <span class="keyword">if</span> (height != LayoutParams.WRAP_CONTENT &amp;&amp; height != LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                    startMarquee();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mRestartMarquee = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) mEditor.prepareCursorControllers();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>TextViewçš„å¸ƒå±€åˆ›å»ºè¿‡ç¨‹æ¶‰åŠåˆ°ä¸€ä¸ªboringçš„æ¦‚å¿µï¼Œboringæ˜¯æŒ‡å¸ƒå±€æ‰€ç”¨çš„æ–‡æœ¬é‡Œé¢ä¸åŒ…å«ä»»ä½•Spanï¼Œæ‰€æœ‰çš„æ–‡æœ¬æ–¹å‘éƒ½æ˜¯ä»å·¦åˆ°å³çš„å¸ƒå±€ï¼Œå¹¶ä¸”ä»…éœ€ä¸€è¡Œå°±èƒ½æ˜¾ç¤ºå®Œå…¨çš„å¸ƒå±€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒTextViewä¼šä½¿ç”¨BoringLayoutç±»æ¥åˆ›å»ºç›¸å…³çš„å¸ƒå±€ï¼Œä»¥èŠ‚çœä¸å¿…è¦çš„æ–‡æœ¬æµ‹é‡ä»¥åŠæ–‡æœ¬æŠ˜è¡Œã€Spanå®½åº¦ã€æ–‡æœ¬æ–¹å‘ç­‰çš„è®¡ç®—ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹makeNewLayoutä¸­ä½¿ç”¨é¢‘ç‡æ¯”è¾ƒé«˜çš„makeSingleLayoutçš„ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Layout <span class="title">makeSingleLayout</span><span class="params">(<span class="keyword">int</span> wantWidth, BoringLayout.Metrics boring, <span class="keyword">int</span> ellipsisWidth,</span></span></div><div class="line">            Layout.Alignment alignment, <span class="keyword">boolean</span> shouldEllipsize, TruncateAt effectiveEllipsize,</div><div class="line">            <span class="keyword">boolean</span> useSaved) &#123;</div><div class="line">        Layout result = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦Spannableï¼Œå¦‚æœæ˜¯åˆ™ç”¨DynamicLayoutç±»æ¥åˆ›å»ºå¸ƒå±€ï¼ŒDynamicLayoutå†…éƒ¨å®é™…ä¹Ÿæ˜¯ä½¿ç”¨StaticLayoutæ¥åšæ–‡æœ¬çš„æµ‹é‡ç»˜åˆ¶ï¼Œå¹¶åœ¨StaticLayoutçš„åŸºç¡€ä¸Šå¢åŠ äº†æ–‡æœ¬æˆ–è€…Spanæ”¹å˜æ—¶çš„ç›‘å¬ï¼ŒåŠæ—¶å¯¹æ–‡æœ¬æˆ–è€…Spançš„å˜åŒ–åšå‡ºååº”ã€‚</span></div><div class="line">        <span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Spannable) &#123;</div><div class="line">            result = <span class="keyword">new</span> DynamicLayout(mText, mTransformed, mTextPaint, wantWidth,</div><div class="line">                    alignment, mTextDir, mSpacingMult, mSpacingAdd, mIncludePad,</div><div class="line">                    mBreakStrategy, mHyphenationFrequency,</div><div class="line">                    getKeyListener() == <span class="keyword">null</span> ? effectiveEllipsize : <span class="keyword">null</span>, ellipsisWidth);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//å¦‚æœboringæ˜¯æœªçŸ¥çŠ¶æ€ï¼Œåˆ™é‡æ–°åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦boring</span></div><div class="line">            <span class="keyword">if</span> (boring == UNKNOWN_BORING) &#123;</div><div class="line">                boring = BoringLayout.isBoring(mTransformed, mTextPaint, mTextDir, mBoring);</div><div class="line">                <span class="keyword">if</span> (boring != <span class="keyword">null</span>) &#123;</div><div class="line">                    mBoring = boring;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//æ ¹æ®boringçš„å±æ€§æ¥åˆ›å»ºå¯¹åº”çš„å¸ƒå±€ï¼Œå¦‚æœæœ‰mSavedLayoutåˆ™ä»mSavedLayoutåˆ›å»º</span></div><div class="line">            <span class="keyword">if</span> (boring != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (boring.width &lt;= wantWidth &amp;&amp;</div><div class="line">                        (effectiveEllipsize == <span class="keyword">null</span> || boring.width &lt;= ellipsisWidth)) &#123;</div><div class="line">                    <span class="keyword">if</span> (useSaved &amp;&amp; mSavedLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">//ä»ä¹‹å‰ä¿å­˜çš„Layoutä¸­åˆ›å»º</span></div><div class="line">                        result = mSavedLayout.replaceOrMake(mTransformed, mTextPaint,</div><div class="line">                                wantWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                boring, mIncludePad);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">//åˆ›å»ºæ–°çš„Layout</span></div><div class="line">                        result = BoringLayout.make(mTransformed, mTextPaint,</div><div class="line">                                wantWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                boring, mIncludePad);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (useSaved) &#123;</div><div class="line">                        mSavedLayout = (BoringLayout) result;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldEllipsize &amp;&amp; boring.width &lt;= wantWidth) &#123;</div><div class="line">                    <span class="keyword">if</span> (useSaved &amp;&amp; mSavedLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                        result = mSavedLayout.replaceOrMake(mTransformed, mTextPaint,</div><div class="line">                                wantWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                boring, mIncludePad, effectiveEllipsize,</div><div class="line">                                ellipsisWidth);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        result = BoringLayout.make(mTransformed, mTextPaint,</div><div class="line">                                wantWidth, alignment, mSpacingMult, mSpacingAdd,</div><div class="line">                                boring, mIncludePad, effectiveEllipsize,</div><div class="line">                                ellipsisWidth);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰åˆ›å»ºBoringLayout, åˆ™ä½¿ç”¨StaticLayoutç±»æ¥åˆ›å»ºå¸ƒå±€</span></div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">            StaticLayout.Builder builder = StaticLayout.Builder.obtain(mTransformed,</div><div class="line">                    <span class="number">0</span>, mTransformed.length(), mTextPaint, wantWidth)</div><div class="line">                    .setAlignment(alignment)</div><div class="line">                    .setTextDirection(mTextDir)</div><div class="line">                    .setLineSpacing(mSpacingAdd, mSpacingMult)</div><div class="line">                    .setIncludePad(mIncludePad)</div><div class="line">                    .setBreakStrategy(mBreakStrategy)</div><div class="line">                    .setHyphenationFrequency(mHyphenationFrequency);</div><div class="line">            <span class="keyword">if</span> (shouldEllipsize) &#123;</div><div class="line">                builder.setEllipsize(effectiveEllipsize)</div><div class="line">                        .setEllipsizedWidth(ellipsisWidth)</div><div class="line">                        .setMaxLines(mMaxMode == LINES ? mMaximum : Integer.MAX_VALUE);</div><div class="line">            &#125;</div><div class="line">            result = builder.build();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="5-TextViewçš„æ–‡å­—å¤„ç†å’Œç»˜åˆ¶"><a href="#5-TextViewçš„æ–‡å­—å¤„ç†å’Œç»˜åˆ¶" class="headerlink" title="5.TextViewçš„æ–‡å­—å¤„ç†å’Œç»˜åˆ¶"></a>5.TextViewçš„æ–‡å­—å¤„ç†å’Œç»˜åˆ¶</h2><p>TextViewä¸»è¦çš„æ–‡å­—æ’ç‰ˆå’Œæ¸²æŸ“å¹¶ä¸æ˜¯åœ¨TextViewé‡Œé¢å®Œæˆçš„ï¼Œè€Œæ˜¯ç”±Layoutç±»æ¥å¤„ç†æ–‡å­—æ’ç‰ˆå·¥ä½œã€‚åœ¨å•çº¯åœ°ä½¿ç”¨TextViewæ¥å±•ç¤ºé™æ€æ–‡æœ¬çš„æ—¶å€™ï¼Œè¿™ä»¶äº‹æƒ…åˆ™æ˜¯ç”±Layoutçš„å­ç±»StaticLayoutæ¥å®Œæˆçš„ã€‚</p>
<p>StaticLayoutæ¥æ”¶åˆ°å­—ç¬¦ä¸²åï¼Œé¦–å…ˆåšçš„äº‹æƒ…æ˜¯æ ¹æ®å­—ç¬¦ä¸²é‡Œé¢çš„æ¢è¡Œç¬¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ‹†åˆ†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> paraStart = bufStart; paraStart &lt;= bufEnd; paraStart = paraEnd) &#123;</div><div class="line">            paraEnd = TextUtils.indexOf(source, CHAR_NEW_LINE, paraStart, bufEnd);</div><div class="line">            <span class="keyword">if</span> (paraEnd &lt; <span class="number">0</span>)</div><div class="line">                paraEnd = bufEnd;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                paraEnd++;</div></pre></td></tr></table></figure>
<p>æ‹†åˆ†åçš„æ®µè½(Paragraph)è¢«åˆ†é…ç»™è¾…åŠ©ç±»MeasuredTextè¿›è¡Œæµ‹é‡å¾—åˆ°æ¯ä¸ªå­—ç¬¦çš„å®½åº¦ä»¥åŠæ¯ä¸ªæ®µè½çš„FontMetricã€‚å¹¶é€šè¿‡LineBreakerè¿›è¡ŒæŠ˜è¡Œçš„åˆ¤æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æŠŠæ®µè½è½½å…¥åˆ°MeasuredTextä¸­ï¼Œå¹¶åˆ†é…å¯¹åº”çš„ç¼“å­˜ç©ºé—´</span></div><div class="line">measured.setPara(source, paraStart, paraEnd, textDir, b);</div><div class="line">            <span class="keyword">char</span>[] chs = measured.mChars;</div><div class="line">            <span class="keyword">float</span>[] widths = measured.mWidths;</div><div class="line">            <span class="keyword">byte</span>[] chdirs = measured.mLevels;</div><div class="line">            <span class="keyword">int</span> dir = measured.mDir;</div><div class="line">            <span class="keyword">boolean</span> easy = measured.mEasy;</div></pre></td></tr></table></figure>
<pre><code>//æŠŠç›¸å…³å±æ€§ä¼ ç»™JNIå±‚çš„LineBreaker
nSetupParagraph(b.mNativePtr, chs, paraEnd - paraStart,
        firstWidth, firstWidthLineCount, restWidth,
        variableTabStops, TAB_INCREMENT, b.mBreakStrategy, b.mHyphenationFrequency);
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int fmCacheCount = 0;</div><div class="line">int spanEndCacheCount = 0;</div><div class="line">for (int spanStart = paraStart, spanEnd; spanStart &lt; paraEnd; spanStart = spanEnd) &#123;</div><div class="line">    if (fmCacheCount * 4 &gt;= fmCache.length) &#123;</div><div class="line">        int[] grow = new int[fmCacheCount * 4 * 2];</div><div class="line">        System.arraycopy(fmCache, 0, grow, 0, fmCacheCount * 4);</div><div class="line">        fmCache = grow;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (spanEndCacheCount &gt;= spanEndCache.length) &#123;</div><div class="line">        int[] grow = new int[spanEndCacheCount * 2];</div><div class="line">        System.arraycopy(spanEndCache, 0, grow, 0, spanEndCacheCount);</div><div class="line">        spanEndCache = grow;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (spanned == null) &#123;</div><div class="line">        spanEnd = paraEnd;</div><div class="line">        int spanLen = spanEnd - spanStart;</div><div class="line">        //æ®µè½æ²¡æœ‰Spançš„æƒ…å†µä¸‹ï¼ŒæŠŠæ•´ä¸ªæ®µè½äº¤ç»™MeasuredTextè®¡ç®—æ¯ä¸ªå­—ç¬¦çš„å®½åº¦å’ŒFontMetric</div><div class="line">        measured.addStyleRun(paint, spanLen, fm);</div><div class="line">    &#125; else &#123;</div><div class="line">        spanEnd = spanned.nextSpanTransition(spanStart, paraEnd,</div><div class="line">                MetricAffectingSpan.class);</div><div class="line">        int spanLen = spanEnd - spanStart;</div><div class="line">        MetricAffectingSpan[] spans =</div><div class="line">                spanned.getSpans(spanStart, spanEnd, MetricAffectingSpan.class);</div><div class="line">        spans = TextUtils.removeEmptySpans(spans, spanned, MetricAffectingSpan.class);</div><div class="line">        //æŠŠå¯¹æ’ç‰ˆæœ‰å½±å“çš„Spanäº¤ç»™MeasuredTextæµ‹é‡å®½åº¦å¹¶è®¡ç®—FontMetric</div><div class="line">        measured.addStyleRun(paint, spans, spanLen, fm);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //æŠŠæµ‹é‡åçš„FontMetricç¼“å­˜ä¸‹æ¥æ–¹ä¾¿åé¢ä½¿ç”¨</div><div class="line">    fmCache[fmCacheCount * 4 + 0] = fm.top;</div><div class="line">    fmCache[fmCacheCount * 4 + 1] = fm.bottom;</div><div class="line">    fmCache[fmCacheCount * 4 + 2] = fm.ascent;</div><div class="line">    fmCache[fmCacheCount * 4 + 3] = fm.descent;</div><div class="line">    fmCacheCount++;</div><div class="line"></div><div class="line">    spanEndCache[spanEndCacheCount] = spanEnd;</div><div class="line">    spanEndCacheCount++;</div><div class="line">&#125;</div><div class="line"></div><div class="line">nGetWidths(b.mNativePtr, widths);</div><div class="line">//è®¡ç®—æ®µè½ä¸­éœ€è¦æŠ˜è¡Œçš„ä½ç½®ï¼Œå¹¶è¿”å›æŠ˜è¡Œçš„æ•°é‡</div><div class="line">int breakCount = nComputeLineBreaks(b.mNativePtr, lineBreaks, lineBreaks.breaks,</div><div class="line">        lineBreaks.widths, lineBreaks.flags, lineBreaks.breaks.length);</div></pre></td></tr></table></figure>
<p>è®¡ç®—å®Œæ¯ä¸€è¡Œçš„æµ‹é‡ç›¸å…³ä¿¡æ¯ã€Spanå®½é«˜ä»¥åŠæŠ˜è¡Œä½ç½®ï¼Œå°±å¯ä»¥å¼€å§‹æŒ‰ç…§æœ€ç»ˆçš„è¡Œæ•°ä¸€è¡Œä¸€è¡Œåœ°ä¿å­˜ä¸‹æ¥ï¼Œä»¥ä¾›åé¢ç»˜åˆ¶å’Œè·å–å¯¹åº”æ–‡æœ¬ä¿¡æ¯çš„æ—¶å€™ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> spanStart = paraStart, spanEnd; spanStart &lt; paraEnd; spanStart = spanEnd) &#123;</div><div class="line">                spanEnd = spanEndCache[spanEndCacheIndex++];</div><div class="line"></div><div class="line">                <span class="comment">// è·å–ä¹‹å‰ç¼“å­˜çš„FontMetricä¿¡æ¯</span></div><div class="line">                fm.top = fmCache[fmCacheIndex * <span class="number">4</span> + <span class="number">0</span>];</div><div class="line">                fm.bottom = fmCache[fmCacheIndex * <span class="number">4</span> + <span class="number">1</span>];</div><div class="line">                fm.ascent = fmCache[fmCacheIndex * <span class="number">4</span> + <span class="number">2</span>];</div><div class="line">                fm.descent = fmCache[fmCacheIndex * <span class="number">4</span> + <span class="number">3</span>];</div><div class="line">                fmCacheIndex++;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (fm.top &lt; fmTop) &#123;</div><div class="line">                    fmTop = fm.top;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (fm.ascent &lt; fmAscent) &#123;</div><div class="line">                    fmAscent = fm.ascent;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (fm.descent &gt; fmDescent) &#123;</div><div class="line">                    fmDescent = fm.descent;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (fm.bottom &gt; fmBottom) &#123;</div><div class="line">                    fmBottom = fm.bottom;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">while</span> (breakIndex &lt; breakCount &amp;&amp; paraStart + breaks[breakIndex] &lt; spanStart) &#123;</div><div class="line">                    breakIndex++;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">while</span> (breakIndex &lt; breakCount &amp;&amp; paraStart + breaks[breakIndex] &lt;= spanEnd) &#123;</div><div class="line">                    <span class="keyword">int</span> endPos = paraStart + breaks[breakIndex];</div><div class="line"></div><div class="line">                    <span class="keyword">boolean</span> moreChars = (endPos &lt; bufEnd);</div><div class="line"></div><div class="line">                    <span class="comment">//é€è¡ŒæŠŠç›¸å…³ä¿¡æ¯å‚¨å­˜ä¸‹æ¥</span></div><div class="line">                    v = out(source, here, endPos,</div><div class="line">                            fmAscent, fmDescent, fmTop, fmBottom,</div><div class="line">                            v, spacingmult, spacingadd, chooseHt, chooseHtv, fm, flags[breakIndex],</div><div class="line">                            needMultiply, chdirs, dir, easy, bufEnd, includepad, trackpad,</div><div class="line">                            chs, widths, paraStart, ellipsize, ellipsizedWidth,</div><div class="line">                            lineWidths[breakIndex], paint, moreChars);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (endPos &lt; spanEnd) &#123;</div><div class="line">                        fmTop = fm.top;</div><div class="line">                        fmBottom = fm.bottom;</div><div class="line">                        fmAscent = fm.ascent;</div><div class="line">                        fmDescent = fm.descent;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        fmTop = fmBottom = fmAscent = fmDescent = <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    here = endPos;</div><div class="line">                    breakIndex++;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (mLineCount &gt;= mMaximumVisibleLineCount) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·StaticLayoutçš„æ’ç‰ˆè¿‡ç¨‹å°±å®Œæˆäº†ã€‚æ–‡æœ¬çš„ç»˜åˆ¶åˆ™æ˜¯äº¤ç»™çˆ¶ç±»Layoutæ¥åšçš„ï¼ŒLayoutçš„ç»˜åˆ¶åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼ŒdrawBackgroundå’ŒdrawTextã€‚drawBackgroundåšçš„äº‹æƒ…æ˜¯å¦‚æœæ–‡æœ¬å†…æœ‰LineBackgroundSpanåˆ™ç»˜åˆ¶æ‰€æœ‰çš„LineBackgroundSpanï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æœ‰é«˜äº®èƒŒæ™¯(æ–‡æœ¬é€‰ä¸­çš„èƒŒæ™¯)ï¼Œå¦‚æœæœ‰åˆ™ç»˜åˆ¶é«˜äº®èƒŒæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawBackground</span><span class="params">(Canvas canvas, Path highlight, Paint highlightPaint,</span></span></div><div class="line">            <span class="keyword">int</span> cursorOffsetVertical, <span class="keyword">int</span> firstLine, <span class="keyword">int</span> lastLine) &#123;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ¤æ–­å¹¶ç»˜åˆ¶LineBackgroundSpan</span></div><div class="line">        <span class="keyword">if</span> (mSpannedText) &#123;</div><div class="line">            <span class="keyword">if</span> (mLineBackgroundSpans == <span class="keyword">null</span>) &#123;</div><div class="line">                mLineBackgroundSpans = <span class="keyword">new</span> SpanSet&lt;LineBackgroundSpan&gt;(LineBackgroundSpan.class);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Spanned buffer = (Spanned) mText;</div><div class="line">            <span class="keyword">int</span> textLength = buffer.length();</div><div class="line">            mLineBackgroundSpans.init(buffer, <span class="number">0</span>, textLength);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mLineBackgroundSpans.numberOfSpans &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">int</span> previousLineBottom = getLineTop(firstLine);</div><div class="line">                <span class="keyword">int</span> previousLineEnd = getLineStart(firstLine);</div><div class="line">                ParagraphStyle[] spans = NO_PARA_SPANS;</div><div class="line">                <span class="keyword">int</span> spansLength = <span class="number">0</span>;</div><div class="line">                TextPaint paint = mPaint;</div><div class="line">                <span class="keyword">int</span> spanEnd = <span class="number">0</span>;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> width = mWidth;</div><div class="line">                <span class="comment">//é€è¡Œç»˜åˆ¶LineBackgroundSpan</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = firstLine; i &lt;= lastLine; i++) &#123;</div><div class="line">                    <span class="keyword">int</span> start = previousLineEnd;</div><div class="line">                    <span class="keyword">int</span> end = getLineStart(i + <span class="number">1</span>);</div><div class="line">                    previousLineEnd = end;</div><div class="line"></div><div class="line">                    <span class="keyword">int</span> ltop = previousLineBottom;</div><div class="line">                    <span class="keyword">int</span> lbottom = getLineTop(i + <span class="number">1</span>);</div><div class="line">                    previousLineBottom = lbottom;</div><div class="line">                    <span class="keyword">int</span> lbaseline = lbottom - getLineDescent(i);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (start &gt;= spanEnd) &#123;</div><div class="line">                        spanEnd = mLineBackgroundSpans.getNextTransition(start, textLength);</div><div class="line"></div><div class="line">                        spansLength = <span class="number">0</span>;</div><div class="line">                        <span class="keyword">if</span> (start != end || start == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="comment">//æ’é™¤ä¸åœ¨ç»˜åˆ¶èŒƒå›´å†…çš„LineBackgroundSpan</span></div><div class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mLineBackgroundSpans.numberOfSpans; j++) &#123;</div><div class="line">                                <span class="keyword">if</span> (mLineBackgroundSpans.spanStarts[j] &gt;= end ||</div><div class="line">                                        mLineBackgroundSpans.spanEnds[j] &lt;= start) <span class="keyword">continue</span>;</div><div class="line">                                spans = GrowingArrayUtils.append(</div><div class="line">                                        spans, spansLength, mLineBackgroundSpans.spans[j]);</div><div class="line">                                spansLength++;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//å¯¹å½“å‰è¡Œå†…çš„LineBackgroundSpanè¿›è¡Œç»˜åˆ¶</span></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; spansLength; n++) &#123;</div><div class="line">                        LineBackgroundSpan lineBackgroundSpan = (LineBackgroundSpan) spans[n];</div><div class="line">                        lineBackgroundSpan.drawBackground(canvas, paint, <span class="number">0</span>, width,</div><div class="line">                                ltop, lbaseline, lbottom,</div><div class="line">                                buffer, start, end, i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mLineBackgroundSpans.recycle();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ¤æ–­å¹¶ç»˜åˆ¶é«˜äº®èƒŒæ™¯(å³é€‰ä¸­çš„æ–‡æœ¬)</span></div><div class="line">        <span class="keyword">if</span> (highlight != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (cursorOffsetVertical != <span class="number">0</span>) canvas.translate(<span class="number">0</span>, cursorOffsetVertical);</div><div class="line">            canvas.drawPath(highlight, highlightPaint);</div><div class="line">            <span class="keyword">if</span> (cursorOffsetVertical != <span class="number">0</span>) canvas.translate(<span class="number">0</span>, -cursorOffsetVertical);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>drawTextç”¨æ¥é€è¡Œç»˜åˆ¶Layoutçš„æ–‡æœ¬ã€å½±å“æ˜¾ç¤ºæ•ˆæœçš„Spanã€ä»¥åŠEmojiè¡¨æƒ…ç­‰ã€‚å½“æœ‰Emojiæˆ–è€…Spançš„æ—¶å€™ï¼Œå®é™…ç»˜åˆ¶å·¥ä½œäº¤ç»™TextLineç±»æ¥å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(Canvas canvas, <span class="keyword">int</span> firstLine, <span class="keyword">int</span> lastLine)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> previousLineBottom = getLineTop(firstLine);</div><div class="line">        <span class="keyword">int</span> previousLineEnd = getLineStart(firstLine);</div><div class="line">        ParagraphStyle[] spans = NO_PARA_SPANS;</div><div class="line">        <span class="keyword">int</span> spanEnd = <span class="number">0</span>;</div><div class="line">        TextPaint paint = mPaint;</div><div class="line">        CharSequence buf = mText;</div><div class="line"></div><div class="line">        Alignment paraAlign = mAlignment;</div><div class="line">        TabStops tabStops = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> tabStopsIsInitialized = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">//è·å–TextLineå®ä¾‹</span></div><div class="line">        TextLine tl = TextLine.obtain();</div><div class="line"></div><div class="line">        <span class="comment">//é€è¡Œç»˜åˆ¶æ–‡æœ¬</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> lineNum = firstLine; lineNum &lt;= lastLine; lineNum++) &#123;</div><div class="line">            <span class="keyword">int</span> start = previousLineEnd;</div><div class="line">            previousLineEnd = getLineStart(lineNum + <span class="number">1</span>);</div><div class="line">            <span class="keyword">int</span> end = getLineVisibleEnd(lineNum, start, previousLineEnd);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> ltop = previousLineBottom;</div><div class="line">            <span class="keyword">int</span> lbottom = getLineTop(lineNum + <span class="number">1</span>);</div><div class="line">            previousLineBottom = lbottom;</div><div class="line">            <span class="keyword">int</span> lbaseline = lbottom - getLineDescent(lineNum);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> dir = getParagraphDirection(lineNum);</div><div class="line">            <span class="keyword">int</span> left = <span class="number">0</span>;</div><div class="line">            <span class="keyword">int</span> right = mWidth;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mSpannedText) &#123;</div><div class="line">                Spanned sp = (Spanned) buf;</div><div class="line">                <span class="keyword">int</span> textLength = buf.length();</div><div class="line">                <span class="comment">//æ£€æµ‹æ˜¯å¦æ®µè½çš„ç¬¬ä¸€è¡Œ</span></div><div class="line">                <span class="keyword">boolean</span> isFirstParaLine = (start == <span class="number">0</span> || buf.charAt(start - <span class="number">1</span>) == <span class="string">'\n'</span>);</div><div class="line"></div><div class="line">                <span class="comment">//è·å¾—æ‰€æœ‰çš„æ®µè½é£æ ¼ç›¸å…³çš„Span</span></div><div class="line">                <span class="keyword">if</span> (start &gt;= spanEnd &amp;&amp; (lineNum == firstLine || isFirstParaLine)) &#123;</div><div class="line">                    spanEnd = sp.nextSpanTransition(start, textLength,</div><div class="line">                                                    ParagraphStyle.class);</div><div class="line">                    spans = getParagraphSpans(sp, start, spanEnd, ParagraphStyle.class);</div><div class="line"></div><div class="line">                    paraAlign = mAlignment;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> n = spans.length - <span class="number">1</span>; n &gt;= <span class="number">0</span>; n--) &#123;</div><div class="line">                        <span class="keyword">if</span> (spans[n] <span class="keyword">instanceof</span> AlignmentSpan) &#123;</div><div class="line">                            paraAlign = ((AlignmentSpan) spans[n]).getAlignment();</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    tabStopsIsInitialized = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//è·å–å½±å“è¡Œç¼©è¿›çš„Span</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> length = spans.length;</div><div class="line">                <span class="keyword">boolean</span> useFirstLineMargin = isFirstParaLine;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n++) &#123;</div><div class="line">                    <span class="keyword">if</span> (spans[n] <span class="keyword">instanceof</span> LeadingMarginSpan2) &#123;</div><div class="line">                        <span class="keyword">int</span> count = ((LeadingMarginSpan2) spans[n]).getLeadingMarginLineCount();</div><div class="line">                        <span class="keyword">int</span> startLine = getLineForOffset(sp.getSpanStart(spans[n]));</div><div class="line">                        <span class="keyword">if</span> (lineNum &lt; startLine + count) &#123;</div><div class="line">                            useFirstLineMargin = <span class="keyword">true</span>;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n++) &#123;</div><div class="line">                    <span class="keyword">if</span> (spans[n] <span class="keyword">instanceof</span> LeadingMarginSpan) &#123;</div><div class="line">                        LeadingMarginSpan margin = (LeadingMarginSpan) spans[n];</div><div class="line">                        <span class="keyword">if</span> (dir == DIR_RIGHT_TO_LEFT) &#123;</div><div class="line">                            margin.drawLeadingMargin(canvas, paint, right, dir, ltop,</div><div class="line">                                                     lbaseline, lbottom, buf,</div><div class="line">                                                     start, end, isFirstParaLine, <span class="keyword">this</span>);</div><div class="line">                            right -= margin.getLeadingMargin(useFirstLineMargin);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            margin.drawLeadingMargin(canvas, paint, left, dir, ltop,</div><div class="line">                                                     lbaseline, lbottom, buf,</div><div class="line">                                                     start, end, isFirstParaLine, <span class="keyword">this</span>);</div><div class="line">                            left += margin.getLeadingMargin(useFirstLineMargin);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> hasTabOrEmoji = getLineContainsTab(lineNum);</div><div class="line">            <span class="keyword">if</span> (hasTabOrEmoji &amp;&amp; !tabStopsIsInitialized) &#123;</div><div class="line">                <span class="keyword">if</span> (tabStops == <span class="keyword">null</span>) &#123;</div><div class="line">                    tabStops = <span class="keyword">new</span> TabStops(TAB_INCREMENT, spans);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    tabStops.reset(TAB_INCREMENT, spans);</div><div class="line">                &#125;</div><div class="line">                tabStopsIsInitialized = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//åˆ¤æ–­å½“å‰è¡Œçš„ç¬¬äº”æ–¹å¼</span></div><div class="line">            Alignment align = paraAlign;</div><div class="line">            <span class="keyword">if</span> (align == Alignment.ALIGN_LEFT) &#123;</div><div class="line">                align = (dir == DIR_LEFT_TO_RIGHT) ?</div><div class="line">                    Alignment.ALIGN_NORMAL : Alignment.ALIGN_OPPOSITE;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (align == Alignment.ALIGN_RIGHT) &#123;</div><div class="line">                align = (dir == DIR_LEFT_TO_RIGHT) ?</div><div class="line">                    Alignment.ALIGN_OPPOSITE : Alignment.ALIGN_NORMAL;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> x;</div><div class="line">            <span class="keyword">if</span> (align == Alignment.ALIGN_NORMAL) &#123;</div><div class="line">                <span class="keyword">if</span> (dir == DIR_LEFT_TO_RIGHT) &#123;</div><div class="line">                    x = left + getIndentAdjust(lineNum, Alignment.ALIGN_LEFT);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    x = right + getIndentAdjust(lineNum, Alignment.ALIGN_RIGHT);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">int</span> max = (<span class="keyword">int</span>)getLineExtent(lineNum, tabStops, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">if</span> (align == Alignment.ALIGN_OPPOSITE) &#123;</div><div class="line">                    <span class="keyword">if</span> (dir == DIR_LEFT_TO_RIGHT) &#123;</div><div class="line">                        x = right - max + getIndentAdjust(lineNum, Alignment.ALIGN_RIGHT);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        x = left - max + getIndentAdjust(lineNum, Alignment.ALIGN_LEFT);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// Alignment.ALIGN_CENTER</span></div><div class="line">                    max = max &amp; ~<span class="number">1</span>;</div><div class="line">                    x = ((right + left - max) &gt;&gt; <span class="number">1</span>) +</div><div class="line">                            getIndentAdjust(lineNum, Alignment.ALIGN_CENTER);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            paint.setHyphenEdit(getHyphen(lineNum));</div><div class="line">            Directions directions = getLineDirections(lineNum);</div><div class="line">            <span class="keyword">if</span> (directions == DIRS_ALL_LEFT_TO_RIGHT &amp;&amp; !mSpannedText &amp;&amp; !hasTabOrEmoji) &#123;</div><div class="line">                <span class="comment">//æ²¡æœ‰ä»»ä½•Emojiæˆ–è€…spançš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨Canvasæ¥ç»˜åˆ¶æ–‡æœ¬</span></div><div class="line">                canvas.drawText(buf, start, end, x, lbaseline, paint);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//å½“æœ‰Emojiæˆ–è€…Spançš„æ—¶å€™ï¼Œäº¤ç»™TextLineç±»æ¥ç»˜åˆ¶</span></div><div class="line">                tl.set(paint, buf, start, end, dir, directions, hasTabOrEmoji, tabStops);</div><div class="line">                tl.draw(canvas, x, ltop, lbaseline, lbottom);</div><div class="line">            &#125;</div><div class="line">            paint.setHyphenEdit(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        TextLine.recycle(tl);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸‹é¢å†æ¥çœ‹çœ‹TextLineæ˜¯å¦‚ä½•ç»˜åˆ¶æœ‰ç‰¹æ®Šæƒ…å†µçš„æ–‡æœ¬çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas c, <span class="keyword">float</span> x, <span class="keyword">int</span> top, <span class="keyword">int</span> y, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰Tabæˆ–è€…Emoji</span></div><div class="line">        <span class="keyword">if</span> (!mHasTabs) &#123;</div><div class="line">            <span class="keyword">if</span> (mDirections == Layout.DIRS_ALL_LEFT_TO_RIGHT) &#123;</div><div class="line">                drawRun(c, <span class="number">0</span>, mLen, <span class="keyword">false</span>, x, top, y, bottom, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mDirections == Layout.DIRS_ALL_RIGHT_TO_LEFT) &#123;</div><div class="line">                drawRun(c, <span class="number">0</span>, mLen, <span class="keyword">true</span>, x, top, y, bottom, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">float</span> h = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span>[] runs = mDirections.mDirections;</div><div class="line">        RectF emojiRect = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> lastRunIndex = runs.length - <span class="number">2</span>;</div><div class="line">        <span class="comment">//é€ä¸ªç»˜åˆ¶</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; runs.length; i += <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">int</span> runStart = runs[i];</div><div class="line">            <span class="keyword">int</span> runLimit = runStart + (runs[i+<span class="number">1</span>] &amp; Layout.RUN_LENGTH_MASK);</div><div class="line">            <span class="keyword">if</span> (runLimit &gt; mLen) &#123;</div><div class="line">                runLimit = mLen;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> runIsRtl = (runs[i+<span class="number">1</span>] &amp; Layout.RUN_RTL_FLAG) != <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> segstart = runStart;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = mHasTabs ? runStart : runLimit; j &lt;= runLimit; j++) &#123;</div><div class="line">                <span class="keyword">int</span> codept = <span class="number">0</span>;</div><div class="line">                Bitmap bm = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mHasTabs &amp;&amp; j &lt; runLimit) &#123;</div><div class="line">                    codept = mChars[j];</div><div class="line">                    <span class="keyword">if</span> (codept &gt;= <span class="number">0xd800</span> &amp;&amp; codept &lt; <span class="number">0xdc00</span> &amp;&amp; j + <span class="number">1</span> &lt; runLimit) &#123;</div><div class="line">                        codept = Character.codePointAt(mChars, j);</div><div class="line">                        <span class="keyword">if</span> (codept &gt;= Layout.MIN_EMOJI &amp;&amp; codept &lt;= Layout.MAX_EMOJI) &#123;</div><div class="line">                            <span class="comment">//è·å–Emojiå¯¹åº”çš„å›¾åƒ</span></div><div class="line">                            bm = Layout.EMOJI_FACTORY.getBitmapFromAndroidPua(codept);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codept &gt; <span class="number">0xffff</span>) &#123;</div><div class="line">                            ++j;</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (j == runLimit || codept == <span class="string">'\t'</span> || bm != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//ç»˜åˆ¶æ–‡å­—</span></div><div class="line">                    h += drawRun(c, segstart, j, runIsRtl, x+h, top, y, bottom,</div><div class="line">                            i != lastRunIndex || j != mLen);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (codept == <span class="string">'\t'</span>) &#123;</div><div class="line">                        h = mDir * nextTab(h * mDir);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bm != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">float</span> bmAscent = ascent(j);</div><div class="line">                        <span class="keyword">float</span> bitmapHeight = bm.getHeight();</div><div class="line">                        <span class="keyword">float</span> scale = -bmAscent / bitmapHeight;</div><div class="line">                        <span class="keyword">float</span> width = bm.getWidth() * scale;</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (emojiRect == <span class="keyword">null</span>) &#123;</div><div class="line">                            emojiRect = <span class="keyword">new</span> RectF();</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//è°ƒæ•´emojiå›¾åƒç»˜åˆ¶çŸ©å½¢</span></div><div class="line">                        emojiRect.set(x + h, y + bmAscent,</div><div class="line">                                x + h + width, y);</div><div class="line">                        <span class="comment">//ç»˜åˆ¶Emojiå›¾åƒ</span></div><div class="line">                        c.drawBitmap(bm, <span class="keyword">null</span>, emojiRect, mPaint);</div><div class="line">                        h += width;</div><div class="line">                        j++;</div><div class="line">                    &#125;</div><div class="line">                    segstart = j + <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å®Œæˆäº†æ–‡æœ¬çš„ç»˜åˆ¶å·¥ä½œï¼Œç®€å•åœ°æ€»ç»“å°±æ˜¯ï¼šåˆ†ææ•´ä½“æ–‡æœ¬â€”&gt;æ‹†åˆ†ä¸ºæ®µè½â€”&gt;è®¡ç®—æ•´ä½“æ®µè½çš„æ–‡æœ¬åŒ…æ‹¬Spançš„æµ‹é‡ä¿¡æ¯â€”&gt;å¯¹æ–‡æœ¬è¿›è¡ŒæŠ˜è¡Œâ€”&gt;æ ¹æ®æœ€ç»ˆè¡Œæ•°æŠŠæ–‡æœ¬æµ‹é‡ä¿¡æ¯ä¿å­˜â€”&gt;ç»˜åˆ¶æ–‡æœ¬çš„è¡ŒèƒŒæ™¯â€”&gt;åˆ¤æ–­å¹¶è·å–æ–‡æœ¬ç§çš„Spanå’ŒEmojiå›¾åƒâ€”&gt;ç»˜åˆ¶æœ€ç»ˆçš„æ–‡æœ¬å’Œå›¾åƒã€‚å½“ç„¶æˆ‘ä»¬çœç•¥äº†ä¸€éƒ¨åˆ†å†…å®¹ï¼Œæ¯”å¦‚æ®µè½æ–‡æœ¬æ–¹å‘ï¼Œå•è¡Œçš„æ–‡æœ¬æ’ç‰ˆæ–¹å‘çš„è®¡ç®—ï¼Œå®é™…çš„å¤„ç†è¦æ›´ä¸ºå¤æ‚ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨æµ‹é‡è¿‡ç¨‹ä¸­å‡ºç°çš„FontMetricsï¼Œè¿™æ˜¯ä¸€ä¸ªPaintçš„é™æ€å†…éƒ¨ç±»ã€‚ä¸»è¦ç”¨æ¥å‚¨å­˜æ–‡å­—æ’ç‰ˆçš„Yè½´ç›¸å…³ä¿¡æ¯ã€‚å†…éƒ¨ä»…åŒ…å«ascentã€descentã€topã€bottomã€leadingäº”ä¸ªæ•°å€¼ã€‚å¦‚ä¸‹å›¾:</p>
<p> <img src="https://raw.githubusercontent.com/7heaven/AndroidSdkSourceAnalysis/master/article/images/fontmetrics.gif" alt="1339061786_4121"></p>
<p>é™¤äº†leadingä»¥å¤–ï¼Œå…¶ä»–çš„æ•°å€¼éƒ½æ˜¯ç›¸å¯¹äºæ¯ä¸€è¡Œçš„baselineçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä»–çš„æ•°å€¼éœ€è¦åŠ ä¸Šå¯¹åº”è¡Œçš„baselineæ‰èƒ½å¾—åˆ°æœ€ç»ˆçœŸå®çš„åæ ‡ã€‚</p>
<h2 id="6-TextViewæ¥æ”¶è½¯é”®ç›˜è¾“å…¥"><a href="#6-TextViewæ¥æ”¶è½¯é”®ç›˜è¾“å…¥" class="headerlink" title="6.TextViewæ¥æ”¶è½¯é”®ç›˜è¾“å…¥"></a>6.TextViewæ¥æ”¶è½¯é”®ç›˜è¾“å…¥</h2><p>Androidä¸Šçš„æ ‡å‡†æ–‡æœ¬ç¼–è¾‘æ§ä»¶æ˜¯EditTextï¼Œè€ŒEditTextå¯¹è½¯é”®ç›˜è¾“å…¥çš„å¤„ç†ï¼Œå´æ˜¯åœ¨TextViewå†…éƒ¨å®ç°çš„ã€‚Androidä¸ºæ‰€æœ‰çš„Viewé¢„ç•™äº†ä¸€ä¸ªæ¥æ”¶è½¯é”®ç›˜è¾“å…¥çš„æ¥å£ç±»ï¼Œå«InputConnectionã€‚è½¯é”®ç›˜ä»¥InputConnectionä¸ºæ¡¥æ¢æŠŠæ–‡å­—è¾“å…¥ã€æ–‡å­—ä¿®æ”¹ã€æ–‡å­—åˆ é™¤ç­‰ä¼ é€’ç»™Viewã€‚ä»»æ„Viewåªè¦é‡å†™onCheckIsTextEditor()å¹¶è¿”å›trueï¼Œç„¶åé‡å†™onCreateInputConnection(EditorInfo outAttrs)è¿”å›ä¸€ä¸ªInputConnectionçš„å®ä¾‹ï¼Œä¾¿å¯ä»¥æ¥æ”¶è½¯é”®ç›˜çš„è¾“å…¥ã€‚TextViewçš„è½¯é”®ç›˜è¾“å…¥æ¥æ”¶ï¼Œæ˜¯é€šè¿‡EditableInputConnectionç±»æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> InputConnection <span class="title">onCreateInputConnection</span><span class="params">(EditorInfo outAttrs)</span> </span>&#123;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å¤„äºå¯ç¼–è¾‘çŠ¶æ€</span></div><div class="line">        <span class="keyword">if</span> (onCheckIsTextEditor() &amp;&amp; isEnabled()) &#123;</div><div class="line">            mEditor.createInputMethodStateIfNeeded();</div><div class="line"></div><div class="line">            <span class="comment">//è®¾ç½®è¾“å…¥æ³•ç›¸å…³çš„ä¿¡æ¯</span></div><div class="line">            outAttrs.inputType = getInputType();</div><div class="line">            <span class="keyword">if</span> (mEditor.mInputContentType != <span class="keyword">null</span>) &#123;</div><div class="line">                outAttrs.imeOptions = mEditor.mInputContentType.imeOptions;</div><div class="line">                outAttrs.privateImeOptions = mEditor.mInputContentType.privateImeOptions;</div><div class="line">                outAttrs.actionLabel = mEditor.mInputContentType.imeActionLabel;</div><div class="line">                outAttrs.actionId = mEditor.mInputContentType.imeActionId;</div><div class="line">                outAttrs.extras = mEditor.mInputContentType.extras;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                outAttrs.imeOptions = EditorInfo.IME_NULL;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (focusSearch(FOCUS_DOWN) != <span class="keyword">null</span>) &#123;</div><div class="line">                outAttrs.imeOptions |= EditorInfo.IME_FLAG_NAVIGATE_NEXT;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (focusSearch(FOCUS_UP) != <span class="keyword">null</span>) &#123;</div><div class="line">                outAttrs.imeOptions |= EditorInfo.IME_FLAG_NAVIGATE_PREVIOUS;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((outAttrs.imeOptions&amp;EditorInfo.IME_MASK_ACTION)</div><div class="line">                    == EditorInfo.IME_ACTION_UNSPECIFIED) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> ((outAttrs.imeOptions&amp;EditorInfo.IME_FLAG_NAVIGATE_NEXT) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">//æŠŠè½¯é”®ç›˜çš„enterè®¾ä¸ºä¸‹ä¸€æ­¥</span></div><div class="line">                    outAttrs.imeOptions |= EditorInfo.IME_ACTION_NEXT;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">//æŠŠè½¯é”®ç›˜çš„enterè®¾ä¸ºå®Œæˆ</span></div><div class="line">                    outAttrs.imeOptions |= EditorInfo.IME_ACTION_DONE;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!shouldAdvanceFocusOnEnter()) &#123;</div><div class="line">                    outAttrs.imeOptions |= EditorInfo.IME_FLAG_NO_ENTER_ACTION;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isMultilineInputType(outAttrs.inputType)) &#123;</div><div class="line">                outAttrs.imeOptions |= EditorInfo.IME_FLAG_NO_ENTER_ACTION;</div><div class="line">            &#125;</div><div class="line">            outAttrs.hintText = mHint;</div><div class="line"></div><div class="line">            <span class="comment">//åˆ¤æ–­TextViewå†…éƒ¨æ–‡æœ¬æ˜¯å¦å¯ç¼–è¾‘</span></div><div class="line">            <span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Editable) &#123;</div><div class="line">                <span class="comment">//è¿”å›EditableInputConnectionå®ä¾‹</span></div><div class="line">                InputConnection ic = <span class="keyword">new</span> EditableInputConnection(<span class="keyword">this</span>);</div><div class="line">                outAttrs.initialSelStart = getSelectionStart();</div><div class="line">                outAttrs.initialSelEnd = getSelectionEnd();</div><div class="line">                outAttrs.initialCapsMode = ic.getCursorCapsMode(getInputType());</div><div class="line">                <span class="keyword">return</span> ic;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹EditableInputConnectioné‡Œé¢çš„å‡ ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š</p>
<p>é¦–å…ˆæ˜¯commitTextæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶è¾“å…¥æ³•è¾“å…¥çš„å­—ç¬¦å¹¶æäº¤ç»™TextViewã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitText</span><span class="params">(CharSequence text, <span class="keyword">int</span> newCursorPosition)</span> </span>&#123;</div><div class="line">        <span class="comment">//åˆ¤æ–­TextViewæ˜¯å¦ä¸ºç©º</span></div><div class="line">        <span class="keyword">if</span> (mTextView == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.commitText(text, newCursorPosition);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ–‡æœ¬æ˜¯å¦Spanï¼Œæ¥è‡ªè¾“å…¥æ³•çš„Spanä¸€èˆ¬åªæœ‰SuggestionSpanï¼ŒSuggestionSpanæºå¸¦äº†è¾“å…¥æ³•çš„é”™åˆ«å­—ä¿®æ­£çš„è¯</span></div><div class="line">        <span class="keyword">if</span> (text <span class="keyword">instanceof</span> Spanned) &#123;</div><div class="line">            Spanned spanned = ((Spanned) text);</div><div class="line">            SuggestionSpan[] spans = spanned.getSpans(<span class="number">0</span>, text.length(), SuggestionSpan.class);</div><div class="line">            mIMM.registerSuggestionSpansForNotification(spans);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mTextView.resetErrorChangedFlag();</div><div class="line">        <span class="comment">//æäº¤å­—ç¬¦</span></div><div class="line">        <span class="keyword">boolean</span> success = <span class="keyword">super</span>.commitText(text, newCursorPosition);</div><div class="line">        mTextView.hideErrorIfUnchanged();</div><div class="line">        <span class="comment">//è¿”å›æ˜¯å¦æˆåŠŸ</span></div><div class="line">        <span class="keyword">return</span> success;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>getEditableæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯InputConnectionæ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯EditableInputConnectionçš„çˆ¶ç±»BaseInputConnectionçš„æ–¹æ³•ï¼Œç”¨æ¥è·å–ä¸€ä¸ªå¯ç¼–è¾‘å¯¹è±¡ï¼ŒEditableInputConnectioné‡Œé¢çš„æ‰€æœ‰ä¿®æ”¹éƒ½é’ˆå¯¹è¿™ä¸ªå¯ç¼–è¾‘å¯¹è±¡æ¥åšã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Editable <span class="title">getEditable</span><span class="params">()</span> </span>&#123;</div><div class="line">        TextView tv = mTextView;</div><div class="line">        <span class="keyword">if</span> (tv != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//è¿”å›TextViewçš„å¯ç¼–è¾‘å¯¹è±¡</span></div><div class="line">            <span class="keyword">return</span> tv.getEditableText();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>deleteSurroundingTextæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥åˆ é™¤å…‰æ ‡å‰åçš„å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteSurroundingText</span><span class="params">(<span class="keyword">int</span> beforeLength, <span class="keyword">int</span> afterLength)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"deleteSurroundingText "</span> + beforeLength</div><div class="line">                + <span class="string">" / "</span> + afterLength);</div><div class="line">        <span class="keyword">final</span> Editable content = getEditable();</div><div class="line">        <span class="keyword">if</span> (content == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">//æ‰¹é‡åˆ é™¤æ ‡è®°</span></div><div class="line">        beginBatchEdit();</div><div class="line"></div><div class="line">        <span class="comment">//è·å–å½“å‰å·²é€‰æ‹©çš„æ–‡æœ¬çš„ä½ç½®</span></div><div class="line">        <span class="keyword">int</span> a = Selection.getSelectionStart(content);</div><div class="line">        <span class="keyword">int</span> b = Selection.getSelectionEnd(content);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (a &gt; b) &#123;</div><div class="line">            <span class="keyword">int</span> tmp = a;</div><div class="line">            a = b;</div><div class="line">            b = tmp;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> ca = getComposingSpanStart(content);</div><div class="line">        <span class="keyword">int</span> cb = getComposingSpanEnd(content);</div><div class="line">        <span class="keyword">if</span> (cb &lt; ca) &#123;</div><div class="line">            <span class="keyword">int</span> tmp = ca;</div><div class="line">            ca = cb;</div><div class="line">            cb = tmp;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (ca != -<span class="number">1</span> &amp;&amp; cb != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (ca &lt; a) a = ca;</div><div class="line">            <span class="keyword">if</span> (cb &gt; b) b = cb;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> deleted = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">//åˆ é™¤å…‰æ ‡ä¹‹å‰çš„æ–‡æœ¬</span></div><div class="line">        <span class="keyword">if</span> (beforeLength &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> start = a - beforeLength;</div><div class="line">            <span class="keyword">if</span> (start &lt; <span class="number">0</span>) start = <span class="number">0</span>;</div><div class="line">            content.delete(start, a);</div><div class="line">            deleted = a - start;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åˆ é™¤å…‰æ ‡ä¹‹åçš„æ–‡æœ¬</span></div><div class="line">        <span class="keyword">if</span> (afterLength &gt; <span class="number">0</span>) &#123;</div><div class="line">            b = b - deleted;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> end = b + afterLength;</div><div class="line">            <span class="keyword">if</span> (end &gt; content.length()) end = content.length();</div><div class="line"></div><div class="line">            content.delete(b, end);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//ç»“æŸæ‰¹é‡ç¼–è¾‘</span></div><div class="line">        endBatchEdit();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>commitCompletionå’ŒcommitCorrectionæ–¹æ³•ï¼Œå³æ˜¯ç”¨æ¥è¡¥å…¨å•è¯å’Œä¿®æ­£é”™åˆ«å­—çš„æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å†…éƒ¨éƒ½æ˜¯è°ƒç”¨TextViewå¯¹åº”çš„æ–¹æ³•æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitCompletion</span><span class="params">(CompletionInfo text)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"commitCompletion "</span> + text);</div><div class="line">        mTextView.beginBatchEdit();</div><div class="line">        mTextView.onCommitCompletion(text);</div><div class="line">        mTextView.endBatchEdit();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitCorrection</span><span class="params">(CorrectionInfo correctionInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"commitCorrection"</span> + correctionInfo);</div><div class="line">        mTextView.beginBatchEdit();</div><div class="line">        mTextView.onCommitCorrection(correctionInfo);</div><div class="line">        mTextView.endBatchEdit();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="8-æ€»ç»“"><a href="#8-æ€»ç»“" class="headerlink" title="8.æ€»ç»“"></a>8.æ€»ç»“</h2><p>ä¸€ä¸ªå±•ç¤ºæ–‡æœ¬+æ–‡æœ¬ç¼–è¾‘å™¨åŠŸèƒ½çš„æ§ä»¶éœ€è¦åšçš„äº‹æƒ…å¾ˆå¤šï¼Œè¦å¯¹æ–‡æœ¬è¿›è¡Œæ’ç‰ˆã€å¤„ç†ä¸åŒçš„æ®µè½é£æ ¼ã€å¤„ç†æ®µè½å†…çš„ä¸åŒemojiå’Œspanã€è¿›è¡ŒæŠ˜è¡Œè®¡ç®—ï¼Œç„¶åè¿˜éœ€è¦åšæ–‡æœ¬ç¼–è¾‘ã€æ–‡æœ¬é€‰æ‹©ç­‰ã€‚è€ŒTextViewæŠŠè¿™äº›äº‹æƒ…æ˜ç¡®åˆ†å·¥ç»™ä¸åŒçš„ç±»ã€‚è¿™æ ·ä¸ä»…ä»…æŠŠå¤æ‚é—®é¢˜æ‹†åˆ†æˆäº†ä¸€ä¸ªä¸ªç®€å•çš„å°åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿå¤§å¤§å¢åŠ äº†å¯æ‰©å±•æ€§ã€‚</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>TabLayoutæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/TabLayout%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/TabLayoutæºç è§£æ/</id>
    <published>2017-07-26T12:06:13.000Z</published>
    <updated>2017-07-26T12:06:32.545Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h1 id="TabLayout-æºç è§£æ"><a href="#TabLayout-æºç è§£æ" class="headerlink" title="TabLayout æºç è§£æ"></a>TabLayout æºç è§£æ</h1><h2 id="1-åŠŸèƒ½ä»‹ç»"><a href="#1-åŠŸèƒ½ä»‹ç»" class="headerlink" title="1. åŠŸèƒ½ä»‹ç»"></a>1. åŠŸèƒ½ä»‹ç»</h2><h3 id="1-1-TabLayout"><a href="#1-1-TabLayout" class="headerlink" title="1.1 TabLayout"></a>1.1 TabLayout</h3><p>Tabsè·ŸéšActionbaråœ¨Android 3.0è¿›å…¥å¤§å®¶çš„è§†çº¿ï¼Œæ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„è®¾è®¡ã€‚å®ƒä¹Ÿæ˜¯Material Design è§„èŒƒä¸­æåŠçš„<code>Component</code>ä¹‹ä¸€ã€‚Tabs or Bottom navigationï¼Ÿç›¸ä¿¡ä¸å°‘Androidå¼€å‘è€…ä¸äº§å“éƒ½æ’•è¿‡ï¼Œå°±è¿å¾®ä¿¡åœ¨å…¶ä¸­ä¹Ÿæœ‰è¿‡æŠ‰æ‹©ã€‚Googleåœ¨Google+ä»¥åŠGoogle Photoä¸­ç›¸ç»§é‡‡ç”¨Bottom navigationçš„è®¾è®¡æŠŠå‰§æƒ…æ¨åˆ°å‘é«˜æ½®ï¼Œä¸€åº¦è½°åŠ¨æ•´ä¸ªç¤¾åŒºã€‚Googleç»§è€Œåœ¨Material Design è§„èŒƒåŠ å…¥äº†Bottom navigationï¼Œè¡¨æ˜äº†æ€åº¦ï¼Œä¹Ÿç»™è¿™èµ·äº‰è®ºç”»ä¸Šäº†åœ†æ»¡çš„å¥å·ã€‚</p>
<p>åœ¨ support desgin lib å‘å¸ƒå‰ï¼Œå¤§å®¶åŸºæœ¬éƒ½é‡‡ç”¨<a href="https://github.com/astuetz/PagerSlidingTabStrip" target="_blank" rel="external">PagerSlidingTabStrip</a>æ¥å®ç°tabæ•ˆæœã€‚å…¶å®<code>TabLayout</code>åœ¨å®ç°ä¸Šå’Œ<code>PagerSlidingTabStrip</code>ååˆ†ç›¸ä¼¼ï¼Œä»Šå¤©æˆ‘ä»¬æ¥åˆ†æ<code>TabLayout</code>ã€‚</p>
<h3 id="1-2-TabLayoutä½¿ç”¨"><a href="#1-2-TabLayoutä½¿ç”¨" class="headerlink" title="1.2 TabLayoutä½¿ç”¨"></a>1.2 TabLayoutä½¿ç”¨</h3><p><code>TabLayout</code>ä½¿ç”¨æ¯”è¾ƒç®€å•ã€‚æ—¢å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸<code>ViewPager</code>é…åˆä½¿ç”¨ã€‚</p>
<h4 id="1-2-1-TabLayoutå•ç‹¬ä½¿ç”¨"><a href="#1-2-1-TabLayoutå•ç‹¬ä½¿ç”¨" class="headerlink" title="1.2.1 TabLayoutå•ç‹¬ä½¿ç”¨"></a>1.2.1 TabLayoutå•ç‹¬ä½¿ç”¨</h4><p>åœ¨javaä»£ç ä¸­æ·»åŠ Tabs<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TabLayout tabLayout = (TabLayout) findViewById(R.id.tabLayout);</div><div class="line">tabLayout.addTab(tabLayout.newTab().setText(<span class="string">"Tab 1"</span>));</div><div class="line">tabLayout.addTab(tabLayout.newTab().setText(<span class="string">"Tab 2"</span>));</div><div class="line">tabLayout.addTab(tabLayout.newTab().setText(<span class="string">"Tab 3"</span>));</div></pre></td></tr></table></figure></p>
<p>ä¹Ÿå¯ä»¥åœ¨xmlä¸­æ·»åŠ Tabs<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.design.widget.TabLayout</span></span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.TabItem</span></span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/tab_text"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.TabItem</span></span></div><div class="line">        <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_android"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.design.widget.TabLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="1-2-2-ä¸ViewPageræ­é…ä½¿ç”¨"><a href="#1-2-2-ä¸ViewPageræ­é…ä½¿ç”¨" class="headerlink" title="1.2.2 ä¸ViewPageræ­é…ä½¿ç”¨"></a>1.2.2 ä¸ViewPageræ­é…ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// find view</span></div><div class="line">TabLayout tabLayout = ...;</div><div class="line">ViewPager viewPager = ...;</div><div class="line"></div><div class="line">PagerAdapter adapter = <span class="keyword">new</span> PagerAdapter()&#123;</div><div class="line">    <span class="comment">// ...Override some methods</span></div><div class="line">    <span class="comment">// TabLayoutè°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–Tabçš„title</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getPageTitle</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Tab 1"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">viewPager.setAdapter(adapter);</div><div class="line">tabLayout.setupWithViewPager(viewPager);</div></pre></td></tr></table></figure>
<h2 id="2-æ€»ä½“è®¾è®¡"><a href="#2-æ€»ä½“è®¾è®¡" class="headerlink" title="2. æ€»ä½“è®¾è®¡"></a>2. æ€»ä½“è®¾è®¡</h2><ul>
<li><p><code>TabLayout</code>ç»§æ‰¿<code>HorizontalScrollView</code>å¤©ç”Ÿå°±æ˜¯ä¸€ä¸ªå¯ä»¥æ¨ªå‘æ»šåŠ¨çš„<code>ViewGroup</code>. æˆ‘ä»¬çŸ¥é“, <code>HorizontalScrollView</code>ä¸<code>ScrollView</code>ä¸€æ ·, æœ€å¤šåªèƒ½åŒ…å«ä¸€ä¸ªå­View.</p>
</li>
<li><p><code>SlidingTabStrip</code>ç»§æ‰¿äº<code>LinearLayout</code>ï¼Œæ˜¯<code>TabLayout</code>çš„å†…éƒ¨ç±»ã€‚å®ƒæ˜¯<code>TabLayout</code>å”¯ä¸€çš„å­View. æ‰€æœ‰çš„<code>TabView</code>éƒ½æ˜¯å®ƒçš„å­View.</p>
</li>
<li><p><code>TabView</code>ç»§æ‰¿äº<code>LinearLayout</code>,ä»¥<code>Tab</code>ä¸ºæ•°æ®æºï¼Œæ¥å±•ç¤ºTabçš„æ ·å¼ã€‚æœ€ç»ˆç”¨forå¾ªç¯è¢«addè¿›<code>SlidingTabStrip</code>.</p>
</li>
<li><p><code>Tab</code>æ˜¯ä¸€ä¸ªç®€å•çš„View Modelå®ä½“ç±»ï¼Œæ§åˆ¶<code>TabView</code>çš„title, icon, custom layout idç­‰å±æ€§ã€‚</p>
</li>
<li><p><code>TabItem</code>ç»§æ‰¿äºView. ç”¨äºåœ¨layout xmlä¸­æ¥æè¿°Tab. éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸ä¼šaddåˆ°<code>SlidingTabStrip</code>ä¸­å»ã€‚å®ƒçš„ä½œç”¨æ˜¯ä»xmlä¸­è·å–åˆ°textï¼Œiconï¼Œcustom layout idç­‰å±æ€§ã€‚TabLayout inflateåˆ°<code>TabItem</code>å¹¶è·å–å±æ€§åˆ°è£…é…åˆ°<code>Tab</code>ä¸­ï¼Œæœ€ç»ˆaddåˆ°<code>SlidingTabStrip</code>ä¸­çš„è¿˜æ˜¯<code>TabView</code>.</p>
</li>
<li><p><code>OnTabSelectedListener</code>æ˜¯TabLayoutä¸­çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºç›‘å¬<code>SlidingTabStrip</code>ä¸­å­<code>TabView</code>é€‰ä¸­çŠ¶æ€çš„æ”¹å˜ã€‚</p>
</li>
<li><p><code>Mode</code>æ˜¯TabLayoutæ»šåŠ¨æ¨¡å¼çš„æè¿°ï¼Œä¸€å…±æœ‰ä¸¤ç§çŠ¶æ€ã€‚<code>MODE_FIXED</code>ä¸å¯æ»šåŠ¨æ¨¡å¼ï¼Œä»¥åŠ<code>MODE_SCROLLABLE</code>å¯ä»¥æ»šåŠ¨æ¨¡å¼ã€‚</p>
</li>
<li><p><code>Gravity</code>æ˜¯<code>TabView</code>åœ¨<code>SlidingTabStrip</code>ä¸­layoutæ–¹å¼çš„æè¿°ã€‚åˆ†ä¸ºï¼šGRAVITY_FILLï¼ŒGRAVITY_CENTER.</p>
</li>
</ul>
<h2 id="3-è¯¦ç»†è®¾è®¡"><a href="#3-è¯¦ç»†è®¾è®¡" class="headerlink" title="3. è¯¦ç»†è®¾è®¡"></a>3. è¯¦ç»†è®¾è®¡</h2><h3 id="3-1-ç±»å…³ç³»å›¾"><a href="#3-1-ç±»å…³ç³»å›¾" class="headerlink" title="3.1 ç±»å…³ç³»å›¾"></a>3.1 ç±»å…³ç³»å›¾</h3><p><img src="../assets/tablayout.png" alt="TabLayout"></p>
<h3 id="3-2-åˆ†æ"><a href="#3-2-åˆ†æ" class="headerlink" title="3.2 åˆ†æ"></a>3.2 åˆ†æ</h3><h4 id="3-2-1-TabLayoutå­Viewå”¯ä¸€æ€§ä¿è¯"><a href="#3-2-1-TabLayoutå­Viewå”¯ä¸€æ€§ä¿è¯" class="headerlink" title="3.2.1 TabLayoutå­Viewå”¯ä¸€æ€§ä¿è¯"></a>3.2.1 TabLayoutå­Viewå”¯ä¸€æ€§ä¿è¯</h4><p>å‰é¢ä»‹ç»<code>TabLayout</code>ç»§æ‰¿äº<code>HorizontalScrollView</code>æœ€å¤šåªèƒ½æœ‰1ä¸ªå­View. ä½†<code>TabLayout</code>å¯ä»¥åœ¨layoutä¸­æ·»åŠ å¤šä¸ªå­ViewèŠ‚ç‚¹. è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.design.widget.TabLayout</span></span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.TabItem</span></span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/tab_text"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.TabItem</span></span></div><div class="line">        <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_android"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.design.widget.TabLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>çœ‹è¿‡<code>LayoutInflater</code>æºç çš„åŒå­¦å¯èƒ½ä¼šçŸ¥é“è¿™ä¸ªè¿‡ç¨‹ï¼šå…ˆinflateåˆ°ç”ŸæˆViewå¯¹è±¡ï¼Œå†è°ƒç”¨<code>ViewGroup#addView(...)</code>ç³»åˆ—æ–¹æ³•æŠŠviewæ·»åŠ åˆ°ViewGroupä¸­ã€‚æˆ‘ä»¬å‘ç°TabLayoutçš„<code>addView(...)</code>ç³»åˆ—æ–¹æ³•ï¼Œéƒ½åˆ å»superè°ƒç”¨ï¼Œä¸”è°ƒç”¨äº†å…±åŒçš„ä¸€ä¸ªæ–¹æ³•ï¼Œ<code>addViewInternal(View view)</code>ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private void addViewInternal(final View child) &#123;</div><div class="line">    if (child instanceof TabItem) &#123;</div><div class="line">        addTabFromItemView((TabItem) child);</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new IllegalArgumentException("Only TabItem instances can be added to TabLayout");</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯è§ï¼Œè‹¥childé<code>TabItem</code>å¯¹è±¡ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥xmlä¸­ç»™TabLayoutæ·»åŠ tabæ—¶ï¼Œåªèƒ½æ·»åŠ <code>TabItem</code>å¯¹è±¡ã€‚è‹¥æƒ³æ·»åŠ å…¶å®ƒViewç±»å‹æ€ä¹ˆåŠï¼ŸTabItemæœ‰<code>android:customView</code>è¿™ä¸ªå±æ€§ã€‚æˆ‘ä»¬ç»§ç»­æ¥çœ‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTabFromItemView</span><span class="params">(@NonNull TabItem item)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Tab tab = newTab();</div><div class="line">    <span class="keyword">if</span> (item.mText != <span class="keyword">null</span>) &#123;</div><div class="line">        tab.setText(item.mText);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (item.mIcon != <span class="keyword">null</span>) &#123;</div><div class="line">        tab.setIcon(item.mIcon);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (item.mCustomLayout != <span class="number">0</span>) &#123;</div><div class="line">        tab.setCustomView(item.mCustomLayout);</div><div class="line">    &#125;</div><div class="line">    addTab(tab);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Tab <span class="title">newTab</span><span class="params">()</span> </span>&#123;</div><div class="line">    Tab tab = sTabPool.acquire();</div><div class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span>) &#123;</div><div class="line">        tab = <span class="keyword">new</span> Tab();</div><div class="line">    &#125;</div><div class="line">    tab.mParent = <span class="keyword">this</span>;</div><div class="line">    tab.mView = createTabView(tab);</div><div class="line">    <span class="keyword">return</span> tab;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> TabView <span class="title">createTabView</span><span class="params">(@NonNull <span class="keyword">final</span> Tab tab)</span> </span>&#123;</div><div class="line">    TabView tabView = mTabViewPool != <span class="keyword">null</span> ? mTabViewPool.acquire() : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (tabView == <span class="keyword">null</span>) &#123;</div><div class="line">        tabView = <span class="keyword">new</span> TabView(getContext());</div><div class="line">    &#125;</div><div class="line">    tabView.setTab(tab);</div><div class="line">    tabView.setFocusable(<span class="keyword">true</span>);</div><div class="line">    tabView.setMinimumWidth(getTabMinWidth());</div><div class="line">    <span class="keyword">return</span> tabView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œè°ƒ<code>newTab()</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªtabå¯¹è±¡ï¼Œå¹¶ä¸”ç”¨å¯¹è±¡æ± æŠŠåˆ›å»ºçš„tabå¯¹è±¡ç¼“å­˜èµ·æ¥ã€‚ç„¶åå°†<code>TabItem</code>å¯¹è±¡çš„å±æ€§éƒ½èµ‹å€¼ç»™tabå¯¹è±¡ã€‚åœ¨<code>createTabView(Tab tab)</code>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé¦–å…ˆä»<code>TabView</code>æ± ä¸­è·å–<code>TabView</code>å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶è°ƒç”¨<code>tabView.setTab(tab)</code>æ–¹æ³•æ¥è¿›è¡Œäº†æ•°æ®ç»‘å®šã€‚ <code>addTab(...)</code>æœ‰ä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTab</span><span class="params">(@NonNull Tab tab, <span class="keyword">boolean</span> setSelected)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (tab.mParent != <span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Tab belongs to a different TabLayout."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    addTabView(tab, setSelected);</div><div class="line">    configureTab(tab, mTabs.size());</div><div class="line">    <span class="keyword">if</span> (setSelected) &#123;</div><div class="line">        tab.select();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTabView</span><span class="params">(Tab tab, <span class="keyword">int</span> position, <span class="keyword">boolean</span> setSelected)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> TabView tabView = tab.mView;</div><div class="line">    mTabStrip.addView(tabView, position, createLayoutParamsForTabs());</div><div class="line">    <span class="keyword">if</span> (setSelected) &#123;</div><div class="line">        tabView.setSelected(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureTab</span><span class="params">(Tab tab, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    tab.setPosition(position);</div><div class="line">    mTabs.add(position, tab);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mTabs.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = position + <span class="number">1</span>; i &lt; count; i++) &#123;</div><div class="line">        mTabs.get(i).setPosition(i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>addView(Tab, int, boolean)</code>æ–¹æ³•ä¸­ï¼ŒæŠŠ<code>TabView</code>å¯¹è±¡addè¿›äº†<code>SlidingTabStrip</code>è¿™ä¸ª<code>ViewGroup</code>ä¸­ã€‚å®é™…ä¸Š<code>SlidingTabStrip</code>çš„å¯¹è±¡<code>mTabStrip</code>æ‰æ˜¯<code>TabLayout</code>çš„å”¯ä¸€å­View.åœ¨<code>TabLayout</code>çš„æ„é€ æ–¹æ³•ä¸­:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TabLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    <span class="comment">// ç¦ç”¨æ¨ªå‘æ»‘åŠ¨æ¡</span></div><div class="line">    setHorizontalScrollBarEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// new ä¸€ä¸ª'SlidingTabStrip'çš„å®ä¾‹ï¼Œå¹¶ä½œä¸ºå”¯ä¸€çš„å­View addè¿›'TabLayout'.</span></div><div class="line">    mTabStrip = <span class="keyword">new</span> SlidingTabStrip(context);</div><div class="line">    <span class="keyword">super</span>.addView(mTabStrip, <span class="number">0</span>, <span class="keyword">new</span> HorizontalScrollView.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT));</div><div class="line"></div><div class="line">    <span class="comment">// çœç•¥ä¸‹é¢çš„æ— å…³ä»£ç ...</span></div><div class="line">ï½</div></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æ˜ç™½äº†<code>TabLayout</code>ä¸­å­Viewçš„ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ã€‚ä¹Ÿæ˜ç™½äº†<code>TabView</code>å…¶å®æ‰æ˜¯äº²ç”Ÿçš„ï¼Œ<code>TabItem</code>å…¶å®æ˜¯åå¨˜å…»çš„! è¿™äº›ä»£ç éƒ½å¾ˆç®€å•ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä»ä¸­å­¦ä¹ åˆ°å¾ˆå¤šæœ‰ç”¨çš„æ€æƒ³ã€‚</p>
<p>è‡³æ­¤ï¼Œä¸€ä¸ªæ¸…æ™°çš„<code>View</code>å±‚çº§å›¾åº”è¯¥å°±å‡ºç°åœ¨äº†å„ä½åŒå­¦çš„çœ¼å‰ã€‚<br><img src="../assets/hierarchy.png" alt="TabLayout Hierarchy"></p>
<h4 id="3-2-2-ä¸ViewPageræ­é…ä½¿ç”¨"><a href="#3-2-2-ä¸ViewPageræ­é…ä½¿ç”¨" class="headerlink" title="3.2.2 ä¸ViewPageræ­é…ä½¿ç”¨"></a>3.2.2 ä¸ViewPageræ­é…ä½¿ç”¨</h4><p>æœ‰äº†ä¸Šé¢çš„çš„åŸºç¡€ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹<code>TabLayout</code>æ˜¯å¦‚ä½•å’Œå®ƒçš„å¥½åŸºå‹<code>ViewPager</code>æ­é…ä½¿ç”¨çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setupWithViewPager</span><span class="params">(@Nullable <span class="keyword">final</span> ViewPager viewPager)</span> </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="comment">//ä¸ºç†è§£ç®€å•èµ·è§ï¼Œåˆ æ‰è¾¹è§’æ€§å¹²æ‰°ä»£ç ï¼Œä¸»è¦æ¥çœ‹æ ¸å¿ƒé€»è¾‘</span></div><div class="line"></div><div class="line">    mViewPager = viewPager;</div><div class="line"></div><div class="line">    <span class="comment">// Add our custom OnPageChangeListener to the ViewPager</span></div><div class="line">    <span class="keyword">if</span> (mPageChangeListener == <span class="keyword">null</span>) &#123;</div><div class="line">        mPageChangeListener = <span class="keyword">new</span> TabLayoutOnPageChangeListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    mPageChangeListener.reset();</div><div class="line">    viewPager.addOnPageChangeListener(mPageChangeListener);</div><div class="line"></div><div class="line">    <span class="comment">// Now we'll add a tab selected listener to set ViewPager's current item</span></div><div class="line">    setOnTabSelectedListener(<span class="keyword">new</span> ViewPagerOnTabSelectedListener(viewPager));</div><div class="line"></div><div class="line">    <span class="comment">// Now we'll populate ourselves from the pager adapter</span></div><div class="line">    setPagerAdapter(adapter, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnTabSelectedListener</span><span class="params">(OnTabSelectedListener onTabSelectedListener)</span> </span>&#123;</div><div class="line">    mOnTabSelectedListener = onTabSelectedListener;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPagerAdapter</span><span class="params">(@Nullable <span class="keyword">final</span> PagerAdapter adapter, <span class="keyword">final</span> <span class="keyword">boolean</span> addObserver)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mPagerAdapter != <span class="keyword">null</span> &amp;&amp; mPagerAdapterObserver != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// If we already have a PagerAdapter, unregister our observer</span></div><div class="line">        mPagerAdapter.unregisterDataSetObserver(mPagerAdapterObserver);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mPagerAdapter = adapter;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (addObserver &amp;&amp; adapter != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Register our observer on the new adapter</span></div><div class="line">        <span class="keyword">if</span> (mPagerAdapterObserver == <span class="keyword">null</span>) &#123;</div><div class="line">            mPagerAdapterObserver = <span class="keyword">new</span> PagerAdapterObserver();</div><div class="line">        &#125;</div><div class="line">        adapter.registerDataSetObserver(mPagerAdapterObserver);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Finally make sure we reflect the new adapter</span></div><div class="line">    populateFromPagerAdapter();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„<code>TabLayoutOnPageChangeListener</code>å®ç°äº†<code>ViewPager.OnPageChangeListener</code>. é¦–å…ˆè°ƒç”¨<code>ViewPager</code>å¯¹è±¡<code>addOnPageChangeListener(OnPageChangeListener)</code>æ¥ç›‘å¬<code>ViewPager</code>çš„æ»‘åŠ¨ä»¥åŠå½“å‰ä¹Ÿçš„é€‰ä¸­ã€‚ç„¶åè®¾ç½®<code>ViewPagerOnTabSelectedListener</code>å¯¹è±¡ï¼Œä¿è¯ViewPagerçš„é¡µé¢å’ŒTabLayoutçš„itemçš„é€‰ä¸­çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œä»¥åŠæ»šåŠ¨çš„ååŒæ€§ã€‚è¿™é‡Œçš„ç›‘å¬åœ¨3.2.3ä¸­è¯¦ç»†è®²è§£ã€‚</p>
<p>æˆ‘ä»¬ä¸€èˆ¬è°ƒç”¨<code>viewPager.getAdapter().notifyDataSetChanged()</code>æ¥è¿›è¡ŒViewPagerçš„åˆ·æ–°. ç°åœ¨æˆ‘ä»¬åœ¨ViewPagerçš„adapterä¸­æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬<code>ViewPager</code>çš„åˆ·æ–°è¡Œä¸ºã€‚ç›®çš„æ˜¯ä¸ºäº†åˆ·æ–°<code>ViewPager</code>çš„åŒæ—¶ä¹Ÿå¯ä»¥åˆ·æ–°TabLayout. æˆ‘ä»¬æ¥çœ‹çœ‹<code>PagerAdapterObserver</code>è¿™ä¸ªç›‘å¬å™¨æ˜¯å¦‚ä½•åˆ·æ–°TabLayoutçš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PagerAdapterObserver</span> <span class="keyword">extends</span> <span class="title">DataSetObserver</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">        populateFromPagerAdapter();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">()</span> </span>&#123;</div><div class="line">        populateFromPagerAdapter();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">populateFromPagerAdapter</span><span class="params">()</span> </span>&#123;</div><div class="line">    removeAllTabs();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mPagerAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> adapterCount = mPagerAdapter.getCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; adapterCount; i++) &#123;</div><div class="line">            addTab(newTab().setText(mPagerAdapter.getPageTitle(i)), <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make sure we reflect the currently set ViewPager item</span></div><div class="line">        <span class="keyword">if</span> (mViewPager != <span class="keyword">null</span> &amp;&amp; adapterCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> curItem = mViewPager.getCurrentItem();</div><div class="line">            <span class="keyword">if</span> (curItem != getSelectedTabPosition() &amp;&amp; curItem &lt; getTabCount()) &#123;</div><div class="line">                selectTab(getTabAt(curItem));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        removeAllTabs();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAllTabs</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Remove all the views</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mTabStrip.getChildCount() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        removeTabViewAt(i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;Tab&gt; i = mTabs.iterator(); i.hasNext();) &#123;</div><div class="line">        <span class="keyword">final</span> Tab tab = i.next();</div><div class="line">        i.remove();</div><div class="line">        tab.reset();</div><div class="line">        sTabPool.release(tab);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mSelectedTab = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åˆ·æ–°æ–¹å¼å¾ˆç®€å•ç²—æš´ï¼Œä»<code>SlidingTabStrip</code>å¯¹è±¡ä¸­ç§»é™¤æ‰€æœ‰çš„<code>TabView</code>ï¼Œç»§è€Œä»View Model<code>mTabs</code>ä¸­ç§»é™¤æ‰€æœ‰<code>Tab</code>å¯¹è±¡ã€‚ç„¶åä»adapterä¸­è·å–tabä¿¡æ¯ï¼Œå¾ªç¯è°ƒç”¨<code>addTab(Tab, boolean)</code>æ–¹æ³•é‡æ–°æ·»åŠ <code>TabView</code>ã€‚æœ€åè°ƒç”¨<code>ViewPager</code>å¯¹è±¡çš„<code>getCurrentItem()</code>æ–¹æ³•ï¼Œè·å–å½“å‰ä½ç½®ï¼Œç„¶åè°ƒç”¨selectTab(int position)æ¢å¤<code>TabView</code>çš„é€‰ä¸­çŠ¶æ€ï¼ˆé’ˆå¯¹TabViewçš„é€‰ä¸­ï¼Œ3.2.4ä¸­æœ‰è¯¦ç»†ä»‹ç»)ã€‚</p>
<h4 id="3-2-3-ViewPagerä¸TabLayoutçš„TabåŠindicaotrååŒæ»šåŠ¨"><a href="#3-2-3-ViewPagerä¸TabLayoutçš„TabåŠindicaotrååŒæ»šåŠ¨" class="headerlink" title="3.2.3 ViewPagerä¸TabLayoutçš„TabåŠindicaotrååŒæ»šåŠ¨"></a>3.2.3 ViewPagerä¸TabLayoutçš„TabåŠindicaotrååŒæ»šåŠ¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TabLayoutOnPageChangeListener</span> <span class="keyword">implements</span> <span class="title">ViewPager</span>.<span class="title">OnPageChangeListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;TabLayout&gt; mTabLayoutRef;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPreviousScrollState;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mScrollState;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TabLayoutOnPageChangeListener</span><span class="params">(TabLayout tabLayout)</span> </span>&#123;</div><div class="line">        mTabLayoutRef = <span class="keyword">new</span> WeakReference&lt;&gt;(tabLayout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</div><div class="line">        mPreviousScrollState = mScrollState;</div><div class="line">        mScrollState = state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> TabLayout tabLayout = mTabLayoutRef.get();</div><div class="line">        <span class="keyword">if</span> (tabLayout != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Only update the text selection if we're not settling, or we are settling after</span></div><div class="line">            <span class="comment">// being dragged</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> updateText = mScrollState != SCROLL_STATE_SETTLING ||</div><div class="line">                    mPreviousScrollState == SCROLL_STATE_DRAGGING;</div><div class="line">            <span class="comment">// Update the indicator if we're not settling after being idle. This is caused</span></div><div class="line">            <span class="comment">// from a setCurrentItem() call and will be handled by an animation from</span></div><div class="line">            <span class="comment">// onPageSelected() instead.</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> updateIndicator = !(mScrollState == SCROLL_STATE_SETTLING</div><div class="line">                    &amp;&amp; mPreviousScrollState == SCROLL_STATE_IDLE);</div><div class="line">            tabLayout.setScrollPosition(position, positionOffset, updateText, updateIndicator);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> TabLayout tabLayout = mTabLayoutRef.get();</div><div class="line">        <span class="keyword">if</span> (tabLayout != <span class="keyword">null</span> &amp;&amp; tabLayout.getSelectedTabPosition() != position) &#123;</div><div class="line">            <span class="comment">// Select the tab, only updating the indicator if we're not being dragged/settled</span></div><div class="line">            <span class="comment">// (since onPageScrolled will handle that).</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> updateIndicator = mScrollState == SCROLL_STATE_IDLE</div><div class="line">                    || (mScrollState == SCROLL_STATE_SETTLING</div><div class="line">                    &amp;&amp; mPreviousScrollState == SCROLL_STATE_IDLE);</div><div class="line">            tabLayout.selectTab(tabLayout.getTabAt(position), updateIndicator);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</div><div class="line">        mPreviousScrollState = mScrollState = SCROLL_STATE_IDLE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”¨è¿‡<code>ViewPager</code>çš„åŒå­¦å¯¹<code>OnPageChangeListener</code>ä¸ä¼šé™Œç”Ÿï¼Œä¸å¤šèµ˜è¿°ã€‚<code>TabLayoutOnPageChangeListener</code>å®ç°äº†<code>OnPageChangeListener</code>, åœ¨<code>onPageScrolled(...)</code>æ–¹æ³•ä¸­åšååŒæ»šåŠ¨å¤„ç†ã€‚æ»šåŠ¨çš„æ¡ä»¶æ˜¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> updateIndicator = !(mScrollState == SCROLL_STATE_SETTLING &amp;&amp; mPreviousScrollState == SCROLL_STATE_IDLE);</div></pre></td></tr></table></figure></p>
<p>è°ƒç”¨<code>TabLayoutçš„setScrollPosition(...)</code>æ–¹æ³•æ¥æ§åˆ¶<code>TabLayout</code>ä¸­<code>TabView</code>å’Œindocatorçš„ååŒæ»šåŠ¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setScrollPosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">boolean</span> updateSelectedText, <span class="keyword">boolean</span> updateIndicatorPosition)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> roundedPosition = Math.round(position + positionOffset);</div><div class="line">    <span class="keyword">if</span> (roundedPosition &lt; <span class="number">0</span> || roundedPosition &gt;= mTabStrip.getChildCount()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set the indicator position, if enabled</span></div><div class="line">    <span class="keyword">if</span> (updateIndicatorPosition) &#123;</div><div class="line">        mTabStrip.setIndicatorPositionFromTabPosition(position, positionOffset);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Now update the scroll position, canceling any running animation</span></div><div class="line">    <span class="keyword">if</span> (mScrollAnimator != <span class="keyword">null</span> &amp;&amp; mScrollAnimator.isRunning()) &#123;</div><div class="line">        mScrollAnimator.cancel();</div><div class="line">    &#125;</div><div class="line">    scrollTo(calculateScrollXForTab(position, positionOffset), <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Update the 'selected state' view as we scroll, if enabled</span></div><div class="line">    <span class="keyword">if</span> (updateSelectedText) &#123;</div><div class="line">        setSelectedTabView(roundedPosition);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="3-2-3-1-TabLayoutçš„IndicatorååŒæ»šåŠ¨"><a href="#3-2-3-1-TabLayoutçš„IndicatorååŒæ»šåŠ¨" class="headerlink" title="3.2.3.1 TabLayoutçš„IndicatorååŒæ»šåŠ¨"></a>3.2.3.1 TabLayoutçš„IndicatorååŒæ»šåŠ¨</h5><p>indicatorçš„æ»šåŠ¨ç”±SlidingTabStripæ¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Set the indicator position, if enabled</span></div><div class="line"><span class="keyword">if</span> (updateIndicatorPosition) &#123;</div><div class="line">    mTabStrip.setIndicatorPositionFromTabPosition(position, positionOffset);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>position</code>æ˜¯å½“å‰é€‰ä¸­çš„ä½ç½®ã€‚<code>positionOffset</code>æ˜¯: <code>è·å½“å‰Tabæ»‘åŠ¨çš„è·ç¦»</code>ï¼<code>ä»å½“å‰tabæ»‘åŠ¨åˆ°ä¸‹ä¸€ä¸ªtabçš„æ€»è·ç¦»</code> è¿™æ ·ä¸€ä¸ªèŒƒå›´åœ¨ï¼»0ï¼Œ1ï¼½é—´çš„å°æ•°ã€‚</p>
<p>SlidingTabStrip#setIndicatorPositionFromTabPosition(int, float)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setIndicatorPositionFromTabPosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mIndicatorAnimator != <span class="keyword">null</span> &amp;&amp; mIndicatorAnimator.isRunning()) &#123;</div><div class="line">        mIndicatorAnimator.cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mSelectedPosition = position;</div><div class="line">    mSelectionOffset = positionOffset;</div><div class="line">    updateIndicatorPosition();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SlidingTabStrip#updateIndicatorPosition()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateIndicatorPosition</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> View selectedTitle = getChildAt(mSelectedPosition);</div><div class="line">    <span class="keyword">int</span> left, right;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (selectedTitle != <span class="keyword">null</span> &amp;&amp; selectedTitle.getWidth() &gt; <span class="number">0</span>) &#123;</div><div class="line">        left = selectedTitle.getLeft();</div><div class="line">        right = selectedTitle.getRight();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSelectionOffset &gt; <span class="number">0f</span> &amp;&amp; mSelectedPosition &lt; getChildCount() - <span class="number">1</span>) &#123;</div><div class="line">            <span class="comment">// Draw the selection partway between the tabs</span></div><div class="line">            View nextTitle = getChildAt(mSelectedPosition + <span class="number">1</span>);</div><div class="line">            left = (<span class="keyword">int</span>) (mSelectionOffset * nextTitle.getLeft() +</div><div class="line">                    (<span class="number">1.0f</span> - mSelectionOffset) * left);</div><div class="line">            right = (<span class="keyword">int</span>) (mSelectionOffset * nextTitle.getRight() +</div><div class="line">                    (<span class="number">1.0f</span> - mSelectionOffset) * right);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        left = right = -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setIndicatorPosition(left, right);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡<code>getChildAt(mSelectedPosition)</code>, è·å–åˆ°åˆ°<code>mSelectedPosition</code>å¤„çš„TabViewã€‚è‹¥æ»‘åŠ¨çš„<code>mSelectionOffset&gt;0f</code>ä¸”å½“å‰é€‰ä¸­çš„ä½ç½®<code>mSelectedPosition</code>ä¸æ˜¯æœ€åä¸€ä¸ªTabView. è·å–åˆ°ä¸‹ä¸€ä¸ªTabViewï¼Œå¹¶è®¡ç®—å‡ºindicatorçš„leftå’Œrightã€‚</p>
<p>SlidingTabStripï¼ƒsetIndicatorPosition(int, int)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIndicatorPosition</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (left != mIndicatorLeft || right != mIndicatorRight) &#123;</div><div class="line">        <span class="comment">// If the indicator's left/right has changed, invalidate</span></div><div class="line">        mIndicatorLeft = left;</div><div class="line">        mIndicatorRight = right;</div><div class="line">        ViewCompat.postInvalidateOnAnimation(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>éå¸¸ç®€å•çš„ä»£ç ï¼Œåœ¨è°ƒç”¨<code>ViewCompat.postInvalidateOnAnimation(this)</code>é‡ç»˜Viewä¹‹å‰ï¼Œå»æ‰ä¸€äº›é‡å¤ç»˜åˆ¶çš„å¸§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">    <span class="comment">// Thick colored underline below the current selection</span></div><div class="line">    <span class="keyword">if</span> (mIndicatorLeft &gt;= <span class="number">0</span> &amp;&amp; mIndicatorRight &gt; mIndicatorLeft) &#123;</div><div class="line">        canvas.drawRect(mIndicatorLeft, getHeight() - mSelectedIndicatorHeight,</div><div class="line">                mIndicatorRight, getHeight(), mSelectedIndicatorPaint);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»˜åˆ¶é€»è¾‘å¾ˆç®€å•ã€‚è°ƒç”¨<code>canvas.drawRect(float left, float top, float right, float bottom, Paint paint)</code>æ¥ç»˜åˆ¶indicator.è¿™é‡Œï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">left = mIndicatorLeft;</div><div class="line">top = getHeight() - mSelectedIndicatorHeight;</div><div class="line">right = mIndicatorRight;</div><div class="line">bottom = getHeight();</div></pre></td></tr></table></figure></p>
<h5 id="3-2-3-2-TabLayoutçš„TabViewååŒæ»šåŠ¨"><a href="#3-2-3-2-TabLayoutçš„TabViewååŒæ»šåŠ¨" class="headerlink" title="3.2.3.2 TabLayoutçš„TabViewååŒæ»šåŠ¨"></a>3.2.3.2 TabLayoutçš„TabViewååŒæ»šåŠ¨</h5><p>æˆ‘ä»¬å›å¤´æ¥çœ‹ 3.2.3ä¸­<code>setScrollPosition(...)</code>æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setScrollPosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">boolean</span> updateSelectedText, <span class="keyword">boolean</span> updateIndicatorPosition)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> roundedPosition = Math.round(position + positionOffset);</div><div class="line">    <span class="keyword">if</span> (roundedPosition &lt; <span class="number">0</span> || roundedPosition &gt;= mTabStrip.getChildCount()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set the indicator position, if enabled</span></div><div class="line">    <span class="keyword">if</span> (updateIndicatorPosition) &#123;</div><div class="line">        mTabStrip.setIndicatorPositionFromTabPosition(position, positionOffset);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Now update the scroll position, canceling any running animation</span></div><div class="line">    <span class="keyword">if</span> (mScrollAnimator != <span class="keyword">null</span> &amp;&amp; mScrollAnimator.isRunning()) &#123;</div><div class="line">        mScrollAnimator.cancel();</div><div class="line">    &#125;</div><div class="line">    scrollTo(calculateScrollXForTab(position, positionOffset), <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Update the 'selected state' view as we scroll, if enabled</span></div><div class="line">    <span class="keyword">if</span> (updateSelectedText) &#123;</div><div class="line">        setSelectedTabView(roundedPosition);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨3.2.3.1ä¸­æˆ‘ä»¬çŸ¥é“indicatorçš„æ»šåŠ¨æ˜¯é€šè¿‡<code>mTabStrip.setIndicatorPositionFromTabPosition(position, positionOffset)</code>å®ç°çš„ã€‚é‚£TabViewçš„æ»šåŠ¨å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“<code>TabLayout</code>æ˜¯ç»§æ‰¿<code>HorizonScrollView</code>å¤©ç”Ÿå°±æ˜¯ä¸€ä¸ªå¯ä»¥æ¨ªè¡Œæ»šåŠ¨çš„<code>View</code>ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨<code>scrollTo(int x, int y)</code>æ–¹æ³•å°±å¯ä»¥å®ç°æ¨ªå‘æ»šåŠ¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scrollTo(calculateScrollXForTab(position, positionOffset), <span class="number">0</span>);</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œxæ–¹å‘çš„åç§»é‡è°ƒç”¨<code>calculateScrollXForTab(position, positionOffset)</code>å®æ—¶è®¡ç®—å¾—å‡ºï¼Œyæ–¹å‘çš„åç§»é‡ä¸º0ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">calculateScrollXForTab</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mMode == MODE_SCROLLABLE) &#123;</div><div class="line">        <span class="keyword">final</span> View selectedChild = mTabStrip.getChildAt(position);</div><div class="line">        <span class="keyword">final</span> View nextChild = position + <span class="number">1</span> &lt; mTabStrip.getChildCount()</div><div class="line">                ? mTabStrip.getChildAt(position + <span class="number">1</span>)</div><div class="line">                : <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> selectedWidth = selectedChild != <span class="keyword">null</span> ? selectedChild.getWidth() : <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nextWidth = nextChild != <span class="keyword">null</span> ? nextChild.getWidth() : <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> selectedChild.getLeft()</div><div class="line">                + ((<span class="keyword">int</span>) ((selectedWidth + nextWidth) * positionOffset * <span class="number">0.5f</span>))</div><div class="line">                + (selectedChild.getWidth() / <span class="number">2</span>)</div><div class="line">                - (getWidth() / <span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æ˜ç™½äº†<code>TabLayout</code>æ˜¯å¦‚ä½•éš<code>ViewPager</code>çš„æ»šåŠ¨è€Œæ»šåŠ¨çš„ã€‚</p>
<h3 id="3-2-4-Tabé€‰ä¸­çŠ¶æ€"><a href="#3-2-4-Tabé€‰ä¸­çŠ¶æ€" class="headerlink" title="3.2.4 Tabé€‰ä¸­çŠ¶æ€"></a>3.2.4 Tabé€‰ä¸­çŠ¶æ€</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSelectedTabView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tabCount = mTabStrip.getChildCount();</div><div class="line">    <span class="keyword">if</span> (position &lt; tabCount &amp;&amp; !mTabStrip.getChildAt(position).isSelected()) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tabCount; i++) &#123;</div><div class="line">            <span class="keyword">final</span> View child = mTabStrip.getChildAt(i);</div><div class="line">            child.setSelected(i == position);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨Viewçš„<code>setSelected(boolean)</code>æ–¹æ³•ã€‚</p>
<h2 id="4-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"><a href="#4-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨" class="headerlink" title="4. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"></a>4. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨</h2><p>å¼€æºé¡¹ç›®ä¸­ä½¿ç”¨TabLayoutçš„ä¾‹å­ç‰¹åˆ«å¤š, è¿™é‡Œç»™å‡ºæˆ‘å†™çš„ä¸€ä¸ªé¡¹ç›®ï¼š</p>
<ul>
<li><a href="https://github.com/Aspsine/SwipeToLoadLayout" target="_blank" rel="external">SwipeToLoadLayout</a>çš„demo</li>
</ul>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>SwipeRefreshLayoutæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/SwipeRefreshLayout%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/SwipeRefreshLayoutæºç åˆ†æ/</id>
    <published>2017-07-26T12:04:43.000Z</published>
    <updated>2017-07-26T12:05:30.578Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><a href="http://developer.android.com/intl/zh-cn/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a></p>
<p><code>SwipeRefreshLayout</code> æ˜¯ä¸€ä¸ªä¸‹æ‹‰åˆ·æ–°æ§ä»¶ï¼Œå‡ ä¹å¯ä»¥åŒ…è£¹ä¸€ä¸ªä»»ä½•å¯ä»¥æ»šåŠ¨çš„å†…å®¹ï¼ˆListView GridView ScrollView RecyclerViewï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«å‚ç›´æ»šåŠ¨æ‰‹åŠ¿ã€‚ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p>
<p><img src="images/SwipeRefreshLayout1" alt=""> <img src="images/SwipeRefreshLayout2" alt=""></p>
<p> 1.å°†éœ€è¦ä¸‹æ‹‰åˆ·æ–°çš„ç©ºé—´åŒ…è£¹èµ·æ¥</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.SwipeRefreshLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/recyclerView"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p> 2.è®¾ç½®åˆ·æ–°åŠ¨ç”»çš„è§¦å‘å›è°ƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è®¾ç½®ä¸‹æ‹‰å‡ºç°å°åœ†åœˆæ˜¯å¦æ˜¯ç¼©æ”¾å‡ºç°ï¼Œå‡ºç°çš„ä½ç½®ï¼Œæœ€å¤§çš„ä¸‹æ‹‰ä½ç½®</span></div><div class="line">mySwipeRefreshLayout.setProgressViewOffset(<span class="keyword">true</span>, <span class="number">50</span>, <span class="number">200</span>);</div><div class="line"></div><div class="line"><span class="comment">//è®¾ç½®ä¸‹æ‹‰åœ†åœˆçš„å¤§å°ï¼Œä¸¤ä¸ªå€¼ LARGEï¼Œ DEFAULT</span></div><div class="line">mySwipeRefreshLayout.setSize(SwipeRefreshLayout.LARGE);</div><div class="line"></div><div class="line"><span class="comment">// è®¾ç½®ä¸‹æ‹‰åœ†åœˆä¸Šçš„é¢œè‰²ï¼Œè“è‰²ã€ç»¿è‰²ã€æ©™è‰²ã€çº¢è‰²</span></div><div class="line">mySwipeRefreshLayout.setColorSchemeResources(</div><div class="line">    android.R.color.holo_blue_bright,</div><div class="line">    android.R.color.holo_green_light,</div><div class="line">    android.R.color.holo_orange_light,</div><div class="line">    android.R.color.holo_red_light);</div><div class="line"></div><div class="line"><span class="comment">// é€šè¿‡ setEnabled(false) ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°</span></div><div class="line">mySwipeRefreshLayout.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="comment">// è®¾å®šä¸‹æ‹‰åœ†åœˆçš„èƒŒæ™¯</span></div><div class="line">mSwipeLayout.setProgressBackgroundColor(R.color.red);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * è®¾ç½®æ‰‹åŠ¿ä¸‹æ‹‰åˆ·æ–°çš„ç›‘å¬</div><div class="line"> */</div><div class="line">mySwipeRefreshLayout.setOnRefreshListener(</div><div class="line">    <span class="keyword">new</span> SwipeRefreshLayout.OnRefreshListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// åˆ·æ–°åŠ¨ç”»å¼€å§‹åå›è°ƒåˆ°æ­¤æ–¹æ³•</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>setRefreshing(false)</code> å’Œ <code>setRefreshing(true)</code> æ¥æ‰‹åŠ¨è°ƒç”¨åˆ·æ–°çš„åŠ¨ç”»ã€‚</p>
<blockquote>
<p><code>onRefresh</code> çš„å›è°ƒåªæœ‰åœ¨æ‰‹åŠ¿ä¸‹æ‹‰çš„æƒ…å†µä¸‹æ‰ä¼šè§¦å‘ï¼Œé€šè¿‡ <code>setRefreshing</code> åªèƒ½è°ƒç”¨åˆ·æ–°çš„åŠ¨ç”»æ˜¯å¦æ˜¾ç¤ºã€‚<br>SwipeRefreshLayout ä¹Ÿå¯æ”¾åœ¨ CoordinatorLayout å†…å…±åŒå¤„ç†æ»‘åŠ¨å†²çªï¼Œæœ‰å…´è¶£å¯ä»¥å°è¯•ã€‚</p>
</blockquote>
<h2 id="SwipeRefreshLayout-æºç åˆ†æ"><a href="#SwipeRefreshLayout-æºç åˆ†æ" class="headerlink" title="SwipeRefreshLayout æºç åˆ†æ"></a>SwipeRefreshLayout æºç åˆ†æ</h2><blockquote>
<p>æœ¬æ–‡åŸºäº v4 ç‰ˆæœ¬ <code>23.2.0</code></p>
</blockquote>
<p>extends <code>ViewGroup</code> implements <code>NestedScrollingParent</code> <code>NestedScrollingChild</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">   â†³	android.view.View</div><div class="line"> 	   â†³	android.view.ViewGroup</div><div class="line"> 	 	   â†³	android.support.v4.widget.SwipeRefreshLayout</div></pre></td></tr></table></figure></p>
<p>SwipeRefreshLayout çš„åˆ†æåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>è‡ªå®šä¹‰ ViewGroup çš„éƒ¨åˆ†</strong>ï¼Œ<strong>å¤„ç†å’Œå­è§†å›¾çš„åµŒå¥—æ»šåŠ¨éƒ¨åˆ†</strong>ã€‚</p>
<h3 id="SwipeRefreshLayout-extends-ViewGroup"><a href="#SwipeRefreshLayout-extends-ViewGroup" class="headerlink" title="SwipeRefreshLayout extends ViewGroup"></a>SwipeRefreshLayout extends ViewGroup</h3><p>å…¶å®å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ ViewGroup ï¼Œç»“åˆæˆ‘ä»¬è‡ªå·±å¹³æ—¶è‡ªå®šä¹‰ ViewGroup çš„æ­¥éª¤ï¼š</p>
<ol>
<li>åˆå§‹åŒ–å˜é‡</li>
<li>onMeasure</li>
<li>onLayout</li>
<li>å¤„ç†äº¤äº’ ï¼ˆ<code>dispatchTouchEvent</code> <code>onInterceptTouchEvent</code> <code>onTouchEvent</code>ï¼‰</li>
</ol>
<p>æ¥ä¸‹æ¥å°±æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œåˆ†æã€‚</p>
<h4 id="1-åˆå§‹åŒ–å˜é‡"><a href="#1-åˆå§‹åŒ–å˜é‡" class="headerlink" title="1.åˆå§‹åŒ–å˜é‡"></a>1.åˆå§‹åŒ–å˜é‡</h4><p><code>SwipeRefreshLayout</code> å†…éƒ¨æœ‰ 2 ä¸ª Viewï¼Œä¸€ä¸ª<code>åœ†åœˆï¼ˆmCircleViewï¼‰</code>ï¼Œä¸€ä¸ªå†…éƒ¨å¯æ»šåŠ¨çš„<code>Viewï¼ˆmTargetï¼‰</code>ã€‚é™¤äº† Viewï¼Œè¿˜åŒ…å«ä¸€ä¸ª <code>OnRefreshListener</code> æ¥å£ï¼Œå½“åˆ·æ–°åŠ¨ç”»è¢«è§¦å‘æ—¶å›è°ƒã€‚</p>
<p> <img src="https://dn-coding-net-production-pp.qbox.me/8e02212d-b364-4df8-bfaa-47f3084f89e7.png" alt="å›¾ç‰‡"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Constructor that is called when inflating SwipeRefreshLayout from XML.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> context</div><div class="line"> * <span class="doctag">@param</span> attrs</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SwipeRefreshLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line"></div><div class="line">    <span class="comment">// ç³»ç»Ÿé»˜è®¤çš„æœ€å°æ»šåŠ¨è·ç¦»</span></div><div class="line">    mTouchSlop = ViewConfiguration.get(context).getScaledTouchSlop();</div><div class="line"></div><div class="line">    <span class="comment">// ç³»ç»Ÿé»˜è®¤çš„åŠ¨ç”»æ—¶é•¿</span></div><div class="line">    mMediumAnimationDuration = getResources().getInteger(</div><div class="line">            android.R.integer.config_mediumAnimTime);</div><div class="line"></div><div class="line">    setWillNotDraw(<span class="keyword">false</span>);</div><div class="line">    mDecelerateInterpolator = <span class="keyword">new</span> DecelerateInterpolator(DECELERATE_INTERPOLATION_FACTOR);</div><div class="line"></div><div class="line">    <span class="comment">// è·å– xml ä¸­å®šä¹‰çš„å±æ€§</span></div><div class="line">    <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(attrs, LAYOUT_ATTRS);</div><div class="line">    setEnabled(a.getBoolean(<span class="number">0</span>, <span class="keyword">true</span>));</div><div class="line">    a.recycle();</div><div class="line"></div><div class="line">    <span class="comment">// åˆ·æ–°çš„åœ†åœˆçš„å¤§å°ï¼Œå•ä½è½¬æ¢æˆ sp</span></div><div class="line">    <span class="keyword">final</span> DisplayMetrics metrics = getResources().getDisplayMetrics();</div><div class="line">    mCircleWidth = (<span class="keyword">int</span>) (CIRCLE_DIAMETER * metrics.density);</div><div class="line">    mCircleHeight = (<span class="keyword">int</span>) (CIRCLE_DIAMETER * metrics.density);</div><div class="line"></div><div class="line">    <span class="comment">// åˆ›å»ºåˆ·æ–°åŠ¨ç”»çš„åœ†åœˆ</span></div><div class="line">    createProgressView();</div><div class="line"></div><div class="line">    ViewCompat.setChildrenDrawingOrderEnabled(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="comment">// the absolute offset has to take into account that the circle starts at an offset</span></div><div class="line">    mSpinnerFinalOffset = DEFAULT_CIRCLE_TARGET * metrics.density;</div><div class="line">    <span class="comment">// åˆ·æ–°åŠ¨ç”»çš„ä¸´ç•Œè·ç¦»å€¼</span></div><div class="line">    mTotalDragDistance = mSpinnerFinalOffset;</div><div class="line"></div><div class="line">    <span class="comment">// é€šè¿‡ NestedScrolling æœºåˆ¶æ¥å¤„ç†åµŒå¥—æ»šåŠ¨</span></div><div class="line">    mNestedScrollingParentHelper = <span class="keyword">new</span> NestedScrollingParentHelper(<span class="keyword">this</span>);</div><div class="line">    mNestedScrollingChildHelper = <span class="keyword">new</span> NestedScrollingChildHelper(<span class="keyword">this</span>);</div><div class="line">    setNestedScrollingEnabled(<span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>// åˆ›å»ºåˆ·æ–°åŠ¨ç”»çš„åœ†åœˆ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createProgressView</span><span class="params">()</span> </span>&#123;</div><div class="line">    mCircleView = <span class="keyword">new</span> CircleImageView(getContext(), CIRCLE_BG_LIGHT, CIRCLE_DIAMETER/<span class="number">2</span>);</div><div class="line">    mProgress = <span class="keyword">new</span> MaterialProgressDrawable(getContext(), <span class="keyword">this</span>);</div><div class="line">    mProgress.setBackgroundColor(CIRCLE_BG_LIGHT);</div><div class="line">    mCircleView.setImageDrawable(mProgress);</div><div class="line">    mCircleView.setVisibility(View.GONE);</div><div class="line">    addView(mCircleView);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªå‡ºæ¥ä¸€ä¸ª View ï¼ˆä¸‹æ‹‰åˆ·æ–°çš„åœ†åœˆï¼‰ã€‚å¯ä»¥çœ‹å‡ºä½¿ç”¨èƒŒæ™¯åœ†åœˆæ˜¯ v4 åŒ…é‡Œæä¾›çš„ <code>CircleImageView</code> æ§ä»¶ï¼Œä¸­é—´çš„æ˜¯ <code>MaterialProgressDrawable</code> è¿›åº¦æ¡ã€‚<br>å¦ä¸€ä¸ª View æ˜¯åœ¨ xml ä¸­åŒ…å«çš„å¯æ»šåŠ¨è§†å›¾ã€‚</p>
<h4 id="2-onMeasure"><a href="#2-onMeasure" class="headerlink" title="2.onMeasure"></a>2.onMeasure</h4><p>onMeasure ç¡®å®šå­è§†å›¾çš„å¤§å°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// ç¡®å®šå†…éƒ¨è¦æ»šåŠ¨çš„Viewï¼Œå¦‚ RecycleView</span></div><div class="line">        ensureTarget();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æµ‹é‡å­ View ï¼ˆmTargetï¼‰</span></div><div class="line">    mTarget.measure(MeasureSpec.makeMeasureSpec(</div><div class="line">            getMeasuredWidth() - getPaddingLeft() - getPaddingRight(),</div><div class="line">            MeasureSpec.EXACTLY), MeasureSpec.makeMeasureSpec(</div><div class="line">            getMeasuredHeight() - getPaddingTop() - getPaddingBottom(), MeasureSpec.EXACTLY));</div><div class="line"></div><div class="line">    <span class="comment">// æµ‹é‡åˆ·æ–°çš„åœ†åœˆ mCircleView</span></div><div class="line">    mCircleView.measure(MeasureSpec.makeMeasureSpec(mCircleWidth, MeasureSpec.EXACTLY),</div><div class="line">            MeasureSpec.makeMeasureSpec(mCircleHeight, MeasureSpec.EXACTLY));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mUsingCustomStart &amp;&amp; !mOriginalOffsetCalculated) &#123;</div><div class="line">        mOriginalOffsetCalculated = <span class="keyword">true</span>;</div><div class="line">        mCurrentTargetOffsetTop = mOriginalOffsetTop = -mCircleView.getMeasuredHeight();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// è®¡ç®— mCircleView åœ¨ ViewGroup ä¸­çš„ç´¢å¼•</span></div><div class="line">    mCircleViewIndex = -<span class="number">1</span>;</div><div class="line">    <span class="comment">// Get the index of the circleview.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; getChildCount(); index++) &#123;</div><div class="line">        <span class="keyword">if</span> (getChildAt(index) == mCircleView) &#123;</div><div class="line">            mCircleViewIndex = index;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ­¥éª¤ç¡®å®šäº† mCircleView å’Œ SwipeRefreshLayout çš„å­è§†å›¾çš„å¤§å°ã€‚</p>
<h4 id="3-onLayout"><a href="#3-onLayout" class="headerlink" title="3.onLayout"></a>3.onLayout</h4><p>onLayout ä¸»è¦è´Ÿè´£ç¡®å®šå„ä¸ªå­è§†å›¾çš„ä½ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– SwipeRefreshLayout çš„å®½é«˜</span></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> width = getMeasuredWidth();</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> height = getMeasuredHeight();</div><div class="line">   <span class="keyword">if</span> (getChildCount() == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</div><div class="line">       ensureTarget();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mTarget == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è€ƒè™‘åˆ°ç»™æ§ä»¶è®¾ç½® paddingï¼Œå»é™¤ padding çš„è·ç¦»</span></div><div class="line">   <span class="keyword">final</span> View child = mTarget;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childLeft = getPaddingLeft();</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childTop = getPaddingTop();</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childWidth = width - getPaddingLeft() - getPaddingRight();</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childHeight = height - getPaddingTop() - getPaddingBottom();</div><div class="line">   <span class="comment">// è®¾ç½® mTarget çš„ä½ç½®</span></div><div class="line">   child.layout(childLeft, childTop, childLeft + childWidth, childTop + childHeight);</div><div class="line">   <span class="keyword">int</span> circleWidth = mCircleView.getMeasuredWidth();</div><div class="line">   <span class="keyword">int</span> circleHeight = mCircleView.getMeasuredHeight();</div><div class="line">   <span class="comment">// æ ¹æ® mCurrentTargetOffsetTop å˜é‡çš„å€¼æ¥è®¾ç½® mCircleView çš„ä½ç½®</span></div><div class="line">   mCircleView.layout((width / <span class="number">2</span> - circleWidth / <span class="number">2</span>), mCurrentTargetOffsetTop,</div><div class="line">           (width / <span class="number">2</span> + circleWidth / <span class="number">2</span>), mCurrentTargetOffsetTop + circleHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <img src="https://dn-coding-net-production-pp.qbox.me/8df6d458-700b-4ec5-b731-c6b8c34cdddc.png" alt="å›¾ç‰‡"></p>
<p>åœ¨ onLayout ä¸­æ”¾ç½®äº† mCircleView çš„ä½ç½®ï¼Œæ³¨æ„ é¡¶éƒ¨ä½ç½®æ˜¯ mCurrentTargetOffsetTop ï¼ŒmCurrentTargetOffsetTop åˆå§‹è·ç¦»æ˜¯<code>-mCircleView.getMeasuredHeight()</code>ï¼Œæ‰€ä»¥æ˜¯åœ¨ SwipeRefreshLayout å¤–ã€‚</p>
<blockquote>
<p>ç»è¿‡ä»¥ä¸Šå‡ ä¸ªæ­¥éª¤ï¼ŒSwipeRefreshLayout åˆ›å»ºäº†å­è§†å›¾ï¼Œç¡®å®šä»–ä»¬çš„å¤§å°ã€ä½ç½®ï¼Œç°åœ¨æ‰€æœ‰è§†å›¾å¯ä»¥æ˜¾ç¤ºåœ¨ç•Œé¢äº†ã€‚</p>
</blockquote>
<h3 id="å¤„ç†ä¸å­è§†å›¾çš„æ»šåŠ¨äº¤äº’"><a href="#å¤„ç†ä¸å­è§†å›¾çš„æ»šåŠ¨äº¤äº’" class="headerlink" title="å¤„ç†ä¸å­è§†å›¾çš„æ»šåŠ¨äº¤äº’"></a>å¤„ç†ä¸å­è§†å›¾çš„æ»šåŠ¨äº¤äº’</h3><p>ä¸‹æ‹‰åˆ·æ–°æ§ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯å½“å­è§†å›¾ä¸‹æ‹‰åˆ°æœ€é¡¶éƒ¨æ—¶ï¼Œç»§ç»­ä¸‹æ‹‰å¯ä»¥å‡ºç°åˆ·æ–°åŠ¨ç”»ã€‚è€Œå­è§†å›¾å¯ä»¥æ»šåŠ¨æ—¶éœ€è¦å°†æ‰€æœ‰æ»šåŠ¨äº‹ä»¶éƒ½äº¤ç»™å­è§†å›¾ã€‚å€ŸåŠ© Android æä¾›çš„ NestedScrolling æœºåˆ¶ï¼Œä½¿å¾— SwipeRefreshLayout å¾ˆè½»æ¾çš„è§£å†³äº†ä¸å­è§†å›¾çš„æ»šåŠ¨å†²çªé—®é¢˜ã€‚<br>SwipeRefreshLayout é€šè¿‡å®ç° <code>NestedScrollingParent</code> å’Œ <code>NestedScrollingChild</code> æ¥å£æ¥å¤„ç†æ»šåŠ¨å†²çªã€‚SwipeRefreshLayout ä½œä¸º Parent åµŒå¥—ä¸€ä¸ªå¯ä»¥æ»šåŠ¨çš„å­è§†å›¾ï¼Œé‚£ä¹ˆå°±éœ€è¦äº†è§£ä¸€ä¸‹ NestedScrollingParent æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> å½“ä½ å¸Œæœ›è‡ªå·±çš„è‡ªå®šä¹‰å¸ƒå±€æ”¯æŒåµŒå¥—å­è§†å›¾å¹¶ä¸”å¤„ç†æ»šåŠ¨æ“ä½œï¼Œå°±å¯ä»¥å®ç°è¯¥æ¥å£ã€‚</div><div class="line"> å®ç°è¿™ä¸ªæ¥å£åå¯ä»¥åˆ›å»ºä¸€ä¸ª NestedScrollingParentHelper å­—æ®µï¼Œä½¿ç”¨å®ƒæ¥å¸®åŠ©ä½ å¤„ç†å¤§éƒ¨åˆ†çš„æ–¹æ³•ã€‚</div><div class="line"> å¤„ç†åµŒå¥—çš„æ»šåŠ¨æ—¶åº”è¯¥ä½¿ç”¨  `ViewCompat`ï¼Œ`ViewGroupCompat`æˆ–`ViewParentCompat` ä¸­çš„æ–¹æ³•æ¥å¤„ç†ï¼Œè¿™æ˜¯ä¸€äº›å…¼å®¹åº“ï¼Œ</div><div class="line"> ä»–ä»¬ä¿è¯ Android 5.0ä¹‹å‰çš„å…¼å®¹æ€§å«ç‰‡çš„é™æ€æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥å…¼å®¹ Android 5.0 ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NestedScrollingParent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å½“å­è§†å›¾è°ƒç”¨ startNestedScroll(View, int) åè°ƒç”¨è¯¥æ–¹æ³•ã€‚è¿”å› true è¡¨ç¤ºå“åº”å­è§†å›¾çš„æ»šåŠ¨ã€‚</div><div class="line">     * å®ç°è¿™ä¸ªæ–¹æ³•æ¥å£°æ˜æ”¯æŒåµŒå¥—æ»šåŠ¨ï¼Œå¦‚æœè¿”å› trueï¼Œé‚£ä¹ˆè¿™ä¸ªè§†å›¾å°†è¦é…åˆå­è§†å›¾åµŒå¥—æ»šåŠ¨ã€‚å½“åµŒå¥—æ»šåŠ¨ç»“æŸæ—¶ä¼šè°ƒç”¨åˆ° onStopNestedScroll(View)ã€‚</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> child å¯æ»šåŠ¨çš„å­è§†å›¾</div><div class="line">     * <span class="doctag">@param</span> target NestedScrollingParent çš„ç›´æ¥å¯æ»šåŠ¨çš„è§†å›¾ï¼Œä¸€èˆ¬æƒ…å†µå°±æ˜¯ child</div><div class="line">     * <span class="doctag">@param</span> nestedScrollAxes åŒ…å« ViewCompat#SCROLL_AXIS_HORIZONTAL, ViewCompat#SCROLL_AXIS_VERTICAL æˆ–è€…ä¸¤ä¸ªå€¼éƒ½æœ‰ã€‚</div><div class="line">     * <span class="doctag">@return</span> è¿”å› true è¡¨ç¤ºå“åº”å­è§†å›¾çš„æ»šåŠ¨ã€‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartNestedScroll</span><span class="params">(View child, View target, <span class="keyword">int</span> nestedScrollAxes)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¦‚æœ onStartNestedScroll è¿”å› true ï¼Œç„¶åèµ°è¯¥æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œå¯ä»¥åšä¸€äº›åˆå§‹åŒ–ã€‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScrollAccepted</span><span class="params">(View child, View target, <span class="keyword">int</span> nestedScrollAxes)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­è§†å›¾å¼€å§‹æ»šåŠ¨å‰ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ—¶å€™çˆ¶å¸ƒå±€ï¼ˆä¹Ÿå°±æ˜¯å½“å‰çš„ NestedScrollingParent çš„å®ç°ç±»ï¼‰å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥é…åˆå­è§†å›¾åŒæ—¶å¤„ç†æ»šåŠ¨äº‹ä»¶ã€‚</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> target æ»šåŠ¨çš„å­è§†å›¾</div><div class="line">     * <span class="doctag">@param</span> dx ç»å¯¹å€¼ä¸ºæ‰‹æŒ‡åœ¨xæ–¹å‘æ»šåŠ¨çš„è·ç¦»ï¼Œdx&lt;0 è¡¨ç¤ºæ‰‹æŒ‡åœ¨å±å¹•å‘å³æ»šåŠ¨</div><div class="line">     * <span class="doctag">@param</span> dy ç»å¯¹å€¼ä¸ºæ‰‹æŒ‡åœ¨yæ–¹å‘æ»šåŠ¨çš„è·ç¦»ï¼Œdy&lt;0 è¡¨ç¤ºæ‰‹æŒ‡åœ¨å±å¹•å‘ä¸‹æ»šåŠ¨</div><div class="line">     * <span class="doctag">@param</span> consumed ä¸€ä¸ªæ•°ç»„ï¼Œå€¼ç”¨æ¥è¡¨ç¤ºçˆ¶å¸ƒå±€æ¶ˆè€—äº†å¤šå°‘è·ç¦»ï¼Œæœªæ¶ˆè€—å‰ä¸º[0,0], å¦‚æœçˆ¶å¸ƒå±€æƒ³å¤„ç†æ»šåŠ¨äº‹ä»¶ï¼Œå°±å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸­ä¸ºconsumed[0]ï¼Œconsumed[1]èµ‹å€¼ã€‚</div><div class="line">     *                 åˆ†åˆ«è¡¨ç¤ºxå’Œyæ–¹å‘æ¶ˆè€—çš„è·ç¦»ã€‚å¦‚çˆ¶å¸ƒå±€æƒ³åœ¨ç«–ç›´æ–¹å‘ï¼ˆyï¼‰å®Œå…¨æ‹¦æˆªå­è§†å›¾ï¼Œé‚£ä¹ˆè®© consumed[1] = dyï¼Œå°±æŠŠæ‰‹æŒ‡äº§ç”Ÿçš„è§¦æ‘¸äº‹ä»¶ç»™æ‹¦æˆªäº†ï¼Œå­è§†å›¾ä¾¿å“åº”ä¸åˆ°è§¦æ‘¸äº‹ä»¶äº† ã€‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedPreScroll</span><span class="params">(View target, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span>[] consumed)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">     * è¿™ä¸ªæ–¹æ³•è¡¨ç¤ºå­è§†å›¾æ­£åœ¨æ»šåŠ¨ï¼Œå¹¶ä¸”æŠŠæ»šåŠ¨è·ç¦»å›è°ƒç”¨åˆ°è¯¥æ–¹æ³•ï¼Œå‰ææ˜¯ onStartNestedScroll è¿”å›äº† trueã€‚</div><div class="line">     * &lt;p&gt;Both the consumed and unconsumed portions of the scroll distance are reported to the</div><div class="line">     * ViewParent. An implementation may choose to use the consumed portion to match or chase scroll</div><div class="line">     * position of multiple child elements, for example. The unconsumed portion may be used to</div><div class="line">     * allow continuous dragging of multiple scrolling or draggable elements, such as scrolling</div><div class="line">     * a list within a vertical drawer where the drawer begins dragging once the edge of inner</div><div class="line">     * scrolling content is reached.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> target æ»šåŠ¨çš„å­è§†å›¾</div><div class="line">     * <span class="doctag">@param</span> dxConsumed æ‰‹æŒ‡äº§ç”Ÿçš„è§¦æ‘¸è·ç¦»ä¸­ï¼Œå­è§†å›¾æ¶ˆè€—çš„xæ–¹å‘çš„è·ç¦»</div><div class="line">     * <span class="doctag">@param</span> dyConsumed æ‰‹æŒ‡äº§ç”Ÿçš„è§¦æ‘¸è·ç¦»ä¸­ï¼Œå­è§†å›¾æ¶ˆè€—çš„yæ–¹å‘çš„è·ç¦» ï¼Œå¦‚æœ onNestedPreScroll ä¸­ dy = 20ï¼Œ consumed[0] = 8ï¼Œé‚£ä¹ˆ dy = 12</div><div class="line">      * <span class="doctag">@param</span> dxUnconsumed æ‰‹æŒ‡äº§ç”Ÿçš„è§¦æ‘¸è·ç¦»ä¸­ï¼Œæœªè¢«å­è§†å›¾æ¶ˆè€—çš„xæ–¹å‘çš„è·ç¦»</div><div class="line">     * <span class="doctag">@param</span> dyUnconsumed æ‰‹æŒ‡äº§ç”Ÿçš„è§¦æ‘¸è·ç¦»ä¸­ï¼Œæœªè¢«å­è§†å›¾æ¶ˆè€—çš„yæ–¹å‘çš„è·ç¦»</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScroll</span><span class="params">(View target, <span class="keyword">int</span> dxConsumed, <span class="keyword">int</span> dyConsumed,<span class="keyword">int</span> dxUnconsumed, <span class="keyword">int</span> dyUnconsumed)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å“åº”åµŒå¥—æ»šåŠ¨ç»“æŸ</div><div class="line">     *</div><div class="line">     * å½“ä¸€ä¸ªåµŒå¥—æ»šåŠ¨ç»“æŸåï¼ˆå¦‚MotionEvent#ACTION_UPï¼Œ MotionEvent#ACTION_CANCELï¼‰ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¯æœ‰åšä¸€äº›æ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚å˜é‡é‡ç½®</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopNestedScroll</span><span class="params">(View target)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ‰‹æŒ‡åœ¨å±å¹•å¿«é€Ÿæ»‘è§¦å‘Flingå‰å›è°ƒï¼Œå¦‚æœå‰é¢ onNestedPreScroll ä¸­çˆ¶å¸ƒå±€æ¶ˆè€—äº†äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªä¹Ÿä¼šè¢«è§¦å‘</div><div class="line">     * è¿”å›trueè¡¨ç¤ºçˆ¶å¸ƒå±€å®Œå…¨å¤„ç† fling äº‹ä»¶</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> target æ»šåŠ¨çš„å­è§†å›¾</div><div class="line">     * <span class="doctag">@param</span> velocityX xæ–¹å‘çš„é€Ÿåº¦ï¼ˆpx/sï¼‰</div><div class="line">     * <span class="doctag">@param</span> velocityY yæ–¹å‘çš„é€Ÿåº¦</div><div class="line">     * <span class="doctag">@return</span> true if this parent consumed the fling ahead of the target view</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onNestedPreFling</span><span class="params">(View target, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å­è§†å›¾fling æ—¶å›è°ƒï¼Œçˆ¶å¸ƒå±€å¯ä»¥é€‰æ‹©ç›‘å¬å­è§†å›¾çš„ flingã€‚</div><div class="line">     * true è¡¨ç¤ºçˆ¶å¸ƒå±€å¤„ç† flingï¼Œfalseè¡¨ç¤ºçˆ¶å¸ƒå±€ç›‘å¬å­è§†å›¾çš„fling</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> target View that initiated the nested scroll</div><div class="line">     * <span class="doctag">@param</span> velocityX Horizontal velocity in pixels per second</div><div class="line">     * <span class="doctag">@param</span> velocityY Vertical velocity in pixels per second</div><div class="line">     * <span class="doctag">@param</span> consumed true è¡¨ç¤ºå­è§†å›¾å¤„ç†äº†fling</div><div class="line"></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onNestedFling</span><span class="params">(View target, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY, <span class="keyword">boolean</span> consumed)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿”å›å½“å‰ NestedScrollingParent çš„æ»šåŠ¨æ–¹å‘ï¼Œ</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@see</span> ViewCompat#SCROLL_AXIS_HORIZONTAL</div><div class="line">     * <span class="doctag">@see</span> ViewCompat#SCROLL_AXIS_VERTICAL</div><div class="line">     * <span class="doctag">@see</span> ViewCompat#SCROLL_AXIS_NONE</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNestedScrollAxes</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹ SwipeRefreshLayout å®ç° NestedScrollingParent çš„ç›¸å…³æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NestedScrollingParent</span></div><div class="line"></div><div class="line"><span class="comment">// å­ View ï¼ˆNestedScrollingChildï¼‰å¼€å§‹æ»šåŠ¨å‰å›è°ƒæ­¤æ–¹æ³•,è¿”å› true è¡¨ç¤ºæ¥ Parent æ”¶åµŒå¥—æ»šåŠ¨ï¼Œç„¶åè°ƒç”¨ onNestedScrollAccepted</span></div><div class="line"><span class="comment">// å…·ä½“å¯ä»¥çœ‹ NestedScrollingChildHelper çš„æºç </span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartNestedScroll</span><span class="params">(View child, View target, <span class="keyword">int</span> nestedScrollAxes)</span> </span>&#123;</div><div class="line">    <span class="comment">// å­ View å›è°ƒï¼Œåˆ¤æ–­æ˜¯å¦å¼€å§‹åµŒå¥—æ»šåŠ¨ ï¼Œ</span></div><div class="line">    <span class="keyword">return</span> isEnabled() &amp;&amp; !mReturningToStart &amp;&amp; !mRefreshing</div><div class="line">            &amp;&amp; (nestedScrollAxes &amp; ViewCompat.SCROLL_AXIS_VERTICAL) != <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScrollAccepted</span><span class="params">(View child, View target, <span class="keyword">int</span> axes)</span> </span>&#123;</div><div class="line">     <span class="comment">// Reset the counter of how much leftover scroll needs to be consumed.</span></div><div class="line">     mNestedScrollingParentHelper.onNestedScrollAccepted(child, target, axes);</div><div class="line"></div><div class="line">     <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>SwipeRefreshLayout åªæ¥å—ç«–ç›´æ–¹å‘ï¼ˆYè½´ï¼‰çš„æ»šåŠ¨ï¼Œå¹¶ä¸”åœ¨åˆ·æ–°åŠ¨ç”»è¿›è¡Œä¸­ä¸æ¥å—æ»šåŠ¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NestedScrollingChild åœ¨æ»šåŠ¨çš„æ—¶å€™ä¼šè§¦å‘ï¼Œ çœ‹çˆ¶ç±»æ¶ˆè€—äº†å¤šå°‘è·ç¦»</span></div><div class="line"><span class="comment">//   * @param dx x è½´æ»šåŠ¨çš„è·ç¦»</span></div><div class="line"><span class="comment">//   * @param dy y è½´æ»šåŠ¨çš„è·ç¦»</span></div><div class="line"><span class="comment">//   * @param consumed ä»£è¡¨ çˆ¶ View æ¶ˆè´¹çš„æ»šåŠ¨è·ç¦»</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedPreScroll</span><span class="params">(View target, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span>[] consumed)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// dy &gt; 0 è¡¨ç¤ºæ‰‹æŒ‡åœ¨å±å¹•å‘ä¸Šç§»åŠ¨</span></div><div class="line">    <span class="comment">//  mTotalUnconsumed è¡¨ç¤ºå­è§†å›¾Yè½´æœªæ¶ˆè´¹çš„è·ç¦»</span></div><div class="line">    <span class="comment">// ç°åœ¨è¡¨ç¤º</span></div><div class="line">    <span class="keyword">if</span> (dy &gt; <span class="number">0</span> &amp;&amp; mTotalUnconsumed &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (dy &gt; mTotalUnconsumed) &#123;</div><div class="line">            consumed[<span class="number">1</span>] = dy - (<span class="keyword">int</span>) mTotalUnconsumed; <span class="comment">// SwipeRefreshLayout å°±å§å­è§†å›¾ä½æ¶ˆè´¹çš„è·ç¦»å…¨éƒ¨æ¶ˆè´¹äº†ã€‚</span></div><div class="line">            mTotalUnconsumed = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mTotalUnconsumed -= dy; <span class="comment">// æ¶ˆè´¹çš„ y è½´çš„è·ç¦»</span></div><div class="line">            consumed[<span class="number">1</span>] = dy;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// å‡ºç°åŠ¨ç”»åœ†åœˆï¼Œå¹¶å‘ä¸Šç§»åŠ¨</span></div><div class="line">        moveSpinner(mTotalUnconsumed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// onStartNestedScroll è¿”å› true æ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚æ­¤æ–¹æ³•è¡¨ç¤ºå­Viewå°†æ»šåŠ¨äº‹ä»¶åˆ†å‘åˆ°çˆ¶ Viewï¼ˆSwipeRefreshLayoutï¼‰</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScroll</span><span class="params">(<span class="keyword">final</span> View target, <span class="keyword">final</span> <span class="keyword">int</span> dxConsumed, <span class="keyword">final</span> <span class="keyword">int</span> dyConsumed,</span></span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dxUnconsumed, <span class="keyword">final</span> <span class="keyword">int</span> dyUnconsumed) &#123;</div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// This is a bit of a hack. Nested scrolling works from the bottom up, and as we are</span></div><div class="line">    <span class="comment">// sometimes between two nested scrolling views, we need a way to be able to know when any</span></div><div class="line">    <span class="comment">// nested scrolling parent has stopped handling events. We do that by using the</span></div><div class="line">    <span class="comment">// 'offset in window 'functionality to see if we have been moved from the event.</span></div><div class="line">    <span class="comment">// This is a decent indication of whether we should take over the event stream or not.</span></div><div class="line">    <span class="comment">// æ‰‹æŒ‡åœ¨å±å¹•ä¸Šå‘ä¸‹æ»šåŠ¨ï¼Œå¹¶ä¸”å­è§†å›¾ä¸å¯ä»¥æ»šåŠ¨</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dy = dyUnconsumed + mParentOffsetInWindow[<span class="number">1</span>];</div><div class="line">    <span class="keyword">if</span> (dy &lt; <span class="number">0</span> &amp;&amp; !canChildScrollUp()) &#123;</div><div class="line">        mTotalUnconsumed += Math.abs(dy);</div><div class="line">        moveSpinner(mTotalUnconsumed);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SwipeRefreshLayout é€šè¿‡ NestedScrollingParent æ¥å£å®Œæˆäº†å¤„ç†å­è§†å›¾çš„æ»šåŠ¨çš„å†²çªï¼Œä¸­é—´çœç•¥äº†ä¸€äº› SwipeRefreshLayoutä½œä¸º child çš„ç›¸å…³ä»£ç ï¼Œè¿™ç§æƒ…å†µæ˜¯ä¸ºäº†å…¼å®¹å°† SwipeRefreshLayout ä½œä¸ºå­è§†å›¾æ”¾åœ¨çŸ¥è¯†åµŒå¥—æ»šåŠ¨çš„çˆ¶å¸ƒå±€çš„æƒ…å†µï¼Œè¿™é‡Œä¸åšæ·±å…¥è®¨è®ºã€‚ä½†æ˜¯ä¸‹æ‹‰åˆ·æ–°éœ€è¦åˆ¤æ–­æ‰‹æŒ‡åœ¨å±å¹•çš„çŠ¶æ€æ¥è¿›è¡Œä¸€ä¸ªåˆ·æ–°çš„åŠ¨ç”»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œåˆ¤æ–­æ‰‹æŒ‡åœ¨å±å¹•ä¸­çš„çŠ¶æ€ã€‚</p>
<p>é¦–å…ˆæ˜¯ onInterceptTouchEventï¼Œè¿”å› true è¡¨ç¤ºæ‹¦æˆªè§¦æ‘¸äº‹ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    ensureTarget();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line"></div><div class="line">    <span class="comment">// æ‰‹æŒ‡æŒ‰ä¸‹æ—¶æ¢å¤çŠ¶æ€</span></div><div class="line">    <span class="keyword">if</span> (mReturningToStart &amp;&amp; action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        mReturningToStart = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æ§ä»¶å¯ç”¨ || åˆ·æ–°äº‹ä»¶åˆšç»“æŸæ­£åœ¨æ¢å¤åˆå§‹çŠ¶æ€æ—¶ || å­ View å¯æ»šåŠ¨ || æ­£åœ¨åˆ·æ–° || çˆ¶ View æ­£åœ¨æ»šåŠ¨</span></div><div class="line">    <span class="keyword">if</span> (!isEnabled() || mReturningToStart || canChildScrollUp()</div><div class="line">            || mRefreshing || mNestedScrollInProgress) &#123;</div><div class="line">        <span class="comment">// Fail fast if we're not in a state where a swipe is possible</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">            setTargetOffsetTopAndBottom(mOriginalOffsetTop - mCircleView.getTop(), <span class="keyword">true</span>);</div><div class="line">            mActivePointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</div><div class="line">            mIsBeingDragged = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// è®°å½•æ‰‹æŒ‡æŒ‰ä¸‹çš„ä½ç½®ï¼Œä¸ºäº†åˆ¤æ–­æ˜¯å¦å¼€å§‹æ»šåŠ¨</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> initialDownY = getMotionEventY(ev, mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (initialDownY == -<span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            mInitialDownY = initialDownY;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">            <span class="keyword">if</span> (mActivePointerId == INVALID_POINTER) &#123;</div><div class="line">                Log.e(LOG_TAG, <span class="string">"Got ACTION_MOVE event but don't have an active pointer id."</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = getMotionEventY(ev, mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (y == -<span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// åˆ¤æ–­å½“æ‹–åŠ¨è·ç¦»å¤§äºæœ€å°è·ç¦»æ—¶è®¾ç½® mIsBeingDragged = true;</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> yDiff = y - mInitialDownY;</div><div class="line">            <span class="keyword">if</span> (yDiff &gt; mTouchSlop &amp;&amp; !mIsBeingDragged) &#123;</div><div class="line">                mInitialMotionY = mInitialDownY + mTouchSlop;</div><div class="line">                mIsBeingDragged = <span class="keyword">true</span>;</div><div class="line">                <span class="comment">// æ­£åœ¨æ‹–åŠ¨çŠ¶æ€ï¼Œæ›´æ–°åœ†åœˆçš„ progressbar çš„ alpha å€¼</span></div><div class="line">                mProgress.setAlpha(STARTING_PROGRESS_ALPHA);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP:</div><div class="line">            onSecondaryPointerUp(ev);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">            mIsBeingDragged = <span class="keyword">false</span>;</div><div class="line">            mActivePointerId = INVALID_POINTER;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> mIsBeingDragged;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æºç ä¹Ÿå°±æ˜¯è¿›è¡Œç®€å•å¤„ç†ï¼ŒDOWN çš„æ—¶å€™è®°å½•ä¸€ä¸‹ä½ç½®ï¼ŒMOVE æ—¶åˆ¤æ–­ç§»åŠ¨çš„è·ç¦»ï¼Œè¿”å›å€¼ mIsBeingDragged ä¸º true æ—¶ï¼Œ å³ onInterceptTouchEvent è¿”å›trueï¼ŒSwipeRefreshLayout æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œä¸åˆ†å‘ç»™ mTargetï¼Œç„¶åæŠŠ MotionEvent ä¼ ç»™ onTouchEvent æ–¹æ³•ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªåˆ¤æ–­å­Viewçš„æ˜¯å¦è¿˜å¯ä»¥æ»šåŠ¨çš„æ–¹æ³• <code>canChildScrollUp</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@return</span> Whether it is possible for the child view of this layout to</div><div class="line"> *         scroll up. Override this if the child view is a custom view.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canChildScrollUp</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &lt; <span class="number">14</span>) &#123;</div><div class="line">        <span class="comment">// åˆ¤æ–­ AbsListView çš„å­ç±» ListView æˆ–è€… GridView ç­‰</span></div><div class="line">        <span class="keyword">if</span> (mTarget <span class="keyword">instanceof</span> AbsListView) &#123;</div><div class="line">            <span class="keyword">final</span> AbsListView absListView = (AbsListView) mTarget;</div><div class="line">            <span class="keyword">return</span> absListView.getChildCount() &gt; <span class="number">0</span></div><div class="line">                    &amp;&amp; (absListView.getFirstVisiblePosition() &gt; <span class="number">0</span> || absListView.getChildAt(<span class="number">0</span>)</div><div class="line">                            .getTop() &lt; absListView.getPaddingTop());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> ViewCompat.canScrollVertically(mTarget, -<span class="number">1</span>) || mTarget.getScrollY() &gt; <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> ViewCompat.canScrollVertically(mTarget, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“SwipeRefreshLayout æ‹¦æˆªäº†è§¦æ‘¸äº‹ä»¶ä¹‹åï¼ˆ mIsBeingDragged ä¸º true ï¼‰ï¼Œå°† MotionEvent äº¤ç»™ onTouchEvent å¤„ç†ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">            <span class="comment">// è·å–ç¬¬ä¸€ä¸ªæŒ‰ä¸‹çš„æ‰‹æŒ‡</span></div><div class="line">            mActivePointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</div><div class="line">            mIsBeingDragged = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">            <span class="comment">// å¤„ç†å¤šæŒ‡è§¦æ§</span></div><div class="line">            pointerIndex = MotionEventCompat.findPointerIndex(ev, mActivePointerId);</div><div class="line"></div><div class="line">            <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, pointerIndex);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> overscrollTop = (y - mInitialMotionY) * DRAG_RATE;</div><div class="line">            <span class="keyword">if</span> (mIsBeingDragged) &#123;</div><div class="line">                <span class="keyword">if</span> (overscrollTop &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// æ­£åœ¨æ‹–åŠ¨çŠ¶æ€ï¼Œæ›´æ–°åœ†åœˆçš„ä½ç½®</span></div><div class="line">                    moveSpinner(overscrollTop);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">            pointerIndex = MotionEventCompat.findPointerIndex(ev, mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                Log.e(LOG_TAG, <span class="string">"Got ACTION_UP event but don't have an active pointer id."</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(ev, pointerIndex);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> overscrollTop = (y - mInitialMotionY) * DRAG_RATE;</div><div class="line">            mIsBeingDragged = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// æ‰‹æŒ‡æ¾å¼€ï¼Œå°†åœ†åœˆç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®</span></div><div class="line">            finishSpinner(overscrollTop);</div><div class="line">            mActivePointerId = INVALID_POINTER;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨æ‰‹æŒ‡æ»šåŠ¨è¿‡ç¨‹ä¸­é€šè¿‡åˆ¤æ–­ mIsBeingDragged æ¥ç§»åŠ¨åˆ·æ–°çš„åœ†åœˆï¼ˆå¯¹åº”çš„æ˜¯ moveSpinner ï¼‰ï¼Œæ‰‹æŒ‡æ¾å¼€å°†åœ†åœˆç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ï¼ˆåˆå§‹ä½ç½®æˆ–è€…åˆ·æ–°åŠ¨ç”»çš„ä½ç½®ï¼Œå¯¹åº”çš„æ˜¯ finishSpinner æ–¹æ³•ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ‰‹æŒ‡ä¸‹æ‹‰è¿‡ç¨‹ä¸­è§¦å‘çš„åœ†åœˆçš„å˜åŒ–è¿‡ç¨‹ï¼Œé€æ˜åº¦å˜åŒ–ï¼Œæ¸æ¸å‡ºç°ç®­å¤´ï¼Œå¤§å°çš„å˜åŒ–</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveSpinner</span><span class="params">(<span class="keyword">float</span> overscrollTop)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// è®¾ç½®ä¸ºæœ‰ç®­å¤´çš„ progress</span></div><div class="line">    mProgress.showArrow(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// è¿›åº¦è½¬åŒ–æˆç™¾åˆ†æ¯”</span></div><div class="line">    <span class="keyword">float</span> originalDragPercent = overscrollTop / mTotalDragDistance;</div><div class="line"></div><div class="line">    <span class="comment">// é¿å…ç™¾åˆ†æ¯”è¶…è¿‡ 100%</span></div><div class="line">    <span class="keyword">float</span> dragPercent = Math.min(<span class="number">1f</span>, Math.abs(originalDragPercent));</div><div class="line">    <span class="comment">// è°ƒæ•´æ‹–åŠ¨ç™¾åˆ†æ¯”ï¼Œé€ æˆè§†å·®æ•ˆæœ</span></div><div class="line">    <span class="keyword">float</span> adjustedPercent = (<span class="keyword">float</span>) Math.max(dragPercent - .<span class="number">4</span>, <span class="number">0</span>) * <span class="number">5</span> / <span class="number">3</span>;</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">float</span> extraOS = Math.abs(overscrollTop) - mTotalDragDistance;</div><div class="line"></div><div class="line">    <span class="comment">// è¿™é‡ŒmUsingCustomStart ä¸º true ä»£è¡¨ç”¨æˆ·è‡ªå®šä¹‰äº†èµ·å§‹å‡ºç°çš„åæ ‡</span></div><div class="line">    <span class="keyword">float</span> slingshotDist = mUsingCustomStart ? mSpinnerFinalOffset - mOriginalOffsetTop</div><div class="line">            : mSpinnerFinalOffset;</div><div class="line"></div><div class="line">    <span class="comment">// å¼¹æ€§ç³»æ•°</span></div><div class="line">    <span class="keyword">float</span> tensionSlingshotPercent = Math.max(<span class="number">0</span>, Math.min(extraOS, slingshotDist * <span class="number">2</span>)</div><div class="line">            / slingshotDist);</div><div class="line">    <span class="keyword">float</span> tensionPercent = (<span class="keyword">float</span>) ((tensionSlingshotPercent / <span class="number">4</span>) - Math.pow(</div><div class="line">            (tensionSlingshotPercent / <span class="number">4</span>), <span class="number">2</span>)) * <span class="number">2f</span>;</div><div class="line">    <span class="keyword">float</span> extraMove = (slingshotDist) * tensionPercent * <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">// å› ä¸ºæœ‰å¼¹æ€§ç³»æ•°ï¼Œä¸åŒçš„æ‰‹æŒ‡æ»šåŠ¨è·ç¦»ä¸åŒäºviewçš„ç§»åŠ¨è·ç¦»</span></div><div class="line">    <span class="keyword">int</span> targetY = mOriginalOffsetTop + (<span class="keyword">int</span>) ((slingshotDist * dragPercent) + extraMove);</div><div class="line"></div><div class="line">    <span class="comment">// where 1.0f is a full circle</span></div><div class="line">    <span class="keyword">if</span> (mCircleView.getVisibility() != View.VISIBLE) &#123;</div><div class="line">        mCircleView.setVisibility(View.VISIBLE);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è®¾ç½®çš„æ˜¯å¦æœ‰ç¼©æ”¾</span></div><div class="line">    <span class="keyword">if</span> (!mScale) &#123;</div><div class="line">        ViewCompat.setScaleX(mCircleView, <span class="number">1f</span>);</div><div class="line">        ViewCompat.setScaleY(mCircleView, <span class="number">1f</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è®¾ç½®ç¼©æ”¾è¿›åº¦</span></div><div class="line">    <span class="keyword">if</span> (mScale) &#123;</div><div class="line">        setAnimationProgress(Math.min(<span class="number">1f</span>, overscrollTop / mTotalDragDistance));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ç§»åŠ¨è·ç¦»æœªè¾¾åˆ°æœ€å¤§è·ç¦»</span></div><div class="line">    <span class="keyword">if</span> (overscrollTop &lt; mTotalDragDistance) &#123;</div><div class="line">        <span class="keyword">if</span> (mProgress.getAlpha() &gt; STARTING_PROGRESS_ALPHA</div><div class="line">                &amp;&amp; !isAnimationRunning(mAlphaStartAnimation)) &#123;</div><div class="line">            <span class="comment">// Animate the alpha</span></div><div class="line">            startProgressAlphaStartAnimation();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mProgress.getAlpha() &lt; MAX_ALPHA &amp;&amp; !isAnimationRunning(mAlphaMaxAnimation)) &#123;</div><div class="line">            <span class="comment">// Animate the alpha</span></div><div class="line">            startProgressAlphaMaxAnimation();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å‡ºç°çš„è¿›åº¦ï¼Œè£å‰ª mProgress</span></div><div class="line">    <span class="keyword">float</span> strokeStart = adjustedPercent * .<span class="number">8f</span>;</div><div class="line">    mProgress.setStartEndTrim(<span class="number">0f</span>, Math.min(MAX_PROGRESS_ANGLE, strokeStart));</div><div class="line">    mProgress.setArrowScale(Math.min(<span class="number">1f</span>, adjustedPercent));</div><div class="line"></div><div class="line">    <span class="comment">// æ—‹è½¬</span></div><div class="line">    <span class="keyword">float</span> rotation = (-<span class="number">0.25f</span> + .<span class="number">4f</span> * adjustedPercent + tensionPercent * <span class="number">2</span>) * .<span class="number">5f</span>;</div><div class="line">    mProgress.setProgressRotation(rotation);</div><div class="line">    setTargetOffsetTopAndBottom(targetY - mCurrentTargetOffsetTop, <span class="keyword">true</span> <span class="comment">/* requires update */</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ·æ–°åœ†åœˆçš„ç§»åŠ¨è¿‡ç¨‹ä¹Ÿæ˜¯æœ‰å¥½å‡ ç§çŠ¶æ€ï¼Œçœ‹ä¸Šé¢çš„æ³¨é‡ŠåŸºæœ¬ä¸Šå°±æ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishSpinner</span><span class="params">(<span class="keyword">float</span> overscrollTop)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (overscrollTop &gt; mTotalDragDistance) &#123;</div><div class="line">        <span class="comment">//ç§»åŠ¨è·ç¦»è¶…è¿‡äº†åˆ·æ–°çš„ä¸´ç•Œå€¼ï¼Œè§¦å‘åˆ·æ–°åŠ¨ç”»</span></div><div class="line">        setRefreshing(<span class="keyword">true</span>, <span class="keyword">true</span> <span class="comment">/* notify */</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// å–æ¶ˆåˆ·æ–°çš„åœ†åœˆï¼Œå°†åœ†åœˆç§»åŠ¨åˆ°åˆå§‹ä½ç½®</span></div><div class="line">        mRefreshing = <span class="keyword">false</span>;</div><div class="line">        mProgress.setStartEndTrim(<span class="number">0f</span>, <span class="number">0f</span>);</div><div class="line">        <span class="comment">// ...çœç•¥ä»£ç </span></div><div class="line"></div><div class="line">        <span class="comment">// ç§»åŠ¨åˆ°åˆå§‹ä½ç½®</span></div><div class="line">        animateOffsetToStartPosition(mCurrentTargetOffsetTop, listener);</div><div class="line">        <span class="comment">// è®¾ç½®æ²¡æœ‰ç®­å¤´</span></div><div class="line">        mProgress.showArrow(<span class="keyword">false</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è°ƒç”¨ setRefresh(true,true) æ–¹æ³•è§¦å‘åˆ·æ–°åŠ¨ç”»å¹¶è¿›è¡Œå›è°ƒï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ private çš„ã€‚å‰é¢æåˆ°æˆ‘ä»¬è‡ªå·±è°ƒç”¨ setRefresh(true) åªèƒ½äº§ç”ŸåŠ¨ç”»ï¼Œè€Œä¸èƒ½å›è°ƒåˆ·æ–°å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨åå°„è°ƒç”¨ 2 ä¸ªå‚æ•°çš„ setRefresh å‡½æ•°ã€‚ æˆ–è€…æ‰‹åŠ¨è°ƒ setRefreshing(true)+ OnRefreshListener.onRefresh æ–¹æ³•ã€‚</p>
<h3 id="setRefresh"><a href="#setRefresh" class="headerlink" title="setRefresh"></a>setRefresh</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * æ”¹å˜åˆ·æ–°åŠ¨ç”»çš„çš„åœ†åœˆåˆ·æ–°çŠ¶æ€ã€‚Notify the widget that refresh state has changed. Do not call this when</div><div class="line">  * refresh is triggered by a swipe gesture.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> refreshing æ˜¯å¦æ˜¾ç¤ºåˆ·æ–°çš„åœ†åœˆ</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefreshing</span><span class="params">(<span class="keyword">boolean</span> refreshing)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (refreshing &amp;&amp; mRefreshing != refreshing) &#123;</div><div class="line">         <span class="comment">// scale and show</span></div><div class="line">         mRefreshing = refreshing;</div><div class="line">         <span class="keyword">int</span> endTarget = <span class="number">0</span>;</div><div class="line">         <span class="keyword">if</span> (!mUsingCustomStart) &#123;</div><div class="line">             endTarget = (<span class="keyword">int</span>) (mSpinnerFinalOffset + mOriginalOffsetTop);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             endTarget = (<span class="keyword">int</span>) mSpinnerFinalOffset;</div><div class="line">         &#125;</div><div class="line">         setTargetOffsetTopAndBottom(endTarget - mCurrentTargetOffsetTop,</div><div class="line">                 <span class="keyword">true</span> <span class="comment">/* requires update */</span>);</div><div class="line">         mNotify = <span class="keyword">false</span>;</div><div class="line">         startScaleUpAnimation(mRefreshListener);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         setRefreshing(refreshing, <span class="keyword">false</span> <span class="comment">/* notify */</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>startScaleUpAnimation å¼€å¯ä¸€ä¸ªåŠ¨ç”»ï¼Œç„¶ååœ¨åŠ¨ç”»ç»“æŸåå›è°ƒ onRefresh æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Animation.AnimationListener mRefreshListener = <span class="keyword">new</span> Animation.AnimationListener() &#123;</div><div class="line">   <span class="comment">// .. çœç•¥ä»£ç </span></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animation animation)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mRefreshing) &#123;</div><div class="line">           mProgress.setAlpha(MAX_ALPHA); <span class="comment">//ç¡®ä¿åˆ·æ–°åœ†åœˆä¸­é—´çš„è¿›åº¦æ¡æ˜¯å®Œå…¨ä¸é€æ˜äº†</span></div><div class="line">           mProgress.start();</div><div class="line">           <span class="keyword">if</span> (mNotify) &#123; <span class="comment">// å½“ mNotify ä¸º true æ—¶æ‰ä¼šå›è°ƒ onRefresh</span></div><div class="line">               <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">// å›è°ƒ listener çš„ onRefresh æ–¹æ³•</span></div><div class="line">                   mListener.onRefresh();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           mCurrentTargetOffsetTop = mCircleView.getTop();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           reset();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ†æ SwipeRefreshLayout çš„æµç¨‹å°±æ˜¯æŒ‰ç…§å¹³æ—¶æˆ‘ä»¬è‡ªå®šä¹‰ <code>ViewGroup</code> çš„æµç¨‹ï¼Œä½†æ˜¯å…¶ä¸­ä¹Ÿæœ‰å¥½å¤šéœ€è¦æˆ‘ä»¬å€Ÿé‰´çš„åœ°æ–¹ï¼Œå¦‚ä½•ä½¿ç”¨ NestedScrollingç›¸å…³æœºåˆ¶ ï¼Œå¤šç‚¹è§¦æ§çš„å¤„ç†ï¼ŒonMeasure ä¸­å‡å»äº† paddingï¼Œå¦‚ä½•åˆ¤æ–­å­ View æ˜¯å¦å¯æ»šåŠ¨ï¼Œå¦‚ä½•ç¡®å®š ViewGroup ä¸­æŸä¸€ä¸ª View çš„ç´¢å¼•ç­‰ã€‚<br>æ­¤å¤–ï¼Œä¸€ä¸ªå¥½çš„ä¸‹æ‹‰åˆ·æ–°æ¡†æ¶ä¸ä»…ä»…è¦å…¼å®¹å„ç§æ»šåŠ¨çš„å­æ§ä»¶ï¼Œè¿˜è¦è€ƒè™‘è‡ªå·±è¦å…¼å®¹ NestedScrollingChild çš„æƒ…å†µï¼Œæ¯”å¦‚æ”¾åˆ° CooCoordinatorLayout çš„æƒ…å†µï¼Œç›®å‰å¤§å¤šæ•°å¼€æºçš„ä¸‹æ‹‰åˆ·æ–°å¥½åƒéƒ½æ²¡æœ‰è¾¾åˆ°è¿™ä¸ªè¦æ±‚ï¼Œä¸€èˆ¬éƒ½æ˜¯åªè€ƒè™‘äº†å†…éƒ¨åµŒå¥—æ»šåŠ¨å­è§†å›¾çš„æƒ…å†µï¼Œæ²¡æœ‰è€ƒè™‘è‡ªå·±ä½œä¸ºæ»šåŠ¨å­è§†å›¾çš„æƒ…å†µã€‚</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>SearchViewæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/SearchView%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/SearchViewæºç è§£æ/</id>
    <published>2017-07-26T11:59:27.000Z</published>
    <updated>2017-07-26T12:03:12.475Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h1 id="SearchViewæºç è§£æ"><a href="#SearchViewæºç è§£æ" class="headerlink" title="SearchViewæºç è§£æ"></a>SearchViewæºç è§£æ</h1><p>SearchViewæ˜¯ä¸€ä¸ªæœç´¢æ¡†æ§ä»¶ï¼Œæ ·å¼ä¹ŸæŒºå¥½çœ‹çš„ã€‚è¿™æ¬¡è§£æä¸»è¦å›´ç»•<code>android.support.v7.widget</code>åŒ…ä¸‹çš„SearchViewï¼ˆAPI &gt;= 7ï¼‰,<code>android.widget.SearchView</code>æ”¯æŒAPI &gt;= 11ï¼Œ<br>å¦å¤–æœ‰ä¸ª<code>android.support.v4.widget.SearchViewCompat</code></p>
<p><img src="https://raw.githubusercontent.com/nukc/SearchViewAnalysis/master/art/searchview.mov.gif"></p>
<h2 id="1-æºç è§£æ"><a href="#1-æºç è§£æ" class="headerlink" title="1. æºç è§£æ"></a>1. æºç è§£æ</h2><p>v7ç‰ˆæœ¬ï¼š23.2.1</p>
<h3 id="1-1-ç»§æ‰¿å…³ç³»"><a href="#1-1-ç»§æ‰¿å…³ç³»" class="headerlink" title="1.1 ç»§æ‰¿å…³ç³»"></a>1.1 ç»§æ‰¿å…³ç³»</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">	â†³ android.view.View</div><div class="line">		â†³ android.view.ViewGroup</div><div class="line">			â†³ android.support.v7.widget.LinearLayoutCompat</div><div class="line">				â†³ android.support.v7.widget.SearchView</div></pre></td></tr></table></figure>
<h3 id="1-2-ä¸»è¦ç»„ä»¶"><a href="#1-2-ä¸»è¦ç»„ä»¶" class="headerlink" title="1.2 ä¸»è¦ç»„ä»¶"></a>1.2 ä¸»è¦ç»„ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SearchAutoComplete mSearchSrcTextView;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> View mSearchEditFrame;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> View mSearchPlate;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> View mSubmitArea;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ImageView mSearchButton;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ImageView mGoButton;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ImageView mCloseButton;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ImageView mVoiceButton;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> View mDropDownAnchor;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ImageView mCollapsedIcon;</div></pre></td></tr></table></figure>
<p>çœ‹å‘½åä¹Ÿèƒ½å¤§æ¦‚çŸ¥é“æ§ä»¶å„è‡ªå……å½“äº†ä»€ä¹ˆè§’è‰²äº†ã€‚</p>
<h3 id="1-3-æ„é€ æ–¹æ³•å’Œè‡ªå®šä¹‰"><a href="#1-3-æ„é€ æ–¹æ³•å’Œè‡ªå®šä¹‰" class="headerlink" title="1.3 æ„é€ æ–¹æ³•å’Œè‡ªå®šä¹‰"></a>1.3 æ„é€ æ–¹æ³•å’Œè‡ªå®šä¹‰</h3><p>æ¥ä¸‹æ¥çœ‹æ„é€ æ–¹æ³•<code>public SearchView(Context context, AttributeSet attrs, int defStyleAttr)</code>,<code>v7</code>çš„<code>SearchView</code>å¹¶ä¸æ˜¯ç”¨<code>TypedArray</code>è€Œæ˜¯ä½¿ç”¨<code>TintTypedArray</code>ï¼Œçœ‹äº†æºç å‘ç°<code>TintTypedArray</code>é‡Œæœ‰ä¸ªï¼š<figure class="highlight plain"><figcaption><span>final TypedArray mWrapped; ```æ‰€ä»¥ä¸»è¦è¿˜æ˜¯`TypedArray`ï¼Œä¸åŒç‚¹æ˜¯`getDrawable(int index)`å’Œæ–°åŠ çš„`getDrawableIfKnown(int index)`æ–¹æ³•ï¼Œ</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">å¹¶åœ¨æ»¡è¶³æ¡ä»¶ä¸‹ä¼šè°ƒç”¨`AppCompatDrawableManager.get().getDrawable(mContext, resourceId)`ã€‚</div><div class="line"></div><div class="line">ä¸ºäº†èƒ½æ›´å¥½çš„è‡ªå®šä¹‰ï¼Œ`SearchView`çš„layoutä¹Ÿæ˜¯å¯ä»¥æŒ‡å®šçš„ï¼Œä¸è¿‡è‡ªå®šä¹‰çš„layoutå¿…é¡»åŒ…æ‹¬ä¸Šé¢é‚£äº›æ§ä»¶ï¼ŒåŒæ—¶idä¹Ÿæ˜¯æŒ‡å®šçš„ï¼Œ</div><div class="line">ä¸ç„¶åé¢ä¼šæŠ¥é”™ï¼Œå› ä¸º`findViewById(id)`æ— æ³•æ‰¾åˆ°å„è‡ªæ§ä»¶ï¼Œç„¶åè°ƒç”¨æ§ä»¶æ–¹æ³•çš„æ—¶å€™å°±ã€‚ã€‚ã€‚</div><div class="line"></div><div class="line">æ„é€ æ–¹æ³•æœ€åæ˜¯æ›´æ–°æ§ä»¶çŠ¶æ€ï¼Œ`mIconifiedByDefault`é»˜è®¤æ˜¯`true`çš„ï¼Œ`setIconifiedByDefault(boolean iconified)`æ”¹å˜å€¼åä¹Ÿä¼šæ‰§è¡Œå¦‚ä¸‹æ–¹æ³•ï¼š</div><div class="line"></div><div class="line">```java</div><div class="line">    public void setIconifiedByDefault(boolean iconified) &#123;</div><div class="line">        if (mIconifiedByDefault == iconified) return;</div><div class="line">        mIconifiedByDefault = iconified;</div><div class="line">        //æ›´æ–°ç»„ä»¶</div><div class="line">        updateViewsVisibility(iconified);</div><div class="line">        updateQueryHint();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥<code>setIconifiedByDefault(false)</code>ä¼šè®©SearchViewä¸€ç›´å‘ˆç°å±•å¼€çŠ¶æ€ï¼Œå¹¶ä¸”è¾“å…¥æ¡†å†…iconä¹Ÿä¼šä¸æ˜¾ç¤ºã€‚å…·ä½“æ–¹æ³•å¦‚ä¸‹ï¼Œè¯¥æ–¹æ³•åœ¨<code>updateQueryHint()</code>ä¸­è¢«è°ƒç”¨ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> CharSequence <span class="title">getDecoratedHint</span><span class="params">(CharSequence hintText)</span> </span>&#123;</div><div class="line">    <span class="comment">//å¦‚æœmIconifiedByDefaultä¸ºfalseæˆ–è€…mSearchHintIconä¸ºnull</span></div><div class="line">    <span class="comment">//å°†ä¸ä¼šæ·»åŠ æœç´¢iconåˆ°æç¤ºhintä¸­</span></div><div class="line">    <span class="keyword">if</span> (!mIconifiedByDefault || mSearchHintIcon == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> hintText;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> textSize = (<span class="keyword">int</span>) (mSearchSrcTextView.getTextSize() * <span class="number">1.25</span>);</div><div class="line">    mSearchHintIcon.setBounds(<span class="number">0</span>, <span class="number">0</span>, textSize, textSize);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> SpannableStringBuilder ssb = <span class="keyword">new</span> SpannableStringBuilder(<span class="string">"   "</span>);</div><div class="line">    ssb.setSpan(<span class="keyword">new</span> ImageSpan(mSearchHintIcon), <span class="number">1</span>, <span class="number">2</span>, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</div><div class="line">    ssb.append(hintText);</div><div class="line">    <span class="keyword">return</span> ssb;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-4-Listener"><a href="#1-4-Listener" class="headerlink" title="1.4 Listener"></a>1.4 Listener</h3><p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹<code>SearchView</code>é‡Œé¢æœ‰å“ªäº›Listenerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//é‡Œé¢æœ‰2ä¸ªæ–¹æ³•ï¼š</span></div><div class="line">    <span class="comment">//onQueryTextSubmit(String query)ï¼šå½“ç”¨æˆ·æäº¤æŸ¥è¯¢çš„æ—¶å€™ä¼šè°ƒç”¨</span></div><div class="line">    <span class="comment">//onQueryTextChange(String newText)ï¼šå½“æŸ¥è¯¢æ–‡å­—æ”¹å˜çš„æ—¶å€™ä¼šè°ƒç”¨</span></div><div class="line"><span class="keyword">private</span> OnQueryTextListener mOnQueryChangeListener;</div><div class="line"></div><div class="line"><span class="comment">//é‡Œé¢æœ‰1ä¸ªæ–¹æ³•ï¼šboolean onClose();</span></div><div class="line">    <span class="comment">//onClose()ï¼šå½“mCloseButtonè¢«ç‚¹å‡»å’ŒsetIconified(true)ä¼šåˆ¤æ–­æ˜¯å¦è°ƒç”¨</span></div><div class="line">    <span class="comment">//æ˜¯å¦è°ƒç”¨æ˜¯åœ¨onCloseClicked()é‡Œåˆ¤æ–­ï¼Œåé¢ä¼šè¿›è¡Œåˆ†æ</span></div><div class="line"><span class="keyword">private</span> OnCloseListener mOnCloseListener;</div><div class="line"></div><div class="line"><span class="comment">//Viewç±»é‡Œå®šä¹‰çš„æ¥å£</span></div><div class="line"><span class="keyword">private</span> OnFocusChangeListener mOnQueryTextFocusChangeListener;</div><div class="line"></div><div class="line"><span class="comment">//é‡Œé¢æœ‰2ä¸ªæ–¹æ³•ï¼š</span></div><div class="line">    <span class="comment">//onSuggestionSelect(int position)ï¼šé€‰æ‹©å»ºè®®å¯é€‰é¡¹ï¼ˆæœç´¢æ¡†ä¸‹æ–¹å‡ºç°çš„ï¼‰åè§¦å‘</span></div><div class="line">    <span class="comment">//onSuggestionClick(int position)ï¼šç‚¹å‡»å»ºè®®å¯é€‰é¡¹åè§¦å‘</span></div><div class="line"><span class="keyword">private</span> OnSuggestionListener mOnSuggestionListener;</div><div class="line"></div><div class="line"><span class="comment">//Viewç±»é‡Œå®šä¹‰çš„æ¥å£</span></div><div class="line"><span class="keyword">private</span> OnClickListener mOnSearchClickListener;</div><div class="line"></div><div class="line"><span class="comment">//è¿˜æœ‰å…¶ä»–mOnClickListenerï¼ŒmTextKeyListenerç­‰</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹çœ‹OnQueryTextListeneræ˜¯æ€æ ·è¿›è¡Œç›‘å¬çš„ï¼š</p>
<ul>
<li>onQueryTextChange(String newText)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//åœ¨æ„é€ æ–¹æ³•é‡Œæ·»åŠ äº†ç›‘å¬</span></div><div class="line">mSearchSrcTextView.addTextChangedListener(mTextWatcher);</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨<code>mTextWatcher</code>çš„<code>onTextChanged()</code>æ–¹æ³•é‡Œè°ƒç”¨äº†SearchViewçš„<code>onTextChanged(CharSequence newText)</code>æ–¹æ³•ï¼Œ<br>ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œäº†åˆ¤æ–­è§¦å‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence newText)</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çœç•¥ä»£ç ,ä¸»è¦æ˜¯æ›´æ–°ç»„ä»¶</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">//å½“listener!=nullå’Œå½“æ–‡æœ¬ä¸ä¸€æ ·çš„æ—¶å€™ä¼šè§¦å‘ã€‚</span></div><div class="line">    <span class="keyword">if</span> (mOnQueryChangeListener != <span class="keyword">null</span> &amp;&amp; !TextUtils.equals(newText, mOldQueryText)) &#123;</div><div class="line">        mOnQueryChangeListener.onQueryTextChange(newText.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>onQueryTextSubmit(String query)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//åŒåœ¨æ„é€ æ–¹æ³•é‡Œæ·»åŠ äº†ç›‘å¬</span></div><div class="line">mSearchSrcTextView.setOnEditorActionListener(mOnEditorActionListener);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnEditorActionListener mOnEditorActionListener = <span class="keyword">new</span> OnEditorActionListener() &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called when the input method default action key is pressed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onEditorAction</span><span class="params">(TextView v, <span class="keyword">int</span> actionId, KeyEvent event)</span> </span>&#123;</div><div class="line">        onSubmitQuery();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSubmitQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">    CharSequence query = mSearchSrcTextView.getText();</div><div class="line">    <span class="keyword">if</span> (query != <span class="keyword">null</span> &amp;&amp; TextUtils.getTrimmedLength(query) &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">        <span class="comment">//å½“ç›‘å¬OnQueryChangeListeneräº†ä¹‹åï¼Œ</span></div><div class="line">        <span class="comment">//å½“onQueryTextSubmit() return trueçš„è¯ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œä¸‹é¢æ“ä½œçš„</span></div><div class="line">        <span class="keyword">if</span> (mOnQueryChangeListener == <span class="keyword">null</span></div><div class="line">                || !mOnQueryChangeListener.onQueryTextSubmit(query.toString())) &#123;</div><div class="line"></div><div class="line">            <span class="comment">//è®¾ç½®äº†Searchableåï¼Œä¼šstartActivityåˆ°é…ç½®æŒ‡å®šçš„Activity    </span></div><div class="line">            <span class="keyword">if</span> (mSearchable != <span class="keyword">null</span>) &#123;</div><div class="line">                launchQuerySearch(KeyEvent.KEYCODE_UNKNOWN, <span class="keyword">null</span>, query.toString());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//è®¾ç½®é”®ç›˜æ˜¯å¦æ˜¾ç¤º</span></div><div class="line">            setImeVisibility(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">            <span class="comment">//ä¸‹æ‹‰å¯é€‰é¡¹æ˜¯ç”¨ListPopupWindowæ˜¾ç¤ºçš„ï¼Œå…·ä½“å¯çœ‹ AutoCompleteTextView æºç </span></div><div class="line">            <span class="comment">//æœç´¢æäº¤åï¼Œdismissåå°±ä¸ä¼šç»§ç»­æ˜¾ç¤ºè€ŒæŒ¡ä½å†…å®¹ä»€ä¹ˆçš„</span></div><div class="line">            dismissSuggestions();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ifé‡ŒåŠ å…¥<code>!mOnQueryChangeListener.onQueryTextSubmit(query.toString())</code>ï¼Œè¿™æ ·åšå°±å¯ä»¥è®©ä½¿ç”¨è€…è‡ªå·±å†³å®šæ˜¯å¦å®Œå…¨è‡ªå·±å¤„ç†ï¼Œçµæ´»æ€§ä¹Ÿæ›´é«˜ã€‚</p>
<p>å…¶ä»–Listenerå·®ä¸å¤šä¹Ÿæ˜¯è¿™æ ·ï¼Œé‚£æ¥ä¸‹æ¥çœ‹çœ‹å…¶ä»–çš„ã€‚</p>
<h3 id="1-5-CollapsibleActionViewæ¥å£"><a href="#1-5-CollapsibleActionViewæ¥å£" class="headerlink" title="1.5 CollapsibleActionViewæ¥å£"></a>1.5 CollapsibleActionViewæ¥å£</h3><p>SearchViewå®ç°äº†CollapsibleActionViewæ¥å£ï¼šonActionViewExpanded()å’ŒonActionViewCollapsed(),å…·ä½“æ“ä½œå°±æ˜¯<br>è®¾ç½®é”®ç›˜åŠæ§ä»¶ï¼Œå¹¶ä½¿ç”¨å…¨å±€å˜é‡<code>mExpandedInActionView</code>è®°å½•ActionViewæ˜¯å¦ä¼¸å±•ã€‚åªæœ‰å½“SearchViewä½œä¸ºMenuItemçš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œå¦‚æœæ˜¯ä½¿ç”¨v7åŒ…çš„è¯ï¼Œæƒ³è¦é€šè¿‡menuè·å–SearchViewå°±éœ€è¦ä½¿ç”¨MenuItemCompatç±»ï¼Œå…·ä½“å¯ä»¥çœ‹demoã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MenuItemCompat.getActionView(android.view.MenuItem item);</div></pre></td></tr></table></figure></p>
<h3 id="1-6-çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤"><a href="#1-6-çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤" class="headerlink" title="1.6 çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤"></a>1.6 çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤</h3><p>SearchViewè¦†å†™äº†onSaveInstanceState()å’ŒonRestoreInstanceState(Parcelable state)ç”¨æ¥ä¿å­˜å’Œæ¢å¤çŠ¶æ€ï¼Œä¸ºä»€ä¹ˆè¦è¦†å†™å‘¢ï¼Ÿ<br>å› ä¸ºéœ€è¦é¢å¤–ä¿å­˜<code>boolean mIconified</code>ï¼Œä¸ºæ­¤è¿˜å»ºäº†ä¸ªå†…éƒ¨é™æ€ç±»SavedStateç”¨æ¥ä¿å­˜mIconifiedã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//å®ç°äº†Parcelableåºåˆ—åŒ–</span></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SavedState</span> <span class="keyword">extends</span> <span class="title">BaseSavedState</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> isIconified;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çœç•¥å…¶ä»–ä»£ç </div><div class="line">     */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-7-å…³äºSuggestionså’ŒSearchable"><a href="#1-7-å…³äºSuggestionså’ŒSearchable" class="headerlink" title="1.7 å…³äºSuggestionså’ŒSearchable"></a>1.7 å…³äºSuggestionså’ŒSearchable</h3><p>å¦‚æœä½ ä½¿ç”¨äº†Suggestionsï¼Œè€Œä¸”æ²¡æœ‰setSearchableInfoï¼Œé‚£ä¹ˆå½“ä½ ç‚¹å‡»å»ºè®®å¯é€‰é¡¹çš„æ—¶å€™ä¼šlogï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">W/SearchView: Search suggestions cursor at row <span class="number">0</span> returned exception.</div><div class="line">              java.lang.NullPointerException</div><div class="line">                  at android.support.v7.widget.SearchView.createIntentFromSuggestion(SearchView.java:<span class="number">1620</span>)</div><div class="line">                  at android.support.v7.widget.SearchView.launchSuggestion(SearchView.java:<span class="number">1436</span>)</div><div class="line">                  at android.support.v7.widget.SearchView.onItemClicked(SearchView.java:<span class="number">1349</span>)</div><div class="line">                  at android.support.v7.widget.SearchView.access$<span class="number">1800</span>(SearchView.java:<span class="number">103</span>)</div><div class="line">                  at android.support.v7.widget.SearchView$<span class="number">10</span>.onItemClick(SearchView.java:<span class="number">1373</span>)</div><div class="line">                  ......</div></pre></td></tr></table></figure>
<p>å®šä½åˆ°ç¬¬1620è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">createIntentFromSuggestion</span><span class="params">(Cursor c, <span class="keyword">int</span> actionKey, String actionMsg)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// use specific action if supplied, or default action if supplied, or fixed default</span></div><div class="line">        String action = getColumnString(c, SearchManager.SUGGEST_COLUMN_INTENT_ACTION);</div><div class="line"></div><div class="line">        <span class="comment">//åœ¨è¿™é‡Œå¹¶æ²¡æœ‰æ£€æŸ¥mSearchableæ˜¯å¦ä¸ºnull</span></div><div class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span> &amp;&amp; Build.VERSION.SDK_INT &gt;= <span class="number">8</span>) &#123;</div><div class="line">            action = mSearchable.getSuggestIntentAction();  <span class="comment">//ç¬¬1620è¡Œ</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         *çœç•¥éƒ¨åˆ†ä»£ç </div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="keyword">return</span> createIntent(action, dataUri, extraData, query, actionKey, actionMsg);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e ) &#123;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         *çœç•¥éƒ¨åˆ†ä»£ç </div><div class="line">         */</div><div class="line"></div><div class="line">        Log.w(LOG_TAG, <span class="string">"Search suggestions cursor at row "</span> + rowNum +</div><div class="line">                                <span class="string">" returned exception."</span>, e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‘ç°è°ƒç”¨mSearchableçš„æ–¹æ³•ä¹‹å‰å¹¶æ²¡æœ‰æ£€æŸ¥mSearchableæ˜¯å¦ä¸ºnullï¼Œå…¶ä»–åœ°æ–¹æ˜¯æœ‰åˆ¤æ–­çš„ï¼Œç”±äºåšäº†catchæ‰€ä»¥ä¸ä¼šcrashï¼Œä¹Ÿä¸å½±å“ä½¿ç”¨ï¼Œå¦å¤–ï¼Œå¦‚æœsetOnSuggestionListenerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mSearchView.setOnQueryTextListener(<span class="keyword">new</span> SearchView.OnQueryTextListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String newText)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//è¿”å›true</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>onSuggestionClick(int position) è¿”å› true å°±ä¸ä¼šæ‰§è¡Œ<code>createIntentFromSuggestion(~)</code>ï¼Œ<br>ä¹Ÿå°±ä¸ä¼šlogäº†ï¼Œä½†è¿™æ ·ï¼Œé”®ç›˜çš„éšè—å’Œå¯é€‰é¡¹popçš„dismissä¹Ÿä¸ä¼šæ‰§è¡Œï¼Œéœ€è¦è‡ªå·±å¤„ç†ï¼Œä½¿ç”¨SearchViewçš„<code>clearFocus()</code>æ–¹æ³•å°±èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<p>é‚£æ—¢ç„¶æ˜¯æŠ¥nullï¼Œé‚£å°±è®¾ç½®Searchableå§ï¼Œè®¾ç½®åæ˜¯ä¼šstartActivityçš„(æ‰§è¡Œå®ŒcreateIntentFromSuggestion(~)åå°±ä¼šæ‰§è¡Œ)ã€‚<br>ç„¶åæ•ˆæœå°±æ˜¯å½“ä½ ç‚¹å‡»äº†å¯é€‰é¡¹å°±ä¼šstartActivityï¼Œçœ‹éœ€æ±‚åšé€‰æ‹©å§ã€‚ã€‚</p>
<h3 id="1-8-è¯­éŸ³æœç´¢åŠŸèƒ½"><a href="#1-8-è¯­éŸ³æœç´¢åŠŸèƒ½" class="headerlink" title="1.8 è¯­éŸ³æœç´¢åŠŸèƒ½"></a>1.8 è¯­éŸ³æœç´¢åŠŸèƒ½</h3><p>SearchViewè¿˜æœ‰è¯­éŸ³æœç´¢åŠŸèƒ½(API &gt;= 8)ï¼Œéœ€è¦é€šè¿‡é…ç½®Searchableæ¥å¼€å¯ï¼Œåœ¨xmlé…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:voiceSearchMode="showVoiceSearchButton|launchRecognizer"</div></pre></td></tr></table></figure>
<p><code>showVoiceSearchButton</code>æ˜¾ç¤ºè¯­éŸ³æœç´¢æŒ‰é’®ï¼Œ<code>launchRecognizer</code>è¡¨ç¤ºè¦å¯åŠ¨ä¸€ä¸ªè¯­éŸ³è¯†åˆ«å™¨æ¥è½¬æ¢æˆæ–‡å­—ä¼ ç»™æŒ‡å®šçš„searchable activityã€‚<br>æœ‰ä¸ªå…¨å±€å˜é‡<code>boolean mVoiceButtonEnabled</code>è¡¨ç¤ºæ˜¯å¦å¯ç”¨ï¼Œåœ¨<code>setSearchableInfo(~)</code>æ–¹æ³•é‡Œè¿›è¡Œäº†è®¾ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mVoiceButtonEnabled = IS_AT_LEAST_FROYO &amp;&amp; hasVoiceSearch();</div></pre></td></tr></table></figure>
<p>IS_AT_LEAST_FROYOæ˜¯Build.VERSION.SDK_INT &gt;= 8ï¼Œä¸ºäº†ç¡®ä¿æ­£ç¡®æ€§ï¼Œæˆ‘è¯•äº†ä¸‹ï¼Œç»“æœå¹¶æ²¡æœ‰æ˜¾ç¤ºè¯­è¨€æœç´¢æŒ‰é’®ï¼Œ<br>debugåå‘ç°åœ¨hasVoiceSearch()é‡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ResolveInfo ri = getContext().getPackageManager().resolveActivity(testIntent,</div><div class="line">        PackageManager.MATCH_DEFAULT_ONLY);</div><div class="line"><span class="keyword">return</span> ri != <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œå¹¶æ²¡æœ‰resolveåˆ°Activityï¼Œç»“æœreturn falseï¼ŒmVoiceButtonEnabledä¹Ÿå°±å˜æˆfalseäº†</p>
<p>ç»ˆäºçŸ¥é“ä¸ºä»€ä¹ˆäº†ï¼ŒåŸæ¥é˜‰å‰²ç‰ˆçš„ç³»ç»Ÿéƒ½ä¸ä¼šå‡ºç°è¯­éŸ³æœç´¢æŒ‰é’®ï¼Œåä¸º/é­…æ—/Genymotionè¯•è¿‡éƒ½ä¸è¡Œ(æ²¡æœ‰è¯•è¿‡å…¨ç‰ˆæœ¬ç³»ç»Ÿ)ï¼ŒASè‡ªå¸¦æ¨¡æ‹Ÿå™¨å¯ä»¥(æœ‰GoogleæœåŠ¡)ï¼Œå…·ä½“åº”è¯¥å°±æ˜¯æ²¡æœ‰resolveåˆ°Googleè¯­éŸ³è¯†åˆ«Activityã€‚å¯¹è¯­éŸ³è¯†åˆ«æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æœç´¢RecognizerIntentã€‚</p>
<h3 id="1-9-AutoCompleteTextViewReflector"><a href="#1-9-AutoCompleteTextViewReflector" class="headerlink" title="1.9 AutoCompleteTextViewReflector"></a>1.9 AutoCompleteTextViewReflector</h3><p>v7åŒ…çš„SearchViewä½¿ç”¨äº†åå°„æœºåˆ¶ï¼Œé€šè¿‡åå°„æ‹¿åˆ°AutoCompleteTextViewå’ŒInputMethodManageréšè—çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> AutoCompleteTextViewReflector HIDDEN_METHOD_INVOKER = <span class="keyword">new</span> AutoCompleteTextViewReflector();</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoCompleteTextViewReflector</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Method doBeforeTextChanged, doAfterTextChanged;</div><div class="line">    <span class="keyword">private</span> Method ensureImeVisible;</div><div class="line">    <span class="keyword">private</span> Method showSoftInputUnchecked;</div><div class="line"></div><div class="line">    AutoCompleteTextViewReflector() &#123;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çœç•¥éƒ¨åˆ†ä»£ç </div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            showSoftInputUnchecked = InputMethodManager.class.getMethod(</div><div class="line">                    <span class="string">"showSoftInputUnchecked"</span>, <span class="keyword">int</span>.class, ResultReceiver.class);</div><div class="line">            showSoftInputUnchecked.setAccessible(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="comment">// Ah well.</span></div><div class="line">        &#125;</div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * çœç•¥éƒ¨åˆ†ä»£ç </div><div class="line">     */        </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showSoftInputUnchecked</span><span class="params">(InputMethodManager imm, View view, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (showSoftInputUnchecked != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                showSoftInputUnchecked.invoke(imm, flags, <span class="keyword">null</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//åªæœ‰è¿™ä¸ªæ–¹æ³•æ‰æœ‰åœ¨ifåé¢åšå¤„ç†</span></div><div class="line">        <span class="comment">// Hidden method failed, call public version instead</span></div><div class="line">        imm.showSoftInput(view, flags);</div><div class="line">    &#125;        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-10-onMeasure-æµ‹é‡"><a href="#1-10-onMeasure-æµ‹é‡" class="headerlink" title="1.10 onMeasure æµ‹é‡"></a>1.10 onMeasure æµ‹é‡</h3><p>æŸ¥çœ‹äº†ä¸‹<code>onMeasure</code>ï¼Œå‘ç°æœ‰ä¸ªåœ°æ–¹è¿˜æ˜¯æ¯”è¾ƒåœ¨æ„çš„ã€‚ å½“<code>isIconified()</code>è¿”å›<code>false</code>çš„æ—¶å€™ï¼Œwidthçš„modeåœ¨æœ€åéƒ½ä¼šè¢«è®¾ç½®æˆ<code>MeasureSpec.EXACTLY</code>ã€‚</p>
<p>åœ¨SearchViewä¼¸å±•æ”¶ç¼©çš„æ—¶å€™ï¼Œ<code>onMeasure</code>ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œwidthæ ¹æ®å…¶modeæ”¹å˜, ä¹‹åmodeè®¾ç½®ä¸ºEXACTLYå†è°ƒç”¨çˆ¶ç±»superæ–¹æ³•è¿›è¡Œæµ‹é‡ã€‚</p>
<p>è®¾ç½®ä¸ºEXACTLYï¼Œè¿™æ ·çˆ¶æ§ä»¶å°±èƒ½ç¡®åˆ‡çš„å†³å®šviewçš„å¤§å°ï¼Œé‚£ä¸ºä»€ä¹ˆåªå¯¹widthè€Œä¸å¯¹heightè¿›è¡Œè®¾ç½®å‘¢?</p>
<p>é€šè¿‡æŸ¥çœ‹é»˜è®¤çš„ <a href="https://github.com/nukc/SearchViewAnalysis/blob/master/app%2Fsrc%2Fmain%2Fres%2Flayout%2Flayout_search.xml" target="_blank" rel="external">layout</a>ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦ç»„ä»¶çš„layout_heightçš„å¤§å¤šéƒ½æ˜¯match_parent(å¯¹åº”EXACTLYæ¨¡å¼)ï¼Œè€Œlayout_widthåŸºæœ¬éƒ½æ˜¯wrap_content(å¯¹åº”AT_MOSTæ¨¡å¼)ã€‚</p>
<p>å¦å¤–ï¼Œä¸æ˜¯åªæœ‰ä¼¸å±•æ”¶ç¼©çš„æ—¶å€™ï¼Œ<code>onMeasure</code>æ‰ä¼šè¢«æ‰§è¡Œ, ç‚¹å‡»è¯­éŸ³æœç´¢æŒ‰é’®/è¾“å…¥æ¡†è·å–ç„¦ç‚¹çš„æ—¶å€™/â€¦ä¹Ÿä¼šæ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="comment">// Let the standard measurements take effect in iconified state.</span></div><div class="line">    <span class="keyword">if</span> (isIconified()) &#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">    <span class="keyword">int</span> width = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (widthMode) &#123;</div><div class="line">        <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">            <span class="comment">// If there is an upper limit, don't exceed maximum width (explicit or implicit)</span></div><div class="line">            <span class="keyword">if</span> (mMaxWidth &gt; <span class="number">0</span>) &#123;</div><div class="line">                width = Math.min(mMaxWidth, width);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                width = Math.min(getPreferredWidth(), width);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">            <span class="comment">// If an exact width is specified, still don't exceed any specified maximum width</span></div><div class="line">            <span class="keyword">if</span> (mMaxWidth &gt; <span class="number">0</span>) &#123;</div><div class="line">                width = Math.min(mMaxWidth, width);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">            <span class="comment">// Use maximum width, if specified, else preferred width</span></div><div class="line">            width = mMaxWidth &gt; <span class="number">0</span> ? mMaxWidth : getPreferredWidth();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    widthMode = MeasureSpec.EXACTLY;</div><div class="line">    <span class="keyword">super</span>.onMeasure(MeasureSpec.makeMeasureSpec(width, widthMode), heightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-å±•æœ›æœªæ¥"><a href="#2-å±•æœ›æœªæ¥" class="headerlink" title="2. å±•æœ›æœªæ¥"></a>2. å±•æœ›æœªæ¥</h2><p>åœ¨v7åŒ…çš„SearchViewé‡Œï¼Œæœ‰ä¸€ä¸ªå£°æ˜å¹¶åˆå§‹åŒ–äº†çš„å˜é‡ï¼Œä½†å¹¶æ²¡æœ‰ç”¨åˆ°è¿‡:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AppCompatDrawableManager mDrawableManager;</div><div class="line"></div><div class="line"><span class="comment">//åœ¨æ„é€ æ–¹æ³•é‡Œåˆå§‹åŒ–</span></div><div class="line">mDrawableManager = AppCompatDrawableManager.get();</div></pre></td></tr></table></figure>
<p>æˆ–è®¸åç»­ç‰ˆæœ¬ä¼šç”¨åˆ°å§! æŠ±ç€å¥½å¥‡çš„å¿ƒå»çœ‹äº†<code>AppCompatDrawableManager</code>æºç ï¼Œä½†å¹¶æ²¡æœ‰æ³¨é‡Šè¯´æ˜è¿™ä¸ªç±»æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Œçœ‹åå­—åªçŸ¥é“æ˜¯ç®¡ç†Drawableçš„ã€‚</p>
<p>æ—¢ç„¶è¿™æ ·ï¼Œé‚£å°±æ¥çœ‹ä¸‹<code>AppCompatDrawableManager</code>èƒ½å¹²äº›ä»€ä¹ˆå§ã€‚</p>
<p>ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œå…ˆçœ‹çœ‹å®ƒåˆå§‹åŒ–çš„æ—¶å€™å¹²äº†äº›ä»€ä¹ˆï¼ŒæŸ¥çœ‹<code>get()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppCompatDrawableManager <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//ä½¿ç”¨äº†æ‡’æ±‰å¼</span></div><div class="line">    <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">        INSTANCE = <span class="keyword">new</span> AppCompatDrawableManager();</div><div class="line">        installDefaultInflateDelegates(INSTANCE);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> INSTANCE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installDefaultInflateDelegates</span><span class="params">(@NonNull AppCompatDrawableManager manager)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sdk = Build.VERSION.SDK_INT;</div><div class="line">    <span class="comment">// åªåœ¨Android 5.0ä»¥ä¸‹çš„ç³»ç»Ÿ</span></div><div class="line">    <span class="keyword">if</span> (sdk &lt; <span class="number">21</span>) &#123;</div><div class="line">        <span class="comment">// åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ VectorDrawableCompat è¿›è¡Œè‡ªåŠ¨å¤„ç†</span></div><div class="line">        manager.addDelegate(<span class="string">"vector"</span>, <span class="keyword">new</span> VdcInflateDelegate());</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sdk &gt;= <span class="number">11</span>) &#123;</div><div class="line">            <span class="comment">// AnimatedVectorDrawableCompat åªèƒ½åœ¨ API v11+ ä½¿ç”¨</span></div><div class="line">            manager.addDelegate(<span class="string">"animated-vector"</span>, <span class="keyword">new</span> AvdcInflateDelegate());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»è¿™é‡Œ, æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè·Ÿ<code>Vector</code>(çŸ¢é‡)æœ‰å…³ã€‚</p>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/4535e11fb7010f2b104d3f8b3954407b9f330e0f/graphics/java/android/graphics/drawable/VectorDrawable.java" target="_blank" rel="external">VectorDrawable</a><br>èƒ½åˆ›å»ºä¸€ä¸ªåŸºäºxmlæè¿°çš„çŸ¢é‡å›¾;</li>
<li><a href="https://github.com/android/platform_frameworks_base/blob/4535e11fb7010f2b104d3f8b3954407b9f330e0f/graphics/java/android/graphics/drawable/AnimatedVectorDrawable.java" target="_blank" rel="external">AnimatedVectorDrawable</a><br>ä½¿ç”¨<code>ObjectAnimator</code>å’Œ<code>AnimatorSet</code>ä¸ºVectorDrawableåˆ›å»ºåŠ¨ç”»ã€‚</li>
</ul>
<p>ç„¶åæˆ‘ç²—ç•¥çš„çœ‹äº†æ–¹æ³•åï¼Œæœ‰å‡ ä¸ªå…³é”®è¯: <code>Tint</code>ç€è‰²ï¼Œ<code>Cache</code>ï¼Œâ€¦â€¦</p>
<p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æœä¸‹ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œå°±ä¸å†æ·±å…¥äº†ã€‚</p>
<p>å¦‚æœæˆ‘å“ªé‡Œåˆ†æé”™äº†ï¼Œè¯·å¤§å®¶åŠæ—¶çº æ­£æˆ‘ï¼Œè°¢è°¢ã€‚</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Scrolleræºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/Scroller%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/Scrolleræºç è§£æ/</id>
    <published>2017-07-26T11:58:31.000Z</published>
    <updated>2017-07-26T11:58:54.457Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<blockquote>
<p>æœ¬æ–‡åˆ†æç‰ˆæœ¬: <strong>Android API 22</strong></p>
</blockquote>
<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p><code>Android</code>å¼€å‘ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ä½¿ä¸€ä¸ª<code>View</code>æ»‘åŠ¨çš„è¯ï¼Œé™¤äº†ä½¿ç”¨å±æ€§åŠ¨ç”»å¤–ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›ç»™æˆ‘ä»¬çš„ä¸¤ä¸ªç±»<code>Scroller</code>å’Œ<code>OverScroller</code>ç”¨æ¥å®ç°å¼¹æ€§æ»‘åŠ¨ã€‚åœ¨æˆ‘ä»¥å‰çš„ä¸€ç¯‡<a href="http://www.jianshu.com/p/07d717ef0b28" target="_blank" rel="external">ViewDragHelperæºç åˆ†æ</a>ä¸­æˆ‘ä»¬æœ‰è®²åˆ°è¿‡<code>Scroller</code>çš„ä½œç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©å°±æ¥ä»”ç»†åˆ†æä¸€ä¸‹<code>Scroller</code>çš„ä½¿ç”¨æ–¹æ³•ä»¥åŠå®ç°æ–¹å¼ã€‚</p>
<h2 id="2-ä½¿ç”¨æ–¹æ³•"><a href="#2-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="2. ä½¿ç”¨æ–¹æ³•"></a>2. ä½¿ç”¨æ–¹æ³•</h2><p>åœ¨çœ‹<code>Scroller</code>çš„ä½¿ç”¨æ–¹æ³•ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹<code>View</code>ä¸­çš„<code>scrollBy()</code>å’Œ<code>scrollTo()</code>æ–¹æ³•ï¼Œ<code>scrollTo()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollTo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line"> 	<span class="comment">//å¦‚æœå½“å‰åç§»é‡å˜åŒ–</span></div><div class="line">     <span class="keyword">if</span> (mScrollX != x || mScrollY != y) &#123;</div><div class="line">         <span class="keyword">int</span> oldX = mScrollX;</div><div class="line">         <span class="keyword">int</span> oldY = mScrollY;</div><div class="line"><span class="comment">//èµ‹å€¼åç§»é‡</span></div><div class="line">         mScrollX = x;</div><div class="line">         mScrollY = y;</div><div class="line">         invalidateParentCaches();</div><div class="line">         <span class="comment">//å›è°ƒonScrollChangedæ–¹æ³•</span></div><div class="line">         onScrollChanged(mScrollX, mScrollY, oldX, oldY);</div><div class="line">         <span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">             postInvalidateOnAnimation();</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><code>scrollTo()</code>æ˜¯æŒ‡å°†å½“å‰è§†å›¾å†…å®¹æ¨ªå‘åç§»<code>x</code>è·ç¦»ï¼Œçºµå‘åç§»<code>y</code>è·ç¦»ã€‚æ³¨æ„è¿™é‡Œæ˜¯<code>View</code>çš„å†…å®¹çš„åç§»ï¼Œè€Œä¸æ˜¯<code>View</code>æœ¬èº«ã€‚è€Œ<code>scrollBy()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollBy</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    scrollTo(mScrollX + x, mScrollY + y);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>scrollBy()</code>æ–¹æ³•é‡Œç›´æ¥è°ƒç”¨äº†<code>scrollTo()</code>æ–¹æ³•ï¼Œè¡¨ç¤ºåœ¨å½“å‰åç§»é‡çš„åŸºç¡€ä¸Šç»§ç»­åç§»<code>(x,y)</code>ã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹<code>Scroller</code>çš„ç”¨æ³•ã€‚<a href="https://github.com/Skykai521/SkyScrollerDemo" target="_blank" rel="external">SkyScrollerDemo</a>æ˜¯æˆ‘å†™çš„ä¸€ä¸ª<code>Scroller</code>å’Œ<code>OverScroller</code>çš„ä½¿ç”¨<code>demo</code>ã€‚ä¸‹é¢çš„ç”¨æ³•éƒ½æ˜¯æ¥è‡ªäºè¿™ä¸ª<code>demo</code>é‡Œï¼Œå¤§å®¶å¯ä»¥<code>clone</code>ä¸‹æ¥é…åˆæœ¬æ–‡ä¸€èµ·é˜…è¯»ã€‚æœ¬æ–‡æˆ‘ä»¬ä¸»è¦ç ”ç©¶<code>Scroller</code>ã€‚å¯¹äº<code>OverScroller</code>æˆ‘åœ¨<code>demo</code>é‡Œä¹Ÿå†™äº†ç›¸å…³çš„ä½¿ç”¨æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡çš„æœ€åæˆ‘ä»¬å†åšè®¨è®ºã€‚</p>
<p><code>Scroller</code>ä¸€èˆ¬éœ€è¦é…åˆé‡å†™<code>computeScroll()</code>ä¸€èµ·ä½¿ç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScrollTextView</span> <span class="keyword">extends</span> <span class="title">TextView</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> Scroller mScroller;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ScrollTextView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        <span class="keyword">this</span>.mContext = context;</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mScroller = <span class="keyword">new</span> Scroller(mContext);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class="line">            offsetLeftAndRight(mScroller.getCurrX() - mLeft);</div><div class="line">            offsetTopAndBottom(mScroller.getCurrY() - mTop);</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ä»¥mLeft,mTopä¸ºåˆå§‹ç‚¹ï¼Œåœ¨DEFAULT_DURATIONçš„æ—¶é—´å†…ï¼Œåœ¨Yè½´ä¸Šæ»‘åŠ¨-400çš„åç§»é‡</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScrollerScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">        mScroller.startScroll(mLeft, mTop, <span class="number">0</span>, -<span class="number">400</span>, DEFAULT_DURATION);</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ä»¥mLeft,mTopä¸ºåˆå§‹ç‚¹ï¼Œå¹¶ä»¥Yæ–¹å‘ä¸Š-5000çš„åŠ é€Ÿåº¦æ»‘åŠ¨ï¼Œæœ€å°Yåæ ‡ä¸º200ï¼Œæœ€å¤§Yåæ ‡ä¸º1200</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScrollerFling</span><span class="params">()</span> </span>&#123;</div><div class="line">        mScroller.fling(mLeft, mTop, <span class="number">0</span>, -<span class="number">5000</span>, mLeft, mLeft, <span class="number">200</span>, <span class="number">1200</span>);</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>startScrollerScroll()</code>ä¸<code>startScrollerFling()</code>æ–¹æ³•æ—¶æˆ‘ä»¬å°±å‘ç°<code>View</code>æ»‘åŠ¨äº†ã€‚å¦‚æœä»¥å‰æ²¡äº†è§£è¿‡<code>Scroller</code>çš„åŒå­¦å¯èƒ½ä¼šä¸ç†è§£ã€‚è¿™é‡Œå¤§è‡´åˆ†æä¸€ä¸‹è°ƒç”¨æµç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“<code>Scroller</code>å…¶å®åªè´Ÿè´£è®¡ç®—ï¼Œå®ƒå¹¶ä¸è´Ÿè´£æ»‘åŠ¨<code>View</code>ï¼Œå½“æˆ‘ä»¬è°ƒç”¨äº†<code>Scroller</code>çš„<code>startScrollerScroll()</code>æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ç´§æ¥ç€è°ƒç”¨äº†<code>invalidate()</code>æ–¹æ³•ã€‚<code>invalidate()</code>æ–¹æ³•ä¼šä½¿<code>View</code>é‡æ–°ç»˜åˆ¶ã€‚å› æ­¤ä¼šè°ƒç”¨<code>View</code>çš„<code>draw()</code>æ–¹æ³•ï¼Œåœ¨<code>View</code>çš„<code>draw()</code>æ–¹æ³•ä¸­åˆä¼šå»è°ƒç”¨<code>computeScroll()</code>æ–¹æ³•ï¼Œ<code>computeScroll()</code>æ–¹æ³•åœ¨<code>View</code>ä¸­æ˜¯ä¸€ä¸ªç©ºå®ç°ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°<code>computeScroll()</code>æ–¹æ³•ã€‚åœ¨ä¸Šé¢çš„<code>computeScroll()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†<code>mScroller.computeScrollOffset()</code>æ–¹æ³•æ¥è®¡ç®—å½“å‰æ»‘åŠ¨çš„åç§»é‡ã€‚å¦‚æœè¿˜åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­å°±ä¼šè¿”å›<code>true</code>ã€‚æ‰€ä»¥æˆ‘ä»¬å°±èƒ½åœ¨<code>if</code>ä¸­é€šè¿‡<code>Scroller</code>æ‹¿åˆ°å½“å‰çš„æ»‘åŠ¨åæ ‡ä»è€Œåšä»»ä½•æˆ‘ä»¬æƒ³åšçš„å¤„ç†ã€‚åœ¨<code>demo</code>é‡Œæˆ‘ä»¬æ ¹æ®æ»‘åŠ¨çš„åç§»é‡æ¥æ”¹å˜äº†<code>View</code>çš„åæ ‡åç§»é‡ã€‚ä»è€Œå½¢æˆäº†æ»‘åŠ¨åŠ¨ç”»ã€‚ä¸‹é¢æˆ‘ä»¬è§£é‡Šä¸€ä¸‹<code>Scroller</code>çš„ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“ä½œç”¨ï¼š</p>
<h3 id="1-startScroll-int-startX-int-startY-int-dx-int-dy-int-duration"><a href="#1-startScroll-int-startX-int-startY-int-dx-int-dy-int-duration" class="headerlink" title="1.startScroll(int startX, int startY, int dx, int dy, int duration):"></a>1.startScroll(int startX, int startY, int dx, int dy, int duration):</h3><p>é€šè¿‡èµ·å§‹ç‚¹ã€åç§»çš„è·ç¦»å’Œæ»‘åŠ¨çš„æ—¶é—´æ¥å¼€å§‹æ»‘åŠ¨ã€‚</p>
<ul>
<li>startX èµ·å§‹æ»‘åŠ¨ç‚¹çš„Xåæ ‡</li>
<li>startY èµ·å§‹æ»‘åŠ¨ç‚¹çš„Yåæ ‡</li>
<li>dx æ»‘åŠ¨çš„æ°´å¹³åç§»é‡ã€‚&gt;0 åˆ™è¡¨ç¤ºå¾€å·¦æ»‘åŠ¨ã€‚</li>
<li>dy æ»‘åŠ¨çš„å‚ç›´åç§»é‡ã€‚&gt;0 åˆ™è¡¨ç¤ºå¾€ä¸Šæ»‘åŠ¨ã€‚</li>
<li>duration æ»‘åŠ¨æ‰§è¡Œçš„æ—¶é—´</li>
</ul>
<h3 id="2-fling-int-startX-int-startY-int-velocityX-int-velocityY-int-minX-int-maxX-int-minY-int-maxY"><a href="#2-fling-int-startX-int-startY-int-velocityX-int-velocityY-int-minX-int-maxX-int-minY-int-maxY" class="headerlink" title="2.fling(int startX, int startY, int velocityX, int velocityY, int minX, int maxX, int minY, int maxY) :"></a>2.fling(int startX, int startY, int velocityX, int velocityY, int minX, int maxX, int minY, int maxY) :</h3><p>åŸºäºä¸€ä¸ªå¿«é€Ÿæ»‘åŠ¨æ‰‹åŠ¿ä¸‹çš„æ»‘åŠ¨ã€‚æ»‘åŠ¨çš„è·ç¦»ä¸è¿™ä¸ªæ‰‹åŠ¿æœ€åˆçš„åŠ é€Ÿåº¦æœ‰å…³ã€‚</p>
<ul>
<li>startX èµ·å§‹æ»‘åŠ¨ç‚¹çš„Xåæ ‡</li>
<li>startY èµ·å§‹æ»‘åŠ¨ç‚¹çš„Yåæ ‡</li>
<li>velocityX Xæ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦</li>
<li>velocityY Yæ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦</li>
<li>minX Xæ–¹å‘ä¸Šæ»‘åŠ¨çš„æœ€å°å€¼ï¼Œä¸ä¼šæ»‘åŠ¨è¶…è¿‡è¿™ä¸ªç‚¹</li>
<li>maxX Xæ–¹å‘ä¸Šæ»‘åŠ¨çš„æœ€å¤§å€¼ï¼Œä¸ä¼šæ»‘åŠ¨è¶…è¿‡è¿™ä¸ªç‚¹</li>
<li>minY Yæ–¹å‘ä¸Šæ»‘åŠ¨çš„æœ€å°å€¼ï¼Œä¸ä¼šæ»‘åŠ¨è¶…è¿‡è¿™ä¸ªç‚¹</li>
<li>maxY Yæ–¹å‘ä¸Šæ»‘åŠ¨çš„æœ€å¤§å€¼ï¼Œä¸ä¼šæ»‘åŠ¨è¶…è¿‡è¿™ä¸ªç‚¹</li>
</ul>
<h2 id="3-æºç åˆ†æ"><a href="#3-æºç åˆ†æ" class="headerlink" title="3. æºç åˆ†æ"></a>3. æºç åˆ†æ</h2><p>æˆ‘ä»¬ä¾ç„¶é€šè¿‡è°ƒç”¨æµç¨‹æ¥åˆ†æ<code>Scroller</code>çš„å®ç°ï¼š</p>
<h3 id="1-æ„é€ æ–¹æ³•"><a href="#1-æ„é€ æ–¹æ³•" class="headerlink" title="1.æ„é€ æ–¹æ³•"></a>1.æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Scroller</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Scroller</span><span class="params">(Context context, Interpolator interpolator)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(context, interpolator,</div><div class="line">            context.getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.HONEYCOMB);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Scroller</span><span class="params">(Context context, Interpolator interpolator, <span class="keyword">boolean</span> flywheel)</span> </span>&#123;</div><div class="line">    mFinished = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (interpolator == <span class="keyword">null</span>) &#123;</div><div class="line">        mInterpolator = <span class="keyword">new</span> ViscousFluidInterpolator();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mInterpolator = interpolator;</div><div class="line">    &#125;</div><div class="line">    mPpi = context.getResources().getDisplayMetrics().density * <span class="number">160.0f</span>;</div><div class="line">    mDeceleration = computeDeceleration(ViewConfiguration.getScrollFriction());</div><div class="line">    mFlywheel = flywheel;</div><div class="line"></div><div class="line">    mPhysicalCoeff = computeDeceleration(<span class="number">0.84f</span>); <span class="comment">// look and feel tuning</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆéƒ½ä¼šè°ƒç”¨æœ€åä¸€ä¸ªæ„é€ æ–¹æ³•ã€‚å¿…é¡»ä¼ å…¥<code>Context</code>å¯¹è±¡ã€‚å¯ä»¥ä¼ å…¥è‡ªå®šä¹‰çš„<code>interpolator</code>å’Œæ˜¯å¦æ”¯æŒé£è½®<code>flywheel</code>çš„åŠŸèƒ½ï¼Œå½“ç„¶è¿™ä¸¤ä¸ªå¹¶ä¸æ˜¯å¿…é¡»çš„ã€‚å¦‚æœä¸ä¼ å…¥<code>interpolator</code>ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ª<code>ViscousFluidInterpolator</code>ï¼Œä»å­—é¢æ„ä¹‰ä¸Šçœ‹æ˜¯ä¸€ä¸ªç²˜æ€§æµä½“æ’å€¼å™¨ã€‚å¯¹äº<code>flywheel</code>æ˜¯æŒ‡æ˜¯å¦æ”¯æŒåœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰æ–°çš„<code>fling()</code>æ–¹æ³•è°ƒç”¨æ˜¯å¦ç´¯åŠ åŠ é€Ÿåº¦ã€‚å¦‚æœä¸ä¼ é»˜è®¤åœ¨2.3ä»¥ä¸Šéƒ½ä¼šæ”¯æŒã€‚å‰©ä¸‹å°±æ˜¯åˆå§‹åŒ–äº†ä¸€äº›ç”¨äºè®¡ç®—çš„å‚æ•°ã€‚è¿™æ ·å°±å®Œæˆäº†<code>Scroller</code>çš„åˆå§‹åŒ–äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹<code>startScroll()</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<h3 id="2-startScroll-æ–¹æ³•çš„å®ç°"><a href="#2-startScroll-æ–¹æ³•çš„å®ç°" class="headerlink" title="2.startScroll()æ–¹æ³•çš„å®ç°"></a>2.startScroll()æ–¹æ³•çš„å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScroll</span><span class="params">(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span> duration)</span> </span>&#123;</div><div class="line">  <span class="comment">// mMode åˆ†ä¸¤ç§æ–¹å¼ 1.æ»‘åŠ¨:SCROLL_MODE 2. åŠ é€Ÿåº¦æ»‘åŠ¨:FLING_MODE</span></div><div class="line">  mMode = SCROLL_MODE;</div><div class="line">  <span class="comment">// æ˜¯å¦æ»‘åŠ¨ç»“æŸ è¿™é‡Œæ˜¯å¼€å§‹æ‰€ä»¥è®¾ç½®ä¸ºfalse</span></div><div class="line">  mFinished = <span class="keyword">false</span>;</div><div class="line">  <span class="comment">// æ»‘åŠ¨çš„æ—¶é—´</span></div><div class="line">  mDuration = duration;</div><div class="line">  <span class="comment">// å¼€å§‹çš„æ—¶é—´</span></div><div class="line">  mStartTime = AnimationUtils.currentAnimationTimeMillis();</div><div class="line">  <span class="comment">// å¼€å§‹æ»‘åŠ¨ç‚¹çš„Xåæ ‡</span></div><div class="line">  mStartX = startX;</div><div class="line">  <span class="comment">// å¼€å§‹æ»‘åŠ¨ç‚¹çš„Yåæ ‡</span></div><div class="line">  mStartY = startY;</div><div class="line">  <span class="comment">// æœ€ç»ˆæ»‘åŠ¨åˆ°ä½ç½®çš„Xåæ ‡</span></div><div class="line">  mFinalX = startX + dx;</div><div class="line">  <span class="comment">// æœ€ç»ˆæ»‘åŠ¨åˆ°ä½ç½®çš„Yåæ ‡</span></div><div class="line">  mFinalY = startY + dy;</div><div class="line">  <span class="comment">// Xæ–¹å‘ä¸Šæ»‘åŠ¨çš„åç§»é‡</span></div><div class="line">  mDeltaX = dx;</div><div class="line">  <span class="comment">// Yæ–¹å‘ä¸Šæ»‘åŠ¨çš„åç§»é‡</span></div><div class="line">  mDeltaY = dy;</div><div class="line">  <span class="comment">// æŒç»­æ—¶é—´çš„å€’æ•° æœ€ç»ˆç”¨æ¥è®¡ç®—å¾—åˆ°æ’å€¼å™¨è¿”å›çš„å€¼</span></div><div class="line">  mDurationReciprocal = <span class="number">1.0f</span> / (<span class="keyword">float</span>) mDuration;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¾ˆç®€å•åªæ˜¯ä¸€äº›å˜é‡çš„èµ‹å€¼ã€‚æ ¹æ®æˆ‘ä»¬å‰é¢ä½¿ç”¨æ–¹æ³•é‡Œçš„åˆ†æï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>computeScrollOffset()</code>æ–¹æ³•ï¼š</p>
<h3 id="3-computeScrollOffset-æ–¹æ³•ä¸­-SCROLL-MODE-çš„å®ç°"><a href="#3-computeScrollOffset-æ–¹æ³•ä¸­-SCROLL-MODE-çš„å®ç°" class="headerlink" title="3.computeScrollOffset() æ–¹æ³•ä¸­ SCROLL_MODE çš„å®ç°"></a>3.computeScrollOffset() æ–¹æ³•ä¸­ SCROLL_MODE çš„å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å½“ä½ éœ€è¦çŸ¥é“æ–°çš„ä½ç½®çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœåŠ¨ç”»è¿˜æœªç»“æŸåˆ™è¿”å›true</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">computeScrollOffset</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//å¦‚æœå·²ç»ç»“æŸ åˆ™ç›´æ¥è¿”å›false</span></div><div class="line">    <span class="keyword">if</span> (mFinished) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//å¾—åˆ°ä»¥åŠåº¦è¿‡çš„æ—¶é—´</span></div><div class="line">    <span class="keyword">int</span> timePassed = (<span class="keyword">int</span>)(AnimationUtils.currentAnimationTimeMillis() - mStartTime);</div><div class="line"></div><div class="line">    <span class="comment">//å¦‚æœè¿˜åœ¨åŠ¨ç”»æ—¶é—´å†…</span></div><div class="line">    <span class="keyword">if</span> (timePassed &lt; mDuration) &#123;</div><div class="line">        <span class="keyword">switch</span> (mMode) &#123;</div><div class="line">            <span class="keyword">case</span> SCROLL_MODE:</div><div class="line">                <span class="comment">// æ ¹æ®timePassed * mDurationReciprocal,ä»mInterpolatorä¸­å–å‡ºå½“å‰éœ€è¦åç§»é‡çš„æ¯”ä¾‹</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> x = mInterpolator.getInterpolation(timePassed * mDurationReciprocal);</div><div class="line">                <span class="comment">// èµ‹å€¼ç»™ mCurrXï¼ŒmCurrY</span></div><div class="line">                mCurrX = mStartX + Math.round(x * mDeltaX);</div><div class="line">                mCurrY = mStartY + Math.round(x * mDeltaY);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> FLING_MODE:</div><div class="line">                ...</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        mCurrX = mFinalX;</div><div class="line">        mCurrY = mFinalY;</div><div class="line">        mFinished = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆçš„åˆ°å½“å‰æ—¶é—´ä¸æ»‘åŠ¨å¼€å§‹æ—¶é—´çš„æ—¶é—´å·®ï¼Œå¦‚æœè¿˜åœ¨æ»‘åŠ¨æ—¶é—´å†…åˆ™é€šè¿‡æ’å€¼å™¨è·å¾—å½“å‰çš„è¿›åº¦å¹¶ä¹˜ä»¥æ€»åç§»é‡å¹¶èµ‹å€¼ç»™<code>mCurrX</code>ï¼Œ<code>mCurrY</code>ã€‚å¦‚æœå·²ç»ç»“æŸåˆ™ç›´æ¥å°†<code>mFinalX</code>å’Œ<code>mFinalY</code>èµ‹å€¼å¹¶å°†<code>mFinished</code>è®¾ç½®ä¸º<code>true</code>ã€‚æ‰€ä»¥è¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡<code>getCurrX()</code>å’Œ<code>getCurrY()</code>æ¥å¾—åˆ°å¯¹åº”çš„<code>mCurrX</code>å’Œ<code>mCurrY</code>æ¥åšç›¸åº”çš„å¤„ç†äº†ã€‚æ•´ä¸ª<code>Scroll</code>çš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·äº†ã€‚</p>
<h3 id="4-fling-æ–¹æ³•çš„å®ç°"><a href="#4-fling-æ–¹æ³•çš„å®ç°" class="headerlink" title="4.fling()æ–¹æ³•çš„å®ç°"></a>4.fling()æ–¹æ³•çš„å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fling</span><span class="params">(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> velocityX, <span class="keyword">int</span> velocityY,</span></span></div><div class="line">                  <span class="keyword">int</span> minX, <span class="keyword">int</span> maxX, <span class="keyword">int</span> minY, <span class="keyword">int</span> maxY) &#123;</div><div class="line">    <span class="comment">// å¦‚æœå‰ä¸€æ¬¡æ»‘åŠ¨è¿˜æœªç»“æŸï¼Œåˆè°ƒç”¨äº†æ–°çš„fling()æ–¹æ³•æ—¶ï¼Œ</span></div><div class="line">    <span class="comment">// åˆ™ç´¯åŠ ç›¸åŒæ–¹å‘ä¸ŠåŠ é€Ÿåº¦</span></div><div class="line">    <span class="keyword">if</span> (mFlywheel &amp;&amp; !mFinished) &#123;</div><div class="line">        <span class="keyword">float</span> oldVel = getCurrVelocity();</div><div class="line"></div><div class="line">        <span class="keyword">float</span> dx = (<span class="keyword">float</span>) (mFinalX - mStartX);</div><div class="line">        <span class="keyword">float</span> dy = (<span class="keyword">float</span>) (mFinalY - mStartY);</div><div class="line">        <span class="keyword">float</span> hyp = FloatMath.sqrt(dx * dx + dy * dy);</div><div class="line"></div><div class="line">        <span class="keyword">float</span> ndx = dx / hyp;</div><div class="line">        <span class="keyword">float</span> ndy = dy / hyp;</div><div class="line"></div><div class="line">        <span class="keyword">float</span> oldVelocityX = ndx * oldVel;</div><div class="line">        <span class="keyword">float</span> oldVelocityY = ndy * oldVel;</div><div class="line">        <span class="keyword">if</span> (Math.signum(velocityX) == Math.signum(oldVelocityX) &amp;&amp;</div><div class="line">                Math.signum(velocityY) == Math.signum(oldVelocityY)) &#123;</div><div class="line">            velocityX += oldVelocityX;</div><div class="line">            velocityY += oldVelocityY;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//è®¾ç½®ä¸ºFLING_MODE</span></div><div class="line">    mMode = FLING_MODE;</div><div class="line">    mFinished = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">//æ ¹æ®å‹¾è‚¡å®šç†è·å¾—æ€»åŠ é€Ÿåº¦</span></div><div class="line">    <span class="keyword">float</span> velocity = FloatMath.sqrt(velocityX * velocityX + velocityY * velocityY);</div><div class="line"></div><div class="line">    mVelocity = velocity;</div><div class="line">    <span class="comment">// é€šè¿‡åŠ é€Ÿåº¦å¾—åˆ°æ»‘åŠ¨æŒç»­æ—¶é—´</span></div><div class="line">    mDuration = getSplineFlingDuration(velocity);</div><div class="line">    mStartTime = AnimationUtils.currentAnimationTimeMillis();</div><div class="line">    mStartX = startX;</div><div class="line">    mStartY = startY;</div><div class="line"></div><div class="line">    <span class="keyword">float</span> coeffX = velocity == <span class="number">0</span> ? <span class="number">1.0f</span> : velocityX / velocity;</div><div class="line">    <span class="keyword">float</span> coeffY = velocity == <span class="number">0</span> ? <span class="number">1.0f</span> : velocityY / velocity;</div><div class="line"></div><div class="line">    <span class="keyword">double</span> totalDistance = getSplineFlingDistance(velocity);</div><div class="line">    mDistance = (<span class="keyword">int</span>) (totalDistance * Math.signum(velocity));</div><div class="line"></div><div class="line">    mMinX = minX;</div><div class="line">    mMaxX = maxX;</div><div class="line">    mMinY = minY;</div><div class="line">    mMaxY = maxY;</div><div class="line"></div><div class="line">    mFinalX = startX + (<span class="keyword">int</span>) Math.round(totalDistance * coeffX);</div><div class="line">    <span class="comment">// Pin to mMinX &lt;= mFinalX &lt;= mMaxX</span></div><div class="line">    mFinalX = Math.min(mFinalX, mMaxX);</div><div class="line">    mFinalX = Math.max(mFinalX, mMinX);</div><div class="line"></div><div class="line">    mFinalY = startY + (<span class="keyword">int</span>) Math.round(totalDistance * coeffY);</div><div class="line">    <span class="comment">// Pin to mMinY &lt;= mFinalY &lt;= mMaxY</span></div><div class="line">    mFinalY = Math.min(mFinalY, mMaxY);</div><div class="line">    mFinalY = Math.max(mFinalY, mMinY);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¾ç„¶æ˜¯ä¸ºè®¡ç®—éœ€è¦çš„å„ç§å˜é‡èµ‹å€¼ã€‚å› ä¸ºå¼•å…¥äº†åŠ é€Ÿåº¦çš„æ¦‚å¿µæ‰€ä»¥å˜å¾—ç›¸å¯¹å¤æ‚ï¼Œé¦–å…ˆå…ˆåˆ¤æ–­äº†å¦‚æœä¸€æ¬¡æ»‘åŠ¨æœªç»“æŸåˆè§¦å‘å¦ä¸€æ¬¡æ»‘åŠ¨æ—¶ï¼Œæ˜¯å¦éœ€è¦ç´¯åŠ åŠ é€Ÿåº¦ã€‚ç„¶åæ˜¯è®¾ç½®<code>mMode</code>ä¸º<code>FLING_MODE</code>ã€‚ç„¶åæ ¹æ®<code>velocityX</code>å’Œ<code>velocityY</code>ç®—å‡ºæ€»çš„åŠ é€Ÿåº¦<code>velocity</code>ï¼Œç´§æ¥ç€ç®—å‡ºè¿™ä¸ªåŠ é€Ÿåº¦ä¸‹å¯ä»¥æ»‘åŠ¨çš„è·ç¦»<code>mDistance</code>ã€‚æœ€åå†é€šè¿‡<code>x</code>æˆ–<code>y</code>æ–¹å‘ä¸Šçš„åŠ é€Ÿåº¦æ¯”å€¼ä»¥åŠæˆ‘ä»¬è®¾å®šçš„æœ€å¤§å€¼å’Œæœ€å°å€¼æ¥ç»™<code>mFinalX</code>æˆ–<code>mFinalY</code>èµ‹å€¼ã€‚èµ‹å€¼ç»“æŸåï¼Œé€šè¿‡è°ƒç”¨<code>invalidate()</code>ï¼Œæœ€ç»ˆä¾ç„¶ä¼šè°ƒç”¨<code>computeScrollOffset()</code>æ–¹æ³•ï¼š</p>
<h3 id="5-computeScrollOffset-æ–¹æ³•ä¸­-FLING-MODE-çš„å®ç°"><a href="#5-computeScrollOffset-æ–¹æ³•ä¸­-FLING-MODE-çš„å®ç°" class="headerlink" title="5.computeScrollOffset() æ–¹æ³•ä¸­ FLING_MODE çš„å®ç°"></a>5.computeScrollOffset() æ–¹æ³•ä¸­ FLING_MODE çš„å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">computeScrollOffset</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mFinished) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> timePassed = (<span class="keyword">int</span>)(AnimationUtils.currentAnimationTimeMillis() - mStartTime);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (timePassed &lt; mDuration) &#123;</div><div class="line">        <span class="keyword">switch</span> (mMode) &#123;</div><div class="line">            <span class="keyword">case</span> SCROLL_MODE:</div><div class="line">                ...</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> FLING_MODE:</div><div class="line">                <span class="comment">// å½“å‰å·²æ»‘åŠ¨çš„æ—¶é—´ä¸æ€»æ»‘åŠ¨æ—¶é—´çš„æ¯”å€¼</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> t = (<span class="keyword">float</span>) timePassed / mDuration;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = (<span class="keyword">int</span>) (NB_SAMPLES * t);</div><div class="line">                <span class="comment">// è·ç¦»ç³»æ•°</span></div><div class="line">                <span class="keyword">float</span> distanceCoef = <span class="number">1</span>.f;</div><div class="line">                <span class="comment">// åŠ é€Ÿåº¦ç³»æ•°</span></div><div class="line">                <span class="keyword">float</span> velocityCoef = <span class="number">0</span>.f;</div><div class="line">                <span class="keyword">if</span> (index &lt; NB_SAMPLES) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> t_inf = (<span class="keyword">float</span>) index / NB_SAMPLES;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> t_sup = (<span class="keyword">float</span>) (index + <span class="number">1</span>) / NB_SAMPLES;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> d_inf = SPLINE_POSITION[index];</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> d_sup = SPLINE_POSITION[index + <span class="number">1</span>];</div><div class="line">                    velocityCoef = (d_sup - d_inf) / (t_sup - t_inf);</div><div class="line">                    distanceCoef = d_inf + (t - t_inf) * velocityCoef;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// è®¡ç®—å‡ºå½“å‰çš„åŠ é€Ÿåº¦</span></div><div class="line">                mCurrVelocity = velocityCoef * mDistance / mDuration * <span class="number">1000.0f</span>;</div><div class="line">                <span class="comment">// è®¡ç®—å‡ºå½“å‰çš„mCurrX ä¸mCurrY</span></div><div class="line">                mCurrX = mStartX + Math.round(distanceCoef * (mFinalX - mStartX));</div><div class="line">                <span class="comment">// Pin to mMinX &lt;= mCurrX &lt;= mMaxX</span></div><div class="line">                mCurrX = Math.min(mCurrX, mMaxX);</div><div class="line">                mCurrX = Math.max(mCurrX, mMinX);</div><div class="line"></div><div class="line">                mCurrY = mStartY + Math.round(distanceCoef * (mFinalY - mStartY));</div><div class="line">                <span class="comment">// Pin to mMinY &lt;= mCurrY &lt;= mMaxY</span></div><div class="line">                mCurrY = Math.min(mCurrY, mMaxY);</div><div class="line">                mCurrY = Math.max(mCurrY, mMinY);</div><div class="line"></div><div class="line">                <span class="comment">// å¦‚æœåˆ°è¾¾äº†ç»ˆç‚¹ åˆ™ç»“æŸ</span></div><div class="line">                <span class="keyword">if</span> (mCurrX == mFinalX &amp;&amp; mCurrY == mFinalY) &#123;</div><div class="line">                    mFinished = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        mCurrX = mFinalX;</div><div class="line">        mCurrY = mFinalY;</div><div class="line">        mFinished = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±äº<code>fling()</code>æ–¹æ³•ä¸­å°†<code>mMode</code>èµ‹å€¼ä¸º<code>FLING_MODE</code>ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ¥çœ‹<code>FLING_MODE</code>ä¸­çš„ä»£ç ã€‚å¯ä»¥çœ‹å‡ºæ ¹æ®å½“å‰æ»‘åŠ¨æ—¶é—´ä¸æ€»æ»‘åŠ¨æ—¶é—´çš„æ¯”ä¾‹ã€‚å†æ ¹æ®ä¸€ä¸ª<code>SPLINE_POSITION</code>æ•°ç»„è®¡ç®—å‡ºäº†è·ç¦»ç³»æ•°<code>distanceCoef</code>ä¸åŠ é€Ÿåº¦ç³»æ•°<code>velocityCoef</code>ã€‚å†æ ¹æ®è¿™ä¸¤ä¸ªç³»æ•°è®¡ç®—å‡ºå½“å‰åŠ é€Ÿåº¦ä¸å½“å‰çš„<code>mCurrX</code>ä¸<code>mCurrY</code>ã€‚å…³äº<code>SPLINE_POSITION</code>çš„åˆå§‹åŒ–æ˜¯åœ¨ä¸‹é¢çš„é™æ€ä»£ç å—é‡Œèµ‹å€¼çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">float</span> x_min = <span class="number">0.0f</span>;</div><div class="line">    <span class="keyword">float</span> y_min = <span class="number">0.0f</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NB_SAMPLES; i++) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> alpha = (<span class="keyword">float</span>) i / NB_SAMPLES;</div><div class="line"></div><div class="line">        <span class="keyword">float</span> x_max = <span class="number">1.0f</span>;</div><div class="line">        <span class="keyword">float</span> x, tx, coef;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            x = x_min + (x_max - x_min) / <span class="number">2.0f</span>;</div><div class="line">            coef = <span class="number">3.0f</span> * x * (<span class="number">1.0f</span> - x);</div><div class="line">            tx = coef * ((<span class="number">1.0f</span> - x) * P1 + x * P2) + x * x * x;</div><div class="line">            <span class="keyword">if</span> (Math.abs(tx - alpha) &lt; <span class="number">1E-5</span>) <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">if</span> (tx &gt; alpha) x_max = x;</div><div class="line">            <span class="keyword">else</span> x_min = x;</div><div class="line">        &#125;</div><div class="line">        SPLINE_POSITION[i] = coef * ((<span class="number">1.0f</span> - x) * START_TENSION + x) + x * x * x;</div><div class="line"></div><div class="line">        <span class="keyword">float</span> y_max = <span class="number">1.0f</span>;</div><div class="line">        <span class="keyword">float</span> y, dy;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            y = y_min + (y_max - y_min) / <span class="number">2.0f</span>;</div><div class="line">            coef = <span class="number">3.0f</span> * y * (<span class="number">1.0f</span> - y);</div><div class="line">            dy = coef * ((<span class="number">1.0f</span> - y) * START_TENSION + y) + y * y * y;</div><div class="line">            <span class="keyword">if</span> (Math.abs(dy - alpha) &lt; <span class="number">1E-5</span>) <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">if</span> (dy &gt; alpha) y_max = y;</div><div class="line">            <span class="keyword">else</span> y_min = y;</div><div class="line">        &#125;</div><div class="line">        SPLINE_TIME[i] = coef * ((<span class="number">1.0f</span> - y) * P1 + y * P2) + y * y * y;</div><div class="line">    &#125;</div><div class="line">    SPLINE_POSITION[NB_SAMPLES] = SPLINE_TIME[NB_SAMPLES] = <span class="number">1.0f</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘å¹¶æ²¡æœ‰çœ‹æ‡‚è¿™æ®µä»£ç çš„å®é™…æ„ä¹‰ã€‚ç½‘ä¸Šä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒæ¸…æ™°çš„è§£é‡Šã€‚é€šè¿‡<code>debug</code>å¾—çŸ¥<code>SPLINE_POSITION</code>æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º<code>101</code>å¹¶ä¸”ä»<code>0-1</code>é€’å¢æ•°ç»„ã€‚çŒœæƒ³è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°æ¨¡å‹å¹¶ä¸”æœ€ç»ˆç”¨äºè®¡ç®—å‡ºæ»‘åŠ¨è¿‡ç¨‹ä¸­çš„åŠ é€Ÿåº¦ä¸ä½ç½®ã€‚è‡³æ­¤<code>Scroller</code>çš„ä¸¤ä¸ªä¸»è¦æ–¹æ³•çš„å®ç°æˆ‘ä»¬å°±åˆ†æå®Œäº†ã€‚</p>
<h2 id="4-OverScrollerè§£æ"><a href="#4-OverScrollerè§£æ" class="headerlink" title="4. OverScrollerè§£æ"></a>4. OverScrollerè§£æ</h2><p><code>OverScroller</code>æ˜¯å¯¹<code>Scroller</code>çš„æ‹“å±•ï¼Œå®ƒåœ¨<code>Scroller</code>çš„åŸºç¡€ä¸Šæ‹“å±•å‡ºäº†æ›´å¤šçš„æ–¹æ³•ã€‚<code>OverScroller</code>çš„<code>fling</code>æ–¹æ³•æ”¯æŒæ»‘åŠ¨åˆ°ç»ˆç‚¹ä¹‹åå¹¶è¶…å‡ºä¸€æ®µè·ç¦»å¹¶è¿”å›ï¼Œç±»ä¼¼äºå¼¹æ€§æ•ˆæœã€‚å¦å¤–ä¸€ä¸ª<code>springBack()</code>æ–¹æ³•æ˜¯æŒ‡å°†æŒ‡å®šçš„ç‚¹å¹³æ»‘æ»šåŠ¨åˆ°æŒ‡å®šçš„ç»ˆç‚¹ä¸Šã€‚è¿™ä¸ªç»ˆç‚¹ç”±è®¾ç½®çš„å‚æ•°å†³å®šã€‚åŸç†æˆ‘ä»¬å°±ä¸å†æ¢ç©¶äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œç ”ç©¶è¿™ä¸¤ä¸ªç±»çš„å·®åˆ«ã€‚æœ€åå…·ä½“çš„ä½¿ç”¨æ–¹æ³•åœ¨æ–‡ç« æœ€ä¸Šé¢çš„<code>demo</code>é‡Œéƒ½æœ‰æä¾›ã€‚å¯ä»¥<code>clone</code>ä¸‹æ¥å¸®åŠ©ç†è§£ã€‚</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>LruCacheæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/LruCache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/LruCacheæºç è§£æ/</id>
    <published>2017-07-26T11:57:39.000Z</published>
    <updated>2017-07-26T11:58:00.664Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><blockquote>
<p>LRU æ˜¯ Least Recently Used æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ã€‚</p>
<p>æ›¾ç»ï¼Œåœ¨å„å¤§ç¼“å­˜å›¾ç‰‡çš„æ¡†æ¶æ²¡æµè¡Œçš„æ—¶å€™ã€‚æœ‰ä¸€ç§å¾ˆå¸¸ç”¨çš„å†…å­˜ç¼“å­˜æŠ€æœ¯ï¼šSoftReference å’Œ WeakReferenceï¼ˆè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ï¼‰ã€‚ä½†æ˜¯èµ°åˆ°äº† Android 2.3ï¼ˆLevel 9ï¼‰æ—¶ä»£ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶æ›´å€¾å‘äºå›æ”¶ SoftReference æˆ– WeakReference çš„å¯¹è±¡ã€‚åæ¥ï¼Œåˆæ¥åˆ°äº† Android3.0ï¼Œå›¾ç‰‡ç¼“å­˜åœ¨å†…å®¹ä¸­ï¼Œå› ä¸ºä¸çŸ¥é“è¦åœ¨æ˜¯ä»€ä¹ˆæ—¶å€™é‡Šæ”¾å†…å­˜ï¼Œæ²¡æœ‰ç­–ç•¥ï¼Œæ²¡ç”¨ä¸€ç§å¯ä»¥é¢„è§çš„åœºåˆå»å°†å…¶é‡Šæ”¾ã€‚è¿™å°±é€ æˆäº†å†…å­˜æº¢å‡ºã€‚</p>
</blockquote>
<h2 id="2-ä½¿ç”¨æ–¹æ³•"><a href="#2-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="2. ä½¿ç”¨æ–¹æ³•"></a>2. ä½¿ç”¨æ–¹æ³•</h2><p><strong>å½“æˆä¸€ä¸ª Map ç”¨å°±å¯ä»¥äº†ï¼Œåªä¸è¿‡å®ç°äº† LRU ç¼“å­˜ç­–ç•¥</strong>ã€‚</p>
<p>ä½¿ç”¨çš„æ—¶å€™è®°ä½å‡ ç‚¹å³å¯ï¼š</p>
<ul>
<li><strong>1.ï¼ˆå¿…å¡«ï¼‰</strong>ä½ éœ€è¦æä¾›ä¸€ä¸ªç¼“å­˜å®¹é‡ä½œä¸ºæ„é€ å‚æ•°ã€‚</li>
<li><strong>2.ï¼ˆå¿…å¡«ï¼‰</strong>  è¦†å†™  <code>sizeOf</code> æ–¹æ³• ï¼Œè‡ªå®šä¹‰è®¾è®¡ä¸€æ¡æ•°æ®æ”¾è¿›æ¥çš„å®¹é‡è®¡ç®—ï¼Œå¦‚æœä¸è¦†å†™å°±æ— æ³•é¢„çŸ¥æ•°æ®çš„å®¹é‡ï¼Œä¸èƒ½ä¿è¯ç¼“å­˜å®¹é‡é™å®šåœ¨æœ€å¤§å®¹é‡ä»¥å†…ã€‚</li>
<li><strong>3.ï¼ˆé€‰å¡«ï¼‰</strong> è¦†å†™ <code>entryRemoved</code> æ–¹æ³• ï¼Œä½ å¯ä»¥çŸ¥é“æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜è¢«æ¸…é™¤æ—¶çš„æ•°æ®ï¼ˆ evicted, key, oldValue, newVaule ï¼‰ã€‚</li>
<li><strong>4.ï¼ˆè®°ä½ï¼‰</strong>LruCacheæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨å†…éƒ¨çš„ getã€putã€remove åŒ…æ‹¬ trimToSize éƒ½æ˜¯å®‰å…¨çš„ï¼ˆå› ä¸ºéƒ½ä¸Šé”äº†ï¼‰ã€‚</li>
<li><strong>5.ï¼ˆé€‰å¡«ï¼‰</strong> è¿˜æœ‰å°±æ˜¯è¦†å†™ <code>create</code> æ–¹æ³• ã€‚</li>
</ul>
<p>ä¸€èˆ¬åšåˆ° <strong>1ã€2ã€3ã€4å°±è¶³å¤Ÿäº†ï¼Œ5å¯ä»¥æ— è§†</strong> ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ ä¸€ä¸ª <strong>LruCache å®ç° Bitmap å°ç¼“å­˜çš„æ¡ˆä¾‹</strong>, <code>entryRemoved</code> é‡Œçš„è‡ªå®šä¹‰é€»è¾‘å¯ä»¥æ— è§†ï¼Œæƒ³çœ‹çš„å¯ä»¥å»åˆ°æˆ‘çš„æˆ‘çš„å±•ç¤º <a href="https://github.com/CaMnter/AndroidLife/blob/master/app/src/main/java/com/camnter/newlife/views/activity/lrucache/LruCacheActivity.java" target="_blank" rel="external">demo</a> é‡Œçš„çœ‹è‡ªå®šä¹‰ <code>entryRemoved</code> é€»è¾‘ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> ONE_MIB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"><span class="comment">// 7MB</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHE_SIZE = (<span class="keyword">int</span>) (<span class="number">7</span> * ONE_MIB);</div><div class="line"><span class="keyword">private</span> LruCache&lt;String, Bitmap&gt; bitmapCache;</div><div class="line"><span class="keyword">this</span>.bitmapCache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(CACHE_SIZE) &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, Bitmap value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value.getByteCount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">entryRemoved</span><span class="params">(<span class="keyword">boolean</span> evicted, String key, Bitmap oldValue, Bitmap newValue)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="3-æ•ˆæœå±•ç¤º"><a href="#3-æ•ˆæœå±•ç¤º" class="headerlink" title="3. æ•ˆæœå±•ç¤º"></a>3. æ•ˆæœå±•ç¤º</h2><p><a href="https://github.com/CaMnter/AndroidLife/blob/master/article/LruCache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90_%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA.md" target="_blank" rel="external">LruCache æ•ˆæœå±•ç¤º</a>  </p>
<h2 id="4-æºç åˆ†æ"><a href="#4-æºç åˆ†æ" class="headerlink" title="4. æºç åˆ†æ"></a>4. æºç åˆ†æ</h2><h3 id="4-1-LruCache-åŸç†æ¦‚è¦è§£æ"><a href="#4-1-LruCache-åŸç†æ¦‚è¦è§£æ" class="headerlink" title="4.1 LruCache åŸç†æ¦‚è¦è§£æ"></a>4.1 LruCache åŸç†æ¦‚è¦è§£æ</h3><p>LruCache å°±æ˜¯ <strong>åˆ©ç”¨ LinkedHashMap çš„ä¸€ä¸ªç‰¹æ€§ï¼ˆ accessOrderï¼true åŸºäºè®¿é—®é¡ºåº ï¼‰å†åŠ ä¸Šå¯¹ LinkedHashMap çš„æ•°æ®æ“ä½œä¸Šé”å®ç°çš„ç¼“å­˜ç­–ç•¥</strong>ã€‚</p>
<p><strong>LruCache çš„æ•°æ®ç¼“å­˜æ˜¯å†…å­˜ä¸­çš„</strong>ã€‚  </p>
<ul>
<li><p>1.é¦–å…ˆè®¾ç½®äº†å†…éƒ¨ <code>LinkedHashMap</code> æ„é€ å‚æ•° <code>accessOrder=true</code>ï¼Œ å®ç°äº†æ•°æ®æ’åºæŒ‰ç…§è®¿é—®é¡ºåºã€‚</p>
</li>
<li><p>2.ç„¶ååœ¨æ¯æ¬¡ <code>LruCache.get(K key)</code> æ–¹æ³•é‡Œéƒ½ä¼šè°ƒç”¨ <code>LinkedHashMap.get(Object key)</code>ã€‚</p>
</li>
<li><p>3.å¦‚ä¸Šè¿°è®¾ç½®äº† <code>accessOrder=true</code> åï¼Œæ¯æ¬¡ <code>LinkedHashMap.get(Object key)</code> éƒ½ä¼šè¿›è¡Œ <code>LinkedHashMap.makeTail(LinkedEntry&amp;lt;K, V&gt; e)</code>ã€‚</p>
</li>
<li><p>4.<code>LinkedHashMap</code> æ˜¯åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç„¶åæ¯æ¬¡ <code>LruCache.get</code> -&gt; <code>LinkedHashMap.get</code> çš„æ•°æ®å°±è¢«æ”¾åˆ°æœ€æœ«å°¾äº†ã€‚</p>
</li>
<li><p>5.åœ¨ <code>put</code> å’Œ <code>trimToSize</code> çš„æ–¹æ³•æ‰§è¡Œä¸‹ï¼Œå¦‚æœå‘ç”Ÿæ•°æ®é‡ç§»é™¤ï¼Œä¼šä¼˜å…ˆç§»é™¤æ‰æœ€å‰é¢çš„æ•°æ®ï¼ˆå› ä¸ºæœ€æ–°è®¿é—®çš„æ•°æ®åœ¨å°¾éƒ¨ï¼‰ã€‚</p>
</li>
</ul>
<p><strong>å…·ä½“è§£æåœ¨ï¼š</strong> 4.2ã€4.3ã€4.4ã€4.5</p>
<h3 id="4-2-LruCache-çš„å”¯ä¸€æ„é€ æ–¹æ³•"><a href="#4-2-LruCache-çš„å”¯ä¸€æ„é€ æ–¹æ³•" class="headerlink" title="4.2 LruCache çš„å”¯ä¸€æ„é€ æ–¹æ³•"></a>4.2 LruCache çš„å”¯ä¸€æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * LruCacheçš„æ„é€ æ–¹æ³•ï¼šéœ€è¦ä¼ å…¥æœ€å¤§ç¼“å­˜ä¸ªæ•°</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.maxSize = maxSize;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * åˆå§‹åŒ–LinkedHashMap</div><div class="line">     * ç¬¬ä¸€ä¸ªå‚æ•°ï¼šinitialCapacityï¼Œåˆå§‹å¤§å°</div><div class="line">     * ç¬¬äºŒä¸ªå‚æ•°ï¼šloadFactorï¼Œè´Ÿè½½å› å­=0.75f</div><div class="line">     * ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šaccessOrder=trueï¼ŒåŸºäºè®¿é—®é¡ºåºï¼›accessOrder=falseï¼ŒåŸºäºæ’å…¥é¡ºåº</div><div class="line">     */</div><div class="line">    <span class="keyword">this</span>.map = <span class="keyword">new</span> LinkedHashMap&lt;K, V&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå‚æ•° <code>initialCapacity</code> ç”¨äºåˆå§‹åŒ–è¯¥ LinkedHashMap çš„å¤§å°ã€‚</p>
<p>å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ ç¬¬äºŒä¸ªå‚æ•° <code>loadFactor</code>ï¼Œè¿™ä¸ªå…¶å®çš„ HashMap é‡Œçš„æ„é€ å‚æ•°ï¼Œæ¶‰åŠåˆ°<strong>æ‰©å®¹é—®é¢˜</strong>ï¼Œæ¯”å¦‚  HashMap çš„æœ€å¤§å®¹é‡æ˜¯100ï¼Œé‚£ä¹ˆè¿™é‡Œè®¾ç½®0.75fçš„è¯ï¼Œåˆ°75å®¹é‡çš„æ—¶å€™å°±ä¼šæ‰©å®¹ã€‚</p>
<p>ä¸»è¦æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•° <code>accessOrder=true</code> ï¼Œ<strong>è¿™æ ·çš„è¯ LinkedHashMap æ•°æ®æ’åºå°±ä¼šåŸºäºæ•°æ®çš„è®¿é—®é¡ºåºï¼Œä»è€Œå®ç°äº† LruCache æ ¸å¿ƒå·¥ä½œåŸç†</strong>ã€‚</p>
<h3 id="4-3-LruCache-get-K-key"><a href="#4-3-LruCache-get-K-key" class="headerlink" title="4.3 LruCache.get(K key)"></a>4.3 LruCache.get(K key)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ ¹æ® key æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå­˜åœ¨äºç¼“å­˜æˆ–è€…è¢« create æ–¹æ³•åˆ›å»ºäº†ã€‚</div><div class="line"> * å¦‚æœå€¼è¿”å›äº†ï¼Œé‚£ä¹ˆå®ƒå°†è¢«ç§»åŠ¨åˆ°åŒå‘å¾ªç¯é“¾è¡¨çš„çš„å°¾éƒ¨ã€‚</div><div class="line"> * å¦‚æœæ²¡æœ‰ç¼“å­˜çš„å€¼ï¼Œåˆ™è¿”å› nullã€‚</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</div><div class="line"></div><div class="line">    ...  </div><div class="line"></div><div class="line">    V mapValue;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// å…³é”®ç‚¹ï¼šLinkedHashMapæ¯æ¬¡getéƒ½ä¼šåŸºäºè®¿é—®é¡ºåºæ¥é‡æ•´æ•°æ®é¡ºåº</span></div><div class="line">        mapValue = map.get(key);</div><div class="line">        <span class="comment">// è®¡ç®— å‘½ä¸­æ¬¡æ•°</span></div><div class="line">        <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">            hitCount++;</div><div class="line">            <span class="keyword">return</span> mapValue;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¡ç®— ä¸¢å¤±æ¬¡æ•°</span></div><div class="line">        missCount++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * å®˜æ–¹è§£é‡Šï¼š</div><div class="line">     * å°è¯•åˆ›å»ºä¸€ä¸ªå€¼ï¼Œè¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸”Mapå¯èƒ½åœ¨create()è¿”å›çš„å€¼æ—¶æœ‰æ‰€ä¸åŒã€‚å¦‚æœåœ¨create()æ‰§è¡Œçš„æ—¶</div><div class="line">     * å€™ï¼Œä¸€ä¸ªå†²çªçš„å€¼è¢«æ·»åŠ åˆ°Mapï¼Œæˆ‘ä»¬åœ¨Mapä¸­åˆ é™¤è¿™ä¸ªå€¼ï¼Œé‡Šæ”¾è¢«åˆ›é€ çš„å€¼ã€‚</div><div class="line">     */</div><div class="line">    V createdValue = create(key);</div><div class="line">    <span class="keyword">if</span> (createdValue == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/***************************</span></div><div class="line">     * ä¸è¦†å†™createæ–¹æ³•èµ°ä¸åˆ°ä¸‹é¢ *</div><div class="line">     ***************************/</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * æ­£å¸¸æƒ…å†µèµ°ä¸åˆ°è¿™é‡Œ</div><div class="line">     * èµ°åˆ°è¿™é‡Œçš„è¯ è¯´æ˜ å®ç°äº†è‡ªå®šä¹‰çš„ create(K key) é€»è¾‘</div><div class="line">     * å› ä¸ºé»˜è®¤çš„ create(K key) é€»è¾‘ä¸ºnull</div><div class="line">     */</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// è®°å½• create çš„æ¬¡æ•°</span></div><div class="line">        createCount++;</div><div class="line">        <span class="comment">// å°†è‡ªå®šä¹‰createåˆ›å»ºçš„å€¼ï¼Œæ”¾å…¥LinkedHashMapä¸­ï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œä¼šè¿”å› ä¹‹å‰ç›¸åŒkey çš„å€¼</span></div><div class="line">        mapValue = map.put(key, createdValue);</div><div class="line"></div><div class="line">        <span class="comment">// å¦‚æœä¹‹å‰å­˜åœ¨ç›¸åŒkeyçš„valueï¼Œå³æœ‰å†²çªã€‚</span></div><div class="line">        <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * æœ‰å†²çª</div><div class="line">             * æ‰€ä»¥ æ’¤é”€ åˆšæ‰çš„ æ“ä½œ</div><div class="line">             * å°† ä¹‹å‰ç›¸åŒkey çš„å€¼ é‡æ–°æ”¾å›å»</div><div class="line">             */</div><div class="line">            map.put(key, mapValue);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// æ‹¿åˆ°é”®å€¼å¯¹ï¼Œè®¡ç®—å‡ºåœ¨å®¹é‡ä¸­çš„ç›¸å¯¹é•¿åº¦ï¼Œç„¶ååŠ ä¸Š</span></div><div class="line">            size += safeSizeOf(key, createdValue);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å¦‚æœä¸Šé¢ åˆ¤æ–­å‡ºäº† å°†è¦æ”¾å…¥çš„å€¼å‘ç”Ÿå†²çª</span></div><div class="line">    <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * åˆšæ‰createçš„å€¼è¢«åˆ é™¤äº†ï¼ŒåŸæ¥çš„ ä¹‹å‰ç›¸åŒkey çš„å€¼è¢«é‡æ–°æ·»åŠ å›å»äº†</div><div class="line">         * å‘Šè¯‰ è‡ªå®šä¹‰ çš„ entryRemoved æ–¹æ³•</div><div class="line">         */</div><div class="line">        entryRemoved(<span class="keyword">false</span>, key, createdValue, mapValue);</div><div class="line">        <span class="keyword">return</span> mapValue;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// ä¸Šé¢ è¿›è¡Œäº† size += æ“ä½œ æ‰€ä»¥è¿™é‡Œè¦é‡æ•´é•¿åº¦</span></div><div class="line">        trimToSize(maxSize);</div><div class="line">        <span class="keyword">return</span> createdValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°çš„ <code>get</code> æ–¹æ³•è¡¨é¢å¹¶æ²¡æœ‰çœ‹å‡ºå“ªé‡Œæœ‰å®ç°äº† LRU çš„ç¼“å­˜ç­–ç•¥ã€‚ä¸»è¦åœ¨ <code>mapValue = map.get(key)</code>;é‡Œï¼Œ<strong>è°ƒç”¨äº† LinkedHashMap çš„ get æ–¹æ³•ï¼Œå†åŠ ä¸Š LruCache æ„é€ é‡Œé»˜è®¤è®¾ç½® LinkedHashMap çš„ accessOrder=true</strong>ã€‚</p>
<h3 id="4-4-LinkedHashMap-get-Object-key"><a href="#4-4-LinkedHashMap-get-Object-key" class="headerlink" title="4.4 LinkedHashMap.get(Object key)"></a>4.4 LinkedHashMap.get(Object key)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the value of the mapping with the specified key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key</div><div class="line"> *            the key.</div><div class="line"> * <span class="doctag">@return</span> the value of the mapping with the specified key, or &#123;<span class="doctag">@code</span> null&#125;</div><div class="line"> *         if no mapping for the specified key is found.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * This method is overridden to eliminate the need for a polymorphic</div><div class="line">     * invocation in superclass at the expense of code duplication.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">        HashMapEntry&lt;K, V&gt; e = entryForNullKey;</div><div class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (accessOrder)</div><div class="line">            makeTail((LinkedEntry&lt;K, V&gt;) e);</div><div class="line">        <span class="keyword">return</span> e.value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> hash = Collections.secondaryHash(key);</div><div class="line">    HashMapEntry&lt;K, V&gt;[] tab = table;</div><div class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K, V&gt; e = tab[hash &amp; (tab.length - <span class="number">1</span>)];</div><div class="line">         e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        K eKey = e.key;</div><div class="line">        <span class="keyword">if</span> (eKey == key || (e.hash == hash &amp;&amp; key.equals(eKey))) &#123;</div><div class="line">            <span class="keyword">if</span> (accessOrder)</div><div class="line">                makeTail((LinkedEntry&lt;K, V&gt;) e);</div><div class="line">            <span class="keyword">return</span> e.value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®ä»”ç»†çœ‹ <code>if (accessOrder)</code> çš„é€»è¾‘å³å¯ï¼Œå¦‚æœ  <code>accessOrder=true</code> é‚£ä¹ˆæ¯æ¬¡ <code>get</code> éƒ½ä¼šæ‰§è¡Œ N æ¬¡  <code>makeTail(LinkedEntry&amp;lt;K, V&gt; e)</code> ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹ï¼š</p>
<h3 id="4-5-LinkedHashMap-makeTail-LinkedEntry-lt-K-V-gt-e"><a href="#4-5-LinkedHashMap-makeTail-LinkedEntry-lt-K-V-gt-e" class="headerlink" title="4.5 LinkedHashMap.makeTail(LinkedEntry&lt;K, V&gt; e)"></a>4.5 LinkedHashMap.makeTail(LinkedEntry&lt;K, V&gt; e)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Relinks the given entry to the tail of the list. Under access ordering,</div><div class="line"> * this method is invoked whenever the value of a  pre-existing entry is</div><div class="line"> * read by Map.get or modified by Map.put.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">makeTail</span><span class="params">(LinkedEntry&lt;K, V&gt; e)</span> </span>&#123;</div><div class="line">    <span class="comment">// Unlink e</span></div><div class="line">    e.prv.nxt = e.nxt;</div><div class="line">    e.nxt.prv = e.prv;</div><div class="line"></div><div class="line">    <span class="comment">// Relink e as tail</span></div><div class="line">    LinkedEntry&lt;K, V&gt; header = <span class="keyword">this</span>.header;</div><div class="line">    LinkedEntry&lt;K, V&gt; oldTail = header.prv;</div><div class="line">    e.nxt = header;</div><div class="line">    e.prv = oldTail;</div><div class="line">    oldTail.nxt = header.prv = e;</div><div class="line">    modCount++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>// Unlink e</p>
<p><img src="http://ww2.sinaimg.cn/large/006lPEc9jw1f36m59c4tgj31kw2c7tgn.jpg" width="500x">  </p>
<p>// Relink e as tail</p>
<p><img src="http://ww3.sinaimg.cn/large/006lPEc9jw1f36m68rkisj31kw1eswnd.jpg" width="500x">  </p>
<p><img src="images/lrucache.png" alt=""></p>
<p>LinkedHashMap æ˜¯åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç„¶åæ­¤æ¬¡ <strong>LruCache.get -&gt; LinkedHashMap.get</strong> çš„æ•°æ®å°±è¢«æ”¾åˆ°æœ€æœ«å°¾äº†ã€‚</p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ LruCache æ ¸å¿ƒå·¥ä½œåŸç†</strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ä»‹ç» <strong>LruCache çš„å®¹é‡æº¢å‡ºç­–ç•¥</strong>ã€‚</p>
<h3 id="4-6-LruCache-put-K-key-V-value"><a href="#4-6-LruCache-put-K-key-V-value" class="headerlink" title="4.6 LruCache.put(K key, V value)"></a>4.6 LruCache.put(K key, V value)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// æ‹¿åˆ°é”®å€¼å¯¹ï¼Œè®¡ç®—å‡ºåœ¨å®¹é‡ä¸­çš„ç›¸å¯¹é•¿åº¦ï¼Œç„¶ååŠ ä¸Š</span></div><div class="line">        size += safeSizeOf(key, value);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">	...</div><div class="line">    trimToSize(maxSize);</div><div class="line">    <span class="keyword">return</span> previous;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®°ä½å‡ ç‚¹ï¼š</p>
<ul>
<li><strong>1.</strong>put å¼€å§‹çš„æ—¶å€™ç¡®å®æ˜¯æŠŠå€¼æ”¾å…¥ LinkedHashMap äº†ï¼Œ<strong>ä¸ç®¡è¶…ä¸è¶…è¿‡ä½ è®¾å®šçš„ç¼“å­˜å®¹é‡</strong>ã€‚</li>
<li><strong>2.</strong>ç„¶åæ ¹æ® <code>safeSizeOf</code> æ–¹æ³•è®¡ç®— æ­¤æ¬¡æ·»åŠ æ•°æ®çš„å®¹é‡æ˜¯å¤šå°‘ï¼Œå¹¶ä¸”åŠ åˆ° <code>size</code> é‡Œ ã€‚</li>
<li><strong>3.</strong>è¯´åˆ° <code>safeSizeOf</code> å°±è¦è®²åˆ° <code>sizeOf(K key, V value)</code> ä¼šè®¡ç®—å‡ºæ­¤æ¬¡æ·»åŠ æ•°æ®çš„å¤§å° ã€‚</li>
<li><strong>4.</strong>ç›´åˆ° put è¦ç»“æŸæ—¶ï¼Œè¿›è¡Œäº† <code>trimToSize</code> æ‰åˆ¤æ–­ <code>size</code> æ˜¯å¦ å¤§äº <code>maxSize</code> ç„¶åè¿›è¡Œæœ€è¿‘å¾ˆå°‘è®¿é—®æ•°æ®çš„ç§»é™¤ã€‚</li>
</ul>
<h3 id="4-7-LruCache-trimToSize-int-maxSize"><a href="#4-7-LruCache-trimToSize-int-maxSize" class="headerlink" title="4.7 LruCache.trimToSize(int maxSize)"></a>4.7 LruCache.trimToSize(int maxSize)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * è¿™æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œ</div><div class="line">     * 1.åªæœ‰ æ‰©å®¹ çš„æƒ…å†µä¸‹èƒ½ç«‹å³è·³å‡º</div><div class="line">     * 2.éæ‰©å®¹çš„æƒ…å†µä¸‹ï¼Œmapçš„æ•°æ®ä¼šä¸€ä¸ªä¸€ä¸ªåˆ é™¤ï¼Œç›´åˆ°mapé‡Œæ²¡æœ‰å€¼äº†ï¼Œå°±ä¼šè·³å‡º</div><div class="line">     */</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        K key;</div><div class="line">        V value;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="comment">// åœ¨é‡æ–°è°ƒæ•´å®¹é‡å¤§å°å‰ï¼Œæœ¬èº«å®¹é‡å°±ä¸ºç©ºçš„è¯ï¼Œä¼šå‡ºå¼‚å¸¸çš„ã€‚</span></div><div class="line">            <span class="keyword">if</span> (size &lt; <span class="number">0</span> || (map.isEmpty() &amp;&amp; size != <span class="number">0</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                        getClass().getName() + <span class="string">".sizeOf() is reporting inconsistent results!"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// å¦‚æœæ˜¯ æ‰©å®¹ æˆ–è€… mapä¸ºç©ºäº†ï¼Œå°±ä¼šä¸­æ–­ï¼Œå› ä¸ºæ‰©å®¹ä¸ä¼šæ¶‰åŠåˆ°ä¸¢å¼ƒæ•°æ®çš„æƒ…å†µ</span></div><div class="line">            <span class="keyword">if</span> (size &lt;= maxSize || map.isEmpty()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Map.Entry&lt;K, V&gt; toEvict = map.entrySet().iterator().next();</div><div class="line">            key = toEvict.getKey();</div><div class="line">            value = toEvict.getValue();</div><div class="line">            map.remove(key);</div><div class="line">            <span class="comment">// æ‹¿åˆ°é”®å€¼å¯¹ï¼Œè®¡ç®—å‡ºåœ¨å®¹é‡ä¸­çš„ç›¸å¯¹é•¿åº¦ï¼Œç„¶åå‡å»ã€‚</span></div><div class="line">            size -= safeSizeOf(key, value);</div><div class="line">            <span class="comment">// æ·»åŠ ä¸€æ¬¡æ”¶å›æ¬¡æ•°</span></div><div class="line">            evictionCount++;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * å°†æœ€åä¸€æ¬¡åˆ é™¤çš„æœ€å°‘è®¿é—®æ•°æ®å›è°ƒå‡ºå»</div><div class="line">         */</div><div class="line">        entryRemoved(<span class="keyword">true</span>, key, value, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€å•æè¿°ï¼šä¼šåˆ¤æ–­ä¹‹å‰ <code>size</code> æ˜¯å¦å¤§äº <code>maxSize</code> ã€‚æ˜¯çš„è¯ï¼Œç›´æ¥è·³å‡ºåä»€ä¹ˆä¹Ÿä¸åšã€‚ä¸æ˜¯çš„è¯ï¼Œè¯æ˜å·²ç»æº¢å‡ºå®¹é‡äº†ã€‚ç”± <code>makeTail</code> å›¾å·²çŸ¥ï¼Œæœ€è¿‘ç»å¸¸è®¿é—®çš„æ•°æ®åœ¨æœ€æœ«å°¾ã€‚æ‹¿åˆ°ä¸€ä¸ªå­˜æ”¾ key çš„ Setï¼Œç„¶åä¸€ç›´ä¸€ç›´ä»å¤´å¼€å§‹åˆ é™¤ï¼Œåˆ ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æº¢å‡ºï¼Œç›´åˆ°æ²¡æœ‰æº¢å‡ºã€‚</p>
<p>æœ€åçœ‹çœ‹ï¼š</p>
<h3 id="4-8-è¦†å†™-entryRemoved-çš„ä½œç”¨"><a href="#4-8-è¦†å†™-entryRemoved-çš„ä½œç”¨" class="headerlink" title="4.8 è¦†å†™ entryRemoved çš„ä½œç”¨"></a>4.8 è¦†å†™ entryRemoved çš„ä½œç”¨</h3><p>entryRemovedè¢«LruCacheè°ƒç”¨çš„åœºæ™¯ï¼š</p>
<ul>
<li><strong>1.ï¼ˆputï¼‰</strong> put å‘ç”Ÿ key å†²çªæ—¶è¢«è°ƒç”¨ï¼Œ<strong>evicted=falseï¼Œkey=æ­¤æ¬¡ put çš„ keyï¼ŒoldValue=è¢«è¦†ç›–çš„å†²çª valueï¼ŒnewValue=æ­¤æ¬¡ put çš„ value</strong>ã€‚</li>
<li><strong>2.ï¼ˆtrimToSizeï¼‰</strong> trimToSize çš„æ—¶å€™ï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå°±æ˜¯æœ€åä¸€æ¬¡è¢«åˆ é™¤çš„æœ€å°‘è®¿é—®æ•°æ®å¸¦å›æ¥ã€‚<strong>evicted=trueï¼Œkey=æœ€åä¸€æ¬¡è¢«åˆ é™¤çš„ keyï¼ŒoldValue=æœ€åä¸€æ¬¡è¢«åˆ é™¤çš„ valueï¼ŒnewValue=nullï¼ˆæ­¤æ¬¡æ²¡æœ‰å†²çªï¼Œåªæ˜¯ removeï¼‰</strong>ã€‚</li>
<li><strong>3.ï¼ˆremoveï¼‰</strong> removeçš„æ—¶å€™ï¼Œå­˜åœ¨å¯¹åº” keyï¼Œå¹¶ä¸”è¢«æˆåŠŸåˆ é™¤åè¢«è°ƒç”¨ã€‚<strong>evicted=falseï¼Œkey=æ­¤æ¬¡ putçš„ keyï¼ŒoldValue=æ­¤æ¬¡åˆ é™¤çš„ valueï¼ŒnewValue=nullï¼ˆæ­¤æ¬¡æ²¡æœ‰å†²çªï¼Œåªæ˜¯ removeï¼‰</strong>ã€‚</li>
<li><strong>4.ï¼ˆgetååŠæ®µï¼ŒæŸ¥è¯¢ä¸¢å¤±åå¤„ç†æƒ…æ™¯ï¼Œä¸è¿‡å»ºè®®å¿½ç•¥ï¼‰</strong> get çš„æ—¶å€™ï¼Œæ­£å¸¸çš„è¯ä¸å®ç°è‡ªå®šä¹‰ <code>create</code> çš„è¯ï¼Œä»£ç ä¸Šçœ‹ get æ–¹æ³•åªä¼šèµ°ä¸€åŠï¼Œå¦‚æœä½ å®ç°äº†è‡ªå®šä¹‰çš„ <code>create(K key)</code> æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨ ä½  create åçš„å€¼æ”¾å…¥ LruCache ä¸­å‘ç”Ÿ key å†²çªæ—¶è¢«è°ƒç”¨ï¼Œ<strong>evicted=falseï¼Œkey=æ­¤æ¬¡ get çš„ keyï¼ŒoldValue=è¢«ä½ è‡ªå®šä¹‰ create(key)åçš„ valueï¼ŒnewValue=åŸæœ¬å­˜åœ¨ map é‡Œçš„ key-value</strong>ã€‚</li>
</ul>
<p>è§£é‡Šä¸€ä¸‹ç¬¬å››ç‚¹å§ï¼š</p>
<ul>
<li>ç¬¬å››ç‚¹æ˜¯è¿™æ ·çš„ï¼Œå…ˆ get(key)ï¼Œç„¶åæ²¡æ‹¿åˆ°ï¼Œä¸¢å¤±ã€‚</li>
<li>å¦‚æœä½ æä¾›äº† è‡ªå®šä¹‰çš„ <code>create(key)</code> æ–¹æ³•ï¼Œé‚£ä¹ˆ LruCache ä¼šæ ¹æ®ä½ çš„é€»è¾‘è‡ªé€ ä¸€ä¸ª valueï¼Œä½†æ˜¯å½“æ”¾å…¥çš„æ—¶å€™å‘ç°å†²çªäº†ï¼Œä½†æ˜¯å·²ç»æ”¾å…¥äº†ã€‚</li>
<li>æ­¤æ—¶ï¼Œä¼šå°†é‚£ä¸ªå†²çªçš„å€¼å†è®©å›å»è¦†ç›–ï¼Œæ­¤æ—¶è°ƒç”¨ä¸Šè¿°4.çš„ entryRemovedã€‚</li>
</ul>
<p>å› ä¸º HashMap åœ¨æ•°æ®é‡å¤§æƒ…å†µä¸‹ï¼Œæ‹¿æ•°æ®å¯èƒ½é€ æˆä¸¢å¤±ï¼Œå¯¼è‡´å‰åŠæ®µæŸ¥ä¸åˆ°ï¼Œä½ è‡ªå®šä¹‰çš„ <code>create(key)</code> æ”¾å…¥çš„æ—¶å€™å‘ç°åˆæŸ¥åˆ°äº†<strong>ï¼ˆæœ‰å†²çªï¼‰</strong>ã€‚ç„¶ååˆæ€¥å¿™æŠŠåŸæ¥çš„å€¼æ”¾å›å»ï¼Œæ­¤æ—¶ä½ å°±ç™½ç™½createä¸€è¶Ÿï¼Œæ— æ‰€ä½œä¸ºï¼Œè¿˜è¦èµ°ä¸€éentryRemovedã€‚</p>
<p>ç»¼ä¸Šå°±å¦‚åŒæ³¨é‡Šå†™çš„ä¸€æ ·ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 1.å½“è¢«å›æ”¶æˆ–è€…åˆ æ‰æ—¶è°ƒç”¨ã€‚è¯¥æ–¹æ³•å½“valueè¢«å›æ”¶é‡Šæ”¾å­˜å‚¨ç©ºé—´æ—¶è¢«removeè°ƒç”¨</div><div class="line"> * æˆ–è€…æ›¿æ¢æ¡ç›®å€¼æ—¶putè°ƒç”¨ï¼Œé»˜è®¤å®ç°ä»€ä¹ˆéƒ½æ²¡åšã€‚</div><div class="line"> * 2.è¯¥æ–¹æ³•æ²¡ç”¨åŒæ­¥è°ƒç”¨ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è®¿é—®ç¼“å­˜æ—¶ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šæ‰§è¡Œã€‚</div><div class="line"> * 3.evicted=trueï¼šå¦‚æœè¯¥æ¡ç›®è¢«åˆ é™¤ç©ºé—´ ï¼ˆè¡¨ç¤º è¿›è¡Œäº†trimToSize or removeï¼‰  evicted=falseï¼šputå†²çªå æˆ– geté‡ŒæˆåŠŸcreateå</div><div class="line"> * å¯¼è‡´</div><div class="line"> * 4.newValue!=nullï¼Œé‚£ä¹ˆåˆ™è¢«put()æˆ–get()è°ƒç”¨ã€‚</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">entryRemoved</span><span class="params">(<span class="keyword">boolean</span> evicted, K key, V oldValue, V newValue)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥å‚è€ƒæˆ‘çš„ <a href="https://github.com/CaMnter/AndroidLife/blob/master/app/src/main/java/com/camnter/newlife/views/activity/lrucache/LruCacheActivity.java" target="_blank" rel="external">demo</a> é‡Œçš„ <code>entryRemoved</code> ã€‚   </p>
<h3 id="4-9-LruCache-å±€éƒ¨åŒæ­¥é”"><a href="#4-9-LruCache-å±€éƒ¨åŒæ­¥é”" class="headerlink" title="4.9 LruCache å±€éƒ¨åŒæ­¥é”"></a>4.9 LruCache å±€éƒ¨åŒæ­¥é”</h3><p>åœ¨ <code>get</code>, <code>put</code>, <code>trimToSize</code>, <code>remove</code> å››ä¸ªæ–¹æ³•é‡Œçš„ <code>entryRemoved</code> æ–¹æ³•éƒ½ä¸åœ¨åŒæ­¥å—é‡Œã€‚å› ä¸º <code>entryRemoved</code> å›è°ƒçš„å‚æ•°éƒ½å±äºæ–¹æ³•åŸŸå‚æ•°ï¼Œä¸ä¼šçº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<blockquote>
<p>æœ¬åœ°æ–¹æ³•æ ˆå’Œç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹éš”ç¦»çš„æ•°æ®åŒº  </p>
</blockquote>
<h2 id="5-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"><a href="#5-å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨" class="headerlink" title="5. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨"></a>5. å¼€æºé¡¹ç›®ä¸­çš„ä½¿ç”¨</h2><p><a href="https://github.com/square/picasso" target="_blank" rel="external">square/picasso</a></p>
<h2 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h2><p>LruCacheé‡è¦çš„å‡ ç‚¹ï¼š</p>
<ul>
<li><p><strong>1.</strong>LruCache æ˜¯é€šè¿‡ LinkedHashMap æ„é€ æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ <code>accessOrder=true</code> å®ç°äº† <code>LinkedHashMap</code> çš„æ•°æ®æ’åº<strong>åŸºäºè®¿é—®é¡ºåº</strong> ï¼ˆæœ€è¿‘è®¿é—®çš„æ•°æ®ä¼šåœ¨é“¾è¡¨å°¾éƒ¨ï¼‰ï¼Œåœ¨å®¹é‡æº¢å‡ºçš„æ—¶å€™ï¼Œå°†é“¾è¡¨å¤´éƒ¨çš„æ•°æ®ç§»é™¤ã€‚ä»è€Œï¼Œå®ç°äº† LRU æ•°æ®ç¼“å­˜æœºåˆ¶ã€‚</p>
</li>
<li><p><strong>2.</strong>LruCache åœ¨å†…éƒ¨çš„getã€putã€removeåŒ…æ‹¬ trimToSize éƒ½æ˜¯å®‰å…¨çš„ï¼ˆå› ä¸ºéƒ½ä¸Šé”äº†ï¼‰ã€‚</p>
</li>
<li><p><strong>3.</strong>LruCache è‡ªèº«å¹¶æ²¡æœ‰é‡Šæ”¾å†…å­˜ï¼Œå°† LinkedHashMap çš„æ•°æ®ç§»é™¤äº†ï¼Œå¦‚æœæ•°æ®è¿˜åœ¨åˆ«çš„åœ°æ–¹è¢«å¼•ç”¨äº†ï¼Œè¿˜æ˜¯æœ‰æ³„æ¼é—®é¢˜ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚</p>
</li>
<li><p><strong>4.</strong>è¦†å†™ <code>entryRemoved</code> æ–¹æ³•èƒ½çŸ¥é“ LruCache æ•°æ®ç§»é™¤æ˜¯æ˜¯å¦å‘ç”Ÿäº†å†²çªï¼Œä¹Ÿå¯ä»¥å»æ‰‹åŠ¨é‡Šæ”¾èµ„æºã€‚</p>
</li>
<li><p><strong>5.</strong><code>maxSize</code> å’Œ <code>sizeOf(K key, V value)</code> æ–¹æ³•çš„è¦†å†™æ¯æ¯ç›¸å…³ï¼Œå¿…é¡»ç›¸åŒå•ä½ã€‚ï¼ˆ æ¯”å¦‚ maxSize æ˜¯7MBï¼Œè‡ªå®šä¹‰çš„ sizeOf è®¡ç®—æ¯ä¸ªæ•°æ®å¤§å°çš„æ—¶å€™å¿…é¡»èƒ½ç®—å‡ºä¸MBä¹‹é—´æœ‰è”ç³»çš„å•ä½ ï¼‰</p>
</li>
</ul>
<h2 id="7-èµ„æº"><a href="#7-èµ„æº" class="headerlink" title="7. èµ„æº"></a>7. èµ„æº</h2><p><a href="https://github.com/CaMnter/AndroidLife/blob/master/app/src/main/java/com/camnter/newlife/views/activity/lrucache/LruCacheActivity.java" target="_blank" rel="external">LruCacheActivity</a>    </p>
<p><a href="https://github.com/CaMnter/AndroidLife/blob/master/app/src/main/java/com/camnter/newlife/utils/cache/LruCache.java" target="_blank" rel="external">LruCache æ³¨é‡Šæºç </a>   </p>
<p><a href="https://github.com/LittleFriendsGroup/AndroidSdkSourceAnalysis/blob/master/article/LruCache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md" target="_blank" rel="external">åŸæ–‡é“¾æ¥</a></p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>FloatingActionButtonæºç è§£æ</title>
    <link href="https://likeqy.com/2017/07/26/FloatingActionButton%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/FloatingActionButtonæºç è§£æ/</id>
    <published>2017-07-26T11:55:14.000Z</published>
    <updated>2017-07-26T11:57:13.408Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>FloatingActionButtonï¼ˆä¸‹æ–‡ä»¥fabä»£æ›¿ï¼‰æ˜¯android support designç»„ä»¶åº“ä¸­æä¾›çš„ä¸€ä¸ªè§†å›¾æ§ä»¶ï¼Œæ˜¯material designè®¾è®¡ä¸­fabçš„å®˜æ–¹å®ç°ã€‚</p>
<p>æ­¤æ§ä»¶çš„å®˜æ–¹ä»‹ç»å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Floating action buttons are used for a promoted action. They are distinguished by a circled icon floating above the UI and have motion behaviors that include morphing, launching, and a transferring anchor point.</p>
</blockquote>
<p>å…³äºè¯¥æ§ä»¶çš„è®¾è®¡è§„èŒƒåŠä½¿ç”¨åœºæ™¯è¯·å‚è€ƒæ–‡æ¡£ï¼š</p>
<blockquote>
<p><a href="http://www.google.com/design/spec/components/buttons-floating-action-button.html#" target="_blank" rel="external">http://www.google.com/design/spec/components/buttons-floating-action-button.html#</a></p>
</blockquote>
<p>å¦‚æœä½ è¿˜ä¸äº†è§£designç»„ä»¶åº“ï¼Œè¯·å‚è€ƒå®˜æ–¹åšå®¢:</p>
<blockquote>
<p><a href="http://android-developers.blogspot.hk/2015/05/android-design-support-library.html" target="_blank" rel="external">http://android-developers.blogspot.hk/2015/05/android-design-support-library.html</a></p>
</blockquote>
<h2 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h2><p>æºç ç‰ˆæœ¬:23.3.0</p>
<p><img src="./01.png" alt="ç±»å›¾"></p>
<p>fabé—´æ¥ç»§æ‰¿è‡ª<code>ImageView</code>ï¼ˆ<code>ImageButton</code>æ˜¯<code>ImageView</code>çš„å­ç±»ï¼‰ï¼Œå› è€Œæ‹¥æœ‰<code>ImageView</code>çš„å¤§éƒ¨åˆ†ç‰¹æ€§ã€‚ä½†æ˜¯å…¶å†…éƒ¨è¿˜æ˜¯åšäº†å¾ˆå¤šå®šåˆ¶ï¼Œæˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ã€‚</p>
<h3 id="1-fabçš„è‡ªå®šä¹‰å±æ€§ã€èƒŒæ™¯ç€è‰²ç›¸å…³"><a href="#1-fabçš„è‡ªå®šä¹‰å±æ€§ã€èƒŒæ™¯ç€è‰²ç›¸å…³" class="headerlink" title="1. fabçš„è‡ªå®šä¹‰å±æ€§ã€èƒŒæ™¯ç€è‰²ç›¸å…³"></a>1. fabçš„è‡ªå®šä¹‰å±æ€§ã€èƒŒæ™¯ç€è‰²ç›¸å…³</h3><p>ä»æ„é€ å™¨å¼€å§‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FloatingActionButton</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">		 <span class="comment">//æ£€æŸ¥æ˜¯å¦ä½¿ç”¨Theme.Appcompatä¸»é¢˜</span></div><div class="line">        ThemeUtils.checkAppCompatTheme(context);</div><div class="line">        <span class="comment">//æ‹¿åˆ°è‡ªå®šä¹‰å±æ€§å¹¶èµ‹å€¼</span></div><div class="line">        TypedArray a = context.obtainStyledAttributes(attrs,</div><div class="line">                R.styleable.FloatingActionButton, defStyleAttr,</div><div class="line">                R.style.Widget_Design_FloatingActionButton);</div><div class="line">       ...</div><div class="line">        a.recycle();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> maxImageSize = (<span class="keyword">int</span>) getResources().getDimension(R.dimen.design_fab_image_size);</div><div class="line">        mImagePadding = (getSizeDimension() - maxImageSize) / <span class="number">2</span>;</div><div class="line"></div><div class="line">		<span class="comment">//èƒŒæ™¯ç€è‰²</span></div><div class="line">        getImpl().setBackgroundDrawable(mBackgroundTint, mBackgroundTintMode,</div><div class="line">                mRippleColor, mBorderWidth);</div><div class="line">      <span class="comment">//ç»˜åˆ¶é˜´å½±</span></div><div class="line">        getImpl().setElevation(elevation);</div><div class="line">		...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨ä¸­ä¸»è¦æ˜¯æ‹¿åˆ°ç”¨æˆ·è®¾ç½®çš„è‡ªå®šä¹‰å±æ€§ï¼Œæ¯”å¦‚ç€è‰²ã€æ³¢çº¹é¢œè‰²ã€å¤§å°ç­‰ç­‰,ä¸€å…±æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§å¯ä»¥å®šä¹‰ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"FloatingActionButton"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"backgroundTint"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"backgroundTintMode"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"color"</span> <span class="attr">name</span>=<span class="string">"rippleColor"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"fabSize"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"normal"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"mini"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">attr</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"elevation"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"dimension"</span> <span class="attr">name</span>=<span class="string">"pressedTranslationZ"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"dimension"</span> <span class="attr">name</span>=<span class="string">"borderWidth"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"boolean"</span> <span class="attr">name</span>=<span class="string">"useCompatPadding"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å±æ€§çš„é»˜è®¤å€¼å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Design.FloatingActionButton"</span> <span class="attr">parent</span>=<span class="string">"android:Widget"</span>&gt;</span><span class="xml"></span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:background"</span>&gt;</span>@drawable/design_fab_background<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"backgroundTint"</span>&gt;</span>?attr/colorAccent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"fabSize"</span>&gt;</span>normal<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"elevation"</span>&gt;</span>@dimen/design_fab_elevation<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"pressedTranslationZ"</span>&gt;</span>@dimen/design_fab_translation_z_pressed<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"rippleColor"</span>&gt;</span>?attr/colorControlHighlight<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"borderWidth"</span>&gt;</span>@dimen/design_fab_border_width<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>android:background</code>å±æ€§ï¼Œè¿™é‡ŒæŒ‡å®šäº†backgroundä¸º<code>design_fab_background</code>,å¹¶ä¸”ä¸å…è®¸æ”¹å˜:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBackgroundDrawable</span><span class="params">(Drawable background)</span> </span>&#123;</div><div class="line">      Log.i(LOG_TAG, <span class="string">"Setting a custom background is not supported."</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªbackgroundé•¿å•¥æ ·ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">        <span class="attr">android:shape</span>=<span class="string">"oval"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@android:color/white"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å¾ˆæ˜¾ç„¶ï¼Œfabçš„å½¢çŠ¶å›ºå®šä¸ºåœ†å½¢éƒ½æ˜¯å› ä¸ºè¿™ä¸ªbackgroundã€‚é‚£ä¹ˆè¿™é‡ŒæŒ‡å®šäº†èƒŒæ™¯è‰²ä¸ºç™½è‰²ï¼Œé‚£æ˜¯ä¸æ˜¯fabåªèƒ½æ˜¯ç™½è‰²èƒŒæ™¯å‘¢ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œè¿˜æœ‰æˆ‘ä»¬ç‰›é€¼çš„backgroundTint(å³èƒŒæ™¯ç€è‰²)ï¼Œtintæ˜¯android 5.xå¼•è¿›çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå¯ä»¥åŠ¨æ€åœ°ç»™drawableèµ„æºç€è‰²ï¼Œå…¶åŸç†å°±æ˜¯é€šè¿‡ç»™æ§ä»¶è®¾ç½®colorFilter:</p>
<p>drawable.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColorFilter</span><span class="params">(@ColorInt <span class="keyword">int</span> color, @NonNull PorterDuff.Mode mode)</span> </span>&#123;</div><div class="line">        setColorFilter(<span class="keyword">new</span> PorterDuffColorFilter(color, mode));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤çš„ç€è‰²æ¨¡å¼ä¸ºSRC_IN(å–äº¤é›†ã€æ˜¾ç¤ºä¸Šå±‚ï¼Œæ•…åº•å±‚ç™½è‰²ä¼šè¢«å¿½ç•¥)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> PorterDuff.Mode DEFAULT_TINT_MODE = PorterDuff.Mode.SRC_IN;</div></pre></td></tr></table></figure>
<p>åœ¨fabæ„é€ çš„æ—¶å€™ï¼Œä¼šæŒ‡å®šç€è‰²ä¸º<code>ï¼Ÿattr/colorAccent</code>ï¼Œå³å½“å‰ä¸»é¢˜çš„<code>colorAccent</code>å±æ€§å€¼ã€‚<br>ç„¶åæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œè¿›è¡Œç€è‰²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">getImpl().setBackgroundDrawable(mBackgroundTint, mBackgroundTintMode,</div><div class="line">               mRippleColor, mBorderWidth);</div></pre></td></tr></table></figure>
<p>å› ä¸ºä¸åŒç‰ˆæœ¬é—´çš„å®ç°ç•¥æœ‰ä¸åŒï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ ¹æ®ä¸åŒç‰ˆæœ¬åˆ›å»ºä¸åŒçš„<code>FloatingActionButtonImpl</code>å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> FloatingActionButtonImpl <span class="title">createImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sdk = Build.VERSION.SDK_INT;</div><div class="line">        <span class="keyword">if</span> (sdk &gt;= <span class="number">21</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FloatingActionButtonLollipop(<span class="keyword">this</span>, <span class="keyword">new</span> ShadowDelegateImpl());</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">14</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FloatingActionButtonIcs(<span class="keyword">this</span>, <span class="keyword">new</span> ShadowDelegateImpl());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FloatingActionButtonEclairMr1(<span class="keyword">this</span>, <span class="keyword">new</span> ShadowDelegateImpl());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»¥5.xä¸ºä¾‹ï¼Œå…¶setBackgroundDrawableå®ç°ä»£ç å¦‚ä¸‹:</p>
<p>å…ˆåˆ›å»ºç€è‰²çš„èƒŒæ™¯drawableã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">GradientDrawable <span class="title">createShapeDrawable</span><span class="params">()</span> </span>&#123;</div><div class="line">       GradientDrawable d = <span class="keyword">new</span> GradientDrawable();</div><div class="line">       d.setShape(GradientDrawable.OVAL);</div><div class="line">       d.setColor(Color.WHITE);</div><div class="line">       <span class="keyword">return</span> d;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å†å¯¹æ­¤drawableè®¾ç½®tintï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBackgroundDrawable</span><span class="params">(ColorStateList backgroundTint,</span></span></div><div class="line">            PorterDuff.Mode backgroundTintMode, <span class="keyword">int</span> rippleColor, <span class="keyword">int</span> borderWidth) &#123;</div><div class="line">        <span class="comment">// Now we need to tint the shape background with the tint</span></div><div class="line">        mShapeDrawable = DrawableCompat.wrap(createShapeDrawable());</div><div class="line"></div><div class="line">        <span class="comment">//ç€è‰²ï¼Œè¿™é‡Œä¼šå…¶å®å°±æ˜¯è®¾ç½®äº†ä¸‹colorFilter</span></div><div class="line">        DrawableCompat.setTintList(mShapeDrawable, backgroundTint);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (backgroundTintMode != <span class="keyword">null</span>) &#123;</div><div class="line">            DrawableCompat.setTintMode(mShapeDrawable, backgroundTintMode);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Drawable rippleContent;</div><div class="line">        <span class="keyword">if</span> (borderWidth &gt; <span class="number">0</span>) &#123;</div><div class="line">            mBorderDrawable = createBorderDrawable(borderWidth, backgroundTint);</div><div class="line">            rippleContent = <span class="keyword">new</span> LayerDrawable(<span class="keyword">new</span> Drawable[]&#123;mBorderDrawable, mShapeDrawable&#125;);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mBorderDrawable = <span class="keyword">null</span>;</div><div class="line">            rippleContent = mShapeDrawable;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mRippleDrawable = <span class="keyword">new</span> RippleDrawable(ColorStateList.valueOf(rippleColor),</div><div class="line">                rippleContent, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        mContentBackground = mRippleDrawable;</div><div class="line"></div><div class="line">        mShadowViewDelegate.setBackgroundDrawable(mRippleDrawable);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ç»è¿‡ç€è‰²ï¼Œfabå°±å‘ˆç°å‡ºæˆ‘ä»¬æƒ³è¦çš„é¢œè‰²å•¦ã€‚</p>
<h3 id="2-fabçš„å¤§å°"><a href="#2-fabçš„å¤§å°" class="headerlink" title="2. fabçš„å¤§å°"></a>2. fabçš„å¤§å°</h3><p>å†æ¥çœ‹fabçš„å¤§å°ï¼Œfabæœ‰ä¸¤ç§å¤§å°ï¼Œä¸€ç§æ˜¯<code>NORMAL</code>ï¼Œä¸€ç§æ˜¯<code>MINI</code>ï¼Œå®é™…å¤§å°åˆ†åˆ«æ˜¯56dpå’Œ40dpï¼Œå…¶å®šä¹‰å¯ä»¥åœ¨designåº“çš„values.xmlä¸­çœ‹åˆ°ã€‚</p>
<p>fabå¦‚ä½•æ§åˆ¶æ§ä»¶å¤§å°åªæœ‰è¿™ä¸¤ç§è§„æ ¼å‘¢(è¿™æ ·è¯´ä¸å‡†ç¡®ï¼Œäº‹å®ä¸Šä½ å¯ä»¥é€šè¿‡è®¾ç½®fabçš„<code>layout_width</code>/<code>layout_height</code>æŒ‡å®šä¸ºä»»æ„å¤§å°ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€å¥½æŒ‰ç…§MDè§„èŒƒæ¥)?å¿…ç„¶æ˜¯é€šè¿‡å¤å†™<code>onMeasure</code>å•¦:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">      <span class="comment">//æˆ‘ä»¬å¸Œæœ›çš„å¤§å°</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> preferredSize = getSizeDimension();</div><div class="line"> <span class="comment">//æœ€ç»ˆæµ‹é‡çš„å¤§å°</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> w = resolveAdjustedSize(preferredSize, widthMeasureSpec);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> h = resolveAdjustedSize(preferredSize, heightMeasureSpec);</div><div class="line"></div><div class="line">      <span class="comment">//å–å°å€¼ï¼Œä¿è¯æœ€åç»˜åˆ¶çš„æ˜¯åœ†å½¢</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> d = Math.min(w, h);</div><div class="line"></div><div class="line">      <span class="comment">// We add the shadow's padding to the measured dimension</span></div><div class="line">      setMeasuredDimension(</div><div class="line">              d + mShadowPadding.left + mShadowPadding.right,</div><div class="line">              d + mShadowPadding.top + mShadowPadding.bottom);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>getSizeDimension</code>æ–¹æ³•è®¡ç®—å‡ºæ¥çš„æ˜¯æˆ‘ä»¬æœŸæœ›çš„å¤§å°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getSizeDimension</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (mSize) &#123;</div><div class="line">            <span class="keyword">case</span> SIZE_MINI:</div><div class="line">                <span class="keyword">return</span> getResources().getDimensionPixelSize(R.dimen.design_fab_size_mini);<span class="comment">//40dp</span></div><div class="line">            <span class="keyword">case</span> SIZE_NORMAL:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> getResources().getDimensionPixelSize(R.dimen.design_fab_size_normal);<span class="comment">//56dp</span></div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯æœ€ç»ˆçš„å€¼è¿˜æ˜¯å¾—çœ‹æˆ‘ä»¬è®¾ç½®çš„LayoutParamsã€‚å…³äºæ§ä»¶æµ‹é‡ç›¸å…³å†…å®¹ä¸åœ¨æ­¤æ–‡ä»‹ç»èŒƒå›´å†…ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œgoogleã€‚</p>
<h3 id="3-fabçš„åŠ¨ç”»"><a href="#3-fabçš„åŠ¨ç”»" class="headerlink" title="3.fabçš„åŠ¨ç”»"></a>3.fabçš„åŠ¨ç”»</h3><p>fabè¿˜æ”¯æŒfabä»¥åŠ¨ç”»çš„æ–¹å¼æ˜¾ç°/éšè—ï¼Œé€šå¸¸å’ŒAppBarLayoutä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡<code>hide()</code>/<code>show()</code>ä¸¤ä¸ªæ–¹æ³•æ§åˆ¶ã€‚</p>
<p>é‚£ä¹ˆåŠ¨ç”»æ˜¯å¦‚ä½•å®ç°çš„å‘¢:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(OnVisibilityChangedListener listener, <span class="keyword">boolean</span> fromUser)</span> </span>&#123;</div><div class="line">        getImpl().show(wrapOnVisibilityChangedListener(listener), fromUser);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">(@Nullable OnVisibilityChangedListener listener, <span class="keyword">boolean</span> fromUser)</span> </span>&#123;</div><div class="line">    getImpl().hide(wrapOnVisibilityChangedListener(listener), fromUser);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå› ä¸ºè¦å…¼å®¹ä¸åŒç‰ˆæœ¬ï¼Œæ‰€ä»¥å…·ä½“å®ç°ä¹Ÿäº¤ç»™äº†ä¸åŒçš„fabå®ç°ç±»ã€‚3.xä¹‹åå¾ˆå¥½åŠï¼Œç›´æ¥ä½¿ç”¨å±æ€§åŠ¨ç”»ï¼Œå¦‚æœæ˜¯3.xä¹‹å‰çš„è¯ï¼Œé‚£ä¹ˆåªèƒ½ä½¿ç”¨ä¼ ç»Ÿçš„Animationäº†</p>
<p>ä»¥<code>hide()</code>ä¸ºä¾‹ï¼Œä½¿ç”¨å±æ€§åŠ¨ç”»è¾ƒä¸ºç®€å•ï¼Œç›´æ¥ä½¿ç”¨<code>View#animate()</code>å³å¯é“¾å¼è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hide</span><span class="params">(@Nullable <span class="keyword">final</span> InternalVisibilityChangedListener listener, <span class="keyword">final</span> <span class="keyword">boolean</span> fromUser)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mIsHiding || mView.getVisibility() != View.VISIBLE) &#123;</div><div class="line">            <span class="comment">// A hide animation is in progress, or we're already hidden. Skip the call</span></div><div class="line">            <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                listener.onHidden();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!ViewCompat.isLaidOut(mView) || mView.isInEditMode()) &#123;</div><div class="line">            <span class="comment">// If the view isn't laid out, or we're in the editor, don't run the animation</span></div><div class="line">            mView.internalSetVisibility(View.GONE, fromUser);</div><div class="line">            <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                listener.onHidden();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mView.animate().cancel();</div><div class="line">            mView.animate()</div><div class="line">                    .scaleX(<span class="number">0f</span>)</div><div class="line">                    .scaleY(<span class="number">0f</span>)</div><div class="line">                    .alpha(<span class="number">0f</span>)</div><div class="line">                    .setDuration(SHOW_HIDE_ANIM_DURATION)</div><div class="line">                    .setInterpolator(AnimationUtils.FAST_OUT_LINEAR_IN_INTERPOLATOR)</div><div class="line">                    .setListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                        <span class="keyword">private</span> <span class="keyword">boolean</span> mCancelled;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                            mIsHiding = <span class="keyword">true</span>;</div><div class="line">                            mCancelled = <span class="keyword">false</span>;</div><div class="line">                            mView.internalSetVisibility(View.VISIBLE, fromUser);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                            mIsHiding = <span class="keyword">false</span>;</div><div class="line">                            mCancelled = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                            mIsHiding = <span class="keyword">false</span>;</div><div class="line">                            <span class="keyword">if</span> (!mCancelled) &#123;</div><div class="line">                                mView.internalSetVisibility(View.GONE, fromUser);</div><div class="line">                                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                                    listener.onHidden();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨ä¼ ç»ŸåŠ¨ç”»çš„è¯ï¼Œåˆ™å…ˆåœ¨xmlä¸­å®šä¹‰å¥½åŠ¨ç”»ï¼Œç„¶åæ„é€ <code>Animation</code>å®ä¾‹ï¼Œå¯åŠ¨åŠ¨ç”»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">hide</span><span class="params">(@Nullable <span class="keyword">final</span> InternalVisibilityChangedListener listener, <span class="keyword">final</span> <span class="keyword">boolean</span> fromUser)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mIsHiding || mView.getVisibility() != View.VISIBLE) &#123;</div><div class="line">           <span class="comment">// A hide animation is in progress, or we're already hidden. Skip the call</span></div><div class="line">           <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">               listener.onHidden();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Animation anim = android.view.animation.AnimationUtils.loadAnimation(</div><div class="line">               mView.getContext(), R.anim.design_fab_out);</div><div class="line">       anim.setInterpolator(AnimationUtils.FAST_OUT_LINEAR_IN_INTERPOLATOR);</div><div class="line">       anim.setDuration(SHOW_HIDE_ANIM_DURATION);</div><div class="line">       anim.setAnimationListener(<span class="keyword">new</span> AnimationUtils.AnimationListenerAdapter() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animation animation)</span> </span>&#123;</div><div class="line">               mIsHiding = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animation animation)</span> </span>&#123;</div><div class="line">               mIsHiding = <span class="keyword">false</span>;</div><div class="line">               mView.internalSetVisibility(View.GONE, fromUser);</div><div class="line">               <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                   listener.onHidden();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       mView.startAnimation(anim);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="4-fabä¸CoordinatorLayoutçš„äº¤äº’"><a href="#4-fabä¸CoordinatorLayoutçš„äº¤äº’" class="headerlink" title="4. fabä¸CoordinatorLayoutçš„äº¤äº’"></a>4. fabä¸CoordinatorLayoutçš„äº¤äº’</h3><blockquote>
<p>è¿™å—å†…å®¹å› ä¸ºä¸<code>CoordinatorLayout</code>/<code>CoordinatorLayout#Behavior</code>æœ‰å¾ˆå¤§å…³è”ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œè¯·å…ˆgoogleç›¸å…³èµ„æ–™ã€‚æœ¬æ–‡å‡è®¾è¯»è€…å¯¹è¿™å—å†…å®¹å·²ç»æœ‰ä¸€å®šç†è§£ã€‚</p>
</blockquote>
<p>fabå¹¶ä¸ç›´æ¥ä¸<code>CoordinatorLayout</code>è”ç³»ï¼Œè€Œæ˜¯é€šè¿‡<code>CoordinatorLayout#Behavior</code>ä½œä¸ºæ¡¥æ¢ã€‚<code>CoordinatorLayout</code>ç±»é€šè¿‡<code>CoordinatorLayout#Behavior</code>å¯ä»¥é—´æ¥æ§åˆ¶å…¶ç›´ç³»å­Viewçš„è¡Œä¸ºï¼Œèƒ½æ§åˆ¶ä»€ä¹ˆè¡Œä¸ºï¼ŸViewæµ‹é‡ã€å¸ƒå±€ã€touchäº‹ä»¶æ‹¦æˆªã€ç›‘å¬ã€NestedScrollç­‰ç­‰ã€‚æ˜¯ä¸æ˜¯å¾ˆå±Œã€‚</p>
<p>fabå†…éƒ¨å®ç°äº†<code>CoordinatorLayout#Behavior</code>æŠ½è±¡ç±»ã€‚è¯¥æŠ½è±¡ç±»æœ‰å¦‚ä¸‹æ¥å£:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Behavior</span>&lt;<span class="title">V</span> <span class="keyword">extends</span> <span class="title">View</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">		...</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(CoordinatorLayout parent, V child, MotionEvent ev)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(CoordinatorLayout parent, V child, MotionEvent ev)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       ...</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Determine whether the supplied child view has another specific sibling view as a</div><div class="line">         * layout dependency.</div><div class="line">         *</div><div class="line">         * &lt;p&gt;This method will be called at least once in response to a layout request. If it</div><div class="line">         * returns true for a given child and dependency view pair, the parent CoordinatorLayout</div><div class="line">         * will:&lt;/p&gt;</div><div class="line">         * &lt;ol&gt;</div><div class="line">         *     &lt;li&gt;Always lay out this child after the dependent child is laid out, regardless</div><div class="line">         *     of child order.&lt;/li&gt;</div><div class="line">         *     &lt;li&gt;Call &#123;<span class="doctag">@link</span> #onDependentViewChanged&#125; when the dependency view's layout or</div><div class="line">         *     position changes.&lt;/li&gt;</div><div class="line">         * &lt;/ol&gt;</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">layoutDependsOn</span><span class="params">(CoordinatorLayout parent, V child, View dependency)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Respond to a change in a child's dependent view</div><div class="line">         *</div><div class="line">         * &lt;p&gt;This method is called whenever a dependent view changes in size or position outside</div><div class="line">         * of the standard layout flow. A Behavior may use this method to appropriately update</div><div class="line">         * the child view in response.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;A view's dependency is determined by</div><div class="line">         * &#123;<span class="doctag">@link</span> #layoutDependsOn(CoordinatorLayout, android.view.View, android.view.View)&#125; or</div><div class="line">         * if &#123;<span class="doctag">@code</span> child&#125; has set another view as it's anchor.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;Note that if a Behavior changes the layout of a child via this method, it should</div><div class="line">         * also be able to reconstruct the correct position in</div><div class="line">         * &#123;<span class="doctag">@link</span> #onLayoutChild(CoordinatorLayout, android.view.View, int) onLayoutChild&#125;.</div><div class="line">         * &lt;code&gt;onDependentViewChanged&lt;/code&gt; will not be called during normal layout since</div><div class="line">         * the layout of each child view will always happen in dependency order.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;If the Behavior changes the child view's size or position, it should return true.</div><div class="line">         * The default implementation returns false.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDependentViewChanged</span><span class="params">(CoordinatorLayout parent, V child, View dependency)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">			...</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Called when the parent CoordinatorLayout is about the lay out the given child view.</div><div class="line">         *</div><div class="line">         * &lt;p&gt;This method can be used to perform custom or modified layout of a child view</div><div class="line">         * in place of the default child layout behavior. The Behavior's implementation can</div><div class="line">         * delegate to the standard CoordinatorLayout measurement behavior by calling</div><div class="line">         * &#123;<span class="doctag">@link</span> CoordinatorLayout#onLayoutChild(android.view.View, int)</div><div class="line">         * parent.onLayoutChild&#125;.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;If a Behavior implements</div><div class="line">         * &#123;<span class="doctag">@link</span> #onDependentViewChanged(CoordinatorLayout, android.view.View, android.view.View)&#125;</div><div class="line">         * to change the position of a view in response to a dependent view changing, it</div><div class="line">         * should also implement &lt;code&gt;onLayoutChild&lt;/code&gt; in such a way that respects those</div><div class="line">         * dependent views. &lt;code&gt;onLayoutChild&lt;/code&gt; will always be called for a dependent view</div><div class="line">         * &lt;em&gt;after&lt;/em&gt; its dependency has been laid out.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLayoutChild</span><span class="params">(CoordinatorLayout parent, V child, <span class="keyword">int</span> layoutDirection)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScroll</span><span class="params">(CoordinatorLayout coordinatorLayout, V child, View target,</span></span></div><div class="line">                <span class="keyword">int</span> dxConsumed, <span class="keyword">int</span> dyConsumed, <span class="keyword">int</span> dxUnconsumed, <span class="keyword">int</span> dyUnconsumed) &#123;</div><div class="line">            <span class="comment">// Do nothing</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™ä¸ªæŠ½è±¡ç±»ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„:</p>
<ol>
<li>æ­¤æŠ½è±¡ç±»å¹¶æ— æŠ½è±¡æ–¹æ³•ï¼Œä¹Ÿå³å­ç±»å¯é€‰æ‹©ä»»ä½•æƒ³å¤å†™çš„æ–¹æ³•è¿›è¡Œå¤å†™ã€‚</li>
<li>æ­¤æŠ½è±¡ç±»æ¥å—ä¸€ä¸ªæ³›å‹ã€‚è¯¥æ³›å‹éœ€è¦æ˜¯Viewçš„å­ç±»ã€‚</li>
</ol>
<p>fabå®ç°æ­¤æŠ½è±¡ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Behavior</span> <span class="keyword">extends</span> <span class="title">CoordinatorLayout</span>.<span class="title">Behavior</span>&lt;<span class="title">FloatingActionButton</span>&gt; </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>æœ‰é€‰æ‹©æ€§åœ°å®ç°äº†ä¸‰ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">layoutDependsOn</span><span class="params">(CoordinatorLayout parent,</span></span></div><div class="line">                FloatingActionButton child, View dependency);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDependentViewChanged</span><span class="params">(CoordinatorLayout parent, FloatingActionButton child,</span></span></div><div class="line">                View dependency);</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLayoutChild</span><span class="params">(CoordinatorLayout parent, FloatingActionButton child,</span></span></div><div class="line">                <span class="keyword">int</span> layoutDirection);</div></pre></td></tr></table></figure>
<p>fabä¸ºå•¥è¦å®ç°<code>Behavior</code>?ä¸»è¦æ˜¯ä¸ºäº†é…åˆå…¶ä»–æ§ä»¶å®Œæˆä¸€äº›å¤æ‚çš„äº¤äº’ï¼Œæ¯”è¾ƒç»å…¸çš„åƒè¿™ä¸ª:</p>
<p><a href="http://material-design.storage.googleapis.com/publish/material_v_3/material_ext_publish/0B6Okdz75tqQsLWFucDNlYWEyeW8/components_snackbar_usage_fabdo_002.webm" target="_blank" rel="external">fabåŠ¨ç”»æ•ˆæœ</a></p>
<p>fabéœ€è¦åœ¨<code>snackBar</code>å¼¹å‡ºçš„æ—¶å€™è‡ªåŠ¨å‘ä¸Šå¹³ç§»ï¼Œè¿™å°±å¾—çŸ¥é“SnackBarçš„çŠ¶æ€äº†ï¼Œå®ç°<code>Behavior</code>è®©fabæœ‰æœºä¼šç›‘å¬åˆ°å…¶ä»–<code>CoordinatorLayout</code>å­Viewçš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®çŠ¶æ€æ›´æ–°è‡ªå·±ã€‚</p>
<p>å¤å†™<code>layoutDependsOn</code>æ–¹æ³•å¯ä»¥å‘Šè¯‰<code>CoordinatorLayout</code>æˆ‘å¯¹å“ªä¸ªViewæ„Ÿå…´è¶£ï¼Œ</p>
<p>è¿™é‡Œå½“ç„¶æ˜¯SnackBaräº†ã€‚ï¼ˆæ³¨æ„å“¦ï¼ŒSnackBaræœ€ç»ˆå±•ç°çš„æ˜¯SnackbarLayoutï¼ŒSnackBaræœ¬èº«å¹¶ä¸æ˜¯Viewï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SNACKBAR_BEHAVIOR_ENABLED = Build.VERSION.SDK_INT &gt;= <span class="number">11</span>;</div><div class="line"></div><div class="line"> <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">layoutDependsOn</span><span class="params">(CoordinatorLayout parent,</span></span></div><div class="line">                FloatingActionButton child, View dependency) &#123;</div><div class="line">            <span class="comment">// We're dependent on all SnackbarLayouts (if enabled)</span></div><div class="line">            <span class="keyword">return</span> SNACKBAR_BEHAVIOR_ENABLED &amp;&amp; dependency <span class="keyword">instanceof</span> Snackbar.SnackbarLayout;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆAPI LEVELè¦å¤§äº11å‘¢ï¼Ÿå› ä¸ºgoogleå·æ‡’æƒ³ç›´æ¥ä½¿ç”¨å±æ€§åŠ¨ç”»ã€‚</p>
<p>å‰é¢å‘Šè¯‰äº†<code>CoordinatorLayout</code>fabå¯¹<code>SnackBar</code>æ¯”è¾ƒæ„Ÿå…´è¶£,é‚£ä¹ˆå½“SnackBarçŠ¶æ€æ”¹å˜çš„æ—¶å€™ï¼Œ<code>CoordinatorLayout</code>å°±ä¼šé€šè¿‡<code>onDependentViewChanged</code>å›è°ƒé€šçŸ¥fab:</p>
<p>fabå°±å¯ä»¥æ›´æ–°è‡ªå·±çš„UIæ‹‰ï¼ˆè¿™é‡Œå½“ç„¶æ˜¯å¹³ç§»å–½ï¼‰:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDependentViewChanged</span><span class="params">(CoordinatorLayout parent, FloatingActionButton child,</span></span></div><div class="line">                View dependency) &#123;</div><div class="line">            <span class="keyword">if</span> (dependency <span class="keyword">instanceof</span> Snackbar.SnackbarLayout) &#123;</div><div class="line">                updateFabTranslationForSnackbar(parent, child, dependency);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dependency <span class="keyword">instanceof</span> AppBarLayout) &#123;</div><div class="line">                <span class="comment">// If we're depending on an AppBarLayout we will show/hide it automatically</span></div><div class="line">                <span class="comment">// if the FAB is anchored to the AppBarLayout</span></div><div class="line">                updateFabVisibility(parent, (AppBarLayout) dependency, child);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯SnackBarçŠ¶æ€å˜åŒ–äº†ï¼Œé‚£ä¹ˆfabå°±ä¼šæ ¹æ®æƒ…å†µè¿›è¡Œå¹³ç§»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateFabTranslationForSnackbar</span><span class="params">(CoordinatorLayout parent,</span></span></div><div class="line">                <span class="keyword">final</span> FloatingActionButton fab, View snackbar) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> targetTransY = getFabTranslationYForSnackbar(parent, fab);</div><div class="line">            <span class="keyword">if</span> (mFabTranslationY == targetTransY) &#123;</div><div class="line">                <span class="comment">// We're already at (or currently animating to) the target value, return...</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> currentTransY = ViewCompat.getTranslationY(fab);</div><div class="line"></div><div class="line">            <span class="comment">// Make sure that any current animation is cancelled</span></div><div class="line">            <span class="keyword">if</span> (mFabTranslationYAnimator != <span class="keyword">null</span> &amp;&amp; mFabTranslationYAnimator.isRunning()) &#123;</div><div class="line">                mFabTranslationYAnimator.cancel();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (fab.isShown()</div><div class="line">                    &amp;&amp; Math.abs(currentTransY - targetTransY) &gt; (fab.getHeight() * <span class="number">0.667f</span>)) &#123;</div><div class="line">                <span class="comment">// If the FAB will be travelling by more than 2/3 of it's height, let's animate</span></div><div class="line">                <span class="comment">// it instead</span></div><div class="line">                <span class="keyword">if</span> (mFabTranslationYAnimator == <span class="keyword">null</span>) &#123;</div><div class="line">                    mFabTranslationYAnimator = ViewUtils.createAnimator();</div><div class="line">                    mFabTranslationYAnimator.setInterpolator(</div><div class="line">                            AnimationUtils.FAST_OUT_SLOW_IN_INTERPOLATOR);</div><div class="line">                    mFabTranslationYAnimator.setUpdateListener(</div><div class="line">                            <span class="keyword">new</span> ValueAnimatorCompat.AnimatorUpdateListener() &#123;</div><div class="line">                                <span class="meta">@Override</span></div><div class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimatorCompat animator)</span> </span>&#123;</div><div class="line">                                    ViewCompat.setTranslationY(fab,</div><div class="line">                                            animator.getAnimatedFloatValue());</div><div class="line">                                &#125;</div><div class="line">                            &#125;);</div><div class="line">                &#125;</div><div class="line">                mFabTranslationYAnimator.setFloatValues(currentTransY, targetTransY);</div><div class="line">                mFabTranslationYAnimator.start();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Now update the translation Y</span></div><div class="line">                ViewCompat.setTranslationY(fab, targetTransY);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mFabTranslationY = targetTransY;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>ä»£ç é‡Œçš„æ³¨é‡Šå¾ˆå¤šï¼Œæˆ‘å°±ä¸è§£é‡Šäº†ã€‚</p>
<p>å‰é¢è¯´åˆ°AppBarLayoutå’Œfabä¸€èµ·ä½¿ç”¨å¯ä»¥å®Œæˆå¦ä¸€ä¸ªæ•ˆæœï¼Œå³AppBarLayoutä¼¸ç¼©æ—¶ï¼Œfabä¹Ÿå¯ä»¥ä»¥åŠ¨ç”»çš„å½¢å¼æ˜¾ç°ã€éšè—ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateFabVisibility</span><span class="params">(CoordinatorLayout parent,</span></span></div><div class="line">                AppBarLayout appBarLayout, FloatingActionButton child) &#123;</div><div class="line">            <span class="keyword">final</span> CoordinatorLayout.LayoutParams lp =</div><div class="line">                    (CoordinatorLayout.LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="comment">//æ³¨æ„åˆ°æˆ‘ä»¬å¿…é¡»ä¸ºfabæŒ‡å®šlayout_anchorä¸ºappBarLayout                    </span></div><div class="line">            <span class="keyword">if</span> (lp.getAnchorId() != appBarLayout.getId()) &#123;</div><div class="line">                <span class="comment">// The anchor ID doesn't match the dependency, so we won't automatically</span></div><div class="line">                <span class="comment">// show/hide the FAB</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (child.getUserSetVisibility() != VISIBLE) &#123;</div><div class="line">                <span class="comment">// The view isn't set to be visible so skip changing it's visibility</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mTmpRect == <span class="keyword">null</span>) &#123;</div><div class="line">                mTmpRect = <span class="keyword">new</span> Rect();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// First, let's get the visible rect of the dependency</span></div><div class="line">            <span class="keyword">final</span> Rect rect = mTmpRect;</div><div class="line">            ViewGroupUtils.getDescendantRect(parent, appBarLayout, rect);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (rect.bottom &lt;= appBarLayout.getMinimumHeightForVisibleOverlappingContent()) &#123;</div><div class="line">                <span class="comment">// If the anchor's bottom is below the seam, we'll animate our FAB out</span></div><div class="line">                child.hide(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Else, we'll animate our FAB back in</span></div><div class="line">                child.show(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>fab#Behavior</code>è¿˜å®ç°äº†<code>onLayoutChild</code>,ä¸»è¦æ˜¯ä¸ºäº†æ ¹æ®AppBarLayoutçš„å½“å‰çŠ¶æ€æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦éœ€è¦éšè—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLayoutChild</span><span class="params">(CoordinatorLayout parent, FloatingActionButton child,</span></span></div><div class="line">               <span class="keyword">int</span> layoutDirection) &#123;</div><div class="line">           <span class="comment">// First, lets make sure that the visibility of the FAB is consistent</span></div><div class="line">           <span class="keyword">final</span> List&lt;View&gt; dependencies = parent.getDependencies(child);</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = dependencies.size(); i &lt; count; i++) &#123;</div><div class="line">               <span class="keyword">final</span> View dependency = dependencies.get(i);</div><div class="line">               <span class="keyword">if</span> (dependency <span class="keyword">instanceof</span> AppBarLayout</div><div class="line">                       &amp;&amp; updateFabVisibility(parent, (AppBarLayout) dependency, child)) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// Now let the CoordinatorLayout lay out the FAB</span></div><div class="line">           parent.onLayoutChild(child, layoutDirection);</div><div class="line">           <span class="comment">// Now offset it if needed</span></div><div class="line">           offsetIfNeeded(parent, child);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•ä¼šåœ¨<code>CoordinatorLayout</code>å¯¹å­©å­å¸ƒå±€çš„æ—¶å€™è¿›è¡Œè°ƒç”¨(å³<code>CoordinatorLayout#onLayout</code>)ï¼Œ<code>CoordinatorLayout</code>ä¼šæ£€æŸ¥æ‰€æœ‰çš„ç›´ç³»å­©å­ï¼Œæ˜¯å¦è®¾ç½®äº†Behaviorï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œå…¶<code>onLayoutChild</code>æ–¹æ³•:</p>
<p>CoordinatorLayout#onLayout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = ViewCompat.getLayoutDirection(<span class="keyword">this</span>);</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childCount = mDependencySortedChildren.size();</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">           <span class="keyword">final</span> View child = mDependencySortedChildren.get(i);</div><div class="line">           <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">           <span class="keyword">final</span> Behavior behavior = lp.getBehavior();</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (behavior == <span class="keyword">null</span> || !behavior.onLayoutChild(<span class="keyword">this</span>, child, layoutDirection)) &#123;</div><div class="line">               onLayoutChild(child, layoutDirection);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœè¯¥Behaviorå®ç°äº†OnLayoutChildï¼Œå¹¶ä¸”è¿”å›äº†trueï¼Œé‚£ä¹ˆå°†ä¸ä¼šæ‰§è¡Œ<code>CoordinatorLayout #onLayoutChild</code>,å¦åˆ™æ‰§è¡Œé»˜è®¤çš„å¸ƒå±€æ–¹æ¡ˆã€‚<br>æœ€åä¸€ç‚¹ï¼Œè¿™é‡Œçš„Behaviorå¦‚ä½•ç”Ÿæ•ˆçš„å‘¢ï¼Ÿé€šè¿‡æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CoordinatorLayout</span>.DefaultBehavior(FloatingActionButton.Behavior.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FloatingActionButton</span> <span class="keyword">extends</span> <span class="title">VisibilityAwareImageButton</span> </span>&#123;</div></pre></td></tr></table></figure>
<p><code>CoordinatorLayout</code>åœ¨è§£æå­©å­çš„<code>LayoutParams</code>æ—¶ï¼Œä¼šcheckæœ‰æ— æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function">LayoutParams <span class="title">getResolvedLayoutParams</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> LayoutParams result = (LayoutParams) child.getLayoutParams();</div><div class="line">      <span class="keyword">if</span> (!result.mBehaviorResolved) &#123;</div><div class="line">          Class&lt;?&gt; childClass = child.getClass();</div><div class="line">          DefaultBehavior defaultBehavior = <span class="keyword">null</span>;</div><div class="line">          <span class="keyword">while</span> (childClass != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                  (defaultBehavior = childClass.getAnnotation(DefaultBehavior.class)) == <span class="keyword">null</span>) &#123;</div><div class="line">              childClass = childClass.getSuperclass();</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (defaultBehavior != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  result.setBehavior(defaultBehavior.value().newInstance());</div><div class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                  Log.e(TAG, <span class="string">"Default behavior class "</span> + defaultBehavior.value().getName() +</div><div class="line">                          <span class="string">" could not be instantiated. Did you forget a default constructor?"</span>, e);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          result.mBehaviorResolved = <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤<code>fab</code>è§£æå®Œæ¯•ï¼Œè°¢è°¢è§‚çœ‹ï¼</p>
<p>å¦‚æœ‰ç–‘æƒ‘ï¼Œå¯ä»¥issueã€‚</p>
<p>å¾®åšï¼š<a href="http://weibo.com/u/2331178381?is_all=1" target="_blank" rel="external">æ¥šå¥•RX</a></p>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">The MIT License (MIT)</div><div class="line"></div><div class="line">Copyright (c) 2016 Rowandjj</div><div class="line"></div><div class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</div><div class="line">of this software and associated documentation files (the &quot;Software&quot;), to deal</div><div class="line">in the Software without restriction, including without limitation the rights</div><div class="line">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</div><div class="line">copies of the Software, and to permit persons to whom the Software is</div><div class="line">furnished to do so, subject to the following conditions:</div><div class="line"></div><div class="line">The above copyright notice and this permission notice shall be included in all</div><div class="line">copies or substantial portions of the Software.</div><div class="line"></div><div class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div class="line">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</div><div class="line">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</div><div class="line">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</div><div class="line">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</div><div class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</div><div class="line">SOFTWARE.</div></pre></td></tr></table></figure>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>CoordinatorLayoutæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/CoordinatorLayout%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/CoordinatorLayoutæºç åˆ†æ/</id>
    <published>2017-07-26T11:53:52.000Z</published>
    <updated>2017-07-26T11:54:43.516Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h1 id="CoordinatorLayout-æºç åˆ†æ"><a href="#CoordinatorLayout-æºç åˆ†æ" class="headerlink" title="CoordinatorLayout æºç åˆ†æ"></a>CoordinatorLayout æºç åˆ†æ</h1><p><code>CoordinatorLayout</code>æœ‰ä¸€äº›å¾ˆæœ‰æ„æ€çš„ç‰¹æ€§ï¼Œè®¾ç½®anchorã€NestedScrollé…åˆToolbar/TabLayoutçš„æ˜¾éšorä¼¸ç¼©ã€Fabçš„ç§»åŠ¨ç­‰ã€‚ä»Šå¤©å’±å°±æ¥ä¸€æ¢ç©¶ç«Ÿï¼</p>
<h2 id="1-ä»LayoutParamå¼€å§‹"><a href="#1-ä»LayoutParamå¼€å§‹" class="headerlink" title="1. ä»LayoutParamå¼€å§‹"></a>1. ä»LayoutParamå¼€å§‹</h2><p> <code>CoordinatorLayout.LayoutParam</code>ä¸­æœ‰ä¸€äº›ä¸å¤ªä¸€æ ·çš„å±æ€§å’Œå…ƒç´ ï¼Œåœ¨æ­¤å…ˆè¿›è¡Œä»‹ç»ã€‚</p>
<h3 id="1-1-ç‰¹æ®Šå±æ€§"><a href="#1-1-ç‰¹æ®Šå±æ€§" class="headerlink" title="1.1 ç‰¹æ®Šå±æ€§"></a>1.1 ç‰¹æ®Šå±æ€§</h3><table>
<thead>
<tr>
<th style="text-align:left">å±æ€§</th>
<th style="text-align:left">å¯¹åº”xmlå±æ€§</th>
<th style="text-align:left">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>AndchorId</code></td>
<td style="text-align:left"><code>layout_anchor</code> &amp;<code>layout_anchorGravity</code></td>
<td style="text-align:left">å¸ƒå±€æ—¶æ ¹æ®è‡ªèº«<code>gravity</code> ä¸ <code>layout_anchorGravity</code>æ”¾ç½®åœ¨è¢«anchorçš„Viewä¸­</td>
</tr>
<tr>
<td style="text-align:left"><code>Behavior</code></td>
<td style="text-align:left"><code>layout_behavior</code></td>
<td style="text-align:left">è¾…åŠ©Coordinatorå¯¹Viewè¿›è¡Œlayoutã€nestedScrollçš„å¤„ç†</td>
</tr>
<tr>
<td style="text-align:left"><code>KeyLine</code></td>
<td style="text-align:left"><code>layout_keyline</code> &amp; <code>keylines</code></td>
<td style="text-align:left">ç»™Coordinatorè®¾ç½®äº†<code>keylines</code>ï¼ˆæ•´æ•°æ•°ç»„ï¼‰åï¼Œå¯ä»¥ä¸ºå­Viewè®¾ç½®<code>layout_keyline=&quot;i&quot;</code>ä½¿å…¶çš„æ°´å¹³ä½ç½®æ ¹æ®å¯¹åº”<code>keylines[i]</code>è¿›è¡Œlayoutã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code>LastChildRect</code></td>
<td style="text-align:left">æ— </td>
<td style="text-align:left">è®°å½•æ¯ä¸€æ¬¡Layoutçš„ä½ç½®ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦æ–°çš„ä¸€å¸§æ”¹å˜äº†ä½ç½®</td>
</tr>
</tbody>
</table>
<p>æ³¨ï¼š</p>
<p><code>keyline</code>æ˜¯ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„å±æ€§ï¼Œæˆ‘åœ¨çœ‹æºç æ—¶æ‰ç¬¬ä¸€æ¬¡çœ‹åˆ°åˆ°è¿™ç©æ„ï¼Œç½‘ä¸Šçš„èµ„æ–™ä¹Ÿéå¸¸ä¹‹å°‘ã€‚åˆ†æä¸‹æ¥ï¼Œå°±æ˜¯å¦‚æœè®¾ç½®äº†keylineï¼Œé‚£ä¹ˆgravityå°±ä¼šè¢«æ— è§†ï¼Œç›´æ¥æ”¾ç½®åœ¨å¯¹åº”çš„æ°´å¹³ä½ç½®keylineä¸Šã€‚CoordinatorLayouté‡Œé¢ä¹Ÿæ²¡æœ‰å…¶ä»–çš„ç‰¹æ€§æ˜¯æ ¹æ®keylineå®ç°çš„ï¼Œä¸ªäººè®¤ä¸ºæ²¡åµç”¨ï¼Œæœ¬æ–‡å¯¹å®ƒçš„åˆ†æåŸºæœ¬éƒ½ä¼šç•¥è¿‡ã€‚</p>
<h3 id="1-2-ä¾èµ–å…³ç³»"><a href="#1-2-ä¾èµ–å…³ç³»" class="headerlink" title="1.2 ä¾èµ–å…³ç³»"></a>1.2 ä¾èµ–å…³ç³»</h3><p>å‡è®¾æ­¤æ—¶æœ‰ä¸¤ä¸ªView: <strong>A</strong> å’Œ<strong>B</strong>ï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ä¾èµ–å…³ç³»ï¼š</p>
<ul>
<li><strong>A</strong>çš„<code>anchor</code>æ˜¯<strong>B</strong> ï¼›</li>
<li><strong>A</strong>çš„<code>behavior</code>å¯¹<strong>B</strong>æœ‰ä¾èµ–ï¼ˆæ¯”å¦‚<code>FloatingActionButton</code>ä¾èµ–<code>SnackBar</code>)ã€‚</li>
</ul>
<p>ä¾èµ–å…³ç³»å»ºç«‹çš„å‰ææ˜¯ä¸¤ä¸ªViewåœ¨åŒä¸€ä¸ª<code>Coordinatorlayout</code>ä¸­ã€‚</p>
<p><code>CoordinatorLayout</code>ä¸­ç»´æŠ¤äº†ä¸€ä¸ª<code>mDependencySortedChildren</code>åˆ—è¡¨ï¼Œé‡Œé¢å«æœ‰æ‰€æœ‰çš„å­Viewï¼Œ<strong>æŒ‰ä¾èµ–å…³ç³»æ’åºï¼Œè¢«ä¾èµ–è€…æ’åœ¨å‰é¢</strong>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ç”¨æ¥æ’åºçš„<code>Comparator</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Comparator&lt;View&gt; mLayoutDependencyComparator = <span class="keyword">new</span> Comparator&lt;View&gt;() &#123;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(View lhs, View rhs)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (lhs == rhs) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((LayoutParams) lhs.getLayoutParams()).dependsOn(</div><div class="line">               CoordinatorLayout.<span class="keyword">this</span>, lhs, rhs)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((LayoutParams) rhs.getLayoutParams()).dependsOn(</div><div class="line">               CoordinatorLayout.<span class="keyword">this</span>, rhs, lhs)) &#123;</div><div class="line">           <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨å»ºç«‹<code>mDependencySortedChildren</code>å¹¶æ’åºå®Œæˆä¹‹åï¼ˆåœ¨measureçš„ç¬¬ä¸€æ­¥å¤„ç†å®Œæˆï¼‰ï¼Œæ¯æ¬¡å¯¹å­Viewçš„éå†<strong>éƒ½æ˜¯é€šè¿‡å®ƒè¿›è¡Œé¡ºåºéå†</strong>ï¼Œä¿è¯äº†è¢«ä¾èµ–çš„Viewæœ€å…ˆè¢«å¤„ç†ã€‚</p>
</blockquote>
<h3 id="1-3-Behavior"><a href="#1-3-Behavior" class="headerlink" title="1.3 Behavior"></a>1.3 Behavior</h3><p>åœ¨<code>CoordinatorLayout</code>ä¸­å®šä¹‰äº†<code>Behavior</code>ç±»ï¼Œå®ƒæ˜¯ç”¨æ¥è¾…åŠ©layoutçš„å·¥å…·ã€‚å¦‚æœä¸€ä¸ªCoordinatorLayoutçš„ç›´æ¥å­Viewè®¾ç½®äº†<code>Behavior</code>ï¼ˆæˆ–è€…é€šè¿‡ç±»æ³¨è§£<code>@DefaultBehavior</code>æŒ‡å®š<code>Behavior</code>ï¼‰ï¼Œåˆ™è¯¥Behaviorä¼šå‚¨å­˜åœ¨è¯¥Viewçš„<code>LayoutParam</code>ä¸­ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šä¸æ˜¯CoordinatorLayoutçš„ç›´æ¥å­Viewï¼Œè®¾ç½®Behavioræ˜¯æ— æ•ˆçš„ã€‚ä½ å¯ä»¥çœ‹åˆ°ä»»ä½•ä¸€å¤„å¯¹äºBehaviorçš„å¤„ç†éƒ½æ˜¯ç›´æ¥<code>getChildCountï¼ˆï¼‰</code>éå†ã€‚</p>
</blockquote>
<p>åœ¨Behaviorä¸­æœ‰å‡ ç±»åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸€ä¸€è¿›è¡Œä»‹ç»ï¼š</p>
<h4 id="1-3-1-è§¦æ‘¸å“åº”ç±»"><a href="#1-3-1-è§¦æ‘¸å“åº”ç±»" class="headerlink" title="1.3.1 è§¦æ‘¸å“åº”ç±»"></a>1.3.1 è§¦æ‘¸å“åº”ç±»</h4><p><code>Behavior</code>ä¸­æœ‰ä¸¤ä¸ªå‡½æ•°ï¼š<code>onInterceptTouchEvent</code>ã€ <code>onTouchEvent</code>ã€‚åœ¨CoordinatorLayoutæ¯æ¬¡è§¦å‘å¯¹åº”äº‹ä»¶çš„æ—¶å€™ä¼šé€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„å­Viewçš„Behavioræ‰§è¡Œå¯¹åº”å‡½æ•°ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹CoordinatorLayoutæ˜¯æ€ä¹ˆåˆ†å‘å’Œå¤„ç†Touchäº‹ä»¶çš„ï¼š</p>
<p><strong><em>intercept</em></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">   MotionEvent cancelEvent = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line"></div><div class="line">   <span class="comment">// é‡ç½®å“åº”çš„Behavoir</span></div><div class="line">   <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">       resetTouchBehaviors();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">	<span class="comment">// åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªæœ€ä½³Behaviorè¿›è¡Œå¤„ç†</span></div><div class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted = performIntercept(ev, TYPE_ON_INTERCEPT);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (cancelEvent != <span class="keyword">null</span>) &#123;</div><div class="line">       cancelEvent.recycle();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">	<span class="comment">// é‡ç½®å“åº”çš„Behavior</span></div><div class="line">   <span class="keyword">if</span> (action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">       resetTouchBehaviors();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> intercepted;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>performIntercept</code>å»é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„Behavioræ¥è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä»…ç”¨äº<code>onInterceptTouchEvent</code>ï¼Œå¹¶ä¸”ä¹Ÿç”¨äº<code>onTouchEvent</code>ï¼Œæ ¹æ®ä¼ å…¥<code>type</code>ä¸åŒæ¥è¯†åˆ«å¯¹åº”æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">performIntercept</span><span class="params">(MotionEvent ev, <span class="keyword">final</span> <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> intercepted = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">boolean</span> newBlock = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">   MotionEvent cancelEvent = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line"></div><div class="line">   <span class="keyword">final</span> List&lt;View&gt; topmostChildList = mTempList1;</div><div class="line"></div><div class="line">   <span class="comment">// API&gt;=21æ—¶ï¼Œä½¿ç”¨elevationç”±ä½åˆ°é«˜æ’åˆ—Viewï¼›API&lt;21æ—¶ï¼ŒæŒ‰Viewæ·»åŠ é¡ºåºæ’åˆ—</span></div><div class="line">   getTopSortedChildren(topmostChildList);</div><div class="line"></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childCount = topmostChildList.size();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i) &#123;</div><div class="line">       <span class="keyword">final</span> View child = topmostChildList.get(i);</div><div class="line">       <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">       <span class="keyword">final</span> Behavior b = lp.getBehavior();</div><div class="line"></div><div class="line">       <span class="comment">// ...(çœç•¥ä»£ç ) å¦‚æœæ­¤æ¬¡åˆ¤å®šinterceptï¼Œåˆ™å¯¹ä¸Šæ¬¡çš„Behaviorå‘é€CANCELäº‹ä»¶ã€‚</span></div><div class="line"></div><div class="line">		<span class="comment">// æ ¹æ®ä¼ å…¥typeä¸åŒè°ƒç”¨ä¸åŒçš„æ–¹æ³•</span></div><div class="line">       <span class="keyword">if</span> (!intercepted &amp;&amp; b != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">switch</span> (type) &#123;</div><div class="line">               <span class="keyword">case</span> TYPE_ON_INTERCEPT:</div><div class="line">                   intercepted = b.onInterceptTouchEvent(<span class="keyword">this</span>, child, ev);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> TYPE_ON_TOUCH:</div><div class="line">                   intercepted = b.onTouchEvent(<span class="keyword">this</span>, child, ev);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (intercepted) &#123;</div><div class="line">               mBehaviorTouchView = child;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">		<span class="comment">//...(çœç•¥ä»£ç ) å¦‚æœBehavior.blocksInteractionBelow()è¿”å›trueï¼Œåˆ™ä¸å¤„ç†åç»­çš„äº‹ä»¶ã€‚</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   topmostChildList.clear();</div><div class="line"></div><div class="line">   <span class="keyword">return</span> intercepted;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-2-ä¾èµ–å…³ç³»ç±»"><a href="#1-3-2-ä¾èµ–å…³ç³»ç±»" class="headerlink" title="1.3.2 ä¾èµ–å…³ç³»ç±»"></a>1.3.2 ä¾èµ–å…³ç³»ç±»</h4><p> è¿™éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå°±ä¿©å‡½æ•°ï¼š<br>   <code>layoutDependsOn</code>ï¼šè¿”å›<code>true</code>åˆ™è¡¨ç¤ºå¯¹å¦ä¸€ä¸ªViewæœ‰ä¾èµ–å…³ç³»ï¼›<br>   <code>onDependentViewChanged</code>&amp;<code>onDependentViewRemoved</code>ï¼šå¦‚æœè¢«ä¾èµ–çš„Viewåœ¨æ­£å¸¸layoutä¹‹åä»æœ‰size/positionä¸Šçš„å˜åŒ–ï¼Œæˆ–è€…è¢«removeæ‰ï¼Œéƒ½ä¼šè§¦å‘å¯¹åº”æ–¹æ³•ã€‚</p>
<p> é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒCoordinatorLayoutæ˜¯æ€ä¹ˆç›‘å¬è¿™ä¸ªè¢«ä¾èµ–çš„Viewæ”¹å˜çš„äº‹ä»¶çš„å‘¢ï¼Ÿ</p>
<p> åŸæ¥å®ƒé‡Œé¢æœ‰ä¸€ä¸ª<code>ViewTreeObserver.OnPreDrawListener</code>ï¼Œå®ƒåœ¨<code>onMeasure</code>çš„æ—¶å€™è¢«æ·»åŠ åˆ°äº†<code>ViewTreeObserver</code>ä¸­ï¼Œè¿™æ ·æ¯ä¸€å¸§è¢«ç»˜åˆ¶å‡ºæ¥ä¹‹å‰éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OnPreDrawListener</span> <span class="keyword">implements</span> <span class="title">ViewTreeObserver</span>.<span class="title">OnPreDrawListener</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">        dispatchOnDependentViewChanged(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> è¿™ä¸ª<code>dispatchOnDependentViewChanged</code>é‡Œé¢ä»£ç æ¯”è¾ƒå¤šï¼Œå°±ä¸æ”¾ä¸Šæ¥äº†ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯è¿™æ ·ï¼š</p>
<p> æ ¹æ®ä¾èµ–å…³ç³»éå†å­Viewï¼Œå¯¹æ¯ä¸€ä¸ªViewåšå¦‚ä¸‹æ“ä½œ</p>
<ul>
<li>åˆ¤æ–­ä¸€ä¸‹æ–°çš„å¸ƒå±€è¾¹ç•Œä¸lastChildRectæ˜¯å¦ç›¸åŒï¼Œæ˜¯åˆ™è®°å½•æ–°çš„å¸ƒå±€è¾¹ç•Œä¸ºlastChildRectï¼Œå¹¶ç»§ç»­åç»­æµç¨‹ï¼Œå¦åˆ™è·³è¿‡ï¼›</li>
<li><p>å¯¹äºä¹‹åæ¯ä¸€ä¸ªViewï¼Œå¦‚æœå®ƒä¾èµ–äºæœ¬Viewï¼Œåˆ™è°ƒç”¨å®ƒçš„<code>Behavior.onDependentViewChanged</code>ï¼ˆå¦‚æœæœ‰Behaviorçš„è¯ï¼‰ã€‚</p>
<p>è‡³äº<code>onDependentViewRemoved</code>ï¼Œæ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šè°ƒç”¨<code>ViewGroup.setOnHierarchyChangeListener()</code>æ–¹æ³•è®¾ç½®ä¸€ä¸ª<code>OnHierarchyChangeListener</code>ï¼Œè¿™æ ·æ¯æ¬¡addå’Œremoveå­Viewçš„æ—¶å€™å°±ä¼šæ¥æ”¶åˆ°å›è°ƒï¼ŒåŒæ—¶å¯¹ç›¸åº”ä¾èµ–å…³ç³»çš„Viewè¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ul>
<h4 id="1-3-3-å¸ƒå±€ç±»"><a href="#1-3-3-å¸ƒå±€ç±»" class="headerlink" title="1.3.3 å¸ƒå±€ç±»"></a>1.3.3 å¸ƒå±€ç±»</h4><p><code>onMeasureChild</code>&amp;<code>onLayoutChild</code>ï¼šå¦‚æœé‡å†™äº†è¯¥æ–¹æ³•å¹¶è¿”å›<code>true</code>ï¼Œåˆ™CoordinatorLayoutä¼šä½¿ç”¨Behaviorå¯¹è¿™ä¸ªå­Viewè¿›è¡Œmeasure/layoutã€‚å…·ä½“çš„å¯ä»¥è§ä¸‹é¢çš„<strong>Measure&amp;Layout</strong></p>
<h4 id="1-3-4-åµŒå¥—æ»‘åŠ¨ç±»"><a href="#1-3-4-åµŒå¥—æ»‘åŠ¨ç±»" class="headerlink" title="1.3.4 åµŒå¥—æ»‘åŠ¨ç±»"></a>1.3.4 åµŒå¥—æ»‘åŠ¨ç±»</h4><p>CoordinatorLayoutå®ç°äº†<code>NestedScrollingParent</code>ï¼Œå½“CoordinatorLayoutå†…æœ‰ä¸€ä¸ªæ”¯æŒNestedScrollçš„å­Viewæ—¶ï¼Œå®ƒçš„åµŒå¥—æ»‘åŠ¨äº‹ä»¶é€šè¿‡<code>NestedScrollingParent</code>çš„å›è°ƒåˆ†å‘åˆ°å„ç›´æ¥å­Viewçš„Behaviorå¤„ç†ã€‚è™½ç„¶<code>Behavior</code>ç±»æ²¡æœ‰å®ç°<code>NestedScrollingParent</code>ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒçš„æ–¹æ³•éƒ½æœ‰ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬è¿™é‡Œé‡ç‚¹è®²CoordinatorLayoutçš„åˆ†å‘è¿‡ç¨‹ã€‚</p>
<p> å„ä¸ªäº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹ç±»ä¼¼ï¼Œæ­¤å¤„å°±ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartNestedScroll</span><span class="params">(View child, View target, <span class="keyword">int</span> nestedScrollAxes)</span> </span>&#123;</div><div class="line">     <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i) &#123;</div><div class="line">         <span class="keyword">final</span> View view = getChildAt(i);</div><div class="line">         <span class="keyword">final</span> LayoutParams lp = (LayoutParams) view.getLayoutParams();</div><div class="line">         <span class="keyword">final</span> Behavior viewBehavior = lp.getBehavior();</div><div class="line">         <span class="keyword">if</span> (viewBehavior != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">final</span> <span class="keyword">boolean</span> accepted = viewBehavior.onStartNestedScroll(<span class="keyword">this</span>, view, child, target,</div><div class="line">                     nestedScrollAxes);</div><div class="line">             handled |= accepted;</div><div class="line"></div><div class="line">             lp.acceptNestedScroll(accepted);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             lp.acceptNestedScroll(<span class="keyword">false</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éå¸¸ç®€å•å§ï¼Œå°±éå†ä¸€ä¸‹ç›´æ¥å­Viewï¼Œæ¯ä¸ªéƒ½è°ƒä¸€ä¸‹å¯¹åº”çš„å›è°ƒæ–¹æ³•ï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå­Viewçš„behavioræ¶ˆè€—äº†è¿™ä¸ªäº‹ä»¶ï¼Œå°±ç®—æ¶ˆè€—äº†è¿™ä¸ªäº‹ä»¶ã€‚</p>
<p>##2. Measure&amp;Layout</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒViewGroupè¦æŠŠå­Viewå‡†ç¡®åœ°æ”¾ç½®åˆ°å±å¹•ä¸Šéƒ½æ˜¯è¦èµ°<code>onMeasure</code>  <code>onLayout</code>çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹<code>CoordinatorLayout</code>åœ¨è¿™é‡Œå¹²äº†ä»€ä¹ˆã€‚</p>
<p>åœ¨çœ‹æ‡‚æ—¶è¯·ç¡®ä¿ä½ æ˜ç™½<code>measure/layout</code>çš„æ„ä¹‰ä»¥åŠåŸºæœ¬ç”¨æ³•ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´èº«ä½“ä¸é€‚=ã€‚=</p>
<h3 id="2-1-Measure"><a href="#2-1-Measure" class="headerlink" title="2.1 Measure"></a>2.1 Measure</h3><p>æœ€ç›´æ¥çš„å°±æ˜¯çœ‹ä»£ç ï¼Œå¦‚æœä¸å–œæ¬¢ï¼Œå¯ä»¥è·³è¿‡ä»£ç çœ‹æ€»ç»“ã€‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">   prepareChildren(); <span class="comment">/* è§£æä¾èµ–å…³ç³»ï¼Œå¹¶ç”¨1.2ä¸­æåˆ°çš„Comparatorå¯¹ViewæŒ‰ä¾èµ–å…³ç³»è¿›è¡Œæ’åº */</span></div><div class="line">   ensurePreDrawListener(); <span class="comment">/* è‹¥PreDrawListeneræœªæ·»åŠ ï¼Œåˆ™æ·»åŠ åˆ°ViewTreeObserver */</span></div><div class="line"></div><div class="line">   <span class="comment">//...(çœç•¥ä»£ç ) è§£æpaddingmeasureSpec</span></div><div class="line"></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childCount = mDependencySortedChildren.size();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i) &#123;</div><div class="line">       <span class="keyword">final</span> View child = mDependencySortedChildren.get(i);</div><div class="line">       <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">		<span class="comment">//...(çœç•¥ä»£ç )å¤„ç†keyline</span></div><div class="line"></div><div class="line">       <span class="keyword">int</span> childWidthMeasureSpec = widthMeasureSpec;</div><div class="line">       <span class="keyword">int</span> childHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">		<span class="comment">//...(çœç•¥ä»£ç ) å¤„ç†ç”±äºfitSystemWindowså¸¦æ¥çš„padding</span></div><div class="line"></div><div class="line">		<span class="comment">/* å¦‚æœchildViewæœ‰Behaviorå¹¶ä¸”å®ƒçš„onMeasureChildè¿”å›trueï¼Œåˆ™ç”±behavioræ¥å¯¹childViewè¿›è¡Œmeasureï¼Œå¦åˆ™å°±è‡ªå·±measure. */</span></div><div class="line">       <span class="keyword">final</span> Behavior b = lp.getBehavior();</div><div class="line">       <span class="keyword">if</span> (b == <span class="keyword">null</span> || !b.onMeasureChild(<span class="keyword">this</span>, child, childWidthMeasureSpec, keylineWidthUsed,</div><div class="line">               childHeightMeasureSpec, <span class="number">0</span>)) &#123;</div><div class="line">           onMeasureChild(child, childWidthMeasureSpec, keylineWidthUsed,</div><div class="line">                   childHeightMeasureSpec, <span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">		<span class="comment">/* å–æœ€å¤§çš„child width/height åŠ ä¸Šmargin ä½œä¸ºå·²ç»æ¶ˆè€—çš„å°ºå¯¸ã€‚ */</span></div><div class="line">       widthUsed = Math.max(widthUsed, widthPadding  child.getMeasuredWidth()</div><div class="line">               lp.leftMargin  lp.rightMargin);</div><div class="line">       heightUsed = Math.max(heightUsed, heightPadding  child.getMeasuredHeight()</div><div class="line">               lp.topMargin  lp.bottomMargin);</div><div class="line"></div><div class="line">       childState = ViewCompat.combineMeasuredStates(childState,</div><div class="line">               ViewCompat.getMeasuredState(child));</div><div class="line">   &#125;</div><div class="line"></div><div class="line">	<span class="comment">/* è®¾ç½®è‡ªèº«çš„measureå°ºå¯¸ */</span></div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> width = ViewCompat.resolveSizeAndState(widthUsed, widthMeasureSpec,</div><div class="line">           childState &amp; ViewCompat.MEASURED_STATE_MASK);</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> height = ViewCompat.resolveSizeAndState(heightUsed, heightMeasureSpec,</div><div class="line">           childState &lt;&lt; ViewCompat.MEASURED_HEIGHT_STATE_SHIFT);</div><div class="line">   setMeasuredDimension(width, height);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸‹æ¥ï¼ŒonMeasureå¹²äº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p>
<ol>
<li>æ ¹æ®ä¾èµ–å…³ç³»å¯¹æ‰€æœ‰å­Viewè¿›è¡Œæ’åº</li>
<li>ä¿è¯OnPreDrawListenerè¢«æ·»åŠ </li>
<li>æŒ‰ä¾èµ–å…³ç³»éå†å­View:<ul>
<li>å¦‚æœå­Viewæœ‰Behaviorï¼Œå¹¶ä¸”å®ƒçš„<code>onMeasureChild</code>è¿”å›trueï¼Œåˆ™ä½¿ç”¨Behaviorè¿›è¡Œmeasureï¼›å¦åˆ™ç›´æ¥ä½¿ç”¨measureSpecå¯¹å­Viewè¿›è¡Œmeasureï¼›</li>
<li>å–å­VIewæœ€å¤§çš„measureå°ºå¯¸ä¸ºå·²ä½¿ç”¨çš„measureå°ºå¯¸ã€‚</li>
</ul>
</li>
<li>æ›´æ–°æœ¬èº«çš„Measureå°ºå¯¸ã€‚</li>
</ol>
<h3 id="2-2-Layout"><a href="#2-2-Layout" class="headerlink" title="2.2 Layout"></a>2.2 Layout</h3><p> åœ¨<code>onLayout</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>CoordinatorLayout</code>ä¼šå¯¹æ¯ä¸€ä¸ªå­Viewä¾ç…§ä»¥ä¸‹åˆ¤æ–­é¡ºåºè¿›è¡Œlayoutï¼š</p>
<ol>
<li>å¦‚æœå­Viewè®¾ç½®äº†<code>Behavior</code>ï¼Œå¹¶ä¸”è¯¥<code>Behavior</code>çš„<code>behavior.onLayoutChild</code>è¿”å›<code>true</code>ï¼Œåˆ™ä½¿ç”¨<code>behavior.onLayoutChild</code>å¯¹è¯¥å­Viewè¿›è¡Œlayoutï¼›</li>
<li><p>å¦‚æœBehaviorä¸è¿›è¡Œlayoutï¼Œåˆ™è¿›å…¥è‡ªèº«çš„<code>onLayoutChild()</code>ï¼Œå†…éƒ¨ä¾æ¬¡è¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<ul>
<li>å¦‚æœå­Viewè®¾ç½®äº†<code>Anchor</code>ï¼Œåˆ™è°ƒç”¨<code>layoutChildWithAnchor</code>ï¼ˆæ ¹æ®anchorè¿›è¡Œlayoutï¼‰ï¼›</li>
<li>å¦‚æœå­Viewå«æœ‰<code>keyline</code>ï¼Œåˆ™è°ƒç”¨<code>layoutChildWithKeyline</code>ï¼ˆæ ¹æ®keylineè¿›è¡Œlayoutï¼‰ï¼›</li>
<li>å¦‚æœä»¥ä¸Šåˆ¤æ–­éƒ½ä¸ç¬¦åˆï¼Œåˆ™ç›´æ¥å°†Viewæ ¹æ®<strong>padding/margin/measureç»“æœ</strong>æŒ‰ç…§<code>Gravity</code>æ”¾ç½®ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ä¸€ä¸‹è¿™äº›è¿‡ç¨‹ã€‚</p>
</li>
</ol>
<h4 id="2-2-1-ä½¿ç”¨Behaviorè¿›è¡Œlayout"><a href="#2-2-1-ä½¿ç”¨Behaviorè¿›è¡Œlayout" class="headerlink" title="2.2.1 ä½¿ç”¨Behaviorè¿›è¡Œlayout"></a>2.2.1 ä½¿ç”¨Behaviorè¿›è¡Œlayout</h4><p> é»˜è®¤çš„Behaviorçš„<code>onLayoutChild</code>éƒ½æ˜¯è¿”å›<code>false</code>çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹<code>FloatingActionButton</code>çš„é»˜è®¤Behavioræ˜¯æ€ä¹ˆå¤„ç†çš„å§ï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLayoutChild</span><span class="params">(CoordinatorLayout parent, FloatingActionButton child,</span></span></div><div class="line">        <span class="keyword">int</span> layoutDirection) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// æ£€æŸ¥è¯¥FABæ˜¯å¦ä¾èµ–AppBarLayout</span></div><div class="line">    <span class="keyword">final</span> List&lt;View&gt; dependencies = parent.getDependencies(child);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = dependencies.size(); i &lt; count; i) &#123;</div><div class="line">        <span class="keyword">final</span> View dependency = dependencies.get(i);</div><div class="line">        <span class="keyword">if</span> (dependency <span class="keyword">instanceof</span> AppBarLayout</div><div class="line">                &amp;&amp; updateFabVisibility(parent, (AppBarLayout) dependency, child)) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// è°ƒç”¨CoordinatorLayoutçš„onLayoutChildå¯¹FABè¿›è¡Œlayout</span></div><div class="line">    parent.onLayoutChild(child, layoutDirection);</div><div class="line">    <span class="comment">// åœ¨API &lt; 21æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨offsetæ¥è®©å‡ºé˜´å½±çš„ä½ç½®</span></div><div class="line">    offsetIfNeeded(parent, child);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦æ˜¯å¤„ç†äº†å¦‚æœFABè®¾ç½®äº†<code>AppBarLayout</code>ä¸ºanchoræ—¶ï¼ˆæ­¤æ—¶ä¼šå¯¹<code>AppBarLayout</code>æœ‰ä¾èµ–ï¼‰ï¼Œåˆ™å½“<code>AppBarLayout</code>çš„é«˜åº¦ä¸è¶³ä»¥æ˜¾ç¤ºFABæ—¶å°†å…¶éšè—ï¼‰ã€‚</p>
<p>ä¹‹åå®ƒä¼šæ‰‹åŠ¨è°ƒç”¨CoordinatorLayoutè‡ªèº«çš„<code>onLayoutChild</code>æ–¹æ³•è¿›è¡Œlayoutï¼Œå³ä¸Šè¿°åˆ¤æ–­çš„ç¬¬äºŒæ­¥ï¼Œé‚£æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<h4 id="2-2-2-ä½¿ç”¨Anchorè¿›è¡Œlayout"><a href="#2-2-2-ä½¿ç”¨Anchorè¿›è¡Œlayout" class="headerlink" title="2.2.2 ä½¿ç”¨Anchorè¿›è¡Œlayout"></a>2.2.2 ä½¿ç”¨Anchorè¿›è¡Œlayout</h4><p> å¦‚æœViewè®¾ç½®äº†anchorï¼Œé‚£ä¹ˆéƒ½ä¼šè°ƒç”¨<code>layoutWithAnchor</code>è¿›è¡Œlayoutï¼Œä»£ç ä¸è§£é‡Šå¦‚ä¸‹ï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">layoutChildWithAnchor</span><span class="params">(View child, View anchor, <span class="keyword">int</span> layoutDirection)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Rect anchorRect = mTempRect1;</div><div class="line">    <span class="keyword">final</span> Rect childRect = mTempRect2;</div><div class="line"></div><div class="line">    <span class="comment">/* 1. æ‰¾åˆ°è¢«anchorçš„Viewçš„å¸ƒå±€è¾¹ç•Œ */</span></div><div class="line">    getDescendantRect(anchor, anchorRect);</div><div class="line"></div><div class="line">    <span class="comment">/* 2. è·å–åˆ°è¢«anchorçš„Viewå¸ƒå±€è¾¹ç•Œä¹‹åï¼Œé…åˆlayout_anchorGravityä¸è‡ªèº«çš„gravityè·å–åˆ°æœ€ç»ˆè¦layoutåˆ°çš„è¾¹ç•Œ */</span></div><div class="line">    getDesiredAnchoredChildRect(child, layoutDirection, anchorRect, childRect);</div><div class="line">    child.layout(childRect.left, childRect.top, childRect.right, childRect.bottom);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨åˆ°çš„ä¸¤ä¸ªå…³é”®å‡½æ•°å°±æ˜¯<code>getDescendantRect</code>ä¸<code>getDesiredAnchoredChildRect</code>ï¼Œå®ƒä»¬çš„ç›®çš„åœ¨æˆ‘æ·»åŠ çš„æ³¨é‡Šä¸­è¿›è¡Œäº†è§£é‡Šï¼Œä¸ºä¿è¯æ–‡ç« çš„å¯è¯»æ€§å°±ä¸å†æŠŠä»£ç æ”¾ä¸Šæ¥äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å†è‡ªå·±å»æŒ–æ˜ç›¸åº”ä»£ç ~~</p>
<h4 id="2-2-3-ç›´æ¥layout"><a href="#2-2-3-ç›´æ¥layout" class="headerlink" title="2.2.3 ç›´æ¥layout"></a>2.2.3 ç›´æ¥layout</h4><p>å¦‚æœä¹‹å‰çš„éƒ½ä¸ç¬¦åˆï¼Œå°±ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆlayoutçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">layoutChild</span><span class="params">(View child, <span class="keyword">int</span> layoutDirection)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">      <span class="keyword">final</span> Rect parent = mTempRect1;</div><div class="line">      parent.set(getPaddingLeft()  lp.leftMargin,</div><div class="line">              getPaddingTop()  lp.topMargin,</div><div class="line">              getWidth() - getPaddingRight() - lp.rightMargin,</div><div class="line">              getHeight() - getPaddingBottom() - lp.bottomMargin);</div><div class="line"></div><div class="line">      <span class="comment">//...(çœç•¥ä»£ç ) å¤„ç†ç”±äºfitsSystemWindowså¸¦æ¥çš„inset</span></div><div class="line"></div><div class="line"> 	 <span class="comment">// æŒ‰ç…§Gravityä¸measureå°ºå¯¸åœ¨çˆ¶æ§ä»¶é‡Œé¢æ‰¾åˆ°è‡ªå·±çš„ä½ç½®ï¼Œå¹¶è¿›è¡Œlayoutã€‚</span></div><div class="line">      <span class="keyword">final</span> Rect out = mTempRect2;</div><div class="line">      GravityCompat.apply(resolveGravity(lp.gravity), child.getMeasuredWidth(),</div><div class="line">              child.getMeasuredHeight(), parent, out, layoutDirection);</div><div class="line">      child.layout(out.left, out.top, out.right, out.bottom);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>##3 æ€»ç»“</p>
<p>CoordinatorLayoutçš„ç‰¹æ€§æ€»ç»“ä¸‹æ¥å°±æ˜¯ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li>å¯ä»¥è®¾ç½®anchorï¼Œè¢«ä¾èµ–çš„Viewå˜åŒ–è‡ªèº«ä¹Ÿä¼šå˜åŒ–ï¼›</li>
<li>å¯ä»¥è®¾ç½®behaviorï¼Œå½“å†…éƒ¨æœ‰æ”¯æŒåµŒå¥—æ»‘åŠ¨çš„æ§ä»¶æ—¶å¤„ç†NestedScrolläº‹ä»¶ï¼›</li>
</ol>
<p>è¿™ä¸¤ä¸ªç‰¹æ€§å¯¼è‡´çš„å­Viewä¹‹é—´çš„ä¾èµ–å…³ç³»è®©ç•Œé¢çš„äº¤äº’æ›´æœ‰æ„æ€ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å†å»çœ‹<code>AppBarLayout</code>ã€<code>FloatingActionButton</code>ã€<code>SnackBar</code>çš„æºç ~~</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>CompoundButtonæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/CompoundButton%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/CompoundButtonæºç åˆ†æ/</id>
    <published>2017-07-26T11:52:49.000Z</published>
    <updated>2017-07-26T11:53:12.246Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<p>CompoundButton æ˜¯ä¸€ä¸ªæœ‰ä¸¤ç§çŠ¶æ€ï¼ˆé€‰ä¸­å’Œæœªé€‰ä¸­ / checkd uncheckedï¼‰çš„Buttonã€‚å½“ä½ æŒ‰ä¸‹ï¼ˆpressedï¼‰æˆ–è€…ç‚¹å‡»ï¼ˆclickedï¼‰ï¼Œå®ƒçš„çŠ¶æ€ä¼šè‡ªåŠ¨æ”¹å˜ã€‚</p>
<h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ul>
<li>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ˆabstractï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨å®ƒï¼Œåªæœ‰è‡ªå®šä¹‰å®ç°æˆ–è€…ç³»ç»Ÿå·²ç»æä¾›çš„å®ƒçš„ä¸€ç›´å­ç±»ï¼ˆToggleButtonï¼ŒCheckboxï¼ŒRadioButton ç­‰ç­‰ï¼‰</li>
<li>ç»§æ‰¿è‡ªButtonï¼Œè€ŒButton ç»§æ‰¿è‡ªTextViewï¼Œæ‰€ä»¥Buttonï¼ŒTextView çš„ç‰¹æ€§CompoundButton éƒ½æ˜¯å…·å¤‡çš„</li>
<li>å®ç°è‡ªCheckable æ¥å£ï¼ˆinterfaceï¼‰ï¼Œåˆ©ç”¨å®ƒå¯ä»¥è®¾ç½®çŠ¶æ€ï¼ˆsetChecked(boolean checked)ï¼‰ï¼Œè·å–çŠ¶æ€ï¼ˆisChecked()ï¼‰å’Œåˆ‡æ¢çŠ¶æ€ï¼ˆtoggle()ï¼‰</li>
</ul>
<p>æœ€åçš„æ•ˆæœå›¾å°±æ˜¯è¿™æ ·çš„ã€‚</p>
<p><img src="http://ww2.sinaimg.cn/large/68622377gw1f36nyso3hsg20c0034dfy.gif" alt=""></p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é€‰ä¸­å’Œæœªé€‰ä¸­çš„çŠ¶æ€</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mChecked;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mBroadcasting;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Drawable mButtonDrawable;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ColorStateList mButtonTintList = <span class="keyword">null</span>;</div><div class="line"><span class="comment">// å°±æ˜¯æ°´æ³¢çº¹å’ŒèƒŒæ™¯é¢œè‰²æ··åˆçš„æ–¹å¼</span></div><div class="line"><span class="keyword">private</span> PorterDuff.Mode mButtonTintMode = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mHasButtonTint = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mHasButtonTintMode = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">// çŠ¶æ€ç›‘å¬</span></div><div class="line"><span class="keyword">private</span> OnCheckedChangeListener mOnCheckedChangeListener;</div><div class="line"><span class="keyword">private</span> OnCheckedChangeListener mOnCheckedChangeWidgetListener;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€äº›å±€éƒ¨å˜é‡ï¼Œåœ¨åé¢çš„åˆ†æä¼šç”¨åˆ°ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹CompoundButton è‡ªå®šä¹‰æ§ä»¶æœ‰å“ªäº›å±æ€§</p>
<p><strong>\data\res\values\attrs.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"CompoundButton"</span>&gt;</span></div><div class="line">     <span class="comment">&lt;!-- è®¾ç½®çŠ¶æ€  true: é€‰ä¸­; false: æœªé€‰ä¸­ --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"checked"</span> <span class="attr">format</span>=<span class="string">"boolean"</span> /&gt;</span></div><div class="line">     <span class="comment">&lt;!-- ç»˜åˆ¶æŒ‰é’®å›¾å½¢ï¼Œä¸€èˆ¬ä¸ºDrawable èµ„æº (e.g. checkbox, radio button, etc). --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"button"</span> <span class="attr">format</span>=<span class="string">"reference"</span> /&gt;</span></div><div class="line">     <span class="comment">&lt;!-- å¯¹ç»˜åˆ¶çš„æŒ‰é’®å›¾å½¢ç€è‰² --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"buttonTint"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">     <span class="comment">&lt;!-- å¯¹ç€è‰²è®¾ç½®æ¨¡å¼ --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"buttonTintMode"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"src_over"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></div><div class="line">         ...</div><div class="line">     <span class="tag">&lt;/<span class="name">attr</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ç„¶åå†æ¥çœ‹çœ‹æ€ä¹ˆç»˜åˆ¶ï¼Œå…ˆæ¥çœ‹çœ‹æ„é€ æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CompoundButton</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</div><div class="line"></div><div class="line">    <span class="comment">// è¿™é‡Œçš„è·å–è‡ªå®šä¹‰çš„CompoundButton å°±æ˜¯ä¸Šé¢çš„å®šä¹‰çš„CompoundButton</span></div><div class="line">    <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(</div><div class="line">            attrs, com.android.internal.R.styleable.CompoundButton, defStyleAttr, defStyleRes);</div><div class="line"></div><div class="line">    <span class="comment">// ç”¨äºç»˜åˆ¶æŒ‰é’®å›¾å½¢</span></div><div class="line">    <span class="keyword">final</span> Drawable d = a.getDrawable(com.android.internal.R.styleable.CompoundButton_button);</div><div class="line">    <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</div><div class="line">        setButtonDrawable(d);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å¯¹ç»˜åˆ¶çš„æŒ‰é’®å›¾å½¢ç€è‰²è®¾ç½®æ¨¡å¼</span></div><div class="line">    <span class="keyword">if</span> (a.hasValue(R.styleable.CompoundButton_buttonTintMode)) &#123;</div><div class="line">        mButtonTintMode = Drawable.parseTintMode(a.getInt(</div><div class="line">                R.styleable.CompoundButton_buttonTintMode, -<span class="number">1</span>), mButtonTintMode);</div><div class="line">        mHasButtonTintMode = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å¯¹ç»˜åˆ¶çš„æŒ‰é’®å›¾å½¢ç€è‰²</span></div><div class="line">    <span class="keyword">if</span> (a.hasValue(R.styleable.CompoundButton_buttonTint)) &#123;</div><div class="line">        mButtonTintList = a.getColorStateList(R.styleable.CompoundButton_buttonTint);</div><div class="line">        mHasButtonTint = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// è®¾ç½®çŠ¶æ€</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> checked = a.getBoolean(</div><div class="line">            com.android.internal.R.styleable.CompoundButton_checked, <span class="keyword">false</span>);</div><div class="line">    setChecked(checked);</div><div class="line"></div><div class="line">    a.<span class="function">re <span class="title">cycle</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    applyButtonTint();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œè·å–è‡ªå®šä¹‰å±æ€§çš„å„ä¸ªå±æ€§ï¼Œ</p>
<ul>
<li>buttonï¼šç”¨äºç»˜åˆ¶æŒ‰é’®å›¾å½¢ï¼Œç„¶åè°ƒç”¨setButtonDrawable() æ¥ç»˜åˆ¶ã€‚</li>
<li>buttonTintï¼šç»˜åˆ¶çš„æŒ‰é’®ç€è‰²ã€‚ä½¿ç”¨ä¸€ä¸ªboolean æ ‡è¯†ç¬¦æ¥è®¾ç½®çš„ï¼Œç„¶åä¼šåœ¨applyButtonTint() ä¸­ç»Ÿä¸€å¤„ç†ã€‚å®ƒä»¬ä¸¤ä¸ªåˆ†åˆ«ç”¨ä½œç»™å’Œ</li>
<li>buttonTintModeï¼šå’Œè®¾ç½®ç€è‰²æ¨¡å¼ã€‚è®¾ç½®æ–¹å¼å’ŒbuttonTint å‡ ä¹ä¸€æ ·ã€‚ä¸è¿‡å®ƒçš„ä¸€äº›å±æ€§ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« æ¥çœ‹çœ‹å…·ä½“ä¸åŒçš„ç€è‰²æ¨¡å¼æ•ˆæœæ˜¯æ€ä¹ˆæ ·çš„ã€‚<a href="http://www.cnblogs.com/fuly550871915/p/5002759.html" target="_blank" rel="external">android5.xæ–°ç‰¹æ€§ä¹‹Tinting</a></li>
<li>checkedï¼šæ˜¯è®¾ç½®é€‰ä¸­çŠ¶æ€ï¼Œåœ¨setChecked() ä¸­è®¾ç½®ã€‚</li>
</ul>
<h2 id="ç»˜åˆ¶æŒ‰é’®å›¾å½¢"><a href="#ç»˜åˆ¶æŒ‰é’®å›¾å½¢" class="headerlink" title="ç»˜åˆ¶æŒ‰é’®å›¾å½¢"></a>ç»˜åˆ¶æŒ‰é’®å›¾å½¢</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setButtonDrawable</span><span class="params">(@Nullable Drawable drawable)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mButtonDrawable != drawable) &#123;</div><div class="line">        <span class="keyword">if</span> (mButtonDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// å–æ¶ˆå¯¹View çš„å¼•ç”¨</span></div><div class="line">            mButtonDrawable.setCallback(<span class="keyword">null</span>);</div><div class="line">            <span class="comment">// å–æ¶ˆç»˜åˆ¶å¯¹è±¡ç›¸å…³è”çš„è°ƒåº¦,å½“æˆ‘ä»¬é‡æ–°ç»˜åˆ¶ä¸€ä¸ªDrawableï¼Œå¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•</span></div><div class="line">            unscheduleDrawable(mButtonDrawable);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mButtonDrawable = drawable;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">            drawable.setCallback(<span class="keyword">this</span>);</div><div class="line">            drawable.setLayoutDirection(getLayoutDirection());</div><div class="line">            <span class="keyword">if</span> (drawable.isStateful()) &#123;</div><div class="line">                drawable.setState(getDrawableState());</div><div class="line">            &#125;</div><div class="line">            drawable.setVisible(getVisibility() == VISIBLE, <span class="keyword">false</span>);</div><div class="line">            setMinHeight(drawable.getIntrinsicHeight());</div><div class="line">            applyButtonTint();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨äºç»˜åˆ¶æŒ‰é’®å›¾å½¢ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æˆ‘ä»¬è®¾ç½®çš„Drawable å’Œåˆå§‹ä¼šçš„mButtonDrawable æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç­‰ï¼Œå°†ä¼šå¯¹åˆå§‹åŒ–çš„mButtonDrawable å¯¹è±¡ï¼Œå–æ¶ˆå¯¹View çš„å¼•ç”¨ï¼ˆsetCallback(null)ï¼‰ï¼Œå¹¶ä¸”å–æ¶ˆmButtonDrawable ç›¸å…³è”è°ƒåº¦ï¼ˆunscheduleDrawable()ï¼‰ï¼Œç„¶åå°†æˆ‘ä»¬æ–°è®¾ç½®çš„Drawable èµ‹å€¼ç»™mButtonDrawable å¯¹è±¡ï¼Œç„¶åå†è®¾ç½®å¼•ç”¨ï¼Œè®¾ç½®å¸ƒå±€çš„æ–¹å‘ï¼Œç„¶ååˆ¤æ–­å¦‚æœçŠ¶æ€æ”¹å˜æ—¶ï¼Œé‡æ–°è®¾ç½®çŠ¶æ€ã€‚æœ€åè°ƒç”¨applyButtonTint()ã€‚</p>
<h2 id="ç€è‰²"><a href="#ç€è‰²" class="headerlink" title="ç€è‰²"></a>ç€è‰²</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyButtonTint</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mButtonDrawable != <span class="keyword">null</span> &amp;&amp; (mHasButtonTint || mHasButtonTintMode)) &#123;</div><div class="line">        mButtonDrawable = mButtonDrawable.mutate();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mHasButtonTint) &#123;</div><div class="line">            mButtonDrawable.setTintList(mButtonTintList);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mHasButtonTintMode) &#123;</div><div class="line">            mButtonDrawable.setTintMode(mButtonTintMode);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// The drawable (or one of its children) may not have been</span></div><div class="line">        <span class="comment">// stateful before applying the tint, so let's try again.</span></div><div class="line">        <span class="keyword">if</span> (mButtonDrawable.isStateful()) &#123;</div><div class="line">            mButtonDrawable.setState(getDrawableState());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯è®¾ç½®mButtonDrawable çš„Tintï¼ˆç€è‰²ï¼‰å’ŒTintModeï¼ˆç€è‰²æ¨¡å¼ï¼‰ï¼Œä¹‹å‰åœ¨æ„é€ æ–¹æ³•ï¼ŒsetButtonDrawable() æ–¹æ³•ä¸­éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå±æ€§éƒ½æ˜¯åŸºäºmButtonDrawable æ¥è®¾ç½®çš„ï¼Œè€Œè¿™ä¸ªä¸¤ä¸ªå±æ€§æ˜¯æ ¹æ®ä¸¤ä¸ªBoolean å±æ€§mHasButtonTint å’ŒmHasButtonTintMode æ¥è¯†åˆ«çš„ï¼Œç„¶åä¸ºtrueï¼Œå°±è¡¨ç¤ºè®¾ç½®ã€‚è€Œä»–ä»¬ä¸¤ä¸ªå±æ€§ä¹Ÿæœ‰setButtonTintList å’ŒsetButtonTintMode() æ–¹æ³•æ¥è®¾ç½®ä¸¤ä¸ªå±æ€§ï¼Œå°†ä¸¤ä¸ªboolean å±æ€§è®¾ç½®ä¸ºtrueï¼Œå¹¶ä¸”è°ƒç”¨applyButtonTint() æ¥è®¾ç½®çš„ã€‚</p>
<h2 id="ç»˜åˆ¶"><a href="#ç»˜åˆ¶" class="headerlink" title="ç»˜åˆ¶"></a><strong>ç»˜åˆ¶</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Drawable buttonDrawable = mButtonDrawable;</div><div class="line">    <span class="keyword">if</span> (buttonDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = getGravity() &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> drawableHeight = buttonDrawable.getIntrinsicHeight();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> drawableWidth = buttonDrawable.getIntrinsicWidth();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> top;</div><div class="line">        <span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">            <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                top = getHeight() - drawableHeight;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">                top = (getHeight() - drawableHeight) / <span class="number">2</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                top = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bottom = top + drawableHeight;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> left = isLayoutRtl() ? getWidth() - drawableWidth : <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> right = isLayoutRtl() ? getWidth() : drawableWidth;</div><div class="line"></div><div class="line">        buttonDrawable.setBounds(left, top, right, bottom);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Drawable background = getBackground();</div><div class="line">        <span class="keyword">if</span> (background != <span class="keyword">null</span>) &#123;</div><div class="line">            background.setHotspotBounds(left, top, right, bottom);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (buttonDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> scrollX = mScrollX;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> scrollY = mScrollY;</div><div class="line">        <span class="keyword">if</span> (scrollX == <span class="number">0</span> &amp;&amp; scrollY == <span class="number">0</span>) &#123;</div><div class="line">            buttonDrawable.draw(canvas);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            canvas.translate(scrollX, scrollY);</div><div class="line">            buttonDrawable.draw(canvas);</div><div class="line">            canvas.translate(-scrollX, -scrollY);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™äº›å±æ€§éƒ½åˆå§‹åŒ–å¥½äº†ï¼Œé‚£å°±å¯ä»¥æ¥ç»˜åˆ¶äº†ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“è‡ªå®šä¹‰é‡å†™onDraw() æ–¹æ³•æ¥ç»˜åˆ¶è§†å›¾ï¼ŒCompoundButton ä¹Ÿé‡å†™äº†æ­¤æ–¹æ³•ï¼Œå°†æˆ‘ä»¬è®¾ç½®äº†å„ç§å±æ€§çš„mButtonDrawable å¤åˆ¶ç»™å±€éƒ¨å˜é‡buttonDrawableï¼Œç„¶åæ ¹æ®å¯¹å…¶æ–¹å¼ï¼ˆGravityï¼‰ å±æ€§æ¥æ¥å…·ä½“ç»˜åˆ¶buttonDrawableã€‚ç„¶åè°ƒç”¨çˆ¶ç±»çš„onDraw()ï¼Œæœ€ååœ¨æ ¹æ®æ—¶å€™æ˜¯æ»‘åŠ¨é€šè¿‡Canvas æ¥ç»˜åˆ¶ï¼Œå¦‚æœæ°´å¹³å’Œå‚ç›´æ»‘åŠ¨ä¸º0ï¼Œåˆ™ç›´æ¥ç»˜åˆ¶å³å¯ï¼Œå¦‚æœä¸ä¸ºé›¶åˆ™éœ€è¦è°ƒç”¨translate å¯¹canvas çš„é‡æ–°ç»˜åˆ¶ã€‚</p>
<h2 id="è®¾ç½®é€‰ä¸­-checked-çŠ¶æ€"><a href="#è®¾ç½®é€‰ä¸­-checked-çŠ¶æ€" class="headerlink" title="è®¾ç½®é€‰ä¸­(checked)çŠ¶æ€"></a><strong>è®¾ç½®é€‰ä¸­(checked)çŠ¶æ€</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setChecked</span><span class="params">(<span class="keyword">boolean</span> checked)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mChecked != checked) &#123;</div><div class="line">        mChecked = checked;</div><div class="line">        refreshDrawableState();</div><div class="line">        notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">                AccessibilityEvent.CONTENT_CHANGE_TYPE_UNDEFINED);</div><div class="line"></div><div class="line">        <span class="comment">// é¿å…å¤šæ¬¡è°ƒç”¨setChecked() æ¥å¤šæ¬¡è°ƒç”¨å›è°ƒç›‘å¬</span></div><div class="line">        <span class="keyword">if</span> (mBroadcasting) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBroadcasting = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mOnCheckedChangeListener != <span class="keyword">null</span>) &#123;</div><div class="line">            mOnCheckedChangeListener.onCheckedChanged(<span class="keyword">this</span>, mChecked);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mOnCheckedChangeWidgetListener != <span class="keyword">null</span>) &#123;</div><div class="line">            mOnCheckedChangeWidgetListener.onCheckedChanged(<span class="keyword">this</span>, mChecked);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBroadcasting = <span class="keyword">false</span>;            </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// è®¾ç½®ç›‘çŠ¶æ€å¬</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnCheckedChangeListener</span><span class="params">(OnCheckedChangeListener listener)</span> </span>&#123;</div><div class="line">    mOnCheckedChangeListener = listener;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setOnCheckedChangeWidgetListener</span><span class="params">(OnCheckedChangeListener listener)</span> </span>&#123;</div><div class="line">    mOnCheckedChangeWidgetListener = listener;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¾ç½®çŠ¶æ€ï¼Œå°±æ˜¯ä¼ å…¥ä¸€ä¸ªBoolean å€¼æ¥è®¾ç½®çŠ¶æ€ï¼Œå¦‚æœå’Œåˆå§‹åŒ–çš„mChecked ç›¸åï¼Œæ‰ä¼šè°ƒç”¨ï¼Œç„¶åè°ƒç”¨refreshDrawableState() æ¥åˆ·æ–°ç»˜åˆ¶çš„çŠ¶æ€ï¼Œç„¶åä¸‹é¢å°±æ˜¯è®¾ç½®çŠ¶æ€æ”¹å˜çš„ç›‘å¬ï¼Œé€šè¿‡mBroadcasting å±æ€§æ¥é¿å…å¤šæ¬¡è®¾ç½®å›è°ƒï¼Œæ¯æ¬¡è°ƒç”¨mBroadcastingï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™è¿”å›ã€‚å‘ç°æœ‰ä¸¤ä¸ªç›‘å¬ï¼Œæˆ‘ä»¬ä»”ç»†çœ‹ä¸‹é¢setXxxListener() çš„æ–¹æ³•ï¼Œè€Œä¸‹é¢é‚£ä¸ªsetOnCheckedChangeWidgetListener() æ–¹æ³•ä¸æ˜¯Publicï¼Œæ‰€ä»¥è¯´ä¸æ˜¯å¯¹å¤–å¼€æ”¾çš„ï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½è°ƒç”¨çš„ï¼Œæ–‡æ¡£ä¸­è¯´æ˜æ˜¯ä»…ä¾›å†…éƒ¨ä½¿ç”¨ã€‚å› æ­¤æˆ‘ä»¬æƒ³è¦ç›‘å¬é€‰ä¸­çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨setOnCheckedChangeListener()ã€‚é‡å†™onCheckedChanged(CompoundButton buttonView, boolean isChecked) å³å¯ã€‚å¯¹äº†ï¼Œé™¤äº†setChecked() å¯ä»¥è®¾ç½®çŠ¶æ€ï¼Œtoggle() æ¯æ¬¡ä¹Ÿä¼šsetChecked() æ–¹æ³•ï¼Œæ¯æ¬¡éƒ½ä¼šè®²çŠ¶æ€è®¾ç½®ä¸ºç›¸åçš„ã€‚è¿˜æœ‰isChecked() æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰çš„é€‰ä¸­çŠ¶æ€ã€‚</p>
<h2 id="çŠ¶æ€ä¿å­˜"><a href="#çŠ¶æ€ä¿å­˜" class="headerlink" title="çŠ¶æ€ä¿å­˜"></a><strong>çŠ¶æ€ä¿å­˜</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SavedState</span> <span class="keyword">extends</span> <span class="title">BaseSavedState</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> checked;</div><div class="line">    SavedState(Parcelable superState) &#123;</div><div class="line">        <span class="keyword">super</span>(superState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SavedState</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(in);</div><div class="line">        checked = (Boolean)in.readValue(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel out, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.writeToParcel(out, flags);</div><div class="line">        out.writeValue(checked);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;SavedState&gt; CREATOR</div><div class="line">            = <span class="keyword">new</span> Parcelable.Creator&lt;SavedState&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> SavedState <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SavedState(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> SavedState[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SavedState[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</div><div class="line">    Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</div><div class="line">    SavedState ss = <span class="keyword">new</span> SavedState(superState);</div><div class="line">    ss.checked = isChecked();</div><div class="line">    <span class="keyword">return</span> ss;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Parcelable state)</span> </span>&#123;</div><div class="line">    SavedState ss = (SavedState) state;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onRestoreInstanceState(ss.getSuperState());</div><div class="line">    setChecked(ss.checked);</div><div class="line">    requestLayout();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¿å­˜çŠ¶æ€æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªSavedStateï¼Œç»§æ‰¿è‡ªBaseSavedStateï¼Œç„¶åParcelable å°†Boobean ç±»å‹checked å±æ€§åºåˆ—åŒ–ï¼Œåˆ¤æ–­æ˜¯å¦é€‰ä¸­ï¼Œåœ¨onSaveInstanceState() ä¸­ï¼Œä¿å­˜ï¼Œç„¶ååœ¨onRestoreInstanceState() è·å–åºåˆ—åŒ–çš„å±æ€§ï¼Œé‡æ–°è°ƒç”¨setChecked() è®¾ç½®å±æ€§ã€‚</p>
<h2 id="Checkbox-ToggleButton"><a href="#Checkbox-ToggleButton" class="headerlink" title="Checkbox/ToggleButton"></a>Checkbox/ToggleButton</h2><p>Checkbox å’ŒToggleButton çš„å®ç°é‚£éƒ½æ˜¯ç»§æ‰¿è‡ªCompoundButtonï¼Œå¯ä»¥çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ã€‚</p>
<ul>
<li><a href="ToggleButtonå’ŒCheckBoxæºç åˆ†æ.md">ToggleButton/Checkbox çš„æºç åˆ†æ</a></li>
</ul>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>bindServiceæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/bindService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/bindServiceæºç åˆ†æ/</id>
    <published>2017-07-26T11:46:44.000Z</published>
    <updated>2017-07-26T11:52:07.551Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h1 id="bindService-æºç åˆ†æ-ã€è¿›è¡Œä¸­ã€‘"><a href="#bindService-æºç åˆ†æ-ã€è¿›è¡Œä¸­ã€‘" class="headerlink" title="bindService æºç åˆ†æ ã€è¿›è¡Œä¸­ã€‘"></a>bindService æºç åˆ†æ ã€è¿›è¡Œä¸­ã€‘</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å®¢æˆ·ç«¯é€šè¿‡ ContextWrapper.bindService() æ–¹æ³•æ¥ç»‘å®šæœåŠ¡ï¼Œæœ¬åœ°å¯¹ bindService çš„è¿‡ç¨‹è¿›è¡Œæºç åˆ†æã€‚</p>
<p><strong>æ•´ä½“æ—¶åºå›¾</strong></p>
<p><img src="https://github.com/xxx" alt="bindService æ—¶åºå›¾"></p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>1. å®¢æˆ·ç«¯è°ƒç”¨ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/java/org/xdty/aidlexample/MainActivity.java#L45" target="_blank" rel="external">bindService()</a> ç»‘å®šæœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MainActivity.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">    Intent intent = <span class="keyword">new</span> Intent().setComponent(<span class="keyword">new</span> ComponentName(</div><div class="line">            <span class="string">"org.xdty.remoteservice"</span>,</div><div class="line">            <span class="string">"org.xdty.remoteservice.RemoteService"</span>));</div><div class="line">    bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Activity.bindService()</code> æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ContextImpl.java#L1283" target="_blank" rel="external">ContextImpl.bindService()</a> æ–¹æ³•</p>
<p>2. ContextImpl.bindService()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ContextImpl.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">        <span class="keyword">int</span> flags) &#123;</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    <span class="keyword">return</span> bindServiceCommon(service, conn, flags, Process.myUserHandle());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</span></span></div><div class="line">        UserHandle user) &#123;</div><div class="line">    IServiceConnection sd;</div><div class="line"></div><div class="line">    sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(),</div><div class="line">                mMainThread.getHandler(), flags);</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        IBinder token = getActivityToken();</div><div class="line">        ...</div><div class="line">        <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">            service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">            sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯è§æ¥ç€è°ƒç”¨äº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L3740" target="_blank" rel="external">ActivityManagerNative.getDefault().bindService()</a> æ–¹æ³•</p>
<p>è¿™é‡Œçš„ <code>mPackageInfo</code> æ˜¯ä¸€ä¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/LoadedApk.java#L977" target="_blank" rel="external">LoadedApk</a> å®ä¾‹ã€‚<code>mMainThread</code> åˆ™æ˜¯ä¸€ä¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityThread.java#L1705" target="_blank" rel="external">ActivityThread</a>ã€‚</p>
<p>3. ActivityManagerNative.getDefault().bindService()</p>
<p>æ³¨æ„ <code>ActivityManagerNative.java</code> æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªç±» <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L61" target="_blank" rel="external">ActivityManagerNative</a> <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L2619" target="_blank" rel="external">ActivityManagerProxy</a>, ä»–ä»¬éƒ½å®ç°äº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/IActivityManager.java#L66" target="_blank" rel="external">IActivityManager</a>æ¥å£ï¼Œè€Œ <a href="">ActivityManagerNative</a> åˆ™ç»§æ‰¿äº† <code>Binder</code> å¯¹è±¡ï¼Œç›¸å½“äº AIDL ä¸­çš„ Stubï¼Œ<code>`ActivityManagerProxy</code> åˆ™ç›¸å½“äº Proxyã€‚</p>
<p>é¦–å…ˆçœ‹ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L84" target="_blank" rel="external">ActivityManagerNative.getDefault()</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†æ‰¾ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L2610" target="_blank" rel="external">gDefault</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">        IActivityManager am = asInterface(b);</div><div class="line">        <span class="keyword">return</span> am;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å†æ¥çœ‹ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L67" target="_blank" rel="external">asInterface()</a> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    IActivityManager in =</div><div class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> in;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¾ˆå®¹æ˜“å‘ç°å…¶è¿”å›äº†ä¸€ä¸ª <code>ActivityManagerProxy</code> å¯¹è±¡ï¼Œæ‰€ä»¥è°ƒç”¨çš„ <code>bindService()</code> æ–¹æ³•å®ç°åœ¨ <code>ActivityManagerProxy</code> ç±»ä¸­ã€‚æ³¨æ„è¿™é‡Œä¸è¦å’ŒæŠ½è±¡ç±» <code>ActivityManagerNative.class</code> ç»§æ‰¿çš„ <code>bindService()</code> æ–¹æ³•æ··æ·†ï¼Œå®ƒçš„å®ç°åœ¨å­ç±» ActivityManagerService ä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ Proxy ä¸­çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ActivityManagerNative.java</span></div><div class="line"></div><div class="line"><span class="comment">// ActivityManagerProxy.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token,</span></span></div><div class="line">        Intent service, String resolvedType, IServiceConnection connection,</div><div class="line">        <span class="keyword">int</span> flags,  String callingPackage, <span class="keyword">int</span> userId) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    Parcel data = Parcel.obtain();</div><div class="line">    Parcel reply = Parcel.obtain();</div><div class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">    data.writeStrongBinder(token);</div><div class="line">    service.writeToParcel(data, <span class="number">0</span>);</div><div class="line">    data.writeString(resolvedType);</div><div class="line">    data.writeStrongBinder(connection.asBinder());</div><div class="line">    data.writeInt(flags);</div><div class="line">    data.writeString(callingPackage);</div><div class="line">    data.writeInt(userId);</div><div class="line">    mRemote.transact(BIND_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">    reply.readException();</div><div class="line">    <span class="keyword">int</span> res = reply.readInt();</div><div class="line">    data.recycle();</div><div class="line">    reply.recycle();</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯è§è¿™é‡Œå°†è¦ç»‘å®šçš„æœåŠ¡ä¿¡æ¯æ‰“åŒ…ï¼Œé€šè¿‡ä¸€ä¸ª binder å¯¹è±¡ï¼Œå‘é€äº† <code>BIND_SERVICE_TRANSACTION</code> å‘½ä»¤ç»™ <code>ActivityManager</code> çš„æœåŠ¡ç«¯ã€‚è€Œ <code>ActivityManager</code> çš„æœåŠ¡ç«¯å°±æ˜¯ <code>ActivityManagerNative</code>ï¼Œæ‰€ä»¥æ¥ç€å‘½ä»¤ä¼šè¢« <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L143" target="_blank" rel="external">ActivityManagerNative.onTransact()</a> å¤„ç†</p>
<p>4. ActivityManagerNative.onTransact()</p>
<p><code>ActivityManagerNative</code> å¯¹ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L973" target="_blank" rel="external">BIND_SERVICE_TRANSACTION</a> å‘½ä»¤é‡æ–°è§£åŒ…å¹¶é€šè¿‡å­ç±»å®ç°çš„ <a href="">ActivityManagerNative.bindService()</a> å¤„ç†ï¼Œæ³¨æ„è¿™é‡Œçš„ <code>bindService()</code> å’Œä¸Šæ–‡çš„ <code>ActivityManagerProxy.bindService()</code> ä¸åŒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> BIND_SERVICE_TRANSACTION: &#123;</div><div class="line">            data.enforceInterface(IActivityManager.descriptor);</div><div class="line">            IBinder b = data.readStrongBinder();</div><div class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(b);</div><div class="line">            IBinder token = data.readStrongBinder();</div><div class="line">            Intent service = Intent.CREATOR.createFromParcel(data);</div><div class="line">            String resolvedType = data.readString();</div><div class="line">            b = data.readStrongBinder();</div><div class="line">            <span class="keyword">int</span> fl = data.readInt();</div><div class="line">            String callingPackage = data.readString();</div><div class="line">            <span class="keyword">int</span> userId = data.readInt();</div><div class="line">            IServiceConnection conn = IServiceConnection.Stub.asInterface(b);</div><div class="line">            <span class="keyword">int</span> res = bindService(app, token, service, resolvedType, conn, fl,</div><div class="line">                    callingPackage, userId);</div><div class="line">            reply.writeNoException();</div><div class="line">            reply.writeInt(res);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5. ActivityManagerService.bindService()</p>
<p>æˆ‘ä»¬ç»§ç»­çœ‹ <code>ActivityManagerNative</code> çš„å­ç±» <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java#L15897" target="_blank" rel="external">ActivityManagerService</a> å¯¹ <code>bindService()</code> æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line">        String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</div><div class="line">        <span class="keyword">int</span> userId) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</div><div class="line">                resolvedType, connection, flags, callingPackage, userId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯è§é€šè¿‡ <code>mServices.bindServiceLocked()</code> æ–¹æ³•åˆä¼ é€’ç»™äº†ä¸‹ä¸€å±‚ï¼Œè¿™é‡Œçš„ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java#L2309" target="_blank" rel="external">mServices</a> åˆ™æ˜¯ä¸€ä¸ª <code>ActiveServices</code> å®ä¾‹ã€‚æˆ‘ä»¬ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/services/core/java/com/android/server/am/ActiveServices.java#L697" target="_blank" rel="external">ActiveServices.bindServiceLocked()</a></p>
<p>6. ActiveServices.bindServiceLocked()</p>
<p>æ¥ä¸‹æ¥çœ‹ bindServiceLocked() å…³é”®ä»£ç ç‰‡æ–­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line">        String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags,</div><div class="line">        String callingPackage, <span class="keyword">int</span> userId) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    <span class="comment">// è·å–å½“å‰åº”ç”¨çš„è¿›ç¨‹è®°å½•</span></div><div class="line">    <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</div><div class="line"></div><div class="line">    <span class="comment">// è·å–å½“å‰ Activity è®°å½•</span></div><div class="line">    ActivityRecord activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (token != <span class="keyword">null</span>) &#123;</div><div class="line">        activity = ActivityRecord.isInStackLocked(token);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// è·å– ServiceLookupResultï¼Œå…¶ä¸­ res.record å°±æ˜¯æˆ‘ä»¬è¦å¯åŠ¨çš„ service</span></div><div class="line">    ServiceLookupResult res =</div><div class="line">        retrieveServiceLocked(service, resolvedType, callingPackage,</div><div class="line">                Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">true</span>, callerFg);</div><div class="line">    ServiceRecord s = res.record;</div><div class="line"></div><div class="line">    mAm.startAssociationLocked(callerApp.uid, callerApp.processName,</div><div class="line">            s.appInfo.uid, s.name, s.processName);</div><div class="line"></div><div class="line">    AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</div><div class="line">    </div><div class="line">    <span class="comment">// å°è£…å®¢æˆ·ç«¯ä¼ å…¥çš„ IServiceConnectionï¼Œç”¨äºç»‘å®šåå›è°ƒ</span></div><div class="line">    ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</div><div class="line">            connection, flags, clientLabel, clientIntent);</div><div class="line"></div><div class="line">    <span class="comment">// ä¿å­˜ connection è®°å½•åˆ°åˆ—è¡¨ä¸­</span></div><div class="line">    IBinder binder = connection.asBinder();</div><div class="line">    ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</div><div class="line">    <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</div><div class="line">        clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">        s.connections.put(binder, clist);</div><div class="line">    &#125;</div><div class="line">    clist.add(c);</div><div class="line">    b.connections.add(c);</div><div class="line">    <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) &#123;</div><div class="line">            activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</div><div class="line">        &#125;</div><div class="line">        activity.connections.add(c);</div><div class="line">    &#125;</div><div class="line">    b.client.connections.add(c);</div><div class="line">    <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) &#123;</div><div class="line">        b.client.hasAboveClient = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</div><div class="line">        updateServiceClientActivitiesLocked(s.app, c, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    clist = mServiceConnections.get(binder);</div><div class="line">    <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</div><div class="line">        clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">        mServiceConnections.put(binder, clist);</div><div class="line">    &#125;</div><div class="line">    clist.add(c);</div><div class="line"></div><div class="line">    <span class="comment">// ç»§ç»­è¿›å…¥ bringUpServiceLocked() å¤„ç†</span></div><div class="line">    <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</div><div class="line">        s.lastActivity = SystemClock.uptimeMillis();</div><div class="line">        <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="keyword">false</span>) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7. ActiveServices.bringUpServiceLocked()</p>
<p>ç»§ç»­æŸ¥çœ‹ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/services/core/java/com/android/server/am/ActiveServices.java#L1362" target="_blank" rel="external">bringUpServiceLocked()</a> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg,</span></span></div><div class="line">        <span class="keyword">boolean</span> whileRestarting) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">final</span> String procName = r.processName;</div><div class="line">    ProcessRecord app;</div><div class="line"></div><div class="line">    <span class="comment">// è·å–è¿›ç¨‹è®°å½•</span></div><div class="line">    app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</div><div class="line">            <span class="comment">// å¯åŠ¨æœåŠ¡</span></div><div class="line">            realStartServiceLocked(r, app, execInFg);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>8. ActiveServices.realStartServiceLocked()</p>
<p>ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/services/core/java/com/android/server/am/ActiveServices.java#L1492" target="_blank" rel="external">ActiveServices.realStartServiceLocked()</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></div><div class="line">        ProcessRecord app, <span class="keyword">boolean</span> execInFg) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// åˆ›å»ºæœåŠ¡ï¼ŒæœåŠ¡ç«¯æœ€ç»ˆä¼šå“åº” onCreate() æ–¹æ³•ã€‚</span></div><div class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                app.repProcState);</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ç»‘å®šæœåŠ¡ï¼Œ æœåŠ¡æœ€ç»ˆç«¯ä¼šå“åº” onBind() æ–¹æ³•</span></div><div class="line">    requestServiceBindingsLocked(r, execInFg);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.csdn.net/luoshengyang/article/details/6745181" target="_blank" rel="external">Androidåº”ç”¨ç¨‹åºç»‘å®šæœåŠ¡ï¼ˆbindServiceï¼‰çš„è¿‡ç¨‹æºä»£ç åˆ†æ</a></p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Binderæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/Binder%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/Binderæºç åˆ†æ/</id>
    <published>2017-07-26T11:44:18.000Z</published>
    <updated>2017-07-26T11:45:24.437Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<p>æœ¬æ–‡æ˜¯åŸºäº <a href="https://github.com/xdtianyu/android-6.0.0_r1" target="_blank" rel="external">Android 6.0.0</a> å’Œ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow" target="_blank" rel="external">kernel 3.4</a> æºç  åŠ Android SDK 23 å±•å¼€çš„</p>
<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>Binder æ˜¯ä¸€ç§ Android è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œæä¾›è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(Remote Procedure Call)åŠŸèƒ½ã€‚æˆ‘ä»¬æœ€ç›´æ¥çš„ä½¿ç”¨æ˜¯è°ƒç”¨ <code>Context.getSystemService()</code> æ¥è·å–ç³»ç»ŸæœåŠ¡ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ <code>AIDL</code> æ¥å®ç°å¤šä¸ªç¨‹åº(APP)é—´æ•°æ®äº¤äº’ã€‚</p>
<p>Binder æ˜¯éå¸¸é‡è¦çš„ Android åŸºç¡€ç»„ä»¶ï¼Œå‡ ä¹æ‰€æœ‰çš„è¿›ç¨‹é—´é€šä¿¡éƒ½æ˜¯ä½¿ç”¨ Binder æœºåˆ¶å®ç°çš„ã€‚æœ¬æ–‡å°†ç»“åˆæºç å±•å¼€è®²è¿° Binder ï¼ŒåŒæ—¶å¯¹ä¸€äº›é‡è¦çŸ¥è¯†ç‚¹æä¾›æ‰©å±•é˜…è¯»çš„å‚è€ƒã€‚</p>
<p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/android_binder.png" alt="android_binder"></p>
<p>ä¸ç®¡æ˜¯ Android ç³»ç»ŸæœåŠ¡(System services)è¿˜æ˜¯ç”¨æˆ·çš„åº”ç”¨è¿›ç¨‹(User apps)ï¼Œæœ€ç»ˆéƒ½ä¼šé€šè¿‡ binder æ¥å®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚ä¸Šå±‚åº”ç”¨é¦–å…ˆé€šè¿‡ IBinder çš„ transcate æ–¹æ³•å‘é€å‘½ä»¤ç»™ libbinderï¼Œ libbinder å†é€šè¿‡ç³»ç»Ÿè°ƒç”¨(ioctl) å‘é€å‘½ä»¤åˆ°å†…æ ¸ä¸­çš„ binder é©±åŠ¨ï¼Œä¹‹åå†ç”±é©±åŠ¨å®Œæˆè¿›ç¨‹é—´æ•°æ®çš„äº¤äº’ã€‚</p>
<p>æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ Intentï¼ŒMessager æ•°æ®ä¼ é€’ä¹Ÿæ˜¯å¯¹ Binder æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡å’Œå°è£…ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šç”±å†…æ ¸ä¸­çš„ binder é©±åŠ¨å®Œæˆæ•°æ®çš„ä¼ é€’ã€‚</p>
<h2 id="2-Binder-ä¸-AIDL"><a href="#2-Binder-ä¸-AIDL" class="headerlink" title="2. Binder ä¸ AIDL"></a>2. Binder ä¸ AIDL</h2><p>AIDL (Android Interface definition language) æ˜¯æ¥å£æè¿°è¯­è¨€ï¼Œç”¨äºç”Ÿæˆåœ¨ä¸¤ä¸ªè¿›ç¨‹é—´è¿›è¡Œé€šä¿¡çš„ä»£ç ã€‚å…ˆçœ‹ AIDL æ¦‚å¿µå›¾</p>
<p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/AIDL.png" alt="AIDLæ¦‚å¿µå›¾"></p>
<ul>
<li><p>Stub.Proxy å’Œ Stub ä»£ç ç”± Android Sdk è‡ªåŠ¨ç”Ÿæˆï¼Œå®¢æˆ·ç«¯é€šè¿‡ Stub.Proxy ä¸è¿œç¨‹æœåŠ¡äº¤äº’ã€‚</p>
</li>
<li><p>Stub åŒ…å«å¯¹ IBinder å¯¹è±¡æ“ä½œçš„å°è£…ï¼Œéœ€è¦è¿œç¨‹æœåŠ¡å®ç°å…·ä½“åŠŸèƒ½ã€‚</p>
</li>
</ul>
<p>æ¥ä¸‹æ¥å†çœ‹å…·ä½“å®ç°ï¼Œ å®Œæ•´æºä»£ç è§ <a href="https://github.com/xdtianyu/AidlExample" target="_blank" rel="external">AidlExample</a>ã€‚åœ¨è¿™ä¸ªå·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ–°å»ºäº†ä¸¤ä¸ªåº”ç”¨ï¼Œ <code>app</code> æ˜¯å®¢æˆ·ç«¯ä»£ç ï¼Œ <code>remoteservice</code> åˆ™æ˜¯æœåŠ¡ç«¯ä»£ç ã€‚</p>
<h3 id="2-1-AIDL-å®¢æˆ·ç«¯"><a href="#2-1-AIDL-å®¢æˆ·ç«¯" class="headerlink" title="2.1 AIDL å®¢æˆ·ç«¯"></a>2.1 AIDL å®¢æˆ·ç«¯</h3><p>åœ¨ Android Studio é¡¹ç›®ä¸Šå³é”®ï¼Œ <code>New</code> -&gt; <code>AIDL</code> -&gt; <code>AIDL File</code> è¾“å…¥æ–‡ä»¶ååå¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ª AIDL çš„ä»£ç ç»“æ„ã€‚ä¾‹å¦‚æˆ‘ä»¬æ–°å»ºä¸€ä¸ª <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/aidl/org/xdty/remoteservice/IRemoteService.aidl" target="_blank" rel="external">IRemoteService.aidl</a> æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ç”Ÿæˆçš„ç¤ºä¾‹ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒAIDL çš„è¯­æ³•ç±»ä¼¼ Javaï¼Œ <code>basicTypes()</code> æ–¹æ³•ä¼ é€’çš„å‚æ•°åªæ˜¯åŸºæœ¬ç±»å‹ã€‚</p>
<p>å¦‚æœè¦ä¼ é€’è‡ªå®šä¹‰ç±»å‹å¦‚ <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/User.java#L6" target="_blank" rel="external">User</a>ï¼Œåˆ™éœ€è¦å®ç° <a href="http://developer.android.com/reference/android/os/Parcelable.html" target="_blank" rel="external">Parcelable</a> æ¥å£ã€‚<code>Parcelable</code> æ˜¯ä¸€ä¸ªä¸ Java <code>Serializable</code> ç±»ä¼¼çš„åºåˆ—åŒ–æ¥å£ã€‚</p>
<p>è¿™æ ·ç±» <code>User</code> çš„å®ä¾‹å°±å¯ä»¥å‚¨å­˜åˆ° <a href="http://developer.android.com/reference/android/os/Parcel.html" target="_blank" rel="external">Parcel</a> ä¸­ï¼Œè€Œ <code>Parcel</code> åˆ™æ˜¯ä¸€ä¸ªå¯ä»¥é€šè¿‡ <code>IBinder</code> å‘é€æ•°æ®æˆ–å¯¹è±¡å¼•ç”¨çš„å®¹å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// User.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> uid;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">// ä» Parcel ä¸­è¯»å–æ•°æ®ï¼Œé¡ºåºéœ€è¦å’Œå†™å…¥ä¿æŒä¸€è‡´</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">User</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        uid = in.readInt();</div><div class="line">        name = in.readString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å¿…é¡»å®ç°ï¼Œç”¨äºä» Parcel å¯¹è±¡ä¸­ç”Ÿæˆç±»å®ä¾‹</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="keyword">new</span> Creator&lt;User&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> User[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// å°†æ•°æ®å†™å…¥åˆ° Parcel ä¸­ï¼Œ é¡ºåºéœ€è¦ä¸è¯»å–ä¿æŒä¸€è‡´</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        dest.writeInt(uid);</div><div class="line">        dest.writeString(name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†å‘ <code>IRemoteService.aidl</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>addUser()</code> æ–¹æ³•ï¼ŒåŒæ—¶æ–°å»ºä¸€ä¸ª <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/aidl/org/xdty/remoteservice/User.aidl" target="_blank" rel="external">User.aidl</a> æ–‡ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.android.aidltest.User;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line"></div><div class="line">    <span class="comment">// in è¡¨ç¤ºä¼ å…¥æ•°æ®ï¼Œ out è¡¨ç¤ºä¼ å‡ºæ•°æ®ï¼Œ inout è¡¨ç¤ºåŒå‘ä¼ é€’ã€‚æ³¨æ„å«æœ‰ out æ—¶ User ç±»éœ€è¦å®ç° readFromParcel() æ–¹æ³•</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addUser</span><span class="params">(in User user)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// User.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line">parcelable User;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç¼–è¯‘åï¼Œä¼šåœ¨ <code>generated</code> æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆä¸€ä¸ª <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L92" target="_blank" rel="external">IRemoteService.java</a> æ¥å£æ–‡ä»¶ã€‚è¿™ä¸ªæ¥å£ä¸­æœ‰ä¸¤ä¸ªå†…éƒ¨ç±» <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L19" target="_blank" rel="external">Stub</a> å’Œ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L92" target="_blank" rel="external">Stub.Proxy</a>ã€‚æ³¨æ„å®¢æˆ·ç«¯ç”Ÿæˆçš„<code>IRemoteService.java</code> æ–‡ä»¶å’Œåœ¨åæ–‡æœåŠ¡ç«¯ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹æ˜¯ç›¸åŒçš„ã€‚</p>
<p>å®¢æˆ·ç«¯ä¼šä» <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L34" target="_blank" rel="external">Stub.asInterface()</a> å¾—åˆ° <code>IRemoteService (Stub.Proxy)</code> çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å°±æ˜¯ä¸€ä¸ªé€šè¿‡ Binder ä¼ é€’å›æ¥çš„ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L93" target="_blank" rel="external">è¿œç¨‹å¯¹è±¡</a> çš„åŒ…è£…ã€‚è€ŒæœåŠ¡ç«¯åˆ™éœ€è¦å®ç° <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L15" target="_blank" rel="external">IRemoteService.addUser()</a> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> org.xdty.remoteservice.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">    <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> org.xdty.remoteservice.IRemoteService))) &#123;</div><div class="line">        <span class="keyword">return</span> ((org.xdty.remoteservice.IRemoteService) iin);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> org.xdty.remoteservice.IRemoteService.Stub.Proxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-AIDL-æœåŠ¡ç«¯"><a href="#2-2-AIDL-æœåŠ¡ç«¯" class="headerlink" title="2.2 AIDL æœåŠ¡ç«¯"></a>2.2 AIDL æœåŠ¡ç«¯</h3><p>ä¸ºäº†æ¼”ç¤ºè¿›ç¨‹é—´é€šä¿¡ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ¨¡å—ï¼ˆåº”ç”¨ï¼‰ <a href="https://github.com/xdtianyu/AidlExample/tree/master/remoteservice" target="_blank" rel="external">RemoteService</a> æ¥å®ç°åŠŸèƒ½ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ç»‘å®šæœåŠ¡ã€‚</p>
<p>æŒ‰å®¢æˆ·ç«¯çš„ç»“æ„æ–°å»º <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/aidl/org/xdty/remoteservice/IRemoteService.aidl" target="_blank" rel="external">IRemoteService.aidl</a> <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/aidl/org/xdty/remoteservice/User.aidl" target="_blank" rel="external">User.aidl</a> <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/User.java" target="_blank" rel="external">User.java</a> æ–‡ä»¶ï¼Œå¹¶æ‹·è´å†…å®¹ï¼Œæ³¨æ„å¦‚æœéœ€è¦è¯·ä¿®æ”¹åŒ…åã€‚</p>
<p>æ–°å»ºæœåŠ¡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/RemoteService.java#L29" target="_blank" rel="external">RemoteService</a> ï¼Œè¦†ç›–(Override) <code>onBind()</code> æ–¹æ³•å¹¶è¿”å› <code>IRemoteService.Stub</code> å®ä¾‹ <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/RemoteService.java#L11" target="_blank" rel="external">mBinder</a>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = RemoteService.class.getSimpleName();</div><div class="line">    <span class="keyword">private</span> IBinder mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">                <span class="keyword">double</span> aDouble, String aString) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">            Log.d(TAG, <span class="string">"basicTypes: "</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">"addUser: "</span> + user.name);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·æœåŠ¡ç«¯å°±å®ç°äº† <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L15" target="_blank" rel="external">addUser()</a> æ–¹æ³•ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡è¿œç¨‹å¯¹è±¡è°ƒç”¨ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L135" target="_blank" rel="external">IRemoteService.Stub.Proxy.addUser()</a> æ—¶ï¼Œè¿œç¨‹å¯¹è±¡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L147" target="_blank" rel="external">mRemote</a> å°±ä¼šé€šè¿‡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L147" target="_blank" rel="external">transact()</a> å‘é€å‘½ä»¤ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å‘½ä»¤ååœ¨ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L76" target="_blank" rel="external">Stub.onTransact()</a> ä¸­è¯»å–æ•°æ®å¹¶æ‰§è¡Œ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L84" target="_blank" rel="external">addUser()</a> æ–¹æ³•ã€‚æ›´å¤šç»†èŠ‚æˆ‘ä»¬å°†åœ¨ <a href="#3-binder-%E6%A1%86%E6%9E%B6%E5%8F%8A-native-%E5%B1%82">3. Binder æ¡†æ¶åŠ Native å±‚</a> å°èŠ‚è®²è¿°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">        <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">            data.enforceInterface(DESCRIPTOR);</div><div class="line">            org.xdty.remoteservice.User _arg0;</div><div class="line">            <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _arg0 = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">            reply.writeNoException();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-3-è¿œç¨‹æœåŠ¡çš„è·å–ä¸ä½¿ç”¨"><a href="#2-3-è¿œç¨‹æœåŠ¡çš„è·å–ä¸ä½¿ç”¨" class="headerlink" title="2.3 è¿œç¨‹æœåŠ¡çš„è·å–ä¸ä½¿ç”¨"></a>2.3 è¿œç¨‹æœåŠ¡çš„è·å–ä¸ä½¿ç”¨</h3><p>å®¢æˆ·ç«¯è¦ä½¿ç”¨è¿œç¨‹æœåŠ¡ï¼Œéœ€è¦ç»‘å®šæœåŠ¡ (<a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/java/org/xdty/aidlexample/MainActivity.java#L45" target="_blank" rel="external">bindService</a>) å¹¶å»ºç«‹æœåŠ¡è¿æ¥ (<a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/java/org/xdty/aidlexample/MainActivity.java#L19" target="_blank" rel="external">ServiceConnection</a>)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MainActivity.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            IRemoteService remoteService = IRemoteService.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                remoteService.addUser(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"neo"</span>));</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent().setComponent(<span class="keyword">new</span> ComponentName(</div><div class="line">                <span class="string">"org.xdty.remoteservice"</span>,</div><div class="line">                <span class="string">"org.xdty.remoteservice.RemoteService"</span>));</div><div class="line">        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯é€šè¿‡ <code>binderService()</code> æ–¹æ³•ï¼Œè·å–è¿œç¨‹æœåŠ¡å¹¶åœ¨æœåŠ¡è¿æ¥ <code>ServiceConnection</code> ä¸­ <code>onServiceConnected()</code> å›è°ƒä¸­å¾—åˆ°äº† <code>IBinder service</code> å®ä¾‹ï¼Œ æœ€åé€šè¿‡ä¸Šæ–‡æåˆ°çš„ <code>IRemoteService.Stub.asInterface(service)</code> æ–¹æ³•å¾—åˆ°è¿œç¨‹æœåŠ¡ <code>IRemoteService</code> çš„å®ä¾‹ã€‚é€šè¿‡ <code>IRemoteService.addUser()</code> æ–¹æ³•æˆ‘ä»¬å¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚åœ¨æ¥çœ‹ <code>IRemoteService.addUser()</code> çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> org.xdty.remoteservice.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> org.xdty.remoteservice.IRemoteService.Stub.Proxy(obj);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">xdty</span>.<span class="title">remoteservice</span>.<span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line"></div><div class="line">    Proxy(android.os.IBinder remote) &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(org.xdty.remoteservice.User user)</span></span></div><div class="line">            <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">        android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">            <span class="keyword">if</span> ((user != <span class="keyword">null</span>)) &#123;</div><div class="line">                _data.writeInt(<span class="number">1</span>);</div><div class="line">                user.writeToParcel(_data, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _data.writeInt(<span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            mRemote.transact(Stub.TRANSACTION_addUser, _data, _reply, <span class="number">0</span>);</div><div class="line">            _reply.readException();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            _reply.recycle();</div><div class="line">            _data.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯è°ƒç”¨ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/java/org/xdty/aidlexample/MainActivity.java#L25" target="_blank" rel="external">remoteService.addUser(new User(1, â€œneoâ€))</a> æ–¹æ³•å®é™…ä¸Šæ˜¯é€šè¿‡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L147" target="_blank" rel="external">IBinder service</a> å®ä¾‹çš„ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L147" target="_blank" rel="external">transact()</a> æ–¹æ³•ï¼Œå‘é€äº†ä¸æœåŠ¡ç«¯çº¦å®šå¥½çš„å‘½ä»¤ <code>Stub.TRANSACTION_addUser</code>ï¼Œå¹¶å°†å‚æ•°æŒ‰æ ¼å¼æ‰“åŒ…è¿› <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L137" target="_blank" rel="external">Parcel</a> å¯¹è±¡ã€‚</p>
<p>æœåŠ¡ç«¯åˆ™åœ¨ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L51" target="_blank" rel="external">onTransact()</a> æ–¹æ³•ä¸­æ”¶åˆ°å‘½ä»¤åä¼šå¯¹å‘½ä»¤å’Œå‚æ•°é‡æ–°è§£æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">        <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">            data.enforceInterface(DESCRIPTOR);</div><div class="line">            org.xdty.remoteservice.User _arg0;</div><div class="line">            <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _arg0 = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">            reply.writeNoException();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åœ¨ <code>onTransact()</code> ä¸­ï¼Œæœ€ç»ˆ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L84" target="_blank" rel="external">this.addUser(_arg0)</a> è°ƒç”¨äº†ä¸Šæ–‡æåˆ°çš„æœåŠ¡ç«¯çš„å®ç° <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/RemoteService.java#L19" target="_blank" rel="external">IRemoteService.Stub.addUser()</a> ã€‚</p>
<p>è¿œç¨‹ Binder å¯¹è±¡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L42" target="_blank" rel="external">mRemote</a> æ˜¯ç”±å®¢æˆ·ç«¯ç»‘å®šæœåŠ¡æ—¶ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/src/main/java/org/xdty/aidlexample/MainActivity.java#L23" target="_blank" rel="external">onServiceConnected()</a> è¿”å›çš„ã€‚ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ContextImpl.java#L1283" target="_blank" rel="external">bindService()</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ContextImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">        <span class="keyword">int</span> flags) &#123;</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    <span class="keyword">return</span> bindServiceCommon(service, conn, flags, Process.myUserHandle());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€åæ˜¯é€šè¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ContextImpl.java#L1317#L1320" target="_blank" rel="external">ActivityManagerNative.getDefault().bindService()</a> æ¥ç»‘å®šæœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// bindServiceCommon()</span></div><div class="line"><span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">    mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">    service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">    sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line"></div><div class="line"><span class="comment">// ActivityManagerNative.getDefault().bindService()</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token,</span></span></div><div class="line">        Intent service, String resolvedType, IServiceConnection connection,</div><div class="line">        <span class="keyword">int</span> flags,  String callingPackage, <span class="keyword">int</span> userId) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    ...</div><div class="line">    data.writeStrongBinder(connection.asBinder());</div><div class="line">    ...</div><div class="line">    mRemote.transact(BIND_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿½è¸ªåˆ° <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L3740" target="_blank" rel="external">ActivityManagerNative.getDefault().bindService()</a> ï¼Œå¯ä»¥å‘ç° <code>ActivityManager</code> å’Œ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ActivityManagerNative.java#L3750" target="_blank" rel="external">IServiceConnection</a>ä¹Ÿæ˜¯ä¸€ä¸ª <code>AIDL</code> å®ç°ã€‚é€šè¿‡å®ƒçš„ <code>ActivityManagerProxy.bindService()</code> å°†ç»‘å®šè¯·æ±‚å‘é€ç»™æœ¬åœ°å±‚ã€‚</p>
<p>å†ä» <code>onServiceConnected()</code> å›è°ƒè¿½è¸ªï¼Œ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/LoadedApk.java#L1223" target="_blank" rel="external">onServiceConnected()</a> æ˜¯ç”± <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/LoadedApk.java#L1175" target="_blank" rel="external">LoadedApk.ServiceDispatcher.doConnected()</a> å›è°ƒçš„ã€‚</p>
<p><em>å…³äºæ›´å¤šçš„ <code>bindService()</code> è¿œç¨‹æœåŠ¡åˆ›å»ºåŠ <code>ServiceConnection</code> å›è°ƒï¼Œ è¯·å‚è€ƒ <a href="http://blog.csdn.net/luoshengyang/article/details/6745181" target="_blank" rel="external">Androidåº”ç”¨ç¨‹åºç»‘å®šæœåŠ¡ï¼ˆbindServiceï¼‰çš„è¿‡ç¨‹æºä»£ç åˆ†æ</a></em></p>
<p>åˆ©ç”¨è¿›ç¨‹é—´é€šä¿¡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç®€å•çš„åº”ç”¨æ’ä»¶åŠŸèƒ½ã€‚å…³äº AIDL åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/xdtianyu/CallerInfo/tree/master/plugin/src/main" target="_blank" rel="external">CallerInfo Plugin</a> çš„å®ç°</p>
<p>ä»ä¸Šé¢åˆ†æå¯ä»¥çœ‹å‡ºï¼Œ AIDL çš„æœ¬è´¨æ˜¯å¯¹ Binder çš„åˆä¸€æ¬¡æŠ½è±¡å’Œå°è£…ï¼Œå®é™…çš„è¿›ç¨‹é—´é€šä¿¡ä»æ˜¯ç”± Binder å®Œæˆçš„ã€‚</p>
<h2 id="3-Binder-æ¡†æ¶åŠ-Native-å±‚"><a href="#3-Binder-æ¡†æ¶åŠ-Native-å±‚" class="headerlink" title="3. Binder æ¡†æ¶åŠ Native å±‚"></a>3. Binder æ¡†æ¶åŠ Native å±‚</h2><p>Binderæœºåˆ¶ä½¿æœ¬åœ°å¯¹è±¡å¯ä»¥åƒæ“ä½œå½“å‰å¯¹è±¡ä¸€æ ·è°ƒç”¨è¿œç¨‹å¯¹è±¡ï¼Œå¯ä»¥ä½¿ä¸åŒçš„è¿›ç¨‹é—´äº’ç›¸é€šä¿¡ã€‚Binder ä½¿ç”¨ Client/Server æ¶æ„ï¼Œå®¢æˆ·ç«¯é€šè¿‡æœåŠ¡ç«¯ä»£ç†ï¼Œç»è¿‡ Binder é©±åŠ¨ä¸æœåŠ¡ç«¯äº¤äº’ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/Binder.png" alt="Binderæ¡†æ¶å›¾ç‰‡"></p>
<p>Binder æœºåˆ¶å®ç°è¿›ç¨‹é—´é€šä¿¡çš„å¥¥ç§˜åœ¨äº kernel ä¸­çš„ Binder é©±åŠ¨ï¼Œå°†åœ¨ <a href="#4-binder-%E9%A9%B1%E5%8A%A8">4. Binder é©±åŠ¨</a> å°èŠ‚è¯¦ç»†è®²è¿°ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/binder_native.png" alt="Binderæœ¬åœ°æ¡†æ¶å›¾ç‰‡"></p>
<p>JNI çš„ä»£ç ä½äº <a href="https://github.com/xdtianyu/android-6.0.0_r1/tree/master/frameworks/base/core/jni" target="_blank" rel="external">frameworks/base/core/jni</a> ç›®å½•ä¸‹ï¼Œä¸»è¦æ˜¯ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp" target="_blank" rel="external">android_util_Binder.cpp</a> æ–‡ä»¶å’Œå¤´æ–‡ä»¶ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.h" target="_blank" rel="external">android_util_Binder.h</a></p>
<p>Binder JNI ä»£ç æ˜¯ Binder Java å±‚æ“ä½œåˆ° Binder Native å±‚çš„æ¥å£å°è£…ï¼Œæœ€åä¼šè¢«ç¼–è¯‘è¿› <code>libandroid_runtime.so</code> ç³»ç»Ÿåº“ã€‚</p>
<p>Binder æœ¬åœ°å±‚çš„ä»£ç åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/tree/master/frameworks/native/libs/binder" target="_blank" rel="external">frameworks/native/libs/binder</a> ç›®å½•ä¸‹ï¼Œ æ­¤ç›®å½•åœ¨ Android ç³»ç»Ÿç¼–è¯‘åä¼šç”Ÿæˆ <code>libbinder.so</code> æ–‡ä»¶ï¼Œä¾› JNI è°ƒç”¨ã€‚<code>libbinder</code> å°è£…äº†æ‰€æœ‰å¯¹ binder é©±åŠ¨çš„æ“ä½œï¼Œæ˜¯ä¸Šå±‚åº”ç”¨ä¸é©±åŠ¨äº¤äº’çš„æ¡¥æ¢ã€‚å¤´æ–‡ä»¶åˆ™åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/tree/master/frameworks/native/include/binder" target="_blank" rel="external">frameworks/native/include/binder</a> ç›®å½•ä¸‹ã€‚</p>
<h3 id="3-1-Binder-Native-çš„å…¥å£"><a href="#3-1-Binder-Native-çš„å…¥å£" class="headerlink" title="3.1 Binder Native çš„å…¥å£"></a>3.1 Binder Native çš„å…¥å£</h3><p><a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IInterface.cpp#L33" target="_blank" rel="external">IInterface.cpp</a> æ˜¯ Binder æœ¬åœ°å±‚å…¥å£ï¼Œä¸ java å±‚çš„ <code>android.os.IInterface</code> å¯¹åº”ï¼Œæä¾› <code>asBinder()</code> çš„å®ç°ï¼Œè¿”å› <code>IBinder</code> å¯¹è±¡ã€‚</p>
<p>åœ¨å¤´æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªç±» <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/include/binder/IInterface.h#L50" target="_blank" rel="external">BnInterface (Binder Native Interface)</a> å’Œ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/include/binder/IInterface.h#L63" target="_blank" rel="external">BpInterface (Binder Proxy Interface)</a>, å¯¹åº”äº java å±‚çš„ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L19" target="_blank" rel="external">Stub</a> å’Œ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L92" target="_blank" rel="external">Proxy</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sp&lt;IBinder&gt; IInterface::asBinder(<span class="keyword">const</span> IInterface* iface)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (iface == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">const_cast</span>&lt;IInterface*&gt;(iface)-&gt;onAsBinder();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BnInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BBinder</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> sp&lt;IInterface&gt;      queryLocalInterface(<span class="keyword">const</span> String16&amp; _descriptor);</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> String16&amp;     <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// ----------------------------------------------------------------------</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BpRefBase</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">                                BpInterface(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remote);</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>BnInterface</code> æ˜¯å®ç°StubåŠŸèƒ½çš„æ¨¡æ¿ï¼Œæ‰©å±•BBinderçš„onTransact()æ–¹æ³•å®ç°Binderå‘½ä»¤çš„è§£æå’Œæ‰§è¡Œã€‚<code>BpInterface</code> æ˜¯å®ç°ProxyåŠŸèƒ½çš„æ¨¡æ¿ï¼ŒBpRefBaseé‡Œæœ‰ä¸ªmRemoteå¯¹è±¡æŒ‡å‘ä¸€ä¸ªBpBinderå¯¹è±¡ã€‚</p>
<h3 id="3-2-Binder-æœ¬åœ°å±‚çš„æ•´ä¸ªå‡½æ•°-æ–¹æ³•è°ƒç”¨è¿‡ç¨‹"><a href="#3-2-Binder-æœ¬åœ°å±‚çš„æ•´ä¸ªå‡½æ•°-æ–¹æ³•è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="3.2 Binder æœ¬åœ°å±‚çš„æ•´ä¸ªå‡½æ•°/æ–¹æ³•è°ƒç”¨è¿‡ç¨‹"></a>3.2 Binder æœ¬åœ°å±‚çš„æ•´ä¸ªå‡½æ•°/æ–¹æ³•è°ƒç”¨è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/binder_native_stack.png" alt="Binderæœ¬åœ°å‡½æ•°è°ƒç”¨å›¾"></p>
<p>1. Java å±‚ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L147" target="_blank" rel="external">IRemoteService.Stub.Proxy</a> è°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/Binder.java#L501" target="_blank" rel="external">android.os.IBinder (å®ç°åœ¨ android.os.Binder.BinderProxy)</a> çš„ <code>transact()</code> å‘é€ <code>Stub.TRANSACTION_addUser</code> å‘½ä»¤ã€‚</p>
<p>2. ç”± <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/Binder.java#L507" target="_blank" rel="external">BinderProxy.transact()</a> è¿›å…¥ native å±‚ã€‚</p>
<p>3. ç”± <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L1246" target="_blank" rel="external">jni</a> è½¬åˆ° <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L1246" target="_blank" rel="external">android_os_BinderProxy_transact()</a> å‡½æ•°ã€‚</p>
<p>4. è°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L1124" target="_blank" rel="external">IBinder-&gt;transact</a> å‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></div><div class="line">        jint code, jobject dataObj, jobject replyObj, jint flags) <span class="comment">// throws RemoteException</span></div><div class="line">&#123;</div><div class="line">    IBinder* target = (IBinder*)</div><div class="line">        env-&gt;GetLongField(obj, gBinderProxyOffsets.mObject);</div><div class="line">    <span class="keyword">status_t</span> err = target-&gt;transact(code, *data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œ <code>gBinderProxyOffsets.mObject</code> åˆ™æ˜¯åœ¨ java å±‚è°ƒç”¨ <code>IBinder.getContextObject()</code> æ—¶åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L580" target="_blank" rel="external">javaObjectForIBinder</a> å‡½æ•°ä¸­è®¾ç½®çš„</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></div><div class="line">&#123;</div><div class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">jobject <span class="title">javaObjectForIBinder</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    LOGDEATH(<span class="string">"objectForBinder %p: created new proxy %p !\n"</span>, val.get(), object);</div><div class="line">    <span class="comment">// The proxy holds a reference to the native object.</span></div><div class="line">    env-&gt;SetLongField(object, gBinderProxyOffsets.mObject, (jlong)val.get());</div><div class="line">    val-&gt;incStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»è¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/ProcessState.cpp#L85" target="_blank" rel="external">ProcessState::getContextObject()</a> å’Œ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/ProcessState.cpp#L220" target="_blank" rel="external">ProcessState::getStrongProxyForHandle()</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">sp&lt;IBinder&gt; ProcessState::getContextObject(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="comment">/*caller*/</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(<span class="keyword">int32_t</span> handle)</div><div class="line">&#123;</div><div class="line">    sp&lt;IBinder&gt; result;</div><div class="line">    ...</div><div class="line">    b = <span class="keyword">new</span> BpBinder(handle);</div><div class="line">    result = b;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯è§ <a href="">android_os_BinderProxy_transact()</a> å‡½æ•°å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/BpBinder.cpp#L159" target="_blank" rel="external">BpBinder::transact()</a> å‡½æ•°ã€‚</p>
<p>5. <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/BpBinder.cpp#L164" target="_blank" rel="external">BpBinder::transact()</a> åˆ™åˆè°ƒç”¨äº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L548" target="_blank" rel="external">IPCThreadState::self()-&gt;transact()</a> å‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> IPCThreadState::transact(<span class="keyword">int32_t</span> handle,</div><div class="line">                                  <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data,</div><div class="line">                                  Parcel* reply, <span class="keyword">uint32_t</span> flags)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">status_t</span> err = data.errorCheck();</div><div class="line"></div><div class="line">    flags |= TF_ACCEPT_FDS;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</div><div class="line">        LOG_ONEWAY(<span class="string">"&gt;&gt;&gt;&gt; SEND from pid %d uid %d %s"</span>, getpid(), getuid(),</div><div class="line">            (flags &amp; TF_ONE_WAY) == <span class="number">0</span> ? <span class="string">"READ REPLY"</span> : <span class="string">"ONE WAY"</span>);</div><div class="line">        err = writeTransactionData(BC_TRANSACTION, flags, handle, code, data, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (reply) &#123;</div><div class="line">            err = waitForResponse(reply);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Parcel fakeReply;</div><div class="line">            err = waitForResponse(&amp;fakeReply);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        err = waitForResponse(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">status_t</span> IPCThreadState::writeTransactionData(<span class="keyword">int32_t</span> cmd, <span class="keyword">uint32_t</span> binderFlags,</div><div class="line">    <span class="keyword">int32_t</span> handle, <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, <span class="keyword">status_t</span>* statusBuffer)</div><div class="line">&#123;</div><div class="line">    binder_transaction_data tr;</div><div class="line"></div><div class="line">    tr.target.ptr = <span class="number">0</span>; <span class="comment">/* Don't pass uninitialized stack data to a remote process */</span></div><div class="line">    tr.target.handle = handle;</div><div class="line">    tr.code = code;</div><div class="line">    ...</div><div class="line"></div><div class="line">    mOut.writeInt32(cmd);</div><div class="line">    mOut.write(&amp;tr, <span class="keyword">sizeof</span>(tr));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NO_ERROR;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±å‡½æ•°å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œ æ•°æ®å†ä¸€æ¬¡é€šè¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L904" target="_blank" rel="external">writeTransactionData()</a> ä¼ é€’ç»™ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L934" target="_blank" rel="external">mOut</a> è¿›è¡Œå†™å…¥æ“ä½œã€‚ <code>mOut</code> æ˜¯ä¸€ä¸ª Parcel å¯¹è±¡ï¼Œ å£°æ˜åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/include/binder/IPCThreadState.h#L123" target="_blank" rel="external">IPCThreadState.h</a> æ–‡ä»¶ä¸­ã€‚ä¹‹ååˆ™è°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L583" target="_blank" rel="external">waitForResponse()</a> å‡½æ•°ã€‚</p>
<p>6. <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L712" target="_blank" rel="external">IPCThreadState::waitForResponse()</a> åœ¨ä¸€ä¸ª <code>while</code> å¾ªç¯é‡Œä¸æ–­çš„è°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L803" target="_blank" rel="external">talkWithDriver()</a> å¹¶æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è¿”å›ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">uint32_t</span> cmd;</div><div class="line">    <span class="keyword">int32_t</span> err;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</div><div class="line">        ...</div><div class="line"></div><div class="line">        cmd = (<span class="keyword">uint32_t</span>)mIn.readInt32();</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">        <span class="keyword">case</span> BR_TRANSACTION_COMPLETE:</div><div class="line">            ...</div><div class="line"></div><div class="line">        <span class="keyword">case</span> BR_REPLY:</div><div class="line">            &#123;</div><div class="line">                binder_transaction_data tr;</div><div class="line">                err = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));</div><div class="line">                ALOG_ASSERT(err == NO_ERROR, <span class="string">"Not enough command data for brREPLY"</span>);</div><div class="line">                <span class="keyword">if</span> (err != NO_ERROR) <span class="keyword">goto</span> finish;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (reply) &#123;</div><div class="line">                    <span class="keyword">if</span> ((tr.flags &amp; TF_STATUS_CODE) == <span class="number">0</span>) &#123;</div><div class="line">                        reply-&gt;ipcSetDataReference(</div><div class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</div><div class="line">                            tr.data_size,</div><div class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">binder_size_t</span>*&gt;(tr.data.ptr.offsets),</div><div class="line">                            tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>),</div><div class="line">                            freeBuffer, <span class="keyword">this</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        err = *<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">status_t</span>*&gt;(tr.data.ptr.buffer);</div><div class="line">                        freeBuffer(<span class="literal">NULL</span>,</div><div class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</div><div class="line">                            tr.data_size,</div><div class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">binder_size_t</span>*&gt;(tr.data.ptr.offsets),</div><div class="line">                            tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>), <span class="keyword">this</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    freeBuffer(<span class="literal">NULL</span>,</div><div class="line">                        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</div><div class="line">                        tr.data_size,</div><div class="line">                        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">binder_size_t</span>*&gt;(tr.data.ptr.offsets),</div><div class="line">                        tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>), <span class="keyword">this</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">goto</span> finish;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            err = executeCommand(cmd);</div><div class="line">            <span class="keyword">if</span> (err != NO_ERROR) <span class="keyword">goto</span> finish;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7. <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L803" target="_blank" rel="external">IPCThreadState::talkWithDriver()</a> å‡½æ•°æ˜¯çœŸæ­£ä¸ binder é©±åŠ¨äº¤äº’çš„å®ç°ã€‚<a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L856" target="_blank" rel="external">ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)</a> å°±æ˜¯ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•° <code>ioctl</code> å‘ binder è®¾å¤‡æ–‡ä»¶ <code>/dev/binder</code> å‘é€ <code>BINDER_WRITE_READ</code> å‘½ä»¤ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> -EBADF;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binder_write_read bwr;</div><div class="line"></div><div class="line">    <span class="comment">// Is the read buffer empty?</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</div><div class="line"></div><div class="line">    <span class="comment">// We don't want to write anything if we are still reading</span></div><div class="line">    <span class="comment">// from data left in the input buffer and the caller</span></div><div class="line">    <span class="comment">// has requested to read the next data.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</div><div class="line"></div><div class="line">    bwr.write_size = outAvail;</div><div class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>)mOut.data();</div><div class="line"></div><div class="line">    <span class="comment">// This is what we'll read.</span></div><div class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</div><div class="line">        bwr.read_size = mIn.dataCapacity();</div><div class="line">        bwr.read_buffer = (<span class="keyword">uintptr_t</span>)mIn.data();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        bwr.read_size = <span class="number">0</span>;</div><div class="line">        bwr.read_buffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Return immediately if there is nothing to do.</span></div><div class="line">    <span class="keyword">if</span> ((bwr.write_size == <span class="number">0</span>) &amp;&amp; (bwr.read_size == <span class="number">0</span>)) <span class="keyword">return</span> NO_ERROR;</div><div class="line"></div><div class="line">    bwr.write_consumed = <span class="number">0</span>;</div><div class="line">    bwr.read_consumed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">status_t</span> err;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(HAVE_ANDROID_OS)</span></div><div class="line">        <span class="comment">// ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ ioctl å‘ /dev/binder å‘é€ BINDER_WRITE_READ å‘½ä»¤</span></div><div class="line">        <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</div><div class="line">            err = NO_ERROR;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            err = -errno;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        err = INVALID_OPERATION;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="number">0</span>) &#123;</div><div class="line">            err = -EBADF;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (err == -EINTR);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err &gt;= NO_ERROR) &#123;</div><div class="line">        <span class="keyword">if</span> (bwr.write_consumed &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (bwr.write_consumed &lt; mOut.dataSize())</div><div class="line">                mOut.remove(<span class="number">0</span>, bwr.write_consumed);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                mOut.setDataSize(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (bwr.read_consumed &gt; <span class="number">0</span>) &#123;</div><div class="line">            mIn.setDataSize(bwr.read_consumed);</div><div class="line">            mIn.setDataPosition(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> NO_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»è¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L718" target="_blank" rel="external">IPCThreadState::talkWithDriver()</a> ,å°±å°†æ•°æ®å‘é€ç»™äº† Binder é©±åŠ¨ã€‚</p>
<p>ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L723" target="_blank" rel="external">IPCThreadState::waitForResponse()</a> ï¼Œå¯ä»¥ä» ç¬¬6æ­¥ å‘ç° <code>IPCThreadState</code> ä¸æ–­çš„å¾ªç¯è¯»å– Binder é©±åŠ¨è¿”å›ï¼Œè·å–åˆ°è¿”å›å‘½ä»¤åæ‰§è¡Œäº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L787" target="_blank" rel="external">executeCommand(cmd)</a> å‡½æ•°ã€‚</p>
<p>8. <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L947" target="_blank" rel="external">IPCThreadState::executeCommand()</a> å¤„ç† Binder é©±åŠ¨è¿”å›å‘½ä»¤</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> IPCThreadState::executeCommand(<span class="keyword">int32_t</span> cmd)</div><div class="line">&#123;</div><div class="line">    BBinder* obj;</div><div class="line">    RefBase::weakref_type* refs;</div><div class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> ((<span class="keyword">uint32_t</span>)cmd) &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">case</span> BR_TRANSACTION:</div><div class="line">        &#123;</div><div class="line">            binder_transaction_data tr;</div><div class="line">            result = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));</div><div class="line">            ...</div><div class="line">            Parcel buffer;</div><div class="line">            buffer.ipcSetDataReference(</div><div class="line">                <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</div><div class="line">                tr.data_size,</div><div class="line">                <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">binder_size_t</span>*&gt;(tr.data.ptr.offsets),</div><div class="line">                tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">binder_size_t</span>), freeBuffer, <span class="keyword">this</span>);</div><div class="line">            ...</div><div class="line"></div><div class="line">            Parcel reply;</div><div class="line">            <span class="keyword">status_t</span> error;</div><div class="line">            <span class="keyword">if</span> (tr.target.ptr) &#123;</div><div class="line">                sp&lt;BBinder&gt; b((BBinder*)tr.cookie);</div><div class="line">                error = b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                error = the_context_object-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>9. å¯ä»¥çœ‹å‡ºå…¶è°ƒç”¨äº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L1085#L1091" target="_blank" rel="external">BBinder::transact()</a> å‡½æ•°ï¼Œå°†æ•°æ®è¿”å›ç»™ä¸Šå±‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> BBinder::transact(</div><div class="line">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</div><div class="line">&#123;</div><div class="line">    data.setDataPosition(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">status_t</span> err = NO_ERROR;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        <span class="keyword">case</span> PING_TRANSACTION:</div><div class="line">            reply-&gt;writeInt32(pingBinder());</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            err = onTransact(code, data, reply, flags);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (reply != <span class="literal">NULL</span>) &#123;</div><div class="line">        reply-&gt;setDataPosition(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>10. è€Œè¿™é‡Œçš„ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L1085#L1091" target="_blank" rel="external">b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags)</a> ä¸­çš„ <code>b (BBinder)</code> æ˜¯ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L217" target="_blank" rel="external">JavaBBinder</a> çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L247" target="_blank" rel="external">JavaBBinder::onTransact()</a> å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// frameworks/base/core/jni/android_util_Binder.cpp</span></div><div class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">onTransact</span><span class="params">(</span></span></div><div class="line">        <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        JNIEnv* env = javavm_to_jnienv(mVM);</div><div class="line">        ...</div><div class="line">        jboolean res = env-&gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact,</div><div class="line">            code, <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(&amp;data), <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(reply), flags);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    gBinderOffsets.mExecTransact = GetMethodIDOrDie(env, clazz, <span class="string">"execTransact"</span>, <span class="string">"(IJJI)Z"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>11. å¯è§ JNI é€šè¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L260" target="_blank" rel="external">gBinderOffsets.mExecTransact</a> æœ€åæ‰§è¡Œäº† <code>android.os.Binder</code> çš„ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/jni/android_util_Binder.cpp#L865" target="_blank" rel="external">execTransact()</a> æ–¹æ³•ã€‚</p>
<p><a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/Binder.java#L442" target="_blank" rel="external">execTransact()</a> æ–¹æ³•æ˜¯ jni å›è°ƒçš„å…¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Entry point from android_util_Binder.cpp's onTransact</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execTransact</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">long</span> dataObj, <span class="keyword">long</span> replyObj,</span></span></div><div class="line">            <span class="keyword">int</span> flags) &#123;</div><div class="line">        Parcel data = Parcel.obtain(dataObj);</div><div class="line">        Parcel reply = Parcel.obtain(replyObj);</div><div class="line">        ...</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            res = onTransact(code, data, reply, flags);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>12. è€Œæˆ‘ä»¬åˆ™åœ¨æœåŠ¡ç«¯ <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L19" target="_blank" rel="external">IRemoteService.Stub</a> é‡è½½äº† <a href="https://github.com/xdtianyu/AidlExample/blob/master/app/build/generated/source/aidl/debug/org/xdty/remoteservice/IRemoteService.java#L51" target="_blank" rel="external">onTransact()</a> æ–¹æ³•ï¼Œæ‰€ä»¥æ•°æ®æœ€åä¼šå›åˆ°æˆ‘ä»¬çš„æœåŠ¡ç«¯å¹¶æ‰§è¡ŒæœåŠ¡ç«¯å®ç°çš„ <code>addUser()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">xdty</span>.<span class="title">remoteservice</span>.<span class="title">IRemoteService</span> &#123;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">            <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        <span class="keyword">switch</span> (code) &#123;</div><div class="line">            <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</div><div class="line">                reply.writeString(DESCRIPTOR);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> TRANSACTION_basicTypes: &#123;</div><div class="line">                ...</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">                data.enforceInterface(DESCRIPTOR);</div><div class="line">                org.xdty.remoteservice.User _arg0;</div><div class="line">                <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                    _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    _arg0 = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">                reply.writeNoException();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¿‡ç¨‹å°±æ˜¯æ‰€æœ‰çš„ Native å±‚å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ å®¢æˆ·ç«¯è¿›ç¨‹å‘é€ <code>BC_TRANSACTION</code> åˆ° Binder é©±åŠ¨ï¼ŒæœåŠ¡ç«¯è¿›ç¨‹ç›‘å¬è¿”å›çš„ <code>BR_TRANSACTION</code> å‘½ä»¤å¹¶å¤„ç†ã€‚å¦‚æœæ˜¯æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ï¼Œç±»ä¼¼çš„æ˜¯æœåŠ¡ç«¯å‘é€ <code>BC_REPLY</code> å‘½ä»¤ï¼Œ å®¢æˆ·ç«¯ç›‘å¬ <code>BR_REPLY</code> å‘½ä»¤ã€‚</p>
<h3 id="3-3-Binder-è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€å’Œè¯»å†™"><a href="#3-3-Binder-è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€å’Œè¯»å†™" class="headerlink" title="3.3 Binder è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€å’Œè¯»å†™"></a>3.3 Binder è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€å’Œè¯»å†™</h3><p><strong>1. è®¾å¤‡çš„æ‰“å¼€</strong></p>
<p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­æˆ‘ä»¬çœ‹åˆ° JNI è¿‡ç¨‹ä¸­è°ƒç”¨äº† <code>ProcessState::getContextObject()</code> å‡½æ•°ï¼Œ åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/ProcessState.cpp#L340" target="_blank" rel="external">ProcessState</a> åˆå§‹åŒ–æ—¶ä¼šæ‰“å¼€ binder è®¾å¤‡</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ProcessState.cpp</span></div><div class="line">ProcessState::ProcessState()</div><div class="line">    : mDriverFD(open_driver())</div><div class="line">    ...</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/ProcessState.cpp#L311#L337" target="_blank" rel="external">open_driver()</a> å‡½æ•°å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ProcessState.cpp</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_driver</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// æ‰“å¼€è®¾å¤‡æ–‡ä»¶</span></div><div class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/binder"</span>, O_RDWR);</div><div class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</div><div class="line">        fcntl(fd, F_SETFD, FD_CLOEXEC);</div><div class="line">        <span class="keyword">int</span> vers = <span class="number">0</span>;</div><div class="line">        <span class="comment">// è·å–é©±åŠ¨ç‰ˆæœ¬</span></div><div class="line">        <span class="keyword">status_t</span> result = ioctl(fd, BINDER_VERSION, &amp;vers);</div><div class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder ioctl to obtain version failed: %s"</span>, strerror(errno));</div><div class="line">            close(fd);</div><div class="line">            fd = <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ£€æŸ¥é©±åŠ¨ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´</span></div><div class="line">        <span class="keyword">if</span> (result != <span class="number">0</span> || vers != BINDER_CURRENT_PROTOCOL_VERSION) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder driver protocol does not match user space protocol!"</span>);</div><div class="line">            close(fd);</div><div class="line">            fd = <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½®æœ€å¤š 15 ä¸ª binder çº¿ç¨‹</span></div><div class="line">        <span class="keyword">size_t</span> maxThreads = DEFAULT_MAX_BINDER_THREADS;</div><div class="line">        result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</div><div class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder ioctl to set max threads failed: %s"</span>, strerror(errno));</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ALOGW(<span class="string">"Opening '/dev/binder' failed: %s\n"</span>, strerror(errno));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> fd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2. è®¾å¤‡çš„è¯»å†™</strong></p>
<p>æ‰“å¼€è®¾å¤‡æ–‡ä»¶åï¼Œæ–‡ä»¶æè¿°ç¬¦è¢«ä¿å­˜åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/ProcessState.cpp#L340" target="_blank" rel="external">mDriverFD</a>ï¼Œ é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>ioctl</code> å‡½æ•°æ“ä½œ <code>mDriverFD</code> å°±å¯ä»¥å®ç°å’Œ binder é©±åŠ¨çš„äº¤äº’ã€‚</p>
<p>å¯¹ Binder è®¾å¤‡æ–‡ä»¶çš„æ‰€æœ‰è¯»å†™åŠå…³é—­æ“ä½œåˆ™éƒ½åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L805" target="_blank" rel="external">IPCThreadState</a> ä¸­ï¼Œå¦‚ä¸Šä¸€å°èŠ‚æåŠåˆ°çš„ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L803" target="_blank" rel="external">IPCThreadState::talkWithDriver</a> å‡½æ•°</p>
<p><code>talkWithDriver()</code> å‡½æ•°å°è£…äº† <code>BINDER_WRITE_READ</code> å‘½ä»¤ï¼Œä¼šä» binder é©±åŠ¨è¯»å–æˆ–å†™å…¥å°è£…åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L856" target="_blank" rel="external">binder_write_read</a> ç»“æ„ä½“ä¸­çš„æœ¬åœ°æˆ–è¿œç¨‹å¯¹è±¡ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IPCThreadState.cpp</span></div><div class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</div><div class="line">&#123;   </div><div class="line">    binder_write_read bwr;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></div><div class="line">    bwr.write_size = outAvail;</div><div class="line">    bwr.write_buffer = (<span class="keyword">uintptr_t</span>)mOut.data();</div><div class="line"></div><div class="line">    <span class="comment">// è¯»å–æ•°æ®</span></div><div class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</div><div class="line">        bwr.read_size = mIn.dataCapacity();</div><div class="line">        bwr.read_buffer = (<span class="keyword">uintptr_t</span>)mIn.data();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        bwr.read_size = <span class="number">0</span>;</div><div class="line">        bwr.read_buffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// ä½¿ç”¨ ioctl ç³»ç»Ÿè°ƒç”¨å‘é€ BINDER_WRITE_READ å‘½ä»¤åˆ° biner é©±åŠ¨</span></div><div class="line">    <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</div><div class="line">        err = NO_ERROR;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œæœ¬åœ°å±‚æ˜¯å¯¹åº”ç”¨ä¸ binder é©±åŠ¨äº¤äº’çš„ç›´æ¥å°è£…ä¸å®ç°ï¼Œæœ€ç»ˆçš„æ•°æ®ä¼ è¾“ä»æ˜¯ç”±é©±åŠ¨æ¥å®Œæˆçš„ã€‚æœ¬åœ°å±‚å¯¹åº•å±‚é©±åŠ¨è¿›è¡Œäº†å®Œæ•´çš„å°è£…ï¼Œä¸Šå±‚åº”ç”¨åªå…³å¿ƒ transact() å’Œ onTransact() å›è°ƒï¼Œå¯Ÿè§‰ä¸åˆ° binder é©±åŠ¨çš„å­˜åœ¨ï¼Œå‡è½»äº†ä¸Šå±‚åº”ç”¨è¿›ç¨‹é—´é€šä¿¡å¼€å‘çš„å¤æ‚åº¦ã€‚</p>
<h2 id="4-Binder-é©±åŠ¨"><a href="#4-Binder-é©±åŠ¨" class="headerlink" title="4. Binder é©±åŠ¨"></a>4. Binder é©±åŠ¨</h2><p>å…³äº binder é©±åŠ¨å»ºè®®å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  <a href="http://blog.csdn.net/yangwen123/article/details/9316987" target="_blank" rel="external">æ·±å…¥åˆ†æAndroid Binder é©±åŠ¨</a> <a href="[Android Binder](https://web.archive.org/web/20101016004342/http://www.gmier.com/node/11">åŸæ–‡</a>ï¼Œæœ¬å°èŠ‚ä»éœ€è¦å®Œå–„ã€‚</p>
<p>Binder é©±åŠ¨æ˜¯ Binder çš„æœ€ç»ˆå®ç°ï¼Œ ServiceManager å’Œ Client/Service è¿›ç¨‹é—´é€šä¿¡æœ€ç»ˆéƒ½æ˜¯ç”± Binder é©±åŠ¨æŠ•é€’çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xdtianyu/SourceAnalysis/master/art/binder_reference.png" alt="Binder reference"></p>
<p>Binder é©±åŠ¨çš„ä»£ç ä½äº kernel ä»£ç çš„ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/tree/master/drivers/staging/android" target="_blank" rel="external">drivers/staging/android</a> ç›®å½•ä¸‹ã€‚ä¸»æ–‡ä»¶æ˜¯ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h" target="_blank" rel="external">binder.h</a> å’Œ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c" target="_blank" rel="external">binder.c</a></p>
<p>è¿›ç¨‹é—´ä¼ è¾“çš„æ•°æ®è¢«ç§°ä¸º Binder å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ª <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L49" target="_blank" rel="external">flat_binder_object</a>ï¼Œç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> &#123;</span></div><div class="line">    <span class="comment">/* 8 bytes for large_flat_header. */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>       type;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>       flags;</div><div class="line"></div><div class="line">    <span class="comment">/* 8 bytes of data. */</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">void</span>        *binder;    <span class="comment">/* local object */</span></div><div class="line">        <span class="keyword">signed</span> <span class="keyword">long</span> handle;     <span class="comment">/* remote object */</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/* extra data associated with local object */</span></div><div class="line">    <span class="keyword">void</span>            *cookie;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ ç±»å‹ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L29" target="_blank" rel="external">type</a> æè¿°äº† Binder å¯¹è±¡çš„ç±»å‹ï¼ŒåŒ…å« <code>BINDER</code>(æœ¬åœ°å¯¹è±¡)ã€<code>HANDLE</code>(è¿œç¨‹å¯¹è±¡)ã€ <code>FD</code> ä¸‰å¤§ç±»(äº”ç§)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    BINDER_TYPE_BINDER  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_BINDER = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_HANDLE  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_HANDLE = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_FD      = B_PACK_CHARS(<span class="string">'f'</span>, <span class="string">'d'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L52" target="_blank" rel="external">flags</a> åˆ™è¡¨è¿°äº†<a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L110" target="_blank" rel="external">ä¼ è¾“æ–¹å¼</a>ï¼Œå¦‚å¼‚æ­¥ã€æ— è¿”å›ç­‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> transaction_flags &#123;</div><div class="line">    TF_ONE_WAY  = <span class="number">0x01</span>, <span class="comment">/* this is a one-way call: async, no return */</span></div><div class="line">    TF_ROOT_OBJECT  = <span class="number">0x04</span>, <span class="comment">/* contents are the component's root object */</span></div><div class="line">    TF_STATUS_CODE  = <span class="number">0x08</span>, <span class="comment">/* contents are a 32-bit status code */</span></div><div class="line">    TF_ACCEPT_FDS   = <span class="number">0x10</span>, <span class="comment">/* allow replies with file descriptors */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è€Œ <code>flat_binder_object</code> ä¸­çš„ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L55" target="_blank" rel="external">union è”åˆä½“</a> å°±æ˜¯è¦ä¼ è¾“çš„æ•°æ®ï¼Œå½“ç±»å‹ä¸º <code>BINDER</code> æ—¶ï¼Œ æ•°æ®å°±æ˜¯ä¸€ä¸ªæœ¬åœ°å¯¹è±¡ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L56" target="_blank" rel="external">*binder</a>ï¼Œè€Œç±»å‹ä¸º <code>HANDLE</code> æ—¶ï¼Œæ•°æ®åˆ™æ˜¯ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L57" target="_blank" rel="external">handle</a>ã€‚</p>
<p>å½“ <code>flat_binder_object</code> åœ¨è¿›ç¨‹é—´ä¼ é€’æ—¶ï¼Œ Binder é©±åŠ¨ä¼šä¿®æ”¹å®ƒçš„ç±»å‹å’Œæ•°æ®ï¼Œäº¤æ¢çš„ä»£ç å‚è€ƒ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L1671" target="_blank" rel="external">binder_transaction</a> çš„å®ç°ã€‚</p>
<p>è¯¥å¦‚ä½•ç†è§£æœ¬åœ° <code>BINDER</code> å¯¹è±¡å’Œè¿œç¨‹ <code>HANDLE</code> å¯¹è±¡å‘¢ï¼Ÿå…¶å®å®ƒä»¬éƒ½ä»£è¡¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸è¿‡æ˜¯ä»ä¸åŒçš„è§’åº¦æ¥çœ‹ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡å¦‚è¿›ç¨‹ <code>RemoteService</code> æœ‰ä¸ªå¯¹è±¡ <a href="https://github.com/xdtianyu/AidlExample/blob/master/remoteservice/src/main/java/org/xdty/remoteservice/RemoteService.java#L11" target="_blank" rel="external">mBinder</a>ï¼Œå¯¹äº <code>RemoteService</code> æ¥è¯´ï¼Œ<code>mBinder</code> å°±æ˜¯ä¸€ä¸ªæœ¬åœ°çš„ <code>BINDER</code> å¯¹è±¡ï¼›å¦‚æœè¿›ç¨‹ <code>app</code> é€šè¿‡ Binder é©±åŠ¨è®¿é—® <code>RemoteService</code> çš„ <code>mBinder</code> å¯¹è±¡ï¼Œå¯¹äº <code>app</code> æ¥è¯´ï¼Œ <code>mBinder</code> å°±æ˜¯ä¸€ä¸ª <code>HANDLE</code>ã€‚å› æ­¤ï¼Œä»æ ¹æœ¬ä¸Šæ¥è¯´ <code>handle</code> å’Œ <code>binder</code> éƒ½æŒ‡å‘ <code>RemoteService</code> çš„ <code>mBinder</code>ã€‚æœ¬åœ°å¯¹è±¡è¿˜å¯ä»¥å¸¦æœ‰é¢å¤–çš„æ•°æ®ï¼Œä¿å­˜åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L61" target="_blank" rel="external">cookie</a> ä¸­ã€‚</p>
<p>Binder é©±åŠ¨ç›´æ¥æ“ä½œçš„æœ€å¤–å±‚æ•°æ®ç»“æ„æ˜¯ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L117" target="_blank" rel="external">binder_transaction_data</a>ï¼Œ Binder å¯¹è±¡ <code>flat_binder_object</code> è¢«å°è£…åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L142" target="_blank" rel="external">binder_transaction_data</a> ç»“æ„ä½“ä¸­ã€‚</p>
<p><code>binder_transaction_data</code> æ•°æ®ç»“æ„æ‰æ˜¯çœŸæ­£ä¼ è¾“çš„æ•°æ®ï¼Œå…¶å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> &#123;</span></div><div class="line">    <span class="comment">/* The first two are only used for bcTRANSACTION and brTRANSACTION,</span></div><div class="line">     * identifying the target and contents of the transaction.</div><div class="line">     */</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">size_t</span>  handle; <span class="comment">/* target descriptor of command transaction */</span></div><div class="line">        <span class="keyword">void</span>    *ptr;   <span class="comment">/* target descriptor of return transaction */</span></div><div class="line">    &#125; target;</div><div class="line">    <span class="keyword">void</span>        *cookie;    <span class="comment">/* target object cookie */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    code;       <span class="comment">/* transaction command */</span></div><div class="line"></div><div class="line">    <span class="comment">/* General information about the transaction. */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    flags;</div><div class="line">    <span class="keyword">pid_t</span>       sender_pid;</div><div class="line">    <span class="keyword">uid_t</span>       sender_euid;</div><div class="line">    <span class="keyword">size_t</span>      data_size;  <span class="comment">/* number of bytes of data */</span></div><div class="line">    <span class="keyword">size_t</span>      offsets_size;   <span class="comment">/* number of bytes of offsets */</span></div><div class="line"></div><div class="line">    <span class="comment">/* If this transaction is inline, the data immediately</span></div><div class="line">     * follows here; otherwise, it ends with a pointer to</div><div class="line">     * the data buffer.</div><div class="line">     */</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            <span class="comment">/* transaction data */</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">void</span>  *buffer;</div><div class="line">            <span class="comment">/* offsets from buffer to flat_binder_object structs */</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">void</span>  *offsets;</div><div class="line">        &#125; ptr;</div><div class="line">        <span class="keyword">uint8_t</span> buf[<span class="number">8</span>];</div><div class="line">    &#125; data;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>flat_binder_object</code> å°±è¢«å°è£…åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L142" target="_blank" rel="external">*buffer</a>ä¸­ï¼Œå…¶ä¸­çš„ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L126" target="_blank" rel="external">unsigned int   code;</a> åˆ™æ˜¯ä¼ è¾“å‘½ä»¤ï¼Œæè¿°äº† Binder å¯¹è±¡æ‰§è¡Œçš„æ“ä½œã€‚</p>
<h3 id="4-1-binder-è®¾å¤‡çš„åˆ›å»º"><a href="#4-1-binder-è®¾å¤‡çš„åˆ›å»º" class="headerlink" title="4.1 binder è®¾å¤‡çš„åˆ›å»º"></a>4.1 binder è®¾å¤‡çš„åˆ›å»º</h3><p><a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3747" target="_blank" rel="external">device_initcall()</a> å‡½æ•°æ˜¯å†…æ ¸åŠ è½½é©±åŠ¨çš„å…¥å£å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">binder_miscdev</span> = &#123;</span></div><div class="line">    .minor = MISC_DYNAMIC_MINOR,</div><div class="line">    <span class="comment">// è®¾å¤‡æ–‡ä»¶ /dev/binder</span></div><div class="line">    .name = <span class="string">"binder"</span>,</div><div class="line">    <span class="comment">// è®¾å¤‡æ–‡ä»¶æ“ä½œ</span></div><div class="line">    .fops = &amp;binder_fops</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">binder_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    ...</div><div class="line">    <span class="comment">// æ³¨å†Œå­—ç¬¦è®¾å¤‡</span></div><div class="line">    ret = misc_register(&amp;binder_miscdev);</div><div class="line">    ...</div><div class="line">    <span class="comment">// è°ƒè¯•æ–‡ä»¶ï¼Œ åœ¨ /sys/kernel/debug/binder ç›®å½•ä¸‹</span></div><div class="line">    <span class="keyword">if</span> (binder_debugfs_dir_entry_root) &#123;</div><div class="line">        debugfs_create_file(<span class="string">"state"</span>,</div><div class="line">                    S_IRUGO,</div><div class="line">                    binder_debugfs_dir_entry_root,</div><div class="line">                    <span class="literal">NULL</span>,</div><div class="line">                    &amp;binder_state_fops);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">device_initcall(binder_init);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3704" target="_blank" rel="external">binder_init()</a> ä½¿ç”¨ <code>misc_register()</code> å‡½æ•°åˆ›å»ºäº† binder è®¾å¤‡ã€‚ä» <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3716" target="_blank" rel="external">misc_register(&amp;binder_miscdev);</a> åŠ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3695" target="_blank" rel="external">.name = â€œbinderâ€</a> å¯ä»¥çœ‹å‡ºï¼Œ binder å‘ kernel æ³¨å†Œäº†ä¸€ä¸ª <code>/dev/binder</code> çš„å­—ç¬¦è®¾å¤‡ï¼Œè€Œæ–‡ä»¶æ“ä½œéƒ½åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3683" target="_blank" rel="external">binder_fops</a> ç»“æ„ä½“ä¸­å®šä¹‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">binder_fops</span> = &#123;</span></div><div class="line">    .owner = THIS_MODULE,</div><div class="line">    .poll = binder_poll,</div><div class="line">    .unlocked_ioctl = binder_ioctl,</div><div class="line">    .mmap = binder_mmap,</div><div class="line">    .open = binder_open,</div><div class="line">    .flush = binder_flush,</div><div class="line">    .release = binder_release,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ <code>binder_fops</code> ç»“æ„ä½“å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„æ“ä½œæ˜¯ <code>binder_ioctl()</code> <code>binder_mmap()</code> <code>binder_open()</code> ç­‰å‡½æ•°å®ç°çš„ã€‚</p>
<h3 id="4-2-binder-åè®®å’Œæ•°æ®ç»“æ„"><a href="#4-2-binder-åè®®å’Œæ•°æ®ç»“æ„" class="headerlink" title="4.2 binder åè®®å’Œæ•°æ®ç»“æ„"></a>4.2 binder åè®®å’Œæ•°æ®ç»“æ„</h3><p><a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h" target="_blank" rel="external">binder.h</a> æ–‡ä»¶ä¸­å®šä¹‰äº† binder åè®®å’Œé‡è¦çš„æ•°æ®ç»“æ„ã€‚</p>
<p>é¦–å…ˆåœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L29" target="_blank" rel="external">enum</a> ä¸­å®šä¹‰äº† binder å¤„ç†çš„ç±»å‹ï¼Œå¼•ç”¨æˆ–æ˜¯å¥æŸ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    BINDER_TYPE_BINDER  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_BINDER = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_HANDLE  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_HANDLE = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_FD      = B_PACK_CHARS(<span class="string">'f'</span>, <span class="string">'d'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ä¸‹é¢è¿™æ®µå®å®šä¹‰åˆ™æ˜¯åœ¨ <code>ioctl</code> å‡½æ•°è°ƒç”¨æ—¶å¯ç”¨çš„å…·ä½“å‘½ä»¤ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_WRITE_READ       _IOWR(<span class="meta-string">'b'</span>, 1, struct binder_write_read)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_IDLE_TIMEOUT     _IOW(<span class="meta-string">'b'</span>, 3, int64_t)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_MAX_THREADS      _IOW(<span class="meta-string">'b'</span>, 5, size_t)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_IDLE_PRIORITY    _IOW(<span class="meta-string">'b'</span>, 6, int)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_CONTEXT_MGR      _IOW(<span class="meta-string">'b'</span>, 7, int)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_THREAD_EXIT      _IOW(<span class="meta-string">'b'</span>, 8, int)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_VERSION          _IOWR(<span class="meta-string">'b'</span>, 9, struct binder_version)</span></div></pre></td></tr></table></figure>
<p>åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L166" target="_blank" rel="external">BinderDriverReturnProtocol</a> å’Œ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L254" target="_blank" rel="external">BinderDriverCommandProtocol</a> ä¸­ åˆ™åˆ†åˆ«å®šä¹‰äº† å®¢æˆ·ç«¯è°ƒç”¨ å’Œ æœåŠ¡ç«¯ è¿”å›çš„å‘½ä»¤ã€‚</p>
<h3 id="4-3-binder-é©±åŠ¨æ–‡ä»¶æ“ä½œ"><a href="#4-3-binder-é©±åŠ¨æ–‡ä»¶æ“ä½œ" class="headerlink" title="4.3 binder é©±åŠ¨æ–‡ä»¶æ“ä½œ"></a>4.3 binder é©±åŠ¨æ–‡ä»¶æ“ä½œ</h3><p>ä¸Šæ–‡å·²ç»æåˆ°ï¼Œæ‰€æœ‰çš„æ“ä½œå®šä¹‰åœ¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3683" target="_blank" rel="external">binder_fops</a> ç»“æ„ä½“ä¸­ï¼Œä¸‹é¢è®²è¿°è¿™äº›æ“ä½œã€‚</p>
<p><strong>è®¾å¤‡çš„æ‰“å¼€ - binder_open() å‡½æ•°</strong></p>
<p>ç”¨æˆ·ç©ºé—´åœ¨æ‰“å¼€ <code>/dev/binder</code> è®¾å¤‡æ—¶ï¼Œé©±åŠ¨ä¼šå‡ºå‘ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3004" target="_blank" rel="external">binder_open()</a> å‡½æ•°çš„å“åº”ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_open</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// åˆ†é… binder_proc æ•°æ®ç»“æ„å†…å­˜</span></div><div class="line">    proc = kzalloc(<span class="keyword">sizeof</span>(*proc), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (proc == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> -ENOMEM;</div><div class="line"></div><div class="line">    <span class="comment">// å¢åŠ å½“å‰çº¿ç¨‹/è¿›ç¨‹çš„å¼•ç”¨è®¡æ•°å¹¶èµ‹å€¼ç»™tsk</span></div><div class="line">    get_task_struct(current);</div><div class="line">    proc-&gt;tsk = current;</div><div class="line">    <span class="comment">// åˆå§‹åŒ–é˜Ÿåˆ—</span></div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;todo);</div><div class="line">    init_waitqueue_head(&amp;proc-&gt;wait);</div><div class="line">    proc-&gt;default_priority = task_nice(current);</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line"></div><div class="line">    <span class="comment">// å¢åŠ BINDER_STAT_PROCçš„å¯¹è±¡è®¡æ•°</span></div><div class="line">    binder_stats_created(BINDER_STAT_PROC);</div><div class="line">    <span class="comment">// æ·»åŠ  proc_node åˆ° binder_procs å…¨å±€åˆ—è¡¨ä¸­ï¼Œè¿™æ ·ä»»ä½•è¿›ç¨‹å°±å¯ä»¥è®¿é—®åˆ°å…¶ä»–è¿›ç¨‹çš„ binder_proc å¯¹è±¡äº†</span></div><div class="line">    hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs);</div><div class="line">    <span class="comment">// ä¿å­˜è¿›ç¨‹ id</span></div><div class="line">    proc-&gt;pid = current-&gt;group_leader-&gt;pid;</div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;delivered_death);</div><div class="line">    <span class="comment">// é©±åŠ¨æ–‡ä»¶ private_data æŒ‡å‘ proc</span></div><div class="line">    filp-&gt;private_data = proc;</div><div class="line"></div><div class="line">    binder_unlock(__func__);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>é©±åŠ¨æ–‡ä»¶é‡Šæ”¾ - binder_release() å‡½æ•°</strong></p>
<p>åœ¨ç”¨æˆ·ç©ºé—´å…³é—­é©±åŠ¨è®¾å¤‡æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L3068" target="_blank" rel="external">binder_release()</a> å‡½æ•°ï¼Œæ¸…ç† binder_proc å¯¹è±¡ï¼Œé‡Šæ”¾å ç”¨çš„å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_release</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></div><div class="line">    binder_defer_work(proc, BINDER_DEFERRED_RELEASE);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">binder_defer_work</span><span class="params">(struct binder_proc *proc, <span class="keyword">enum</span> binder_deferred_state defer)</span></div><div class="line">&#123;</div><div class="line">    mutex_lock(&amp;binder_deferred_lock);</div><div class="line">    proc-&gt;deferred_work |= defer;</div><div class="line">    <span class="keyword">if</span> (hlist_unhashed(&amp;proc-&gt;deferred_work_node)) &#123;</div><div class="line">        <span class="comment">// æ·»åŠ åˆ°é‡Šæ”¾é˜Ÿåˆ—ä¸­</span></div><div class="line">        hlist_add_head(&amp;proc-&gt;deferred_work_node,</div><div class="line">                &amp;binder_deferred_list);</div><div class="line">        queue_work(binder_deferred_workqueue, &amp;binder_deferred_work);</div><div class="line">    &#125;</div><div class="line">    mutex_unlock(&amp;binder_deferred_lock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>å†…å­˜æ˜ å°„ - binder_mmap() å‡½æ•°</strong></p>
<p><a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L2905" target="_blank" rel="external">binder_mmap()</a> å‡½æ•°æŠŠè®¾å¤‡å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åƒæ“ä½œç”¨æˆ·å†…å­˜é‚£æ ·æ“ä½œè®¾å¤‡å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_mmap</span><span class="params">(struct file *filp, struct vm_area_struct *vma)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_struct</span> *<span class="title">area</span>;</span></div><div class="line">    <span class="comment">// è·å¾— binder_proc å¯¹è±¡</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *failure_string;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> *<span class="title">buffer</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// æœ€å¤šåªåˆ†é… 4M çš„å†…å­˜</span></div><div class="line">    <span class="keyword">if</span> ((vma-&gt;vm_end - vma-&gt;vm_start) &gt; SZ_4M)</div><div class="line">        vma-&gt;vm_end = vma-&gt;vm_start + SZ_4M;</div><div class="line"></div><div class="line">    <span class="comment">// æ£€æŸ¥ flags</span></div><div class="line">    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; FORBIDDEN_MMAP_FLAGS) &#123;</div><div class="line">        ret = -EPERM;</div><div class="line">        failure_string = <span class="string">"bad vm_flags"</span>;</div><div class="line">        <span class="keyword">goto</span> err_bad_arg;</div><div class="line">    &#125;</div><div class="line">    vma-&gt;vm_flags = (vma-&gt;vm_flags | VM_DONTCOPY) &amp; ~VM_MAYWRITE;</div><div class="line"></div><div class="line">    mutex_lock(&amp;binder_mmap_lock);</div><div class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»æ˜ å°„</span></div><div class="line">    <span class="keyword">if</span> (proc-&gt;buffer) &#123;</div><div class="line">        ret = -EBUSY;</div><div class="line">        failure_string = <span class="string">"already mapped"</span>;</div><div class="line">        <span class="keyword">goto</span> err_already_mapped;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ç”³è¯·å†…æ ¸è™šæ‹Ÿå†…å­˜ç©ºé—´</span></div><div class="line">    area = get_vm_area(vma-&gt;vm_end - vma-&gt;vm_start, VM_IOREMAP);</div><div class="line">    <span class="keyword">if</span> (area == <span class="literal">NULL</span>) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"get_vm_area"</span>;</div><div class="line">        <span class="keyword">goto</span> err_get_vm_area_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å°†ç”³è¯·åˆ°çš„å†…å­˜åœ°å€ä¿å­˜åˆ° binder_proc å¯¹è±¡ä¸­</span></div><div class="line">    proc-&gt;buffer = area-&gt;addr;</div><div class="line">    proc-&gt;user_buffer_offset = vma-&gt;vm_start - (<span class="keyword">uintptr_t</span>)proc-&gt;buffer;</div><div class="line">    mutex_unlock(&amp;binder_mmap_lock);</div><div class="line"></div><div class="line">    <span class="comment">// æ ¹æ®è¯·æ±‚åˆ°çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œåˆ†é…ç»™ binder_proc å¯¹è±¡çš„ pagesï¼Œ ç”¨äºä¿å­˜æŒ‡å‘ç‰©ç†é¡µçš„æŒ‡é’ˆ</span></div><div class="line">    proc-&gt;pages = kzalloc(<span class="keyword">sizeof</span>(proc-&gt;pages[<span class="number">0</span>]) * ((vma-&gt;vm_end - vma-&gt;vm_start) / PAGE_SIZE), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (proc-&gt;pages == <span class="literal">NULL</span>) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"alloc page array"</span>;</div><div class="line">        <span class="keyword">goto</span> err_alloc_pages_failed;</div><div class="line">    &#125;</div><div class="line">    proc-&gt;buffer_size = vma-&gt;vm_end - vma-&gt;vm_start;</div><div class="line"></div><div class="line">    vma-&gt;vm_ops = &amp;binder_vm_ops;</div><div class="line">    vma-&gt;vm_private_data = proc;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªé¡µçš„ç‰©ç†å†…å­˜</span></div><div class="line">    <span class="keyword">if</span> (binder_update_page_range(proc, <span class="number">1</span>, proc-&gt;buffer, proc-&gt;buffer + PAGE_SIZE, vma)) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"alloc small buf"</span>;</div><div class="line">        <span class="keyword">goto</span> err_alloc_small_buf_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å†…å­˜æä¾›ç»™ binder_buffer</span></div><div class="line">    buffer = proc-&gt;buffer;</div><div class="line">    <span class="comment">// åˆå§‹åŒ– proc-&gt;buffers é“¾è¡¨</span></div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;buffers);</div><div class="line">    <span class="comment">// å°† binder_buffer å¯¹è±¡æ”¾å…¥åˆ° proc-&gt;buffers é“¾è¡¨ä¸­</span></div><div class="line">    list_add(&amp;buffer-&gt;entry, &amp;proc-&gt;buffers);</div><div class="line">    buffer-&gt;<span class="built_in">free</span> = <span class="number">1</span>;</div><div class="line">    binder_insert_free_buffer(proc, buffer);</div><div class="line">    proc-&gt;free_async_space = proc-&gt;buffer_size / <span class="number">2</span>;</div><div class="line">    barrier();</div><div class="line">    proc-&gt;files = get_files_struct(proc-&gt;tsk);</div><div class="line">    proc-&gt;vma = vma;</div><div class="line">    proc-&gt;vma_vm_mm = vma-&gt;vm_mm;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>é©±åŠ¨å‘½ä»¤æ¥å£ - binder_ioctl() å‡½æ•°</strong></p>
<p>ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ <code>ioctl</code> ç³»ç»Ÿå‡½æ•°å‘ <code>/dev/binder</code> è®¾å¤‡å‘é€æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L2734" target="_blank" rel="external">binder_ioctl()</a> å‡½æ•°å“åº”ã€‚</p>
<p>ä¸Šæ–‡æ•°æ®ç»“æ„ä¸­å·²ç»æåˆ°äº† <code>binder_ioctl</code> å¯ä»¥å¤„ç†çš„ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L87" target="_blank" rel="external">å‘½ä»¤</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ ¸å¿ƒå‘½ä»¤ï¼Œæ•°æ®çš„è¯»å†™</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_WRITE_READ       _IOWR(<span class="meta-string">'b'</span>, 1, struct binder_write_read)</span></div><div class="line"><span class="comment">// è®¾ç½®æœ€å¤§çº¿ç¨‹æ•°</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_MAX_THREADS      _IOW(<span class="meta-string">'b'</span>, 5, size_t)</span></div><div class="line"><span class="comment">// è®¾ç½® context manager</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_SET_CONTEXT_MGR      _IOW(<span class="meta-string">'b'</span>, 7, int)</span></div><div class="line"><span class="comment">// çº¿ç¨‹é€€å‡ºå‘½ä»¤</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_THREAD_EXIT      _IOW(<span class="meta-string">'b'</span>, 8, int)</span></div><div class="line"><span class="comment">// binder é©±åŠ¨çš„ç‰ˆæœ¬</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_VERSION          _IOWR(<span class="meta-string">'b'</span>, 9, struct binder_version)</span></div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</div><div class="line">    <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</div><div class="line"></div><div class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯</span></div><div class="line">    ret = wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="number">2</span>);</div><div class="line">    <span class="keyword">if</span> (ret)</div><div class="line">        <span class="keyword">goto</span> err_unlocked;</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line">    <span class="comment">// è·å– binder_thread å¯¹è±¡</span></div><div class="line">    thread = binder_get_thread(proc);</div><div class="line">    <span class="keyword">if</span> (thread == <span class="literal">NULL</span>) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        <span class="keyword">goto</span> err;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></div><div class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(struct binder_write_read)) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ä»ç”¨æˆ·ç©ºé—´æ‹·è´ binder_write_read åˆ° binder é©±åŠ¨ï¼Œå‚¨å­˜åœ¨ bwr</span></div><div class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</div><div class="line">            ret = -EFAULT;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œå†™å…¥æ“ä½œ</span></div><div class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                bwr.read_consumed = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</div><div class="line">                    ret = -EFAULT;</div><div class="line">                <span class="keyword">goto</span> err;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œè¯»å–æ“ä½œ</span></div><div class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</div><div class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</div><div class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</div><div class="line">                    ret = -EFAULT;</div><div class="line">                <span class="keyword">goto</span> err;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ“ä½œå®Œæˆåå°†æ•°æ®è¿”å›ç»™ç”¨æˆ·ç©ºé—´</span></div><div class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</div><div class="line">            ret = -EFAULT;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> BINDER_SET_MAX_THREADS:</div><div class="line">        <span class="comment">// è®¾ç½®æœ€å¤§çº¿ç¨‹ï¼Œä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ° proc-&gt;max_threads</span></div><div class="line">        <span class="keyword">if</span> (copy_from_user(&amp;proc-&gt;max_threads, ubuf, <span class="keyword">sizeof</span>(proc-&gt;max_threads))) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_SET_CONTEXT_MGR:</div><div class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®</span></div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_node != <span class="literal">NULL</span>) &#123;</div><div class="line">            ret = -EBUSY;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½® context manager</span></div><div class="line">        ret = security_binder_set_context_mgr(proc-&gt;tsk);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_uid != <span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (binder_context_mgr_uid != current-&gt;cred-&gt;euid) &#123;</div><div class="line">                ret = -EPERM;</div><div class="line">                <span class="keyword">goto</span> err;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            binder_context_mgr_uid = current-&gt;cred-&gt;euid;</div><div class="line">        <span class="comment">// åˆ›å»º binder_context_mgr_node èŠ‚ç‚¹</span></div><div class="line">        binder_context_mgr_node = binder_new_node(proc, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_node == <span class="literal">NULL</span>) &#123;</div><div class="line">            ret = -ENOMEM;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®</span></div><div class="line">        binder_context_mgr_node-&gt;local_weak_refs++;</div><div class="line">        binder_context_mgr_node-&gt;local_strong_refs++;</div><div class="line">        binder_context_mgr_node-&gt;has_strong_ref = <span class="number">1</span>;</div><div class="line">        binder_context_mgr_node-&gt;has_weak_ref = <span class="number">1</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_THREAD_EXIT:</div><div class="line">        <span class="comment">// çº¿ç¨‹é€€å‡ºï¼Œé‡Šæ”¾èµ„æº</span></div><div class="line">        binder_free_thread(proc, thread);</div><div class="line">        thread = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_VERSION:</div><div class="line">        <span class="comment">// å°† binder é©±åŠ¨ç‰ˆæœ¬å·å†™å…¥åˆ°ç”¨æˆ·ç©ºé—´ ubuf-&gt;protocol_version ä¸­</span></div><div class="line">        <span class="keyword">if</span> (put_user(BINDER_CURRENT_PROTOCOL_VERSION, &amp;((struct binder_version *)ubuf)-&gt;protocol_version)) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            <span class="keyword">goto</span> err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        ret = -EINVAL;</div><div class="line">        <span class="keyword">goto</span> err;</div><div class="line">    &#125;</div><div class="line">    ret = <span class="number">0</span>;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> struct binder_node *<span class="title">binder_new_node</span><span class="params">(struct binder_proc *proc,</span></span></div><div class="line">                       <span class="keyword">void</span> __user *ptr,</div><div class="line">                       <span class="keyword">void</span> __user *cookie)</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> = &amp;<span class="title">proc</span>-&gt;<span class="title">nodes</span>.<span class="title">rb_node</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> = <span class="title">NULL</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// æŸ¥æ‰¾è¦æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></div><div class="line">    <span class="keyword">while</span> (*p) &#123;</div><div class="line">        parent = *p;</div><div class="line">        node = rb_entry(parent, struct binder_node, rb_node);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ptr &lt; node-&gt;ptr)</div><div class="line">            p = &amp;(*p)-&gt;rb_left;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ptr &gt; node-&gt;ptr)</div><div class="line">            p = &amp;(*p)-&gt;rb_right;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸ºè¦æ’å…¥èŠ‚ç‚¹åˆ†é…å†…å­˜ç©ºé—´</span></div><div class="line">    node = kzalloc(<span class="keyword">sizeof</span>(*node), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    binder_stats_created(BINDER_STAT_NODE);</div><div class="line">    <span class="comment">// æ’å…¥èŠ‚ç‚¹</span></div><div class="line">    rb_link_node(&amp;node-&gt;rb_node, parent, p);</div><div class="line">    rb_insert_color(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</div><div class="line">    <span class="comment">// åˆå§‹åŒ–</span></div><div class="line">    node-&gt;debug_id = ++binder_last_id;</div><div class="line">    node-&gt;proc = proc;</div><div class="line">    node-&gt;ptr = ptr;</div><div class="line">    node-&gt;cookie = cookie;</div><div class="line">    node-&gt;work.type = BINDER_WORK_NODE;</div><div class="line">    INIT_LIST_HEAD(&amp;node-&gt;work.entry);</div><div class="line">    INIT_LIST_HEAD(&amp;node-&gt;async_todo);</div><div class="line">    <span class="keyword">return</span> node;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>BINDER_WRITE_READ å¤„ç†è¿‡ç¨‹</strong></p>
<p>åœ¨ binder æœ¬åœ°å±‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨ <code>IPCThreadState::talkWithDriver()</code> å‡½æ•°ä¸­ï¼Œ binder æœ¬åœ°å±‚é€šè¿‡ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/native/libs/binder/IPCThreadState.cpp#L856" target="_blank" rel="external">ioctl()(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)</a> å‘½ä»¤çš„å½¢å¼ï¼Œä¸ binder é©±åŠ¨äº¤äº’ã€‚</p>
<p>å¯ä»¥çœ‹å‡º <code>ioctl()</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.h#L69" target="_blank" rel="external">binder_write_read</a> ç»“æ„ä½“</p>
<p>binder.h å¤´æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ•°æ®ç±»å‹, ä¸€ä¸ªæ˜¯ <code>binder_write_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> &#123;</span></div><div class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> write_size; <span class="comment">/* bytes to write */</span></div><div class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> write_consumed; <span class="comment">/* bytes consumed by driver */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   write_buffer;</div><div class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> read_size;  <span class="comment">/* bytes to read */</span></div><div class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> read_consumed;  <span class="comment">/* bytes consumed by driver */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   read_buffer;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>write_size</code> å’Œ <code>read_size</code> è¡¨ç¤ºéœ€è¦è¢«è¯»å†™çš„å­—èŠ‚æ•°ï¼Œ <code>write_consumed</code> å’Œ <code>read_consumed</code> è¡¨ç¤ºå·²ç»è¢« binder é©±åŠ¨è¯»å†™çš„å­—èŠ‚æ•°ï¼Œ <code>write_buffer</code> å’Œ <code>read_buffer</code> åˆ™æ˜¯æŒ‡å‘è¢«è¯»å†™æ•°æ®çš„æŒ‡é’ˆã€‚</p>
<p>å…·ä½“çš„è¯»å†™æ“ä½œè¢« <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L1852" target="_blank" rel="external">binder_thread_write</a> å’Œ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L2266" target="_blank" rel="external">binder_thread_read</a> å®ç°ã€‚</p>
<p><strong>æ•°æ®å†™å…¥ - binder_thread_write() å‡½æ•°</strong></p>
<p>å°†ç”¨æˆ·ç©ºé—´æ•°æ®å†™å…¥åˆ° binder é©±åŠ¨ï¼Œä»é©±åŠ¨è§’åº¦æ¥çœ‹æ˜¯è¯»å–çš„æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></div><div class="line">            <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">uint32_t</span> cmd;</div><div class="line">    <span class="comment">// ç”¨æˆ·ç©ºé—´æ•°æ®ï¼Œèµ·å§‹åœ°å€å’Œç»“æŸåœ°å€</span></div><div class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</div><div class="line">    <span class="keyword">void</span> __user *end = buffer + size;</div><div class="line"></div><div class="line">    <span class="comment">// å¾ªç¯è¯»å–</span></div><div class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</div><div class="line">        <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è·å–æ“ä½œå‘½ä»¤</span></div><div class="line">        <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">        <span class="keyword">if</span> (_IOC_NR(cmd) &lt; ARRAY_SIZE(binder_stats.bc)) &#123;</div><div class="line">            <span class="comment">// å¢åŠ å‘½ä»¤è®¡æ•°å™¨</span></div><div class="line">            binder_stats.bc[_IOC_NR(cmd)]++;</div><div class="line">            proc-&gt;stats.bc[_IOC_NR(cmd)]++;</div><div class="line">            thread-&gt;stats.bc[_IOC_NR(cmd)]++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">        <span class="comment">// è¿™å››ä¸ªå‘½ä»¤ç”¨æ¥å¢åŠ æˆ–å‡å°‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œ æ“ä½œç›®æ ‡ binder_ref</span></div><div class="line">        <span class="keyword">case</span> BC_INCREFS:</div><div class="line">        <span class="keyword">case</span> BC_ACQUIRE:</div><div class="line">        <span class="keyword">case</span> BC_RELEASE:</div><div class="line">        <span class="keyword">case</span> BC_DECREFS: &#123;</div><div class="line">            <span class="keyword">uint32_t</span> target;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *debug_string;</div><div class="line"></div><div class="line">            <span class="comment">// è·å–ç›®æ ‡è¿›ç¨‹èŠ‚ç‚¹æè¿° desc</span></div><div class="line">            <span class="keyword">if</span> (get_user(target, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">            <span class="comment">// ç´¢æè¿°ä¸º 0 è¡¨ç¤º context manager è¿›ç¨‹</span></div><div class="line">            <span class="keyword">if</span> (target == <span class="number">0</span> &amp;&amp; binder_context_mgr_node &amp;&amp;</div><div class="line">                (cmd == BC_INCREFS || cmd == BC_ACQUIRE)) &#123;</div><div class="line">                <span class="comment">// åœ¨ proc-&gt;refs_by_node.rb_node çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾å¼•ç”¨</span></div><div class="line">                ref = binder_get_ref_for_node(proc,</div><div class="line">                           binder_context_mgr_node);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">                <span class="comment">// åœ¨ proc-&gt;refs_by_desc.rb_node çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾å¼•ç”¨</span></div><div class="line">                ref = binder_get_ref(proc, target);</div><div class="line">            <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">            <span class="keyword">case</span> BC_INCREFS:</div><div class="line">                debug_string = <span class="string">"IncRefs"</span>;</div><div class="line">                <span class="comment">// å¢åŠ å¼±å¼•ç”¨è®¡æ•°</span></div><div class="line">                binder_inc_ref(ref, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_ACQUIRE:</div><div class="line">                debug_string = <span class="string">"Acquire"</span>;</div><div class="line">                <span class="comment">// å¢åŠ å¼ºå¼•ç”¨è®¡æ•°</span></div><div class="line">                binder_inc_ref(ref, <span class="number">1</span>, <span class="literal">NULL</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_RELEASE:</div><div class="line">                debug_string = <span class="string">"Release"</span>;</div><div class="line">                <span class="comment">// å‡å°‘å¼ºå¼•ç”¨è®¡æ•°</span></div><div class="line">                binder_dec_ref(ref, <span class="number">1</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_DECREFS:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                debug_string = <span class="string">"DecRefs"</span>;</div><div class="line">                <span class="comment">// å‡å°‘å¼±å¼•ç”¨è®¡æ•°</span></div><div class="line">                binder_dec_ref(ref, <span class="number">0</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> BC_INCREFS_DONE:</div><div class="line">        <span class="keyword">case</span> BC_ACQUIRE_DONE: &#123;</div><div class="line">            <span class="keyword">void</span> __user *node_ptr;</div><div class="line">            <span class="keyword">void</span> *cookie;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span>;</span></div><div class="line"></div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å– node_ptr</span></div><div class="line">            <span class="keyword">if</span> (get_user(node_ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å– cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// è·å¾—èŠ‚ç‚¹</span></div><div class="line">            node = binder_get_node(proc, node_ptr);</div><div class="line">            <span class="comment">// æ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›</span></div><div class="line">            <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"%s u%p no match\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_INCREFS_DONE ?</div><div class="line">                    <span class="string">"BC_INCREFS_DONE"</span> :</div><div class="line">                    <span class="string">"BC_ACQUIRE_DONE"</span>,</div><div class="line">                    node_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// cookie ä¸åŒ¹é…åˆ™è¿”å›</span></div><div class="line">            <span class="keyword">if</span> (cookie != node-&gt;cookie) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d %s u%p node %d"</span></div><div class="line">                    <span class="string">" cookie mismatch %p != %p\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_INCREFS_DONE ?</div><div class="line">                    <span class="string">"BC_INCREFS_DONE"</span> : <span class="string">"BC_ACQUIRE_DONE"</span>,</div><div class="line">                    node_ptr, node-&gt;debug_id,</div><div class="line">                    cookie, node-&gt;cookie);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (cmd == BC_ACQUIRE_DONE) &#123;</div><div class="line">                node-&gt;pending_strong_ref = <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                node-&gt;pending_weak_ref = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// å‡å°‘èŠ‚ç‚¹ä½¿ç”¨è®¡æ•°</span></div><div class="line">            binder_dec_node(node, cmd == BC_ACQUIRE_DONE, <span class="number">0</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// é‡Šæ”¾ binder_bffer</span></div><div class="line">        <span class="keyword">case</span> BC_FREE_BUFFER: &#123;</div><div class="line">            <span class="keyword">void</span> __user *data_ptr;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> *<span class="title">buffer</span>;</span></div><div class="line"></div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è·å– data_ptr</span></div><div class="line">            <span class="keyword">if</span> (get_user(data_ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line"></div><div class="line">            <span class="comment">// æŸ¥æ‰¾ binder_buffer</span></div><div class="line">            buffer = binder_buffer_lookup(proc, data_ptr);</div><div class="line">            <span class="comment">// æ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›</span></div><div class="line">            <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"BC_FREE_BUFFER u%p no match\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, data_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// ä¸å…è®¸ç”¨æˆ·é‡Šæ”¾åˆ™è¿”å›</span></div><div class="line">            <span class="keyword">if</span> (!buffer-&gt;allow_user_free) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"BC_FREE_BUFFER u%p matched "</span></div><div class="line">                    <span class="string">"unreturned buffer\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, data_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// å°† buffer-&gt;transaction ç½®ç©º</span></div><div class="line">            <span class="keyword">if</span> (buffer-&gt;transaction) &#123;</div><div class="line">                buffer-&gt;transaction-&gt;buffer = <span class="literal">NULL</span>;</div><div class="line">                buffer-&gt;transaction = <span class="literal">NULL</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (buffer-&gt;async_transaction &amp;&amp; buffer-&gt;target_node) &#123;</div><div class="line">                <span class="keyword">if</span> (list_empty(&amp;buffer-&gt;target_node-&gt;async_todo))</div><div class="line">                    buffer-&gt;target_node-&gt;has_async_transaction = <span class="number">0</span>;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    list_move_tail(buffer-&gt;target_node-&gt;async_todo.next, &amp;thread-&gt;todo);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// é‡Šæ”¾ binder_buffer å¯¹è±¡</span></div><div class="line">            trace_binder_transaction_buffer_release(buffer);</div><div class="line">            binder_transaction_buffer_release(proc, buffer, <span class="literal">NULL</span>);</div><div class="line">            binder_free_buf(proc, buffer);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// binder æ•°æ®ä¼ é€’å¤„ç†</span></div><div class="line">        <span class="keyword">case</span> BC_TRANSACTION:</div><div class="line">        <span class="keyword">case</span> BC_REPLY: &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></div><div class="line"></div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´æ‹·è´ binder_transaction_data å¯¹è±¡</span></div><div class="line">            <span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(tr);</div><div class="line">            <span class="comment">// å®é™…çš„ä¼ è¾“å‡½æ•°ï¼Œåœ¨ä¸‹æ–‡è®²è§£</span></div><div class="line">            binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// è®¾ç½® looper ä¸º BINDER_LOOPER_STATE_REGISTERED çŠ¶æ€</span></div><div class="line">        <span class="keyword">case</span> BC_REGISTER_LOOPER:</div><div class="line">            <span class="keyword">if</span> (thread-&gt;looper &amp; BINDER_LOOPER_STATE_ENTERED) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_REGISTER_LOOPER called "</span></div><div class="line">                    <span class="string">"after BC_ENTER_LOOPER\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;requested_threads == <span class="number">0</span>) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_REGISTER_LOOPER called "</span></div><div class="line">                    <span class="string">"without request\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                proc-&gt;requested_threads--;</div><div class="line">                proc-&gt;requested_threads_started++;</div><div class="line">            &#125;</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_REGISTERED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">// è®¾ç½® looper ä¸º BINDER_LOOPER_STATE_ENTERED çŠ¶æ€</span></div><div class="line">        <span class="keyword">case</span> BC_ENTER_LOOPER:</div><div class="line">            <span class="keyword">if</span> (thread-&gt;looper &amp; BINDER_LOOPER_STATE_REGISTERED) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_ENTER_LOOPER called after "</span></div><div class="line">                    <span class="string">"BC_REGISTER_LOOPER\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125;</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_ENTERED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">// è®¾ç½® looper ä¸º BINDER_LOOPER_STATE_EXITED çŠ¶æ€</span></div><div class="line">        <span class="keyword">case</span> BC_EXIT_LOOPER:</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_EXITED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">// å‘é€ REQUEST_DEATH æˆ– CLEAR_DEATH é€šçŸ¥</span></div><div class="line">        <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</div><div class="line">        <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</div><div class="line">            <span class="keyword">uint32_t</span> target;</div><div class="line">            <span class="keyword">void</span> __user *cookie;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span>;</span></div><div class="line"></div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è·å– binder_ref æè¿° desc</span></div><div class="line">            <span class="keyword">if</span> (get_user(target, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è·å– cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> __user * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// è·å– binder_ref å¼•ç”¨</span></div><div class="line">            ref = binder_get_ref(proc, target);</div><div class="line">            <span class="keyword">if</span> (ref == <span class="literal">NULL</span>) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d %s "</span></div><div class="line">                    <span class="string">"invalid ref %d\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_REQUEST_DEATH_NOTIFICATION ?</div><div class="line">                    <span class="string">"BC_REQUEST_DEATH_NOTIFICATION"</span> :</div><div class="line">                    <span class="string">"BC_CLEAR_DEATH_NOTIFICATION"</span>,</div><div class="line">                    target);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;death) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_REQUEST_DEATH_NOTI"</span></div><div class="line">                        <span class="string">"FICATION death notific"</span></div><div class="line">                        <span class="string">"ation already set\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// ä¸º binder_ref_death å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´</span></div><div class="line">                death = kzalloc(<span class="keyword">sizeof</span>(*death), GFP_KERNEL);</div><div class="line">                <span class="keyword">if</span> (death == <span class="literal">NULL</span>) &#123;</div><div class="line">                    thread-&gt;return_error = BR_ERROR;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// åˆå§‹åŒ– binder_ref_death å¯¹è±¡</span></div><div class="line">                binder_stats_created(BINDER_STAT_DEATH);</div><div class="line">                INIT_LIST_HEAD(&amp;death-&gt;work.entry);</div><div class="line">                death-&gt;cookie = cookie;</div><div class="line">                ref-&gt;death = death;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;node-&gt;proc == <span class="literal">NULL</span>) &#123;</div><div class="line">                    ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</div><div class="line">                    <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                        list_add_tail(&amp;ref-&gt;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        list_add_tail(&amp;ref-&gt;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                        <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></div><div class="line">                        wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;death == <span class="literal">NULL</span>) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_CLEAR_DEATH_NOTIFI"</span></div><div class="line">                        <span class="string">"CATION death notificat"</span></div><div class="line">                        <span class="string">"ion not active\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                death = ref-&gt;death;</div><div class="line">                <span class="keyword">if</span> (death-&gt;cookie != cookie) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_CLEAR_DEATH_NOTIFI"</span></div><div class="line">                        <span class="string">"CATION death notificat"</span></div><div class="line">                        <span class="string">"ion cookie mismatch "</span></div><div class="line">                        <span class="string">"%p != %p\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid,</div><div class="line">                        death-&gt;cookie, cookie);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// å°† ref-&gt;death ç½®ç©º</span></div><div class="line">                ref-&gt;death = <span class="literal">NULL</span>;</div><div class="line">                <span class="keyword">if</span> (list_empty(&amp;death-&gt;work.entry)) &#123;</div><div class="line">                    death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</div><div class="line">                    <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                        list_add_tail(&amp;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        list_add_tail(&amp;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                        <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></div><div class="line">                        wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    BUG_ON(death-&gt;work.type != BINDER_WORK_DEAD_BINDER);</div><div class="line">                    death-&gt;work.type = BINDER_WORK_DEAD_BINDER_AND_CLEAR;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BC_DEAD_BINDER_DONE: &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></div><div class="line">            <span class="keyword">void</span> __user *cookie;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span> = <span class="title">NULL</span>;</span></div><div class="line">            <span class="comment">// ä»ç”¨æˆ·ç©ºé—´è·å– cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> __user * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line"></div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">            list_for_each_entry(w, &amp;proc-&gt;delivered_death, entry) &#123;</div><div class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">tmp_death</span> = <span class="title">container_of</span>(<span class="title">w</span>, <span class="title">struct</span> <span class="title">binder_ref_death</span>, <span class="title">work</span>);</span></div><div class="line">                <span class="keyword">if</span> (tmp_death-&gt;cookie == cookie) &#123;</div><div class="line">                    death = tmp_death;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (death == <span class="literal">NULL</span>) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d BC_DEAD"</span></div><div class="line">                    <span class="string">"_BINDER_DONE %p not found\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, cookie);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            list_del_init(&amp;death-&gt;work.entry);</div><div class="line">            <span class="comment">// å¦‚æœ death-&gt;work.t ä¸º BINDER_WORK_DEAD_BINDER_AND_CLEAR åˆ™ä¿®æ”¹ä¸º BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span></div><div class="line">            <span class="keyword">if</span> (death-&gt;work.t == BINDER_WORK_DEAD_BINDER_AND_CLEAR ) &#123;</div><div class="line">                death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</div><div class="line">                <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                    list_add_tail(&amp;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    list_add_tail(&amp;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                    <span class="comment">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span></div><div class="line">                    wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> -EINVAL;</div><div class="line">        &#125;</div><div class="line">        *consumed = ptr - buffer;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>binder_transaction() å‡½æ•°</strong></p>
<p>åœ¨ä¸Šæ–‡å¤„ç† <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L2041" target="_blank" rel="external">BC_TRANSACTION</a> å’Œ <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L2042" target="_blank" rel="external">BC_REPLY</a> æ—¶ï¼Œè°ƒç”¨äº† <a href="https://github.com/xdtianyu/android-msm-hammerhead-3.4-marshmallow/blob/master/drivers/staging/android/binder.c#L1417" target="_blank" rel="external">binder_transaction()</a> å‡½æ•°ã€‚æˆ‘ä»¬ç»§ç»­è¿½è¸ª</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></div><div class="line">                   struct binder_thread *thread,</div><div class="line">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></div><div class="line">    <span class="keyword">size_t</span> *offp, *off_end;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></div><div class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (reply) &#123;</div><div class="line">        <span class="comment">// BC_REPLY å¤„ç†æµç¨‹</span></div><div class="line">        <span class="comment">// å¾—åˆ° binder_transaction å¯¹è±¡</span></div><div class="line">        in_reply_to = thread-&gt;transaction_stack;</div><div class="line">        <span class="keyword">if</span> (in_reply_to == <span class="literal">NULL</span>) &#123;</div><div class="line">            return_error = BR_FAILED_REPLY;</div><div class="line">            <span class="keyword">goto</span> err_empty_call_stack;</div><div class="line">        &#125;</div><div class="line">        binder_set_nice(in_reply_to-&gt;saved_priority);</div><div class="line">        thread-&gt;transaction_stack = in_reply_to-&gt;to_parent;</div><div class="line">        <span class="comment">// è·å–ç›®æ ‡çº¿ç¨‹</span></div><div class="line">        target_thread = in_reply_to-&gt;from;</div><div class="line">        target_proc = target_thread-&gt;proc;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// BC_TRANSACTION å¤„ç†æµç¨‹</span></div><div class="line">        <span class="comment">// æŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) &#123;</div><div class="line">            struct binder_ref *ref;</div><div class="line">            <span class="comment">// è·å– binder_ref å¯¹è±¡</span></div><div class="line">            ref = binder_get_ref(proc, tr-&gt;target.handle);</div><div class="line">            target_node = ref-&gt;node;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ç´¢å¼•ä¸º 0 åˆ™è¿”å› context manager</span></div><div class="line">            target_node = binder_context_mgr_node;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// å¾—åˆ°ç›®æ ‡è¿›ç¨‹</span></div><div class="line">        target_proc = target_node-&gt;proc;</div><div class="line">        <span class="keyword">if</span> (!(tr-&gt;flags &amp; TF_ONE_WAY) &amp;&amp; thread-&gt;transaction_stack) &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">tmp</span>;</span></div><div class="line">            tmp = thread-&gt;transaction_stack;</div><div class="line">            <span class="keyword">while</span> (tmp) &#123;</div><div class="line">                <span class="keyword">if</span> (tmp-&gt;from &amp;&amp; tmp-&gt;from-&gt;proc == target_proc)</div><div class="line">                    <span class="comment">// è·å¾—ç›®æ ‡çº¿ç¨‹</span></div><div class="line">                    target_thread = tmp-&gt;from;</div><div class="line">                tmp = tmp-&gt;from_parent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è®¾ç½®è¦å¤„ç†çš„ç›®æ ‡è¿›ç¨‹æˆ–ç›®æ ‡çº¿ç¨‹ä»»åŠ¡</span></div><div class="line">    <span class="keyword">if</span> (target_thread) &#123;</div><div class="line">        target_list = &amp;target_thread-&gt;todo;</div><div class="line">        target_wait = &amp;target_thread-&gt;wait;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        target_list = &amp;target_proc-&gt;todo;</div><div class="line">        target_wait = &amp;target_proc-&gt;wait;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸º binder_transaction å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´</span></div><div class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</div><div class="line">    binder_stats_created(BINDER_STAT_TRANSACTION);</div><div class="line"></div><div class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</div><div class="line">    binder_stats_created(BINDER_STAT_TRANSACTION_COMPLETE);</div><div class="line"></div><div class="line">    <span class="comment">// å¦‚æœæ˜¯åŒæ­¥ä¼ è¾“(åŒå‘)ï¼Œåˆ™å°†å½“å‰çš„ binder_thread å¯¹è±¡ä¿å­˜åœ¨ binder_transaction å¯¹è±¡çš„ from ä¸­ã€‚</span></div><div class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</div><div class="line">        t-&gt;from = thread;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        t-&gt;from = <span class="literal">NULL</span>;</div><div class="line">    <span class="comment">// è®¾ç½® binder_transaction å¯¹è±¡</span></div><div class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</div><div class="line">    t-&gt;to_proc = target_proc;</div><div class="line">    t-&gt;to_thread = target_thread;</div><div class="line">    t-&gt;code = tr-&gt;code;</div><div class="line">    t-&gt;flags = tr-&gt;flags;</div><div class="line">    t-&gt;priority = task_nice(current);</div><div class="line"></div><div class="line">    <span class="comment">// ä¸º binder_buffer åˆ†é…å†…å­˜ç©ºé—´</span></div><div class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</div><div class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</div><div class="line">    <span class="comment">// è®¾ç½® binder_buffer</span></div><div class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</div><div class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</div><div class="line">    t-&gt;buffer-&gt;transaction = t;</div><div class="line">    t-&gt;buffer-&gt;target_node = target_node;</div><div class="line">    <span class="keyword">if</span> (target_node)</div><div class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</div><div class="line"></div><div class="line">    <span class="comment">// ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ° binder_buffer</span></div><div class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</div><div class="line">        return_error = BR_FAILED_REPLY;</div><div class="line">        <span class="keyword">goto</span> err_copy_data_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</div><div class="line">        return_error = BR_FAILED_REPLY;</div><div class="line">        <span class="keyword">goto</span> err_copy_data_failed;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</div><div class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> *<span class="title">fp</span>;</span></div><div class="line">        <span class="comment">// ä¸º flat_binder_object èµ‹å€¼</span></div><div class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</div><div class="line">        <span class="comment">// è½¬æ¢ binder ç±»å‹ï¼Œå¦‚æœæ˜¯ BINDER åˆ™è½¬æ¢ä¸º HANDLEï¼Œ å¦‚æœæ˜¯ HANDLE åˆ™è½¬ä¸º BANDLE</span></div><div class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_BINDER:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_BINDER: &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></div><div class="line">            <span class="comment">// è·å– binder_node èŠ‚ç‚¹</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span> = <span class="title">binder_get_node</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">binder</span>);</span></div><div class="line">            <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</div><div class="line">                node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</div><div class="line">                <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</div><div class="line">                    return_error = BR_FAILED_REPLY;</div><div class="line">                    <span class="keyword">goto</span> err_binder_new_node_failed;</div><div class="line">                &#125;</div><div class="line">                node-&gt;min_priority = fp-&gt;flags &amp; FLAT_BINDER_FLAG_PRIORITY_MASK;</div><div class="line">                node-&gt;accept_fds = !!(fp-&gt;flags &amp; FLAT_BINDER_FLAG_ACCEPTS_FDS);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (fp-&gt;cookie != node-&gt;cookie) &#123;</div><div class="line">                <span class="keyword">goto</span> err_binder_get_ref_for_node_failed;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// è·å– binder_ref å¯¹è±¡</span></div><div class="line">            ref = binder_get_ref_for_node(target_proc, node);</div><div class="line">            <span class="comment">// è½¬æ¢ç±»å‹</span></div><div class="line">            <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_BINDER)</div><div class="line">                fp-&gt;type = BINDER_TYPE_HANDLE;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                fp-&gt;type = BINDER_TYPE_WEAK_HANDLE;</div><div class="line">            fp-&gt;handle = ref-&gt;desc;</div><div class="line">            binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE,</div><div class="line">                       &amp;thread-&gt;todo);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_HANDLE:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_HANDLE: &#123;</div><div class="line">            <span class="comment">// è·å– binder_ref å¯¹è±¡</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span>*<span class="title">ref</span> = <span class="title">binder_get_ref</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">handle</span>);</span></div><div class="line">            <span class="comment">// è½¬æ¢ç±»å‹</span></div><div class="line">            <span class="keyword">if</span> (ref-&gt;node-&gt;proc == target_proc) &#123;</div><div class="line">                <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_HANDLE)</div><div class="line">                    fp-&gt;type = BINDER_TYPE_BINDER;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    fp-&gt;type = BINDER_TYPE_WEAK_BINDER;</div><div class="line">                fp-&gt;binder = ref-&gt;node-&gt;ptr;</div><div class="line">                fp-&gt;cookie = ref-&gt;node-&gt;cookie;</div><div class="line">                binder_inc_node(ref-&gt;node, fp-&gt;type == BINDER_TYPE_BINDER, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                struct binder_ref *new_ref;</div><div class="line">                new_ref = binder_get_ref_for_node(target_proc, ref-&gt;node);</div><div class="line">                fp-&gt;handle = new_ref-&gt;desc;</div><div class="line">                binder_inc_ref(new_ref, fp-&gt;type == BINDER_TYPE_HANDLE, <span class="literal">NULL</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">// æ–‡ä»¶ç±»å‹</span></div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_FD: &#123;</div><div class="line">            <span class="keyword">int</span> target_fd;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></div><div class="line">            <span class="comment">// è·å¾—æ–‡ä»¶å¯¹è±¡</span></div><div class="line">            file = fget(fp-&gt;handle);</div><div class="line">            <span class="comment">// åˆ†é…ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦</span></div><div class="line">            target_fd = task_get_unused_fd_flags(target_proc, O_CLOEXEC);</div><div class="line">            task_fd_install(target_proc, target_fd, file);</div><div class="line">            fp-&gt;handle = target_fd;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            return_error = BR_FAILED_REPLY;</div><div class="line">            <span class="keyword">goto</span> err_bad_object_type;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (reply) &#123;</div><div class="line">        <span class="comment">// BC_REPLY å¤„ç†æµç¨‹, binder_transaction ä¸­é‡Šæ”¾ binder_transaction å¯¹è±¡</span></div><div class="line">        binder_pop_transaction(target_thread, in_reply_to);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</div><div class="line">        <span class="comment">// åŒæ­¥çŠ¶æ€(åŒå‘)éœ€è¦è®¾ç½®å›å¤</span></div><div class="line">        t-&gt;need_reply = <span class="number">1</span>;</div><div class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</div><div class="line">        thread-&gt;transaction_stack = t;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// å¼‚æ­¥ä¼ è¾“ä¸éœ€è¦è®¾ç½®å›å¤</span></div><div class="line">        <span class="keyword">if</span> (target_node-&gt;has_async_transaction) &#123;</div><div class="line">            target_list = &amp;target_node-&gt;async_todo;</div><div class="line">            target_wait = <span class="literal">NULL</span>;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            target_node-&gt;has_async_transaction = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</div><div class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</div><div class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</div><div class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</div><div class="line">    <span class="keyword">if</span> (target_wait)</div><div class="line">        <span class="comment">// å”¤é†’ç›®æ ‡çº¿ç¨‹</span></div><div class="line">        wake_up_interruptible(target_wait);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ•°æ®è¯»å– - binder_thread_read() å‡½æ•°</strong></p>
<p>ç”¨æˆ·ç©ºé—´ä» binder é©±åŠ¨è¯»å–æ•°æ®ï¼Œä»é©±åŠ¨è§’åº¦æ¥çœ‹æ˜¯å†™å‡ºçš„æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></div><div class="line">                  struct binder_thread *thread,</div><div class="line">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</div><div class="line">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</div><div class="line">    <span class="keyword">void</span> __user *end = buffer + size;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> wait_for_proc_work;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ“ä½œæ—¶å‘ç”¨æˆ·ç©ºé—´è¿”å› BR_NOOP å‘½ä»¤</span></div><div class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">retry:</div><div class="line">    <span class="comment">// è·å–å°†è¦å¤„ç†çš„ä»»åŠ¡</span></div><div class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp;</div><div class="line">                list_empty(&amp;thread-&gt;todo);</div><div class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</div><div class="line">        <span class="keyword">if</span> (!(thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED |</div><div class="line">                    BINDER_LOOPER_STATE_ENTERED))) &#123;</div><div class="line">            binder_user_error(<span class="string">"binder: %d:%d ERROR: Thread waiting "</span></div><div class="line">                <span class="string">"for process work before calling BC_REGISTER_"</span></div><div class="line">                <span class="string">"LOOPER or BC_ENTER_LOOPER (state %x)\n"</span>,</div><div class="line">                proc-&gt;pid, thread-&gt;pid, thread-&gt;looper);</div><div class="line">            wait_event_interruptible(binder_user_error_wait,</div><div class="line">                         binder_stop_on_user_error &lt; <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        binder_set_nice(proc-&gt;default_priority);</div><div class="line">        <span class="keyword">if</span> (non_block) &#123;</div><div class="line">            <span class="comment">// éé˜»å¡ä¸”æ²¡æœ‰æ•°æ®åˆ™è¿”å› EAGAIN</span></div><div class="line">            <span class="keyword">if</span> (!binder_has_proc_work(proc, thread))</div><div class="line">                ret = -EAGAIN;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="comment">// é˜»å¡åˆ™è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…å¯æ“ä½œçš„ä»»åŠ¡</span></div><div class="line">            ret = wait_event_freezable_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (non_block) &#123;</div><div class="line">            <span class="keyword">if</span> (!binder_has_thread_work(thread))</div><div class="line">                ret = -EAGAIN;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            ret = wait_event_freezable(thread-&gt;wait, binder_has_thread_work(thread));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (wait_for_proc_work)</div><div class="line">        proc-&gt;ready_threads--;</div><div class="line">    thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_WAITING;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ret)</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> cmd;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></div><div class="line"></div><div class="line">        <span class="comment">// è·å– binder_work å¯¹è±¡</span></div><div class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</div><div class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</div><div class="line">            w = list_first_entry(&amp;proc-&gt;todo, struct binder_work, entry);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></div><div class="line">                <span class="keyword">goto</span> retry;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (end - ptr &lt; <span class="keyword">sizeof</span>(tr) + <span class="number">4</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION: &#123;</div><div class="line">            <span class="comment">// è·å– binder_transaction å¯¹è±¡</span></div><div class="line">            t = container_of(w, struct binder_transaction, work);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE: &#123;</div><div class="line">            cmd = BR_TRANSACTION_COMPLETE;</div><div class="line">            <span class="comment">// è¿”å› BR_TRANSACTION_COMPLETE å‘½ä»¤</span></div><div class="line">            <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line"></div><div class="line">            binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">            <span class="comment">// ä» work é“¾è¡¨ä¸­åˆ é™¤å¹¶é‡Šæ”¾å†…å­˜</span></div><div class="line">            list_del(&amp;w-&gt;entry);</div><div class="line">            kfree(w);</div><div class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION_COMPLETE);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_NODE: &#123;</div><div class="line">            <span class="comment">// è·å¾— binder_node èŠ‚ç‚¹</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span> = <span class="title">container_of</span>(<span class="title">w</span>, <span class="title">struct</span> <span class="title">binder_node</span>, <span class="title">work</span>);</span></div><div class="line">            <span class="keyword">uint32_t</span> cmd = BR_NOOP;</div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cmd_name;</div><div class="line">            <span class="comment">// æ ¹æ®èŠ‚ç‚¹ç±»å‹ï¼Œå¢åŠ /è·å–ã€å‡å°‘/é‡Šæ”¾èŠ‚ç‚¹ç´¢å¼•</span></div><div class="line">            <span class="keyword">int</span> strong = node-&gt;internal_strong_refs || node-&gt;local_strong_refs;</div><div class="line">            <span class="keyword">int</span> weak = !hlist_empty(&amp;node-&gt;refs) || node-&gt;local_weak_refs || strong;</div><div class="line">            <span class="comment">// æ„é€  BR_* å‘½ä»¤</span></div><div class="line">            <span class="keyword">if</span> (weak &amp;&amp; !node-&gt;has_weak_ref) &#123;</div><div class="line">                cmd = BR_INCREFS;</div><div class="line">                cmd_name = <span class="string">"BR_INCREFS"</span>;</div><div class="line">                node-&gt;has_weak_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;pending_weak_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;local_weak_refs++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strong &amp;&amp; !node-&gt;has_strong_ref) &#123;</div><div class="line">                cmd = BR_ACQUIRE;</div><div class="line">                cmd_name = <span class="string">"BR_ACQUIRE"</span>;</div><div class="line">                node-&gt;has_strong_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;pending_strong_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;local_strong_refs++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strong &amp;&amp; node-&gt;has_strong_ref) &#123;</div><div class="line">                cmd = BR_RELEASE;</div><div class="line">                cmd_name = <span class="string">"BR_RELEASE"</span>;</div><div class="line">                node-&gt;has_strong_ref = <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!weak &amp;&amp; node-&gt;has_weak_ref) &#123;</div><div class="line">                cmd = BR_DECREFS;</div><div class="line">                cmd_name = <span class="string">"BR_DECREFS"</span>;</div><div class="line">                node-&gt;has_weak_ref = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// å‘ç”¨æˆ·ç©ºé—´è¿”å›å‘½ä»¤</span></div><div class="line">            <span class="keyword">if</span> (cmd != BR_NOOP) &#123;</div><div class="line">                <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">                <span class="keyword">if</span> (put_user(node-&gt;ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">                <span class="keyword">if</span> (put_user(node-&gt;cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line"></div><div class="line">                binder_stat_br(proc, thread, cmd);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                list_del_init(&amp;w-&gt;entry);</div><div class="line">                <span class="keyword">if</span> (!weak &amp;&amp; !strong) &#123;</div><div class="line">                    rb_erase(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</div><div class="line">                    kfree(node);</div><div class="line">                    binder_stats_deleted(BINDER_STAT_NODE);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span>;</span></div><div class="line">            <span class="keyword">uint32_t</span> cmd;</div><div class="line"></div><div class="line">            <span class="comment">// è·å– binder_ref_death å¯¹è±¡</span></div><div class="line">            death = container_of(w, struct binder_ref_death, work);</div><div class="line">            <span class="comment">// æ„é€ è¿”å›å‘½ä»¤</span></div><div class="line">            <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</div><div class="line">                cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                cmd = BR_DEAD_BINDER;</div><div class="line">            <span class="comment">// å‘ç”¨æˆ·ç©ºé—´è¿”å›å‘½ä»¤</span></div><div class="line">            <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">            <span class="comment">// å°† cookie è¿”å›ç»™ç”¨æˆ·ç©ºé—´</span></div><div class="line">            <span class="keyword">if</span> (put_user(death-&gt;cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</div><div class="line">            binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</div><div class="line">                list_del(&amp;w-&gt;entry);</div><div class="line">                kfree(death);</div><div class="line">                binder_stats_deleted(BINDER_STAT_DEATH);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">                list_move(&amp;w-&gt;entry, &amp;proc-&gt;delivered_death);</div><div class="line">            <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</div><div class="line">                <span class="keyword">goto</span> done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!t)</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (t-&gt;buffer-&gt;target_node) &#123;</div><div class="line">            <span class="comment">// è·å¾— binder_node èŠ‚ç‚¹</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">t</span>-&gt;<span class="title">buffer</span>-&gt;<span class="title">target_node</span>;</span></div><div class="line">            <span class="comment">// å°†æ•°æ®å°è£…åˆ° binder_transaction_data å¯¹è±¡</span></div><div class="line">            tr.target.ptr = target_node-&gt;ptr;</div><div class="line">            tr.cookie =  target_node-&gt;cookie;</div><div class="line">            t-&gt;saved_priority = task_nice(current);</div><div class="line">            <span class="keyword">if</span> (t-&gt;priority &lt; target_node-&gt;min_priority &amp;&amp;</div><div class="line">                !(t-&gt;flags &amp; TF_ONE_WAY))</div><div class="line">                binder_set_nice(t-&gt;priority);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY) ||</div><div class="line">                 t-&gt;saved_priority &gt; target_node-&gt;min_priority)</div><div class="line">                binder_set_nice(target_node-&gt;min_priority);</div><div class="line">            <span class="comment">// è®¾ç½®è¿”å›çš„å‘½ä»¤ç±»å‹</span></div><div class="line">            cmd = BR_TRANSACTION;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            tr.target.ptr = <span class="literal">NULL</span>;</div><div class="line">            tr.cookie = <span class="literal">NULL</span>;</div><div class="line">            cmd = BR_REPLY;</div><div class="line">        &#125;</div><div class="line">        tr.code = t-&gt;code;</div><div class="line">        tr.flags = t-&gt;flags;</div><div class="line">        tr.sender_euid = t-&gt;sender_euid;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (t-&gt;from) &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">sender</span> = <span class="title">t</span>-&gt;<span class="title">from</span>-&gt;<span class="title">proc</span>-&gt;<span class="title">tsk</span>;</span></div><div class="line">            tr.sender_pid = task_tgid_nr_ns(sender,</div><div class="line">                            current-&gt;nsproxy-&gt;pid_ns);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            tr.sender_pid = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tr.data_size = t-&gt;buffer-&gt;data_size;</div><div class="line">        tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</div><div class="line">        tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data +</div><div class="line">                    proc-&gt;user_buffer_offset;</div><div class="line">        tr.data.ptr.offsets = tr.data.ptr.buffer +</div><div class="line">                    ALIGN(t-&gt;buffer-&gt;data_size,</div><div class="line">                        <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</div><div class="line">        <span class="comment">// æ‹·è´ binder_transaction_data å¯¹è±¡åˆ°ç”¨æˆ·ç©ºé—´</span></div><div class="line">        <span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, <span class="keyword">sizeof</span>(tr)))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += <span class="keyword">sizeof</span>(tr);</div><div class="line"></div><div class="line">        binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">        <span class="comment">// ç§»é™¤ binder_transaction å¹¶é‡Šæ”¾ç©ºé—´</span></div><div class="line">        list_del(&amp;t-&gt;work.entry);</div><div class="line">        t-&gt;buffer-&gt;allow_user_free = <span class="number">1</span>;</div><div class="line">        <span class="comment">// å¦‚æœæ˜¯åŒæ­¥æ“ä½œï¼Œåˆ™å°† thread å¯¹è±¡ä¿å­˜åœ¨ binder_transaction ä¸­ï¼Œè¿”å›ç»™å‘é€æ–¹è¿›ç¨‹, å¦åˆ™é‡Šæ”¾ binder_transaction å¯¹è±¡</span></div><div class="line">        <span class="keyword">if</span> (cmd == BR_TRANSACTION &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</div><div class="line">            t-&gt;to_parent = thread-&gt;transaction_stack;</div><div class="line">            t-&gt;to_thread = thread;</div><div class="line">            thread-&gt;transaction_stack = t;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            t-&gt;buffer-&gt;transaction = <span class="literal">NULL</span>;</div><div class="line">            kfree(t);</div><div class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡º binder é©±åŠ¨çš„å…·ä½“å®ç°ï¼Œä»¥åŠæ˜¯å¦‚ä½•å‘é€å’Œæ¥æ”¶æ•°æ®çš„ã€‚</p>
<h2 id="5-Binder-ä¸ç³»ç»ŸæœåŠ¡"><a href="#5-Binder-ä¸ç³»ç»ŸæœåŠ¡" class="headerlink" title="5. Binder ä¸ç³»ç»ŸæœåŠ¡"></a>5. Binder ä¸ç³»ç»ŸæœåŠ¡</h2><h3 id="5-1-Context-getSystemService"><a href="#5-1-Context-getSystemService" class="headerlink" title="5.1 Context.getSystemService()"></a>5.1 Context.getSystemService()</h3><p>Android ç³»ç»Ÿåœ¨å¯åŠ¨åä¼šåœ¨åå°è¿è¡Œå¾ˆå¤šç³»ç»ŸæœåŠ¡æä¾›ç»™åº”ç”¨ä½¿ç”¨ï¼Œè¿™äº› <a href="http://developer.android.com/reference/android/content/Context.html#getSystemService(java.lang.Class&lt;T" target="_blank" rel="external">æœåŠ¡</a>) ä¸»è¦æœ‰ <code>WindowManager, LayoutInflater, ActivityManager, PowerManager, AlarmManager, NotificationManager, KeyguardManager, LocationManager, SearchManager, Vibrator, ConnectivityManager, WifiManager, AudioManager, MediaRouter, TelephonyManager, SubscriptionManager, InputMethodManager, UiModeManager, DownloadManager, BatteryManager, JobScheduler, NetworkStatsManager</code></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Context.getSystemService(String name)</code> æ¥è·å– <a href="http://developer.android.com/reference/android/content/Context.html#getSystemService(java.lang.String" target="_blank" rel="external">æœåŠ¡</a>)ã€‚</p>
<p>ä¾‹å¦‚ å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•ä» xml ä¸­æ’å…¥æ–°çš„è§†å›¾</p>
<pre><code>LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);
inflater.inflate(R.layout.view, root, true);
</code></pre><h3 id="5-2-Context-getSystemService-æºç åˆ†æ"><a href="#5-2-Context-getSystemService-æºç åˆ†æ" class="headerlink" title="5.2 Context.getSystemService() æºç åˆ†æ"></a>5.2 Context.getSystemService() æºç åˆ†æ</h3><p>è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/ContextImpl.java#L1364" target="_blank" rel="external">ContextImpl</a> <code>getSystemService()</code> æºä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/SystemServiceRegistry.java#L719" target="_blank" rel="external">SystemServiceRegistry</a> æºä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Gets a system service from a given context.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</div><div class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</div><div class="line">    <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿½è¸ª <code>SYSTEM_SERVICE_FETCHERS</code> å¯ä»¥å‘ç°åœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/SystemServiceRegistry.java#L318" target="_blank" rel="external">SystemServiceRegistry</a> é™æ€åŒºä¸­æ³¨å†Œäº†å‡ ä¹æ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</div><div class="line">        <span class="keyword">new</span> CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PhoneLayoutInflater(ctx.getOuterContext());</div><div class="line">    &#125;&#125;);</div><div class="line"></div><div class="line">registerService(Context.LOCATION_SERVICE, LocationManager.class,</div><div class="line">        <span class="keyword">new</span> CachedServiceFetcher&lt;LocationManager&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LocationManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        IBinder b = ServiceManager.getService(Context.LOCATION_SERVICE);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocationManager(ctx, ILocationManager.Stub.asInterface(b));</div><div class="line">    &#125;&#125;);</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ç‰‡æ–­ä¸­ï¼Œ<a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/app/SystemServiceRegistry.java#L322" target="_blank" rel="external">PhoneLayoutInflater</a> æœ€ç»ˆå›åˆ°äº† <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/view/LayoutInflater.java#L204" target="_blank" rel="external">LayoutInflater</a>ã€‚è€Œ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/location/java/android/location/LocationManager.java#L315" target="_blank" rel="external">LocationManager</a> åˆ™æ˜¯å¯¹ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/location/java/android/location/ILocationManager.aidl#L39" target="_blank" rel="external">ILocationManager</a> çš„å°è£…ã€‚å¯ä»¥å‘ç°ï¼Œåœ¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/tree/master/frameworks/base/location/java/android/location" target="_blank" rel="external">frameworks/base/location/java/android/location</a> åŒ…ä¸‹å«æœ‰å¤§é‡çš„ AIDL æ–‡ä»¶ã€‚</p>
<p>ç»§ç»­è¿½è¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/ServiceManager.java#L49" target="_blank" rel="external">ServiceManager.getService(Context.LOCATION_SERVICE)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> sServiceManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Find the service manager</span></div><div class="line">    sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</div><div class="line">    <span class="keyword">return</span> sServiceManager;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns a reference to a service with the given name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> name the name of the service to get</div><div class="line"> * <span class="doctag">@return</span> a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn't exist</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        IBinder service = sCache.get(name);</div><div class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> service;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> getIServiceManager().getService(name);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"error in getService"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç ç‰‡æ–­å¯ä»¥çœ‹å‡ºï¼Œ<code>ServiceManager</code> ä¼šä» <code>sCache</code> ç¼“å­˜æˆ– <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/ServiceManagerNative.java#L33" target="_blank" rel="external">IServiceManager</a> ä¸­æŸ¥æ‰¾æœåŠ¡å¹¶è¿”å›ä¸€ä¸ª <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/IBinder.java#L85" target="_blank" rel="external">IBinder</a> å¯¹è±¡ã€‚è¿™ä¸ª <code>IBinder</code> å°±æ˜¯ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡å®ƒä¸å…¶ä»–è¿›ç¨‹äº¤äº’ã€‚</p>
<p>ç»§ç»­æ·±å…¥ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/ServiceManager.java#L55" target="_blank" rel="external">getIServiceManager().getService(name)</a> , è¿›å…¥ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/ServiceManagerNative.java#L33" target="_blank" rel="external">ServiceManagerNative</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Cast a Binder object into a service manager interface, generating</div><div class="line"> * a proxy if needed.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    IServiceManager in =</div><div class="line">        (IServiceManager)obj.queryLocalInterface(descriptor);</div><div class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> in;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        Parcel data = Parcel.obtain();</div><div class="line">        Parcel reply = Parcel.obtain();</div><div class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</div><div class="line">        data.writeString(name);</div><div class="line">        mRemote.transact(GET_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">        IBinder binder = reply.readStrongBinder();</div><div class="line">        reply.recycle();</div><div class="line">        data.recycle();</div><div class="line">        <span class="keyword">return</span> binder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> IBinder mRemote;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šè¾¹ä»£ç ç‰‡æ–­å¯ä»¥çœ‹åˆ°ï¼Œ<code>ServiceManager.getIServiceManager()</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <code>ServiceManagerProxy</code>, è€Œ <code>ServiceManager.getService()</code> åˆ™æ˜¯åœ¨ <code>ServiceManagerProxy</code> ä¸­é€šè¿‡ <code>ServiceManager</code> çš„è¿œç¨‹ <code>Binder</code> å¯¹è±¡ <code>mRemote</code>ï¼Œæ“ä½œ <code>Parcel</code> æ•°æ®ï¼Œè°ƒç”¨ <a href="https://github.com/xdtianyu/android-6.0.0_r1/blob/master/frameworks/base/core/java/android/os/IBinder.java#L223" target="_blank" rel="external">IBinder.transact(int code, Parcel data, Parcel reply, int flags)</a> æ–¹æ³•æ¥å‘é€è¯·æ±‚ï¼Œå¹¶é€šè¿‡ <code>reply.readStrongBinder()</code> è¿”å›äº†è¦æŸ¥æ‰¾çš„æœåŠ¡çš„è¿œç¨‹å¯¹è±¡ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»ŸæœåŠ¡çš„è·å–æ–¹å¼ä¹Ÿæ˜¯é€šè¿‡ AIDL çš„æ–¹å¼å®ç°çš„ã€‚</p>
<h2 id="6-ç»“è®º"><a href="#6-ç»“è®º" class="headerlink" title="6. ç»“è®º"></a>6. ç»“è®º</h2><p>1. Binder çš„å®ç°æ¶‰åŠåˆ° kernel é©±åŠ¨ï¼Œæœ¬åœ°å±‚ï¼ŒJNI å’Œåº”ç”¨å±‚ï¼Œè´¯ç©¿äº†æ•´ä¸ª ï¼¡ndroid ç³»ç»Ÿã€‚ç³»ç»ŸæœåŠ¡è·å–ã€Activity/Service å¯åŠ¨ã€Intentçš„ä¼ é€’ç­‰éƒ½ç¦»ä¸å¼€ binder,è¦æŒæ¡ binder çš„åŸç†éœ€è¦æ·±å…¥åˆ°ç³»ç»Ÿçš„æ¯ä¸€å±‚ä»£ç ã€‚</p>
<p>2. ä¸Šå±‚çš„ <code>android.os.Binder</code> åªæ˜¯å¯¹ binder çš„åˆä¸€æ¬¡æŠ½è±¡å°è£…ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ä¸­ä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥ä½¿ç”¨ã€‚</p>
<p>3. AIDL æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”¨äºå°è£… Binder æ“ä½œçš„å·¥å…·ï¼Œæœ€ç»ˆçš„è¿›ç¨‹é—´é€šä¿¡ç”± Binder çš„ <code>transact</code> å’Œ <code>onTransact</code> å®Œæˆã€‚æˆ‘ä»¬åœ¨åº”ç”¨ä¸­å®ç° AIDL æ¥å£ï¼Œå¯ä»¥å¿«é€Ÿå®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚</p>
<h2 id="7-å‚è€ƒ"><a href="#7-å‚è€ƒ" class="headerlink" title="7. å‚è€ƒ"></a>7. å‚è€ƒ</h2><p><a href="http://wangkuiwu.github.io/2014/09/01/Binder-Introduce/" target="_blank" rel="external">Android Binderæœºåˆ¶</a></p>
<p><a href="http://blog.csdn.net/luoshengyang/article/details/6618363" target="_blank" rel="external">Androidè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶Binder</a></p>
<p><a href="https://www.nds.rub.de/media/attachments/files/2012/03/binder.pdf" target="_blank" rel="external">Android Binder</a></p>
<p><a href="http://rts.lab.asu.edu/web_438/project_final/CSE_598_Android_Architecture_Binder.pdf" target="_blank" rel="external">Android Architecture Binder</a></p>
<p><a href="http://liuxiangtian.github.io/2016/01/07/AIDL%E4%B8%8EBinder%E6%A1%86%E6%9E%B6%E6%B5%85%E8%B0%88/" target="_blank" rel="external">AIDLä¸Binderæ¡†æ¶æµ…è°ˆ</a></p>
<p><a href="https://github.com/hehonghui/android-tech-frontier/blob/master/issue-22/Binder%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90.md" target="_blank" rel="external">Binderæ¡†æ¶è§£æ</a></p>
<p><a href="http://events.linuxfoundation.org/images/stories/slides/abs2013_gargentas.pdf" target="_blank" rel="external">Deep Dive into Android IPC/Binder Framework at Android Builders Summit 2013</a></p>
<p><a href="https://www.youtube.com/watch?v=NWhyADzgoiI" target="_blank" rel="external">Android Builders Summit 2013 - Deep Dive into Android IPC/Binder Framework (video)</a></p>
<p><a href="http://blog.csdn.net/u010961631/article/details/20479507" target="_blank" rel="external">Binderæºç åˆ†æä¹‹é©±åŠ¨å±‚ï¼ˆåŸï¼‰</a></p>
<p><a href="http://blog.csdn.net/yangwen123/article/details/9316987" target="_blank" rel="external">æ·±å…¥åˆ†æAndroid Binder é©±åŠ¨</a></p>
<p><a href="http://blog.csdn.net/qq429205464/article/details/7822442" target="_blank" rel="external">æ„é€ IOCTLå‘½ä»¤çš„å­¦ä¹ å¿ƒå¾—â€”â€“_IO, _IOR, _IOW, _IOWR å¹»æ•°çš„ç†è§£</a></p>
<p><a href="http://blog.csdn.net/21cnbao/article/details/8087354" target="_blank" rel="external">Serviceä¸Androidç³»ç»Ÿè®¾è®¡ï¼ˆ7ï¼‰â€” Binderé©±åŠ¨</a></p>
<p><a href="https://web.archive.org/web/20101016004342/http://www.gmier.com/node/11" target="_blank" rel="external">Android Binder</a></p>
<p><a href="http://www.cnblogs.com/zhangxinyan/p/3487889.html" target="_blank" rel="external">Binderæœºåˆ¶ï¼Œä»Javaåˆ°C ï¼ˆ7. Native Serviceï¼‰</a></p>
<hr>
<p><strong>å¾…è¡¥å……çš„å†…å®¹</strong></p>
<p>1. å®¢æˆ·ç«¯ bindService() æµç¨‹åŠæºç åˆ†æ</p>
<p>2. Binder Native å±‚å…¶ä»–æºç æ–‡ä»¶åˆ†æ</p>
<p>3. ç³»ç»ŸæœåŠ¡ï¼ˆSystemServiceï¼‰è¯¦ç»†åˆ—è¡¨åŠåœ¨æœ¬åœ°å±‚çš„æºç åˆ†æ</p>
<p>4. SystemManager æºç åˆ†æ</p>
<p>5. å®Œå–„ binder é©±åŠ¨å†…å®¹ï¼Œè¡¥å……å…³ç³»å›¾</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>AsyncTaskæºç åˆ†æ</title>
    <link href="https://likeqy.com/2017/07/26/AsyncTask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://likeqy.com/2017/07/26/AsyncTaskæºç åˆ†æ/</id>
    <published>2017-07-26T11:36:58.000Z</published>
    <updated>2017-07-26T11:42:43.373Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;label=Star" alt=""></p>
<p>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/likeqy/AndroidSource-Analysis" target="_blank" rel="external">https://github.com/likeqy/AndroidSource-Analysis</a></p>
<p>ç®€ä»‹ï¼š Androidæºç åˆ†æï¼Œè®©ä½ æ›´æ¸…æ¥šçš„ç†è§£æ¯ä¸€ä¸ªç»„ä»¶çš„åŠŸèƒ½ä¸ç”¨æ³•ã€‚</p>
<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>AsyncTaskæ˜¯androidæä¾›çš„ä¸€ç§å¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½ç®€åŒ–æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UIæ§ä»¶ï¼Œä½¿ç”¨AsyncTaskä½ å°†çœ‹ä¸åˆ°ä»»ä½•å…³äºæ“ä½œçº¿ç¨‹çš„ä»£ç </p>
<h2 id="2-ç‰ˆæœ¬å·®åˆ«"><a href="#2-ç‰ˆæœ¬å·®åˆ«" class="headerlink" title="2. ç‰ˆæœ¬å·®åˆ«"></a>2. ç‰ˆæœ¬å·®åˆ«</h2><p>2.1 çº¿ç¨‹æ± é…ç½®</p>
<ul>
<li>android3.0ä»¥å‰çº¿ç¨‹æ± é…ç½®ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = <span class="number">5</span>;<span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = <span class="number">128</span>;<span class="comment">//çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ç›®</span></div><div class="line"></div><div class="line"><span class="comment">//å½“çº¿ç¨‹æ•°ç›®å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ç›®æ—¶ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªkeepAliveTimeæ—¶é—´ï¼Œé‚£ä¹ˆç©ºé—²çš„çº¿ç¨‹ä¼šè¢«ç»ˆæ­¢</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> it KEEP_ALIVE = <span class="number">10</span>;</div><div class="line">â€¦â€¦    </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadPoolExecutor sExecutor = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE,    </div><div class="line">        MAXIMUM_POOL_SIZE, KEEP_ALIVE, TimeUnit.SECONDS, sWorkQueue, sThreadFactory);</div></pre></td></tr></table></figure>
<p>android3.0ä»¥åæ›´åŠ çµæ´»ï¼Œæ ¹æ®cpuæ ¸æ•°é…ç½®<code>CORE_POOL_SIZE</code>å’Œ<code>MAXIMUM_POOL_SIZE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ ¹æ®cpuçš„å¤§å°æ¥é…ç½®æ ¸å¿ƒçš„çº¿ç¨‹</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = CPU_COUNT + <span class="number">1</span>;<span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></div><div class="line"><span class="comment">//çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ç›®</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">1</span>;<span class="comment">//ç©ºé—²çº¿ç¨‹çš„è¶…æ—¶æ—¶é—´</span></div></pre></td></tr></table></figure>
<p>2.2 ä¸²è¡Œå’Œå¹¶è¡Œï¼Œå¼•ç”¨æ¥è‡ª<a href="http://www.jianshu.com/p/a8b1861f2efc" target="_blank" rel="external">è¿™ç¯‡æ–‡ç« </a></p>
<ul>
<li>android 1.5ä»¥å‰çš„æ—¶å€™<code>execute</code>æ˜¯ä¸²è¡Œæ‰§è¡Œçš„</li>
<li>android 1.6ç›´åˆ°android 2.3.2è¢«ä¿®æ”¹ä¸ºå¹¶è¡Œæ‰§è¡Œï¼Œæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± å°±æ˜¯THREAD_POOL_EXECUTOR</li>
<li>android 3.0ä»¥åï¼Œé»˜è®¤ä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå¦‚æœæƒ³è¦å¹¶è¡Œæ‰§è¡Œä»»åŠ¡å¯è°ƒç”¨<code>executeOnExecutor(Executor exec, Params.. params)</code></li>
</ul>
<p>å…·ä½“ç”¨æ³•å¯å‚ç…§<a href="http://glanwang.com/post/android/android-asynctaskde-pian-zhu" target="_blank" rel="external">Android AsyncTaskçš„éª—æœ¯</a></p>
<h2 id="3-åŸºæœ¬ç”¨æ³•"><a href="#3-åŸºæœ¬ç”¨æ³•" class="headerlink" title="3. åŸºæœ¬ç”¨æ³•"></a>3. åŸºæœ¬ç”¨æ³•</h2><h3 id="3-1-ç»§æ‰¿AsyncTaskï¼Œè®¾ç½®å­ç±»ä¸‰ä¸ªæ³›å‹çš„å‚æ•°"><a href="#3-1-ç»§æ‰¿AsyncTaskï¼Œè®¾ç½®å­ç±»ä¸‰ä¸ªæ³›å‹çš„å‚æ•°" class="headerlink" title="3.1 ç»§æ‰¿AsyncTaskï¼Œè®¾ç½®å­ç±»ä¸‰ä¸ªæ³›å‹çš„å‚æ•°"></a>3.1 ç»§æ‰¿AsyncTaskï¼Œè®¾ç½®å­ç±»ä¸‰ä¸ªæ³›å‹çš„å‚æ•°</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span>&lt;<span class="title">Params</span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>Params     å¼‚æ­¥ä»»åŠ¡å¤„ç†çš„å‚æ•°</li>
<li>Progress   å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¿”å›ç»™ä¸»çº¿ç¨‹çš„è¿›åº¦å€¼ï¼Œé€šè¿‡publishProgress()æ–¹æ³•å‘é€å‡ºå»</li>
<li>Result     å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸè¿”å›çš„ç»“æœçš„ç»“æœç±»å‹ï¼Œå¯ä»¥ä¸ºbooleanï¼Œæˆ–è€…bitmapç­‰ç±»å‹</li>
</ul>
<h3 id="3-2-å­ç±»å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•"><a href="#3-2-å­ç±»å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•" class="headerlink" title="3.2 å­ç±»å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•"></a>3.2 å­ç±»å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•</h3><ul>
<li>onPreExecute</li>
</ul>
<p>æ‰§è¡Œåå°è€—æ—¶æ“ä½œå‰è¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºå®Œæˆä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚2.3ä¾‹å­ä¸­åˆå§‹åŒ–dialogçš„æ“ä½œï¼Œæˆ–è€…ä¸€äº›é›†åˆå®¹å™¨</p>
<ul>
<li>doInBackGround</li>
</ul>
<p>å¿…é¡»å®ç°ï¼Œå¼‚æ­¥æ‰§è¡Œåå°çº¿ç¨‹å°†è¦å®Œæˆçš„ä»»åŠ¡(è¯¥æ–¹æ³•åœ¨å­çº¿ç¨‹è¿è¡Œï¼Œä¸‹é¢æºç ä¼šåˆ†æåˆ°)</p>
<ul>
<li>onProgressUpdate</li>
</ul>
<p>åœ¨doInBackGroundæ–¹æ³•ä¸­è°ƒç”¨publishProgressæ–¹æ³•ï¼ŒAsyncTaskå°±ä¼šä¸»åŠ¨è°ƒç”¨onProgressUpdateå®ç°æ›´æ–°</p>
<p>ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦</p>
<ul>
<li>onPostExecute</li>
</ul>
<p>å½“doInBackGroundå®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œé”€æ¯ä¸€äº›dialogçš„æ“ä½œï¼Œå¹¶å°†doInBackGroundæ–¹æ³•è¿”å›çš„å€¼ä¼ ç»™è¯¥æ–¹æ³•</p>
<p>æ‰§è¡Œçš„å¤§è‡´æµç¨‹æ˜¯ï¼š</p>
<p><code>onPreExecute</code>-&gt; <code>doInBackGround</code>-&gt;<code>onProgressUpdate(è°ƒç”¨publishProgressçš„æ—¶å€™)</code>-&gt;<code>onPostExecute</code></p>
<h3 id="3-3-ç”¨æ³•æ¡ˆä¾‹"><a href="#3-3-ç”¨æ³•æ¡ˆä¾‹" class="headerlink" title="3.3 ç”¨æ³•æ¡ˆä¾‹"></a>3.3 ç”¨æ³•æ¡ˆä¾‹</h3><p>1ã€å®ä¾‹åŒ–å­ç±»<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¸²è¡Œå®ä¾‹åŒ–</span></div><div class="line"><span class="keyword">new</span> DownAsyncTask().extcute();</div><div class="line"><span class="comment">//å¹¶è¡Œå®ä¾‹åŒ–</span></div><div class="line"><span class="keyword">new</span> DownAsyncTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR,<span class="string">""</span>);</div></pre></td></tr></table></figure></p>
<p>2ã€ç‚¹å‡»æŸ¥çœ‹ï¼Œ<a href="https://github.com/white37/AndroidSdkSourceAnalysis/blob/master/source/AsyntaskActivity.java" target="_blank" rel="external">ä»£ç æ¡ˆä¾‹</a></p>
<h3 id="3-4-å–æ¶ˆå¼‚æ­¥ä»»åŠ¡"><a href="#3-4-å–æ¶ˆå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="3.4 å–æ¶ˆå¼‚æ­¥ä»»åŠ¡"></a>3.4 å–æ¶ˆå¼‚æ­¥ä»»åŠ¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AsyncTask.cancel(mayInterruptIfRunning);</div></pre></td></tr></table></figure>
<p>mayInterruptIfRunningæ˜¯booleanç±»å‹çš„(æ³¨æ„è¿™é‡Œtrueå’Œfalseçš„åŒºåˆ«)ï¼Œå…¶è°ƒç”¨æµç¨‹ï¼šAsyncTask.cancel() -&gt; FutureTask.cancel()ã€‚FutureTask.cancel()çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</div><div class="line">	<span class="comment">//æ£€æµ‹å½“å‰çŠ¶æ€æ˜¯å¦æ˜¯NEW,å¦‚æœä¸æ˜¯ï¼Œè¯´æ˜ä»»åŠ¡å·²ç»å®Œæˆæˆ–å–æ¶ˆæˆ–ä¸­æ–­ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</span></div><div class="line">      <span class="keyword">if</span> (!(state == NEW &amp;&amp;</div><div class="line">            U.compareAndSwapInt(<span class="keyword">this</span>, STATE, NEW,</div><div class="line">                mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;    <span class="comment">// in case call to interrupt throws exception</span></div><div class="line">          <span class="comment">//å¦‚æœmayInterruptIfRunningä¸ºtrueçš„æ—¶å€™ï¼Œçº¿ç¨‹å°±ä¼šè°ƒç”¨interrupt()æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line">          <span class="keyword">if</span> (mayInterruptIfRunning) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  Thread t = runner;</div><div class="line">                  <span class="keyword">if</span> (t != <span class="keyword">null</span>)</div><div class="line">                  	<span class="comment">//è°ƒç”¨interruptæ–¹æ³•ï¼ŒçŠ¶æ€è®¾ç½®ä¸ºINTERRUPTINGï¼Œç„¶åè¯•ç€ä¸­æ–­çº¿ç¨‹ï¼Œå®Œæˆåè®¾ç½®çŠ¶æ€ä¸ºINTERRUPTED</span></div><div class="line">                      t.interrupt();</div><div class="line">              &#125; <span class="keyword">finally</span> &#123; <span class="comment">// final state</span></div><div class="line">                  U.putOrderedInt(<span class="keyword">this</span>, STATE, INTERRUPTED);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          <span class="comment">//é€šçŸ¥ç­‰å¾…çº¿ç¨‹çš„ç»“æœï¼ˆå› ä¸ºFutureTask.get()æ³•è·å¾—è®¡ç®—ç»“æœçš„å”¯ä¸€æ–¹æ³•ï¼Œå¦‚æœè®¡ç®—æ²¡æœ‰å®Œæˆï¼Œæ­¤æ–¹æ³•ä¼šå µå¡ç›´åˆ°è®¡ç®—å®Œæˆï¼‰</span></div><div class="line">          finishCompletion();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»£ç ä¾‹å­ä¸­<code>doInBackground()</code>ä¸­æ³¨é‡Šçš„ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å¼ºè°ƒtrueå’Œfalseçš„åŒºåˆ«</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">        Thread.sleep(<span class="number">2000</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e)</div><div class="line">    &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>å¦‚æœçº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä¸ºtrueåˆ™æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å°†ä¼šä¸­æ–­ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ‰§è¡Œçš„ä»»åŠ¡çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡Œå®Œæ¯•è°ƒç”¨<code>onCanceled()</code>ã€‚ä¸ºfalseåˆ™æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸ä¼šä¸­æ–­ï¼Œä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è°ƒç”¨<code>onCanceled()</code></p>
</li>
<li><p>å¦‚æœçº¿ç¨‹ä¸å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä¸ºtrueå’Œfalseéƒ½æ²¡æœ‰åŒºåˆ«ï¼Œä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè°ƒç”¨<code>onCanceled()</code><br>æ­£ç¡®åœ°å–æ¶ˆè¦åœ¨<code>doInBackground(Void... params)</code>ä½¿ç”¨<code>isCancelled()</code>æ¥åˆ¤æ–­ï¼Œé€€å‡ºå¾ªç¯æ“ä½œã€‚å¦‚ä¸‹é¢çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Boolean <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (progress &lt; <span class="number">10000</span>) &#123;</div><div class="line">        progress = progress + <span class="number">2</span>;</div><div class="line">        Log.i(<span class="string">"å½“å‰çš„è¿›åº¦"</span>, <span class="string">"progress=="</span> + progress);</div><div class="line">        publishProgress(progress);</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯è°ƒç”¨äº†AsyncTask.cancel(mayInterruptIfRunning)ï¼Œå¦‚æœå·²ç»è°ƒç”¨äº†ï¼Œ</span></div><div class="line">        <span class="keyword">if</span>(isCancelled())</div><div class="line">        &#123;</div><div class="line">           <span class="keyword">break</span>;<span class="comment">//è·³å‡ºå¾ªç¯ï¼Œé©¬ä¸Šè°ƒç”¨onCancelled()æ–¹æ³•ï¼Œä¸éœ€è¦ç­‰doInBackgroundæ‰§è¡Œå®Œä»»åŠ¡</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4-AsyncTaskæºç åˆ†æ-åŸºäºandroid3-0ä»¥ååˆ†æ"><a href="#4-AsyncTaskæºç åˆ†æ-åŸºäºandroid3-0ä»¥ååˆ†æ" class="headerlink" title="4. AsyncTaskæºç åˆ†æ(åŸºäºandroid3.0ä»¥ååˆ†æ)"></a>4. AsyncTaskæºç åˆ†æ(åŸºäºandroid3.0ä»¥ååˆ†æ)</h2><h3 id="4-1-AsyncTaskæ„é€ å‡½æ•°"><a href="#4-1-AsyncTaskæ„é€ å‡½æ•°" class="headerlink" title="4.1 AsyncTaskæ„é€ å‡½æ•°"></a>4.1 AsyncTaskæ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**AsyncTaskçš„æ„é€ å‡½æ•°æºç ç‰‡æ®µ**/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">     mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">         <span class="comment">//å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™å›è°ƒcallæ–¹æ³•</span></div><div class="line">         <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">             mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">             <span class="comment">//è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§</span></div><div class="line">             Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">             <span class="comment">//noinspection unchecked</span></div><div class="line">             Result result = doInBackground(mParams);</div><div class="line">             Binder.flushPendingCommands();</div><div class="line">             <span class="comment">//å°†ç»“æœå‘é€å‡ºå»</span></div><div class="line">             <span class="keyword">return</span> postResult(result);</div><div class="line">         &#125;</div><div class="line">     &#125;;</div><div class="line"></div><div class="line">     mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">         <span class="comment">//ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åä¼šè°ƒç”¨doneæ–¹æ³•</span></div><div class="line">         <span class="meta">@Override</span></div><div class="line">         <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">             <span class="keyword">try</span> &#123;</div><div class="line">                 <span class="comment">//get()è¡¨ç¤ºè·å–mWorkerçš„callçš„è¿”å›å€¼ï¼Œå³Result.ç„¶åçœ‹postResultIfNotInvokedæ–¹æ³•</span></div><div class="line">                 postResultIfNotInvoked(get());</div><div class="line">             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                 android.util.Log.w(LOG_TAG, e);</div><div class="line">             &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                         e.getCause());</div><div class="line">             &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                 postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>AsyncTaskçš„å®ä¾‹åŒ–æ˜¯åœ¨UIçº¿ç¨‹ä¸­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//@MainThreadè¡¨ç¤ºè¿™ä¸ªåŠ¨ä½œæ˜¯åœ¨UIçº¿ç¨‹ä¸­å®Œæˆ</span></div><div class="line"><span class="meta">@MainThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>æ„é€ å‡½æ•°åˆå§‹åŒ–äº†ä¸¤ä¸ªæˆå‘˜å˜é‡mWorkerå’ŒmFutureã€‚mWorkerä¸ºWorkerRunnableç±»å‹çš„åŒ¿åå†…éƒ¨ç±»å®ä¾‹å¯¹è±¡ï¼ˆå®ç°äº†Callableæ¥å£ï¼‰ï¼ŒmFutureä¸ºFutureTaskç±»å‹çš„åŒ¿åå†…éƒ¨ç±»å®ä¾‹å¯¹è±¡ï¼Œå°†mWorkerä½œä¸ºmFutureçš„å½¢å‚ï¼ˆé‡å†™äº†FutureTaskç±»çš„doneæ–¹æ³•ï¼‰ã€‚</p>
<ul>
<li>WorkerRunnableæ˜¯ä¸€ä¸ªå®ç°äº†Callableçš„æŠ½è±¡ç±»ï¼Œæ‰©å±•äº†Callableå¤šäº†ä¸€ä¸ªParamså‚æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt;</span></div><div class="line">&#123;</div><div class="line">        Params[] mParams;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸‹é¢è®²è¿°ä¸‹Callableå’ŒRunnableçš„åŒºåˆ«</p>
<ul>
<li>Callableçš„æ¥å£æ–¹æ³•æ˜¯callï¼ŒRunnableæ˜¯run</li>
<li>Callableå¯ä»¥å¸¦è¿”å›å€¼ï¼ŒRunnableä¸è¡Œï¼Œç»“æœé€šè¿‡Future.get()è·å–</li>
<li>Callableå¯ä»¥æ•è·å¼‚å¸¸ï¼ŒRunnableä¸è¡Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableAndFuture</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Callable&lt;Integer&gt; callable = <span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="comment">//é‚£WorkerRunnableçš„å›è°ƒæ–¹æ³•callè‚¯å®šæ˜¯åœ¨FutureTaskä¸­è°ƒç”¨çš„</span></div><div class="line">        FutureTask&lt;Integer&gt; future = <span class="keyword">new</span> FutureTask&lt;Integer&gt;(callable)</div><div class="line">      );</div><div class="line">        <span class="keyword">new</span> Thread(future).start();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(<span class="number">5000</span>);<span class="comment">// å¯èƒ½åšä¸€äº›äº‹æƒ…</span></div><div class="line">            System.out.println(future.get());</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FutureTaskçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼Œ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (callable == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="comment">//å°†AsyncTaské‡Œé¢åˆå§‹åŒ–çš„callableèµ‹å€¼ç»™FutureTaské‡Œé¢çš„callableï¼Œè¯å®äº†WorkerRunnableçš„å›è°ƒæ–¹æ³•callè‚¯å®šæ˜¯åœ¨FutureTaskä¸­è°ƒç”¨çš„</span></div><div class="line">    <span class="keyword">this</span>.callable = callable;</div><div class="line">    <span class="keyword">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹FutureTaskç±»ï¼Œå®ƒå®ç°äº†æ¥å£Runnable<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; // å®ç°äº†<span class="title">RunnableFuture</span>æ¥å£</span></div></pre></td></tr></table></figure></p>
<p>ä½œä¸ºRunnableè¢«çº¿ç¨‹æ‰§è¡Œï¼ŒåŒæ—¶å°†Callableä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ä¼ å…¥ï¼Œè¿™æ ·ç»„åˆçš„å¥½å¤„æ˜¯ï¼Œå‡è®¾æœ‰ä¸€ä¸ªå¾ˆè€—æ—¶çš„è¿”å›å€¼éœ€è¦è®¡ç®—ï¼Œå¹¶ä¸”è¿™ä¸ªè¿”å›å€¼ä¸æ˜¯ç«‹åˆ»éœ€è¦çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªç»„åˆï¼Œç”¨å¦ä¸€ä¸ªçº¿ç¨‹å»è®¡ç®—è¿”å›å€¼ï¼Œè€Œå½“å‰çº¿ç¨‹åœ¨ä½¿ç”¨è¿™ä¸ªè¿”å›å€¼ä¹‹å‰å¯ä»¥åšå…¶å®ƒçš„æ“ä½œï¼Œç­‰åˆ°éœ€è¦è¿™ä¸ªè¿”å›å€¼æ—¶ï¼Œå†é€šè¿‡Futureå¾—åˆ°ã€‚FutureTaskçš„runæ–¹æ³•è¦å¼€å§‹å›è°ƒWorkerRunableçš„callæ–¹æ³•äº†ï¼Œcallé‡Œé¢è°ƒç”¨doInBackground(mParams)ï¼Œç»ˆäºå›åˆ°æˆ‘ä»¬åå°ä»»åŠ¡äº†ï¼Œè°ƒç”¨æˆ‘ä»¬AsyncTaskå­ç±»çš„<code>doInBackground()</code>ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡º<code>doInBackground()</code>æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="/images/FutureTask.png" alt=""></p>
<h3 id="4-2-æ ¸å¿ƒæ–¹æ³•"><a href="#4-2-æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="4.2 æ ¸å¿ƒæ–¹æ³•"></a>4.2 æ ¸å¿ƒæ–¹æ³•</h3><p>1ã€execute()æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"></div><div class="line"> <span class="comment">/** AsyncTaskç±»çš„executeæ–¹æ³•**/</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">    <span class="comment">//è°ƒç”¨executeOnExecutoræ–¹æ³•</span></div><div class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å½“æ‰§è¡Œexecuteæ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†executeOnExecutoræ–¹æ³•ã€‚è¿™é‡Œä¼ é€’äº†ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯sDefaultExecutorï¼Œä¸€ä¸ªæ˜¯paramsã€‚ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹å‡ºï¼ŒsDefaultExecutorå…¶å®æ˜¯ä¸€ä¸ªSerialExecutorå¯¹è±¡ï¼Œå®ç°äº†ä¸²è¡Œçº¿ç¨‹é˜Ÿåˆ—ã€‚paramså…¶å®æœ€ç»ˆä¼šèµ‹ç»™doInBackgroundæ–¹æ³•å»å¤„ç†ã€‚</p>
<p>2ã€executeOnExecutor()æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//execæ‰§è¡ŒAsyncTask.execute()æ–¹æ³•æ—¶ä¼ é€’è¿›æ¥çš„å‚æ•°sDefaultExecutorï¼Œè¿™ä¸ªsDefaultExecutorå…¶å®å°±æ˜¯SerialExecutorå¯¹è±¡ã€‚é»˜è®¤æ˜¯ä¸²è¡Œæ‰§è¡Œçš„</span></div><div class="line"><span class="comment">//è‹¥æƒ³å˜æˆå¹¶å‘æ‰§è¡Œexecå¯ä»¥ä¼ å…¥AsyncTask.THREAD_POOL_EXECUTORã€‚</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">            Params... params) &#123;</div><div class="line">        <span class="comment">//å¦‚æœä¸€ä¸ªä»»åŠ¡å·²ç»è¿›å…¥æ‰§è¡Œçš„çŠ¶æ€ï¼Œå†æ‰§è¡Œå°±ä¼šæŠ›å¼‚å¸¸ã€‚è¿™å°±å†³å®šäº†ä¸€ä¸ªAsyncTaskåªèƒ½æ‰§è¡Œä¸€æ¬¡</span></div><div class="line">        <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">            <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">                <span class="keyword">case</span> RUNNING:</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                            + <span class="string">" the task is already running."</span>);</div><div class="line">                <span class="keyword">case</span> FINISHED:</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                            + <span class="string">" the task has already been executed "</span></div><div class="line">                            + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">	<span class="comment">//ä¸€æ—¦executeOnExecutorè°ƒç”¨äº†å°±æ ‡è®°ä¸ºè¿è¡ŒçŠ¶æ€</span></div><div class="line">        mStatus = Status.RUNNING;</div><div class="line">	<span class="comment">//å®é™…æ˜¯è°ƒç”¨å­ç±»é‡Œé¢çš„onPreExecute</span></div><div class="line">        onPreExecute();</div><div class="line">	<span class="comment">//å°†å¤„ç†çš„å‚æ•°ç±»å‹èµ‹å€¼ç»™mWorker</span></div><div class="line">        mWorker.mParams = params;</div><div class="line">        <span class="comment">//executeæ˜¯è°ƒç”¨SERIAL_EXECUTORçš„executeï¼ŒmFutureå°±æ˜¯ä¹‹å‰AsyncTaskæ„é€ åˆå§‹åŒ–èµ‹å€¼çš„FutureTaskã€‚</span></div><div class="line">        exec.execute(mFuture);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹ï¼ŒAsyncTaskçš„å¼‚æ­¥ä»»åŠ¡æœ‰ä¸‰ç§çŠ¶æ€</p>
<ul>
<li>PENDING å¾…æ‰§è¡ŒçŠ¶æ€ã€‚å½“AsyncTaskè¢«åˆ›å»ºæ—¶ï¼Œå°±è¿›å…¥äº†PENDINGçŠ¶æ€ã€‚</li>
<li>RUNNING è¿è¡ŒçŠ¶æ€ã€‚å½“è°ƒç”¨executeOnExecutorï¼Œå°±è¿›å…¥äº†RUNNINGçŠ¶æ€ã€‚</li>
<li>FINISHED ç»“æŸçŠ¶æ€ã€‚å½“AsyncTaskå®Œæˆ(ç”¨æˆ·cancel()æˆ–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•)æ—¶ï¼Œå°±è¿›å…¥äº†FINISHEDçŠ¶æ€ã€‚</li>
</ul>
<p>3ã€SerialExecutorçš„executeæ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">	<span class="comment">//å¾ªç¯æ•°ç»„å®ç°çš„åŒå‘Queueã€‚å¤§å°æ˜¯2çš„å€æ•°ï¼Œé»˜è®¤æ˜¯16ã€‚æœ‰é˜Ÿå¤´é˜Ÿå°¾ä¸¤ä¸ªä¸‹æ ‡</span></div><div class="line">      <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">      <span class="comment">//å½“å‰æ­£åœ¨è¿è¡Œçš„runnable</span></div><div class="line">      Runnable mActive;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">          <span class="comment">//æ·»åŠ åˆ°åŒç«¯é˜Ÿåˆ—é‡Œé¢å»</span></div><div class="line">          mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                  	<span class="comment">//æ‰§è¡Œçš„æ˜¯mFutureå°±æ˜¯ä¹‹å‰AsyncTaskæ„é€ åˆå§‹åŒ–èµ‹å€¼çš„FutureTaskçš„run()æ–¹æ³•</span></div><div class="line">                      r.run();</div><div class="line">                  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                  	<span class="comment">//æ— è®ºæ‰§è¡Œç»“æœå¦‚ä½•éƒ½ä¼šå–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ</span></div><div class="line">                      scheduleNext();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;);</div><div class="line">          <span class="comment">//å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„runnableï¼Œä»åŒç«¯é˜Ÿåˆ—é‡Œé¢å–å‡ºä¸€ä¸ªrunnableæ”¾åˆ°çº¿ç¨‹æ± ä¸­è¿è¡Œ</span></div><div class="line">          <span class="comment">//ç¬¬ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡è¿‡æ¥çš„æ—¶å€™mActiveæ˜¯ç©ºçš„</span></div><div class="line">          <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">          	<span class="comment">//å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</span></div><div class="line">              scheduleNext();</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="comment">//ä»åŒç«¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡</span></div><div class="line">          <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">          	<span class="comment">//çº¿ç¨‹æ± æ‰§è¡Œå–å‡ºæ¥çš„ä»»åŠ¡ï¼ŒçœŸæ­£æ‰§è¡Œä»»åŠ¡çš„</span></div><div class="line">              THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;<span class="comment">//java</span></div></pre></td></tr></table></figure></p>
<p>exec.execute(mFuture)æ‰§è¡Œæ—¶ï¼ŒSerialExecutorå°†FutureTaskä½œä¸ºå‚æ•°æ‰§è¡Œexecuteæ–¹æ³•ã€‚åœ¨executeæ–¹æ³•ä¸­ï¼Œå‡è®¾FutureTaskæ’å…¥è¿›äº†ä¸¤ä¸ªä»¥ä¸Šçš„ä»»åŠ¡é˜Ÿåˆ—åˆ°mTasksä¸­ï¼Œç¬¬ä¸€æ¬¡è¿‡æ¥mActive==nullï¼Œé€šè¿‡<code>mTasks.poll()</code>å–å‡ºä¸€ä¸ªä»»åŠ¡ä¸¢ç»™çº¿ç¨‹æ± è¿è¡Œï¼Œçº¿ç¨‹æ± æ‰§è¡Œr.runï¼Œå…¶å®å°±æ˜¯æ‰§è¡ŒFutureTaskçš„runæ–¹æ³•ï¼Œå› ä¸ºä¼ é€’è¿›æ¥çš„rå‚æ•°å°±æ˜¯mFutureã€‚ç­‰åˆ°ä¸Šä¸€ä¸ªçº¿ç¨‹æ‰§å®Œr.run()å®Œä¹‹åï¼Œè¿™é‡Œæ˜¯é€šè¿‡ä¸€ä¸ªtry-finallyä»£ç å—ï¼Œå¹¶åœ¨finallyä¸­è°ƒç”¨äº†scheduleNext()æ–¹æ³•ï¼Œä¿è¯æ— è®ºå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼ŒscheduleNext()éƒ½ä¼šå–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚æ¥ç€å› ä¸ºmActiveä¸ä¸ºç©ºäº†ï¼Œä¸ä¼šå†æ‰§è¡Œ<code>`scheduleNext()</code>ï¼Œç”±äºå­˜åœ¨ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œæ¯ä¸ª Runnable è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œéƒ½è¿›å…¥å»é˜Ÿåˆ—ï¼Œç„¶ååœ¨æ‰§è¡Œå®Œåå‡ºé˜Ÿï¼Œæ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ª Runnable çš„æ‰§è¡Œæµç¨‹ã€‚ç”±æ­¤å¯çŸ¥é“è¿™æ˜¯ä¸€ä¸ªä¸²è¡Œçš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒåŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå…¶ä½™çš„å‡å¤„äºç­‰å¾…çŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">                <span class="comment">//noinspection unchecked</span></div><div class="line">                Result result = doInBackground(mParams);<span class="comment">//è°ƒç”¨å­ç±»çš„doInBackground</span></div><div class="line">                Binder.flushPendingCommands();</div><div class="line">                <span class="keyword">return</span> postResult(result);<span class="comment">//æ‰§è¡Œå®Œåé€šè¿‡postResultç»“æœä¼ é€’å‡ºå»</span></div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>ä¸Šæ–‡ä¸­æåˆ°è°ƒç”¨<code>call()</code>çš„æµç¨‹ï¼šSerialExecutor.execute() -&gt; FutureTask.run() -&gt; WorkerRunnable.call()  å¦‚æœå›è°ƒäº†<code>call()</code>æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨äº†<code>doInBackground(mParams)</code>æ–¹æ³•ï¼Œè¿™éƒ½æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚æ‰§è¡Œå®Œåï¼Œå°†ç»“æœé€šè¿‡<code>postResult(result)</code>å‘é€å‡ºå»ã€‚</p>
<p>4ã€AsyncTaskçš„postResultæ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="comment">//è·å–ä¸€ä¸ªhandlerï¼Œç­‰åˆ°ä¸€ä¸ªæ¶ˆæ¯ï¼Œå°†ç»“æœå°è£…åœ¨Message</span></div><div class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">            <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));<span class="comment">//new AsyncTaskResult&lt;Result&gt;(this, result)å°†å¾—åˆ°çš„ç»“æœå†åšäº†ä¸€å±‚å°è£…</span></div><div class="line">    <span class="comment">//å°†æ¶ˆæ¯å‘é€åˆ°ä¸»çº¿ç¨‹ï¼Œä¼šå›è°ƒhandleMessage()æ–¹æ³•</span></div><div class="line">    message.sendToTarget();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å› ä¸º<code>postResult(Result result)</code>è¿˜æ˜¯åœ¨å­çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œå¦‚æœè¦å‘é€ç»™ä¸»çº¿ç¨‹ï¼Œå¿…é¡»é€šè¿‡Handlerã€‚æºç ä¸­ä½¿ç”¨sHandlerå¹¶å¸¦ç€MESSAGE_POST_RESULTå’Œå°è£…äº†ä»»åŠ¡æ‰§è¡Œç»“æœçš„å¯¹è±¡AsyncTaskResultï¼Œç„¶åmessage.sendToTarget()å¼€å§‹å‘æ¶ˆæ¯ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (AsyncTask.class) &#123;</div><div class="line">          <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</div><div class="line">          	<span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªInternalHandlerï¼Œç”¨ä¸å°†ç»“æœå‘é€ç»™ä¸»çº¿ç¨‹</span></div><div class="line">              sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> sHandler;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>å¹¶åœ¨InternalHandlerçš„handleMessageä¸­å¼€å§‹å¤„ç†æ¶ˆæ¯ï¼ŒInternalHandlerçš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// è¿™ä¸ªhandleræ˜¯å…³è”åˆ°ä¸»çº¿ç¨‹çš„</span></div><div class="line">        <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                <span class="comment">// There is only one result</span></div><div class="line">                result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                result.mTask.onProgressUpdate(result.mData);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>è¿™é‡Œæ ¹æ®æ¶ˆæ¯çš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœæ˜¯MESSAGE_POST_RESULTæ¶ˆæ¯ï¼Œå°±ä¼šå»æ‰§è¡Œfinish()æ–¹æ³•ï¼Œ<code>finish()</code>æºç å¦‚ä¸‹æ–‡æ‰€ç¤ºï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (isCancelled()) &#123;  </div><div class="line">        onCancelled(result);  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        onPostExecute(result);  </div><div class="line">    &#125;  </div><div class="line">    mStatus = Status.FINISHED;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>å¦‚æœä»»åŠ¡å·²ç»å–æ¶ˆäº†ï¼Œè°ƒç”¨<code>onCancelled</code>æ–¹æ³•ï¼Œå¦‚æœæ²¡è¢«å–æ¶ˆï¼Œåˆ™è°ƒç”¨onPostExecute()æ–¹æ³•ã€‚</p>
<ul>
<li>å¦‚æœ<code>doInBackground(Void... params)</code>è°ƒç”¨<code>publishProgress()</code>æ–¹æ³•ï¼Œå®é™…å°±æ˜¯å‘é€ä¸€æ¡MESSAGE_POST_PROGRESSæ¶ˆæ¯ï¼Œå°±ä¼šå»æ‰§è¡ŒonProgressUpdate()æ–¹æ³•ã€‚<code>publishProgress()</code>çš„æºç å¦‚ä¸‹æ–‡æ‰€ç¤ºï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WorkerThread</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">        getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœä½ è¿˜ä¸å¤Ÿæ¸…æ™°ï¼Œè¯·çœ‹ä¸‹é¢çš„è¿™ä¸ªæµç¨‹å›¾</p>
<p><img src="images/AsyncTaskæµç¨‹å›¾.png" alt=""></p>
<h2 id="5-AsyncTaskéœ€è¦æ³¨æ„çš„å‘"><a href="#5-AsyncTaskéœ€è¦æ³¨æ„çš„å‘" class="headerlink" title="5. AsyncTaskéœ€è¦æ³¨æ„çš„å‘"></a>5. AsyncTaskéœ€è¦æ³¨æ„çš„å‘</h2><ul>
<li>AsyncTaskçš„å¯¹è±¡å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸­å®ä¾‹åŒ–ï¼Œexecuteæ–¹æ³•ä¹Ÿè¦åœ¨ä¸»çº¿ç¨‹è°ƒç”¨(æŸ¥çœ‹3.1èŠ‚-AsyncTaskæ„é€ å‡½æ•°)</li>
<li>åŒä¸€ä¸ªAsyncTaskä»»åŠ¡åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå³åªèƒ½è°ƒç”¨ä¸€æ¬¡executeæ–¹æ³•ï¼Œå¤šæ¬¡è°ƒç”¨æ—¶å°†ä¼šæŠ›å¼‚å¸¸ï¼ˆæŸ¥çœ‹3.2é‡Œé¢çš„ç¬¬äºŒå°èŠ‚ï¼‰</li>
<li>cancel()æ–¹æ³•æ— æ³•ç›´æ¥ä¸­æ–­å­çº¿ç¨‹ï¼Œåªæ˜¯æ›´æ”¹äº†ä¸­æ–­çš„æ ‡å¿—ä½ã€‚æ§åˆ¶å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸåä¸ä¼šå›è°ƒonPostExecute()ã€‚æ­£ç¡®çš„å–æ¶ˆå¼‚æ­¥ä»»åŠ¡è¦cancel()æ–¹æ³•+doInbacground()åšåˆ¤æ–­è·³å‡ºå¾ªç¯</li>
<li>AsyncTaskåœ¨Activityé€šå¸¸ä½œä¸ºåŒ¿åçš„å†…éƒ¨ç±»æ¥ä½¿ç”¨ï¼Œå¦‚æœ AsyncTask ä¸­çš„å¼‚æ­¥ä»»åŠ¡åœ¨ Activity é€€å‡ºæ—¶è¿˜æ²¡æ‰§è¡Œå®Œæˆ–è€…é˜»å¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä¿æŒçš„å¤–éƒ¨çš„ Activity å®ä¾‹å¾—ä¸åˆ°é‡Šæ”¾ï¼ˆå†…éƒ¨ç±»ä¿æŒéšå¼å¤–éƒ¨ç±»çš„å®ä¾‹çš„å¼•ç”¨ï¼‰ï¼Œæœ€åå¯¼è‡´ä¼šå¼•èµ·OOMï¼Œè§£å†³åŠæ³•æ˜¯ï¼šåœ¨ AsyncTask ä½¿ç”¨å¼±å¼•ç”¨å¤–éƒ¨å®ä¾‹ï¼Œæˆ–è€…ä¿è¯åœ¨ Activity é€€å‡ºæ—¶ï¼Œæ‰€æœ‰çš„ AsyncTask å·²æ‰§è¡Œå®Œæˆæˆ–è¢«å–æ¶ˆ</li>
<li>ä¼šäº§ç”Ÿé˜»å¡é—®é¢˜ï¼Œå°¤å…¶æ˜¯å•ä»»åŠ¡é¡ºåºæ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ä¼šé˜»å¡å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œ</li>
<li>ä¸å»ºè®®ä½¿ç”¨AsyncTaskè¿›è¡Œç½‘ç»œæ“ä½œ</li>
</ul>
<p>AsyncTasks should ideally be used for short operations (a few seconds at the most.) If you need to keep threads running for long periods of time, it is highly recommended you use the various APIsã€‚</p>
<p>Androidæ–‡æ¡£ä¸­æœ‰å†™åˆ°AsyncTaskåº”è¯¥å¤„ç†å‡ ç§’é’Ÿçš„æ“ä½œï¼ˆé€šå¸¸ä¸ºè½»é‡çš„æœ¬åœ°IOæ“ä½œï¼‰ï¼Œç”±äºç½‘ç»œæ“ä½œå­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œå¯èƒ½è¾¾åˆ°å‡ ç§’ä»¥ä¸Šï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨ã€‚</p>
<h2 id="6-ç‰ˆæœ¬å…¼å®¹AsyncTaskCompat"><a href="#6-ç‰ˆæœ¬å…¼å®¹AsyncTaskCompat" class="headerlink" title="6. ç‰ˆæœ¬å…¼å®¹AsyncTaskCompat"></a>6. ç‰ˆæœ¬å…¼å®¹AsyncTaskCompat</h2><p><a href="http://www.jianshu.com/p/b283b5b704e5" target="_blank" rel="external">æœ‰å…´è¶£çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« </a></p>
<h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><p>å°½ç®¡AsyncTaskç°åœ¨å·²ç»å¾ˆå°‘ä½¿ç”¨äº†ï¼Œä½†æ˜¯å®ƒçš„ä¸€äº›è®¾è®¡æ€è·¯å¯ä»¥å€Ÿé‰´åˆ°æˆ‘ä»¬çš„æ¡†æ¶ä¸­ã€‚æ¯”å¦‚æˆ‘ä»¬çš„ä»£ç ä¸­å°½é‡è®¾è®¡çµæ´»ä¸€äº›ï¼Œå°±åƒAysnTaské‡Œé¢å­˜åœ¨ä¸²è¡Œã€å¹¶è¡Œçš„æ“ä½œä¸€æ ·ï¼Œæä¾›ç”¨æˆ·åŒçš„apiï¼Œè®©ç”¨æˆ·åœ¨ä¸åŒçš„åœºæ™¯ä¸‹é€‰æ‹©ä¸åŒçš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/AndroidSource-Analysis.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href
    
    </summary>
    
      <category term="æºç åˆ†æ" scheme="https://likeqy.com/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>AndroidStudioæ’ä»¶å¤§å…¨</title>
    <link href="https://likeqy.com/2017/07/25/AndroidStudio%E6%8F%92%E4%BB%B6%E5%A4%A7%E5%85%A8/"/>
    <id>https://likeqy.com/2017/07/25/AndroidStudioæ’ä»¶å¤§å…¨/</id>
    <published>2017-07-25T13:30:45.000Z</published>
    <updated>2017-07-26T11:23:12.997Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img.shields.io/github/stars/likeqy/Android-Studio-Plugins.svg?style=social&amp;label=Star" alt=""></p>
<p>#1.<a href="http://plugins.jetbrains.com/plugin/7654?pr=androidstudio" target="_blank" rel="external">GsonFormat</a><br>å¿«é€Ÿå°†jsonå­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªJava Beanï¼Œå…å»æˆ‘ä»¬æ ¹æ®jsonå­—ç¬¦ä¸²æ‰‹å†™å¯¹åº”Java Beançš„è¿‡ç¨‹ã€‚</p>
<p><img src="http://plugins.jetbrains.com/files/7654/screenshot_15729.png" alt=""></p>
<p>ä½¿ç”¨æ–¹æ³•ï¼šå¿«æ·é”®Alt+Sä¹Ÿå¯ä»¥ä½¿ç”¨Alt+Inserté€‰æ‹©GsonFormat</p>
<h1 id="2-Android-ButterKnife-Zelezny"><a href="#2-Android-ButterKnife-Zelezny" class="headerlink" title="2.Android ButterKnife Zelezny"></a>2.<a href="http://plugins.jetbrains.com/plugin/7369?pr=androidstudio" target="_blank" rel="external">Android ButterKnife Zelezny</a></h1><p>é…åˆButterKnifeå®ç°æ³¨è§£ï¼Œä»æ­¤ä¸ç”¨å†™findViewByIdï¼Œæƒ³ç€å°±çˆ½å•Šã€‚åœ¨Activityï¼ŒFragmentï¼ŒAdapterä¸­é€‰ä¸­å¸ƒå±€xmlçš„èµ„æºidè‡ªåŠ¨ç”Ÿæˆbutterknifeæ³¨è§£ã€‚</p>
<p><img src="http://plugins.jetbrains.com/files/7369/screenshot_14384.png" alt=""></p>
<p>ä½¿ç”¨æ–¹æ³•ï¼šCtrl+Shift+Bé€‰æ‹©å›¾ä¸Šæ‰€ç¤ºé€‰é¡¹</p>
<h1 id="3-Android-Code-Generator"><a href="#3-Android-Code-Generator" class="headerlink" title="3.Android Code Generator"></a>3.<a href="http://plugins.jetbrains.com/plugin/7595?pr=androidstudio" target="_blank" rel="external">Android Code Generator</a></h1><p>æ ¹æ®å¸ƒå±€æ–‡ä»¶å¿«é€Ÿç”Ÿæˆå¯¹åº”çš„Activityï¼ŒFragmentï¼ŒAdapterï¼ŒMenuã€‚</p>
<p><img src="http://plugins.jetbrains.com/files/7595/screenshot_14834.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7595/screenshot_14833.png" alt=""></p>
<h1 id="4-Android-Parcelable-code-generator"><a href="#4-Android-Parcelable-code-generator" class="headerlink" title="4.Android Parcelable code generator"></a>4.<a href="http://plugins.jetbrains.com/plugin/7332?pr=androidstudio" target="_blank" rel="external">Android Parcelable code generator</a></h1><p>JavaBeanåºåˆ—åŒ–ï¼Œå¿«é€Ÿå®ç°Parcelableæ¥å£ã€‚</p>
<p><img src="https://segmentfault.com/image?src=http://img.blog.csdn.net/20160416104459926&amp;objectId=1190000005092842&amp;token=ab29ed79d41be9e42b3a3d2ed1ec3bef" alt=""></p>
<h1 id="5-Android-Methods-Count"><a href="#5-Android-Methods-Count" class="headerlink" title="5.Android Methods Count"></a>5.<a href="http://plugins.jetbrains.com/plugin/8076?pr=androidstudio" target="_blank" rel="external">Android Methods Count</a></h1><p>æ˜¾ç¤ºä¾èµ–åº“ä¸­å¾—æ–¹æ³•æ•°</p>
<p><img src="http://plugins.jetbrains.com/files/8076/screenshot_15509.png" alt=""></p>
<h1 id="6-Lifecycle-Sorter"><a href="#6-Lifecycle-Sorter" class="headerlink" title="6.Lifecycle Sorter"></a>6.<a href="http://plugins.jetbrains.com/plugin/7742?pr=androidstudio" target="_blank" rel="external">Lifecycle Sorter</a></h1><p>å¯ä»¥æ ¹æ®Activityæˆ–è€…fragmentçš„ç”Ÿå‘½å‘¨æœŸå¯¹å…¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä½ç½®è¿›è¡Œå…ˆåæ’åºï¼Œå¿«æ·é”®Ctrl + alt + K</p>
<p><img src="http://plugins.jetbrains.com/files/7742/screenshot_15071.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7742/screenshot_15070.png" alt=""></p>
<h1 id="7-CodeGlance"><a href="#7-CodeGlance" class="headerlink" title="7.CodeGlance"></a>7.<a href="http://plugins.jetbrains.com/plugin/7275?pr=androidstudio" target="_blank" rel="external">CodeGlance</a></h1><p>åœ¨å³è¾¹å¯ä»¥é¢„è§ˆä»£ç ï¼Œå®ç°å¿«é€Ÿå®šä½</p>
<p><img src="http://plugins.jetbrains.com/files/7275/screenshot_14294.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7275/screenshot_14295.png" alt=""></p>
<h1 id="8-findBugs-IDEA"><a href="#8-findBugs-IDEA" class="headerlink" title="8.findBugs-IDEA"></a>8.<a href="http://plugins.jetbrains.com/plugin/3847?pr=androidstudio" target="_blank" rel="external">findBugs-IDEA</a></h1><p>æŸ¥æ‰¾bugçš„æ’ä»¶ï¼ŒAndroid Studioä¹Ÿæä¾›äº†ä»£ç å®¡æŸ¥çš„åŠŸèƒ½ï¼ˆAnalyze-Inspect Codeâ€¦ï¼‰</p>
<p><img src="http://plugins.jetbrains.com/old_res/icon/screenshots/FindBugs-IDEA_2541.png" alt=""></p>
<h1 id="9-ADB-WIFI"><a href="#9-ADB-WIFI" class="headerlink" title="9.ADB WIFI"></a>9.<a href="http://plugins.jetbrains.com/plugin/7856?pr=androidstudio" target="_blank" rel="external">ADB WIFI</a></h1><p>ä½¿ç”¨wifiæ— çº¿è°ƒè¯•ä½ çš„appï¼Œæ— éœ€rootæƒé™<br>ä¹Ÿå¯å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š<br><a href="http://www.jianshu.com/p/21d1b65d92a4" target="_blank" rel="external">Android wifiæ— çº¿è°ƒè¯•Appæ–°ç©æ³•ADB WIFI</a></p>
<p><img src="http://plugins.jetbrains.com/files/7856/screenshot_15153.png" alt=""></p>
<h1 id="10-AndroidPixelDimenGenerator"><a href="#10-AndroidPixelDimenGenerator" class="headerlink" title="10.AndroidPixelDimenGenerator"></a>10.<a href="https://github.com/succlz123/AndroidPixelDimenGenerator" target="_blank" rel="external">AndroidPixelDimenGenerator</a></h1><p>Android Studioè‡ªåŠ¨ç”Ÿæˆdimen.xmlæ–‡ä»¶æ’ä»¶</p>
<p><img src="https://github.com/succlz123/AndroidPixelDimenGenerator/raw/master/snapshot/1.jpeg" alt=""></p>
<h1 id="11-JsonOnlineViewer"><a href="#11-JsonOnlineViewer" class="headerlink" title="11.JsonOnlineViewer"></a>11.<a href="http://plugins.jetbrains.com/plugin/7838?pr=androidstudio" target="_blank" rel="external">JsonOnlineViewer</a></h1><p>åœ¨Android Studioä¸­è¯·æ±‚ã€è°ƒè¯•æ¥å£</p>
<p><img src="http://plugins.jetbrains.com/files/7838/screenshot_15113.png" alt=""></p>
<h1 id="12-Android-Styler"><a href="#12-Android-Styler" class="headerlink" title="12.Android Styler"></a>12.<a href="http://plugins.jetbrains.com/plugin/7972?pr=androidstudio" target="_blank" rel="external">Android Styler</a></h1><p>æ ¹æ®xmlè‡ªåŠ¨ç”Ÿæˆstyleä»£ç çš„æ’ä»¶</p>
<p><img src="http://plugins.jetbrains.com/files/7972/screenshot_15340.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7972/screenshot_15339.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7972/screenshot_15338.png" alt=""></p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage:"></a>Usage:</h2><p>a. copy lines with future style from your layout.xml file<br>b. paste it to styles.xml file with Ctrl+Shift+D (or context menu)<br>c. enter name of new style in the modal window<br>d. your style is prepared!</p>
<h1 id="13-Android-Drawable-Importer"><a href="#13-Android-Drawable-Importer" class="headerlink" title="13.Android Drawable Importer"></a>13.<a href="http://plugins.jetbrains.com/plugin/7658?pr=androidstudio" target="_blank" rel="external">Android Drawable Importer</a></h1><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å›¾ç‰‡å¯¼å…¥æ’ä»¶ã€‚å®ƒå¯¼å…¥Androidå›¾æ ‡ä¸Materialå›¾æ ‡çš„Drawable ï¼Œæ‰¹é‡å¯¼å…¥Drawable ï¼Œå¤šæºå¯¼å…¥Drawableï¼ˆå³å¯¼å…¥æŸå¼ å›¾ç‰‡å„ç§dpiå¯¹åº”çš„å›¾ç‰‡ï¼‰</p>
<p><img src="http://plugins.jetbrains.com/files/7658/screenshot_15535.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15691.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15533.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15537.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15536.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15534.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15532.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7658/screenshot_15351.png" alt=""></p>
<h1 id="14-SelectorChapek-for-Android"><a href="#14-SelectorChapek-for-Android" class="headerlink" title="14.SelectorChapek for Android"></a>14.<a href="http://plugins.jetbrains.com/plugin/7298?pr=androidstudio" target="_blank" rel="external">SelectorChapek for Android</a></h1><p>é€šè¿‡èµ„æºæ–‡ä»¶å‘½åè‡ªåŠ¨ç”ŸæˆSelectoræ–‡ä»¶ã€‚</p>
<p><img src="http://plugins.jetbrains.com/files/7298/screenshot_14292.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7298/screenshot_14291.png" alt=""><br><img src="http://plugins.jetbrains.com/files/7298/screenshot_14290.png" alt=""></p>
<h1 id="15-GenerateSerialVersionUID"><a href="#15-GenerateSerialVersionUID" class="headerlink" title="15.GenerateSerialVersionUID"></a>15.<a href="http://plugins.jetbrains.com/plugin/185?pr=androidstudio" target="_blank" rel="external">GenerateSerialVersionUID</a></h1><p>å®ç°Serializableåºåˆ—åŒ–bean</p>
<p>Adds a new action â€˜SerialVersionUIDâ€™ in the generate menu (alt + ins). The action adds an serialVersionUID field in the current class or updates it if it already exists, and assigns it the same value the standard â€˜serialverâ€™ JDK tool would return. The action is only visible when IDEA is not rebuilding its indexes, the class is serializable and either no serialVersionUID field exists or its value is different from the one the â€˜serialverâ€™ tool would return.</p>
<h1 id="16-genymotion"><a href="#16-genymotion" class="headerlink" title="16.genymotion"></a>16.<a href="http://plugins.jetbrains.com/plugin/7269?pr=androidstudio" target="_blank" rel="external">genymotion</a></h1><p>é€Ÿåº¦è¾ƒå¿«çš„androidæ¨¡æ‹Ÿå™¨</p>
<p><img src="http://plugins.jetbrains.com/files/7269/screenshot_14278.png" alt=""></p>
<h1 id="17-LeakCanary"><a href="#17-LeakCanary" class="headerlink" title="17.LeakCanary"></a>17.<a href="https://github.com/square/leakcanary" target="_blank" rel="external">LeakCanary</a></h1><p>å¸®åŠ©ä½ åœ¨å¼€å‘é˜¶æ®µæ–¹ä¾¿çš„æ£€æµ‹å‡ºå†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œä½¿ç”¨èµ·æ¥æ›´ç®€å•æ–¹ä¾¿ã€‚<br>å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š<br><a href="http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/" target="_blank" rel="external">LeakCanary ä¸­æ–‡ä½¿ç”¨è¯´æ˜</a></p>
<p><img src="http://stormzhang.com/image/leakcaneray.png" alt=""></p>
<h1 id="18-Android-Postfix-Completion"><a href="#18-Android-Postfix-Completion" class="headerlink" title="18.Android Postfix Completion"></a>18.<a href="http://plugins.jetbrains.com/plugin/7775?pr=androidstudio" target="_blank" rel="external">Android Postfix Completion</a></h1><p>å¯æ ¹æ®åç¼€å¿«é€Ÿå®Œæˆä»£ç ï¼Œè¿™ä¸ªå±äºæ‹“å±•å§ï¼Œç³»ç»Ÿå·²ç»æœ‰è¿™äº›åŠŸèƒ½ï¼Œå¦‚soutã€notnullç­‰ï¼Œè¿™ä¸ªæ’ä»¶åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šå¢æ·»äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œæˆ‘æ›´æƒ³åšçš„æ˜¯é€šè¿‡åŸä½œè€…çš„ä»£ç è‡ªå·±å®šåˆ¶åŠŸèƒ½ï¼Œé‚£å°±æ›´çˆ½äº†</p>
<p><img src="http://plugins.jetbrains.com/files/7775/screenshot_15042.png" alt=""></p>
<h1 id="19-Android-Holo-Colors-Generator"><a href="#19-Android-Holo-Colors-Generator" class="headerlink" title="19.Android Holo Colors Generator"></a>19.<a href="https://plugins.jetbrains.com/plugin/7366?pr=" target="_blank" rel="external">Android Holo Colors Generator</a></h1><p>é€šè¿‡è‡ªå®šä¹‰Holoä¸»é¢˜é¢œè‰²ç”Ÿæˆå¯¹åº”çš„Drawableå’Œå¸ƒå±€æ–‡ä»¶</p>
<p><img src="https://plugins.jetbrains.com/files/7366/screenshot_14379.png" alt=""></p>
<h1 id="20-dagger-intellij-plugin"><a href="#20-dagger-intellij-plugin" class="headerlink" title="20.dagger-intellij-plugin"></a>20.<a href="https://github.com/square/dagger-intellij-plugin" target="_blank" rel="external">dagger-intellij-plugin</a></h1><p>daggerå¯è§†åŒ–è¾…åŠ©å·¥å…·</p>
<p><img src="https://github.com/square/dagger-intellij-plugin/raw/master/images/inject-to-provide.gif" alt=""></p>
<h1 id="21-GradleDependenciesHelperPlugin"><a href="#21-GradleDependenciesHelperPlugin" class="headerlink" title="21.GradleDependenciesHelperPlugin"></a>21.<a href="https://github.com/ligi/GradleDependenciesHelperPlugin" target="_blank" rel="external">GradleDependenciesHelperPlugin</a></h1><p>maven gradle ä¾èµ–æ”¯æŒè‡ªåŠ¨è¡¥å…¨</p>
<p><img src="https://camo.githubusercontent.com/d9b1b39eda21e0e33b656e2821f01897d915f7c5/68747470733a2f2f6c68332e676f6f676c6575736572636f6e74656e742e636f6d2f2d51364e7970315864594c772f556a73325a5175666634492f414141414141414144624d2f624d704c516742664d6b632f773538372d683330392d6e6f2f696465615f677261646c655f706c7567696e2e706e67" alt=""></p>
<h1 id="22-RemoveButterKnife"><a href="#22-RemoveButterKnife" class="headerlink" title="22.RemoveButterKnife"></a>22.<a href="https://github.com/u3shadow/RemoveButterKnife" target="_blank" rel="external">RemoveButterKnife</a></h1><p>ButterKnifeè¿™ä¸ªç¬¬ä¸‰æ–¹åº“æ¯æ¬¡æ›´æ–°ä¹‹åï¼Œç»‘å®šviewçš„æ³¨è§£éƒ½ä¼šæ”¹å˜ï¼Œä»bind,åˆ°injectï¼Œå†åˆ°bindviewï¼Œæå¾—å¾ˆå¤šäººéƒ½ä¸æ•¢å‡çº§ï¼Œä¸€æ—¦å‡çº§ï¼Œå°±ä¼šæœ‰å·¨é‡çš„ä»£ç éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼Œéå¸¸ç—›è‹¦<br>å½“æˆ‘ä»¬æœ‰ä¸€äº›éå¸¸æ£’çš„ä»£ç éœ€è¦æ‹¿åˆ°å…¶ä»–é¡¹ç›®ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œé‚£ä¸ªé¡¹ç›®å¯¹ç¬¬ä¸‰æ–¹åº“çš„ä½¿ç”¨æ˜¯æœ‰é™åˆ¶çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨butterknifeï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¾—ä»æ³¨è§£æ”¹å›findviewbyid<br>é’ˆå¯¹ä¸Šé¢çš„ä¸¤ç§æƒ…å†µï¼Œå¦‚æœviewæ¯”è¾ƒå°‘è¿˜å¥½è¯´ï¼Œå¦‚æœæœ‰å‡ åä¸ªviewï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€ä¸ªä¸ªçš„æ‰‹åŠ¨åˆ é™¤æ³¨è§£ï¼Œå†™findviewbyidè¯­å¥ï¼Œç®€ç›´æ˜¯ä¸€åœºå™©æ¢¦ï¼ˆåˆ«é—®æˆ‘ä¸ºä»€ä¹ˆçŸ¥é“è¿™æ˜¯å™©æ¢¦ï¼‰<br>æ‰€ä»¥ï¼Œè¿™ç§æœ‰è§„å¾‹åˆé‡å¤ç®€å•çš„å·¥ä½œä¸ºä»€ä¹ˆä¸èƒ½ç”¨ä¸€ä¸ªæ’ä»¶æ¥å®ç°å‘¢ï¼Ÿäºæ˜¯RemoveButterKnifeçš„æƒ³æ³•å°±å‡ºç°äº†ã€‚</p>
<p><a href="http://www.u3coding.com/2016/06/24/androidstudio-plugin-removebutterknife-di/" target="_blank" rel="external">å…·ä½“ä»‹ç»</a></p>
<p><img src="https://camo.githubusercontent.com/0327cda5b531ab6f2b803abe295c42225668d28d/687474703a2f2f7777772e7533636f64696e672e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031362f30362f312e676966" alt=""></p>
<h1 id="23-AndroidProguardPlugin"><a href="#23-AndroidProguardPlugin" class="headerlink" title="23.AndroidProguardPlugin"></a>23.<a href="https://github.com/zhonghanwen/AndroidProguardPlugin" target="_blank" rel="external">AndroidProguardPlugin</a></h1><p>ä¸€é”®ç”Ÿæˆé¡¹ç›®æ··æ·†ä»£ç æ’ä»¶ï¼Œå€¼å¾—ä½ å®‰è£…~(ä¸è¿‡ç›®å‰å¯èƒ½æœ‰äº›ç¬¬ä¸‰æ–¹é¡¹ç›®çš„æ··æ·†è¿˜æœªæ·»åŠ å®Œå…¨)</p>
<p><img src="http://7xrnko.com1.z0.glb.clouddn.com/androidproguard1.gif" alt=""></p>
<h1 id="24-otto-intellij-plugin"><a href="#24-otto-intellij-plugin" class="headerlink" title="24.otto-intellij-plugin"></a>24.<a href="https://github.com/square/otto-intellij-plugin" target="_blank" rel="external">otto-intellij-plugin</a></h1><p>ottoäº‹ä»¶å¯¼èˆªå·¥å…·ã€‚</p>
<p><img src="https://github.com/square/otto-intellij-plugin/raw/master/images/produce-to-subscribe.gif" alt=""><br><img src="https://github.com/square/otto-intellij-plugin/raw/master/images/event-to-subscribe.gif" alt=""></p>
<h1 id="25-eventbus-intellij-plugin"><a href="#25-eventbus-intellij-plugin" class="headerlink" title="25.eventbus-intellij-plugin"></a>25.<a href="https://github.com/kgmyshin/eventbus-intellij-plugin" target="_blank" rel="external">eventbus-intellij-plugin</a></h1><p>eventbuså¯¼èˆªæ’ä»¶(å¯¹äºæœ€æ–°ç‰ˆçš„ EventBus 3.0.0 å¥½åƒæ— æ•ˆ,è¯·æ›¿æ¢ä¸ºeventbus3-intellij-pluginæ­¤æ’ä»¶åœ°å€åœ¨æœ¬æ–‡ç¬¬51ä¸ª)</p>
<p><img src="https://raw.githubusercontent.com/kgmyshin/eventbus-intellij-plugin/master/art/cap.gif" alt=""></p>
<h1 id="26-idea-markdown"><a href="#26-idea-markdown" class="headerlink" title="26.idea-markdown"></a>26.<a href="https://github.com/nicoulaj/idea-markdown" target="_blank" rel="external">idea-markdown</a></h1><p>markdownæ’ä»¶</p>
<p><img src="https://github.com/nicoulaj/idea-markdown/raw/assets/screenshots/preview.png" alt=""></p>
<h1 id="27-Sexy-Editor"><a href="#27-Sexy-Editor" class="headerlink" title="27.Sexy Editor"></a>27.<a href="https://plugins.jetbrains.com/plugin/1833?pr=androidstudio" target="_blank" rel="external">Sexy Editor</a></h1><p>è®¾ç½®ASä»£ç ç¼–è¾‘åŒºçš„èƒŒæ™¯å›¾</p>
<p>é¦–å…ˆç‚¹å‡»ç•Œé¢çš„è®¾ç½®æŒ‰é’® è¿›å…¥è®¾ç½®ç•Œé¢ï¼Œé€‰ä¸­Plugins,å³è¾¹é€‰æ‹© Browser â€¦ ï¼Œè¾“å…¥Sexy â€¦ ä¸‹é¢è‡ªåŠ¨å¼¹å‡ºå€™é€‰æ’ä»¶ï¼Œå³è¾¹ç‚¹å‡»Install å®‰è£…<br><img src="http://d.hiphotos.baidu.com/zhidao/wh%3D600%2C800/sign=f57bdd37f0246b607b5bba72dbc83674/4b90f603738da9777260054fb651f8198618e303.jpg" alt=""><br>å®‰è£…æˆåŠŸ åéœ€è¦é‡å¯AS<br><img src="http://h.hiphotos.baidu.com/zhidao/wh%3D600%2C800/sign=77e4e517fdf2b211e47b8d48fab04900/1c950a7b02087bf46d0dd48df4d3572c10dfcff5.jpg" alt=""><br>é‡å¯å®Œæˆä¹‹å è¿›å…¥è®¾ç½®ç•Œé¢ é€‰æ‹©other Setting ä¸‹çš„Sexy Editor ï¼Œ å³ä¾§ insert ä¸€å¼ æˆ–å¤šå¼ å›¾ç‰‡å³å¯ï¼Œä¸Šé¢çš„å…¶ä»–è®¾ç½®å¯ä»¥è®¾ç½®æ–¹ä½ é—´éš”æ—¶é—´ é€æ˜åº¦ç­‰ç­‰ï¼Œè®¾ç½®å®Œæˆåï¼Œè¦å…³é—­æ‰“å¼€çš„æ–‡ä»¶ï¼Œé‡æ–°æ‰“å¼€é¡¹ç›®æ–‡ä»¶å³å¯åœ¨ä»£ç ç¼–è¾‘åŒºæ˜¾ç¤ºæ’å…¥çš„å›¾ç‰‡ï¼Œä½œä¸ºä»£ç ç¼–è¾‘åŒºçš„èƒŒæ™¯å›¾ã€‚<br><img src="http://h.hiphotos.baidu.com/zhidao/wh%3D600%2C800/sign=5cd9b28564d9f2d320442ce999dca62b/34fae6cd7b899e51289eb77044a7d933c8950d45.jpg" alt=""></p>
<h1 id="28-folding-plugin"><a href="#28-folding-plugin" class="headerlink" title="28.folding-plugin"></a>28.<a href="https://github.com/dmytrodanylyk/folding-plugin" target="_blank" rel="external">folding-plugin</a></h1><p>å¸ƒå±€æ–‡ä»¶åˆ†ç»„çš„æ’ä»¶</p>
<p><img src="https://github.com/dmytrodanylyk/folding-plugin/raw/master/screenshots/Preview.png" alt=""></p>
<h1 id="29-Android-DPI-Calculator"><a href="#29-Android-DPI-Calculator" class="headerlink" title="29.Android-DPI-Calculator"></a>29.<a href="https://github.com/JerzyPuchalski/Android-DPI-Calculator" target="_blank" rel="external">Android-DPI-Calculator</a></h1><p>DPIè®¡ç®—æ’ä»¶</p>
<p><img src="https://camo.githubusercontent.com/ce3be2aaa3b1f70b90f5b825c529694509d70313/68747470733a2f2f7261772e6769746875622e636f6d2f4a65727a7950756368616c736b692f416e64726f69642d4450492d43616c63756c61746f722f6d61737465722f696d672f6469616c6f672e706e67" alt=""></p>
<p>ä½¿ç”¨ï¼š<br><img src="https://camo.githubusercontent.com/598d3b5c9efc5f0b57b58c25a79a323d06307fad/68747470733a2f2f7261772e6769746875622e636f6d2f4a65727a7950756368616c736b692f416e64726f69642d4450492d43616c63756c61746f722f6d61737465722f696d672f616374696f6e2e706e67" alt=""><br>æˆ–è€…<br><img src="https://camo.githubusercontent.com/7a8f977de7a1ba6cd23fb64cbd37566690c27cdc/68747470733a2f2f7261772e6769746875622e636f6d2f4a65727a7950756368616c736b692f416e64726f69642d4450492d43616c63756c61746f722f6d61737465722f696d672f6d656e752e706e67" alt=""></p>
<h1 id="30-gradle-retrolambda"><a href="#30-gradle-retrolambda" class="headerlink" title="30.gradle-retrolambda"></a>30.<a href="https://github.com/evant/gradle-retrolambda" target="_blank" rel="external">gradle-retrolambda</a></h1><p>åœ¨java 6 7ä¸­ä½¿ç”¨ lambdaè¡¨è¾¾å¼æ’ä»¶</p>
<p>ä¿®æ”¹ç¼–è¯‘çš„jdkä¸ºjava8:<br><img src="http://img.blog.csdn.net/20160311101644127" alt=""></p>
<h1 id="31-Android-Studio-Prettify"><a href="#31-Android-Studio-Prettify" class="headerlink" title="31.Android Studio Prettify"></a>31.<a href="https://plugins.jetbrains.com/plugin/7405" target="_blank" rel="external">Android Studio Prettify</a></h1><p>å¯ä»¥å°†ä»£ç ä¸­çš„å­—ç¬¦ä¸²å†™åœ¨string.xmlæ–‡ä»¶ä¸­</p>
<p>é€‰ä¸­å­—ç¬¦ä¸²é¼ æ ‡å³é”®é€‰æ‹©å›¾ä¸­æ‰€ç¤º<br><img src="https://plugins.jetbrains.com/files/7405/screenshot_14417.png" alt=""></p>
<p>è¿™ä¸ªæ’ä»¶è¿˜å¯ä»¥è‡ªåŠ¨ä¹¦å†™findViewById<br><img src="https://plugins.jetbrains.com/files/7405/screenshot_14418.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7405/screenshot_14416.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7405/screenshot_14501.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7405/screenshot_14419.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7405/screenshot_14415.png" alt=""></p>
<h1 id="32-Material-Theme-UI"><a href="#32-Material-Theme-UI" class="headerlink" title="32.Material Theme UI"></a>32.<a href="https://plugins.jetbrains.com/plugin/8006?pr=" target="_blank" rel="external">Material Theme UI</a></h1><p>æ·»åŠ Materialä¸»é¢˜åˆ°ä½ çš„AS</p>
<p><img src="https://plugins.jetbrains.com/files/8006/screenshot_15722.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/8006/screenshot_15723.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/8006/screenshot_15721.png" alt=""></p>
<h1 id="33-ignore"><a href="#33-ignore" class="headerlink" title="33..ignore"></a>33.<a href="https://plugins.jetbrains.com/plugin/7495?pr=" target="_blank" rel="external">.ignore</a></h1><p>æˆ‘ä»¬éƒ½çŸ¥é“åœ¨Git ä¸­æƒ³è¦è¿‡æ»¤æ‰ä¸€äº›ä¸æƒ³æäº¤çš„æ–‡ä»¶ï¼Œå¯ä»¥æŠŠç›¸åº”çš„æ–‡ä»¶æ·»åŠ åˆ°.gitignore ä¸­ï¼Œè€Œ.gitignore è¿™ä¸ªAndroid Studio æ’ä»¶æ ¹æ®ä¸åŒçš„è¯­è¨€æ¥é€‰æ‹©æ¨¡æ¿ï¼Œå°±ä¸ç”¨è‡ªå·±åœ¨è´¹äº‹æ·»åŠ ä¸€äº›æ–‡ä»¶äº†ï¼Œè€Œä¸”è¿˜æœ‰è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿‡æ»¤æ–‡ä»¶å†ä¹Ÿä¸è¦å¤åˆ¶æ–‡ä»¶åäº†ã€‚æˆ‘ä»¬åšé¡¹ç›®çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯è¦æäº¤çš„ï¼Œæ¯”å¦‚æ„å»ºçš„build æ–‡ä»¶å¤¹ï¼Œæœ¬åœ°é…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªModule ç”Ÿæˆçš„iml æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡addï¼Œcommit éƒ½ä¼šä¸å°å¿ƒæŠŠå®ƒä»¬æ·»åŠ ä¸Šå»ï¼Œè€Œgitignore å°±æ˜¯è§£å†³è¿™ç§ç—›ç‚¹çš„ï¼Œå¦‚æœä½ ä¸æƒ³æäº¤çš„æ–‡ä»¶ï¼Œå°±å¯ä»¥åœ¨åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å°†è¿™ä¸ªæ–‡ä»¶ä¸­æ·»åŠ å³å¯ï¼Œå°†ä¸€äº›é€šç”¨çš„ä¸œè¥¿å±è”½æ‰ã€‚</p>
<p><img src="https://plugins.jetbrains.com/files/7495/screenshot_14960.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7495/screenshot_14958.png" alt=""></p>
<p><img src="https://plugins.jetbrains.com/files/7495/screenshot_14959.png" alt=""></p>
<h1 id="34-CheckStyle-IDEA"><a href="#34-CheckStyle-IDEA" class="headerlink" title="34.CheckStyle-IDEA"></a>34.<a href="https://plugins.jetbrains.com/plugin/1065?pr=" target="_blank" rel="external">CheckStyle-IDEA</a></h1><p>CheckStyle-IDEA æ˜¯ä¸€ä¸ªæ£€æŸ¥ä»£ç é£æ ¼çš„æ’ä»¶ï¼Œæ¯”å¦‚åƒå‘½åçº¦å®šï¼ŒJavadocï¼Œç±»è®¾è®¡ç­‰æ–¹é¢è¿›è¡Œä»£ç è§„èŒƒå’Œé£æ ¼çš„æ£€æŸ¥ï¼Œä½ ä»¬å¯ä»¥éµä»åƒGoogle Oracle çš„Java ä»£ç æŒ‡å— ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±çš„è§„åˆ™æ¥è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œä»è€Œæœ‰æ•ˆçº¦æŸä½ è‡ªå·±æ›´å¥½åœ°éµå¾ªä»£ç ç¼–å†™è§„èŒƒã€‚</p>
<h1 id="35-Markdown-Navigator"><a href="#35-Markdown-Navigator" class="headerlink" title="35.Markdown Navigator"></a>35.<a href="https://plugins.jetbrains.com/plugin/7896?pr=" target="_blank" rel="external">Markdown Navigator</a></h1><p>github:<a href="https://github.com/vsch/idea-multimarkdown/wiki" target="_blank" rel="external">Markdown Navigator</a><br>Markdownæ’ä»¶</p>
<p><img src="https://plugins.jetbrains.com/files/7896/screenshot_15818.png" alt=""></p>
<h1 id="36-ECTranslation"><a href="#36-ECTranslation" class="headerlink" title="36.ECTranslation"></a>36.<a href="https://github.com/Skykai521/ECTranslation" target="_blank" rel="external">ECTranslation</a></h1><p>Android Studio Plugin,Translate English to Chinese. Android Studio ç¿»è¯‘æ’ä»¶,å¯ä»¥å°†è‹±æ–‡ç¿»è¯‘ä¸ºä¸­æ–‡ã€‚</p>
<p><img src="https://github.com/Skykai521/ECTranslation/raw/master/_res/icon/translation_img.png" alt=""></p>
<h1 id="37-PermissionsDispatcher-plugin"><a href="#37-PermissionsDispatcher-plugin" class="headerlink" title="37.PermissionsDispatcher plugin"></a>37.<a href="https://plugins.jetbrains.com/plugin/8349" target="_blank" rel="external">PermissionsDispatcher plugin</a></h1><p>github:<a href="https://github.com/shiraji/permissions-dispatcher-plugin" target="_blank" rel="external">PermissionsDispatcher plugin</a><br>è‡ªåŠ¨ç”Ÿæˆ6.0æƒé™çš„ä»£ç </p>
<p><img src="https://github.com/shiraji/permissions-dispatcher-plugin/raw/master/website/images/pd.gif" alt=""></p>
<h1 id="38-WakaTime"><a href="#38-WakaTime" class="headerlink" title="38.WakaTime"></a>38.<a href="https://plugins.jetbrains.com/plugin/7425?pr=" target="_blank" rel="external">WakaTime</a></h1><p>github:<a href="https://github.com/wakatime/jetbrains-wakatime" target="_blank" rel="external">WakaTime</a><br>è®°å½•ä½ åœ¨IDEä¸Šçš„å·¥ä½œæ—¶é—´</p>
<p><img src="https://plugins.jetbrains.com/files/7425/screenshot_14794.png" alt=""></p>
<h1 id="39-AndroidWiFiADB"><a href="#39-AndroidWiFiADB" class="headerlink" title="39.AndroidWiFiADB"></a>39.<a href="https://github.com/pedrovgs/AndroidWiFiADB" target="_blank" rel="external">AndroidWiFiADB</a></h1><p>æ— çº¿è°ƒè¯•åº”ç”¨</p>
<p><img src="https://github.com/pedrovgs/AndroidWiFiADB/raw/master/art/screenshot1.gif" alt=""></p>
<p><img src="https://github.com/pedrovgs/AndroidWiFiADB/raw/master/art/android_devices_window.png" alt=""></p>
<h1 id="40-AndroidLocalizationer"><a href="#40-AndroidLocalizationer" class="headerlink" title="40.AndroidLocalizationer"></a>40.<a href="https://github.com/westlinkin/AndroidLocalizationer" target="_blank" rel="external">AndroidLocalizationer</a></h1><p>å¯ç”¨äºå°†é¡¹ç›®ä¸­çš„ string èµ„æºè‡ªåŠ¨ç¿»è¯‘ä¸ºå…¶ä»–è¯­è¨€çš„ Android Studio/IntelliJ IDEA æ’ä»¶</p>
<p><img src="https://raw.githubusercontent.com/westlinkin/AndroidLocalizationer/master/screen_shot_3.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/westlinkin/AndroidLocalizationer/master/screen_shot_2.png" alt=""></p>
<h1 id="41-TranslationPlugin"><a href="#41-TranslationPlugin" class="headerlink" title="41.TranslationPlugin"></a>41.<a href="https://github.com/YiiGuxing/TranslationPlugin" target="_blank" rel="external">TranslationPlugin</a></h1><p>åˆä¸€ç¿»è¯‘æ’ä»¶,å¯ä¸­è‹±äº’è¯‘ã€‚</p>
<p><img src="https://raw.githubusercontent.com/YiiGuxing/TranslationPlugin/master/images/1.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/YiiGuxing/TranslationPlugin/master/images/3.png" alt=""></p>
<h1 id="42-SingletonTest"><a href="#42-SingletonTest" class="headerlink" title="42.SingletonTest"></a>42.<a href="https://github.com/luhaoaimama1/SingletonTest" target="_blank" rel="external">SingletonTest</a></h1><p>å¿«é€Ÿç”Ÿæˆå•ä¾‹æ¨¡å¼çš„é¢„è®¾</p>
<p><img src="https://github.com/luhaoaimama1/SingletonTest/raw/master/demo/tip1.png" alt=""></p>
<p><img src="https://github.com/luhaoaimama1/SingletonTest/raw/master/demo/tip2.png" alt=""></p>
<p><img src="https://github.com/luhaoaimama1/SingletonTest/raw/master/demo/tip3.png" alt=""></p>
<h1 id="43-BorePlugin"><a href="#43-BorePlugin" class="headerlink" title="43.BorePlugin"></a>43.<a href="https://github.com/boredream/BorePlugin" target="_blank" rel="external">BorePlugin</a></h1><p>Android Studio è‡ªåŠ¨ç”Ÿæˆå¸ƒå±€ä»£ç æ’ä»¶</p>
<p><img src="https://github.com/boredream/BorePlugin/raw/master/screenshot/LayoutCreator.gif" alt=""></p>
<h2 id="ä»£ç ç”Ÿæˆè§„åˆ™"><a href="#ä»£ç ç”Ÿæˆè§„åˆ™" class="headerlink" title="ä»£ç ç”Ÿæˆè§„åˆ™"></a>ä»£ç ç”Ÿæˆè§„åˆ™</h2><p>a.è‡ªåŠ¨éå†ç›®æ ‡å¸ƒå±€ä¸­æ‰€æœ‰å¸¦idçš„æ–‡ä»¶, æ— idçš„ä¸ä¼šè¯†åˆ«å¤„ç†<br>b.æ§ä»¶ç”Ÿæˆçš„å˜é‡åé»˜è®¤ä¸ºidåç§°, å¯ä»¥åœ¨å¼¹å‡ºç¡®è®¤æ¡†å³ä¾§çš„åç§°è¾“å…¥æ ä¸­è‡ªè¡Œä¿®æ”¹<br>c.æ‰€æœ‰çš„Buttonæˆ–è€…å¸¦clickable=trueçš„æ§ä»¶, éƒ½ä¼šè‡ªåŠ¨åœ¨ä»£ç ä¸­ç”ŸæˆsetOnClickListenerç›¸å…³ä»£ç <br>d.æ‰€æœ‰EditTextæ§ä»¶, éƒ½ä¼šåœ¨ä»£ç ä¸­ç”Ÿæˆéç©ºåˆ¤æ–­ä»£ç , å¦‚æœä¸ºç©ºä¼šæç¤ºEditTextçš„hintå†…å®¹, å¦‚æœhintä¸ºç©ºåˆ™æç¤ºxxxå­—ç¬¦ä¸²ä¸èƒ½ä¸ºç©ºå­—æ ·, æœ€åä¼šæŠŠæ‰€æœ‰è¾“å…¥æ¡†çš„éªŒè¯åˆå¹¶åˆ°ä¸€ä¸ªsubmitæ–¹æ³•ä¸­<br>e.ä¼šè‡ªåŠ¨è¯†åˆ«å¸ƒå±€ä¸­çš„includeæ ‡ç­¾, å¹¶è¯»å–å¯¹åº”å¸ƒå±€ä¸­çš„æ§ä»¶</p>
<h1 id="44-jimu-Mirror"><a href="#44-jimu-Mirror" class="headerlink" title="44.jimu Mirror"></a>44.<a href="http://www.jimumirror.com/mirror-downloads/" target="_blank" rel="external">jimu Mirror</a></h1><p>èƒ½å¤Ÿå®æ—¶é¢„è§ˆAndroidå¸ƒå±€ï¼Œå®ƒä¼šç›‘å¬å¸ƒå±€æ–‡ä»¶çš„æ”¹åŠ¨ï¼Œå¦‚æœæœ‰ä»£ç å˜åŒ–ï¼Œå°±ä¼šç«‹å³åˆ·æ–°UIã€‚</p>
<h1 id="45-jRebel-For-Android"><a href="#45-jRebel-For-Android" class="headerlink" title="45.jRebel For Android"></a>45.<a href="http://zeroturnaround.com/software/jrebel-for-android/" target="_blank" rel="external">jRebel For Android</a></h1><p>ä¸ä»…èƒ½å¤Ÿåšåˆ°UIå¸ƒå±€çš„å®æ—¶é¢„è§ˆï¼Œå®ƒç”šè‡³åšåˆ°äº†è®©ä½ æ›´æ”¹javaä»£ç åå°±èƒ½å®æ—¶æ›¿æ¢apkä¸­çš„ç±»æ–‡ä»¶ï¼Œè¾¾åˆ°åº”ç”¨å®æ—¶åˆ·æ–°ï¼Œå®˜ç½‘çš„ä»‹ç»æ˜¯ï¼šSkip build, install and runï¼Œå› æ­¤å®ƒå¯ä»¥èŠ‚çº¦æˆ‘ä»¬å¾ˆå¤šå¾ˆå¤šçš„æ—¶é—´ï¼Œå®ƒçš„æ•ˆæœä¹Ÿååˆ†ä¸é”™ã€‚</p>
<p><img src="http://zeroturnaround.com/wp-content/uploads/2015/04/Android_Card1_2x.png" alt=""></p>
<p><img src="http://zeroturnaround.com/wp-content/uploads/2015/04/Android_Card2_2x.png" alt=""></p>
<p><img src="http://zeroturnaround.com/wp-content/uploads/2015/04/Android_Card3_2x.png" alt=""></p>
<h1 id="46-sdk-manager-plugin"><a href="#46-sdk-manager-plugin" class="headerlink" title="46.sdk-manager-plugin"></a>46.<a href="https://github.com/JakeWharton/sdk-manager-plugin" target="_blank" rel="external">sdk-manager-plugin</a></h1><p>SDKç®¡ç†æ’ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹æ›´æ–°å¹¶ä¸‹è½½ã€‚(å›¾ç‰‡ä¸æ’ä»¶æ— å…³å“ˆ)</p>
<p><img src="https://camo.githubusercontent.com/95469d65798f62a50a9fcabe21e2cc303a1b859c/687474703a2f2f692e696d6775722e636f6d2f384a734a587a6e2e6a7067" alt=""></p>
<h1 id="47-Codota"><a href="#47-Codota" class="headerlink" title="47.Codota"></a>47.<a href="http://www.codota.com/" target="_blank" rel="external">Codota</a></h1><p>æœç´¢æœ€å¥½çš„Androidä»£ç ã€‚(Studioé‡Œé¢ç›´æ¥å¯ä»¥æœåˆ°æ­¤æ’ä»¶)</p>
<h1 id="48-LayoutFormatter"><a href="#48-LayoutFormatter" class="headerlink" title="48.LayoutFormatter"></a>48.<a href="https://github.com/drakeet/LayoutFormatter" target="_blank" rel="external">LayoutFormatter</a></h1><p>drakeet å¼€å‘ä¸€ä¸ªä¸€é”®æ ¼å¼åŒ–ä½ çš„ XML æ–‡ä»¶çš„ Android Studio æ’ä»¶ï¼Œè‡³äºä¸ºä»€ä¹ˆä¸ç”¨ Android Studio è‡ªå¸¦çš„æ ¼å¼åŒ–åŠŸèƒ½è€Œç”¨è¿™ä¸ªæ’ä»¶ï¼Œå¯ä»¥çœ‹ä¸‹ä½œè€…çš„ä¸€ç¯‡ Blog -&gt; <a href="https://drakeet.me/layoutformatter" target="_blank" rel="external">å½“æˆ‘ä»¬è°ˆ XML å¸ƒå±€æ–‡ä»¶ä»£ç çš„ä¼˜é›…æ€§</a></p>
<p><img src="http://ww1.sinaimg.cn/large/86e2ff85gw1f383wa95tej21ge0m5ai0.jpg" alt=""></p>
<h1 id="49-android-strings-search-plugin"><a href="#49-android-strings-search-plugin" class="headerlink" title="49.android-strings-search-plugin"></a>49.<a href="https://github.com/konifar/android-strings-search-plugin" target="_blank" rel="external">android-strings-search-plugin</a></h1><p>ä¸€ä¸ªå¯ä»¥é€šè¿‡è¾“å…¥æ–‡å­—æ‰¾åˆ°strings.xmlèµ„æºçš„æ’ä»¶</p>
<p><img src="https://github.com/konifar/android-strings-search-plugin/raw/master/art/demo.gif" alt=""></p>
<h1 id="50-ideaVim"><a href="#50-ideaVim" class="headerlink" title="50.ideaVim"></a>50.<a href="http://plugins.jetbrains.com/plugin/164?pr=androidstudio" target="_blank" rel="external">ideaVim</a></h1><p>vim æœ¬èº«å°±æ˜¯ä¸€æ¬¾å¾ˆä¼˜ç§€çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œè€ŒAndroid Studio æ›´æ˜¯ä¸€æ¬¾ç¼–å†™APPåº”ç”¨çš„ç¥å™¨ã€‚å¦‚æœä¸¤ä¸ªæ¬¾ä¼˜ç§€çš„è½¯ä»¶ç»“åˆåœ¨ä¸€èµ·æ„Ÿè§‰ä¼šæ€æ ·å‘¢ï¼Ÿ<br>è¯¦ç»†è¯·çœ‹æ–‡ç« :<a href="http://www.jianshu.com/p/43862126b88f" target="_blank" rel="external">Android Studio ï¼‹Vim</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1825722-8b55d9654777599e.gif?imageMogr2/auto-orient/strip" alt=""></p>
<h1 id="51-eventbus3-intellij-plugin"><a href="#51-eventbus3-intellij-plugin" class="headerlink" title="51.eventbus3-intellij-plugin"></a>51.<a href="https://github.com/likfe/eventbus3-intellij-plugin/blob/master/README-zh.md" target="_blank" rel="external">eventbus3-intellij-plugin</a></h1><p>å¼•å¯¼ EventBus çš„ post å’Œ event(å¯¹äºæœ€æ–°ç‰ˆçš„ EventBus 3.0.0 æœ‰æ•ˆ)<br>ä¸»è¦Bugä¿®å¤å·¥ä½œï¼š<br>ä¿®æ”¹åŒ…åå’Œæ–¹æ³•åä»¥é€‚åº” EventBus 3.X<br>æ›¿æ¢ä¸€ä¸ªåœ¨æ–°ç‰ˆçš„ intellij plugin SDK å·²ç»ä¸å­˜åœ¨çš„ç±»<br>å¢åŠ è‹¥å¹² try-catch ï¼Œé˜²æ­¢æ’ä»¶å´©æºƒ</p>
<p><img src="https://raw.githubusercontent.com/likfe/eventbus3-intellij-plugin/master/art/cap.gif" alt=""></p>
<h1 id="52-Exynap"><a href="#52-Exynap" class="headerlink" title="52.Exynap"></a>52.<a href="http://exynap.com/" target="_blank" rel="external">Exynap</a></h1><p>Exynap ä¸€ä¸ªå¸®åŠ©å¼€å‘è€…è‡ªåŠ¨ç”Ÿæˆæ ·æ¿ä»£ç çš„ AndroidStudio æ’ä»¶</p>
<p><img src="http://exynap.com/images/anim01.gif" alt=""></p>
<h1 id="53-gradle-cleaner-intellij-plugin"><a href="#53-gradle-cleaner-intellij-plugin" class="headerlink" title="53.gradle-cleaner-intellij-plugin"></a>53.<a href="https://github.com/Softwee/gradle-cleaner-intellij-plugin" target="_blank" rel="external">gradle-cleaner-intellij-plugin</a></h1><p>Force clear delaying &amp; no longer needed Gradle tasks.</p>
<p><img src="https://camo.githubusercontent.com/cb48bca7f8bd0b513f350f7320c74054d1b9fbce/687474703a2f2f6936352e74696e797069632e636f6d2f726a687863382e706e67" alt=""></p>
<h1 id="54-MVPHelper"><a href="#54-MVPHelper" class="headerlink" title="54.MVPHelper"></a>54.<a href="http://androidwing.net/index.php/27" target="_blank" rel="external">MVPHelper</a></h1><p>ä¸€æ¬¾Intellj IDEA å’ŒAndroid Studioçš„æ’ä»¶ï¼Œå¯ä»¥ä¸ºMVPç”Ÿæˆæ¥å£ä»¥åŠå®ç°ç±»ï¼Œè§£æ”¾åŒæ‰‹ã€‚<br>å…·ä½“è¯·æŸ¥çœ‹<a href="http://androidwing.net/index.php/27" target="_blank" rel="external">Android Studioæ’ä»¶ä¹‹MVPHelperï¼Œä¸€é”®ç”ŸæˆMVPä»£ç </a>ä¸€æ–‡</p>
<p><img src="https://github.com/githubwing/MVPHelper/raw/master/_res/icon/mvp_presenter.gif" alt=""></p>
<p>å¦‚æœè¿˜æœ‰æ›´å¥½ç©æ›´å¥½ç”¨çš„æ’ä»¶æ¬¢è¿fork + pull request</p>
<hr>
<p>å¦‚æœä½ æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬ï¼Œè¯·ç›´æ¥å…³æ³¨å…¬ä¼—å· LikeTip ï¼Œæˆ–è€…åŠ  QQ ç¾¤ï¼š317195350</p>
<p><img src="/_res/icon/likeqy_group.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://img.shields.io/github/stars/likeqy/Android-Studio-Plugins.svg?style=social&amp;amp;label=Star&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;#1.&lt;a href=&quot;h
    
    </summary>
    
      <category term="å­¦ä¹ èµ„æ–™" scheme="https://likeqy.com/categories/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/"/>
    
    
      <category term="Android" scheme="https://likeqy.com/tags/Android/"/>
    
  </entry>

</feed>
